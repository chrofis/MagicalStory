import{c as re,s as U,j as e,L as de,C as pe,T as $e}from"./index-DObFb98j.js";import{b as x}from"./vendor-react-CqfXSjHo.js";import{W as ke}from"./wrench-CDY3DfOX.js";import{R as Ae}from"./rotate-ccw-B4uV31b0.js";import{C as ve}from"./chevron-down-sTwsGQQD.js";import{C as we}from"./chevron-right-72qhPy0J.js";import{S as Re}from"./square-LE0NA_aX.js";import{S as Pe}from"./search-BddXzUJw.js";import{C as Ie}from"./circle-x-FAMS1C9Y.js";import{U as Se}from"./Input-CAV57ZjE.js";import{R as We}from"./Modal-Boc_oufn.js";import"./vendor-firebase-DTVMaYMy.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=re("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=re("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=re("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=re("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=re("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function Ce(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{},pagesFailed:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const oe=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair"];function Me({storyId:c,sceneImages:I,characters:B,finalChecksReport:W,imageModel:L,onImageUpdate:T}){const[b,$]=x.useState(Ce),[Q,G]=x.useState({current:0,total:0,currentPage:void 0}),m=x.useRef(null),[D,X]=x.useState(!1),K=x.useMemo(()=>Object.values(b.stepStatus).some(a=>a==="in-progress"),[b.stepStatus]),H=x.useMemo(()=>oe.indexOf(b.currentStep),[b.currentStep]),A=x.useCallback(a=>{$(l=>({...l,currentStep:a,stepStatus:{...l.stepStatus,[a]:"in-progress"}}))},[]),d=x.useCallback((a,l)=>{$(n=>({...n,stepStatus:{...n.stepStatus,[a]:"completed"},...a==="collect-feedback"&&l?{collectedFeedback:l}:{},...a==="re-evaluate"&&l?{reEvaluationResults:l}:{},...a==="consistency-check"&&l?{consistencyResults:l}:{}}))},[]),N=x.useCallback((a,l)=>{$(n=>({...n,stepStatus:{...n.stepStatus,[a]:"failed"}}))},[]),Y=x.useCallback(a=>{$(l=>({...l,stepStatus:{...l.stepStatus,[a]:"skipped"}}))},[]),ue=x.useCallback(()=>{$(Ce()),G({current:0,total:0,currentPage:void 0}),X(!1),m.current=null},[]),ge=x.useCallback(()=>{var a;console.log("[useRepairWorkflow] Aborting workflow"),(a=m.current)==null||a.abort(),X(!0)},[]),Z=x.useCallback(async()=>{var a,l,n,j,v;if(c){A("collect-feedback");try{const u={};let p=0;for(const r of I){const P={pageNumber:r.pageNumber,qualityScore:r.qualityScore,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},w=(a=r.retryHistory)==null?void 0:a.slice(-1)[0];if((l=w==null?void 0:w.postRepairEval)!=null&&l.fixableIssues?P.fixableIssues=w.postRepairEval.fixableIssues:(n=w==null?void 0:w.preRepairEval)!=null&&n.fixableIssues&&(P.fixableIssues=w.preRepairEval.fixableIssues),W!=null&&W.entity){for(const[q,k]of Object.entries(W.entity.characters||{})){const h=[];if(k.byClothing)for(const R of Object.values(k.byClothing))R.issues&&h.push(...R.issues);k.issues&&h.push(...k.issues);const M=h.filter(R=>{var F;return((F=R.pagesToFix)==null?void 0:F.includes(r.pageNumber))||R.pageNumber===r.pageNumber});for(const R of M)P.entityIssues.push({character:q,issue:R.description,severity:R.severity})}for(const[q,k]of Object.entries(W.entity.objects||{})){const h=[];if(k.byClothing)for(const R of Object.values(k.byClothing))R.issues&&h.push(...R.issues);k.issues&&h.push(...k.issues);const M=h.filter(R=>{var F;return((F=R.pagesToFix)==null?void 0:F.includes(r.pageNumber))||R.pageNumber===r.pageNumber});for(const R of M)P.objectIssues.push({object:q,issue:R.description,severity:R.severity})}}if(W!=null&&W.imageChecks)for(const q of W.imageChecks)for(const k of q.issues||[])(((j=k.pagesToFix)==null?void 0:j.includes(r.pageNumber))||((v=k.images)==null?void 0:v.includes(r.pageNumber)))&&P.semanticIssues.push({type:k.type,description:k.description,severity:k.severity,characterInvolved:k.characterInvolved,recommendation:k.recommendation});p+=P.fixableIssues.length+P.entityIssues.length+P.objectIssues.length+P.semanticIssues.length,u[r.pageNumber]=P}d("collect-feedback",{pages:u,totalIssues:p})}catch(u){console.error("Failed to collect feedback:",u),N("collect-feedback",u instanceof Error?u.message:"Unknown error")}}},[c,I,W,A,d,N]),me=x.useCallback((a,l)=>{$(n=>({...n,collectedFeedback:{...n.collectedFeedback,pages:{...n.collectedFeedback.pages,[a]:{...n.collectedFeedback.pages[a],...l}}}}))},[]),xe=x.useCallback((a,l)=>{$(n=>{const j=n.redoPages.pageNumbers.includes(a),v=j?n.redoPages.pageNumbers.filter(p=>p!==a):[...n.redoPages.pageNumbers,a].sort((p,r)=>p-r),u={...n.redoPages.reasons};return j?delete u[a]:l&&(u[a]=l),{...n,redoPages:{pageNumbers:v,reasons:u}}})},[]),J=x.useCallback((a=6,l=3)=>{A("identify-redo-pages");const n=[],j={};for(const[v,u]of Object.entries(b.collectedFeedback.pages)){const p=parseInt(v),r=u.fixableIssues.length+u.entityIssues.length,P=u.qualityScore??10;P<a?(n.push(p),j[p]=`Low quality score: ${P}`):r>=l?(n.push(p),j[p]=`Too many issues: ${r}`):u.needsFullRedo&&(n.push(p),j[p]="Manually marked for redo")}$(v=>({...v,redoPages:{pageNumbers:n.sort((u,p)=>u-p),reasons:j},stepStatus:{...v.stepStatus,"identify-redo-pages":"completed"}}))},[b.collectedFeedback.pages,A]),le=x.useCallback(async()=>{var j;if(!c||b.redoPages.pageNumbers.length===0)return;A("redo-pages");const a=b.redoPages.pageNumbers;G({current:0,total:a.length,currentPage:void 0});const l=[],n={};try{for(let v=0;v<a.length;v++){const u=a[v];G({current:v,total:a.length,currentPage:u});try{const p=await U.iteratePage(c,u,L);if(p.success){l.push(u);const r=I.find(w=>w.pageNumber===u),P=((j=r==null?void 0:r.imageVersions)==null?void 0:j.length)??0;n[u]=P,T&&T(u,p.imageData,P)}}catch(p){console.error(`Failed to redo page ${u}:`,p)}}$(v=>({...v,redoResults:{pagesCompleted:l,newVersions:n},stepStatus:{...v.stepStatus,"redo-pages":"completed"}})),G({current:a.length,total:a.length,currentPage:void 0})}catch(v){console.error("Redo pages failed:",v),N("redo-pages",v instanceof Error?v.message:"Unknown error")}},[c,b.redoPages.pageNumbers,L,I,T,A,N]),ee=x.useCallback(async a=>{if(!c)return;A("re-evaluate");const l=a??b.redoResults.pagesCompleted;if(l.length===0){Y("re-evaluate");return}try{const n=await U.reEvaluatePages(c,l),j={};for(const[v,u]of Object.entries(n.pages||{})){const p=u;j[parseInt(v)]={qualityScore:p.qualityScore,rawScore:p.rawScore,verdict:p.verdict,issuesSummary:p.issuesSummary,reasoning:p.reasoning,fixableIssues:p.fixableIssues}}d("re-evaluate",{pages:j})}catch(n){console.error("Re-evaluation failed:",n),N("re-evaluate",n instanceof Error?n.message:"Unknown error")}},[c,b.redoResults.pagesCompleted,A,d,N,Y]),ce=x.useCallback(async()=>{if(c){A("consistency-check");try{const a=await U.runEntityConsistency(c);d("consistency-check",{report:a.report})}catch(a){console.error("Consistency check failed:",a),N("consistency-check",a instanceof Error?a.message:"Unknown error")}}},[c,A,d,N]),se=x.useCallback(async(a,l,n)=>{var j,v,u,p;if(!(!c||l.length===0)){A("character-repair");try{const r=await U.repairCharacters(c,[{character:a,pages:l}],n),P=((v=(j=r.results)==null?void 0:j[0])==null?void 0:v.pagesRepaired)||[],w=((p=(u=r.results)==null?void 0:u[0])==null?void 0:p.pagesFailed)||[];for(const h of P)if(h.imageData&&T)try{T(h.pageNumber,h.imageData,h.versionIndex)}catch(M){console.error(`[RepairWorkflow] Failed to notify parent of image update for page ${h.pageNumber}:`,M)}w.length>0&&console.warn(`[RepairWorkflow] ${w.length} pages failed repair for ${a}:`,w.map(h=>`page ${h.pageNumber}: ${h.reason}`).join(", "));const q=P.map(h=>typeof h=="number"?h:h.pageNumber),k=w.map(h=>({pageNumber:h.pageNumber,reason:h.reason,rejected:h.rejected}));$(h=>({...h,characterRepairResults:{charactersProcessed:[...h.characterRepairResults.charactersProcessed,a],pagesRepaired:{...h.characterRepairResults.pagesRepaired,[a]:q},pagesFailed:{...h.characterRepairResults.pagesFailed,[a]:k}},stepStatus:{...h.stepStatus,"character-repair":w.length>0&&P.length===0?"failed":"completed"}}))}catch(r){console.error("Character repair failed:",r),N("character-repair",r instanceof Error?r.message:"Unknown error")}}},[c,A,N,T]),te=x.useCallback(async a=>{if(!(!c||a.length===0)){A("artifact-repair");try{const l=await U.repairArtifacts(c,a);$(n=>({...n,artifactRepairResults:{pagesProcessed:l.pagesProcessed||a,issuesFixed:l.issuesFixed||0},stepStatus:{...n.stepStatus,"artifact-repair":"completed"}}))}catch(l){console.error("Artifact repair failed:",l),N("artifact-repair",l instanceof Error?l.message:"Unknown error")}}},[c,A,N]),he=x.useCallback(a=>{const l=oe.indexOf(a);if(a==="idle")return!0;if(K)return!1;switch(a){case"collect-feedback":return!0;case"identify-redo-pages":return b.stepStatus["collect-feedback"]==="completed";case"redo-pages":return b.redoPages.pageNumbers.length>0;case"re-evaluate":return b.stepStatus["redo-pages"]==="completed"||b.stepStatus["redo-pages"]==="skipped";case"consistency-check":return l>oe.indexOf("collect-feedback");case"character-repair":return b.stepStatus["consistency-check"]==="completed";case"artifact-repair":return b.stepStatus["collect-feedback"]==="completed";default:return!1}},[b,K]),be=x.useCallback(a=>{const l=oe.indexOf(a);return l>0?l:0},[]),fe=x.useCallback(()=>Object.entries(b.collectedFeedback.pages).filter(([a,l])=>{const n=l.qualityScore??10,j=l.fixableIssues.length+l.entityIssues.length;return n<7||j>0||l.needsFullRedo}).map(([a])=>parseInt(a)).sort((a,l)=>a-l),[b.collectedFeedback.pages]),ne=x.useCallback(()=>{const a=b.consistencyResults.report;return a!=null&&a.characters?Object.entries(a.characters).filter(([l,n])=>{var j;return"overallConsistent"in n?!n.overallConsistent||(n.totalIssues??0)>0:!n.consistent||(((j=n.issues)==null?void 0:j.length)??0)>0}).map(([l])=>l):[]},[b.consistencyResults.report]),ye=x.useCallback(a=>{var v;const l=b.consistencyResults.report;if(!((v=l==null?void 0:l.characters)!=null&&v[a]))return[];const n=l.characters[a],j=new Set;if(n.byClothing){for(const u of Object.values(n.byClothing))for(const p of u.issues||[])if(p.severity==="major"||p.severity==="critical"){for(const r of p.pagesToFix||[])j.add(r);p.pageNumber&&j.add(p.pageNumber)}}if(n.issues){for(const u of n.issues)if(u.severity==="major"||u.severity==="critical"){for(const p of u.pagesToFix||[])j.add(p);u.pageNumber&&j.add(u.pageNumber)}}return Array.from(j).sort((u,p)=>u-p)},[b.consistencyResults.report]),ae=x.useCallback(async(a={})=>{var q,k,h;if(!c)return;const l=6,n=3,j=4,{scoreThreshold:v=l,issueThreshold:u=n,maxRetries:p=j,onProgress:r}=a;m.current=new AbortController,X(!1);const P=m.current.signal,w=()=>{if(P.aborted)throw console.log("[useRepairWorkflow] Workflow aborted"),new Error("Workflow aborted")};try{w(),r==null||r("collect-feedback","Collecting existing issues..."),await Z(),w(),r==null||r("re-evaluate","Evaluating all pages...");const M=await U.reEvaluatePages(c,I.map(g=>g.pageNumber)),R={};for(const[g,i]of Object.entries(M.pages||{})){const o=i;R[parseInt(g)]=o}w(),r==null||r("identify-redo-pages","Identifying pages needing redo...");const F=[];for(const[g,i]of Object.entries(R)){const o=parseInt(g),S=i.rawScore??Math.round(i.qualityScore/10);S>10&&console.error(`[RepairWorkflow] Invalid rawScore scale for page ${o}: ${S} (expected 0-10)`);const O=((q=i.fixableIssues)==null?void 0:q.length)??0;(S<v||O>=u)&&F.push(o)}F.sort((g,i)=>g-i),$(g=>({...g,redoPages:{pageNumbers:F,reasons:{}},stepStatus:{...g.stepStatus,"identify-redo-pages":"completed"}})),w();const V=[];if(F.length>0){r==null||r("redo-pages",`Redoing ${F.length} pages...`),A("redo-pages");const g={};for(let i=0;i<F.length;i++){w();const o=F[i];let S=0,O="",E=0;for(let y=1;y<=p;y++){w(),r==null||r("redo-pages",`Page ${o}: attempt ${y}/${p}`),G({current:i,total:F.length,currentPage:o});try{const C=await U.iteratePage(c,o,L);if(C.success){const _=C.qualityScore??0;if(_>S){S=_,O=C.imageData;const je=I.find(Oe=>Oe.pageNumber===o);E=(((k=je==null?void 0:je.imageVersions)==null?void 0:k.length)??0)+y-1}if(_>=v*10)break}}catch(C){console.error(`Failed to redo page ${o} attempt ${y}:`,C)}}O&&(g[o]={score:S,imageData:O,versionIndex:E},V.push(o),T==null||T(o,O,E))}$(i=>({...i,redoResults:{pagesCompleted:V,newVersions:Object.fromEntries(Object.entries(g).map(([o,S])=>[o,S.versionIndex]))},stepStatus:{...i.stepStatus,"redo-pages":"completed"}}))}V.length>0&&(w(),r==null||r("re-evaluate","Re-evaluating redone pages..."),await ee(V)),w(),r==null||r("consistency-check","Running consistency check...");const s=(await U.runEntityConsistency(c)).report;if($(g=>({...g,consistencyResults:{report:s},stepStatus:{...g.stepStatus,"consistency-check":"completed"}})),w(),s!=null&&s.characters){const g=Object.entries(s.characters).filter(([i,o])=>{var S;return"overallConsistent"in o?!o.overallConsistent||(o.totalIssues??0)>0:!o.consistent||(((S=o.issues)==null?void 0:S.length)??0)>0}).map(([i])=>i);if(g.length>0){r==null||r("character-repair",`Repairing ${g.length} characters...`);for(const i of g){w();const o=s.characters[i],S=new Set;if(o.byClothing){for(const E of Object.values(o.byClothing))for(const y of E.issues||[])if(y.severity==="major"||y.severity==="critical"){for(const C of y.pagesToFix||[])S.add(C);y.pageNumber&&S.add(y.pageNumber)}}if(o.issues){for(const E of o.issues)if(E.severity==="major"||E.severity==="critical"){for(const y of E.pagesToFix||[])S.add(y);E.pageNumber&&S.add(E.pageNumber)}}const O=Array.from(S).sort((E,y)=>E-y);O.length>0&&(r==null||r("character-repair",`Repairing ${i} on ${O.length} pages...`),await se(i,O))}}}w();const f=[];for(const[g,i]of Object.entries(R))(h=i.fixableIssues)!=null&&h.some(o=>o.type==="artifact"||o.type==="distortion")&&f.push(parseInt(g));f.length>0&&(r==null||r("artifact-repair",`Repairing artifacts on ${f.length} pages...`),await te(f)),r==null||r("complete","Workflow complete!")}catch(M){if(M instanceof Error&&M.message==="Workflow aborted"){console.log("[useRepairWorkflow] Workflow was aborted by user");return}throw console.error("Full workflow failed:",M),M}finally{m.current=null}},[c,I,L,T,Z,ee,A,G,ce,se,te]);return{workflowState:b,isRunning:K,currentStepIndex:H,startStep:A,completeStep:d,failStep:N,skipStep:Y,resetWorkflow:ue,collectFeedback:Z,updatePageFeedback:me,toggleRedoPage:xe,autoIdentifyRedoPages:J,redoMarkedPages:le,redoProgress:Q,reEvaluatePages:ee,runConsistencyCheck:ce,repairCharacter:se,repairArtifacts:te,runFullWorkflow:ae,abortWorkflow:ge,isAborted:D,canProceedToStep:he,getStepNumber:be,getPagesNeedingAttention:fe,getCharactersWithIssues:ne,getPagesWithSevereIssuesForCharacter:ye}}const z={idle:{label:"Ready",icon:Fe,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:Pe,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:$e,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:We,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:pe,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:Se,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:Se,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:Ee,description:"Fix remaining artifacts via grid repair"}};function _e({status:c}){const I={pending:{color:"bg-gray-100 text-gray-600",icon:Fe},"in-progress":{color:"bg-blue-100 text-blue-600",icon:de},completed:{color:"bg-green-100 text-green-600",icon:pe},skipped:{color:"bg-yellow-100 text-yellow-600",icon:qe},failed:{color:"bg-red-100 text-red-600",icon:Ie}},{color:B,icon:W}=I[c],L=c==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${B}`,children:[e.jsx(W,{className:`w-3 h-3 ${L?"animate-spin":""}`}),c]})}function De({feedback:c,isMarkedForRedo:I,onToggleRedo:B,onUpdateNotes:W}){var Q,G;const[L,T]=x.useState(!1),b=c.fixableIssues.length+c.entityIssues.length+(((Q=c.objectIssues)==null?void 0:Q.length)||0)+(((G=c.semanticIssues)==null?void 0:G.length)||0),$=b>0||c.qualityScore!==void 0&&c.qualityScore<7;return e.jsxs("div",{className:`border rounded-lg p-3 ${I?"border-red-300 bg-red-50":$?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>T(!L),className:"p-1 hover:bg-gray-100 rounded",children:L?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",c.pageNumber]}),c.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${c.qualityScore>=8?"bg-green-100 text-green-700":c.qualityScore>=6?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",c.qualityScore]}),b>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[b," issues"]})]}),e.jsx("button",{onClick:B,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${I?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:I?"Marked for Redo":"Mark for Redo"})]}),L&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[c.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",c.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.fixableIssues.map((m,D)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsxs("span",{children:["[",m.type,"] ",m.description]})]},D))})]}),c.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",c.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.entityIssues.map((m,D)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:m.character}),e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.issue})]},D))})]}),c.objectIssues&&c.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",c.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.objectIssues.map((m,D)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:m.object}),e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.issue})]},D))})]}),c.semanticIssues&&c.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",c.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.semanticIssues.map((m,D)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:m.type.replace(/_/g," ")}),m.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:m.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${m.severity==="high"?"bg-red-100 text-red-700":m.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.description})]},D))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:c.manualNotes,onChange:m=>W(m.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}const Ne="repair-workflow-autorun-completed";function Ye({storyId:c,sceneImages:I,characters:B,finalChecksReport:W,imageModel:L,onImageUpdate:T,onRefreshStory:b,autoRunFullWorkflow:$=!1,onAutoRunComplete:Q,developerMode:G=!1,useMagicApiRepair:m=!1,setUseMagicApiRepair:D}){const[X,K]=x.useState(!0),[H,A]=x.useState(new Set(["collect-feedback"])),{workflowState:d,isRunning:N,resetWorkflow:Y,collectFeedback:ue,updatePageFeedback:ge,toggleRedoPage:Z,autoIdentifyRedoPages:me,redoMarkedPages:xe,redoProgress:J,reEvaluatePages:le,runConsistencyCheck:ee,repairCharacter:ce,repairArtifacts:se,runFullWorkflow:te,abortWorkflow:he,isAborted:be,getStepNumber:fe,getCharactersWithIssues:ne,getPagesWithSevereIssuesForCharacter:ye}=Me({storyId:c,sceneImages:I,characters:B,finalChecksReport:W,imageModel:L,onImageUpdate:T}),[ae,a]=x.useState(null),[l,n]=x.useState(!1),j=x.useRef(null),v=t=>{try{return JSON.parse(localStorage.getItem(Ne)||"[]").includes(t)}catch{return!1}},u=t=>{try{const s=JSON.parse(localStorage.getItem(Ne)||"[]");if(!s.includes(t)){s.push(t);const f=s.slice(-10);localStorage.setItem(Ne,JSON.stringify(f))}}catch(s){console.error("[RepairWorkflowPanel] Failed to save auto-run completion:",s)}};x.useEffect(()=>{if($&&c&&I.length>0&&!N&&!l){const t=j.current===c,s=v(c);!t&&!s?(j.current=c,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",c),setTimeout(async()=>{await p(),u(c),Q==null||Q()},500)):console.log("[RepairWorkflowPanel] Skipping auto-run - already completed for story:",c,{alreadyRunThisSession:t,alreadyCompletedPreviously:s})}},[$,c,I.length,N,l]);const p=async()=>{n(!0);try{await te({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(t,s)=>{a({step:t,detail:s})}}),b&&await b()}catch(t){console.error("Full workflow failed:",t)}finally{n(!1),a(null)}},[r,P]=x.useState(""),[w,q]=x.useState([]),[k,h]=x.useState([]),M=t=>{A(s=>{const f=new Set(s);return f.has(t)?f.delete(t):f.add(t),f})},R=x.useMemo(()=>ne(),[ne]),F=x.useMemo(()=>{var s;const t=new Set;for(const[f,g]of Object.entries(d.collectedFeedback.pages))g.fixableIssues.some(i=>i.type==="artifact"||i.type==="distortion")&&t.add(parseInt(f));for(const[f,g]of Object.entries(d.reEvaluationResults.pages))(s=g.fixableIssues)!=null&&s.some(i=>i.type==="artifact"||i.type==="distortion")&&t.add(parseInt(f));return Array.from(t).sort((f,g)=>f-g)},[d.collectedFeedback.pages,d.reEvaluationResults.pages]),V=t=>{const s=z[t],f=s.icon,g=d.stepStatus[t],i=H.has(t),o=fe(t);return e.jsxs("button",{onClick:()=>M(t),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${g==="in-progress"?"bg-blue-50":g==="completed"?"bg-green-50":g==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:o}),e.jsx(f,{className:`w-4 h-4 ${g==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:s.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{status:g}),i?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})]})]})};return c?e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>K(!X),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),d.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[d.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[N&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(de,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:t=>{t.stopPropagation(),Y()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(Ae,{className:"w-4 h-4 text-amber-700"})}),X?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})]})]}),X&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsxs("button",{onClick:()=>{he(),n(!1),a(null)},className:"flex items-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium",title:"Stop the workflow",children:[e.jsx(Re,{className:"w-5 h-5"}),"Stop"]}),e.jsx("button",{onClick:p,disabled:N||l,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:l?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-5 h-5"}),"Run Full Workflow"]})})]})]}),ae&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(de,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[ae.step,":"]}),e.jsx("span",{className:"text-purple-600",children:ae.detail})]})}),be&&!l&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(Re,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Workflow stopped"})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("collect-feedback"),H.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["collect-feedback"].description}),e.jsxs("button",{onClick:ue,disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Pe,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(d.collectedFeedback.pages).length>0&&(()=>{const t=Object.values(d.collectedFeedback.pages),s=t.reduce((y,C)=>y+C.fixableIssues.length,0),f=t.reduce((y,C)=>y+C.entityIssues.length,0),g=t.reduce((y,C)=>{var _;return y+(((_=C.objectIssues)==null?void 0:_.length)||0)},0),i=t.reduce((y,C)=>{var _;return y+(((_=C.semanticIssues)==null?void 0:_.length)||0)},0),o=s+f+g+i,S=Object.values(d.reEvaluationResults.pages),O=S.reduce((y,C)=>{var _;return y+(((_=C.fixableIssues)==null?void 0:_.length)||0)},0),E=S.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",o," issues from generation + ",E?`${O} from re-evaluation`:"re-evaluate for fresh data"]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[s>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",s]}),f>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",f]}),g>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",g]}),i>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",i]}),E&&O>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",O]}),o===0&&!E&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"No issues detected (run re-evaluate for fresh assessment)"}),o===0&&E&&O===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:t.sort((y,C)=>y.pageNumber-C.pageNumber).map(y=>e.jsx(De,{feedback:y,isMarkedForRedo:d.redoPages.pageNumbers.includes(y.pageNumber),onToggleRedo:()=>Z(y.pageNumber),onUpdateNotes:C=>ge(y.pageNumber,{manualNotes:C})},y.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("identify-redo-pages"),H.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>me(6,3),disabled:N||d.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ie,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),d.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",d.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.redoPages.pageNumbers.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:d.redoPages.reasons[t],children:["Page ",t,e.jsx("button",{onClick:()=>Z(t),className:"hover:text-red-900",children:e.jsx(Ie,{className:"w-3 h-3"})})]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("redo-pages"),H.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["redo-pages"].description}),e.jsxs("button",{onClick:xe,disabled:N||d.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Te,{className:"w-4 h-4"}),"Redo ",d.redoPages.pageNumbers.length," Pages"]}),J.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",J.current," / ",J.total]}),J.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",J.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${J.current/J.total*100}%`}})})]}),d.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",d.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.redoResults.pagesCompleted.map(t=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",t," (v",d.redoResults.newVersions[t]??"?",")"]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("re-evaluate"),H.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[d.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>le(),disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(pe,{className:"w-4 h-4"}),"Re-evaluate ",d.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>le(I.map(t=>t.pageNumber)),disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(pe,{className:"w-4 h-4"}),"Re-evaluate All ",I.length," Pages"]})]}),Object.keys(d.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(d.reEvaluationResults.pages).map(([t,s])=>{var o,S,O,E,y;const f=s.score??s.qualityScore,g=s.qualityScore,i=s.semanticScore;return s.score===null&&s.qualityScore!==null&&console.warn(`[RepairWorkflow] Page ${t}: Missing combined score, using qualityScore fallback`),e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-medium",children:["Page ",t,":"]}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:["Quality: ",g,"%"]}),i!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",i,"%"]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${f>=70?"bg-green-100 text-green-700":f>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",f,"%"]}),s.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${s.verdict==="PASS"?"bg-green-100 text-green-700":s.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:s.verdict}),s.fixableIssues&&s.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",s.fixableIssues.length," fixable issues)"]})]}),s.issuesSummary&&s.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${s.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:s.issuesSummary}),s.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["ðŸ” Semantic Analysis (Score: ",s.semanticResult.score??"N/A","):"]}),s.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸ‘ï¸ Visible:"}),s.semanticResult.visible.characters&&s.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.visible.characters.join(", ")]}),s.semanticResult.visible.objects&&s.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.visible.objects.join(", ")]}),s.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.visible.setting]}),s.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸŽ¯ Expected:"}),((o=s.semanticResult.expected)==null?void 0:o.characters)&&s.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.expected.characters.join(", ")]}),((S=s.semanticResult.expected)==null?void 0:S.objects)&&s.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.expected.objects.join(", ")]}),((O=s.semanticResult.expected)==null?void 0:O.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.expected.setting]}),((E=s.semanticResult.expected)==null?void 0:E.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.expected.action]})]})]}),s.semanticResult.semanticIssues&&s.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:s.semanticResult.semanticIssues.map((C,_)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${C.severity==="CRITICAL"?"text-red-600":C.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",C.severity,"]"]})," ",C.problem]},_))}),((y=s.semanticResult.semanticIssues)==null?void 0:y.length)===0&&!s.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"âœ“ No issues"})]})]},t)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("consistency-check"),H.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["consistency-check"].description}),e.jsxs("button",{onClick:()=>ee(),disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Se,{className:"w-4 h-4"}),"Run Consistency Check"]}),d.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${d.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:d.consistencyResults.report.overallConsistent?"All characters consistent!":`${d.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:d.consistencyResults.report.summary})]}),Object.entries(d.consistencyResults.report.characters||{}).map(([t,s])=>{var f,g;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${s.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:t}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${s.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",s.overallScore??s.score??"?","/10",(s.totalIssues??((f=s.issues)==null?void 0:f.length)??0)>0&&` â€¢ ${s.totalIssues??((g=s.issues)==null?void 0:g.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[s.byClothing&&Object.entries(s.byClothing).map(([i,o])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:i}),e.jsxs("span",{className:`text-xs ${o.score>=7?"text-green-600":"text-amber-600"}`,children:[o.score,"/10"]})]}),o.issues&&o.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:o.issues.map((S,O)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${S.severity==="critical"?"bg-red-400":S.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[S.description,S.pagesToFix&&S.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",S.pagesToFix.join(", "),")"]})]})]},O))})]},i)),!s.byClothing&&s.issues&&s.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:s.issues.map((i,o)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${i.severity==="critical"?"bg-red-400":i.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:i.description})]},o))}),(!s.byClothing||Object.values(s.byClothing).every(i=>{var o;return!((o=i.issues)!=null&&o.length)}))&&(!s.issues||s.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},t)}),R.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:R.map(t=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:t},t))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("character-repair"),H.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:r,onChange:t=>{P(t.target.value),q([])},className:"w-full p-2 border rounded text-sm",disabled:N,children:[e.jsx("option",{value:"",children:"Choose a character..."}),R.map(t=>e.jsxs("option",{value:t,children:[t," (has issues)"]},t)),B.filter(t=>!R.includes(t.name)).map(t=>e.jsx("option",{value:t.name,children:t.name},t.name))]})]}),r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const t=ye(r);q(t)},disabled:N||d.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(ie,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:I.map(t=>e.jsxs("button",{onClick:()=>{q(s=>s.includes(t.pageNumber)?s.filter(f=>f!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${w.includes(t.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:N,children:["Page ",t.pageNumber]},t.pageNumber))})]}),G&&D&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("label",{className:"text-sm font-medium text-blue-800 mb-2 block",children:"Repair Method:"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:!m,onChange:()=>D(!1),className:"text-blue-600",disabled:N}),e.jsx("span",{className:"text-sm",children:"Gemini (default)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:m,onChange:()=>D(!0),className:"text-blue-600",disabled:N}),e.jsx("span",{className:"text-sm",children:"MagicAPI Face+Hair"}),e.jsx("span",{className:"text-xs text-blue-600",children:"(~$0.006/repair)"})]})]}),m&&e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Uses face swap + hair fix pipeline with iterative crop checking"})]}),e.jsxs("button",{onClick:async()=>{await ce(r,w,{useMagicApiRepair:m}),b&&await b()},disabled:N||!r||w.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(ke,{className:"w-4 h-4"}),"Repair ",r||"Character"," on ",w.length," pages",m&&e.jsx("span",{className:"text-xs opacity-75",children:"(MagicAPI)"})]}),Object.keys(d.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800 mb-2",children:"Repair Results:"}),Object.entries(d.characterRepairResults.pagesRepaired).map(([t,s])=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[t,":"]})," ",e.jsxs("span",{className:"text-gray-600",children:["Pages ",s.join(", ")]})]},t))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("artifact-repair"),H.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>h(F),disabled:N||F.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(ie,{className:"w-3 h-3"}),"Auto-Identify (",F.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:F.length>0?F.map(t=>e.jsxs("button",{onClick:()=>{h(s=>s.includes(t)?s.filter(f=>f!==t):[...s,t])},className:`px-2 py-1 text-xs rounded border transition-colors ${k.includes(t)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:N,children:["Page ",t]},t)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),F.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),I.map(t=>e.jsxs("button",{onClick:()=>{h(s=>s.includes(t.pageNumber)?s.filter(f=>f!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${k.includes(t.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:N,children:["Page ",t.pageNumber]},t.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await se(k),b&&await b()},disabled:N||k.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Run Grid Repair on ",k.length," pages"]}),d.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",d.artifactRepairResults.pagesProcessed.length," pages, fixed ",d.artifactRepairResults.issuesFixed," issues"]})})]})]})]})]}):null}export{Ye as RepairWorkflowPanel,Ye as default};
