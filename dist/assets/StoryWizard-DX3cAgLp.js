const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WizardStep2Characters-DnjRBTBh.js","assets/index-CaMXNLRt.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-Cx3TGXLP.css","assets/Input-CceRB9w-.js","assets/Textarea-BckDNxSW.js","assets/sparkles-UkDH1caR.js","assets/book-open-Dp5sy5FP.js","assets/check-BYcBn5zH.js","assets/pen-BP5wsPMq.js","assets/trash-2-CTJvYzg9.js","assets/Modal-BzwjZMOd.js","assets/download-bwchrUzQ.js","assets/chevron-right-BKxciC_3.js","assets/arrow-right-CVPMJ1jt.js","assets/camera-Bll-VXFs.js","assets/pencil-BDgCzg_N.js","assets/circle-x-DzYci4SR.js","assets/clock-CGvzYkJT.js","assets/palette-Dh3oYzfb.js","assets/book-pgdgkuQr.js","assets/shopping-cart-DqkABsLa.js","assets/arrow-left-pQDBQ5qk.js","assets/WizardStep4StoryType-CdMd0XZq.js","assets/WizardStep5ArtStyle-Bxu3io_W.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-DJ1RXrzz.js"])))=>i.map(i=>d[i]);
import{c as Xe,b as Ge,d as fa,j as e,X as Et,u as Lt,a as ba,L as ft,T as pn,C as qa,E as ki,e as Ai,f as Pi,s as Oe,g as Ua,_ as cs}from"./index-CaMXNLRt.js";import{b as d,u as Ti,e as $i}from"./vendor-react-CqfXSjHo.js";import{U as ya,B as Fs,I as Ka}from"./Input-CceRB9w-.js";import{S as Ii,A as Ja,N as Di}from"./Textarea-BckDNxSW.js";import{C as Ei}from"./circle-x-DzYci4SR.js";import{C as zi}from"./clock-CGvzYkJT.js";import{M as fn,H as Fi,C as Qa,R as Gt,F as Br,P as Za,a as Ri,I as Ya,b as Bi}from"./Modal-BzwjZMOd.js";import{D as vr,C as Ut}from"./download-bwchrUzQ.js";import{C as ha}from"./chevron-right-BKxciC_3.js";import{P as bn}from"./palette-Dh3oYzfb.js";import{B as Mi}from"./book-pgdgkuQr.js";import{C as Gi}from"./check-BYcBn5zH.js";import{S as Xa}from"./shopping-cart-DqkABsLa.js";import{B as Rs}from"./book-open-Dp5sy5FP.js";import{S as Gr}from"./sparkles-UkDH1caR.js";import{A as en}from"./arrow-left-pQDBQ5qk.js";import{A as Li}from"./arrow-right-CVPMJ1jt.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oi=Xe("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hi=Xe("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _i=Xe("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=Xe("Images",[["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"m22 13-1.296-1.296a2.41 2.41 0 0 0-3.408 0L11 18",key:"nf6bnh"}],["circle",{cx:"12",cy:"8",r:"2",key:"1822b1"}],["rect",{width:"16",height:"16",x:"6",y:"2",rx:"2",key:"12espp"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wi=Xe("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vi=Xe("Link2Off",[["path",{d:"M9 17H7A5 5 0 0 1 7 7",key:"10o201"}],["path",{d:"M15 7h2a5 5 0 0 1 4 8",key:"1d3206"}],["line",{x1:"8",x2:"12",y1:"12",y2:"12",key:"rvw6j4"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qi=Xe("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=Xe("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ui=Xe("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ki=Xe("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=Xe("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rr=Xe("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ji=Xe("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tn=Xe("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qi=Xe("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zi=Xe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ma=Xe("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $s=Xe("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]),Yi={async login(t,l){const i=await Ge.post("/api/auth/login",{username:t,password:l},{skipAuth:!0}),f={id:i.user.id,username:i.user.username,email:i.user.email,role:i.user.role,credits:i.user.credits};return{token:i.token,user:f}},async register(t,l,i){return Ge.post("/api/auth/register",{username:t,password:l,email:i},{skipAuth:!0})},async loginWithFirebase(t){const l=await Ge.post("/api/auth/firebase",{idToken:t},{skipAuth:!0}),i={id:l.user.id,username:l.user.username,email:l.user.email,role:l.user.role,credits:l.user.credits};return{token:l.token,user:i}},async getQuota(){const t=await Ge.get("/api/user/quota");return{storyQuota:t.storyQuota,storiesGenerated:t.storiesGenerated,remaining:t.remaining}},async getCredits(){const t=await Ge.get("/api/user/quota");return{credits:t.credits,unlimited:t.unlimited}},async updateEmail(t){await Ge.put("/api/user/update-email",{email:t})},async getShippingAddress(){try{return await Ge.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(t){await Ge.put("/api/user/shipping-address",t)}},ie=fa("CharacterService");function yn(t){if(!t)return;const l=parseInt(t,10);if(!(isNaN(l)||l<0))return l<=1?"infant":l<=2?"toddler":l<=4?"preschooler":l<=6?"kindergartner":l<=8?"young-school-age":l<=10?"school-age":l<=12?"preteen":l<=14?"young-teen":l<=17?"teenager":l<=25?"young-adult":l<=39?"adult":l<=59?"middle-aged":l<=75?"senior":"elderly"}function ua(t){const l={height:t.height,build:t.build,face:t.other_features||t.otherFeatures,eyeColor:t.eye_color||t.eyeColor,hairColor:t.hair_color||t.hairColor,hairLength:t.hair_length||t.hairLength,hairStyle:t.hair_style||t.hairStyle,facialHair:t.facial_hair||t.facialHair,skinTone:t.skin_tone||t.skinTone,skinUndertone:t.skin_undertone||t.skinUndertone,skinToneHex:t.skin_tone_hex||t.skinToneHex,hair:t.hair_color||t.hairColor,other:t.other,detailedHairAnalysis:t.detailed_hair_analysis||t.detailedHairAnalysis,apparentAge:t.apparent_age||t.apparentAge},i=t.age_category||t.ageCategory||yn(t.age);return{id:t.id,name:t.name,gender:t.gender,age:t.age,ageCategory:i,physical:l.height||l.build||l.face||l.eyeColor||l.hairColor||l.hairLength||l.hairStyle||l.facialHair||l.skinTone||l.hair||l.other||l.detailedHairAnalysis||l.apparentAge?l:void 0,physicalTraitsSource:t.physical_traits_source||t.physicalTraitsSource,traits:{strengths:t.strengths||[],flaws:t.flaws||t.weaknesses||[],challenges:t.challenges||t.fears||[],specialDetails:t.special_details||t.specialDetails},photos:{original:t.photo_url||t.photoUrl,face:t.thumbnail_url||t.thumbnailUrl,body:t.body_photo_url||t.bodyPhotoUrl,bodyNoBg:t.body_no_bg_url||t.bodyNoBgUrl,faceBox:t.face_box||t.faceBox,bodyBox:t.body_box||t.bodyBox},avatars:t.avatars||t.clothing_avatars||t.clothingAvatars,clothing:t.clothing||t.structured_clothing||t.structuredClothing?{current:t.clothing,structured:t.structured_clothing||t.structuredClothing}:void 0,generatedOutfits:t.generated_outfits||t.generatedOutfits,storyRole:t.storyRole}}function rn(t){var i,f,s,k,h,A,o,M,D,C,E,v,p,b,G,O,_,ee,se,z,ne,Z,J,$;const l=t.ageCategory||yn(t.age);return{id:t.id,name:t.name,gender:t.gender,age:t.age,age_category:l,apparent_age:(i=t.physical)==null?void 0:i.apparentAge,height:(f=t.physical)==null?void 0:f.height,build:(s=t.physical)==null?void 0:s.build,eye_color:(k=t.physical)==null?void 0:k.eyeColor,hair_color:(h=t.physical)==null?void 0:h.hairColor,hair_length:(A=t.physical)==null?void 0:A.hairLength,hair_style:(o=t.physical)==null?void 0:o.hairStyle,facial_hair:(M=t.physical)==null?void 0:M.facialHair,skin_tone:(D=t.physical)==null?void 0:D.skinTone,skin_undertone:(C=t.physical)==null?void 0:C.skinUndertone,skin_tone_hex:(E=t.physical)==null?void 0:E.skinToneHex,other_features:(v=t.physical)==null?void 0:v.face,other:(p=t.physical)==null?void 0:p.other,detailed_hair_analysis:(b=t.physical)==null?void 0:b.detailedHairAnalysis,physical_traits_source:t.physicalTraitsSource,face_box:(G=t.photos)==null?void 0:G.faceBox,body_box:(O=t.photos)==null?void 0:O.bodyBox,strengths:(_=t.traits)==null?void 0:_.strengths,flaws:(ee=t.traits)==null?void 0:ee.flaws,challenges:(se=t.traits)==null?void 0:se.challenges,special_details:(z=t.traits)==null?void 0:z.specialDetails,weaknesses:(ne=t.traits)==null?void 0:ne.flaws,fears:(Z=t.traits)==null?void 0:Z.challenges,clothing:(J=t.clothing)==null?void 0:J.current,structured_clothing:($=t.clothing)==null?void 0:$.structured,generated_outfits:t.generatedOutfits,storyRole:t.storyRole}}function Xi(t){return!t||t.length===0?[]:typeof t[0]=="string"?t.map(l=>({forward:l,inverse:l})):t}const Ie={async getCharacters(t=!1){const l=t?"/api/characters?includeAllAvatars=true":"/api/characters";return((await Ge.get(l)).characters||[]).map(ua)},async getCharacterData(t=!1){const l=t?"/api/characters?includeAllAvatars=true":"/api/characters",i=await Ge.get(l);return{characters:(i.characters||[]).map(ua),relationships:i.relationships||{},relationshipTexts:i.relationshipTexts||{},customRelationships:Xi(i.customRelationships),customStrengths:i.customStrengths||[],customWeaknesses:i.customWeaknesses||[],customFears:i.customFears||[]}},async saveCharacters(t){await Ge.post("/api/characters",{characters:t.map(rn)})},async saveCharacterData(t,l){const i=s=>{var h,A,o,M;const k=rn(s);return l!=null&&l.includePhotos&&(k.photo_url=(h=s.photos)==null?void 0:h.original,k.thumbnail_url=(A=s.photos)==null?void 0:A.face,k.body_photo_url=(o=s.photos)==null?void 0:o.body,k.body_no_bg_url=(M=s.photos)==null?void 0:M.bodyNoBg),k},f={characters:t.characters.map(i),relationships:t.relationships,relationshipTexts:t.relationshipTexts,customRelationships:t.customRelationships,customStrengths:t.customStrengths,customWeaknesses:t.customWeaknesses,customFears:t.customFears};await Ge.post("/api/characters",f)},async deleteCharacter(t){try{const l=await Ge.delete(`/api/characters/${t}`);return ie.success(`Deleted character ${t}: ${l.message}`),{success:!0}}catch(l){return ie.error(`Failed to delete character ${t}:`,l),{success:!1,error:String(l)}}},async saveCharacterRoles(t){try{return await Ge.put("/api/characters/roles",{roles:t}),ie.success(`Saved character roles: ${Object.keys(t).length} characters`),{success:!0}}catch(l){return ie.error("Failed to save character roles:",l),{success:!1,error:String(l)}}},async loadCharacterAvatars(t){try{const l=await Ge.get(`/api/characters/${t}/avatars`);return ie.info(`Loaded full avatars for character ${t}`),l.avatars||null}catch(l){return ie.error(`Failed to load avatars for character ${t}:`,l),null}},async loadFullCharacter(t){try{const l=await Ge.get(`/api/characters/${t}/full`);return l.character?(ie.info(`Loaded full data for character ${t}`),ua(l.character)):null}catch(l){return ie.error(`Failed to load full data for character ${t}:`,l),null}},async generateAvatarOptions(t,l){try{return await Ge.post("/api/generate-avatar-options",{facePhoto:t,gender:l,category:"standard"})}catch(i){const f=i instanceof Error?i.message:"Unknown error";return{success:!1,options:[],error:f}}},async generateClothingAvatars(t,l){var i,f,s,k,h,A,o,M,D,C,E;try{const v=parseInt(t.age)||10,p=t.gender||"child";let b;p==="male"?b=v>=18?"man":"boy":p==="female"?b=v>=18?"woman":"girl":b=v>=18?"person":"child";let O=`${((i=t.name)==null?void 0:i.trim())||`This ${b}`} is a ${v}-year-old ${b}`;t.physical&&(t.physical.hair&&(O+=`, ${t.physical.hair}`),t.physical.face&&(O+=`, ${t.physical.face}`),t.physical.build&&(O+=`, ${t.physical.build}`),t.physical.other&&(O+=`, ${t.physical.other}`));const _=((f=t.photos)==null?void 0:f.bodyNoBg)||((s=t.photos)==null?void 0:s.body)||((k=t.photos)==null?void 0:k.face)||((h=t.photos)==null?void 0:h.original);ie.info(`ðŸŽ¨ Generating clothing avatars for ${t.name||"unnamed"} (id: ${t.id})`);const ee=await Ge.post("/api/generate-clothing-avatars?async=true",{characterId:t.id,facePhoto:_,physicalDescription:O,name:t.name,age:t.age,apparentAge:(A=t.physical)==null?void 0:A.apparentAge,gender:t.gender,build:(o=t.physical)==null?void 0:o.build,clothing:(M=t.clothing)==null?void 0:M.structured,avatarModel:l==null?void 0:l.avatarModel});if(ee.async&&ee.jobId){ie.info(`Avatar job started: ${ee.jobId}, polling for completion...`);const z=60,ne=2e3;for(let Z=0;Z<z;Z++){await new Promise($=>setTimeout($,ne));const J=await Ge.get(`/api/avatar-jobs/${ee.jobId}`);if(J.status==="complete"&&J.clothingAvatars){ie.success(`Avatar job ${ee.jobId} completed after ${(Z+1)*2}s`);const $=J.clothingAvatars.extractedTraits,re=(D=J.clothingAvatars.structuredClothing)==null?void 0:D.standard;return ie.info(`ðŸ” [DEBUG] extractedTraits: ${(C=JSON.stringify($))==null?void 0:C.substring(0,100)}`),ie.info(`ðŸ” [DEBUG] extractedClothing: ${JSON.stringify(re)}`),ie.info(`ðŸ” [DEBUG] structuredClothing keys: ${Object.keys(J.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:J.clothingAvatars,extractedTraits:$,extractedClothing:re}}if(J.status==="failed")return ie.error(`Avatar job failed: ${J.error}`),{success:!1,error:J.error};Z%5===0&&ie.info(`Avatar job ${ee.jobId}: ${J.message||J.status} (${J.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const se=ee;if(se.success&&se.clothingAvatars){ie.success(`Clothing avatars generated for ${t.name}`);const z=se.clothingAvatars.extractedTraits,ne=(E=se.clothingAvatars.structuredClothing)==null?void 0:E.standard;return z&&ie.info(`Extracted traits: ${JSON.stringify(z)}`),ne&&ie.info(`Extracted clothing: ${JSON.stringify(ne)}`),{success:!0,avatars:se.clothingAvatars,extractedTraits:z,extractedClothing:ne}}else return ie.error(`Failed to generate avatars: ${se.error}`),{success:!1,error:se.error}}catch(v){return ie.error("Clothing avatar generation failed:",v),{success:!1,error:String(v)}}},async generateClothingAvatarsWithTraits(t){var l,i,f,s,k,h,A,o,M,D,C,E,v,p,b,G,O,_;try{const ee=parseInt(t.age)||10,se=t.gender||"child";let z;se==="male"?z=ee>=18?"man":"boy":se==="female"?z=ee>=18?"woman":"girl":z=ee>=18?"person":"child";let Z=`${((l=t.name)==null?void 0:l.trim())||`This ${z}`} is a ${ee}-year-old ${z}`;t.physical&&(t.physical.hair&&(Z+=`, ${t.physical.hair}`),t.physical.face&&(Z+=`, ${t.physical.face}`),t.physical.build&&(Z+=`, ${t.physical.build}`),t.physical.other&&(Z+=`, ${t.physical.other}`));const J=((i=t.photos)==null?void 0:i.bodyNoBg)||((f=t.photos)==null?void 0:f.body)||((s=t.photos)==null?void 0:s.face)||((k=t.photos)==null?void 0:k.original),$=(h=t.photos)!=null&&h.bodyNoBg?"bodyNoBg":(A=t.photos)!=null&&A.body?"body":(o=t.photos)!=null&&o.face?"face":"original",re=J?Math.round(J.length/1024):0,xe=J==null?void 0:J.startsWith("data:image/png");ie.info(`ðŸŽ¨ Generating clothing avatars WITH TRAITS for ${t.name} (id: ${t.id})`),ie.info(`ðŸ“¸ Photo source: ${$}, size: ${re}KB, format: ${xe?"PNG":"JPEG"}`),ie.info(`ðŸ“¸ Available photos: bodyNoBg=${!!((M=t.photos)!=null&&M.bodyNoBg)}, body=${!!((D=t.photos)!=null&&D.body)}, face=${!!((C=t.photos)!=null&&C.face)}, original=${!!((E=t.photos)!=null&&E.original)}`),ie.info(`Physical traits: ${JSON.stringify(t.physical)}`);const be=t.physicalTraitsSource||{};ie.info(`Physical traits source: ${JSON.stringify(be)}`),ie.info(`Physical skinTone value: '${(v=t.physical)==null?void 0:v.skinTone}', source: '${be.skinTone}'`),ie.info(`Physical hairStyle value: '${(p=t.physical)==null?void 0:p.hairStyle}', source: '${be.hairStyle}'`);const je={};t.physical&&(be.eyeColor==="user"&&t.physical.eyeColor&&(je.eyeColor=t.physical.eyeColor),be.hairColor==="user"&&t.physical.hairColor&&(je.hairColor=t.physical.hairColor),be.hairLength==="user"&&t.physical.hairLength&&(je.hairLength=t.physical.hairLength),be.hairStyle==="user"&&t.physical.hairStyle&&(je.hairStyle=t.physical.hairStyle),be.build==="user"&&t.physical.build&&(je.build=t.physical.build),be.skinTone==="user"&&t.physical.skinTone&&(je.skinTone=t.physical.skinTone,t.physical.skinToneHex&&(je.skinToneHex=t.physical.skinToneHex)),be.face==="user"&&t.physical.face&&(je.face=t.physical.face),be.facialHair==="user"&&t.physical.facialHair&&(je.facialHair=t.physical.facialHair),be.other==="user"&&t.physical.other&&(je.other=t.physical.other));const oe=Object.keys(je).length>0;ie.info(`Physical traits to send (user-edited only): ${oe?JSON.stringify(je):"none"}`);const we=t.clothingSource||{},Ee={};(b=t.clothing)!=null&&b.structured&&(we.upperBody==="user"&&t.clothing.structured.upperBody&&(Ee.upperBody=t.clothing.structured.upperBody),we.lowerBody==="user"&&t.clothing.structured.lowerBody&&(Ee.lowerBody=t.clothing.structured.lowerBody),we.shoes==="user"&&t.clothing.structured.shoes&&(Ee.shoes=t.clothing.structured.shoes),we.fullBody==="user"&&t.clothing.structured.fullBody&&(Ee.fullBody=t.clothing.structured.fullBody));const Re=Object.keys(Ee).length>0;ie.info(`Clothing to send (user-edited only): ${Re?JSON.stringify(Ee):"none"}`);const Y=await Ge.post("/api/generate-clothing-avatars?async=true",{characterId:t.id,facePhoto:J,physicalDescription:Z,name:t.name,age:t.age,apparentAge:(G=t.physical)==null?void 0:G.apparentAge,gender:t.gender,build:je.build||"average",physicalTraits:oe?je:void 0,clothing:Re?Ee:void 0});if(Y.async&&Y.jobId){ie.info(`Avatar job started: ${Y.jobId}, polling for completion...`);const Ve=60,Se=2e3;for(let qe=0;qe<Ve;qe++){await new Promise(ue=>setTimeout(ue,Se));const me=await Ge.get(`/api/avatar-jobs/${Y.jobId}`);if(me.status==="complete"&&me.clothingAvatars){ie.success(`Avatar job ${Y.jobId} completed after ${(qe+1)*2}s`);const ue=me.clothingAvatars.extractedTraits,W=(O=me.clothingAvatars.structuredClothing)==null?void 0:O.standard;return{success:!0,avatars:me.clothingAvatars,extractedTraits:ue,extractedClothing:W}}if(me.status==="failed")return ie.error(`Avatar job failed: ${me.error}`),{success:!1,error:me.error};qe%5===0&&ie.info(`Avatar job ${Y.jobId}: ${me.message||me.status} (${me.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(Y.success&&Y.clothingAvatars){ie.success(`Clothing avatars WITH TRAITS generated for ${t.name}`);const Ve=Y.clothingAvatars.extractedTraits,Se=(_=Y.clothingAvatars.structuredClothing)==null?void 0:_.standard;return{success:!0,avatars:Y.clothingAvatars,extractedTraits:Ve,extractedClothing:Se}}else return ie.error(`Failed to generate avatars with traits: ${Y.error}`),{success:!1,error:Y.error}}catch(ee){return ie.error("Clothing avatar generation with traits failed:",ee),{success:!1,error:String(ee)}}},async analyzePhoto(t,l,i,f,s){var k,h,A,o,M,D,C,E,v,p,b,G,O,_,ee,se,z,ne,Z,J;try{const $=await Ge.post("/api/analyze-photo",{imageData:t,language:l,selectedFaceId:i,cachedFaces:f,existingCharacterId:s});if(!$.success)return{success:!1,error:$.error};if($.multipleFacesDetected&&$.faces)return ie.info(`Multiple faces detected (${$.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:$.faceCount,faces:$.faces};const re={height:(k=$.attributes)==null?void 0:k.height,build:(h=$.attributes)==null?void 0:h.build,face:(A=$.attributes)==null?void 0:A.face,eyeColor:((o=$.attributes)==null?void 0:o.eye_color)||((M=$.attributes)==null?void 0:M.eyeColor),hairColor:((D=$.attributes)==null?void 0:D.hair_color)||((C=$.attributes)==null?void 0:C.hairColor),hairLength:((E=$.attributes)==null?void 0:E.hair_length)||((v=$.attributes)==null?void 0:v.hairLength),hairStyle:((p=$.attributes)==null?void 0:p.hair_style)||((b=$.attributes)==null?void 0:b.hairStyle),hair:((G=$.attributes)==null?void 0:G.hair_color)||((O=$.attributes)==null?void 0:O.hairColor),other:(_=$.attributes)==null?void 0:_.other_features};return{success:$.success,characterId:$.characterId,multipleFacesDetected:!1,faceCount:$.faceCount,photos:{face:$.faceThumbnail,body:$.bodyCrop,bodyNoBg:$.bodyNoBg,faceBox:$.faceBox,bodyBox:$.bodyBox},age:(ee=$.attributes)==null?void 0:ee.age,apparentAge:(se=$.attributes)==null?void 0:se.apparent_age,gender:(z=$.attributes)==null?void 0:z.gender,physical:re.height||re.build||re.face||re.eyeColor||re.hairColor||re.hairLength||re.hairStyle||re.hair||re.other?re:void 0,clothing:(ne=$.attributes)!=null&&ne.clothing||(Z=$.attributes)!=null&&Z.clothingStyle||(J=$.attributes)!=null&&J.clothingColors?{current:$.attributes.clothing,style:$.attributes.clothingStyle||$.attributes.clothingColors}:void 0,_debug:$._debug}}catch($){return ie.error("Photo analysis failed:",$),{success:!1,error:"unknown_error"}}},needsAvatars(t){var s,k,h,A;if(!!!((s=t.photos)!=null&&s.original||(k=t.photos)!=null&&k.face||(h=t.photos)!=null&&h.body||(A=t.photos)!=null&&A.bodyNoBg))return!1;const i=t.avatars;return i?i.status==="generating"||i.status==="pending"?!1:i.status==="failed"?!0:!!!(i.winter||i.standard||i.summer||i.formal||i.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(t,l,i){var s,k,h,A,o,M,D,C,E,v,p,b,G,O,_,ee,se,z,ne,Z;const f={characterId:t.id,characterName:t.name,success:!1};try{if(!!!((s=t.photos)!=null&&s.original||(k=t.photos)!=null&&k.face||(h=t.photos)!=null&&h.body||(A=t.photos)!=null&&A.bodyNoBg))return f.skipped=!0,f.skipReason="No photo available",f;l==null||l("generating",`Generating avatars for ${t.name}...`),ie.info(`ðŸŽ¨ Generating avatars for ${t.name} (id: ${t.id})${i!=null&&i.avatarModel?`, model: ${i.avatarModel}`:""}`);const $=await Ie.generateClothingAvatars(t,i);if(!$.success||!$.avatars)return f.error=$.error||"Avatar generation failed",l==null||l("error",f.error),f;f.avatars=$.avatars,f.extractedTraits=$.extractedTraits,f.extractedClothing=$.extractedClothing,l==null||l("saving",`Fetching updated data for ${t.name}...`);let re=null;const xe=30;for(let be=0;be<xe;be++){if(be>0){const je=Math.min(500*Math.pow(1.2,be),3e3);ie.info(`[AVATAR] Retry ${be+1}/${xe}: waiting ${Math.round(je)}ms for avatar data...`),await new Promise(oe=>setTimeout(oe,je))}if(re=await Ie.loadFullCharacter(t.id),(o=re==null?void 0:re.avatars)!=null&&o.standard||(M=re==null?void 0:re.avatars)!=null&&M.winter||(D=re==null?void 0:re.avatars)!=null&&D.summer){ie.info(`[AVATAR] Got fresh data with avatars on attempt ${be+1}`);break}}return re?(f.character=re,(C=re.avatars)!=null&&C.standard||(E=re.avatars)!=null&&E.winter||(v=re.avatars)!=null&&v.summer||ie.warn(`âš ï¸ Fresh DB data for ${t.name} missing avatars after ${xe} retries - server may not have saved them`),ie.info(`ðŸ“‹ Using server-saved data for ${t.name}`)):(ie.error(`âŒ Character ${t.name} (id: ${t.id}) not found in DB after avatar job - avatars lost!`),f.character={...t,avatars:{status:"failed"},physical:$.extractedTraits?{...t.physical,apparentAge:$.extractedTraits.apparentAge||((p=t.physical)==null?void 0:p.apparentAge),build:$.extractedTraits.build||((b=t.physical)==null?void 0:b.build),eyeColor:$.extractedTraits.eyeColor||((G=t.physical)==null?void 0:G.eyeColor),eyeColorHex:$.extractedTraits.eyeColorHex||((O=t.physical)==null?void 0:O.eyeColorHex),hairColor:$.extractedTraits.hairColor||((_=t.physical)==null?void 0:_.hairColor),hairColorHex:$.extractedTraits.hairColorHex||((ee=t.physical)==null?void 0:ee.hairColorHex),hairLength:$.extractedTraits.hairLength||((se=t.physical)==null?void 0:se.hairLength),hairStyle:$.extractedTraits.hairStyle||((z=t.physical)==null?void 0:z.hairStyle),skinTone:$.extractedTraits.skinTone||((ne=t.physical)==null?void 0:ne.skinTone),skinToneHex:$.extractedTraits.skinToneHex||((Z=t.physical)==null?void 0:Z.skinToneHex)}:t.physical,clothing:$.extractedClothing?{...t.clothing,structured:{upperBody:$.extractedClothing.upperBody||void 0,lowerBody:$.extractedClothing.lowerBody||void 0,shoes:$.extractedClothing.shoes||void 0,fullBody:$.extractedClothing.fullBody||void 0}}:t.clothing}),f.success=!0,l==null||l("complete",`Avatars saved for ${t.name}`),ie.success(`âœ… Avatars generated and saved for ${t.name}`),f}catch(J){return f.error=String(J),l==null||l("error",f.error),ie.error(`Failed to generate/save avatars for ${t.name}:`,J),f}},async generateAvatarsForCharacters(t,l){const{forceRegenerate:i=!1,maxConcurrent:f=2,onProgress:s}=l||{};ie.info("ðŸŽ¨ Starting batch avatar generation...");const k=await Ie.getCharacterData();let h;if(t&&t.length>0?h=k.characters.filter(E=>t.includes(E.id)):h=k.characters.filter(E=>{var v,p;return i?!!((v=E.photos)!=null&&v.original||(p=E.photos)!=null&&p.face):Ie.needsAvatars(E)}),h.length===0)return ie.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};ie.info(`Processing ${h.length} characters for avatar generation`);const A=[],o=new Map;for(let E=0;E<h.length;E+=f){const p=h.slice(E,E+f).map(async G=>{var _,ee,se,z,ne;const O={characterId:G.id,characterName:G.name,success:!1};try{if(!!!((_=G.photos)!=null&&_.original||(ee=G.photos)!=null&&ee.face||(se=G.photos)!=null&&se.body||(z=G.photos)!=null&&z.bodyNoBg))return O.skipped=!0,O.skipReason="No photo available",O;if(!i&&((ne=G.avatars)!=null&&ne.winter))return O.skipped=!0,O.skipReason="Avatars already exist",O;s==null||s(G.id,"generating",`Generating avatars for ${G.name}...`),ie.info(`ðŸŽ¨ Generating avatars for ${G.name}...`);const J=await Ie.generateClothingAvatars(G);return!J.success||!J.avatars?(O.error=J.error||"Avatar generation failed",s==null||s(G.id,"error",O.error),O):(O.avatars=J.avatars,O.success=!0,o.set(G.id,{...G,avatars:J.avatars}),s==null||s(G.id,"complete",`Avatars generated for ${G.name}`),ie.success(`âœ… Avatars generated for ${G.name}`),O)}catch(Z){return O.error=String(Z),s==null||s(G.id,"error",O.error),ie.error(`Failed to generate avatars for ${G.name}:`,Z),O}}),b=await Promise.all(p);A.push(...b)}if(o.size>0){ie.info(`ðŸ’¾ Saving ${o.size} character avatar updates...`);const E=await Ie.getCharacterData(),v=E.characters.map(p=>o.get(p.id)||p);await Ie.saveCharacterData({...E,characters:v}),ie.success(`ðŸ’¾ Saved character data for ${o.size} characters`)}const M=A.filter(E=>E.success).length,D=A.filter(E=>!E.success&&!E.skipped).length,C=A.filter(E=>E.skipped).length;return ie.info(`Avatar generation complete: ${M} success, ${D} failed, ${C} skipped`),{results:A,successCount:M,failCount:D,skipCount:C}},async regenerateAvatarsForCharacter(t,l,i){ie.info(`ðŸ”„ Regenerating avatars for character ${t}...`);const s=(await Ie.getCharacterData()).characters.find(h=>h.id===t);if(!s)return{characterId:t,characterName:"Unknown",success:!1,error:"Character not found"};const k={...s,avatars:{status:"pending"}};return Ie.generateAndSaveAvatarForCharacter(k,l?(h,A)=>l(h,A):void 0,i)}},sn={sm:"h-1",md:"h-2",lg:"h-3"},eo={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function to({value:t,max:l=100,label:i,showPercentage:f=!1,size:s="md",variant:k="gradient",className:h=""}){const A=Math.min(Math.max(t/l*100,0),100);return e.jsxs("div",{className:h,children:[(i||f)&&e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[i&&e.jsx("span",{className:"text-sm font-medium text-gray-700",children:i}),f&&e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(A),"%"]})]}),e.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${sn[s]}`,children:e.jsx("div",{className:`${sn[s]} ${eo[k]} rounded-full transition-all duration-500 ease-out`,style:{width:`${A}%`}})})]})}const or=fa("ImageLoad");function Is({src:t,alt:l,className:i,label:f}){const[s,k]=d.useState(!0),[h,A]=d.useState(null),o=d.useRef(0),M=d.useRef(null);d.useEffect(()=>{t&&t.length>100?(o.current=Date.now(),or.info(`â³ Loading ${f||l}`,{isBase64:t==null?void 0:t.startsWith("data:"),sizeKB:Math.round(t.length*3/4/1024)})):o.current=0,k(!0),A(null)},[t,l,f]);const D=()=>{if(k(!1),o.current===0){or.info(`âœ… Loaded ${f||l} (placeholder/empty)`);return}const E=Date.now()-o.current;A(E);const p=(t==null?void 0:t.startsWith("data:"))?Math.round(t.length*3/4/1024):null,b=M.current?`${M.current.naturalWidth}x${M.current.naturalHeight}`:"unknown";E<100?or.success(`âœ… Loaded ${f||l} in ${E}ms`,{sizeKB:p,naturalSize:b}):E<500?or.info(`âœ… Loaded ${f||l} in ${E}ms`,{sizeKB:p,naturalSize:b}):E<2e3?or.warn(`âš ï¸ Slow load: ${f||l} took ${E}ms`,{sizeKB:p,naturalSize:b}):or.error(`ðŸ¢ Very slow: ${f||l} took ${E}ms`,{sizeKB:p,naturalSize:b}),E>1e3&&ro({type:"slow_image_load",label:f||l,loadTimeMs:E,sizeKB:p,naturalSize:b,userAgent:navigator.userAgent,timestamp:new Date().toISOString()})},C=()=>{if(k(!1),o.current===0){or.error(`âŒ Failed to load ${f||l} (no data received)`);return}const E=Date.now()-o.current;or.error(`âŒ Failed to load ${f||l} after ${E}ms`)};return e.jsx("img",{ref:M,src:t,alt:l,className:i,onLoad:D,onError:C,draggable:!1})}async function ro(t){try{await fetch("/api/log-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errorType:"Performance",message:`Slow image load: ${t.label} took ${t.loadTimeMs}ms`,userAgent:t.userAgent,timestamp:t.timestamp,url:window.location.href})})}catch{}}function so({step:t,text:l}){const i=`wizard_helper_dismissed_${t}`,[f,s]=d.useState(()=>localStorage.getItem(i)==="true");d.useEffect(()=>{const h=localStorage.getItem(i)==="true";s(h)},[t,i]);const k=()=>{localStorage.setItem(i,"true"),s(!0)};return f?null:e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[e.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:l}),e.jsx("button",{onClick:k,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:e.jsx(Et,{size:16})})]})}function ao({current:t,total:l,message:i,isGenerating:f=!0,coverImages:s,jobId:k,onCancel:h,onMinimize:A,characters:o=[],isStalled:M=!1,onDismissStalled:D,isImpersonating:C=!1}){const{language:E}=Lt(),{user:v}=ba(),p=(v==null?void 0:v.role)==="admin"||C,[b,G]=d.useState(!1),[O,_]=d.useState(0),ee=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit fÃ¼r das grosse Abenteuer...",fr:"{name} se prÃ©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} Ã¼bt gerade die Heldenpose...",fr:"{name} s'entraÃ®ne Ã  prendre la pose du hÃ©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als NÃ¤chstes passiert!",fr:"{name} a hÃ¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} wÃ¤rmt sich fÃ¼r das bevorstehende Abenteuer auf...",fr:"{name} s'Ã©chauffe pour l'aventure Ã  venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir fÃ¼gen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au rÃ©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} flÃ¼stert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'Å“il au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne fÃ¼r die Geschichte...",fr:"{name} collectionne des Ã©toiles pour le rÃ©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],se=d.useRef({}),[z,ne]=d.useState(null),Z=d.useMemo(()=>o.filter(me=>{var W;const ue=me.avatars;return ue&&(((W=ue.faceThumbnails)==null?void 0:W.standard)||ue.standard||ue.summer||ue.winter||ue.formal||ue.hasFullAvatars)}),[o]),J=me=>{var ke;const ue=me.avatars;if(!ue)return"";if((ke=ue.faceThumbnails)!=null&&ke.standard)return ue.faceThumbnails.standard;const W=[];return ue.standard&&W.push(ue.standard),ue.summer&&W.push(ue.summer),ue.winter&&W.push(ue.winter),ue.formal&&W.push(ue.formal),W[Math.floor(Math.random()*W.length)]||""},$=d.useMemo(()=>{const me=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(Z.length===0)return me;const ue=[],W=Math.max(me.length,Z.length);for(let ke=0;ke<W;ke++)ue.push(me[ke%me.length]),ue.push({type:"character",char:Z[ke%Z.length]});return ue},[Z]);if(d.useEffect(()=>{if($.length<=1)return;const me=setInterval(()=>{_(ue=>(ue+1)%$.length)},8e3);return()=>clearInterval(me)},[$.length]),d.useEffect(()=>{if($.length===0)return;const me=$[O];if(me.type==="character"){const ue=me.char,W=J(ue),et=((se.current[ue.id]??-1)+1)%ee.length;se.current[ue.id]=et;const He=ee[et],bt=(E==="de"?He.de:E==="fr"?He.fr:He.en).replace("{name}",ue.name);ne({avatarUrl:W,message:bt})}else ne(null)},[O,$,E]),!f||l===0)return null;const re=l===100?t:Math.round(t/l*100),xe=me=>{if(me)return typeof me=="string"?me:me.imageData},be=xe(s==null?void 0:s.frontCover),je=xe(s==null?void 0:s.initialPage),oe=xe(s==null?void 0:s.backCover),we=!!be,Ee=!!je,Re=!!oe,Y=we||Ee||Re,Ve={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollstÃ¤ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erhÃ¤ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz persÃ¶nliches Abenteuer gestalten.',tipLocations:'FÃ¼ge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu fÃ¼r eine persÃ¶nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? FÃ¼r BilderbÃ¼cher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint hÃ¤ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"CrÃ©ation de votre histoire!",timeInfo:"Votre rÃ©cit commencera Ã  s'afficher dans environ 1 minute. Le rÃ©cit complet peut prendre jusqu'Ã  10 minutes.",emailInfo:"Vous recevrez un email quand votre rÃ©cit sera prÃªt.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre rÃ©cit continuera Ã  Ãªtre gÃ©nÃ©rÃ©.",tipCharacters:"Mieux vous dÃ©crivez vos personnages, plus le rÃ©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du rÃ©cit" vous permet de crÃ©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits prÃ©fÃ©rÃ©s Ã  "Intrigue / Contexte du rÃ©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique prÃ©fÃ©rÃ© ? Pour les livres d'images, l'aquarelle fonctionne trÃ¨s bien !",coversPreview:"AperÃ§u des couvertures",frontCover:"Avant",initialPage:"IntÃ©rieur",backCover:"ArriÃ¨re",cancelJob:"Annuler la gÃ©nÃ©ration",cancelling:"Annulation...",stalled:"La gÃ©nÃ©ration semble bloquÃ©e",stalledDesc:"Aucun progrÃ¨s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer Ã  attendre",continueInBackground:"Continuer en arriÃ¨re-plan"}},Se=Ve[E]||Ve.en,qe=({imageData:me,label:ue,isReady:W})=>e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${W?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:W&&me?e.jsx("img",{src:me,alt:ue,className:"w-full h-full object-cover"}):e.jsx(ft,{size:20,className:"animate-spin text-gray-400"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[W&&e.jsx(qa,{size:12,className:"text-green-500"}),e.jsx("span",{className:`text-xs ${W?"text-green-600 font-medium":"text-gray-400"}`,children:ue})]})]});return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${Y?"max-w-lg":"max-w-md"}`,children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("div",{className:"relative inline-block mb-3",children:[e.jsx(ft,{size:48,className:"animate-spin text-indigo-600"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"âœ¨"})]}),e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:Se.title})]}),!Y&&$.length>0&&e.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const me=$[O];if(me.type==="character"&&z)return e.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[e.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:e.jsx("img",{src:z.avatarUrl,alt:me.char.name,className:"w-full h-full object-contain"})}),e.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:z.message})]},`char-${me.char.id}-${O}`);if(me.type==="message"){const ue=me.key,W=Se[ue]||"",ke=ue==="timeInfo"?e.jsx(zi,{size:20,className:"text-indigo-500 shrink-0"}):ue==="emailInfo"?e.jsx(fn,{size:20,className:"text-indigo-500 shrink-0"}):e.jsx(qa,{size:20,className:"text-indigo-500 shrink-0"});return e.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[ke,e.jsx("p",{className:"text-sm text-gray-700",children:W})]})}return null})()}),Y&&e.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:Se.coversPreview}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(qe,{imageData:be,label:Se.frontCover,isReady:we}),e.jsx(qe,{imageData:je,label:Se.initialPage,isReady:Ee}),e.jsx(qe,{imageData:oe,label:Se.backCover,isReady:Re})]})]}),Y&&e.jsxs("div",{className:"mb-4 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[e.jsx(ft,{size:14,className:"animate-spin text-indigo-500"}),E==="de"?"Bilder fÃ¼r die Seiten werden jetzt erstellt...":E==="fr"?"CrÃ©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:E==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":E==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),e.jsx("div",{className:"mb-4",children:e.jsx(to,{value:re,max:100,showPercentage:!0,size:"lg"})}),A&&e.jsx("button",{onClick:A,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:Se.continueInBackground}),M&&e.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(pn,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:Se.stalled}),e.jsx("p",{className:"text-sm text-amber-700 mb-3",children:Se.stalledDesc}),e.jsxs("div",{className:"flex gap-2",children:[D&&e.jsx("button",{onClick:D,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:Se.continueWaiting}),h&&e.jsx("button",{onClick:()=>{if(!b){G(!0);try{h()}finally{G(!1)}}},disabled:b,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:b?Se.cancelling:Se.cancelJob})]})]})]})}),p&&k&&h&&e.jsxs("button",{onClick:async()=>{if(!b){G(!0);try{h()}finally{G(!1)}}},disabled:b,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[b?e.jsx(ft,{size:16,className:"animate-spin"}):e.jsx(Ei,{size:16}),b?Se.cancelling:Se.cancelJob]})]})})}function Lr(t,l){const i=new Blob([t],{type:"text/plain;charset=utf-8"}),f=URL.createObjectURL(i),s=document.createElement("a");s.href=f,s.download=l,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(f)}function xa(t,l=0){const i="  ".repeat(l);if(t==null)return`${i}null`;if(typeof t=="boolean")return`${i}${t?"YES":"NO"}`;if(typeof t=="number")return`${i}${t}`;if(typeof t=="string")return`${i}${t}`;if(Array.isArray(t))return t.length===0?`${i}[]`:t.map((f,s)=>`${i}[${s}]: ${xa(f,0)}`).join(`
`);if(typeof t=="object"){const f=Object.entries(t);return f.length===0?`${i}{}`:f.map(([s,k])=>{const h=xa(k,l+1);return typeof k=="object"&&k!==null?`${i}${s}:
${h}`:`${i}${s}: ${h.trim()}`}).join(`
`)}return`${i}${String(t)}`}function Ds({data:t,language:l,title:i}){const[f,s]=d.useState(new Set);if(!t)return e.jsx("div",{className:"text-gray-400 italic text-sm",children:l==="de"?"Keine Daten":"No data"});let k=t;if(typeof t=="string")try{k=JSON.parse(t)}catch{return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-end mb-1",children:e.jsxs("button",{onClick:()=>Lr(t,`${i||"evaluation"}.txt`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Download as text file",children:[e.jsx(vr,{size:12})," Download"]})}),e.jsx("pre",{className:"text-sm whitespace-pre-wrap bg-gray-50 p-3 rounded max-h-80 overflow-auto font-mono",children:t})]})}const h=M=>{const D=new Set(f);D.has(M)?D.delete(M):D.add(M),s(D)},A=()=>{const M=xa(k);Lr(M,`${i||"evaluation"}.txt`)},o=(M,D,C=0)=>{const E=f.has(M);if(D==null)return e.jsx("span",{className:"text-gray-400",children:"null"});if(typeof D=="boolean")return e.jsx("span",{className:D?"text-green-600 font-medium":"text-red-600 font-medium",children:D?"âœ“":"âœ—"});if(typeof D=="number"){const v=D>=70?"text-green-600":D>=50?"text-yellow-600":"text-red-600";return e.jsx("span",{className:`font-bold ${v}`,children:D})}if(typeof D=="string")return D.length>100?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>h(M),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[E?e.jsx(Ut,{size:14}):e.jsx(ha,{size:14}),E?"Collapse":`Show (${D.length} chars)`]}),E&&e.jsx("div",{className:"mt-1 p-2 bg-gray-100 rounded text-sm whitespace-pre-wrap font-mono",children:D})]}):e.jsx("span",{className:"text-gray-700",children:D});if(Array.isArray(D))return D.length===0?e.jsx("span",{className:"text-gray-400",children:"[]"}):e.jsx("div",{className:"ml-2 border-l-2 border-gray-200 pl-2",children:D.map((v,p)=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"text-gray-400 text-xs",children:["[",p,"]"]})," ",o(`${M}.${p}`,v,C+1)]},p))});if(typeof D=="object"){const v=Object.entries(D);return v.length===0?e.jsx("span",{className:"text-gray-400",children:"{}"}):C>0?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>h(M),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[E?e.jsx(Ut,{size:14}):e.jsx(ha,{size:14}),E?"Collapse":`{${v.length} fields}`]}),E&&e.jsx("div",{className:"ml-2 mt-1 border-l-2 border-gray-200 pl-2",children:v.map(([p,b])=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium text-gray-600",children:[p,":"]})," ",o(`${M}.${p}`,b,C+1)]},p))})]}):e.jsx("div",{className:"space-y-1",children:v.map(([p,b])=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-medium text-gray-600 min-w-[100px]",children:[p,":"]}),e.jsx("div",{className:"flex-1",children:o(`${M}.${p}`,b,C+1)})]},p))})}return e.jsx("span",{children:String(D)})};return e.jsxs("div",{className:"text-sm space-y-1 max-h-[500px] overflow-auto",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:A,className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",title:"Download as text file",children:[e.jsx(vr,{size:12})," Download"]})}),o("root",k)]})}function no({beforeImage:t,maskImage:l,onEnlarge:i}){return e.jsxs("div",{className:"relative w-40 h-40 cursor-pointer hover:ring-2 hover:ring-amber-400 rounded overflow-hidden border",onClick:()=>i(t,"Before with Mask"),children:[e.jsx("img",{src:t,alt:"Before",className:"w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 w-full h-full",style:{backgroundImage:`url(${l})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",mixBlendMode:"multiply",opacity:.5}}),e.jsx("img",{src:l,alt:"Mask overlay",className:"absolute inset-0 w-full h-full object-contain pointer-events-none",style:{mixBlendMode:"screen",opacity:.7,filter:"sepia(1) saturate(5) hue-rotate(-50deg)"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-[10px] text-center py-1 font-medium",children:"ðŸŽ¯ Edit Area"})]})}function Mr({retryHistory:t,totalAttempts:l,language:i,onRevertRepair:f}){const[s,k]=d.useState(null);if(!t||t.length===0)return null;const h=t.filter(o=>o.type==="auto_repair"||o.type==="grid_repair").length,A=t.filter(o=>o.type==="grid_repair").length;return e.jsxs(e.Fragment,{children:[s&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>k(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:s.title}),e.jsx("img",{src:s.src,alt:s.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>k(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-purple-700 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Fi,{size:14}),i==="de"?"Generierungshistorie":i==="fr"?"Historique de gÃ©nÃ©ration":"Generation History",h>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["ðŸ”§ ",h," ",i==="de"?"Reparatur":"repair",h>1?i==="de"?"en":"s":"",A>0&&e.jsxs("span",{className:"ml-1",children:["(",A," grid)"]})]})]}),e.jsxs("span",{className:"text-purple-600",children:[l," ",i==="de"?"Versuche":i==="fr"?"tentatives":"attempts"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:t.map((o,M)=>{var D,C,E,v;return e.jsxs("div",{className:`border rounded-lg p-3 ${o.type==="grid_repair"?"bg-violet-50 border-violet-300":o.type==="auto_repair"?"bg-amber-50 border-amber-300":M===t.length-1?"bg-green-50 border-green-300":"bg-white border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[o.type==="grid_repair"?e.jsx("span",{className:"text-violet-700",children:"ðŸ”² Grid Repair"}):o.type==="auto_repair"?e.jsx("span",{className:"text-amber-700",children:"ðŸ”§ Auto-Repair"}):e.jsx(e.Fragment,{children:i==="de"?`Versuch ${o.attempt}`:i==="fr"?`Tentative ${o.attempt}`:`Attempt ${o.attempt}`}),o.type==="text_edit"&&e.jsx("span",{className:"text-xs ml-2 text-blue-600",children:"(text edit)"}),o.type==="text_edit_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(text edit failed)"}),o.type==="auto_repair_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(auto-repair failed)"}),M===t.length-1&&o.type!=="auto_repair"&&e.jsx("span",{className:"text-xs ml-2 text-green-600 font-bold",children:"âœ“ USED"})]}),o.type==="auto_repair"&&o.preRepairScore!==void 0&&o.postRepairScore!==void 0?e.jsxs("span",{className:"font-bold text-sm",children:[e.jsxs("span",{className:o.preRepairScore>=70?"text-green-600":o.preRepairScore>=50?"text-yellow-600":"text-red-600",children:[o.preRepairScore,"%"]}),e.jsx("span",{className:"text-gray-400 mx-1",children:"â†’"}),e.jsxs("span",{className:o.postRepairScore>=70?"text-green-600":o.postRepairScore>=50?"text-yellow-600":"text-red-600",children:[o.postRepairScore,"%"]})]}):o.score!==void 0&&e.jsxs("span",{className:`font-bold ${o.score>=70?"text-green-600":o.score>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(o.score),"%"]})]}),o.error&&e.jsxs("div",{className:"text-xs text-red-600 mb-2",children:["Error: ",o.error]}),o.textIssue&&o.textIssue!=="NONE"&&e.jsxs("div",{className:"text-xs text-orange-600 mb-2",children:["Text issue: ",o.textIssue,o.expectedText&&e.jsxs("span",{className:"block",children:['Expected: "',o.expectedText,'"']}),o.actualText&&e.jsxs("span",{className:"block",children:['Actual: "',o.actualText,'"']})]}),o.type==="auto_repair"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[o.fixTargetsCount&&e.jsxs("div",{className:"text-xs text-amber-700",children:["Fixed ",o.fixTargetsCount," target",o.fixTargetsCount>1?"s":""]}),f&&((C=(D=o.repairDetails)==null?void 0:D[0])==null?void 0:C.beforeImage)&&o.postRepairScore!==void 0&&o.preRepairScore!==void 0&&o.postRepairScore<=o.preRepairScore&&e.jsxs("button",{onClick:()=>f(M,o.repairDetails[0].beforeImage),className:"text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded border border-red-300 transition-colors",children:["â†©ï¸ ",i==="de"?"ZurÃ¼cksetzen":"Revert to Original"]})]}),o.postRepairScore!==void 0&&o.preRepairScore!==void 0&&o.postRepairScore<o.preRepairScore&&e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200",children:["âš ï¸ ",i==="de"?`Bewertung verschlechtert: ${o.preRepairScore}% â†’ ${o.postRepairScore}%`:`Score decreased: ${o.preRepairScore}% â†’ ${o.postRepairScore}%`]}),o.bboxDetection&&Array.isArray(o.bboxDetection)&&o.bboxDetection.length>0&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900",children:["ðŸ“¦ ",i==="de"?"Bounding Box Erkennung":"Bounding Box Detection"," (",o.bboxDetection.length,")"]}),e.jsx("div",{className:"mt-3 space-y-2",children:o.bboxDetection.map((p,b)=>e.jsxs("div",{className:`p-3 rounded-lg border ${p.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:`font-medium text-sm ${p.success?"text-green-800":"text-red-800"}`,children:[p.success?"âœ“":"âœ—"," ",p.issue.substring(0,60),p.issue.length>60?"...":""]}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${p.severity==="CRITICAL"?"bg-red-200 text-red-800":p.severity==="MAJOR"?"bg-orange-200 text-orange-800":p.severity==="MODERATE"?"bg-yellow-200 text-yellow-800":"bg-gray-200 text-gray-800"}`,children:[p.severity," â€¢ ",p.type]})]}),p.success&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${p.faceBox?"bg-purple-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-purple-800",children:"Face Box:"}),p.faceBox?e.jsxs("span",{className:"ml-1 font-mono text-purple-600",children:["[",p.faceBox.map(G=>(G*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]}),e.jsxs("div",{className:`p-2 rounded ${p.bodyBox?"bg-blue-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Body Box:"}),p.bodyBox?e.jsxs("span",{className:"ml-1 font-mono text-blue-600",children:["[",p.bodyBox.map(G=>(G*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]})]}),p.label&&p.label!==p.issue&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Detected as:"})," ",p.label]}),p.usage&&e.jsxs("div",{className:"mt-1 text-xs text-gray-400",children:["Tokens: ",p.usage.input_tokens," in / ",p.usage.output_tokens," out"]})]},b))})]}),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ“Š ",i==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[o.preRepairScore,"%"]})]}),e.jsx(Ds,{data:o.preRepairEval||o.reasoning,language:i,title:`evaluation-before-attempt-${M}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[o.postRepairScore,"%"]})]}),e.jsx(Ds,{data:o.postRepairEval,language:i,title:`evaluation-after-attempt-${M}`})]})]})]}),o.repairDetails&&o.repairDetails.length>0&&e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ–¼ï¸ ",i==="de"?"Reparatur-Details":"Repair Details"," (",o.repairDetails.length,")"]}),e.jsx("div",{className:"mt-3 space-y-3",children:o.repairDetails.map((p,b)=>{var G,O;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("div",{className:"font-medium text-amber-800 text-base",children:p.description}),p.modelId&&e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded",children:p.modelId})]}),e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:["Show fix prompt",e.jsxs("button",{onClick:_=>{_.stopPropagation(),Lr(p.fullPrompt||p.fixPrompt||"",`fix-prompt-${b}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(vr,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:p.fullPrompt||p.fixPrompt})]}),e.jsxs("div",{className:"flex gap-4 items-start",children:[p.beforeImage&&p.maskImage?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before + Mask"}),e.jsx(no,{beforeImage:p.beforeImage,maskImage:p.maskImage,onEnlarge:(_,ee)=>k({src:_,title:ee})})]}):p.beforeImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before"}),e.jsx("img",{src:p.beforeImage,alt:"Before",className:"w-32 h-32 object-contain border rounded cursor-pointer hover:ring-2 hover:ring-amber-400",onClick:()=>k({src:p.beforeImage,title:"Before Repair"})})]}),e.jsx("div",{className:"flex items-center h-32 text-gray-400 text-2xl",children:"â†’"}),p.afterImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"After"}),e.jsx("img",{src:p.afterImage,alt:"After",className:"w-32 h-32 object-contain border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>k({src:p.afterImage,title:"After Repair"})})]})]}),p.verification&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded border text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"ðŸ” Verification:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[p.verification.lpips&&e.jsxs("div",{className:`p-2 rounded ${p.verification.lpips.changed?"bg-green-100":"bg-yellow-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LPIPS: "}),e.jsx("span",{className:p.verification.lpips.changed?"text-green-700":"text-yellow-700",children:(G=p.verification.lpips.lpipsScore)==null?void 0:G.toFixed(4)}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",p.verification.lpips.changed?"âœ“ changed":"âš  unchanged",")"]})]}),p.verification.llm&&e.jsxs("div",{className:`p-2 rounded ${p.verification.llm.fixed?"bg-green-100":"bg-red-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LLM: "}),e.jsx("span",{className:p.verification.llm.fixed?"text-green-700":"text-red-700",children:p.verification.llm.fixed?"âœ“ Fixed":"âœ— Not fixed"}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",Math.round(p.verification.llm.confidence*100),"%)"]})]})]}),((O=p.verification.llm)==null?void 0:O.explanation)&&e.jsx("div",{className:"mt-2 text-gray-600 text-sm italic",children:p.verification.llm.explanation})]})]},b)})})]})]}),o.type==="grid_repair"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[o.gridTotalIssues!==void 0&&e.jsxs("span",{className:"text-violet-700",children:[i==="de"?"Probleme:":"Issues:"," ",o.gridTotalIssues]}),o.gridFixedCount!==void 0&&e.jsxs("span",{className:"text-green-600",children:["âœ“ ",i==="de"?"Behoben:":"Fixed:"," ",o.gridFixedCount]}),o.gridFailedCount!==void 0&&o.gridFailedCount>0&&e.jsxs("span",{className:"text-red-600",children:["âœ— ",i==="de"?"Fehlgeschlagen:":"Failed:"," ",o.gridFailedCount]})]}),o.annotatedOriginal&&e.jsxs("details",{className:"text-sm",open:!0,children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“ ",i==="de"?"Schritt 1: Erkannte Probleme":"Step 1: Detected Issues"]}),e.jsxs("div",{className:"mt-3 bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-2 font-medium",children:[i==="de"?"Originalbild mit markierten Problembereichen":"Original image with marked issue regions",e.jsxs("span",{className:"ml-2 text-gray-400",children:["(ðŸ”´ ",i==="de"?"kritisch":"critical",", ðŸŸ  ",i==="de"?"wichtig":"major",", ðŸŸ¡ ",i==="de"?"gering":"minor",")"]})]}),e.jsx("img",{src:`data:image/jpeg;base64,${o.annotatedOriginal}`,alt:"Annotated original",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>k({src:`data:image/jpeg;base64,${o.annotatedOriginal}`,title:i==="de"?"Erkannte Probleme":"Detected Issues"})})]})]}),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“Š ",i==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[o.preRepairScore,"%"]})]}),e.jsx(Ds,{data:o.preRepairEval||o.reasoning,language:i,title:`evaluation-before-grid-${M}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[o.postRepairScore,"%"]})]}),e.jsx(Ds,{data:o.postRepairEval,language:i,title:`evaluation-after-grid-${M}`})]})]})]}),o.grids&&o.grids.length>0&&e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ”² ",i==="de"?"Grid-Details":"Grid Details"," (",o.grids.length," ",o.grids.length===1?"grid":"grids",")"]}),e.jsx("div",{className:"mt-3 space-y-4",children:o.grids.map((p,b)=>{var G,O;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("span",{className:"font-medium text-violet-800",children:["Grid"," ",p.batchNum||b+1]}),((G=p.manifest)==null?void 0:G.issues)&&e.jsxs("span",{className:"text-xs text-gray-500",children:[p.manifest.issues.length," ",i==="de"?"Regionen":"regions"]})]}),((O=p.manifest)==null?void 0:O.issues)&&p.manifest.issues.length>0&&e.jsxs("div",{className:"mb-3 p-2 bg-violet-50 rounded text-sm",children:[e.jsx("div",{className:"font-medium text-violet-800 mb-1",children:i==="de"?"Zu reparierende Probleme:":"Issues to repair:"}),e.jsx("div",{className:"space-y-1",children:p.manifest.issues.map((_,ee)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-mono font-bold text-violet-600 min-w-[20px]",children:[_.letter,":"]}),e.jsx("span",{className:"text-gray-700",children:_.fixInstruction||_.description||"Unknown issue"})]},ee))})]}),p.prompt&&e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:[i==="de"?"Reparatur-Prompt anzeigen":"Show repair prompt",e.jsxs("button",{onClick:_=>{_.stopPropagation(),Lr(p.prompt||"",`grid-repair-prompt-${b}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(vr,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:p.prompt})]}),e.jsxs("div",{className:"flex gap-4 items-start flex-wrap",children:[p.original&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:i==="de"?"Original-Grid":"Input Grid"}),e.jsx("img",{src:`data:image/jpeg;base64,${p.original}`,alt:"Input grid",className:"max-w-xs border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>k({src:`data:image/jpeg;base64,${p.original}`,title:i==="de"?"Original-Grid":"Input Grid"})})]}),p.original&&p.repaired&&e.jsx("div",{className:"flex items-center self-center text-gray-400 text-2xl",children:"â†’"}),p.repaired&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:i==="de"?"Repariertes Grid":"Repaired Grid"}),e.jsx("img",{src:`data:image/jpeg;base64,${p.repaired}`,alt:"Repaired grid",className:"max-w-xs border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>k({src:`data:image/jpeg;base64,${p.repaired}`,title:i==="de"?"Repariertes Grid":"Repaired Grid"})})]})]}),p.repairs&&p.repairs.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"font-medium text-violet-800 mb-2",children:["âœ… ",i==="de"?"Verifizierungsergebnisse":"Verification Results"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-violet-100 text-violet-800",children:[e.jsx("th",{className:"px-2 py-1 text-left border",children:"Ltr"}),e.jsx("th",{className:"px-2 py-1 text-left border",children:i==="de"?"Problem":"Issue"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:i==="de"?"Vorher":"Before"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:i==="de"?"Nachher":"After"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:"Status"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:i==="de"?"Konfidenz":"Confidence"})]})}),e.jsx("tbody",{children:p.repairs.map((_,ee)=>{var se,z,ne,Z,J,$,re,xe;return e.jsxs("tr",{className:(se=_.verification)!=null&&se.accepted?"bg-green-50":"bg-red-50",children:[e.jsx("td",{className:"px-2 py-1 border font-mono font-bold text-violet-600",children:_.letter}),e.jsxs("td",{className:"px-2 py-1 border text-gray-700 max-w-[200px] truncate",title:_.description,children:[e.jsx("span",{className:`inline-block px-1 py-0.5 rounded text-xs mr-1 ${_.severity==="critical"?"bg-red-200 text-red-800":_.severity==="major"?"bg-orange-200 text-orange-800":"bg-yellow-200 text-yellow-800"}`,children:_.type||"unknown"}),(z=_.description)==null?void 0:z.substring(0,40),(((ne=_.description)==null?void 0:ne.length)||0)>40?"...":""]}),e.jsx("td",{className:"px-2 py-1 border text-center",children:_.originalThumbnail&&e.jsx("img",{src:`data:image/jpeg;base64,${_.originalThumbnail}`,alt:"Before",className:"w-12 h-12 object-contain inline-block cursor-pointer hover:ring-2 hover:ring-violet-400 rounded",onClick:()=>k({src:`data:image/jpeg;base64,${_.originalThumbnail}`,title:`${_.letter}: Before`})})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:_.repairedThumbnail&&e.jsx("img",{src:`data:image/jpeg;base64,${_.repairedThumbnail}`,alt:"After",className:`w-12 h-12 object-contain inline-block cursor-pointer hover:ring-2 rounded ${(Z=_.verification)!=null&&Z.accepted?"hover:ring-green-400 border-green-300":"hover:ring-red-400 border-red-300"}`,onClick:()=>k({src:`data:image/jpeg;base64,${_.repairedThumbnail}`,title:`${_.letter}: After`})})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:(J=_.verification)!=null&&J.accepted?e.jsx("span",{className:"text-green-600 font-bold",children:"âœ“"}):e.jsx("span",{className:"text-red-600 font-bold",children:"âœ—"})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:e.jsxs("span",{className:`font-medium ${((($=_.verification)==null?void 0:$.confidence)??0)>=.7?"text-green-600":(((re=_.verification)==null?void 0:re.confidence)??0)>=.5?"text-yellow-600":"text-red-600"}`,children:[Math.round((((xe=_.verification)==null?void 0:xe.confidence)??0)*100),"%"]})})]},ee)})})]})}),p.repairs.filter(_=>{var ee;return!((ee=_.verification)!=null&&ee.accepted)}).map((_,ee)=>{var se,z;return e.jsxs("div",{className:"mt-2 text-sm text-red-600 bg-red-50 p-2 rounded border border-red-200",children:[e.jsxs("span",{className:"font-mono font-bold",children:[_.letter,":"]})," ",((se=_.verification)==null?void 0:se.reason)||((z=_.verification)==null?void 0:z.explanation)||"Unknown failure reason"]},ee)})]})]},b)})})]})]}),o.bboxDetection&&typeof o.bboxDetection=="object"&&"figures"in o.bboxDetection&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¦ ",i==="de"?"Objekterkennung":"Object Detection",e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:[((E=o.bboxDetection.figures)==null?void 0:E.length)||0," ",i==="de"?"Figuren":"figures",","," ",((v=o.bboxDetection.objects)==null?void 0:v.length)||0," ",i==="de"?"Objekte":"objects"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[o.bboxOverlayImage&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:[i==="de"?"Erkannte Regionen":"Detected Regions",e.jsx("span",{className:"ml-2 text-gray-400",children:"(ðŸŸ¢ Body, ðŸ”µ Face, ðŸŸ  Object)"})]}),e.jsx("img",{src:o.bboxOverlayImage,alt:"Bbox overlay",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-blue-400",onClick:()=>k({src:o.bboxOverlayImage,title:i==="de"?"Erkannte Regionen":"Detected Regions"})})]}),o.bboxDetection.figures&&o.bboxDetection.figures.length>0&&e.jsxs("div",{className:"bg-green-50 p-3 rounded border border-green-200",children:[e.jsxs("div",{className:"font-medium text-green-800 mb-2",children:[i==="de"?"Figuren":"Figures"," (",o.bboxDetection.figures.length,")"]}),e.jsx("div",{className:"space-y-2",children:o.bboxDetection.figures.map((p,b)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-green-700",children:p.label||`Figure ${b+1}`}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 grid grid-cols-2 gap-2",children:[p.bodyBox&&e.jsxs("span",{children:["Body: [",p.bodyBox.map(G=>(G*100).toFixed(0)+"%").join(", "),"]"]}),p.faceBox&&e.jsxs("span",{children:["Face: [",p.faceBox.map(G=>(G*100).toFixed(0)+"%").join(", "),"]"]}),p.position&&e.jsxs("span",{children:["Pos: ",p.position]})]})]},b))})]}),o.bboxDetection.objects&&o.bboxDetection.objects.length>0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsxs("div",{className:"font-medium text-orange-800 mb-2",children:[i==="de"?"Objekte":"Objects"," (",o.bboxDetection.objects.length,")"]}),e.jsx("div",{className:"space-y-2",children:o.bboxDetection.objects.map((p,b)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-orange-700",children:p.label||`Object ${b+1}`}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[p.bodyBox&&e.jsxs("span",{children:["Box: [",p.bodyBox.map(G=>(G*100).toFixed(0)+"%").join(", "),"]"]}),p.position&&e.jsxs("span",{className:"ml-2",children:["Pos: ",p.position]})]})]},b))})]}),e.jsxs("button",{onClick:()=>Lr(JSON.stringify(o.bboxDetection,null,2),`bbox-detection-attempt-${M}.json`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",children:[e.jsx(vr,{size:12})," ",i==="de"?"JSON herunterladen":"Download JSON"]})]})]}),o.type!=="auto_repair"&&o.type!=="grid_repair"&&o.prompt&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¤ ",i==="de"?"Eingabe-Prompt":"Input Prompt",e.jsxs("button",{onClick:p=>{p.stopPropagation(),Lr(o.prompt||"",`prompt-attempt-${o.attempt}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(vr,{size:10})," Download"]})]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-blue-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono border border-blue-200",children:o.prompt})]}),o.type!=="auto_repair"&&o.type!=="grid_repair"&&o.reasoning?e.jsxs("details",{className:"text-sm text-gray-600 mb-2",children:[e.jsxs("summary",{className:"cursor-pointer font-medium",children:["ðŸ“¥ ",i==="de"?"Bewertungs-Feedback":"Evaluation Feedback"]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-gray-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono",children:o.reasoning})]}):o.type!=="auto_repair"&&o.type!=="grid_repair"&&o.score===0&&e.jsx("div",{className:"text-sm text-gray-500 italic mb-2",children:i==="de"?"QualitÃ¤tsbewertung fehlgeschlagen":i==="fr"?"Ã‰valuation de qualitÃ© Ã©chouÃ©e":"Quality evaluation failed"}),o.imageData&&o.type!=="auto_repair"&&o.type!=="grid_repair"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:i==="de"?"Generiertes Bild":"Generated Image"}),e.jsx("img",{src:o.imageData,alt:`Attempt ${o.attempt}`,className:`w-48 h-48 object-contain rounded border cursor-pointer hover:ring-2 ${M===t.length-1?"border-green-300 hover:ring-green-400":"border-gray-200 opacity-75 hover:ring-gray-400"}`,onClick:()=>k({src:o.imageData,title:`${i==="de"?"Versuch":"Attempt"} ${o.attempt}`})})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(o.timestamp).toLocaleTimeString()})]},M)})})]})]})}function io({src:t,alt:l,onClose:i}){const f=d.useCallback(s=>{s.key==="Escape"&&i()},[i]);return d.useEffect(()=>(t&&(document.addEventListener("keydown",f),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",f),document.body.style.overflow="unset"}),[t,f]),t?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm cursor-pointer",onClick:i,children:[e.jsx("button",{onClick:i,className:"absolute top-4 right-4 p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors z-10","aria-label":"Close",children:e.jsx(Et,{size:24})}),e.jsx("img",{src:t,alt:l||"Enlarged image",className:"max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl",onClick:s=>s.stopPropagation()})]}):null}function ls({referencePhotos:t,landmarkPhotos:l,language:i}){var E;const[f,s]=d.useState(null),k=t&&t.length>0,h=l&&l.length>0;if(!k&&!h)return null;const A=((t==null?void 0:t.length)||0)+((l==null?void 0:l.length)||0),o=v=>{switch(v){case"bodyNoBg":case"body-no-bg":return i==="de"?"GanzkÃ¶rper (freigestellt)":i==="fr"?"Corps entier (dÃ©tourÃ©)":"Full body (no bg)";case"body":return i==="de"?"GanzkÃ¶rper":i==="fr"?"Corps entier":"Full body";case"face":return i==="de"?"Gesicht":i==="fr"?"Visage":"Face only";case"clothing-winter":return i==="de"?"Winter-Avatar":i==="fr"?"Avatar hiver":"Winter avatar";case"clothing-summer":return i==="de"?"Sommer-Avatar":i==="fr"?"Avatar Ã©tÃ©":"Summer avatar";case"clothing-formal":return i==="de"?"Formell-Avatar":i==="fr"?"Avatar formel":"Formal avatar";case"clothing-standard":return i==="de"?"Standard-Avatar":i==="fr"?"Avatar standard":"Standard avatar";case"none":return i==="de"?"Kein Foto":i==="fr"?"Pas de photo":"No photo";default:return v}},M=v=>{switch(v){case"bodyNoBg":case"body-no-bg":return"bg-green-100 text-green-700 border-green-300";case"body":return"bg-blue-100 text-blue-700 border-blue-300";case"face":return"bg-yellow-100 text-yellow-700 border-yellow-300";case"clothing-winter":return"bg-cyan-100 text-cyan-700 border-cyan-300";case"clothing-summer":return"bg-orange-100 text-orange-700 border-orange-300";case"clothing-formal":return"bg-purple-100 text-purple-700 border-purple-300";case"clothing-standard":return"bg-teal-100 text-teal-700 border-teal-300";case"none":return"bg-red-100 text-red-700 border-red-300";default:return"bg-gray-100 text-gray-700 border-gray-300"}},D=(E=t.find(v=>v.clothingCategory))==null?void 0:E.clothingCategory,C=v=>{if(!v)return"";switch(v){case"winter":return i==="de"?"Winter":i==="fr"?"Hiver":"Winter";case"summer":return i==="de"?"Sommer":i==="fr"?"Ã‰tÃ©":"Summer";case"formal":return i==="de"?"Formell":i==="fr"?"Formel":"Formal";case"standard":return"Standard";default:return v}};return e.jsxs("details",{className:"bg-pink-50 border border-pink-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-900 flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ“¸"}),i==="de"?"Referenzfotos":i==="fr"?"Photos de rÃ©fÃ©rence":"Reference Photos",e.jsxs("span",{className:"text-xs text-pink-600",children:["(",A,")"]}),D&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-pink-200 text-pink-800 text-xs rounded",children:["ðŸ‘• ",C(D)]}),h&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded",children:["ðŸ“ ",l.length," ",i==="de"?"Wahrzeichen":"Landmark"]})]}),k&&e.jsx("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2",children:t.map((v,p)=>e.jsxs("div",{className:"bg-white rounded-lg p-2 border border-pink-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:v.name}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap ${M(v.photoType)}`,children:o(v.photoType)})]}),v.photoUrl&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:v.photoUrl,alt:`${v.name} - ${o(v.photoType)}`,className:`w-full max-h-32 object-contain rounded border bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity ${v.isStyled?"border-purple-400 ring-2 ring-purple-200":"border-gray-200"}`,onClick:()=>s(v.photoUrl),title:"Click to enlarge"}),v.isStyled&&e.jsx("span",{className:"absolute top-1 right-1 px-1 py-0.5 text-[9px] font-bold bg-purple-500 text-white rounded",children:"ðŸŽ¨ STYLED"})]}),v.photoHash&&e.jsxs("div",{className:"mt-1 text-[9px] font-mono text-gray-500 bg-gray-100 px-1 py-0.5 rounded text-center",children:["ðŸ” ",v.photoHash]})]})]},p))}),h&&e.jsxs("div",{className:k?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-amber-700 mb-2 flex items-center gap-1",children:["ðŸ“ ",i==="de"?"Wahrzeichen-Referenzfotos":i==="fr"?"Photos de monuments":"Landmark Reference Photos"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:l.map((v,p)=>e.jsxs("div",{className:"bg-amber-50 rounded-lg p-2 border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:v.name}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-amber-100 text-amber-700 border-amber-300",children:"ðŸ“ LANDMARK"})]}),v.photoData&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:v.photoData,alt:`${v.name} landmark`,className:"w-full max-h-32 object-contain rounded border border-amber-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>s(v.photoData),title:"Click to enlarge"})}),v.attribution&&e.jsxs("div",{className:"mt-1 text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 rounded truncate",title:v.attribution,children:["ðŸ“· ",v.attribution]}),v.source&&e.jsxs("div",{className:"mt-0.5 text-[9px] text-gray-400",children:["Source: ",v.source]})]})]},p))})]}),e.jsx(io,{src:f,onClose:()=>s(null)})]})}function oo({pageNumber:t,scene:l,onSceneChange:i,onClose:f,onRegenerate:s,isRegenerating:k,imageRegenerationCost:h,characters:A=[],selectedCharacterIds:o=[],onCharacterSelectionChange:M,consistencyRegen:D}){const{language:C}=Lt(),[E,v]=d.useState(!1),[p,b]=d.useState(!1),G=O=>{M&&(o.includes(O)?M(o.filter(_=>_!==O)):M([...o,O]))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(nt,{size:20}),C==="de"?`Szene bearbeiten - Seite ${t}`:C==="fr"?`Modifier la scÃ¨ne - Page ${t}`:`Edit Scene - Page ${t}`]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:C==="de"?"Bearbeiten Sie die Szenenbeschreibung und wÃ¤hlen Sie die Charaktere aus.":C==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages.":"Edit the scene description and select the characters."})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[A.length>0&&M&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(ya,{size:16}),C==="de"?"Charaktere in dieser Szene:":C==="fr"?"Personnages dans cette scÃ¨ne:":"Characters in this scene:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:A.map(O=>{const _=o.includes(O.id);return e.jsxs("button",{type:"button",onClick:()=>G(O.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${_?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:O.name}),_&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},O.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:C==="de"?"WÃ¤hlen Sie die Charaktere aus, die im Bild erscheinen sollen.":C==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre dans l'image.":"Select the characters that should appear in the image."})]}),D&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(pn,{className:"text-amber-600",size:20}),e.jsx("h4",{className:"font-semibold text-amber-800",children:C==="de"?"Konsistenz-Korrektur angewendet":C==="fr"?"Correction de cohÃ©rence appliquÃ©e":"Consistency Fix Applied"}),e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded",children:["Score: ",D.score,"%"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-amber-700 mb-2",children:C==="de"?"Behobene Probleme:":C==="fr"?"ProblÃ¨mes corrigÃ©s:":"Issues Fixed:"}),e.jsx("ul",{className:"text-sm text-amber-900 space-y-1",children:D.issues.map((O,_)=>e.jsxs("li",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium",children:[O.type.toUpperCase(),O.characterInvolved&&` (${O.characterInvolved})`,":"]}),e.jsx("span",{className:"text-amber-700 ml-2",children:O.description}),e.jsxs("span",{className:"text-amber-600 ml-2 text-xs",children:["â†’ ",O.recommendation]})]},_))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-1 text-center",children:"Original"}),e.jsx("img",{src:D.originalImage,alt:"Original",className:"w-full rounded-lg border border-gray-300",draggable:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-green-600 mb-1 text-center",children:C==="de"?"Korrigiert":C==="fr"?"CorrigÃ©":"Fixed"}),e.jsx("img",{src:D.fixedImage,alt:"Fixed",className:"w-full rounded-lg border-2 border-green-500",draggable:!1})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>v(!E),className:"flex items-center gap-1 text-xs text-gray-600 hover:text-gray-800",children:[E?e.jsx(Qa,{size:14}):e.jsx(Ut,{size:14}),C==="de"?"Original-Prompt":C==="fr"?"Prompt original":"Original Prompt"]}),E&&e.jsx("pre",{className:"text-xs bg-gray-100 p-2 rounded overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:D.originalPrompt}),e.jsxs("button",{onClick:()=>b(!p),className:"flex items-center gap-1 text-xs text-green-600 hover:text-green-800",children:[p?e.jsx(Qa,{size:14}):e.jsx(Ut,{size:14}),C==="de"?"Korrigierter Prompt (mit Korrekturen)":C==="fr"?"Prompt corrigÃ© (avec corrections)":"Fixed Prompt (with corrections)"]}),p&&e.jsx("pre",{className:"text-xs bg-green-50 p-2 rounded border border-green-200 overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:D.fixedPrompt})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:C==="de"?`Korrigiert am ${new Date(D.timestamp).toLocaleString()}`:C==="fr"?`CorrigÃ© le ${new Date(D.timestamp).toLocaleString()}`:`Fixed at ${new Date(D.timestamp).toLocaleString()}`}),D.clothing&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded",children:["ðŸŽ¨ ",D.clothing]})]}),D.avatarsUsed&&D.avatarsUsed.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-blue-50 rounded border border-blue-200",children:[e.jsx("p",{className:"text-xs font-medium text-blue-700 mb-1",children:C==="de"?"Verwendete Avatare:":C==="fr"?"Avatars utilisÃ©s:":"Avatars used:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:D.avatarsUsed.map((O,_)=>e.jsxs("span",{className:`text-xs px-2 py-1 rounded ${O.hasPhoto?"bg-green-100 text-green-700":"bg-gray-100 text-gray-500"}`,children:[O.name,O.category&&O.category!=="standard"&&e.jsxs("span",{className:"ml-1 opacity-75",children:["(",O.category,")"]}),!O.hasPhoto&&" âš ï¸"]},_))})]}),D.retryHistory&&D.retryHistory.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx(Mr,{retryHistory:D.retryHistory,totalAttempts:D.totalAttempts||1,language:C})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:C==="de"?"Szenenbeschreibung:":C==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:l,onChange:O=>i(O.target.value),className:"w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y",placeholder:C==="de"?"Beschreiben Sie die Szene...":C==="fr"?"DÃ©crivez la scÃ¨ne...":"Describe the scene..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:C==="de"?"Tipp: Beschreiben Sie die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":C==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:o.length>0&&e.jsx("span",{children:C==="de"?`${o.length} Charakter(e) ausgewÃ¤hlt`:C==="fr"?`${o.length} personnage(s) sÃ©lectionnÃ©(s)`:`${o.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:f,disabled:k,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium disabled:opacity-50 order-2 sm:order-1",children:C==="de"?"Abbrechen":C==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:s,disabled:k||!l.trim(),className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${k||!l.trim()?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:k?e.jsxs(e.Fragment,{children:[e.jsx(Gt,{size:16,className:"animate-spin"}),C==="de"?"Generiere...":C==="fr"?"GÃ©nÃ©ration...":"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Gt,{size:16}),C==="de"?"Neu generieren":C==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",h,")"]})]})})]})]})]})})}function lo({pageNumber:t,versions:l,onClose:i,onSelectVersion:f,developerMode:s=!1}){const{language:k}=Lt();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(ds,{size:20}),k==="de"?`Bildversionen - Seite ${t}`:k==="fr"?`Versions d'image - Page ${t}`:`Image Versions - Page ${t}`]}),e.jsx("button",{onClick:i,className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Et,{size:20})})]}),e.jsxs("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:l.map((h,A)=>e.jsxs("div",{className:`relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${h.isActive?"border-green-500 ring-2 ring-green-200":"border-gray-200 hover:border-indigo-300"}`,onClick:()=>f(t,A),children:[e.jsx("img",{src:h.imageData,alt:`Version ${A+1}`,className:"w-full aspect-square object-cover"}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:A===0?"Original":`V${A+1}`}),h.isActive&&e.jsx("span",{className:"bg-green-500 px-2 py-0.5 rounded text-[10px] font-bold",children:k==="de"?"Aktiv":k==="fr"?"Actif":"Active"})]}),e.jsx("div",{className:"text-[10px] text-gray-300 mt-1",children:new Date(h.createdAt).toLocaleDateString()})]})]},A))}),s&&l.length>1&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold text-gray-700",children:k==="de"?"Szenen- und Prompt-Vergleich":k==="fr"?"Comparaison de scÃ¨nes et prompts":"Scene & Prompt Comparison"}),l.map((h,A)=>e.jsxs("details",{className:`rounded-lg p-3 ${h.isActive?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-medium text-gray-700",children:[A===0?"Original":`V${A+1}`,h.isActive&&e.jsx("span",{className:"ml-2 text-green-600 text-xs",children:"(Active)"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[h.userInput&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-purple-700",children:k==="de"?"Benutzer-Eingabe:":k==="fr"?"EntrÃ©e utilisateur:":"User Input:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-purple-50 p-2 rounded border border-purple-200 max-h-24 overflow-y-auto",children:h.userInput})]}),h.description&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700",children:k==="de"?"Erweiterte Szene:":k==="fr"?"ScÃ¨ne Ã©tendue:":"Expanded Scene:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-24 overflow-y-auto",children:h.description})]}),h.prompt&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-700",children:k==="de"?"API-Prompt:":k==="fr"?"Prompt API:":"API Prompt:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-32 overflow-y-auto",children:h.prompt})]}),h.modelId&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Model: ",h.modelId]})]})]},A))]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-sm text-gray-500",children:k==="de"?"Klicken Sie auf ein Bild, um es auszuwÃ¤hlen":k==="fr"?"Cliquez sur une image pour la sÃ©lectionner":"Click an image to select it"})]})})}function co({src:t,title:l,onClose:i}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:i,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden",onClick:f=>f.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-2 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:l}),e.jsx("button",{onClick:i,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(Et,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50",children:e.jsx("img",{src:t,alt:l,className:"max-w-full max-h-[80vh] object-contain mx-auto"})})]})})}const an={en:{adventure:"Adventure","life-challenge":"Life Challenge",educational:"Educational",historical:"Historical"},de:{adventure:"Abenteuer","life-challenge":"Lebensherausforderung",educational:"Bildung",historical:"Historisch"},fr:{adventure:"Aventure","life-challenge":"DÃ©fi de vie",educational:"Ã‰ducatif",historical:"Historique"}},nn={en:{"1st-grade":"Picture Book (1st Grade)",standard:"Standard",advanced:"Advanced"},de:{"1st-grade":"Bilderbuch (1. Klasse)",standard:"Standard",advanced:"Fortgeschritten"},fr:{"1st-grade":"Livre illustrÃ© (1Ã¨re annÃ©e)",standard:"Standard",advanced:"AvancÃ©"}},mo={"de-CH":"Schweizerdeutsch","de-DE":"Deutsch (Deutschland)",en:"English",fr:"FranÃ§ais"};function uo({settings:t,language:l}){var v,p;const[i,f]=d.useState(!1),s=b=>{const G={en:{title:"Story Info",category:"Category",topic:"Topic",theme:"Theme",storyType:"Story Type",storyDetails:"Story Idea",artStyle:"Art Style",language:"Language",readingLevel:"Reading Level",pages:"Length",dedication:"Dedication",mainCharacters:"Main Characters",otherCharacters:"Other Characters",relationships:"Relationships",season:"Season",location:"Location",noData:"Not specified",spring:"Spring",summer:"Summer",autumn:"Autumn",winter:"Winter"},de:{title:"Story-Info",category:"Kategorie",topic:"Thema",theme:"Thema",storyType:"Story-Typ",storyDetails:"Story-Idee",artStyle:"Kunststil",language:"Sprache",readingLevel:"Lesestufe",pages:"LÃ¤nge",dedication:"Widmung",mainCharacters:"Hauptfiguren",otherCharacters:"Andere Figuren",relationships:"Beziehungen",season:"Jahreszeit",location:"Ort",noData:"Nicht angegeben",spring:"FrÃ¼hling",summer:"Sommer",autumn:"Herbst",winter:"Winter"},fr:{title:"Info histoire",category:"CatÃ©gorie",topic:"Sujet",theme:"ThÃ¨me",storyType:"Type d'histoire",storyDetails:"IdÃ©e d'histoire",artStyle:"Style artistique",language:"Langue",readingLevel:"Niveau de lecture",pages:"Longueur",dedication:"DÃ©dicace",mainCharacters:"Personnages principaux",otherCharacters:"Autres personnages",relationships:"Relations",season:"Saison",location:"Lieu",noData:"Non spÃ©cifiÃ©",spring:"Printemps",summer:"Ã‰tÃ©",autumn:"Automne",winter:"Hiver"}};return(G[l]||G.en)[b]||b},k=b=>(an[l]||an.en)[b]||b,h=b=>(nn[l]||nn.en)[b]||b,A=(b,G)=>b==null||b===""?e.jsx("span",{className:"text-gray-400 italic",children:s("noData")}):e.jsx("span",{className:"text-gray-800",children:b}),o=t.mainCharacters||[],M=((v=t.characters)==null?void 0:v.filter(b=>o.includes(b.id)))||[],D=((p=t.characters)==null?void 0:p.filter(b=>!o.includes(b.id)))||[],C=b=>s(b)||b,E=()=>{if(!t.userLocation)return null;const b=[t.userLocation.city,t.userLocation.region,t.userLocation.country].filter(Boolean);return b.length>0?b.join(", "):null};return e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>f(!i),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-amber-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ii,{size:16,className:"text-amber-600"}),e.jsx("span",{className:"font-medium text-amber-800",children:s("title")}),e.jsx("span",{className:"text-xs bg-amber-200 text-amber-700 px-2 py-0.5 rounded",children:"DEV"})]}),i?e.jsx(Ut,{size:18,className:"text-amber-600"}):e.jsx(ha,{size:18,className:"text-amber-600"})]}),i&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[M.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(ma,{size:12}),s("mainCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:M.map(b=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800 border border-indigo-200",children:[e.jsx(ma,{size:10}),e.jsx("span",{children:b.name})]},b.id))})]}),D.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(ya,{size:12}),s("otherCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:D.map(b=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-200",children:[e.jsx(ma,{size:10}),e.jsx("span",{children:b.name})]},b.id))})]}),t.relationships&&Object.keys(t.relationships).length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-2",children:s("relationships")}),e.jsx("div",{className:"text-xs bg-white/50 p-2 rounded border border-amber-100 space-y-1",children:Object.entries(t.relationships).map(([b,G])=>{var z,ne;const[O,_]=b.split("-").map(Z=>parseInt(Z,10)),ee=(z=t.characters)==null?void 0:z.find(Z=>Z.id===O),se=(ne=t.characters)==null?void 0:ne.find(Z=>Z.id===_);return!ee||!se?null:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-amber-600 font-medium whitespace-nowrap",children:[ee.name," â†’ ",se.name,":"]}),e.jsx("span",{className:"text-gray-700",children:G})]},b)})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(_i,{size:12}),s("language")]}),e.jsx("div",{className:"text-sm",children:t.language?mo[t.language]||t.language:A(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("readingLevel")}),e.jsx("div",{className:"text-sm",children:t.languageLevel?h(t.languageLevel):A(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("pages")}),e.jsx("div",{className:"text-sm",children:t.pages?`${t.pages} ${l==="de"?"Seiten":"pages"}`:A(void 0)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("season")}),e.jsx("div",{className:"text-sm",children:t.season?C(t.season):A(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("location")}),e.jsx("div",{className:"text-sm",children:E()||A(void 0)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(bn,{size:12}),s("artStyle")]}),e.jsx("div",{className:"text-sm capitalize",children:A(t.artStyle)})]})]}),t.storyDetails&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Br,{size:12}),s("storyDetails")]}),e.jsx("div",{className:"text-sm bg-white/50 p-2 rounded border border-amber-100 whitespace-pre-wrap",children:t.storyDetails})]}),(t.storyCategory||t.storyTheme||t.storyTopic)&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-amber-100",children:[t.storyCategory&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Mi,{size:12}),s("category")]}),e.jsx("div",{className:"text-sm",children:k(t.storyCategory)})]}),(t.storyTheme||t.storyTopic)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:t.storyCategory==="adventure"?s("theme"):s("topic")}),e.jsx("div",{className:"text-sm",children:t.storyCategory==="adventure"?t.storyTheme:t.storyTopic})]})]})]})]})}function go({storyId:t,onShareStatusChange:l,variant:i="compact"}){const{language:f}=Lt(),[s,k]=d.useState(!1),[h,A]=d.useState(null),[o,M]=d.useState(!1),[D,C]=d.useState(!1),[E,v]=d.useState(null),p=i==="full",b={share:f==="de"?"Teilen":f==="fr"?"Partager":"Share",shareStory:f==="de"?"Geschichte teilen":f==="fr"?"Partager l'histoire":"Share Story",enableSharing:f==="de"?"Link aktivieren":f==="fr"?"Activer le lien":"Enable sharing",disableSharing:f==="de"?"Link deaktivieren":f==="fr"?"DÃ©sactiver le lien":"Disable sharing",copyLink:f==="de"?"Link kopieren":f==="fr"?"Copier le lien":"Copy link",copied:f==="de"?"Kopiert!":f==="fr"?"CopiÃ©!":"Copied!",shareWhatsApp:f==="de"?"Per WhatsApp teilen":f==="fr"?"Partager sur WhatsApp":"Share on WhatsApp",sharingEnabled:f==="de"?"Teilen aktiv":f==="fr"?"Partage actif":"Sharing enabled",sharingDisabled:f==="de"?"Teilen inaktiv":f==="fr"?"Partage inactif":"Sharing disabled",anyoneWithLink:f==="de"?"Jeder mit dem Link kann die Geschichte lesen":f==="fr"?"Toute personne avec le lien peut lire l'histoire":"Anyone with the link can read the story",errorLoading:f==="de"?"Fehler beim Laden":f==="fr"?"Erreur de chargement":"Error loading"};d.useEffect(()=>{s&&!h&&G()},[s]);const G=async()=>{M(!0),v(null);try{const se=localStorage.getItem("auth_token"),z=await fetch(`/api/stories/${t}/share-status`,{headers:se?{Authorization:`Bearer ${se}`}:{}});if(!z.ok)throw new Error("Failed to fetch status");const ne=await z.json();A(ne)}catch{v(b.errorLoading)}finally{M(!1)}},O=async()=>{M(!0),v(null);try{const z=(h==null?void 0:h.isShared)?"DELETE":"POST",ne=localStorage.getItem("auth_token"),Z=await fetch(`/api/stories/${t}/share`,{method:z,headers:ne?{Authorization:`Bearer ${ne}`}:{}});if(!Z.ok)throw new Error("Failed to toggle sharing");const J=await Z.json();A({isShared:J.isShared,shareToken:J.shareToken,shareUrl:J.shareUrl}),l==null||l(J.isShared)}catch{v("Failed to update sharing")}finally{M(!1)}},_=async()=>{if(h!=null&&h.shareUrl)try{await navigator.clipboard.writeText(h.shareUrl),C(!0),setTimeout(()=>C(!1),2e3)}catch{const z=document.createElement("textarea");z.value=h.shareUrl,document.body.appendChild(z),z.select(),document.execCommand("copy"),document.body.removeChild(z),C(!0),setTimeout(()=>C(!1),2e3)}},ee=()=>{if(!(h!=null&&h.shareUrl))return;const se=encodeURIComponent(h.shareUrl);window.open(`https://wa.me/?text=${se}`,"_blank")};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>k(!s),className:p?"bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full hover:bg-indigo-600":"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg",title:b.share,children:[e.jsx(tn,{className:"w-4 h-4"}),e.jsx("span",{className:p?"":"hidden sm:inline",children:b.share}),(h==null?void 0:h.isShared)&&e.jsx("span",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>k(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(tn,{className:"w-5 h-5 text-blue-600"}),b.shareStory]})}),e.jsx("div",{className:"p-4 space-y-4",children:o&&!h?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(ft,{className:"w-6 h-6 animate-spin text-blue-500"})}):E?e.jsx("div",{className:"text-red-500 text-sm py-2",children:E}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[h!=null&&h.isShared?e.jsx(qi,{className:"w-5 h-5 text-green-500"}):e.jsx(Vi,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:h!=null&&h.isShared?"text-green-700":"text-gray-600",children:h!=null&&h.isShared?b.sharingEnabled:b.sharingDisabled})]}),e.jsx("button",{onClick:O,disabled:o,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${h!=null&&h.isShared?"bg-red-100 text-red-700 hover:bg-red-200":"bg-green-100 text-green-700 hover:bg-green-200"} disabled:opacity-50`,children:o?e.jsx(ft,{className:"w-4 h-4 animate-spin"}):h!=null&&h.isShared?b.disableSharing:b.enableSharing})]}),(h==null?void 0:h.isShared)&&h.shareUrl&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xs text-gray-500",children:b.anyoneWithLink}),e.jsx("button",{onClick:_,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-colors",children:D?e.jsxs(e.Fragment,{children:[e.jsx(Gi,{className:"w-4 h-4 text-green-500"}),b.copied]}):e.jsxs(e.Fragment,{children:[e.jsx(Oi,{className:"w-4 h-4"}),b.copyLink]})}),e.jsxs("button",{onClick:ee,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors",children:[e.jsx(Ki,{className:"w-4 h-4"}),b.shareWhatsApp]})]})]})})]})]})]})}function ho({title:t,dedication:l,story:i,outline:f,outlinePrompt:s,outlineModelId:k,outlineUsage:h,storyTextPrompts:A=[],visualBible:o,sceneImages:M,sceneDescriptions:D=[],coverImages:C,regeneratingCovers:E=new Set,languageLevel:v="standard",storyLanguage:p,isGenerating:b=!1,onDownloadPdf:G,onAddToBook:O,onPrintBook:_,onCreateAnother:ee,onDownloadTxt:se,onRegenerateImage:z,onRegenerateCover:ne,characters:Z=[],onEditImage:J,onEditCover:$,onRepairImage:re,onRevertRepair:xe,onVisualBibleChange:be,storyId:je,developerMode:oe=!1,styledAvatarGeneration:we=[],costumedAvatarGeneration:Ee=[],generationLog:Re=[],finalChecksReport:Y,clothingRequirements:Ve,isPartial:Se=!1,failureReason:qe,generatedPages:me,totalPages:ue,progressiveMode:W=!1,progressiveData:ke,completedPageImages:et={},originalStory:He,onSaveStoryText:gt,onSaveTitleChange:bt,userCredits:Kt=0,imageRegenerationCost:yt=5,isImpersonating:Ms=!1,onSelectImageVersion:Or,generationSettings:ms}){var Zr,Tt,$t,st,sr;const{t:dr,language:a}=Lt(),Ce=p?p.startsWith("de")?"de":p:a,tt=Ms||Kt===-1||Kt>=yt,[ge,Hr]=d.useState(null),[lt,Ot]=d.useState(""),[vt,cr]=d.useState(!1),[rt,jr]=d.useState(i),[dt,Jt]=d.useState(!1),[Ne,Qt]=d.useState(!1),[ze,Zt]=d.useState(t||""),[Be,Nr]=d.useState(!1),[ct,Yt]=d.useState(null),[_e,kt]=d.useState(null),[,he]=d.useState(!1),[pe,_r]=d.useState(new Set),[Pe,j]=d.useState(null),[ye,Wr]=d.useState(null),[wr,mt]=d.useState(null),[zt,Sr]=d.useState("square"),[Ue,Cr]=d.useState(!1);d.useEffect(()=>{vt||jr(i)},[i,vt]),d.useEffect(()=>{Ne||Zt(t||"")},[t,Ne]);const mr=async()=>{if(gt){Jt(!0);try{await gt(rt),cr(!1)}catch(r){console.error("Failed to save story text:",r)}finally{Jt(!1)}}},Vr=async()=>{if(!(!bt||!ze.trim())){Nr(!0);try{await bt(ze.trim()),Qt(!1)}catch(r){console.error("Failed to save title:",r)}finally{Nr(!1)}}},At=()=>{jr(i),cr(!1)},us=async r=>{if(!(!re||ye!==null)){Wr(r);try{await re(r)}catch(y){console.error("Failed to repair image:",y)}finally{Wr(null)}}},qr=(r,y)=>{const N=rt.split(/(?=---\s*(?:Page|Seite)\s+\d+\s*---|(?=##\s*(?:Page|Seite)\s+\d+))/i);let F=0;for(let Q=0;Q<N.length;Q++)if(/^(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i.test(N[Q].trim())){F=Q;break}const m=F+r;if(m<N.length){const Q=N[m].match(/^(---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i),le=Q?Q[0]:"";N[m]=le+`
`+y.trim()+`
`}jr(N.join(""))},Xt=r=>{const y=M.find(N=>N.pageNumber===r);return(y==null?void 0:y.imageVersions)||[]},kr=async(r,y)=>{if(Or)try{await Or(r,y),Yt(null)}catch(N){console.error("Failed to select image version:",N)}},Gs=r=>{if(!r)return"";let y;if(typeof r!="string"){const Q=r;if(Q.output)if(typeof Q.output=="string")y=Q.output;else if(typeof Q.output=="object"){const le=Q.output.translatedSummary||Q.output.imageSummary||"";if(le)return le;y=JSON.stringify(r)}else y=JSON.stringify(r);else y=JSON.stringify(r)}else y=r;if(y.trim().startsWith("{"))try{const Q=JSON.parse(y);if(Q.output){if(typeof Q.output=="string")y=Q.output;else if(typeof Q.output=="object"){const le=Q.output.translatedSummary||Q.output.imageSummary;if(le)return le}}}catch{}const N=y.match(/(?:#{1,3}\s*)?(?:\*\*)?6\.?\s*(?:\*\*)?\s*\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*\*?\*?\s*:?\s*\n?([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n---|\n```|$)/i);if(N&&N[2]&&N[2].trim())return N[2].trim();const F=y.match(/(?:#{1,3}\s*)?\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*:?\s*\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n\*\*|\n#{1,3}\s|$)/i);if(F&&F[2]&&F[2].trim())return F[2].trim();if(!y.includes("**")&&y.length<1e3)return y.trim();const m=y.match(/\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:\*\*)?\d+\.\s*\*\*|\n\s*\*\*\d+\.|$)/i);return m&&m[2]&&m[2].trim()?m[2].trim():y.substring(0,500).trim()+"..."},gs=r=>{if(!r||!Z.length)return Z.map(F=>F.id);let y;if(typeof r!="string"){const F=r;y=F.output&&typeof F.output=="string"?F.output:JSON.stringify(r)}else y=r;if(y.trim().startsWith("{"))try{const F=JSON.parse(y);F.output&&typeof F.output=="string"&&(y=F.output)}catch{}const N=y.toLowerCase();return Z.filter(F=>N.includes(F.name.toLowerCase())).map(F=>F.id)},hs=r=>{const y=M.find(le=>le.pageNumber===r),N=D.find(le=>le.pageNumber===r),F=(y==null?void 0:y.description)||(N==null?void 0:N.description)||"",m=(N==null?void 0:N.translatedSummary)||Gs(F)||(N==null?void 0:N.imageSummary)||"",Q=gs(F);kt({pageNumber:r,scene:m,selectedCharacterIds:Q})},xs=async()=>{if(!_e||!z)return;const r=_e.pageNumber,y=_e.scene,N=_e.selectedCharacterIds;kt(null),_r(F=>new Set(F).add(r)),he(!0);try{await z(r,y,N)}catch(F){console.error("Failed to regenerate image:",F)}finally{_r(F=>{const m=new Set(F);return m.delete(r),m}),_r(F=>(F.size===0&&he(!1),F))}},Ur=r=>{let y="",N=[];if(r==="front"&&(C!=null&&C.frontCover)){const le=C.frontCover;typeof le=="object"&&(y=le.description||"",N=le.referencePhotos||[])}else if(r==="initial"&&(C!=null&&C.initialPage)){const le=C.initialPage;typeof le=="object"&&(y=le.description||"",N=le.referencePhotos||[])}else if(r==="back"&&(C!=null&&C.backCover)){const le=C.backCover;typeof le=="object"&&(y=le.description||"",N=le.referencePhotos||[])}let F=[];N.length>0&&Z.length>0&&(F=Z.filter(le=>N.some(Ke=>Ke.name===le.name)).map(le=>le.id)),F.length===0&&(F=Z.map(le=>le.id)),j({coverType:r,scene:y,selectedCharacterIds:F,title:r==="front"?t:void 0,dedication:r==="initial"?l:void 0})},Ls=async()=>{if(!Pe||!ne)return;const{coverType:r,scene:y,selectedCharacterIds:N,title:F,dedication:m}=Pe;j(null);try{await ne(r,y,N,F,m)}catch(Q){console.error("Failed to regenerate cover:",Q)}},er=(r,y,N,F)=>{Hr({type:r,id:y,field:N}),Ot(F||"")},ur=()=>{if(!ge||!o||!be)return;const{type:r,id:y,field:N}=ge,F={...o};if(r==="secondaryCharacter")F.secondaryCharacters=(F.secondaryCharacters||[]).map(m=>m.id===y?{...m,[N]:lt}:m);else if(r==="animal")F.animals=(F.animals||[]).map(m=>m.id===y?{...m,[N]:lt}:m);else if(r==="artifact")F.artifacts=(F.artifacts||[]).map(m=>m.id===y?{...m,[N]:lt}:m);else if(r==="location")F.locations=(F.locations||[]).map(m=>m.id===y?{...m,[N]:lt}:m);else if(r==="mainCharacter"){const m=parseInt(y);F.mainCharacters=(F.mainCharacters||[]).map(Q=>Q.id!==m?Q:N==="physical.face"?{...Q,physical:{...Q.physical,face:lt}}:N==="physical.hair"?{...Q,physical:{...Q.physical,hair:lt}}:N==="physical.build"?{...Q,physical:{...Q.physical,build:lt}}:Q)}be(F),Hr(null),Ot("")},tr=()=>{Hr(null),Ot("")},Ft=(r=>r?r.split(/(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i).slice(1).filter(N=>N.trim().length>0):[])(vt?rt:i),Rt=M.length>0,Ye=v==="1st-grade",jt=(()=>{if(!W)return Ft.length;if(Ft.length===0)return 0;let r=1;for(let y=2;y<=Ft.length;y++){const N=y-1;if(M.some(m=>m.pageNumber===N&&m.imageData)||!!et[N])r=y;else break}return r})(),Qr=(ke==null?void 0:ke.totalPages)||Ft.length;ke!=null&&ke.totalScenes||M.length||Math.ceil(Qr/(Ye?1:2));const ht=r=>r?typeof r=="string"?r:r.imageData||null:null,Ar=r=>r?typeof r=="string"?{imageData:r}:r:null,rr=r=>{var F;const y=(F=D.find(m=>m.pageNumber===r))==null?void 0:F.description;if(y)return y;const N=M.find(m=>m.pageNumber===r);return N==null?void 0:N.description},Pr=r=>{const y=D.find(N=>N.pageNumber===r);return r===1&&y&&(console.log("[StoryDisplay] Page 1 scene keys:",Object.keys(y)),console.log("[StoryDisplay] Page 1 has outlineExtract:",!!y.outlineExtract),console.log("[StoryDisplay] Page 1 has scenePrompt:",!!y.scenePrompt)),y==null?void 0:y.outlineExtract},Pt=r=>{var y;return(y=D.find(N=>N.pageNumber===r))==null?void 0:y.scenePrompt},Ht=r=>{var y;return(y=D.find(N=>N.pageNumber===r))==null?void 0:y.textModelId};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center gap-2",children:Ne?e.jsxs("div",{className:"flex items-center gap-2 w-full max-w-2xl",children:[e.jsx("input",{type:"text",value:ze,onChange:r=>Zt(r.target.value),className:"flex-1 text-2xl md:text-3xl font-bold text-gray-800 text-center border-2 border-indigo-300 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500",autoFocus:!0,onKeyDown:r=>{r.key==="Enter"&&Vr(),r.key==="Escape"&&(Zt(t||""),Qt(!1))}}),e.jsx("button",{onClick:Vr,disabled:Be||!ze.trim(),className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",title:a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save",children:Be?e.jsx(os,{className:"animate-spin",size:20}):e.jsx(Rr,{size:20})}),e.jsx("button",{onClick:()=>{Zt(t||""),Qt(!1)},disabled:Be,className:"p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",title:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel",children:e.jsx(Et,{size:20})})]}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 text-center",children:t||dr.yourStory}),bt&&!b&&e.jsx("button",{onClick:()=>Qt(!0),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors",title:a==="de"?"Titel bearbeiten":a==="fr"?"Modifier le titre":"Edit title",children:e.jsx(nt,{size:18})})]})}),Se&&e.jsx("div",{className:"bg-amber-50 border-2 border-amber-400 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-amber-500 text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-amber-800",children:a==="de"?"UnvollstÃ¤ndige Geschichte":a==="fr"?"Histoire incomplÃ¨te":"Incomplete Story"}),e.jsx("p",{className:"text-amber-700 text-sm mt-1",children:a==="de"?`Diese Geschichte konnte nicht vollstÃ¤ndig generiert werden. ${me||M.length} von ${ue||"unbekannt"} Seiten wurden erstellt.`:a==="fr"?`Cette histoire n'a pas pu Ãªtre gÃ©nÃ©rÃ©e complÃ¨tement. ${me||M.length} sur ${ue||"inconnu"} pages ont Ã©tÃ© crÃ©Ã©es.`:`This story could not be fully generated. ${me||M.length} of ${ue||"unknown"} pages were created.`}),qe&&oe&&e.jsxs("details",{className:"mt-2 text-sm",children:[e.jsx("summary",{className:"cursor-pointer text-amber-600 hover:text-amber-700",children:a==="de"?"Fehlerdetails":a==="fr"?"DÃ©tails de l'erreur":"Error details"}),e.jsx("p",{className:"mt-1 bg-amber-100 p-2 rounded text-amber-800 font-mono text-xs",children:qe})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[Rt&&je&&O&&e.jsxs("button",{onClick:O,disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Xa,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),Rt&&G&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>Cr(!Ue),disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Br,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Ut,{size:14,className:`transition-transform ${Ue?"rotate-180":""}`})]}),Ue&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:zt==="square",onChange:()=>Sr("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:zt==="A4",onChange:()=>Sr("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{G(zt),Cr(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),Rt&&je&&!b&&e.jsx(go,{storyId:je,variant:"full"}),ee&&e.jsxs("button",{onClick:ee,disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Za,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]}),oe&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[se&&e.jsxs("button",{onClick:se,className:"bg-gray-500 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 hover:bg-gray-600",children:[e.jsx(vr,{size:14})," TXT"]}),Rt&&je&&_&&e.jsxs("button",{onClick:_,disabled:b,className:`bg-yellow-500 text-black px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 ${b?"opacity-50 cursor-not-allowed":"hover:bg-yellow-600"}`,children:[e.jsx(Rs,{size:14})," Print (DEV)"]})]}),oe&&ms&&e.jsx("div",{className:"mt-4",children:e.jsx(uo,{settings:ms,language:a})}),oe&&e.jsxs("div",{className:"space-y-4 mt-6",children:[f&&e.jsxs("details",{className:"bg-purple-50 border-2 border-purple-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-purple-800 hover:text-purple-900 flex items-center gap-2",children:[e.jsx(Br,{size:20}),Ye?a==="de"?"VollstÃ¤ndige API-Ausgabe (Kombiniert)":a==="fr"?"Sortie API complÃ¨te (CombinÃ©e)":"Full API Output (Combined)":a==="de"?"VollstÃ¤ndige API-Ausgabe (Outline)":a==="fr"?"Sortie API complÃ¨te (Plan)":"Full API Output (Outline)",k&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-purple-600",children:["(",k,")"]}),h&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-purple-500",children:["[",h.input_tokens.toLocaleString()," in / ",h.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[s&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:s})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:Ye?a==="de"?"ðŸ“¥ API-Antwort (Kombiniert)":a==="fr"?"ðŸ“¥ RÃ©ponse API (CombinÃ©e)":"ðŸ“¥ API Response (Combined)":a==="de"?"ðŸ“¥ API-Antwort (Outline)":a==="fr"?"ðŸ“¥ RÃ©ponse API (Plan)":"ðŸ“¥ API Response (Outline)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:f})]})]})]}),i&&A.length>0&&e.jsxs("details",{className:"bg-amber-50 border-2 border-amber-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Rs,{size:20}),a==="de"?"VollstÃ¤ndige API-Ausgabe (Story-Text)":a==="fr"?"Sortie API complÃ¨te (Texte)":"Full API Output (Story Text)",((Zr=A[0])==null?void 0:Zr.modelId)&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-amber-600",children:["(",A[0].modelId,")"]}),((Tt=A[0])==null?void 0:Tt.usage)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-500",children:["[",A[0].usage.input_tokens.toLocaleString()," in / ",A[0].usage.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:(($t=A[0])==null?void 0:$t.prompt)||"No prompt available"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¥ Rohe API-Antwort (ungefiltert)":a==="fr"?"ðŸ“¥ RÃ©ponse API brute (non filtrÃ©e)":"ðŸ“¥ Raw API Response (unfiltered)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((st=A[0])==null?void 0:st.rawResponse)||i})]})]})]}),o&&e.jsxs("details",{className:"bg-rose-50 border-2 border-rose-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-rose-800 hover:text-rose-900 flex items-center gap-2",children:[e.jsx(Rs,{size:20}),a==="de"?"Visual Bible (Wiederkehrende Elemente)":a==="fr"?"Bible Visuelle (Ã‰lÃ©ments RÃ©currents)":"Visual Bible (Recurring Elements)",o.changeLog&&o.changeLog.length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-rose-200 text-rose-800 rounded-full text-xs font-medium",children:[o.changeLog.length," ",a==="de"?"Ã„nderungen":a==="fr"?"changements":"changes"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[o.mainCharacters&&o.mainCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-purple-300 rounded-lg p-3",children:[e.jsxs("h4",{className:"text-sm font-bold text-purple-700 mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘—"}),a==="de"?"Hauptcharaktere (Style Profile)":a==="fr"?"Personnages Principaux (Profil Style)":"Main Characters (Style Profile)"]}),e.jsx("div",{className:"space-y-3",children:o.mainCharacters.map(r=>{var y,N,F,m;return e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-sm",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-800 hover:text-purple-900",children:[r.name,Object.keys(r.generatedOutfits||{}).length>0&&e.jsxs("span",{className:"ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs",children:[Object.keys(r.generatedOutfits).length," ",a==="de"?"Outfits":a==="fr"?"tenues":"outfits"]})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"font-medium text-gray-600",children:"Physical:"}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[((y=r.physical)==null?void 0:y.skinTone)||"N/A"," | ",((N=r.physical)==null?void 0:N.hair)||"N/A"," | ",((F=r.physical)==null?void 0:F.build)||"N/A",((m=r.physical)==null?void 0:m.other)&&` | ${r.physical.other}`]})]}),r.generatedOutfits&&Object.keys(r.generatedOutfits).length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-purple-200",children:[e.jsx("span",{className:"font-medium text-gray-600 text-xs",children:"Generated Outfits:"}),e.jsx("div",{className:"mt-1 space-y-1",children:Object.entries(r.generatedOutfits).map(([Q,le])=>{var Ke;return e.jsxs("div",{className:"bg-white p-1.5 rounded text-xs",children:[e.jsxs("span",{className:"font-medium text-purple-600",children:["Page ",Q,":"]}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[(Ke=le.outfit)==null?void 0:Ke.substring(0,80),"..."]}),e.jsx("span",{className:`ml-1 px-1 py-0.5 rounded text-[10px] ${le.setting==="outdoor-cold"?"bg-blue-100 text-blue-700":le.setting==="outdoor-warm"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:le.setting})]},Q)})})]})]})]},r.id)})})]}),o.secondaryCharacters&&o.secondaryCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Nebencharaktere":a==="fr"?"Personnages Secondaires":"Secondary Characters"}),e.jsx("div",{className:"space-y-2",children:o.secondaryCharacters.map(r=>{var y;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[r.name,r.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:r.id}),r.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${r.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:r.source==="outline"?"Outline":"Story"}),((y=r.appearsInPages)==null?void 0:y.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",r.appearsInPages.join(", "),")"]})]}),(ge==null?void 0:ge.type)==="secondaryCharacter"&&(ge==null?void 0:ge.id)===r.id&&(ge==null?void 0:ge.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:lt,onChange:N=>Ot(N.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:ur,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Rr,{size:12})," Save"]}),e.jsxs("button",{onClick:tr,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(Et,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:r.description}),oe&&be&&e.jsx("button",{onClick:()=>er("secondaryCharacter",r.id,"description",r.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(nt,{size:12})})]}),r.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",r.extractedDescription]})]},r.id)})})]}),o.animals.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Tiere & Wesen":a==="fr"?"Animaux & CrÃ©atures":"Animals & Creatures"}),e.jsx("div",{className:"space-y-2",children:o.animals.map(r=>{var y;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[r.name,r.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:r.id}),r.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${r.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:r.source==="outline"?"Outline":"Story"}),((y=r.appearsInPages)==null?void 0:y.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",r.appearsInPages.join(", "),")"]})]}),(ge==null?void 0:ge.type)==="animal"&&(ge==null?void 0:ge.id)===r.id&&(ge==null?void 0:ge.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:lt,onChange:N=>Ot(N.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:ur,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Rr,{size:12})," Save"]}),e.jsxs("button",{onClick:tr,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(Et,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:r.description}),oe&&be&&e.jsx("button",{onClick:()=>er("animal",r.id,"description",r.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(nt,{size:12})})]}),r.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",r.extractedDescription]})]},r.id)})})]}),o.artifacts.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Artefakte & Objekte":a==="fr"?"Artefacts & Objets":"Artifacts & Objects"}),e.jsx("div",{className:"space-y-2",children:o.artifacts.map(r=>{var y;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[r.name,r.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:r.id}),r.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${r.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:r.source==="outline"?"Outline":"Story"}),((y=r.appearsInPages)==null?void 0:y.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",r.appearsInPages.join(", "),")"]})]}),(ge==null?void 0:ge.type)==="artifact"&&(ge==null?void 0:ge.id)===r.id&&(ge==null?void 0:ge.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:lt,onChange:N=>Ot(N.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:ur,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Rr,{size:12})," Save"]}),e.jsxs("button",{onClick:tr,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(Et,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:r.description}),oe&&be&&e.jsx("button",{onClick:()=>er("artifact",r.id,"description",r.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(nt,{size:12})})]}),r.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",r.extractedDescription]})]},r.id)})})]}),o.locations.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Wiederkehrende Orte":a==="fr"?"Lieux RÃ©currents":"Recurring Locations"}),e.jsx("div",{className:"space-y-2",children:o.locations.map(r=>{var y;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[r.name,r.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:r.id}),r.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${r.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:r.source==="outline"?"Outline":"Story"}),r.isRealLandmark&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 font-semibold",children:"ðŸ“ LANDMARK"}),r.photoFetchStatus==="success"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700",children:"ðŸ“· Photo"}),((y=r.appearsInPages)==null?void 0:y.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",r.appearsInPages.join(", "),")"]})]}),r.isRealLandmark&&r.landmarkQuery&&e.jsxs("div",{className:"text-amber-700 text-xs mt-1",children:["Landmark: ",e.jsx("span",{className:"font-mono bg-amber-50 px-1 rounded",children:r.landmarkQuery})]}),(ge==null?void 0:ge.type)==="location"&&(ge==null?void 0:ge.id)===r.id&&(ge==null?void 0:ge.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:lt,onChange:N=>Ot(N.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:ur,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Rr,{size:12})," Save"]}),e.jsxs("button",{onClick:tr,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(Et,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:r.description}),oe&&be&&e.jsx("button",{onClick:()=>er("location",r.id,"description",r.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(nt,{size:12})})]}),r.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",r.extractedDescription]}),r.referencePhotoData&&e.jsxs("div",{className:"mt-2 border border-amber-200 rounded overflow-hidden",children:[e.jsx("img",{src:r.referencePhotoData,alt:`${r.name} reference`,className:"w-full max-h-32 object-contain bg-gray-50"}),r.photoAttribution&&e.jsxs("div",{className:"text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 truncate",children:["ðŸ“· ",r.photoAttribution]})]})]},r.id)})})]}),o.vehicles&&o.vehicles.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Fahrzeuge":a==="fr"?"VÃ©hicules":"Vehicles"}),e.jsx("div",{className:"space-y-2",children:o.vehicles.map(r=>{var y;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[r.name,r.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:r.id}),r.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${r.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:r.source==="outline"?"Outline":"Story"}),((y=r.appearsInPages)==null?void 0:y.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",r.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:r.description}),r.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",r.extractedDescription]})]},r.id)})})]}),o.clothing&&o.clothing.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Kleidung & KostÃ¼me":a==="fr"?"VÃªtements & Costumes":"Clothing & Costumes"}),e.jsx("div",{className:"space-y-2",children:o.clothing.map(r=>{var y;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[r.name,r.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:r.id}),r.wornBy&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:["worn by ",r.wornBy]}),r.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${r.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:r.source==="outline"?"Outline":"Story"}),((y=r.appearsInPages)==null?void 0:y.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",r.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:r.description}),r.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",r.extractedDescription]})]},r.id)})})]}),o.changeLog&&o.changeLog.length>0&&e.jsxs("details",{className:"bg-white border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-bold text-amber-700 hover:text-amber-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“"}),a==="de"?"Ã„nderungsprotokoll":a==="fr"?"Journal des Modifications":"Change Log",e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-xs",children:o.changeLog.length})]}),e.jsx("div",{className:"mt-2 space-y-1 max-h-[500px] overflow-y-auto",children:o.changeLog.slice().reverse().map((r,y)=>{var N;return e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs border-l-2 border-amber-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${r.type==="mainCharacter"?"bg-purple-100 text-purple-700":r.type==="secondaryCharacter"?"bg-rose-100 text-rose-700":r.type==="generatedOutfit"?"bg-green-100 text-green-700":r.type==="animal"?"bg-orange-100 text-orange-700":r.type==="artifact"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:r.type}),e.jsx("span",{className:"font-semibold text-amber-800",children:r.element}),e.jsxs("span",{className:"text-gray-500",children:[Ce==="de"?"Seite":"Page"," ",r.page]})]}),e.jsxs("div",{className:"mt-1 text-gray-600",children:[e.jsxs("span",{className:"font-medium",children:[r.change,":"]}),e.jsxs("span",{className:"ml-1 text-gray-700",children:[(N=r.after)==null?void 0:N.substring(0,100),r.after&&r.after.length>100?"...":""]})]}),r.before&&e.jsxs("div",{className:"text-gray-400 line-through text-[10px] mt-0.5",children:[a==="de"?"Vorher":a==="fr"?"Avant":"Before",": ",r.before.substring(0,50),"..."]}),e.jsx("div",{className:"text-gray-400 text-[10px] mt-0.5",children:new Date(r.timestamp).toLocaleTimeString()})]},y)})})]}),(!o.mainCharacters||o.mainCharacters.length===0)&&(!o.secondaryCharacters||o.secondaryCharacters.length===0)&&(!o.animals||o.animals.length===0)&&(!o.artifacts||o.artifacts.length===0)&&(!o.locations||o.locations.length===0)&&(!o.vehicles||o.vehicles.length===0)&&(!o.clothing||o.clothing.length===0)&&e.jsx("div",{className:"text-gray-500 text-sm italic",children:a==="de"?"Keine wiederkehrenden Elemente gefunden":a==="fr"?"Aucun Ã©lÃ©ment rÃ©current trouvÃ©":"No recurring elements found in this story"})]})]}),Ve&&Object.keys(Ve).length>0&&e.jsxs("details",{className:"bg-teal-50 border-2 border-teal-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-teal-800 hover:text-teal-900 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸ‘”"}),a==="de"?`Kleidungsanforderungen (${Object.keys(Ve).length} Charaktere)`:a==="fr"?`Exigences vestimentaires (${Object.keys(Ve).length} personnages)`:`Clothing Requirements (${Object.keys(Ve).length} characters)`]}),e.jsx("div",{className:"mt-4 space-y-3",children:Object.entries(Ve).map(([r,y])=>{var N,F,m,Q,le,Ke,Nt,it,wt,xt,de,ot,_t,gr,Wt;return e.jsxs("div",{className:"bg-white border border-teal-200 rounded-lg p-3",children:[e.jsx("h4",{className:"font-bold text-teal-700 mb-2",children:r}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${(N=y.standard)!=null&&N.used?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(F=y.standard)!=null&&F.used?"âœ…":"â¬œ"," Standard"]}),((m=y.standard)==null?void 0:m.used)&&((Q=y.standard)==null?void 0:Q.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:y.standard.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(le=y.winter)!=null&&le.used?"bg-blue-50 border border-blue-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Ke=y.winter)!=null&&Ke.used?"â„ï¸":"â¬œ"," Winter"]}),((Nt=y.winter)==null?void 0:Nt.used)&&((it=y.winter)==null?void 0:it.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:y.winter.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(wt=y.summer)!=null&&wt.used?"bg-yellow-50 border border-yellow-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(xt=y.summer)!=null&&xt.used?"â˜€ï¸":"â¬œ"," Summer"]}),((de=y.summer)==null?void 0:de.used)&&((ot=y.summer)==null?void 0:ot.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:y.summer.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(_t=y.costumed)!=null&&_t.used?"bg-purple-50 border border-purple-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(gr=y.costumed)!=null&&gr.used?"ðŸŽ­":"â¬œ"," Costumed"]}),((Wt=y.costumed)==null?void 0:Wt.used)&&e.jsxs("div",{className:"text-gray-600 mt-1",children:[y.costumed.costume&&e.jsxs("span",{className:"font-medium",children:[y.costumed.costume,": "]}),y.costumed.description]})]})]})]},r)})})]}),we&&we.length>0&&e.jsxs("details",{className:"bg-pink-50 border-2 border-pink-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-pink-800 hover:text-pink-900 flex items-center gap-2",children:[e.jsx(ds,{size:20}),a==="de"?`Stilisierte Avatare (${we.length})`:a==="fr"?`Avatars stylisÃ©s (${we.length})`:`Styled Avatars (${we.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:we.map((r,y)=>{var N,F;return e.jsxs("details",{className:`border rounded-lg p-3 ${r.success?"bg-white border-pink-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${r.success?"bg-green-500":"bg-red-500"}`}),r.characterName," - ",r.artStyle," (",r.clothingCategory||"standard",")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(r.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:"Face Photo"}),(N=r.inputs.facePhoto)!=null&&N.imageData?e.jsx("img",{src:r.inputs.facePhoto.imageData,alt:"Face",className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.inputs.facePhoto.imageData,title:"Face Photo"}),title:`${r.inputs.facePhoto.sizeKB} KB - Click to enlarge`}):r.inputs.facePhoto?e.jsxs("span",{className:"text-blue-600 text-[10px]",children:[r.inputs.facePhoto.sizeKB," KB"]}):e.jsx("span",{className:"text-gray-400 italic text-[10px]",children:"N/A"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:"Original Avatar"}),(F=r.inputs.originalAvatar)!=null&&F.imageData?e.jsx("img",{src:r.inputs.originalAvatar.imageData,alt:"Avatar",className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.inputs.originalAvatar.imageData,title:"Original Avatar"}),title:`${r.inputs.originalAvatar.sizeKB} KB - Click to enlarge`}):e.jsxs("span",{className:"text-blue-600 text-[10px]",children:[r.inputs.originalAvatar.sizeKB," KB"]})]}),r.inputs.styleSample&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:"Style Sample"}),r.inputs.styleSample.imageData?e.jsx("img",{src:r.inputs.styleSample.imageData,alt:"Style",className:"w-16 h-16 object-cover rounded border border-purple-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.inputs.styleSample.imageData,title:"Style Sample"}),title:`${r.inputs.styleSample.sizeKB} KB - Click to enlarge`}):e.jsxs("span",{className:"text-purple-600 text-[10px]",children:[r.inputs.styleSample.sizeKB," KB"]})]})]})]}),r.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",r.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:r.prompt})]}),r.success&&r.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2 flex flex-col items-start",children:r.output.imageData?e.jsx("img",{src:r.output.imageData,alt:"Output",className:"w-24 h-24 object-cover rounded border border-green-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.output.imageData,title:"Styled Avatar Output"}),title:`${r.output.sizeKB} KB - Click to enlarge`}):e.jsxs("span",{className:"text-green-600",children:[r.output.sizeKB," KB"]})})]}),!r.success&&r.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:r.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(r.timestamp).toLocaleString()]})]})]},y)})})]}),Ee&&Ee.length>0&&e.jsxs("details",{className:"bg-orange-50 border-2 border-orange-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-orange-800 hover:text-orange-900 flex items-center gap-2",children:[e.jsx(ds,{size:20}),a==="de"?`KostÃ¼m-Avatare (${Ee.length})`:a==="fr"?`Avatars costumÃ©s (${Ee.length})`:`Costumed Avatars (${Ee.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:Ee.map((r,y)=>{var N,F,m;return e.jsxs("details",{className:`border rounded-lg p-3 ${r.success?"bg-white border-orange-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 hover:text-orange-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${r.success?"bg-green-500":"bg-red-500"}`}),r.characterName," - ",r.costumeType," (",r.artStyle,")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(r.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[r.costumeDescription&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-yellow-700",children:"Costume:"}),e.jsx("p",{className:"mt-1 text-gray-700",children:r.costumeDescription})]}),e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:"Face Photo"}),(N=r.inputs.facePhoto)!=null&&N.imageData?e.jsx("img",{src:r.inputs.facePhoto.imageData,alt:"Face",className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.inputs.facePhoto.imageData,title:"Face Photo"}),title:`${r.inputs.facePhoto.sizeKB} KB - Click to enlarge`}):e.jsxs("span",{className:"text-blue-600 text-[10px]",children:[((F=r.inputs.facePhoto)==null?void 0:F.sizeKB)||0," KB"]})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:"Standard Avatar"}),(m=r.inputs.standardAvatar)!=null&&m.imageData?e.jsx("img",{src:r.inputs.standardAvatar.imageData,alt:"Avatar",className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.inputs.standardAvatar.imageData,title:"Standard Avatar"}),title:`${r.inputs.standardAvatar.sizeKB} KB - Click to enlarge`}):e.jsx("span",{className:"text-gray-400 italic text-[10px]",children:"N/A"})]})]})]}),r.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",r.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:r.prompt})]}),r.success&&r.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2 flex flex-col items-start",children:r.output.imageData?e.jsx("img",{src:r.output.imageData,alt:"Output",className:"w-24 h-24 object-cover rounded border border-green-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>mt({src:r.output.imageData,title:"Costumed Avatar Output"}),title:`${r.output.sizeKB} KB - Click to enlarge`}):e.jsxs("span",{className:"text-green-600",children:[r.output.sizeKB," KB"]})})]}),!r.success&&r.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:r.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(r.timestamp).toLocaleString()]})]})]},y)})})]}),Re&&Re.length>0&&e.jsxs("details",{className:"bg-slate-50 border-2 border-slate-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-slate-800 hover:text-slate-900 flex items-center gap-2",children:[e.jsx(Br,{size:20}),a==="de"?`Generierungslog (${Re.length})`:a==="fr"?`Journal de gÃ©nÃ©ration (${Re.length})`:`Generation Log (${Re.length})`,Re.filter(r=>r.level==="warn").length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded-full",children:[Re.filter(r=>r.level==="warn").length," warnings"]}),Re.filter(r=>r.level==="error").length>0&&e.jsxs("span",{className:"ml-1 px-2 py-0.5 bg-red-200 text-red-800 text-xs rounded-full",children:[Re.filter(r=>r.level==="error").length," errors"]})]}),e.jsx("div",{className:"mt-4 space-y-1 max-h-96 overflow-y-auto",children:Re.map((r,y)=>e.jsxs("div",{className:`text-xs p-2 rounded flex items-start gap-2 ${r.level==="error"?"bg-red-50 text-red-800":r.level==="warn"?"bg-yellow-50 text-yellow-800":r.level==="debug"?"bg-gray-50 text-gray-600":"bg-white text-slate-700"}`,children:[e.jsx("span",{className:"text-gray-400 font-mono text-[10px] whitespace-nowrap",children:new Date(r.timestamp).toLocaleTimeString()}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium whitespace-nowrap ${r.stage==="outline"?"bg-blue-100 text-blue-700":r.stage==="avatars"?"bg-purple-100 text-purple-700":r.stage==="scenes"?"bg-green-100 text-green-700":r.stage==="images"?"bg-orange-100 text-orange-700":r.stage==="covers"?"bg-pink-100 text-pink-700":"bg-gray-100 text-gray-700"}`,children:r.stage}),r.character&&e.jsxs("span",{className:"font-medium text-slate-600",children:["[",r.character,"]"]}),e.jsx("span",{className:"flex-1",children:r.message}),e.jsx("span",{className:"text-gray-400 text-[10px]",children:r.event})]},y))})]}),Y&&e.jsxs("details",{className:`border-2 rounded-xl p-4 ${Y.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsxs("summary",{className:`cursor-pointer text-lg font-bold flex items-center gap-2 ${Y.overallConsistent?"text-green-800 hover:text-green-900":"text-amber-800 hover:text-amber-900"}`,children:[Y.overallConsistent?"âœ“":"âš ï¸",a==="de"?`KonsistenzprÃ¼fung (${Y.totalIssues} Probleme)`:a==="fr"?`VÃ©rification de cohÃ©rence (${Y.totalIssues} problÃ¨mes)`:`Final Checks (${Y.totalIssues} issues)`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-700",children:Y.summary}),Y.imageChecks&&Y.imageChecks.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"Bildkonsistenz":a==="fr"?"CohÃ©rence des images":"Image Consistency"}),Y.imageChecks.map((r,y)=>{var N,F;return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${r.consistent?"text-green-600":"text-amber-600"}`,children:r.consistent?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:r.type==="full"?"Full Check":r.type==="character"?`Character: ${r.characterName}`:r.type==="sequence"?"Sequence Check":r.type}),r.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",r.overallScore,"/10"]})]}),r.issues&&r.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:r.issues.map((m,Q)=>{var le,Ke;return e.jsxs("div",{className:`text-xs p-2 rounded ${m.severity==="high"?"bg-red-50 border-l-4 border-red-400":m.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${m.severity==="high"?"bg-red-200 text-red-800":m.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:m.severity}),e.jsxs("span",{className:"text-gray-500",children:["Pages ",(le=m.images)==null?void 0:le.join(", ")]}),m.pagesToFix&&m.pagesToFix.length>0&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px]",children:["Fix: ",m.pagesToFix.join(", ")]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:(Ke=m.type)==null?void 0:Ke.replace(/_/g," ")}),m.characterInvolved&&e.jsx("span",{className:"px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px]",children:m.characterInvolved})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:m.description}),m.details&&Object.keys(m.details).length>0&&e.jsx("div",{className:"mt-1 pl-2 border-l-2 border-gray-200",children:Object.entries(m.details).map(([Nt,it])=>e.jsxs("p",{className:"text-gray-500 text-[10px]",children:[e.jsxs("span",{className:"font-medium",children:[Nt,":"]})," ",it]},Nt))}),m.canonicalVersion&&e.jsxs("p",{className:"text-blue-700 mt-1",children:["ðŸŽ¯ Target: ",m.canonicalVersion]}),m.recommendation&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:["ðŸ’¡ ",m.recommendation]})]},Q)})}),r.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:r.summary}),(r.evaluationPrompts||r.evaluationPrompt)&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:["ðŸ” View Evaluation Prompt",(((N=r.evaluationPrompts)==null?void 0:N.length)??0)>1?`s (${(F=r.evaluationPrompts)==null?void 0:F.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:(r.evaluationPrompts??(r.evaluationPrompt?[r.evaluationPrompt]:[])).map((m,Q)=>{var le;return e.jsxs("div",{children:[(((le=r.evaluationPrompts)==null?void 0:le.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-blue-700 mb-1",children:["Batch ",Q+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:m})]},Q)})})]}),e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result (Full JSON)"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-96 overflow-y-auto bg-white p-2 rounded border",children:JSON.stringify({type:r.type,characterName:r.characterName,consistent:r.consistent,overallScore:r.overallScore,issues:r.issues,summary:r.summary},null,2)})]}),r.rawResponses&&r.rawResponses.length>0&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:["ðŸ“ View Raw Response",r.rawResponses.length>1?`s (${r.rawResponses.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:r.rawResponses.map((m,Q)=>{var le;return e.jsxs("div",{children:[(((le=r.rawResponses)==null?void 0:le.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-purple-700 mb-1",children:["Batch ",Q+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:m})]},Q)})})]})]},y)})]}),Y.textCheck&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"TextqualitÃ¤t":a==="fr"?"QualitÃ© du texte":"Text Quality"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${Y.textCheck.quality==="good"?"text-green-600":Y.textCheck.quality==="needs_review"?"text-amber-600":"text-red-600"}`,children:Y.textCheck.quality==="good"?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:Y.textCheck.quality==="good"?"Good":Y.textCheck.quality==="needs_review"?"Needs Review":"Has Issues"}),Y.textCheck.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",Y.textCheck.overallScore,"/10"]})]}),Y.textCheck.issues&&Y.textCheck.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:Y.textCheck.issues.map((r,y)=>e.jsxs("div",{className:`text-xs p-2 rounded ${r.severity==="high"?"bg-red-50 border-l-4 border-red-400":r.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${r.severity==="high"?"bg-red-200 text-red-800":r.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:r.severity}),r.page&&e.jsxs("span",{className:"text-gray-500",children:["Page ",r.page]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:r.type})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:r.issue}),(r.originalText||r.text)&&e.jsxs("p",{className:"text-red-600 mt-1 line-through",children:['"',r.originalText||r.text,'"']}),r.correctedText&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:['âœ“ "',r.correctedText,'"']}),!r.correctedText&&r.suggestion&&e.jsxs("p",{className:"text-green-700 mt-1",children:["â†’ ",r.suggestion]})]},y))}),Y.textCheck.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:Y.textCheck.summary}),Y.textCheck.fullOriginalText&&e.jsxs("details",{className:"mt-3 bg-gray-50 border border-gray-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-gray-700",children:"ðŸ“„ View Original Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-600 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.fullOriginalText})]}),Y.textCheck.fullCorrectedText&&e.jsxs("details",{className:"mt-3 bg-green-50 border border-green-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-green-800",children:"ðŸ“‹ View Full Corrected Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.fullCorrectedText})]}),Y.textCheck.rawResponse&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:"ðŸ“ View Raw Response"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.rawResponse})]}),Y.textCheck&&e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:JSON.stringify({quality:Y.textCheck.quality,overallScore:Y.textCheck.overallScore,issues:Y.textCheck.issues,summary:Y.textCheck.summary,parseError:Y.textCheck.parseError},null,2)})]}),Y.textCheck.evaluationPrompt&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:"ðŸ” View Evaluation Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.evaluationPrompt})]})]})]}),Y.error&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-2 text-xs text-red-700",children:["Error: ",Y.error]})]})]}),D.length>0&&e.jsxs("details",{className:"bg-green-50 border-2 border-green-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-green-800 hover:text-green-900 flex items-center gap-2",children:[e.jsx(Br,{size:20}),a==="de"?`Alle Szenenbeschreibungen (${D.length})`:a==="fr"?`Toutes les descriptions de scÃ¨nes (${D.length})`:`All Scene Descriptions (${D.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:D.map(r=>{var y;return e.jsxs("details",{className:"bg-white border border-green-200 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-700 hover:text-green-800",children:Ce==="de"?`Seite ${r.pageNumber}`:Ce==="fr"?`Page ${r.pageNumber}`:`Page ${r.pageNumber}`}),e.jsxs("div",{className:"mt-2 space-y-2",children:[r.outlineExtract&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-amber-700",children:"Outline Extract:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:r.outlineExtract})]}),r.scenePrompt&&e.jsxs("div",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-purple-700",children:"Scene Prompt:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:r.scenePrompt})]}),e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Scene Description:"}),r.textModelId&&e.jsxs("span",{className:"ml-2 text-green-600",children:["(",r.textModelId,")"]}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:typeof r.description=="string"?r.description:((y=r.description)==null?void 0:y.text)||JSON.stringify(r.description)})]})]})]},r.pageNumber)})})]})]}),C&&ht(C.frontCover)&&(()=>{var y,N,F;const r=Ar(C.frontCover);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Ce==="de"?"Titelseite":Ce==="fr"?"Couverture":"Front Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Is,{src:ht(C.frontCover),alt:"Front Cover",className:"w-full rounded-lg shadow-lg",label:"Front Cover"}),E.has("frontCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(ft,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),ne&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Ur("front"),disabled:b||!tt||E.has("frontCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||!tt||E.has("frontCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:tt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Gt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",yt," ",a==="de"?"Credits":"credits",")"]})]})}),oe&&r&&e.jsxs("div",{className:"mt-3 space-y-2",children:[$&&e.jsxs("button",{onClick:()=>$("front"),disabled:b,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),r.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:typeof r.description=="string"?r.description:((y=r.description)==null?void 0:y.text)||JSON.stringify(r.description)})]}),r.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",r.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",r.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:r.prompt})]}),((((N=r.referencePhotos)==null?void 0:N.length)??0)>0||(((F=r.landmarkPhotos)==null?void 0:F.length)??0)>0)&&e.jsx(ls,{referencePhotos:r.referencePhotos||[],landmarkPhotos:r.landmarkPhotos,language:a}),r.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",r.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",r.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${r.qualityScore>=70?"text-green-600":r.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(r.qualityScore),"%"]})]}),r.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:r.qualityReasoning})]})]}),r.retryHistory&&r.retryHistory.length>0&&e.jsx(Mr,{retryHistory:r.retryHistory,totalAttempts:r.totalAttempts||r.retryHistory.length,language:a}),r.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",r.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(r.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),r.originalImage&&r.originalImage!==r.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",r.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(r.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),C&&ht(C.initialPage)&&(()=>{var y,N,F;const r=Ar(C.initialPage);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Ce==="de"?"Widmungsseite":Ce==="fr"?"Page de dÃ©dicace":"Dedication Page"}),e.jsxs("div",{className:"relative",children:[e.jsx(Is,{src:ht(C.initialPage),alt:"Dedication Page",className:"w-full rounded-lg shadow-lg",label:"Dedication Page"}),E.has("initialPage")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(ft,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),ne&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Ur("initial"),disabled:b||!tt||E.has("initialPage"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||!tt||E.has("initialPage")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:tt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Gt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",yt," ",a==="de"?"Credits":"credits",")"]})]})}),oe&&r&&e.jsxs("div",{className:"mt-3 space-y-2",children:[$&&e.jsxs("button",{onClick:()=>$("initial"),disabled:b,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),r.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:typeof r.description=="string"?r.description:((y=r.description)==null?void 0:y.text)||JSON.stringify(r.description)})]}),r.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",r.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",r.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:r.prompt})]}),((((N=r.referencePhotos)==null?void 0:N.length)??0)>0||(((F=r.landmarkPhotos)==null?void 0:F.length)??0)>0)&&e.jsx(ls,{referencePhotos:r.referencePhotos||[],landmarkPhotos:r.landmarkPhotos,language:a}),r.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",r.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",r.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${r.qualityScore>=70?"text-green-600":r.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(r.qualityScore),"%"]})]}),r.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:r.qualityReasoning})]})]}),r.retryHistory&&r.retryHistory.length>0&&e.jsx(Mr,{retryHistory:r.retryHistory,totalAttempts:r.totalAttempts||r.retryHistory.length,language:a}),r.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",r.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(r.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),r.originalImage&&r.originalImage!==r.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",r.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(r.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),W&&!i&&(C==null?void 0:C.frontCover)&&e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-8 mt-6",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-indigo-700",children:Ce==="de"?"Geschichte wird erstellt...":Ce==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:Ce==="de"?"Die Seiten werden gleich angezeigt":Ce==="fr"?"Les pages seront bientÃ´t affichÃ©es":"Pages will appear shortly"})]})}),Rt&&i&&e.jsxs("div",{className:"space-y-8 mt-8",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 text-center mb-6",children:t||(Ce==="de"?"Ihre Geschichte":Ce==="fr"?"Votre histoire":"Your Story")}),Ft.slice(0,W?jt:Ft.length).map((r,y)=>{var Nt,it,wt,xt;const N=y+1,F=N,m=M.find(de=>de.pageNumber===F),Q=W?et[F]:void 0,le=!!(m!=null&&m.imageData||Q),Ke=W&&N===jt&&!le;return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:Ce==="de"?`Seite ${N}`:Ce==="fr"?`Page ${N}`:`Page ${N}`}),Ye?e.jsxs("div",{className:"flex flex-col items-center max-w-2xl mx-auto",children:[Ke?e.jsxs("div",{className:"w-full mb-4 aspect-[4/3] bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg shadow-md flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-indigo-600 font-medium",children:Ce==="de"?"Bild wird erstellt...":Ce==="fr"?"CrÃ©ation de l'image...":"Creating image..."}),e.jsx("p",{className:"text-indigo-400 text-sm mt-1",children:Ce==="de"?"Die nÃ¤chste Seite erscheint bald":Ce==="fr"?"La page suivante arrive bientÃ´t":"Next page coming soon"})]}):m!=null&&m.imageData||Q?e.jsxs("div",{className:"w-full mb-4 relative",children:[e.jsx(Is,{src:((m==null?void 0:m.imageData)||Q)??"",alt:`Scene for page ${N}`,className:`w-full rounded-lg shadow-md object-cover ${pe.has(N)?"opacity-50":""}`,label:`Page ${N}`}),pe.has(N)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(os,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]}),z&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>hs(N),disabled:b||pe.has(N)||!tt,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||pe.has(N)||!tt?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:tt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Gt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",yt," ",a==="de"?"Credits":"credits",")"]})]}),gt&&e.jsxs("button",{onClick:()=>cr(!0),disabled:b,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),Xt(N).length>1&&e.jsxs("button",{onClick:()=>Yt({pageNumber:N,versions:Xt(N)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(ds,{size:14}),Xt(N).length]})]})}),oe&&e.jsxs("div",{className:"mt-3 space-y-2",children:[J&&e.jsxs("button",{onClick:()=>J(N),disabled:b,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),re&&e.jsx("button",{onClick:()=>us(N),disabled:b||ye!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||ye!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:ye===N?e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx($s,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),(m==null?void 0:m.repairHistory)&&m.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx($s,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",m.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:m.repairHistory.map((de,ot)=>e.jsxs("div",{className:`border rounded-lg p-3 ${de.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${de.attempt}`:`Repair ${de.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${de.success?"text-green-600":"text-red-600"}`,children:["(",de.success?"âœ“":"âœ—"," ",de.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:de.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",de.fixPrompt]}),de.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:de.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),de.beforeImage&&de.afterImage&&e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:de.beforeImage,alt:"Before repair",className:"w-48 h-48 object-contain border rounded bg-gray-100 cursor-pointer hover:opacity-80 hover:ring-2 hover:ring-amber-400",onClick:()=>mt({src:de.beforeImage,title:a==="de"?"Vorher":"Before"}),title:a==="de"?"Klicken zum VergrÃ¶ÃŸern":"Click to enlarge"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:de.afterImage,alt:"After repair",className:"w-48 h-48 object-contain border rounded bg-gray-100 cursor-pointer hover:opacity-80 hover:ring-2 hover:ring-amber-400",onClick:()=>mt({src:de.afterImage,title:a==="de"?"Nachher":"After"}),title:a==="de"?"Klicken zum VergrÃ¶ÃŸern":"Click to enlarge"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(de.timestamp).toLocaleTimeString()})]},ot))})]}),Pr(N)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Pr(N)})]}),Pt(N)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:Pt(N)})]}),rr(N)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",Ht(N)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",Ht(N),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:rr(N)})]}),(m==null?void 0:m.prompt)&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",(m==null?void 0:m.modelId)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",m.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:m==null?void 0:m.prompt})]}),((((Nt=m==null?void 0:m.referencePhotos)==null?void 0:Nt.length)??0)>0||(((it=m==null?void 0:m.landmarkPhotos)==null?void 0:it.length)??0)>0)&&m&&e.jsx(ls,{referencePhotos:m.referencePhotos||[],landmarkPhotos:m.landmarkPhotos,language:a}),(m==null?void 0:m.qualityScore)!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",(m==null?void 0:m.qualityModelId)&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",m.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${((m==null?void 0:m.qualityScore)??0)>=70?"text-green-600":((m==null?void 0:m.qualityScore)??0)>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round((m==null?void 0:m.qualityScore)??0),"%"]})]}),(m==null?void 0:m.qualityReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:m.qualityReasoning})]})]}),(m==null?void 0:m.retryHistory)&&m.retryHistory.length>0&&e.jsx(Mr,{retryHistory:m.retryHistory,totalAttempts:(m==null?void 0:m.totalAttempts)||m.retryHistory.length,language:a,onRevertRepair:xe?(de,ot)=>xe(m.pageNumber,ot):void 0}),(m==null?void 0:m.wasRegenerated)&&(!(m!=null&&m.retryHistory)||m.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),(m==null?void 0:m.originalScore)!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(m.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),(m==null?void 0:m.originalImage)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:m.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),(m==null?void 0:m.originalReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:m.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`w-full flex flex-col items-center justify-center rounded-lg p-8 mb-4 ${b?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Ce==="de"?"Bild wird noch erstellt...":Ce==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Ce==="de"?"Kein Bild fÃ¼r diese Seite":Ce==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"w-full bg-indigo-50 rounded-lg p-6 border-2 border-indigo-200",children:vt?e.jsx("textarea",{value:r.trim(),onChange:de=>qr(y,de.target.value),className:"w-full min-h-[400px] p-3 text-gray-800 leading-snug font-serif text-xl text-center bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl text-center",children:r.trim()})})]}):e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-stretch",children:[m&&m.imageData?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:m.imageData,alt:`Scene for page ${N}`,className:`w-full rounded-lg shadow-md object-cover ${pe.has(N)?"opacity-50":""}`}),pe.has(N)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(os,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]})]}),z&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>hs(N),disabled:b||pe.has(N)||!tt,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||pe.has(N)||!tt?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:tt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Gt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",yt," ",a==="de"?"Credits":"credits",")"]})]}),gt&&e.jsxs("button",{onClick:()=>cr(!0),disabled:b,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),Xt(N).length>1&&e.jsxs("button",{onClick:()=>Yt({pageNumber:N,versions:Xt(N)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(ds,{size:14}),Xt(N).length]})]})}),oe&&e.jsxs("div",{className:"mt-3 space-y-2",children:[J&&e.jsxs("button",{onClick:()=>J(N),disabled:b,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),re&&e.jsx("button",{onClick:()=>us(N),disabled:b||ye!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||ye!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:ye===N?e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx($s,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),(m==null?void 0:m.repairHistory)&&m.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx($s,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",m.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:m.repairHistory.map((de,ot)=>e.jsxs("div",{className:`border rounded-lg p-3 ${de.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${de.attempt}`:`Repair ${de.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${de.success?"text-green-600":"text-red-600"}`,children:["(",de.success?"âœ“":"âœ—"," ",de.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:de.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",de.fixPrompt]}),de.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:de.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),de.beforeImage&&de.afterImage&&e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:de.beforeImage,alt:"Before repair",className:"w-48 h-48 object-contain border rounded bg-gray-100 cursor-pointer hover:opacity-80 hover:ring-2 hover:ring-amber-400",onClick:()=>mt({src:de.beforeImage,title:a==="de"?"Vorher":"Before"}),title:a==="de"?"Klicken zum VergrÃ¶ÃŸern":"Click to enlarge"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:de.afterImage,alt:"After repair",className:"w-48 h-48 object-contain border rounded bg-gray-100 cursor-pointer hover:opacity-80 hover:ring-2 hover:ring-amber-400",onClick:()=>mt({src:de.afterImage,title:a==="de"?"Nachher":"After"}),title:a==="de"?"Klicken zum VergrÃ¶ÃŸern":"Click to enlarge"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(de.timestamp).toLocaleTimeString()})]},ot))})]}),Pr(N)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Pr(N)})]}),Pt(N)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:Pt(N)})]}),rr(N)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",Ht(N)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",Ht(N),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:rr(N)})]}),m.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",m.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",m.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:m.prompt})]}),((((wt=m.referencePhotos)==null?void 0:wt.length)??0)>0||(((xt=m.landmarkPhotos)==null?void 0:xt.length)??0)>0)&&e.jsx(ls,{referencePhotos:m.referencePhotos||[],landmarkPhotos:m.landmarkPhotos,language:a}),m.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",m.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",m.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${m.qualityScore>=70?"text-green-600":m.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(m.qualityScore),"%"]})]}),m.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:m.qualityReasoning})]})]}),m.retryHistory&&m.retryHistory.length>0&&e.jsx(Mr,{retryHistory:m.retryHistory,totalAttempts:m.totalAttempts||m.retryHistory.length,language:a,onRevertRepair:xe?(de,ot)=>xe(m.pageNumber,ot):void 0}),m.wasRegenerated&&(!m.retryHistory||m.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),m.originalScore!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(m.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),m.originalImage&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:m.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),m.originalReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:m.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`flex flex-col items-center justify-center rounded-lg p-8 ${b?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Ce==="de"?"Bild wird noch erstellt...":Ce==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Ce==="de"?"Kein Bild fÃ¼r diese Seite":Ce==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"flex flex-col w-full h-full",children:vt?e.jsx("textarea",{value:r.trim(),onChange:de=>qr(y,de.target.value),className:"w-full flex-1 min-h-[300px] p-4 text-gray-800 leading-snug font-serif text-xl bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("div",{className:"prose max-w-none",children:e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl",children:r.trim()})})})]})]},N)})]}),C&&ht(C.backCover)&&(()=>{var y,N,F;const r=Ar(C.backCover);return e.jsxs("div",{className:"mt-8 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Ce==="de"?"RÃ¼ckseite":Ce==="fr"?"QuatriÃ¨me de couverture":"Back Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Is,{src:ht(C.backCover),alt:"Back Cover",className:"w-full rounded-lg shadow-lg",label:"Back Cover"}),E.has("backCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(ft,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),ne&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Ur("back"),disabled:b||!tt||E.has("backCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b||!tt||E.has("backCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:tt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Gt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",yt," ",a==="de"?"Credits":"credits",")"]})]})}),oe&&r&&e.jsxs("div",{className:"mt-3 space-y-2",children:[$&&e.jsxs("button",{onClick:()=>$("back"),disabled:b,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),r.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:typeof r.description=="string"?r.description:((y=r.description)==null?void 0:y.text)||JSON.stringify(r.description)})]}),r.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",r.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",r.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:r.prompt})]}),((((N=r.referencePhotos)==null?void 0:N.length)??0)>0||(((F=r.landmarkPhotos)==null?void 0:F.length)??0)>0)&&e.jsx(ls,{referencePhotos:r.referencePhotos||[],landmarkPhotos:r.landmarkPhotos,language:a}),r.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",r.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",r.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${r.qualityScore>=70?"text-green-600":r.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(r.qualityScore),"%"]})]}),r.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:r.qualityReasoning})]})]}),r.retryHistory&&r.retryHistory.length>0&&e.jsx(Mr,{retryHistory:r.retryHistory,totalAttempts:r.totalAttempts||r.retryHistory.length,language:a}),r.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",r.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(r.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),r.originalImage&&r.originalImage!==r.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",r.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(r.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:r.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),Rt&&i&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-4 mt-6",children:[e.jsx("h3",{className:"text-base font-bold text-gray-800 mb-3 text-center",children:a==="de"?"Was mÃ¶chten Sie als NÃ¤chstes tun?":a==="fr"?"Que souhaitez-vous faire ensuite ?":"What would you like to do next?"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[je&&O&&e.jsxs("button",{onClick:O,disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Xa,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),G&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>Cr(!Ue),disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Br,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Ut,{size:14,className:`transition-transform ${Ue?"rotate-180":""}`})]}),Ue&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:zt==="square",onChange:()=>Sr("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:zt==="A4",onChange:()=>Sr("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{G(zt),Cr(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),gt&&!vt&&e.jsxs("button",{onClick:()=>cr(!0),disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(nt,{size:16})," ",a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),ee&&e.jsxs("button",{onClick:ee,disabled:b,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${b?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Za,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]})]}),vt&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-lg p-3 md:p-4 z-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-2 md:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-600",children:[e.jsx(nt,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"font-semibold text-sm md:text-base",children:a==="de"?"Bearbeitungsmodus":a==="fr"?"Mode Ã©dition":"Edit Mode"}),He&&e.jsxs("span",{className:"text-xs text-gray-500 hidden sm:inline",children:["(",a==="de"?"Original gespeichert":a==="fr"?"Original sauvegardÃ©":"Original saved",")"]})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto justify-center md:justify-end",children:[e.jsxs("button",{onClick:At,disabled:dt,className:"px-3 md:px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(Et,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"})]}),He&&rt!==He&&e.jsxs("button",{onClick:()=>jr(He),disabled:dt,className:"px-3 md:px-4 py-2 border border-amber-400 text-amber-700 rounded-lg hover:bg-amber-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(Ri,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"ZurÃ¼cksetzen":a==="fr"?"Restaurer":"Restore"})]}),e.jsxs("button",{onClick:mr,disabled:dt,className:`px-3 md:px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold flex items-center gap-1.5 ${dt?"opacity-50 cursor-not-allowed":"hover:bg-green-600"}`,children:[e.jsx(Rr,{size:16}),dt?a==="de"?"Speichern...":a==="fr"?"Sauvegarde...":"Saving...":a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save"]})]})]})}),_e&&e.jsx(oo,{pageNumber:_e.pageNumber,scene:_e.scene,onSceneChange:r=>kt({..._e,scene:r}),onClose:()=>kt(null),onRegenerate:xs,isRegenerating:pe.has(_e.pageNumber),imageRegenerationCost:yt,characters:Z.map(r=>({id:r.id,name:r.name})),selectedCharacterIds:_e.selectedCharacterIds,onCharacterSelectionChange:r=>kt({..._e,selectedCharacterIds:r}),consistencyRegen:oe?(sr=M.find(r=>r.pageNumber===_e.pageNumber))==null?void 0:sr.consistencyRegen:void 0}),Pe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Gt,{size:20}),a==="de"?"Cover bearbeiten":a==="fr"?"Modifier la couverture":"Edit Cover"," - ",Pe.coverType==="front"?a==="de"?"Titelseite":a==="fr"?"Couverture":"Front Cover":Pe.coverType==="initial"?a==="de"?"Einleitungsseite":a==="fr"?"Page de dÃ©dicace":"Dedication Page":a==="de"?"RÃ¼ckseite":a==="fr"?"Dos":"Back Cover"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a==="de"?"Bearbeite die Szenenbeschreibung und wÃ¤hle die Charaktere aus":a==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages":"Edit the scene description and select the characters"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[Z.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(ya,{size:16}),a==="de"?"Charaktere auf dem Cover:":a==="fr"?"Personnages sur la couverture:":"Characters on the cover:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Z.map(r=>{const y=Pe.selectedCharacterIds.includes(r.id);return e.jsxs("button",{type:"button",onClick:()=>{const N=y?Pe.selectedCharacterIds.filter(F=>F!==r.id):[...Pe.selectedCharacterIds,r.id];j({...Pe,selectedCharacterIds:N})},className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${y?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:r.name}),y&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},r.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"WÃ¤hle die Charaktere aus, die auf dem Cover erscheinen sollen.":a==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre sur la couverture.":"Select the characters that should appear on the cover."})]}),Pe.coverType==="front"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Titel:":a==="fr"?"Titre:":"Title:"}),e.jsx("input",{type:"text",value:Pe.title||"",onChange:r=>j({...Pe,title:r.target.value}),placeholder:a==="de"?"Der Titel des Buches":a==="fr"?"Le titre du livre":"The book title",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),Pe.coverType==="initial"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Widmung:":a==="fr"?"DÃ©dicace:":"Dedication:"}),e.jsx("input",{type:"text",value:Pe.dedication||"",onChange:r=>j({...Pe,dedication:r.target.value}),placeholder:a==="de"?'z.B. "FÃ¼r meine liebste Tochter Emma"':a==="fr"?'par ex. "Pour ma chÃ¨re fille Emma"':'e.g. "For my dear daughter Emma"',className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:a==="de"?"Leer lassen fÃ¼r keine Widmung":a==="fr"?"Laisser vide pour aucune dÃ©dicace":"Leave empty for no dedication"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Szenenbeschreibung:":a==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:Pe.scene,onChange:r=>j({...Pe,scene:r.target.value}),placeholder:a==="de"?'z.B. "Die Hauptfigur steht vor einem magischen Schloss bei Sonnenuntergang"':a==="fr"?'par ex. "Le personnage principal devant un chÃ¢teau magique au coucher du soleil"':'e.g. "The main character standing in front of a magical castle at sunset"',className:"w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"Tipp: Beschreibe die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":a==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:Pe.selectedCharacterIds.length>0&&e.jsx("span",{children:a==="de"?`${Pe.selectedCharacterIds.length} Charakter(e) ausgewÃ¤hlt`:a==="fr"?`${Pe.selectedCharacterIds.length} personnage(s) sÃ©lectionnÃ©(s)`:`${Pe.selectedCharacterIds.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:()=>j(null),className:"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium order-2 sm:order-1",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"}),e.jsxs("button",{onClick:Ls,disabled:E.has(Pe.coverType==="front"?"frontCover":Pe.coverType==="initial"?"initialPage":"backCover")||Pe.selectedCharacterIds.length===0,className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${E.has(Pe.coverType==="front"?"frontCover":Pe.coverType==="initial"?"initialPage":"backCover")||Pe.selectedCharacterIds.length===0?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:[e.jsx(Gt,{size:16}),a==="de"?"Neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",yt," ",a==="de"?"Credits":"credits",")"]})]})]})]})]})}),ct&&e.jsx(lo,{pageNumber:ct.pageNumber,versions:ct.versions,onClose:()=>Yt(null),onSelectVersion:kr,developerMode:oe}),wr&&e.jsx(co,{src:wr.src,title:wr.title,onClose:()=>mt(null)})]})}const Es={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.5 - Best narrative quality",descriptionDe:"Claude Sonnet 4.5 - Beste ErzÃ¤hlqualitÃ¤t",descriptionFr:"Claude Sonnet 4.5 - Meilleure qualitÃ© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 3.5 - Fast and cheap",descriptionDe:"Claude Haiku 3.5 - Schnell und gÃ¼nstig",descriptionFr:"Claude Haiku 3.5 - Rapide et Ã©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe QualitÃ¤t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualitÃ©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - TrÃ¨s rapide"}},on={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide de scÃ¨nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra gÃ¼nstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra Ã©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere QualitÃ¤t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualitÃ© ($0.004/image)"}},xo={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - Ã‰valuation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - GrÃ¼ndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},po={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste QualitÃ¤t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualitÃ© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra gÃ¼nstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra Ã©conomique pour tests ($0.0006/image)"}},fo={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - GÃ¼nstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars Ã©conomiques avec visage cohÃ©rent (~$0.005)"}};function qt({label:t,icon:l,value:i,options:f,onChange:s,language:k}){const h=A=>k==="de"&&A.descriptionDe?A.descriptionDe:k==="fr"&&A.descriptionFr?A.descriptionFr:A.description;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[l,t]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:i||"",onChange:A=>s(A.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:k==="de"?"Server-Standard":k==="fr"?"Par dÃ©faut serveur":"Server Default"}),Object.entries(f).map(([A,o])=>e.jsxs("option",{value:A,children:[A," ",o.provider?`(${o.provider})`:""]},A))]}),e.jsx(Ut,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),i&&f[i]&&e.jsx("p",{className:"text-[10px] text-gray-500 italic",children:h(f[i])})]})}function bo({selections:t,onChange:l}){const{language:i}=Lt(),f=(s,k)=>{l({...t,[s]:k})};return e.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[e.jsx(Hi,{size:16}),i==="de"?"AI-Modell Auswahl (Dev)":i==="fr"?"SÃ©lection de modÃ¨le IA (Dev)":"AI Model Selection (Dev)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(qt,{label:i==="de"?"Ideen-Modell":i==="fr"?"ModÃ¨le d'idÃ©es":"Idea Model",icon:e.jsx(Wi,{size:12}),value:t.ideaModel,options:Es,onChange:s=>f("ideaModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Geschichte (Kombiniert)":i==="fr"?"Histoire (CombinÃ©)":"Story (Combined)",icon:e.jsx(Gr,{size:12}),value:t.outlineModel,options:Es,onChange:s=>f("outlineModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Text-Modell":i==="fr"?"ModÃ¨le de texte":"Text Model",icon:e.jsx(Gr,{size:12}),value:t.textModel,options:Es,onChange:s=>f("textModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Szenen-Modell":i==="fr"?"ModÃ¨le de scÃ¨ne":"Scene Description Model",icon:e.jsx(bn,{size:12}),value:t.sceneDescriptionModel,options:Es,onChange:s=>f("sceneDescriptionModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Bild-Modell":i==="fr"?"ModÃ¨le d'image":"Image Model",icon:e.jsx(Ya,{size:12}),value:t.imageModel,options:on,onChange:s=>f("imageModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Cover-Modell":i==="fr"?"ModÃ¨le de couverture":"Cover Image Model",icon:e.jsx(Qi,{size:12}),value:t.coverImageModel,options:on,onChange:s=>f("coverImageModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Bewertungs-Modell":i==="fr"?"ModÃ¨le d'Ã©valuation":"Quality Eval Model",icon:e.jsx(ki,{size:12}),value:t.qualityModel,options:xo,onChange:s=>f("qualityModel",s),language:i}),e.jsx(qt,{label:i==="de"?"Bild-Reparatur":i==="fr"?"RÃ©paration d'image":"Image Repair",icon:e.jsx(Ji,{size:12}),value:t.imageBackend,options:po,onChange:s=>f("imageBackend",s),language:i}),e.jsx(qt,{label:i==="de"?"Avatar-Modell":i==="fr"?"ModÃ¨le d'avatar":"Avatar Model",icon:e.jsx(Ya,{size:12}),value:t.avatarModel,options:fo,onChange:s=>f("avatarModel",s),language:i})]}),e.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:i==="de"?'Hinweis: Nur sichtbar fÃ¼r Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':i==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode dÃ©veloppeur. "Par dÃ©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}const ln=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"FranÃ§ais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],zs={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"SÃ¼ddeutsch"},{code:"de-at",name:"Ã–sterreich"},{code:"de-it",name:"SÃ¼dtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"QuÃ©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"ZÃ¼ritÃ¼Ã¼tsch"},{code:"gsw-be",name:"BÃ¤rndÃ¼tsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"LuzÃ¤rndÃ¼tsch"},{code:"gsw-sg",name:"SanggallerdÃ¼tsch"},{code:"gsw-vs",name:"WalliserdÃ¼tsch"},{code:"gsw-gr",name:"BÃ¼ndnerdÃ¼tsch"}]};function ga(t){return t.startsWith("gsw")?"gsw":t.startsWith("de")?"de":t.startsWith("fr")?"fr":t.startsWith("it")?"it":"en"}const yo=["spring","summer","autumn","winter"];function vn(){const t=new Date().getMonth();return t>=2&&t<=4?"spring":t>=5&&t<=7?"summer":t>=8&&t<=10?"autumn":"winter"}function vo({languageLevel:t,onLanguageLevelChange:l,pages:i,onPagesChange:f,storyLanguage:s,onStoryLanguageChange:k,developerMode:h,userLocation:A,onLocationChange:o,season:M,onSeasonChange:D,userCredits:C}){const{t:E,language:v}=Lt(),[p,b]=d.useState(!1),[G,O]=d.useState((A==null?void 0:A.city)||""),[_,ee]=d.useState((A==null?void 0:A.country)||""),[se,z]=d.useState(!1),ne=d.useRef(null);d.useEffect(()=>{const W=ke=>{ne.current&&!ne.current.contains(ke.target)&&z(!1)};return document.addEventListener("mousedown",W),()=>document.removeEventListener("mousedown",W)},[]);const Z=d.useCallback(()=>{const W=ga(s),ke=ln.find(He=>He.family===W),et=zs[W].find(He=>He.code===s)||zs[W][0];return ke&&et?`${ke.name} (${et.name})`:(ke==null?void 0:ke.name)||s},[s]);d.useEffect(()=>{A&&(O(A.city||""),ee(A.country||""))},[A]);const J=()=>{o({city:G||null,region:null,country:_||null}),b(!1)},$={spring:{de:"FrÃ¼hling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"Ã‰tÃ©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},re=h?4:10,xe=50,be=2,je=10,oe=C===-1,we=oe?xe:Math.floor(C/je),Ee=Math.floor(we/2)*2,Re=re*je,Y=!oe&&C<Re,Ve=Re-C,Se=Y?re:Math.min(xe,Math.max(re,Ee)),qe=!oe&&Ee<xe;d.useEffect(()=>{let W=i;W%2!==0&&(W=Math.round(W/2)*2),W=Math.max(re,Math.min(Se,W)),W!==i&&f(W)},[i,re,Se,f]);const me=[{value:"1st-grade",label:E.firstGrade,desc:E.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:E.standard,desc:E.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:E.advanced,desc:E.advancedDesc,image:"/images/dense text left.jpg"}],ue=(W,ke=!1)=>{const et=ke?" (Test)":"",He=W*10,gt=v==="de"?"Credits":v==="fr"?"crÃ©dits":"credits";if(t==="1st-grade")return`${W} ${v==="de"?"Seiten":"pages"} = ${He} ${gt}${et}`;const bt=Math.floor(W/2),Kt=Math.floor(W/2);return v==="de"?`${W} Seiten (${bt} Text + ${Kt} Bilder) = ${He} ${gt}${et}`:v==="fr"?`${W} pages (${bt} texte + ${Kt} images) = ${He} ${gt}${et}`:`${W} pages (${bt} text + ${Kt} images) = ${He} ${gt}${et}`};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Rs,{size:24}),v==="de"?"Buchformat":v==="fr"?"Format du livre":"Book Format"]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:v==="de"?"Sprache:":v==="fr"?"Langue:":"Language:"}),e.jsxs("div",{className:"relative",ref:ne,children:[e.jsxs("button",{type:"button",onClick:()=>z(!se),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[Z(),e.jsx(Ut,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${se?"rotate-180":""}`})]}),se&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[ln.map(W=>{const ke=ga(s)===W.family;return e.jsx("button",{type:"button",onClick:()=>{const et=zs[W.family][0];k(et.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${ke?"font-semibold text-indigo-600":"text-gray-700"}`,children:W.name},W.family)}),e.jsx("div",{className:"border-t border-gray-300 my-1"}),zs[ga(s)].map(W=>e.jsx("button",{type:"button",onClick:()=>{k(W.code),z(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${s===W.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:W.name},W.code))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ui,{className:"text-gray-500",size:16}),e.jsx("span",{className:"text-sm text-gray-600",children:v==="de"?"Ort:":v==="fr"?"Lieu:":"Location:"}),p?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"text",value:G,onChange:W=>O(W.target.value),placeholder:v==="de"?"Stadt":v==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("input",{type:"text",value:_,onChange:W=>ee(W.target.value),placeholder:v==="de"?"Land":v==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("button",{onClick:J,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),e.jsx("button",{onClick:()=>b(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"âœ•"})]}):e.jsx("button",{onClick:()=>b(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:A!=null&&A.city?`${A.city}${A.country?`, ${A.country}`:""}`:v==="de"?"Festlegen":v==="fr"?"DÃ©finir":"Set"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:v==="de"?"Jahreszeit:":v==="fr"?"Saison:":"Season:"}),e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:M,onChange:W=>D(W.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:yo.map(W=>e.jsx("option",{value:W,children:$[W][v]||$[W].en},W))}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:E.readingLevel}),e.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:me.map(W=>e.jsxs("button",{onClick:()=>l(W.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${t===W.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[e.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:e.jsx("img",{src:W.image,alt:W.label,className:"w-full h-full object-contain"})}),e.jsxs("div",{className:"p-2 md:p-2.5",children:[e.jsx("div",{className:"font-semibold text-sm mb-0.5",children:W.label}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:W.desc})]})]},W.value))})]}),t&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:E.numberOfPages}),Y?e.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-red-700 font-semibold mb-2",children:v==="de"?"Nicht genÃ¼gend Credits":v==="fr"?"CrÃ©dits insuffisants":"Not enough credits"}),e.jsx("p",{className:"text-red-600 text-sm",children:v==="de"?`Du benÃ¶tigst mindestens ${Re} Credits fÃ¼r eine Geschichte mit ${re} Seiten. Dir fehlen noch ${Ve} Credits.`:v==="fr"?`Vous avez besoin d'au moins ${Re} crÃ©dits pour une histoire de ${re} pages. Il vous manque ${Ve} crÃ©dits.`:`You need at least ${Re} credits for a ${re}-page story. You need ${Ve} more credits.`}),e.jsx("p",{className:"text-gray-500 text-xs mt-2",children:v==="de"?`Aktuell: ${C} Credits`:v==="fr"?`Actuel: ${C} crÃ©dits`:`Current: ${C} credits`})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"range",min:re,max:Se,step:be,value:Math.min(i,Se),onChange:W=>f(parseInt(W.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-400",children:re}),e.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[i," ",v==="de"?"Seiten":"pages"]}),e.jsxs("span",{className:`text-sm ${qe?"text-orange-500 font-medium":"text-gray-400"}`,children:[Se,qe&&" âš ï¸"]})]}),qe&&e.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:v==="de"?`Max. ${Se} Seiten mit ${C} Credits mÃ¶glich`:v==="fr"?`Max. ${Se} pages possibles avec ${C} crÃ©dits`:`Max. ${Se} pages possible with ${C} credits`}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-base font-medium text-gray-700",children:ue(i,i===4)}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:t==="1st-grade"?v==="de"?"Jede Seite enthÃ¤lt ein Bild mit Text darunter":v==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":v==="de"?"Abwechselnd Textseite und Bildseite":v==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const jo=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:vo,getCurrentSeason:vn},Symbol.toStringTag,{value:"Module"})),dn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail prÃ¼fen",description:"Wir haben Ihnen einen BestÃ¤tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail bestÃ¤tigen!",currentEmail:"BestÃ¤tigung gesendet an",sendVerification:"BestÃ¤tigungs-E-Mail senden",resendVerification:"BestÃ¤tigungs-E-Mail erneut senden",emailSent:"BestÃ¤tigungs-E-Mail gesendet! Bitte prÃ¼fen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? Ã„ndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"Ã„ndern & BestÃ¤tigen",cancel:"Abbrechen",emailChanged:"E-Mail geÃ¤ndert! Bitte prÃ¼fen Sie Ihren neuen Posteingang fÃ¼r die BestÃ¤tigung.",checkSpam:"Nicht gefunden? PrÃ¼fen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausfÃ¼llen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function No({isOpen:t,onClose:l,onVerified:i}){const{language:f}=Lt(),{user:s,refreshUser:k}=ba(),h=dn[f]||dn.en,[A,o]=d.useState("verify"),[M,D]=d.useState(!1),[C,E]=d.useState(!1),[v,p]=d.useState(""),[b,G]=d.useState(""),[O,_]=d.useState(!1),[ee,se]=d.useState(0),[z,ne]=d.useState(""),[Z,J]=d.useState(""),$=d.useRef(null),re=d.useRef(null),xe=d.useRef(!1);if(d.useEffect(()=>(ee>0&&(re.current=setTimeout(()=>{se(oe=>oe-1)},1e3)),()=>{re.current&&clearTimeout(re.current)}),[ee]),d.useEffect(()=>{if(t&&!xe.current&&!C){xe.current=!0;const oe=setTimeout(async()=>{D(!0);try{const we=await Ge.post("/api/auth/send-verification",{});E(!0),G(h.emailSent),we.cooldown&&se(we.cooldown)}catch(we){const Ee=we;Ee.retryAfter?(se(Ee.retryAfter),E(!0)):p(Ee.message||"Failed to send verification email")}finally{D(!1)}},300);return()=>clearTimeout(oe)}t||(xe.current=!1)},[t,C,h.emailSent]),d.useEffect(()=>{if(!t){$.current&&(clearInterval($.current),$.current=null);return}return _(!0),console.log("[EmailVerificationModal] Starting polling"),$.current=setInterval(async()=>{try{const oe=await Ge.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",oe.emailVerified),oe.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await k(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),$.current&&(clearInterval($.current),$.current=null),_(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),i==null||i(),console.log("[EmailVerificationModal] Calling onClose"),l())}catch(oe){console.debug("Verification status poll error:",oe)}},3e3),()=>{$.current&&(clearInterval($.current),$.current=null)}},[t,k,i,l]),!t)return null;const be=async()=>{D(!0),p("");try{const oe=await Ge.post("/api/auth/send-verification",{});E(!0),G(h.emailSent),oe.cooldown&&se(oe.cooldown)}catch(oe){const we=oe;we.retryAfter?(se(we.retryAfter),p(f==="de"?`Bitte warten Sie ${we.retryAfter} Sekunden`:f==="fr"?`Veuillez patienter ${we.retryAfter} secondes`:`Please wait ${we.retryAfter} seconds`)):p(we.message||"Failed to send verification email")}finally{D(!1)}},je=async()=>{if(!z||!Z){p(h.fillAllFields);return}D(!0),p("");try{await Ge.post("/api/auth/change-email",{newEmail:z,password:Z}),G(h.emailChanged),o("verify"),ne(""),J("")}catch(oe){p(oe instanceof Error?oe.message:"Failed to change email")}finally{D(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[e.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:e.jsx(Et,{size:20})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(fn,{className:"w-8 h-8 text-indigo-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:h.title}),e.jsx("p",{className:"text-gray-500",children:h.description})]}),v&&e.jsx(Ja,{variant:"error",className:"mb-4",children:v}),b&&e.jsxs(Ja,{variant:"success",className:"mb-4",children:[b,e.jsx("p",{className:"text-sm mt-1 opacity-80",children:h.checkSpam})]}),O&&C&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[e.jsx(ft,{size:16,className:"animate-spin"}),e.jsx("span",{className:"text-sm",children:f==="de"?"Warte auf BestÃ¤tigung...":f==="fr"?"En attente de verification...":"Waiting for verification..."})]}),A==="verify"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:h.currentEmail}),e.jsx("p",{className:"font-medium text-gray-800",children:s==null?void 0:s.email})]}),e.jsxs(Fs,{onClick:be,variant:"primary",loading:M,disabled:ee>0,className:"w-full",children:[e.jsx(Gt,{size:16,className:"mr-2"}),ee>0?`${f==="de"?"Warten":f==="fr"?"Patienter":"Wait"} ${ee}s`:C?h.resendVerification:h.sendVerification]}),e.jsxs("button",{onClick:()=>{o("change"),p(""),G("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[e.jsx(nt,{size:16}),h.changeEmail]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ka,{type:"email",label:h.newEmail,value:z,onChange:oe=>ne(oe.target.value),placeholder:"your@newemail.com",disabled:M}),e.jsx(Ka,{type:"password",label:h.currentPassword,value:Z,onChange:oe=>J(oe.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:M}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Fs,{onClick:()=>{o("verify"),p(""),ne(""),J("")},variant:"secondary",className:"flex-1",disabled:M,children:h.cancel}),e.jsx(Fs,{onClick:je,variant:"primary",loading:M,className:"flex-1",children:h.confirmChange})]})]})]})})}const va=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "},inverse:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"},inverse:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"},inverse:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function wo(t){const l=va.find(i=>i.value.en==="Not Known to");return l?l.value[t]:"Not Known to"}function cn(t){const l=va.find(i=>i.value.en==="Not Known to");return l?t===l.value.en||t===l.value.de||t===l.value.fr:!1}function So(t,l,i=[]){for(const f of va)if(f.value[l]===t)return f.inverse[l];for(const f of i){if(f.forward===t)return f.inverse;if(f.inverse===t)return f.forward}return t}const Co=1440*60*1e3;function Bs(t){const l=`avatar_regen_${t}`,i=localStorage.getItem(l),f=Date.now();if(!i)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:s,lastAttempt:k}=JSON.parse(i);if(f-k>Co)return localStorage.removeItem(l),{canRegenerate:!0,waitSeconds:0,attempts:0};let h=0;s>=2&&s<4?h=30*1e3:s>=4&&s<6?h=60*1e3:s>=6&&s<8?h=120*1e3:s>=8&&s<10?h=300*1e3:s>=10&&(h=600*1e3);const A=f-k;return A>=h?{canRegenerate:!0,waitSeconds:0,attempts:s}:{canRegenerate:!1,waitSeconds:Math.ceil((h-A)/1e3),attempts:s}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function jn(t){const l=`avatar_regen_${t}`,i=localStorage.getItem(l),f=Date.now();let s=1;if(i)try{s=(JSON.parse(i).attempts||0)+1}catch{}localStorage.setItem(l,JSON.stringify({attempts:s,lastAttempt:f}))}function rl(t){const[l,i]=d.useState(()=>Bs(t));d.useEffect(()=>{if(l.waitSeconds>0){const s=setInterval(()=>{i(Bs(t))},1e3);return()=>clearInterval(s)}},[l.waitSeconds,t]);const f=d.useCallback(()=>{jn(t),i(Bs(t))},[t]);return{...l,recordRegeneration:f}}const mn={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte wÃ¤hlen Sie aus, welches Gesicht zu dem Charakter gehÃ¶rt, den Sie erstellen mÃ¶chten.",selectFace:"Gesicht auswÃ¤hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages dÃ©tectÃ©s",description:"Nous avons dÃ©tectÃ© plusieurs personnes sur votre photo. Veuillez sÃ©lectionner le visage du personnage que vous souhaitez crÃ©er.",selectFace:"SÃ©lectionner le visage",uploadDifferent:"TÃ©lÃ©charger une autre photo",confidence:"Confiance"}};function ko({isOpen:t,faces:l,onSelect:i,onUploadNew:f,developerMode:s=!1}){const{language:k}=Lt(),h=mn[k]||mn.en;return e.jsx(Bi,{isOpen:t,onClose:f,title:h.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-600 text-center",children:h.description}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:l.map((A,o)=>e.jsxs("button",{onClick:()=>i(A.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:e.jsx("img",{draggable:!1,src:A.thumbnail,alt:`Face ${o+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[h.selectFace," ",o+1]})}),s&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[h.confidence,": ",Math.round(A.confidence*100),"%"]})]},A.id))}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("button",{onClick:f,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[e.jsx(Zi,{size:20}),h.uploadDifferent]})})]})})}const sl=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et quÃªtes hÃ©roÃ¯ques"},emoji:"ðŸ—¡ï¸"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"CompÃ©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei alltÃ¤glichen Herausforderungen",fr:"Aide pour surmonter les dÃ©fis quotidiens"},emoji:"ðŸ’ª"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"ðŸ“š"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais Ã©vÃ©nements historiques"},emoji:"ðŸ›ï¸"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"DÃ©cris ta propre idÃ©e d'histoire"},emoji:"âœ¨"}],Ao=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],al=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"Ã‰poques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"HÃ©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"PersonnalisÃ©"}}],pa=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"ðŸ´â€â˜ ï¸",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"âš”ï¸",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ðŸ¤ ",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ðŸ¥·",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"âš“",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"ðŸ›ï¸",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes Ã„gypten",fr:"Ã‰gypte Ancienne"},emoji:"ðŸº",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"GrÃ¨ce Antique"},emoji:"ðŸº",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"Ã‚ge de Pierre"},emoji:"ðŸ¦´",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure SamouraÃ¯"},emoji:"ðŸŽŒ",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & SorciÃ¨re"},emoji:"ðŸ§™",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"QuÃªte du Dragon"},emoji:"ðŸ‰",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ðŸ¦„",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de SirÃ¨ne"},emoji:"ðŸ§œâ€â™€ï¸",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ðŸ¦–",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-hÃ©ros"},emoji:"ðŸ¦¸",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"ðŸš€",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des OcÃ©ans"},emoji:"ðŸŒŠ",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"ðŸŒ´",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie Ã  la Ferme"},emoji:"ðŸ„",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la ForÃªt"},emoji:"ðŸ¦Š",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"ðŸš’",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"ðŸ‘¨â€âš•ï¸",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"ðŸ‘®",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"MystÃ¨re DÃ©tective"},emoji:"ðŸ”",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de NoÃ«l"},emoji:"ðŸŽ„",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"ðŸŽ†",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de PÃ¢ques"},emoji:"ðŸ°",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"ðŸŽƒ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},emoji:"âœ¨",group:"custom"}],nl={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"ðŸ "},un=[{id:"potty-training",name:{en:"Potty Training",de:"TÃ¶pfchen-Training",fr:"Apprentissage du pot"},emoji:"ðŸš½",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"HÃ¤nde waschen",fr:"Se laver les mains"},emoji:"ðŸ§¼",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"ZÃ¤hne putzen",fr:"Se brosser les dents"},emoji:"ðŸª¥",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"GemÃ¼se essen",fr:"Manger des lÃ©gumes"},emoji:"ðŸ¥¦",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"ðŸ›ï¸",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"ðŸ‘‹",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de tÃ©tine"},emoji:"ðŸ¼",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"AufrÃ¤umen",fr:"Ranger les jouets"},emoji:"ðŸ§¹",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ðŸª‘",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre Ã  partager"},emoji:"ðŸ¤",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten kÃ¶nnen",fr:"Attendre son tour"},emoji:"â³",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"ðŸŽ’",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"ðŸ‘«",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"ÃŠtre courageux"},emoji:"ðŸ’ª",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau bÃ©bÃ© dans la famille"},emoji:"ðŸ‘¶",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'Ã©cole"},emoji:"ðŸ«",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"ðŸ“",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre Ã  lire"},emoji:"ðŸ“–",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren kÃ¶nnen",fr:"Savoir perdre"},emoji:"ðŸŽ¯",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"ÃŠtre diffÃ©rent c'est bien"},emoji:"ðŸŒˆ",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit HÃ¤nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"ðŸ›¡ï¸",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la vÃ©ritÃ©"},emoji:"âœ…",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"ðŸŒŸ",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"DÃ©mÃ©nagement"},emoji:"ðŸ ",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"âœˆï¸",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents sÃ©parÃ©s"},emoji:"ðŸ’”",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le mÃ©decin"},emoji:"ðŸ¥",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"SÃ©jour Ã  l'hÃ´pital"},emoji:"ðŸ©º",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"ðŸŒˆ",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"â¤ï¸",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"Ã‰conomiser de l'argent"},emoji:"ðŸ’°",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"DÃ©penser intelligemment"},emoji:"ðŸ›’",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"Ã‰quilibre du temps d'Ã©cran"},emoji:"ðŸ“±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"ðŸ‘¥",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"KÃ¶rperliche VerÃ¤nderungen",fr:"Changements corporels"},emoji:"ðŸŒ±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung Ã¼bernehmen",fr:"Prendre ses responsabilitÃ©s"},emoji:"ðŸŽ¯",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"â°",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"SÃ©curitÃ© en ligne"},emoji:"ðŸ”’",ageGroup:"preteen"}],Po=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],il=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-VerÃ¤nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"PrÃ©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"Ã‰cole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"VorpubertÃ¤t (9-12)",fr:"PrÃ©adolescent (9-12)"},ageRange:"9-12"}],gn=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"ðŸ”¤",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"ðŸ…°ï¸",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"ReimwÃ¶rter",fr:"Mots qui riment"},emoji:"ðŸŽµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"ðŸ”¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"ðŸ”¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"ZÃ¤hlen lernen",fr:"Apprendre Ã  compter"},emoji:"âœ‹",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"ðŸ”·",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"âž•",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"ðŸŒˆ",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"MÃ©langer les couleurs"},emoji:"ðŸŽ¨",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"PlanÃ¨tes & Espace"},emoji:"ðŸª",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"ðŸ‚",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"MÃ©tÃ©o"},emoji:"â›…",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"ðŸ’§",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"ðŸŒ±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"ðŸŒ™",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"ðŸ·",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ðŸ¦",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"ðŸ‹",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & KÃ¤fer",fr:"Insectes"},emoji:"ðŸ›",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ðŸ¦•",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"KÃ¶rperteile",fr:"Parties du corps"},emoji:"ðŸ«€",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die fÃ¼nf Sinne",fr:"Les cinq sens"},emoji:"ðŸ‘ï¸",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ðŸ¥—",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"ðŸ“…",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'annÃ©e"},emoji:"ðŸ—“ï¸",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"ðŸ•",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"ðŸŒ",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"LÃ¤nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"ðŸ³ï¸",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"ðŸŽ¸",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"BerÃ¼hmte KÃ¼nstler",fr:"Artistes cÃ©lÃ¨bres"},emoji:"ðŸ–¼ï¸",group:"arts"}],To=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],ol=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"KÃ¶rper & Gesundheit",fr:"Corps & SantÃ©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & GÃ©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],$o=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],ll=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"â­"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"ðŸ‡¨ðŸ‡­"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & DÃ©couverte"},icon:"ðŸ§­"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & MÃ©decine"},icon:"ðŸ”¬"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"ðŸ’¡"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & LibertÃ©"},icon:"âœŠ"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"ðŸ—ï¸"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"ðŸŽ­"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"ArchÃ¤ologische Entdeckungen",fr:"DÃ©couvertes ArchÃ©ologiques"},icon:"ðŸº"}],hn=[{id:"swiss-founding",name:{en:"Founding of Switzerland (RÃ¼tlischwur)",de:"GrÃ¼ndung der Schweiz (RÃ¼tlischwur)",fr:"Fondation de la Suisse (Serment du GrÃ¼tli)"},shortName:{en:"RÃ¼tlischwur",de:"RÃ¼tlischwur",fr:"Serment du GrÃ¼tli"},emoji:"ðŸ¤",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"ðŸ¹",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"âš”ï¸",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"ðŸ›¡ï¸",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"RÃ©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"RÃ©forme"},emoji:"ðŸ“œ",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant grÃ¼ndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"â¤ï¸",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"GÃ©nÃ©ral Dufour et l'unitÃ© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"GÃ©nÃ©ral Dufour"},emoji:"ðŸŽ–ï¸",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"ðŸ”ï¸",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution fÃ©dÃ©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"ðŸ“‹",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"ðŸš‚",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer NeutralitÃ¤t im 1. Weltkrieg",fr:"NeutralitÃ© suisse pendant la PremiÃ¨re Guerre"},shortName:{en:"WWI Neutrality",de:"NeutralitÃ¤t 1. WK",fr:"NeutralitÃ© 1GM"},emoji:"ðŸ•Šï¸",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the RÃ¼tli Report",de:"General Guisan und der RÃ¼tlirapport",fr:"GÃ©nÃ©ral Guisan et le Rapport du GrÃ¼tli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"GÃ©nÃ©ral Guisan"},emoji:"ðŸŽ–ï¸",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2Ã¨me GM"},emoji:"ðŸ”ï¸",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"ðŸŒ™",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les AmÃ©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"DÃ©couverte de l'AmÃ©rique"},emoji:"â›µ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motorisÃ©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"âœˆï¸",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"PremiÃ¨re traversÃ©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"ðŸ›©ï¸",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"ðŸ”ï¸",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am SÃ¼dpol",fr:"Premier au PÃ´le Sud"},shortName:{en:"South Pole",de:"SÃ¼dpol",fr:"PÃ´le Sud"},emoji:"â„ï¸",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"ðŸŒ",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"PlongÃ©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"PlongÃ©e profonde"},emoji:"ðŸŒŠ",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"ExpÃ©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"ElektrizitÃ¤t entdeckt",fr:"DÃ©couverte Ã©lectricitÃ©"},emoji:"âš¡",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"DÃ©couverte de la pÃ©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"PÃ©nicilline"},emoji:"ðŸ’Š",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"ðŸ’‰",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN dÃ©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"DÃ©couverte ADN"},emoji:"ðŸ§¬",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nommÃ©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"DÃ©couverte dinosaure"},emoji:"ðŸ¦•",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins RelativitÃ¤tstheorie",fr:"RelativitÃ© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"ThÃ©orie d'Einstein"},emoji:"ðŸ§ ",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits GalÃ¡pagos",de:"Darwin auf GalÃ¡pagos",fr:"Darwin aux GalÃ¡pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"ðŸ¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"PremiÃ¨re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"â¤ï¸",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschlÃ¼sselt",fr:"GÃ©nome humain dÃ©codÃ©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet GÃ©nome"},emoji:"ðŸ§ª",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement tÃ©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"TÃ©lescope Hubble"},emoji:"ðŸ”­",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel tÃ©lÃ©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"TÃ©lÃ©phone"},emoji:"ðŸ“ž",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons GlÃ¼hbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"GlÃ¼hbirne",fr:"Ampoule"},emoji:"ðŸ’¡",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"ðŸ“–",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"ðŸŒ",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"â›“ï¸",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"ðŸšŒ",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"ðŸ§±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela libÃ©rÃ©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"âœŠ",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"ðŸ”º",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm erÃ¶ffnet",fr:"Tour Eiffel inaugurÃ©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"ðŸ—¼",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal erÃ¶ffnet",fr:"Canal de Panama inaugurÃ©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"ðŸš¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"ðŸŒ‰",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel erÃ¶ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"ðŸš‡",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"ðŸ…",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland erÃ¶ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"ðŸ°",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cinÃ©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"ðŸŽ¬",year:1895,category:"culture",mainPerson:"LumiÃ¨re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ðŸ¦",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"MusÃ©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"MusÃ©e Histoire Naturelle"},emoji:"ðŸ›ï¸",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de ToutÃ¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"ToutÃ¢nkhamon"},emoji:"ðŸ‘‘",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"RedÃ©couverte de PompÃ©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"PompÃ©i"},emoji:"ðŸŒ‹",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"ArmÃ©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"ArmÃ©e terre cuite"},emoji:"ðŸ—¿",year:1974,category:"archaeology"}];function dl(t){return t==="popular"?pa.filter(l=>Ao.includes(l.id)):pa.filter(l=>l.group===t)}function cl(t){return t==="popular"?un.filter(l=>Po.includes(l.id)):un.filter(l=>l.ageGroup===t)}function ml(t){return t==="popular"?gn.filter(l=>To.includes(l.id)):gn.filter(l=>l.group===t)}function ul(t){return t==="popular"?hn.filter(l=>$o.includes(l.id)):hn.filter(l=>l.category===t)}const Io={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},lr={enableAutoRepair:!1,enableFinalChecks:!0,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null};function Do(){const t=localStorage.getItem("developer_mode")==="true",[l,i]=d.useState(t),[f,s]=d.useState(null),[k,h]=d.useState("auto"),[A,o]=d.useState(!1),[M,D]=d.useState(!1),[C,E]=d.useState(!1),[v,p]=d.useState(!1),[b,G]=d.useState(t),[O,_]=d.useState(lr.enableAutoRepair),[ee,se]=d.useState(lr.enableFinalChecks),[z,ne]=d.useState(lr.incrementalConsistency),[Z,J]=d.useState(lr.incrementalConsistencyDryRun),[$,re]=d.useState(lr.lookbackCount),[xe,be]=d.useState(lr.checkOnlyMode),[je,oe]=d.useState(lr.useGridRepair),[we,Ee]=d.useState(lr.forceRepairThreshold),[Re,Y]=d.useState(!1),[Ve,Se]=d.useState({...Io}),qe=me=>{i(me),G(!!me)};return d.useEffect(()=>{l?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[l]),{developerMode:l,setDeveloperMode:qe,imageGenMode:f,setImageGenMode:s,generationMode:k,setGenerationMode:h,devSkipOutline:A,setDevSkipOutline:o,devSkipText:M,setDevSkipText:D,devSkipSceneDescriptions:C,setDevSkipSceneDescriptions:E,devSkipImages:v,setDevSkipImages:p,devSkipCovers:b,setDevSkipCovers:G,enableAutoRepair:O,setEnableAutoRepair:_,enableFinalChecks:ee,setEnableFinalChecks:se,incrementalConsistency:z,setIncrementalConsistency:ne,incrementalConsistencyDryRun:Z,setIncrementalConsistencyDryRun:J,lookbackCount:$,setLookbackCount:re,checkOnlyMode:xe,setCheckOnlyMode:be,useGridRepair:je,setUseGridRepair:oe,forceRepairThreshold:we,setForceRepairThreshold:Ee,loadAllAvatars:Re,setLoadAllAvatars:Y,modelSelections:Ve,setModelSelections:Se}}const Eo=d.lazy(()=>cs(()=>import("./WizardStep2Characters-DnjRBTBh.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])).then(t=>({default:t.WizardStep2Characters}))),zo=d.lazy(()=>cs(()=>Promise.resolve().then(()=>jo),void 0).then(t=>({default:t.WizardStep3BookSettings}))),Fo=d.lazy(()=>cs(()=>import("./WizardStep4StoryType-CdMd0XZq.js"),__vite__mapDeps([24,1,2,3,4,7,17,12,13,5,6,8,18,19,14,20,21,9,22,23,15])).then(t=>({default:t.WizardStep4StoryType}))),Ro=d.lazy(()=>cs(()=>import("./WizardStep5ArtStyle-Bxu3io_W.js"),__vite__mapDeps([25,1,2,3,4,26,20])).then(t=>({default:t.WizardStep5ArtStyle}))),Bo=d.lazy(()=>cs(()=>import("./WizardStep6Summary-DJ1RXrzz.js"),__vite__mapDeps([27,1,2,3,4,26,17,9,7,5,6,8,18,19,12,13,14,20,21,22,23,15])).then(t=>({default:t.WizardStep6Summary}))),u=fa("StoryWizard"),xn={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"FÃ¼ge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die BuchlÃ¤nge und das Leseniveau fÃ¼r dein Publikum fest",3:"WÃ¤hle einen Geschichtstyp und ein Thema",4:"WÃ¤hle einen Illustrationsstil fÃ¼r dein Buch",5:"ÃœberprÃ¼fe deine Auswahl, fÃ¼ge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils apparaÃ®tront de maniÃ¨re cohÃ©rente dans toute votre histoire!",2:"DÃ©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un thÃ¨me",4:"Choisissez un style d'illustration pour votre livre",5:"VÃ©rifiez vos choix, ajoutez des dÃ©tails de l'intrigue, puis gÃ©nÃ©rez votre histoire!"}};function Mo(){const t=Ti(),[l,i]=$i(),{t:f,language:s}=Lt(),{isAuthenticated:k,user:h,updateCredits:A,refreshUser:o,isLoading:M,isImpersonating:D}=ba(),{showSuccess:C,showInfo:E,showError:v}=Ai(),{startTracking:p,stopTracking:b,activeJob:G,isComplete:O,completedStoryId:_,markCompletionViewed:ee,hasUnviewedCompletion:se}=Pi(),[z,ne]=d.useState(()=>{const n=new URLSearchParams(window.location.search);if(n.get("storyId"))return 6;if(n.get("new")==="true")return 1;const g=localStorage.getItem("wizard_step");return g?parseInt(g,10):1}),[Z,J]=d.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[$,re]=d.useState(null),{developerMode:xe,setDeveloperMode:be,imageGenMode:je,setImageGenMode:oe,generationMode:we,setGenerationMode:Ee,devSkipOutline:Re,setDevSkipOutline:Y,devSkipText:Ve,setDevSkipText:Se,devSkipSceneDescriptions:qe,setDevSkipSceneDescriptions:me,devSkipImages:ue,setDevSkipImages:W,devSkipCovers:ke,setDevSkipCovers:et,enableAutoRepair:He,setEnableAutoRepair:gt,useGridRepair:bt,setUseGridRepair:Kt,forceRepairThreshold:yt,setForceRepairThreshold:Ms,enableFinalChecks:Or,setEnableFinalChecks:ms,incrementalConsistency:dr,setIncrementalConsistency:a,incrementalConsistencyDryRun:Ce,setIncrementalConsistencyDryRun:tt,lookbackCount:ge,setLookbackCount:Hr,checkOnlyMode:lt,setCheckOnlyMode:Ot,loadAllAvatars:vt,setLoadAllAvatars:cr,modelSelections:rt,setModelSelections:jr}=Do(),[dt,Jt]=d.useState(()=>localStorage.getItem("story_type")||""),[Ne,Qt]=d.useState(()=>localStorage.getItem("story_category")||""),[ze,Zt]=d.useState(()=>localStorage.getItem("story_topic")||""),[Be,Nr]=d.useState(()=>localStorage.getItem("story_theme")||""),[ct,Yt]=d.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[_e,kt]=d.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[he,pe]=d.useState([]),[_r,Pe]=d.useState(null),[j,ye]=d.useState(null),Wr=d.useRef([]),wr=d.useRef(null),[mt,zt]=d.useState(!1),[Sr,Ue]=d.useState("photo"),[Cr,mr]=d.useState(!1),[Vr,At]=d.useState(null),[us,qr]=d.useState(!1),[Xt,kr]=d.useState(!1),[Gs,gs]=d.useState(void 0),[hs,xs]=d.useState(void 0),Ur=d.useRef(null),[Ls,er]=d.useState(!1),[ur,tr]=d.useState([]),[Kr,ps]=d.useState(null),[Ft,Rt]=d.useState(null),[Ye,Jr]=d.useState({}),[jt,Qr]=d.useState({}),[ht,Ar]=d.useState([]),rr=d.useRef(null),Pr=d.useRef(!1),Pt=d.useRef(!1),[Ht,Zr]=d.useState(!1),[Tt,$t]=d.useState([]),[st,sr]=d.useState([]),r=d.useRef(!1),[y,N]=d.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[F,m]=d.useState(()=>{try{const n=localStorage.getItem("story_language");if(n){if(n==="de")return"de-ch";if(n==="fr")return"fr-ch";if(n==="it")return"it-ch";if(n==="en")return"en-gb";if(n.startsWith("de")||n.startsWith("fr")||n.startsWith("it")||n.startsWith("en")||n.startsWith("gsw"))return n}return"de-ch"}catch{return"de-ch"}}),[Q,le]=d.useState(()=>{try{const n=localStorage.getItem("story_pages");return n?parseInt(n):30}catch{return 30}}),[Ke,Nt]=d.useState(()=>localStorage.getItem("story_dedication")||""),[it,wt]=d.useState(()=>localStorage.getItem("story_details")||""),[xt,de]=d.useState(!1),[ot,_t]=d.useState(!1),[gr,Wt]=d.useState(!1),[Nn,Os]=d.useState(0),[wn,Hs]=d.useState(0),[fs,_s]=d.useState(null),[ja,Ws]=d.useState(""),[ar,Tr]=d.useState([]),[Sn,Na]=d.useState(null),[wa,Cn]=d.useState(null),hr=d.useRef(null),[xr,Sa]=d.useState(null),[pr,kn]=d.useState(()=>vn()),[nr,$r]=d.useState(!1),[An,Ca]=d.useState(new Set),[Pn,ka]=d.useState(!1),[Tn,bs]=d.useState(!1),[$n,Vs]=d.useState(!1),[In,qs]=d.useState(!1),[Dn,Aa]=d.useState(!1),[En,ys]=d.useState(!1),[Us,fr]=d.useState({current:0,total:0,message:""}),[Bt,Yr]=d.useState(null),[zn,Ir]=d.useState(!1),[Ks,ir]=d.useState(""),[Dr,Xr]=d.useState(""),[Fn,Pa]=d.useState(""),[Rn,Ta]=d.useState(""),[Bn,$a]=d.useState(""),[Mn,Ia]=d.useState(),[Gn,Da]=d.useState(),[Ln,Ea]=d.useState([]),[On,Er]=d.useState(null),[Hn,vs]=d.useState(null),[_n,Js]=d.useState([]),[Wn,Qs]=d.useState([]),[Vn,Zs]=d.useState([]),[qn,za]=d.useState(null),[Un,es]=d.useState([]),[Ys,It]=d.useState([]),[ts,Mt]=d.useState({frontCover:null,initialPage:null,backCover:null}),[ve,Xs]=d.useState(null),[ea,js]=d.useState(null),[Kn,Fa]=d.useState(!1),[Jn,Ra]=d.useState(),[Qn,Ba]=d.useState(),[Zn,Ma]=d.useState(),[Yn,ta]=d.useState(null),ra=d.useRef(!1),zr=d.useRef(!1),[pt,Ns]=d.useState(null),[sa,ws]=d.useState({}),[Xn,Ss]=d.useState(!1),[Je,Cs]=d.useState(null),[rs,ss]=d.useState("");d.useEffect(()=>{Wr.current=he},[he]),d.useEffect(()=>{wr.current=j},[j]),d.useEffect(()=>{if(!M&&!k){if(!!localStorage.getItem("auth_token")){u.debug("Token found but not authenticated yet, waiting for state sync...");return}const g=window.location.pathname+window.location.search,c=encodeURIComponent(g);t(`/?login=true&redirect=${c}`)}},[k,M,t]);const aa=d.useCallback(n=>{var g,c,S,x,w,P,T,I;if(n){if((g=n.sceneImages)!=null&&g.length&&It(K=>K.map(H=>{const U=n.sceneImages.find(fe=>fe.pageNumber===H.pageNumber);return U?{...H,prompt:U.prompt??H.prompt,qualityReasoning:U.qualityReasoning??H.qualityReasoning,retryHistory:U.retryHistory??H.retryHistory,repairHistory:U.repairHistory??H.repairHistory,wasRegenerated:U.wasRegenerated??H.wasRegenerated,originalScore:U.originalScore??H.originalScore,originalReasoning:U.originalReasoning??H.originalReasoning,totalAttempts:U.totalAttempts??H.totalAttempts,faceEvaluation:U.faceEvaluation??H.faceEvaluation,referencePhotos:U.referencePhotos??H.referencePhotos,landmarkPhotos:U.landmarkPhotos??H.landmarkPhotos,consistencyRegen:U.consistencyRegen??H.consistencyRegen}:H})),n.coverImages&&Mt(K=>{var fe;const H={...K},U=["frontCover","initialPage","backCover"];for(const Le of U){const We=(fe=n.coverImages)==null?void 0:fe[Le],Fe=K[Le];We&&typeof Fe=="object"&&Fe!==null&&(H[Le]={...Fe,prompt:We.prompt??Fe.prompt,qualityReasoning:We.qualityReasoning??Fe.qualityReasoning,retryHistory:We.retryHistory??Fe.retryHistory,referencePhotos:We.referencePhotos??Fe.referencePhotos,landmarkPhotos:We.landmarkPhotos??Fe.landmarkPhotos})}return H}),console.log("[StoryWizard] Dev metadata generationLog:",((c=n.generationLog)==null?void 0:c.length)||0,"entries"),(S=n.generationLog)!=null&&S.length&&Zs(n.generationLog),(x=n.styledAvatarGeneration)!=null&&x.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",n.styledAvatarGeneration.length,"entries"),Js(n.styledAvatarGeneration)),(w=n.costumedAvatarGeneration)!=null&&w.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",n.costumedAvatarGeneration.length,"entries"),Qs(n.costumedAvatarGeneration)),n.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",n.finalChecksReport.totalIssues,"issues"),za(n.finalChecksReport)),(P=n.sceneDescriptions)!=null&&P.length){const K=n.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",K.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(K[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((T=K[0])!=null&&T.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((I=K[0])!=null&&I.scenePrompt)),es(n.sceneDescriptions)}n.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),Er(n.visualBible))}},[]);d.useEffect(()=>{Oe.getUserLocation().then(n=>{Sa(n),n!=null&&n.city&&Oe.triggerLandmarkDiscovery(n.city,n.country)})},[]),d.useEffect(()=>{k&&Oe.getStories({limit:1}).then(({pagination:n})=>{Aa(n.total>0)}).catch(()=>Aa(!1))},[k]);const na=d.useRef(null);d.useEffect(()=>{const n=l.get("storyId");l.get("new")!=="true"&&(n&&(na.current=null),G&&!n&&na.current!==G.jobId&&(u.info("Returning during active generation, restoring progress for job:",G.jobId),na.current=G.jobId,ne(6),$r(!0),ir(G.storyTitle),js(G.jobId),Oe.getJobStatus(G.jobId).then(c=>{var S,x;if(u.info("Restored job status:",{progress:c.progress,hasStoryText:!!c.storyText,storyTextKeys:c.storyText?Object.keys(c.storyText):[],pageTextsCount:(S=c.storyText)!=null&&S.pageTexts?Object.keys(c.storyText.pageTexts).length:0,partialPages:((x=c.partialPages)==null?void 0:x.length)||0}),c.progress&&fr(w=>c.progress.current>=w.current?c.progress:{...w,message:c.progress.message}),c.storyText){const w=c.storyText.pageTexts||{};u.info("Setting progressiveStoryData with",Object.keys(w).length,"pages"),Ns({title:c.storyText.title||G.storyTitle,dedication:c.storyText.dedication,pageTexts:w,sceneDescriptions:c.storyText.sceneDescriptions||[],totalPages:c.storyText.totalPages||Q})}else u.warn("No storyText in job status response");if(c.partialPages&&c.partialPages.length>0){const w={};c.partialPages.forEach(P=>{P.pageNumber&&P.imageData&&(w[P.pageNumber]=P.imageData)}),u.info("Restored",Object.keys(w).length,"page images"),ws(w)}c.partialCovers&&Mt(w=>{var P,T,I;return{frontCover:((P=c.partialCovers)==null?void 0:P.frontCover)||w.frontCover,initialPage:((T=c.partialCovers)==null?void 0:T.initialPage)||w.initialPage,backCover:((I=c.partialCovers)==null?void 0:I.backCover)||w.backCover}})}).catch(c=>{u.error("Failed to restore job status:",c)})),u.debug("Auto-nav check:",{generationComplete:O,completedStoryId:_,urlStoryId:n,hasActiveJob:!!G}),O&&_&&!n&&(u.info("Generation completed, navigating to story:",_),i({storyId:_},{replace:!0})))},[G,O,_,l,i,Q]),d.useEffect(()=>{if(l.get("new")==="true"){u.info("New story requested - resetting all story settings"),Jt(""),Qt(""),Zt(""),Nr(""),Yt(""),kt("watercolor"),N("standard"),le(30),Nt(""),wt(""),Pe(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const g=new URLSearchParams(l);g.delete("new"),i(g,{replace:!0}),ye(null),Ue("photo"),ne(1)}},[l,i]),d.useEffect(()=>{const n=l.get("storyId");n&&z!==6&&ne(6),(async()=>{if(!(!n||!k)){if(ra.current){ra.current=!1,u.info("Skipping story reload - just finished generating");return}u.info("Loading saved story progressively:",n),J(!0),re(null),Yr(null);try{await Oe.getStoryProgressively(n,(c,S)=>{var x,w,P;u.info("Metadata loaded:",c.title,`(${S} images to load)`),Xs(c.id),ir(c.title||""),Jt(c.storyType||""),kt(c.artStyle||"pixar"),Ta(c.outline||""),$a(c.outlinePrompt||""),Ia(c.outlineModelId),Da(c.outlineUsage),Ea(c.storyTextPrompts||[]),Js(c.styledAvatarGeneration||[]),Qs(c.costumedAvatarGeneration||[]),(x=c.generationLog)!=null&&x.length&&(console.log("[StoryWizard] Loading story metadata, generationLog:",c.generationLog.length,"entries"),Zs(c.generationLog)),c.visualBible?Er({mainCharacters:c.visualBible.mainCharacters||[],secondaryCharacters:c.visualBible.secondaryCharacters||[],animals:c.visualBible.animals||[],artifacts:c.visualBible.artifacts||[],locations:c.visualBible.locations||[],vehicles:c.visualBible.vehicles||[],clothing:c.visualBible.clothing||[],changeLog:c.visualBible.changeLog||[]}):Er(null),c.clothingRequirements?vs(c.clothingRequirements):vs(null),It(c.sceneImages||[]),es(c.sceneDescriptions||[]),Mt(c.coverImages||{frontCover:null,initialPage:null,backCover:null}),N(c.languageLevel||"standard"),c.language&&m(c.language),$r(!1),Fa(c.isPartial||!1),Ra(c.failureReason),Ba(c.generatedPages),Ma(c.totalPages),Xr(c.story||""),Pa(c.originalStory||c.story||""),ta({storyCategory:c.storyCategory,storyTopic:c.storyTopic,storyTheme:c.storyTheme,storyTypeName:c.storyTypeName,storyDetails:c.storyDetails,artStyle:c.artStyle,language:c.language,languageLevel:c.languageLevel,pages:c.pages,dedication:c.dedication,characters:(w=c.characters)==null?void 0:w.map(T=>{var I;return{id:T.id,name:T.name,isMain:(I=c.mainCharacters)==null?void 0:I.includes(T.id)}}),mainCharacters:c.mainCharacters,relationships:c.relationships,relationshipTexts:c.relationshipTexts,season:c.season,userLocation:c.userLocation}),(P=c.characters)!=null&&P.length&&Pe(c.characters.map(T=>{var I,K;return{id:T.id,name:T.name,photoData:T.photoData||((I=T.photos)==null?void 0:I.face)||((K=T.photos)==null?void 0:K.original)}})),ne(6),J(!1),re(null),S>0&&Yr({loaded:0,total:S}),zr.current=!0,Oe.getStoryDevMetadata(n).then(T=>{aa(T),u.debug("Dev metadata merged into story")}).catch(T=>{u.warn("Failed to load dev metadata:",T),zr.current=!1})},(c,S,x,w)=>{if(typeof c=="number")It(P=>P.map(T=>T.pageNumber===c?{...T,imageData:S,imageVersions:x}:T));else{const P=c;Mt(T=>{const I=T[P];return typeof I=="object"&&I!==null?{...T,[P]:{...I,imageData:S}}:{...T,[P]:S}})}w!==void 0&&Yr(P=>P?{...P,loaded:w}:null)},()=>{u.info("All images loaded"),Yr(null)})}catch(c){u.error("Failed to load story:",c),J(!1),re(null),Yr(null)}}})()},[l,k]),d.useEffect(()=>{z===6&&se&&(u.info("Clearing unviewed completion - user is viewing story"),ee())},[z,se,ee]),d.useEffect(()=>{(async()=>{const g=l.get("payment"),c=l.get("session_id");if(g==="success"&&c){u.info("Payment successful! Checking order status..."),u.info("Session ID:",c);try{const w=await Oe.getOrderStatus(c);if(u.info("Order Status:",w),w.order){const P=`CHF ${(w.order.amount_total/100).toFixed(2)}`,T={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement rÃ©ussi!"},I={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a Ã©tÃ© reÃ§ue et sera bientÃ´t imprimÃ©e."},K=[`${s==="de"?"Kunde":s==="fr"?"Client":"Customer"}: ${w.order.customer_name}`,`Email: ${w.order.customer_email}`,`${s==="de"?"Betrag":s==="fr"?"Montant":"Amount"}: ${P}`,`${s==="de"?"Versand an":s==="fr"?"ExpÃ©diÃ© Ã ":"Shipping to"}: ${w.order.shipping_name}`,`${w.order.shipping_address_line1}`,`${w.order.shipping_postal_code} ${w.order.shipping_city}`,`${w.order.shipping_country}`];C(I[s]||I.en,T[s]||T.en,K)}}catch(w){u.error("Error checking order status:",w)}const x=new URLSearchParams(l);x.delete("payment"),x.delete("session_id"),i(x,{replace:!0})}else if(g==="cancelled"){u.info("Payment cancelled by user");const x={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie kÃ¶nnen es erneut versuchen.",fr:"Paiement annulÃ©. Vous pouvez rÃ©essayer quand vous Ãªtes prÃªt."};E(x[s]||x.en,s==="de"?"Abgebrochen":s==="fr"?"AnnulÃ©":"Cancelled");const w=new URLSearchParams(l);w.delete("payment"),i(w,{replace:!0})}const S=l.get("credits_payment");if(S==="success"){u.info("Credits payment successful!"),await o();const x={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},w={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};C(w[s]||w.en,x[s]||x.en);const P=new URLSearchParams(l);P.delete("credits_payment"),P.delete("session_id"),i(P,{replace:!0})}else if(S==="cancelled"){u.info("Credits payment cancelled by user");const x={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};E(x[s]||x.en,s==="de"?"Abgebrochen":s==="fr"?"Annule":"Cancelled");const w=new URLSearchParams(l);w.delete("credits_payment"),i(w,{replace:!0})}})()},[l,i,s,C,E,o]);const ks=d.useRef(!1);d.useEffect(()=>{if(l.get("autoGenerate")==="true"&&!ks.current){ks.current=!0;const g=localStorage.getItem("pending_story_type"),c=localStorage.getItem("pending_art_style");g&&(Jt(g),localStorage.removeItem("pending_story_type")),c&&(kt(c),localStorage.removeItem("pending_art_style")),ne(6);const S=new URLSearchParams(l);S.delete("autoGenerate"),i(S,{replace:!0})}},[l,i]);const ia=n=>{if(n.length===0)return;const g=n.filter(c=>{const S=parseInt(c.age);return S>=1&&S<=10});if(g.length>0){const c=g.map(S=>S.id);$t(c),u.info(`Auto-selected ${g.length} main character(s) aged 1-10`)}else{const c=n.reduce((S,x)=>{const w=parseInt(x.age)||999,P=parseInt(S.age)||999;return w<P?x:S});$t([c.id]),u.info(`Auto-selected youngest character as main: ${c.name} (age ${c.age})`)}};d.useEffect(()=>{k?(async()=>{try{J(!0);const g=await Ie.getCharacterData(vt);if(u.info("Loaded character data from API:",{characters:g.characters.length,relationships:Object.keys(g.relationships).length}),pe(g.characters),Object.keys(g.relationships).length>0&&(Jr(g.relationships),Pr.current=!0),Object.keys(g.relationshipTexts).length>0&&Qr(g.relationshipTexts),g.customRelationships.length>0&&Ar(g.customRelationships),g.characters.some(S=>S.storyRole)){const S=[],x=[];for(const w of g.characters)w.storyRole==="main"?S.push(w.id):w.storyRole==="out"&&x.push(w.id);$t(S),sr(x),u.info(`Loaded character roles from database: ${S.length} main, ${x.length} excluded`)}else g.characters.length>0&&ia(g.characters)}catch(g){u.error("Failed to load character data:",g)}finally{J(!1),Zr(!0)}})():M||Zr(!0)},[k,M]),d.useEffect(()=>{xe&&ve&&!zr.current&&(zr.current=!0,u.info("Developer mode enabled, fetching dev metadata for story:",ve),Oe.getStoryDevMetadata(ve).then(n=>{aa(n),u.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(n=>{u.warn("Failed to load dev metadata on toggle:",n),zr.current=!1})),(!xe||!ve)&&(zr.current=!1)},[xe,ve,aa]),d.useEffect(()=>{vt&&k&&Ht&&(async()=>{try{u.info("Reloading characters with full avatars (dev mode)");const g=await Ie.getCharacterData(!0);pe(g.characters),u.info(`Loaded ${g.characters.length} characters with full avatars`)}catch(g){u.error("Failed to reload with full avatars:",g)}})()},[vt,k,Ht]),d.useEffect(()=>{z===1&&he.length===0&&!j&&!Z&&Ht&&la()},[z,he.length,j,Z,Ht]);const oa=d.useRef(st);d.useEffect(()=>{oa.current!==st&&JSON.stringify(oa.current)!==JSON.stringify(st)&&(Tr([]),wt(""),oa.current=st)},[st]),d.useEffect(()=>{localStorage.setItem("story_language_level",y)},[y]),d.useEffect(()=>{localStorage.setItem("story_language",F)},[F]),d.useEffect(()=>{localStorage.setItem("story_pages",Q.toString())},[Q]),d.useEffect(()=>{localStorage.setItem("story_dedication",Ke)},[Ke]),d.useEffect(()=>{localStorage.setItem("story_details",it)},[it]),d.useEffect(()=>{localStorage.setItem("story_type",dt)},[dt]),d.useEffect(()=>{Ne?localStorage.setItem("story_category",Ne):localStorage.removeItem("story_category")},[Ne]),d.useEffect(()=>{ze?localStorage.setItem("story_topic",ze):localStorage.removeItem("story_topic")},[ze]),d.useEffect(()=>{Be?localStorage.setItem("story_theme",Be):localStorage.removeItem("story_theme")},[Be]),d.useEffect(()=>{ct?localStorage.setItem("story_custom_theme_text",ct):localStorage.removeItem("story_custom_theme_text")},[ct]);const Ga=d.useRef(Ne),La=d.useRef(ze),Oa=d.useRef(Be),Ha=d.useRef(!0);d.useEffect(()=>{if(Ha.current){Ha.current=!1;return}const n=Ga.current!==Ne,g=La.current!==ze,c=Oa.current!==Be;(n||g||c)&&(wt(""),localStorage.removeItem("story_details"),Tr([])),Ga.current=Ne,La.current=ze,Oa.current=Be},[Ne,ze,Be]),d.useEffect(()=>{localStorage.setItem("story_art_style",_e)},[_e]);const as=d.useRef(!1);d.useEffect(()=>{if(z===4&&!as.current&&!xt&&ar.length===0){const n=!!Ne,g=!!Be||!!ze,c=he.length>0;n&&g&&c&&(as.current=!0,u.info("[StoryWizard] Pre-generating story ideas while user selects art style"),Va())}as.current&&ar.length===0&&(as.current=!1)},[z,Ne,Be,ze,he.length,xt,ar.length]);const _a=d.useRef({storyCategory:Ne,storyTheme:Be,storyTopic:ze});d.useEffect(()=>{const n=_a.current,g=n.storyCategory!==Ne||n.storyTheme!==Be||n.storyTopic!==ze;_a.current={storyCategory:Ne,storyTheme:Be,storyTopic:ze},g&&(xt||ar.length>0)&&(u.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),hr.current&&(hr.current.abort(),hr.current=null),de(!1),_t(!1),Wt(!1),Tr([]),_s(null),Ws(""),as.current=!1)},[Ne,Be,ze,xt,ar.length]),d.useEffect(()=>{if(!xt)return;const g=setTimeout(()=>{u.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),de(!1),_t(!1),Wt(!1),v(s==="de"?"ZeitÃ¼berschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":s==="fr"?"DÃ©lai d'attente de gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(g)},[xt,s]),d.useEffect(()=>{if(!ot&&!gr){Os(0),Hs(0);return}const n=35e3,g=80,c=100,S=Date.now(),x=setInterval(()=>{const w=Date.now()-S,P=Math.min(w/n,1),T=1-Math.pow(1-P,3),I=Math.round(T*g);ot&&Os(I),gr&&Hs(I),P>=1&&clearInterval(x)},c);return()=>clearInterval(x)},[ot,gr]),d.useEffect(()=>{z>=1&&z<=5&&localStorage.setItem("wizard_step",z.toString())},[z]);const ei=n=>{Qt(n)},ti=n=>{Nr(n),!(n==="custom"||n==="realistic"||n==="")&&(Ne==="adventure"||(Ne==="life-challenge"||Ne==="educational")&&ze!=="")&&Vt(4)},ri=n=>{Zt(n),Ne==="historical"&&n!==""&&Vt(4)},si=n=>{kt(n),Vt(5)};d.useEffect(()=>{if(z===2&&he.length>=2&&!Z){const n=he.map(g=>g.id).sort().join("-");if(!rr.current||rr.current!==n){const c=wo(s);u.debug("Initializing relationships for step 2",{charKey:n,existingCount:Object.keys(Ye).length}),Jr(S=>{const x={...S};let w=!1;return he.forEach((P,T)=>{he.forEach((I,K)=>{if(T!==K){const H=`${P.id}-${I.id}`;x[H]||(x[H]=c,w=!0,u.debug("Initializing missing relationship:",H))}})}),w?x:S}),rr.current=n}}},[z,he,s,Z]);const ai=()=>{if(he.length<2)return!0;for(let n=0;n<he.length;n++)for(let g=0;g<he.length;g++)if(n!==g){const c=`${he[n].id}-${he[g].id}`,S=Ye[c];if(!S||cn(S))return!1}return!0},ni=()=>{if(he.length<2)return null;let n=0,g=null;for(const c of he){let S=0;for(const x of he)if(c.id!==x.id){const w=`${c.id}-${x.id}`,P=Ye[w];(!P||cn(P))&&S++}S>n&&(n=S,g=c)}return g},la=()=>{ye({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),Ue("photo"),zt(!1)},ii=(n,g=1500)=>new Promise(c=>{const S=new Image;S.onload=()=>{const x=document.createElement("canvas");let{width:w,height:P}=S;(w>g||P>g)&&(w>P?(P=Math.round(P*g/w),w=g):(w=Math.round(w*g/P),P=g)),x.width=w,x.height=P;const T=x.getContext("2d");T==null||T.drawImage(S,0,0,w,P),c(x.toDataURL("image/jpeg",.85))},S.onerror=()=>c(n),S.src=n}),oi=async(n,g)=>{var x,w,P,T,I;if(u.info(`ðŸ“¸ handlePhotoSelect called: file=${n==null?void 0:n.name}, character=${j==null?void 0:j.name}, developerMode=${xe}`),j&&!xe){const K=!!((x=j.avatars)!=null&&x.winter||(w=j.avatars)!=null&&w.standard||(P=j.avatars)!=null&&P.summer||(T=j.avatars)!=null&&T.hasFullAvatars);if(u.info(`ðŸ“¸ hasAvatars=${K}`),K){const H=Bs(j.id);if(u.info(`ðŸ“¸ cooldown check: canRegenerate=${H.canRegenerate}, waitSeconds=${H.waitSeconds}`),!H.canRegenerate){const U=s==="de"?`Bitte warten Sie ${H.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${H.waitSeconds} seconds before uploading a new photo.`;v(U);return}jn(j.id)}}const c=g&&((I=j==null?void 0:j.clothing)!=null&&I.structured)?{...j.clothing.structured}:null,S=new FileReader;S.onload=async K=>{var U,fe,Le,We,Fe,te,Qe,X,L,R,V,B;const H=(U=K.target)==null?void 0:U.result;j&&(Ur.current={physical:j.physical,gender:j.gender,age:j.age}),gs(void 0),mr(!0),!(j!=null&&j.name)||j.name.trim().length<2?Ue("name"):(Ue("traits"),u.info("ðŸ“¸ Character has name, going to traits step to show avatar regeneration"));try{const ae=await ii(H),Te=Math.round(H.length/1024),q=Math.round(ae.length/1024);u.info(`Starting photo analysis... (${Te}KB -> ${q}KB)`);const Ae=j!=null&&j.id&&j.id>0?j.id:void 0,ce=await Ie.analyzePhoto(ae,s,void 0,void 0,Ae);if(ce.success){if(ce.multipleFacesDetected&&ce.faces&&ce.faces.length>1){u.info(`Multiple faces detected (${ce.faces.length}), showing selection modal`),ps(ae),Rt(c?{structured:c}:null),tr(ce.faces),er(!0),mr(!1);return}u.info("Photo analysis complete:",{hasPhotos:!!ce.photos,hasPhysical:!!ce.physical,hasClothing:!!ce.clothing,age:ce.age,gender:ce.gender}),ce._debug&&(xs(ce._debug),ce._debug.rawResponse,ce._debug.error&&console.warn("ðŸ“¸ [DEBUG] Gemini error:",ce._debug.error));const Me={original:((fe=ce.photos)==null?void 0:fe.face)||H,face:(Le=ce.photos)==null?void 0:Le.face,body:((We=ce.photos)==null?void 0:We.body)||H,bodyNoBg:(Fe=ce.photos)==null?void 0:Fe.bodyNoBg,faceBox:(te=ce.photos)==null?void 0:te.faceBox,bodyBox:(Qe=ce.photos)==null?void 0:Qe.bodyBox},Ze=(X=ce.photos)!=null&&X.bodyNoBg?Math.round(ce.photos.bodyNoBg.length/1024):0,at=(L=ce.photos)!=null&&L.body?Math.round(ce.photos.body.length/1024):0,As=(R=ce.photos)!=null&&R.face?Math.round(ce.photos.face.length/1024):0;if(u.info(`ðŸ“¸ [PHOTO CHANGE] Analysis returned: bodyNoBg=${Ze}KB, body=${at}KB, face=${As}KB`),(V=ce.photos)!=null&&V.bodyNoBg){const $e=ce.photos.bodyNoBg.substring(ce.photos.bodyNoBg.indexOf("base64,")+7,ce.photos.bodyNoBg.indexOf("base64,")+27);u.info(`ðŸ“¸ [PHOTO CHANGE] bodyNoBg fingerprint: ${$e}...`)}let Dt,Ps;c?(Dt={structured:c},Ps={upperBody:c.upperBody?"user":void 0,lowerBody:c.lowerBody?"user":void 0,shoes:c.shoes?"user":void 0,fullBody:c.fullBody?"user":void 0},u.info(`ðŸ‘• Keeping old clothing (marked as user-edited): ${JSON.stringify(c)}`)):u.info("ðŸ‘• Using new photo's clothing (cleared existing)");const Ts=ce.characterId,ca=(j==null?void 0:j.id)&&j.id>0,Fr=ca?j.id:Ts;ca?u.info(`ðŸ“¸ [PHOTO] Keeping existing character ID: ${j.id} (server created new ID ${Ts} but ignoring)`):Ts&&u.info(`ðŸ“¸ [PHOTO] Using server-created character ID: ${Ts}`);const St=j?{...j,id:Fr||j.id,photos:Me,avatars:{status:"generating"},clothing:Dt,clothingSource:Ps}:null;if(St){const $e=(B=St.photos)==null?void 0:B.bodyNoBg,ut=$e?Math.round($e.length/1024):0;if(u.info(`ðŸ“¸ [CHAR FOR GEN] bodyNoBg=${ut}KB, has photos: ${!!St.photos}`),$e){const De=$e.substring($e.indexOf("base64,")+7,$e.indexOf("base64,")+27);u.info(`ðŸ“¸ [CHAR FOR GEN] fingerprint: ${De}...`)}}if(ye($e=>{var De;if(!$e)return null;const ut=(De=$e.avatars)!=null&&De.standard?{...$e.avatars,status:"generating",stale:!0}:{status:"generating"};return{...$e,id:Fr||$e.id,photos:Me,avatars:ut,clothing:Dt,clothingSource:Ps}}),Fr&&!ca&&pe($e=>{if(!$e.some(De=>De.id===Fr)){const De={...j,id:Fr,photos:Me,avatars:{status:"generating"},clothing:Dt,clothingSource:Ps};return u.info(`ðŸ“¸ Adding new character ${Fr} to array to prevent data loss`),[...$e,De]}return $e}),u.info("ðŸŽ¨ Auto-starting avatar generation in background..."),u.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Me.bodyNoBg}, body=${!!Me.body}, face=${!!Me.face}`),St&&St.id&&St.name&&St.name.trim()){const $e=St.id;At($e),Ie.generateAndSaveAvatarForCharacter(St,void 0,{avatarModel:rt.avatarModel||void 0}).then(ut=>{ut.success&&ut.character?(ye(De=>!De||De.id!==$e?De:{...De,avatars:ut.character.avatars,physical:ut.character.physical,clothing:ut.character.clothing}),pe(De=>De.map(Ct=>Ct.id===$e?{...Ct,...ut.character,id:Ct.id}:Ct)),u.success(`âœ… Avatar generated and traits extracted for ${St.name}`)):(u.error(`âŒ Avatar generation failed: ${ut.error}`),ye(De=>De&&De.id===$e?{...De,avatars:{status:"failed"}}:De),pe(De=>De.map(Ct=>Ct.id===$e?{...Ct,avatars:{status:"failed"}}:Ct)))}).catch(ut=>{u.error("âŒ Avatar generation error:",ut),ye(De=>De&&De.id===$e?{...De,avatars:{status:"failed"}}:De),pe(De=>De.map(Ct=>Ct.id===$e?{...Ct,avatars:{status:"failed"}}:Ct))}).finally(()=>{At(null)})}else St&&St.id?(u.info("â­ï¸ Skipping auto-generation: character has no name yet"),At(null),ye($e=>$e&&{...$e,avatars:{status:"pending"}})):(u.warn("â­ï¸ Skipping auto-generation: no character data available"),At(null))}else ce.error==="no_face_detected"?(u.warn("No face detected in photo"),v(f.noFaceDetected)):(u.warn("Photo analysis returned no data, using original photo"),ye(Me=>Me?{...Me,photos:{original:H},avatars:void 0}:null))}catch(ae){u.error("Photo analysis error:",ae),ye(Te=>Te?{...Te,photos:{original:H},avatars:void 0}:null)}finally{mr(!1)}},S.readAsDataURL(n)},li=async n=>{var g,c,S,x,w,P,T,I;if(!Kr){u.error("No pending photo data for face selection");return}er(!1),mr(!0);try{u.info(`Re-analyzing photo with selected face ID: ${n}`);const K=ur.map(fe=>({id:fe.id,x:fe.faceBox.x,y:fe.faceBox.y,width:fe.faceBox.width,height:fe.faceBox.height,confidence:fe.confidence})),H=j!=null&&j.id&&j.id>0?j.id:void 0,U=await Ie.analyzePhoto(Kr,s,n,K,H);if(U.success){u.info("Photo analysis complete with selected face:",{hasPhotos:!!U.photos,hasPhysical:!!U.physical,hasClothing:!!U.clothing,age:U.age,gender:U.gender}),U._debug&&xs(U._debug);const fe=Ft==null?void 0:Ft.structured,Le={original:((g=U.photos)==null?void 0:g.face)||Kr,face:(c=U.photos)==null?void 0:c.face,body:((S=U.photos)==null?void 0:S.body)||Kr,bodyNoBg:(x=U.photos)==null?void 0:x.bodyNoBg,faceBox:(w=U.photos)==null?void 0:w.faceBox,bodyBox:(P=U.photos)==null?void 0:P.bodyBox},We=(T=U.photos)!=null&&T.bodyNoBg?Math.round(U.photos.bodyNoBg.length/1024):0;if(u.info(`ðŸ“¸ [FACE SELECT] Analysis returned: bodyNoBg=${We}KB`),(I=U.photos)!=null&&I.bodyNoBg){const V=U.photos.bodyNoBg.substring(U.photos.bodyNoBg.indexOf("base64,")+7,U.photos.bodyNoBg.indexOf("base64,")+27);u.info(`ðŸ“¸ [FACE SELECT] bodyNoBg fingerprint: ${V}...`)}let Fe,te;fe&&(Fe={structured:fe},te={upperBody:fe.upperBody?"user":void 0,lowerBody:fe.lowerBody?"user":void 0,shoes:fe.shoes?"user":void 0,fullBody:fe.fullBody?"user":void 0});const Qe=U.characterId,X=(j==null?void 0:j.id)&&j.id>0,L=X?j.id:Qe;X?u.info(`ðŸ“¸ [FACE SELECT] Keeping existing character ID: ${j.id} (server created new ID ${Qe} but ignoring)`):Qe&&u.info(`ðŸ“¸ [FACE SELECT] Using server-created character ID: ${Qe}`);const R=j?{...j,id:L||j.id,photos:Le,avatars:{status:"generating"},clothing:Fe,clothingSource:te}:null;if(ye(V=>{var ae;if(!V)return null;const B=(ae=V.avatars)!=null&&ae.standard?{...V.avatars,status:"generating",stale:!0}:{status:"generating"};return{...V,id:L||V.id,photos:Le,avatars:B,clothing:Fe,clothingSource:te}}),L&&!X&&pe(V=>{if(!V.some(ae=>ae.id===L)){const ae={...j,id:L,photos:Le,avatars:{status:"generating"},clothing:Fe,clothingSource:te};return u.info(`ðŸ“¸ [FACE SELECT] Adding new character ${L} to array to prevent data loss`),[...V,ae]}return V}),j!=null&&j.name&&j.name.trim().length>=2?(Ue("traits"),u.info("ðŸ“¸ Face selected, character has name, going to traits step")):Ue("name"),u.info("ðŸŽ¨ Auto-starting avatar generation in background after face selection..."),u.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Le.bodyNoBg}, body=${!!Le.body}, face=${!!Le.face}`),R&&R.name&&R.name.trim()){const V=R.id;At(V),Ie.generateAndSaveAvatarForCharacter(R,void 0,{avatarModel:rt.avatarModel||void 0}).then(B=>{B.success&&B.character?(ye(ae=>!ae||ae.id!==V?ae:{...ae,avatars:B.character.avatars,physical:B.character.physical,clothing:B.character.clothing}),pe(ae=>ae.map(Te=>Te.id===V?{...Te,...B.character,id:Te.id}:Te)),u.success(`âœ… Avatar generated for ${R.name} (face selection)`)):(u.error(`âŒ Avatar generation failed: ${B.error}`),ye(ae=>ae&&ae.id===V?{...ae,avatars:{status:"failed"}}:ae),pe(ae=>ae.map(Te=>Te.id===V?{...Te,avatars:{status:"failed"}}:Te)))}).catch(B=>{u.error("âŒ Avatar generation error:",B),ye(ae=>ae&&ae.id===V?{...ae,avatars:{status:"failed"}}:ae),pe(ae=>ae.map(Te=>Te.id===V?{...Te,avatars:{status:"failed"}}:Te))}).finally(()=>{At(null)})}else u.info("â­ï¸ Skipping auto-generation: character has no name yet"),At(null),ye(V=>V&&{...V,avatars:{status:"pending"}})}else u.warn("Photo analysis failed after face selection"),v(f.noFaceDetected)}catch(K){u.error("Photo analysis error after face selection:",K),v("Failed to analyze photo. Please try again.")}finally{mr(!1),ps(null),Rt(null),tr([])}},di=()=>{er(!1),ps(null),Rt(null),tr([]),Ue("photo")},ci=async()=>{if(j){ye(n=>n&&{...n,avatars:void 0}),qr(!0);try{u.info(`ðŸ”„ Regenerating avatars for ${j.name}...`);const n=await Ie.regenerateAvatarsForCharacter(j.id,(g,c)=>u.info(`[${g}] ${c}`),{avatarModel:rt.avatarModel||void 0});if(n.success&&n.character){const g={...n.character.avatars,stale:!1};ye(c=>c&&{...c,avatars:g,physical:n.character.physical,clothing:n.character.clothing}),pe(c=>c.map(S=>S.id===j.id?{...S,avatars:g,physical:n.character.physical,clothing:n.character.clothing}:S)),u.success(`âœ… Avatars and traits regenerated for ${j.name}`)}else u.error(`âŒ Failed to regenerate avatars: ${n.error}`),v(`Failed to regenerate avatars: ${n.error||"Unknown error"}`)}catch(n){u.error(`âŒ Failed to regenerate avatars for ${j.name}:`,n),v(`Failed to regenerate avatars: ${n instanceof Error?n.message:"Unknown error"}`)}finally{qr(!1)}}},mi=async()=>{var n,g,c,S,x,w,P,T,I,K,H,U,fe,Le,We,Fe;if(j){ye(te=>te&&{...te,avatars:void 0}),kr(!0);try{u.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${j.name}...`),u.info(`Physical traits: ${JSON.stringify(j.physical)}`);const te=await Ie.generateClothingAvatarsWithTraits(j);if(te.success&&te.avatars){const Qe={...te.avatars,stale:!1,generatedAt:new Date().toISOString()},X=j.physicalTraitsSource||{},L=te.extractedTraits?{height:(n=j.physical)==null?void 0:n.height,eyeColor:X.eyeColor==="user"?(g=j.physical)==null?void 0:g.eyeColor:te.extractedTraits.eyeColor,eyeColorHex:X.eyeColor==="user"?(c=j.physical)==null?void 0:c.eyeColorHex:te.extractedTraits.eyeColorHex,hairColor:X.hairColor==="user"?(S=j.physical)==null?void 0:S.hairColor:te.extractedTraits.hairColor,hairColorHex:X.hairColor==="user"?(x=j.physical)==null?void 0:x.hairColorHex:te.extractedTraits.hairColorHex,hairLength:X.hairLength==="user"?(w=j.physical)==null?void 0:w.hairLength:te.extractedTraits.hairLength,hairStyle:X.hairStyle==="user"?(P=j.physical)==null?void 0:P.hairStyle:te.extractedTraits.hairStyle,build:X.build==="user"?(T=j.physical)==null?void 0:T.build:te.extractedTraits.build,face:X.face==="user"?(I=j.physical)==null?void 0:I.face:te.extractedTraits.face,facialHair:X.facialHair==="user"?(K=j.physical)==null?void 0:K.facialHair:te.extractedTraits.facialHair,other:X.other==="user"?(H=j.physical)==null?void 0:H.other:te.extractedTraits.other,skinTone:X.skinTone==="user"?(U=j.physical)==null?void 0:U.skinTone:te.extractedTraits.skinTone,skinToneHex:X.skinTone==="user"?(fe=j.physical)==null?void 0:fe.skinToneHex:te.extractedTraits.skinToneHex,detailedHairAnalysis:te.extractedTraits.detailedHairAnalysis||((Le=j.physical)==null?void 0:Le.detailedHairAnalysis),apparentAge:X.apparentAge==="user"?(We=j.physical)==null?void 0:We.apparentAge:te.extractedTraits.apparentAge||((Fe=j.physical)==null?void 0:Fe.apparentAge)}:j.physical,R=te.extractedTraits?{eyeColor:X.eyeColor==="user"?"user":te.extractedTraits.eyeColor?"extracted":void 0,hairColor:X.hairColor==="user"?"user":te.extractedTraits.hairColor?"extracted":void 0,hairLength:X.hairLength==="user"?"user":te.extractedTraits.hairLength?"extracted":void 0,hairStyle:X.hairStyle==="user"?"user":te.extractedTraits.hairStyle?"extracted":void 0,build:X.build==="user"?"user":te.extractedTraits.build?"extracted":void 0,face:X.face==="user"?"user":te.extractedTraits.face?"extracted":void 0,facialHair:X.facialHair==="user"?"user":te.extractedTraits.facialHair?"extracted":void 0,other:X.other==="user"?"user":te.extractedTraits.other?"extracted":void 0,skinTone:X.skinTone==="user"?"user":te.extractedTraits.skinTone?"extracted":void 0,apparentAge:X.apparentAge==="user"?"user":te.extractedTraits.apparentAge?"extracted":void 0}:j.physicalTraitsSource,V=te.extractedClothing?{...j.clothing,structured:{upperBody:te.extractedClothing.upperBody||void 0,lowerBody:te.extractedClothing.lowerBody||void 0,shoes:te.extractedClothing.shoes||void 0,fullBody:te.extractedClothing.fullBody||void 0}}:j.clothing;ye(B=>B&&{...B,avatars:Qe,physical:L,physicalTraitsSource:R,clothing:V}),pe(B=>B.map(ae=>ae.id===j.id?{...ae,avatars:Qe,physical:L,physicalTraitsSource:R,clothing:V}:ae)),u.success(`âœ… Avatars WITH TRAITS regenerated for ${j.name}`),te.extractedTraits&&u.info(`ðŸ“‹ Extracted traits saved: ${JSON.stringify(te.extractedTraits)}`),te.extractedClothing&&u.info(`ðŸ‘• Extracted clothing saved: ${JSON.stringify(te.extractedClothing)}`)}else u.error(`âŒ Failed to regenerate avatars with traits: ${te.error}`),v(`Failed to regenerate avatars: ${te.error||"Unknown error"}`)}catch(te){u.error(`âŒ Failed to regenerate avatars with traits for ${j.name}:`,te),v(`Failed to regenerate avatars: ${te instanceof Error?te.message:"Unknown error"}`)}finally{kr(!1)}}},ui=async()=>{var c,S,x,w,P,T,I,K,H,U,fe,Le,We,Fe,te,Qe;if(!j)return;const n={...j},g=j.id;kr(!0);try{u.info(`ðŸ’¾ Saving character and regenerating avatars for ${n.name}...`),await da(),u.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${n.name}...`);const L=(await new Promise(V=>{pe(B=>(V(B),B))})).find(V=>V.id===g);if(!L){u.warn("Character not found in characters array after save");return}const R=await Ie.generateClothingAvatarsWithTraits(L);if(R.success&&R.avatars){const V={...R.avatars,stale:!1,generatedAt:new Date().toISOString()},B=L.physicalTraitsSource||{},ae=R.extractedTraits?{height:(c=L.physical)==null?void 0:c.height,eyeColor:B.eyeColor==="user"?(S=L.physical)==null?void 0:S.eyeColor:R.extractedTraits.eyeColor,eyeColorHex:B.eyeColor==="user"?(x=L.physical)==null?void 0:x.eyeColorHex:R.extractedTraits.eyeColorHex,hairColor:B.hairColor==="user"?(w=L.physical)==null?void 0:w.hairColor:R.extractedTraits.hairColor,hairColorHex:B.hairColor==="user"?(P=L.physical)==null?void 0:P.hairColorHex:R.extractedTraits.hairColorHex,hairLength:B.hairLength==="user"?(T=L.physical)==null?void 0:T.hairLength:R.extractedTraits.hairLength,hairStyle:B.hairStyle==="user"?(I=L.physical)==null?void 0:I.hairStyle:R.extractedTraits.hairStyle,build:B.build==="user"?(K=L.physical)==null?void 0:K.build:R.extractedTraits.build,face:B.face==="user"?(H=L.physical)==null?void 0:H.face:R.extractedTraits.face,facialHair:B.facialHair==="user"?(U=L.physical)==null?void 0:U.facialHair:R.extractedTraits.facialHair,other:B.other==="user"?(fe=L.physical)==null?void 0:fe.other:R.extractedTraits.other,skinTone:B.skinTone==="user"?(Le=L.physical)==null?void 0:Le.skinTone:R.extractedTraits.skinTone,skinToneHex:B.skinTone==="user"?(We=L.physical)==null?void 0:We.skinToneHex:R.extractedTraits.skinToneHex,detailedHairAnalysis:R.extractedTraits.detailedHairAnalysis||((Fe=L.physical)==null?void 0:Fe.detailedHairAnalysis),apparentAge:B.apparentAge==="user"?(te=L.physical)==null?void 0:te.apparentAge:R.extractedTraits.apparentAge||((Qe=L.physical)==null?void 0:Qe.apparentAge)}:L.physical,Te=R.extractedTraits?{eyeColor:B.eyeColor==="user"?"user":R.extractedTraits.eyeColor?"extracted":void 0,hairColor:B.hairColor==="user"?"user":R.extractedTraits.hairColor?"extracted":void 0,hairLength:B.hairLength==="user"?"user":R.extractedTraits.hairLength?"extracted":void 0,hairStyle:B.hairStyle==="user"?"user":R.extractedTraits.hairStyle?"extracted":void 0,build:B.build==="user"?"user":R.extractedTraits.build?"extracted":void 0,face:B.face==="user"?"user":R.extractedTraits.face?"extracted":void 0,facialHair:B.facialHair==="user"?"user":R.extractedTraits.facialHair?"extracted":void 0,other:B.other==="user"?"user":R.extractedTraits.other?"extracted":void 0,skinTone:B.skinTone==="user"?"user":R.extractedTraits.skinTone?"extracted":void 0,apparentAge:B.apparentAge==="user"?"user":R.extractedTraits.apparentAge?"extracted":void 0}:L.physicalTraitsSource,q=R.extractedClothing?{...L.clothing,structured:{upperBody:R.extractedClothing.upperBody||void 0,lowerBody:R.extractedClothing.lowerBody||void 0,shoes:R.extractedClothing.shoes||void 0,fullBody:R.extractedClothing.fullBody||void 0}}:L.clothing;ye(Ze=>Ze&&Ze.id===g?{...Ze,avatars:V,physical:ae,physicalTraitsSource:Te,clothing:q}:Ze),pe(Ze=>Ze.map(at=>at.id===g?{...at,avatars:V,physical:ae,physicalTraitsSource:Te,clothing:q}:at)),u.success(`âœ… Avatars regenerated for ${L.name}`);const Ae={...L,avatars:V,physical:ae,physicalTraitsSource:Te,clothing:q},Me=(await new Promise(Ze=>{pe(at=>(Ze(at),at))})).map(Ze=>Ze.id===g?Ae:Ze);await Ie.saveCharacterData({characters:Me,relationships:Ye,relationshipTexts:jt,customRelationships:ht,customStrengths:[],customWeaknesses:[],customFears:[]}),u.success("ðŸ’¾ Character saved with new avatars, traits, and clothing"),C(s==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else u.error(`âŒ Failed to regenerate avatars: ${R.error}`),v(`Failed to regenerate avatars: ${R.error||"Unknown error"}`)}catch(X){u.error("âŒ Failed to save and regenerate:",X),v(`Failed: ${X instanceof Error?X.message:"Unknown error"}`)}finally{kr(!1)}},gi=async()=>{var S,x,w,P,T,I,K,H,U,fe,Le,We,Fe,te,Qe,X,L,R;if(!j)return;const n=j.id;gs(void 0),Ue("traits");const g=(S=j.avatars)==null?void 0:S.status,c=!!((x=j.avatars)!=null&&x.standard||(w=j.avatars)!=null&&w.winter||(P=j.avatars)!=null&&P.summer||(T=j.avatars)!=null&&T.hasFullAvatars);if(g==="generating"||g==="complete"&&c){u.info(`â­ï¸ Skipping avatar generation - already ${g}${c?" with avatars":""}`);return}At(n),ye(V=>V&&V.id===n?{...V,avatars:{status:"generating"}}:V),u.info(`ðŸŽ¨ Starting avatar generation for ${j.name||"unnamed"} (id: ${n})...`);try{const V=await Ie.generateClothingAvatarsWithTraits(j);if(V.success&&V.avatars){const B={...V.avatars,stale:!1,generatedAt:new Date().toISOString()},ae=V.extractedTraits?{...j.physical,build:V.extractedTraits.build||((I=j.physical)==null?void 0:I.build),eyeColor:V.extractedTraits.eyeColor||((K=j.physical)==null?void 0:K.eyeColor),eyeColorHex:V.extractedTraits.eyeColorHex||((H=j.physical)==null?void 0:H.eyeColorHex),hairColor:V.extractedTraits.hairColor||((U=j.physical)==null?void 0:U.hairColor),hairColorHex:V.extractedTraits.hairColorHex||((fe=j.physical)==null?void 0:fe.hairColorHex),hairLength:V.extractedTraits.hairLength||((Le=j.physical)==null?void 0:Le.hairLength),hairStyle:V.extractedTraits.hairStyle||((We=j.physical)==null?void 0:We.hairStyle),facialHair:V.extractedTraits.facialHair||((Fe=j.physical)==null?void 0:Fe.facialHair),skinTone:V.extractedTraits.skinTone||((te=j.physical)==null?void 0:te.skinTone),skinToneHex:V.extractedTraits.skinToneHex||((Qe=j.physical)==null?void 0:Qe.skinToneHex),face:V.extractedTraits.face||((X=j.physical)==null?void 0:X.face),other:V.extractedTraits.other||((L=j.physical)==null?void 0:L.other),detailedHairAnalysis:V.extractedTraits.detailedHairAnalysis||((R=j.physical)==null?void 0:R.detailedHairAnalysis)}:j.physical,Te=V.extractedClothing?{...j.clothing,structured:{upperBody:V.extractedClothing.upperBody||void 0,lowerBody:V.extractedClothing.lowerBody||void 0,shoes:V.extractedClothing.shoes||void 0,fullBody:V.extractedClothing.fullBody||void 0}}:j.clothing;pe(q=>q.map(Ae=>Ae.id===n?{...Ae,avatars:B,physical:ae,clothing:Te}:Ae)),ye(q=>q&&q.id===n?{...q,avatars:B,physical:ae,clothing:Te}:q),u.success(`âœ… Avatar generated for ${j.name} (id: ${n})`)}else u.error(`âŒ Failed to generate avatar: ${V.error}`),v(`Failed to generate avatar: ${V.error||"Unknown error"}`),pe(B=>B.map(ae=>ae.id===n?{...ae,avatars:{status:"failed"}}:ae)),ye(B=>B&&B.id===n?{...B,avatars:{status:"failed"}}:B)}catch(V){u.error("âŒ Avatar generation failed:",V),v(`Avatar generation failed: ${V instanceof Error?V.message:"Unknown error"}`),pe(B=>B.map(ae=>ae.id===n?{...ae,avatars:{status:"failed"}}:ae)),ye(B=>B&&B.id===n?{...B,avatars:{status:"failed"}}:B)}finally{At(null)}},da=async()=>{var n;if(j){J(!0);try{const g=wr.current,c=Wr.current;if(!g){u.warn("No current character to save");return}const S=g.id&&c.find(T=>T.id===g.id),x=S?c.map(T=>T.id===g.id?g:T):[...c,g];u.info("Saving characters with relationships:",x.length);const w=!S&&!!((n=g.photos)!=null&&n.original);await Ie.saveCharacterData({characters:x,relationships:Ye,relationshipTexts:jt,customRelationships:ht,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:w}),Pt.current=!1,u.success("Character data saved successfully"),pe(x),ia(x);const P=x.find(T=>T.id===j.id);P&&Ie.needsAvatars(P)&&Vr!==P.id&&(u.info(`ðŸŽ¨ Starting background avatar generation for ${P.name}...`),Ie.generateAndSaveAvatarForCharacter(P,void 0,{avatarModel:rt.avatarModel||void 0}).then(T=>{T.success&&T.character?(pe(I=>I.map(K=>K.id===P.id?{...K,avatars:T.character.avatars,physical:T.character.physical,clothing:T.character.clothing}:K)),u.success(`âœ… Avatars and traits saved for ${P.name}`)):T.skipped||(u.warn(`Avatar generation failed for ${P.name}: ${T.error}`),pe(I=>I.map(K=>K.id===P.id?{...K,avatars:{status:"failed"}}:K)))}).catch(T=>{u.error(`âŒ Background avatar generation error for ${P.name}:`,T),pe(I=>I.map(K=>K.id===P.id?{...K,avatars:{status:"failed"}}:K))})),ye(null),zt(!0)}catch(g){u.error("Failed to save character:",g),v(s==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de l'enregistrement du personnage. Veuillez rÃ©essayer.":"Failed to save character. Please try again.")}finally{J(!1)}}},hi=async n=>{ye({...n}),Ue("traits"),zt(!1);const g=await Ie.loadFullCharacter(n.id);g&&(ye(c=>c&&c.id===n.id?{...c,...g}:c),pe(c=>c.map(S=>S.id===n.id?{...S,...g}:S)))},xi=async n=>{try{const g=await Ie.deleteCharacter(n);g.success?(pe(c=>c.filter(S=>S.id!==n)),Jr(c=>{const S={...c};return Object.keys(S).forEach(x=>{(x.includes(`${n}-`)||x.includes(`-${n}`))&&delete S[x]}),S}),Qr(c=>{const S={...c};return Object.keys(S).forEach(x=>{(x.includes(`${n}-`)||x.includes(`-${n}`))&&delete S[x]}),S}),$t(c=>c.filter(S=>S!==n)),r.current=!0,u.success(`Character ${n} deleted`)):(u.error("Failed to delete character:",g.error),v(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character"))}catch(g){u.error("Failed to delete character:",g),v(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character")}},pi=(n,g,c)=>{const x=So(c,s),w=`${n}-${g}`,P=`${g}-${n}`;u.debug("Updating relationship:",w,"=",c,", inverse:",P,"=",x),Pt.current=!0,Jr(T=>({...T,[w]:c,[P]:x}))},fi=(n,g)=>{Pt.current=!0;const[c,S]=n.split("-").map(Number),x=`${S}-${c}`;Qr(w=>({...w,[n]:g,[x]:g}))},bi=(n,g)=>{Pt.current=!0,Ar(c=>[...c,{forward:n,inverse:g}])},yi=(n,g)=>{g==="out"?(sr(c=>c.includes(n)?c:[...c,n]),$t(c=>c.filter(S=>S!==n))):g==="in"?(sr(c=>c.filter(S=>S!==n)),$t(c=>c.filter(S=>S!==n))):g==="main"&&(sr(c=>c.filter(S=>S!==n)),$t(c=>c.includes(n)?c:[...c,n])),r.current=!0,pe(c=>c.map(S=>S.id===n?{...S,storyRole:g}:S))},vi=async()=>{const[n,g,c]=await Promise.all([new Promise(x=>{pe(w=>(x(w),w))}),new Promise(x=>{$t(w=>(x(w),w))}),new Promise(x=>{sr(w=>(x(w),w))})]);if(n.length===0)return;if(!r.current){u.debug("Roles not modified, skipping save");return}const S={};for(const x of n)g.includes(x.id)?S[x.id]="main":c.includes(x.id)?S[x.id]="out":S[x.id]="in";try{await Ie.saveCharacterRoles(S),r.current=!1}catch(x){u.error("Failed to save character roles:",x)}},ns=d.useRef(null),Vt=async n=>{n>=0&&n<=7&&(z===1&&j&&n!==1&&await da(),z===1&&n!==1&&(ns.current=(async()=>{await Ni(),await vi()})(),ns.current.catch(g=>u.error("Background save failed:",g))),n===1&&z!==1&&ye(null),ne(n),window.scrollTo(0,0))},ji=n=>n===1?!0:n===2||n===3?he.length>0:n===4?he.length>0&&Ne!=="":n===5?he.length>0&&Ne!==""&&_e!=="":n===6?Dr!=="":!1,br=()=>z===1?he.length>0&&Tt.length>0:z===2?!0:z===3?!(!Ne||Ne==="adventure"&&!Be||(Ne==="life-challenge"||Ne==="educational")&&!ze||Ne==="historical"&&!ze||Ne==="custom"&&!(ct!=null&&ct.trim())):z===4?_e!=="":z===5?he.filter(g=>!st.includes(g.id)).length>0&&Tt.length>0&&it.trim().length>0:!1,Ni=async()=>{const n=await new Promise(g=>{pe(c=>(g(c),c))});if(n.length!==0){if(!Pt.current){u.debug("Relationships not modified, skipping save");return}try{u.debug("Auto-saving character data with latest state..."),await Ie.saveCharacterData({characters:n,relationships:Ye,relationshipTexts:jt,customRelationships:ht,customStrengths:[],customWeaknesses:[],customFears:[]}),Pt.current=!1,u.debug("Character data auto-saved")}catch(g){u.error("Failed to auto-save character data:",g)}}},wi=async()=>{if(z<5&&br()){if(z===1&&he.length===1){qs(!0);return}await Vt(z+1)}},Wa=async()=>{z>0&&await Vt(z-1)},Si=(n,g)=>{wt(n),Na(g??null)},Va=async()=>{hr.current&&hr.current.abort(),de(!0),_t(!0),Wt(!0),Tr([]),_s(null),Ws(""),Na(null);const n=he.filter(g=>!st.includes(g.id));Cn({storyType:dt,storyCategory:Ne||"",storyTopic:ze||"",storyTheme:Be||"",characters:n.map(g=>({id:g.id,name:g.name})),language:F,languageLevel:y,pages:Q,userLocation:xr||void 0,season:pr||void 0}),hr.current=Oe.generateStoryIdeasStream({storyType:dt,storyTypeName:is(),storyCategory:Ne||void 0,storyTopic:ze||void 0,storyTheme:Be||void 0,customThemeText:Be==="custom"?ct:void 0,language:F,languageLevel:y,pages:Q,characters:n.map(g=>({name:g.name,age:g.age,gender:g.gender,traits:g.traits,isMain:Tt.includes(g.id)})),relationships:Object.entries(Ye).map(([g,c])=>{const[S,x]=g.split("-").map(Number),w=n.find(T=>T.id===S),P=n.find(T=>T.id===x);return{character1:(w==null?void 0:w.name)||"",character2:(P==null?void 0:P.name)||"",relationship:c}}).filter(g=>g.character1&&g.character2),ideaModel:(h==null?void 0:h.role)==="admin"||D?rt.ideaModel:void 0,userLocation:xr||void 0,season:pr},{onStatus:(g,c,S)=>{c&&S&&_s({prompt:c,model:S})},onStory1:g=>{Tr(c=>{const S=[...c];return S[0]=g,S}),Os(100),_t(!1)},onStory2:g=>{Tr(c=>{const S=[...c];return S[1]=g,S}),Hs(100),Wt(!1)},onError:g=>{u.error("Failed to generate story ideas:",g),v(s==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":s==="fr"?"Erreur lors de la gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Failed to generate ideas. Please try again."),de(!1),_t(!1),Wt(!1)},onDone:g=>{de(!1),_t(!1),Wt(!1),g&&Ws(g),hr.current=null,u.info("[IDEAS] onDone complete")}})},is=()=>{const n=pa.find(g=>g.id===dt);return n?n.name[s]:dt},yr=async n=>{var c,S,x,w,P,T,I,K,H,U,fe,Le,We,Fe,te,Qe;if(console.log("[generateStory] Called with overrides:",n),console.log("[generateStory] user:",h==null?void 0:h.email,"emailVerified:",h==null?void 0:h.emailVerified,"isImpersonating:",D),ns.current&&(await ns.current,ns.current=null),!(n!=null&&n.skipEmailCheck)&&!D&&h&&h.emailVerified!==!0){await o();const X=localStorage.getItem("currentUser");let L=h.emailVerified;if(X)try{L=JSON.parse(X).emailVerified}catch{}if(L===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",dt),localStorage.setItem("pending_art_style",_e),ys(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),$r(!0),bs(!1),ne(6),ta({storyCategory:Ne||void 0,storyTopic:ze||void 0,storyTheme:Be||void 0,storyTypeName:is(),storyDetails:it||void 0,artStyle:_e||void 0,language:F||void 0,languageLevel:y||void 0,pages:Q||void 0,dedication:Ke||void 0,characters:he.filter(X=>!st.includes(X.id)).map(X=>({id:X.id,name:X.name})),mainCharacters:Tt,relationships:Ye,relationshipTexts:jt,season:pr||void 0,userLocation:xr||void 0}),Xr(""),ir(""),It([]),es([]),Ns(null),ws({}),Mt({frontCover:null,initialPage:null,backCover:null});const g=he.filter(X=>!st.includes(X.id)).filter(X=>!X.avatars||X.avatars.stale||X.avatars.status!=="complete");if(g.length>0){console.log("[generateStory] Characters needing avatar regeneration:",g.map(X=>X.name)),fr({current:1,total:100,message:s==="de"?`Aktualisiere Avatare fÃ¼r ${g.length} Charakter(e)...`:s==="fr"?`Mise Ã  jour des avatars pour ${g.length} personnage(s)...`:`Updating avatars for ${g.length} character(s)...`});for(let X=0;X<g.length;X++){const L=g[X];try{console.log(`[generateStory] Regenerating avatars for ${L.name} (${X+1}/${g.length})`),fr({current:2,total:100,message:s==="de"?`Generiere Avatare fÃ¼r ${L.name}...`:s==="fr"?`GÃ©nÃ©ration des avatars pour ${L.name}...`:`Generating avatars for ${L.name}...`});const R=await Ie.generateClothingAvatarsWithTraits(L);if(R.success&&R.avatars){const V={...R.avatars,stale:!1,generatedAt:new Date().toISOString()},B=L.physicalTraitsSource||{},ae=R.extractedTraits?{...L.physical,height:(c=L.physical)==null?void 0:c.height,build:B.build==="user"?(S=L.physical)==null?void 0:S.build:R.extractedTraits.build,eyeColor:B.eyeColor==="user"?(x=L.physical)==null?void 0:x.eyeColor:R.extractedTraits.eyeColor,eyeColorHex:B.eyeColor==="user"?(w=L.physical)==null?void 0:w.eyeColorHex:R.extractedTraits.eyeColorHex,hairColor:B.hairColor==="user"?(P=L.physical)==null?void 0:P.hairColor:R.extractedTraits.hairColor,hairColorHex:B.hairColor==="user"?(T=L.physical)==null?void 0:T.hairColorHex:R.extractedTraits.hairColorHex,hairLength:B.hairLength==="user"?(I=L.physical)==null?void 0:I.hairLength:R.extractedTraits.hairLength,hairStyle:B.hairStyle==="user"?(K=L.physical)==null?void 0:K.hairStyle:R.extractedTraits.hairStyle,facialHair:B.facialHair==="user"?(H=L.physical)==null?void 0:H.facialHair:R.extractedTraits.facialHair,skinTone:B.skinTone==="user"?(U=L.physical)==null?void 0:U.skinTone:R.extractedTraits.skinTone,skinToneHex:B.skinTone==="user"?(fe=L.physical)==null?void 0:fe.skinToneHex:R.extractedTraits.skinToneHex,face:B.face==="user"?(Le=L.physical)==null?void 0:Le.face:R.extractedTraits.face,other:B.other==="user"?(We=L.physical)==null?void 0:We.other:R.extractedTraits.other,detailedHairAnalysis:R.extractedTraits.detailedHairAnalysis||((Fe=L.physical)==null?void 0:Fe.detailedHairAnalysis),apparentAge:B.apparentAge==="user"?(te=L.physical)==null?void 0:te.apparentAge:R.extractedTraits.apparentAge||((Qe=L.physical)==null?void 0:Qe.apparentAge)}:L.physical,Te=R.extractedTraits?{...B,build:B.build==="user"?"user":R.extractedTraits.build?"extracted":void 0,eyeColor:B.eyeColor==="user"?"user":R.extractedTraits.eyeColor?"extracted":void 0,hairColor:B.hairColor==="user"?"user":R.extractedTraits.hairColor?"extracted":void 0,hairLength:B.hairLength==="user"?"user":R.extractedTraits.hairLength?"extracted":void 0,hairStyle:B.hairStyle==="user"?"user":R.extractedTraits.hairStyle?"extracted":void 0,face:B.face==="user"?"user":R.extractedTraits.face?"extracted":void 0,facialHair:B.facialHair==="user"?"user":R.extractedTraits.facialHair?"extracted":void 0,other:B.other==="user"?"user":R.extractedTraits.other?"extracted":void 0,skinTone:B.skinTone==="user"?"user":R.extractedTraits.skinTone?"extracted":void 0,apparentAge:B.apparentAge==="user"?"user":R.extractedTraits.apparentAge?"extracted":void 0}:L.physicalTraitsSource,q=R.extractedClothing?{...L.clothing,structured:{upperBody:R.extractedClothing.upperBody||void 0,lowerBody:R.extractedClothing.lowerBody||void 0,shoes:R.extractedClothing.shoes||void 0,fullBody:R.extractedClothing.fullBody||void 0}}:L.clothing;pe(Ae=>Ae.map(ce=>ce.id===L.id?{...ce,avatars:V,physical:ae,physicalTraitsSource:Te,clothing:q}:ce)),ye(Ae=>Ae&&Ae.id===L.id?{...Ae,avatars:V,physical:ae,physicalTraitsSource:Te,clothing:q}:Ae),pe(Ae=>{const ce=Ae.map(Me=>Me.id===L.id?{...Me,avatars:V,physical:ae,physicalTraitsSource:Te,clothing:q}:Me);return Ie.saveCharacterData({characters:ce,relationships:Ye,relationshipTexts:jt,customRelationships:ht,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(Me=>console.error("Failed to save avatar update:",Me)),ce}),console.log(`[generateStory] âœ… Avatars regenerated for ${L.name}`)}else console.warn(`[generateStory] âš ï¸ Failed to regenerate avatars for ${L.name}: ${R.error}`)}catch(R){console.error(`[generateStory] âŒ Error regenerating avatars for ${L.name}:`,R)}}}fr({current:5,total:100,message:s==="de"?"Starte Generierung...":s==="fr"?"DÃ©marrage de la gÃ©nÃ©ration...":"Starting generation..."});try{const X=he.filter(q=>!st.includes(q.id)),{jobId:L,creditsRemaining:R}=await Oe.createStoryJob({storyType:dt,storyTypeName:is(),storyCategory:Ne||void 0,storyTopic:ze||void 0,storyTheme:Be||void 0,customThemeText:Be==="custom"?ct:void 0,artStyle:_e,language:F,languageLevel:y,pages:Q,dedication:Ke,storyDetails:it,characters:X,mainCharacters:Tt,relationships:Ye,relationshipTexts:jt,skipImages:(n==null?void 0:n.skipImages)??ue,imageGenMode:je,generationMode:we!=="auto"?we:void 0,skipOutline:Re,skipText:Ve,skipSceneDescriptions:qe,skipCovers:ke,enableAutoRepair:He,useGridRepair:bt,forceRepairThreshold:yt,enableFinalChecks:Or,checkOnlyMode:lt,incrementalConsistency:dr?{enabled:!0,dryRun:Ce,lookbackCount:ge}:void 0,modelOverrides:(h==null?void 0:h.role)==="admin"||D?{outlineModel:rt.outlineModel,textModel:rt.textModel,sceneDescriptionModel:rt.sceneDescriptionModel,imageModel:rt.imageModel,coverImageModel:rt.coverImageModel,qualityModel:rt.qualityModel}:void 0,userLocation:xr||void 0,season:pr||void 0,ideaGeneration:wa&&fs&&ar.length>0?{input:wa,output:ar,rawResponse:ja,prompt:fs.prompt,model:fs.model,selectedIndex:Sn}:void 0});js(L),u.info("Story job created:",L),p(L,is()||"New Story"),R!=null&&A(R);let V=!1,B=0,ae=Date.now();const Te=180*1e3;for(Ir(!1);!V;){await new Promise(Ae=>setTimeout(Ae,2e3));const q=await Oe.getJobStatus(L);if(q.progress&&(q.progress.current!==B?(u.debug(`Progress: ${q.progress.current}% - ${q.progress.message||""}`),B=q.progress.current,ae=Date.now(),Ir(!1)):Date.now()-ae>=Te&&Ir(!0),fr(Ae=>q.progress.current>=Ae.current?q.progress:q.progress.message?{...Ae,message:q.progress.message}:Ae)),q.partialCovers){let Ae=!1;Mt(ce=>{var Ze,at,As;const Me={...ce};if((Ze=q.partialCovers)!=null&&Ze.frontCover&&!ce.frontCover){Me.frontCover=q.partialCovers.frontCover,u.debug("Front cover received during streaming");const Dt=q.partialCovers.frontCover;typeof Dt=="object"&&(Dt!=null&&Dt.storyTitle)&&(ir(Dt.storyTitle),u.debug(`Story title from front cover: ${Dt.storyTitle}`)),Ae=!0}return(at=q.partialCovers)!=null&&at.initialPage&&!ce.initialPage&&(Me.initialPage=q.partialCovers.initialPage,u.debug("Initial page cover received during streaming")),(As=q.partialCovers)!=null&&As.backCover&&!ce.backCover&&(Me.backCover=q.partialCovers.backCover,u.debug("Back cover received during streaming")),Me}),Ae&&(u.debug("Transitioning to StoryDisplay - front cover ready"),ne(6))}if(q.storyText&&!pt&&(Ns(q.storyText),ir(q.storyText.title),u.debug(`Story text received: ${q.storyText.totalPages} pages ready for display`)),q.partialPages&&q.partialPages.length>0&&ws(Ae=>{var Ze;const ce={...Ae};let Me=0;return(Ze=q.partialPages)==null||Ze.forEach(at=>{at.imageData&&!Ae[at.pageNumber]&&(ce[at.pageNumber]=at.imageData,Me++)}),Me>0&&u.debug(`${Me} new page images received (total: ${Object.keys(ce).length})`),ce}),console.log("[StoryWizard] Job status check:",{status:q.status,hasResult:!!q.result,resultKeys:q.result?Object.keys(q.result):[],progress:q.progress}),q.status==="completed"&&q.result)Xs(q.result.storyId),ir(q.result.title),Ta(q.result.outline),$a(q.result.outlinePrompt||""),Ia(q.result.outlineModelId),Da(q.result.outlineUsage),Ea(q.result.storyTextPrompts||[]),Js(q.result.styledAvatarGeneration||[]),Qs(q.result.costumedAvatarGeneration||[]),Zs(q.result.generationLog||[]),za(q.result.finalChecksReport||null),q.result.visualBible?Er({mainCharacters:q.result.visualBible.mainCharacters||[],secondaryCharacters:q.result.visualBible.secondaryCharacters||[],animals:q.result.visualBible.animals||[],artifacts:q.result.visualBible.artifacts||[],locations:q.result.visualBible.locations||[],vehicles:q.result.visualBible.vehicles||[],clothing:q.result.visualBible.clothing||[],changeLog:q.result.visualBible.changeLog||[]}):Er(null),q.result.clothingRequirements?vs(q.result.clothingRequirements):vs(null),Xr(q.result.story),Pa(q.result.story),es(q.result.sceneDescriptions||[]),It(q.result.sceneImages||[]),Mt(q.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),Ns(null),ws({}),V=!0,q.currentCredits!==null&&q.currentCredits!==void 0&&A(q.currentCredits),ne(6),u.success("Story generation completed!"),ta({storyCategory:Ne||void 0,storyTopic:ze||void 0,storyTheme:Be||void 0,storyTypeName:is(),storyDetails:it||void 0,artStyle:_e||void 0,language:F||void 0,languageLevel:y||void 0,pages:Q||void 0,dedication:Ke||void 0,characters:he.map(Ae=>({id:Ae.id,name:Ae.name})),mainCharacters:Tt,relationships:Ye,relationshipTexts:jt,season:pr||void 0,userLocation:xr||void 0}),ra.current=!0,b();else if(q.status==="failed")throw new Error(q.error||"Story generation failed")}fr({current:100,total:100,message:s==="de"?"Fertig!":s==="fr"?"TerminÃ©!":"Complete!"})}catch(X){u.error("Generation failed:",X);const L=X instanceof Error?X.message:String(X);if(L.includes("already in progress")){const R=L.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),V=R?R[1]:null,B=s==="de"?"Eine Geschichte wird bereits erstellt. MÃ¶chtest du diese abbrechen und eine neue starten?":s==="fr"?"Une histoire est dÃ©jÃ  en cours de crÃ©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(V&&window.confirm(B))try{await Oe.cancelJob(V),u.info("Cancelled existing job:",V),await yr(n);return}catch(ae){u.error("Failed to cancel existing job:",ae),v(s==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es spÃ¤ter erneut.":s==="fr"?"Ã‰chec de l'annulation. Veuillez rÃ©essayer plus tard.":"Failed to cancel. Please try again later.")}$r(!1);return}else v(s==="de"?`Generierung fehlgeschlagen: ${L}`:s==="fr"?`Ã‰chec de la gÃ©nÃ©ration: ${L}`:`Generation failed: ${L}`)}finally{Ir(!1),b(),setTimeout(()=>$r(!1),500)}};d.useEffect(()=>{if(ks.current&&k&&he.length>0&&z===5&&!nr){ks.current=!1;const n=localStorage.getItem("verificationGenerationStarted");if(n){const c=parseInt(n,10),S=Date.now()-120*1e3;if(c>S){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await o(),setTimeout(()=>{yr({skipEmailCheck:!0})},500)})()}},[k,he,z,nr,o]);const Ci=()=>{switch(z){case 1:return e.jsx(Eo,{characters:he,currentCharacter:j,characterStep:Sr,showCharacterCreated:mt,isLoading:Z,isAnalyzingPhoto:Cr,isGeneratingAvatar:Vr===(j==null?void 0:j.id),isRegeneratingAvatars:us,isRegeneratingAvatarsWithTraits:Xt,developerMode:xe,isImpersonating:D,changedTraits:Gs,photoAnalysisDebug:hs,mainCharacters:Tt,excludedCharacters:st,onCharacterRoleChange:yi,onCharacterChange:ye,onCharacterStepChange:Ue,onContinueToAvatar:()=>Ue("avatar"),onPhotoSelect:oi,onSaveAndGenerateAvatar:gi,onSaveCharacter:da,onEditCharacter:hi,onDeleteCharacter:xi,onStartNewCharacter:la,onRegenerateAvatars:ci,onRegenerateAvatarsWithTraits:mi,onSaveAndRegenerateWithTraits:ui,onSaveAndTryNewPhoto:async()=>{var c;if(u.info(`ðŸ“¸ onSaveAndTryNewPhoto called, currentCharacter: ${j==null?void 0:j.name}`),!j){u.warn("ðŸ“¸ No currentCharacter, returning early");return}J(!0);try{const S=j.id&&he.find(P=>P.id===j.id),x=S?he.map(P=>P.id===j.id?j:P):[...he,j],w=!S&&!!((c=j.photos)!=null&&c.original);await Ie.saveCharacterData({characters:x,relationships:Ye,relationshipTexts:jt,customRelationships:ht,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:w}),pe(x),ia(x),u.info(`ðŸ“¸ Setting characterStep to 'photo', currentCharacter still: ${j==null?void 0:j.name}`),Ue("photo")}catch(S){u.error("ðŸ“¸ Error saving character:",S)}finally{J(!1),u.info("ðŸ“¸ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:Ye,relationshipTexts:jt,onRelationshipChange:pi,onRelationshipTextChange:fi,customRelationships:ht,onAddCustomRelationship:bi});case 2:return e.jsx(zo,{languageLevel:y,onLanguageLevelChange:N,pages:Q,onPagesChange:le,storyLanguage:F,onStoryLanguageChange:m,developerMode:xe,userLocation:xr,onLocationChange:Sa,season:pr,onSeasonChange:kn,userCredits:D?-1:(h==null?void 0:h.credits)??0});case 3:return e.jsx(Fo,{storyCategory:Ne,storyTopic:ze,storyTheme:Be,customThemeText:ct,onCategoryChange:ei,onTopicChange:ri,onThemeChange:ti,onCustomThemeTextChange:Yt,onLegacyStoryTypeChange:Jt});case 4:return e.jsx(Ro,{artStyle:_e,onArtStyleChange:si});case 5:return e.jsx(Bo,{characters:he,mainCharacters:Tt,excludedCharacters:st,storyCategory:Ne,storyTopic:ze,storyTheme:Be,customThemeText:ct,onCustomThemeTextChange:Yt,artStyle:_e,storyLanguage:F,languageLevel:y,pages:Q,userLocation:xr,season:pr,storyDetails:it,onStoryDetailsChange:wt,dedication:Ke,onDedicationChange:Nt,onGenerateIdeas:Va,isGeneratingIdeas:xt,isGeneratingIdea1:ot,isGeneratingIdea2:gr,ideaProgress1:Nn,ideaProgress2:wn,ideaPrompt:fs,ideaFullResponse:ja,generatedIdeas:ar,onSelectIdea:Si,onUseDirectly:()=>yr(),onEditStep:Vt,developerMode:xe,imageGenMode:je,onImageGenModeChange:oe,generationMode:we,onGenerationModeChange:Ee});case 6:const n=ts.frontCover||ts.initialPage||Object.keys(sa).length>0||Ys.some(c=>c.imageData);if(Dr&&n||pt&&n||nr&&n){const c=Dr?Ys:Object.entries(sa).map(([x,w])=>{var P;return{pageNumber:parseInt(x),imageData:w,description:((P=pt==null?void 0:pt.sceneDescriptions.find(T=>T.pageNumber===parseInt(x)))==null?void 0:P.description)||""}}),S=Dr||Object.entries((pt==null?void 0:pt.pageTexts)||{}).sort(([x],[w])=>parseInt(x)-parseInt(w)).map(([x,w])=>`--- Page ${x} ---
${w}`).join(`

`);return e.jsxs(e.Fragment,{children:[Bt&&Bt.total>0&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${Bt.loaded/Bt.total*100}%`}})}),e.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:s==="de"?`Bilder: ${Bt.loaded}/${Bt.total}`:s==="fr"?`Images: ${Bt.loaded}/${Bt.total}`:`Images: ${Bt.loaded}/${Bt.total}`})]}),e.jsx(ho,{title:Ks,dedication:Ke||void 0,story:S,originalStory:Fn,outline:Rn,outlinePrompt:Bn,outlineModelId:Mn,outlineUsage:Gn,storyTextPrompts:Ln,visualBible:On||void 0,sceneImages:c,sceneDescriptions:(pt==null?void 0:pt.sceneDescriptions)||Un,characters:_r||he.filter(x=>!st.includes(x.id)),progressiveMode:nr,progressiveData:pt||void 0,completedPageImages:sa,coverImages:ts,regeneratingCovers:An,languageLevel:y,storyLanguage:F,isGenerating:nr,developerMode:xe,styledAvatarGeneration:_n,costumedAvatarGeneration:Wn,generationLog:Vn,finalChecksReport:qn,clothingRequirements:Hn||void 0,storyId:ve,onVisualBibleChange:ve?async x=>{try{u.info("Updating Visual Bible for story:",ve),await Oe.updateVisualBible(ve,x),Er(x),u.success("Visual Bible updated successfully")}catch(w){u.error("Failed to update Visual Bible:",w),v(s==="de"?"Visual Bible konnte nicht aktualisiert werden":s==="fr"?"Ã‰chec de la mise Ã  jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:ve?async(x,w,P)=>{var T;try{u.info("Regenerating image for page:",x,w?"(scene edited)":"",P?`(${P.length} characters)`:"");const I=await Oe.regenerateImage(ve,x,w,P);if(u.info("Regenerate result:",{hasImageData:!!(I!=null&&I.imageData),length:(T=I==null?void 0:I.imageData)==null?void 0:T.length,versionCount:I==null?void 0:I.versionCount,creditsRemaining:I==null?void 0:I.creditsRemaining}),!(I!=null&&I.imageData))throw u.error("No imageData in response!",I),new Error("No image data returned from server");It(K=>K.map(H=>H.pageNumber===x?{...H,imageData:I.imageData,description:I.newDescription||H.description,prompt:I.newPrompt,qualityScore:I.qualityScore,qualityReasoning:I.qualityReasoning,totalAttempts:I.totalAttempts,retryHistory:I.retryHistory,wasRegenerated:!0,originalImage:I.originalImage,originalScore:I.originalScore,originalReasoning:I.originalReasoning,imageVersions:I.imageVersions}:H)),I.creditsRemaining!==void 0&&A&&A(I.creditsRemaining),u.info("Image regenerated successfully, updated state")}catch(I){u.error("Image regeneration failed:",I);const K=I instanceof Error?I.message:String(I);v(s==="de"?`Bildgenerierung fehlgeschlagen: ${K}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${K}`:`Image regeneration failed: ${K}`)}}:void 0,onDownloadTxt:()=>{const x=new Blob([Dr],{type:"text/plain"}),w=URL.createObjectURL(x),P=document.createElement("a");P.href=w,P.download=`${Ks}.txt`,P.click(),URL.revokeObjectURL(w)},onDownloadPdf:ve?async x=>{try{const w=await Oe.generatePdf(ve,x),P=URL.createObjectURL(w),T=document.createElement("a");T.href=P,T.download=`${Ks}.pdf`,T.click(),URL.revokeObjectURL(P)}catch(w){u.error("PDF download failed:",w),v(s==="de"?"PDF-Download fehlgeschlagen":s==="fr"?"Ã‰chec du tÃ©lÃ©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:ve?()=>{try{const x=sessionStorage.getItem("mystories_selected"),w=x?JSON.parse(x):[];w.includes(ve)||(w.push(ve),sessionStorage.setItem("mystories_selected",JSON.stringify(w))),u.info("Added story to book selection:",ve),C(s==="de"?"Geschichte zum Buch hinzugefÃ¼gt. Du kannst weitere hinzufÃ¼gen oder das Buch bestellen.":s==="fr"?"Histoire ajoutÃ©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",s==="de"?"Zum Buch hinzugefÃ¼gt":s==="fr"?"AjoutÃ© au livre":"Added to Book"),t("/stories")}catch(x){u.error("Failed to add story to selection:",x)}}:void 0,onPrintBook:ve?async()=>{let x=await Yi.getShippingAddress();if(!x){const T=prompt(s==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":s==="fr"?"Aucune adresse enregistrÃ©e. Veuillez entrer (Format: PrÃ©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!T)return;const I=T.split(",").map(K=>K.trim());if(I.length<7){v(s==="de"?"UngÃ¼ltiges Adressformat":s==="fr"?"Format d'adresse invalide":"Invalid address format");return}x={firstName:I[0],lastName:I[1],addressLine1:I[2],postCode:I[3],city:I[4],country:I[5],email:I[6]}}const w=`${x.firstName} ${x.lastName}
${x.addressLine1}
${x.postCode} ${x.city}
${x.country}`,P=s==="de"?`Druckauftrag an folgende Adresse senden?

${w}`:s==="fr"?`Envoyer la commande Ã  cette adresse?

${w}`:`Send print order to this address?

${w}`;if(confirm(P))try{u.info("Creating print order for story:",ve);const T=await Oe.createPrintOrder(ve,{firstName:x.firstName,lastName:x.lastName,addressLine1:x.addressLine1,city:x.city,postCode:x.postCode,country:x.country,email:x.email||""}),I=s==="de"?`âœ… Druckauftrag erfolgreich erstellt!

Order ID: ${T.orderId}
${T.isDraft?"(Entwurf - muss in Gelato bestÃ¤tigt werden)":""}

MÃ¶chten Sie das Gelato Dashboard Ã¶ffnen, um den Auftrag zu verfolgen?`:s==="fr"?`âœ… Commande d'impression crÃ©Ã©e avec succÃ¨s!

ID de commande: ${T.orderId}
${T.isDraft?"(Brouillon - doit Ãªtre confirmÃ© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`âœ… Print order created successfully!

Order ID: ${T.orderId}
${T.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;T.dashboardUrl&&confirm(I)?window.open(T.dashboardUrl,"_blank"):T.dashboardUrl||C(s==="de"?`Druckauftrag erstellt! Order ID: ${T.orderId}`:s==="fr"?`Commande crÃ©Ã©e! ID: ${T.orderId}`:`Print order created! Order ID: ${T.orderId}`)}catch(T){u.error("Print order failed:",T);const I=T instanceof Error?T.message:String(T);v(s==="de"?`Druckauftrag fehlgeschlagen: ${I}`:s==="fr"?`Ã‰chec de la commande d'impression: ${I}`:`Print order failed: ${I}`)}}:void 0,onCreateAnother:()=>{u.info("Creating new story - resetting settings"),Xs(null),js(null),Pe(null);const x=new URLSearchParams(l);x.delete("storyId"),i(x,{replace:!0}),Xr(""),ir(""),es([]),It([]),Mt({frontCover:null,initialPage:null,backCover:null}),Fa(!1),Ra(void 0),Ba(void 0),Ma(void 0),Jt(""),Qt(""),Zt(""),Nr(""),kt("watercolor"),N("standard"),le(30),Nt(""),wt(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),ye(null),Ue("photo"),ne(1)},onRegenerateCover:ve?async(x,w,P,T,I)=>{const K=x==="front"?"frontCover":x==="back"?"backCover":"initialPage";try{u.info("Regenerating cover:",x,w?`with scene: "${w.substring(0,50)}..."`:"",P?`with ${P.length} characters`:""),Ca(U=>new Set(U).add(K));const H=await Oe.regenerateCover(ve,x,w,P,T,I);Mt(U=>U&&{...U,[x==="front"?"frontCover":x==="back"?"backCover":"initialPage"]:{imageData:H.imageData,description:H.description,prompt:H.prompt,qualityScore:H.qualityScore,qualityReasoning:H.qualityReasoning,totalAttempts:H.totalAttempts,retryHistory:H.retryHistory,referencePhotos:H.referencePhotos,wasRegenerated:H.wasRegenerated,regenerationCount:H.regenerationCount,previousImage:H.previousImage,previousScore:H.previousScore,originalImage:H.originalImage,originalScore:H.originalScore,modelId:H.modelId}}),H.creditsRemaining!==void 0&&A&&A(H.creditsRemaining),u.info("Cover regenerated successfully")}catch(H){u.error("Cover regeneration failed:",H);const U=H instanceof Error?H.message:String(H);v(s==="de"?`Cover-Generierung fehlgeschlagen: ${U}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${U}`:`Cover regeneration failed: ${U}`)}finally{Ca(H=>{const U=new Set(H);return U.delete(K),U})}}:void 0,onEditImage:x=>{Cs({type:"image",pageNumber:x}),ss(""),Ss(!0)},onEditCover:x=>{Cs({type:"cover",coverType:x}),ss(""),Ss(!0)},onRepairImage:ve&&((h==null?void 0:h.role)==="admin"||D)?async x=>{var w,P,T;try{u.info("Starting auto-repair for page:",x);const I=Ys.find(U=>U.pageNumber===x);let K=I==null?void 0:I.fixTargets;if(!K||K.length===0){const U=(P=(w=I==null?void 0:I.retryHistory)==null?void 0:w.filter(fe=>fe.type==="auto_repair"))==null?void 0:P.slice(-1)[0];(T=U==null?void 0:U.preRepairEval)!=null&&T.fixTargets&&U.preRepairEval.fixTargets.length>0&&(K=U.preRepairEval.fixTargets,u.info(`Using ${K.length} fix targets from retryHistory.preRepairEval`))}K&&K.length>0?u.info(`Using ${K.length} existing fix targets`):u.info("No stored fix targets found, will re-evaluate");const H=await Oe.repairImage(ve,x,K);H.repaired?(It(U=>U.map(fe=>fe.pageNumber===x?{...fe,imageData:H.imageData,wasAutoRepaired:!0,repairHistory:H.repairHistory,repairedAt:new Date().toISOString()}:fe)),u.info("Auto-repair completed successfully:",{repaired:H.repaired,repairs:H.repairHistory.length})):H.noErrorsFound&&u.info("No physics errors detected in the image")}catch(I){throw u.error("Auto-repair failed:",I),I}}:void 0,onRevertRepair:ve&&((h==null?void 0:h.role)==="admin"||D)?async(x,w)=>{try{u.info("Reverting repair for page:",x),It(P=>P.map(T=>T.pageNumber===x?{...T,imageData:w,wasAutoRepaired:!1}:T)),await Oe.updateSceneImage(ve,x,w),u.info("Repair reverted successfully")}catch(P){throw u.error("Failed to revert repair:",P),P}}:void 0,onSaveStoryText:ve?async x=>{try{u.info("Saving story text for story:",ve),await Oe.saveStoryText(ve,x),Xr(x),u.info("Story text saved successfully")}catch(w){throw u.error("Failed to save story text:",w),w}}:void 0,onSaveTitleChange:ve?async x=>{try{u.info("Saving title for story:",ve,x),await Oe.saveStoryTitle(ve,x),ir(x),u.info("Title saved successfully")}catch(w){throw u.error("Failed to save title:",w),w}}:void 0,userCredits:D?-1:(h==null?void 0:h.credits)||0,imageRegenerationCost:5,isImpersonating:D,onSelectImageVersion:ve?async(x,w)=>{try{u.info("Selecting image version:",{pageNumber:x,versionIndex:w});const P=await Oe.setActiveImage(ve,x,w);It(T=>T.map(I=>{if(I.pageNumber===x&&I.imageVersions){const K=I.imageVersions[w];return{...I,imageData:(K==null?void 0:K.imageData)||I.imageData,imageVersions:I.imageVersions.map((H,U)=>({...H,isActive:U===w}))}}return I})),u.info("Image version selected:",P)}catch(P){throw u.error("Failed to select image version:",P),P}}:void 0,isPartial:Kn,failureReason:Jn,generatedPages:Qn,totalPages:Zn,generationSettings:Yn||void 0})]})}return l.get("storyId")?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(ft,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):nr?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:s==="de"?"Geschichte wird erstellt...":s==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:s==="de"?"Einen Moment Geduld bitte":s==="fr"?"Veuillez patienter":"Please wait a moment"})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Gr,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:f.generateStory}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Bereit, deine Geschichte zu erstellen!":s==="fr"?"PrÃªt Ã  crÃ©er votre histoire!":"Ready to create your story!"}),e.jsxs(Fs,{onClick:()=>yr(),size:"lg",icon:Gr,children:[f.generateStory," (",Q*10," Credits)"]})]});default:return null}};return k?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Di,{currentStep:z,onStepClick:Vt,canAccessStep:ji,developerMode:xe,onDeveloperModeChange:be,hideSteps:z===6&&!!ve,onShowGenerationProgress:()=>{bs(!1),ne(6)}}),e.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:e.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[Z&&!nr?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(ft,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:$?s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story...":s==="de"?"Wird geladen...":s==="fr"?"Chargement...":"Loading..."}),$&&e.jsxs("div",{className:"w-64 mt-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:$.total?`${Math.min(100,$.loaded/$.total*100)}%`:"100%"}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[($.loaded/(1024*1024)).toFixed(1)," MB",$.total&&e.jsxs("span",{children:[" (",Math.round($.loaded/$.total*100),"%)"]})]})]})]}):e.jsxs(e.Fragment,{children:[z>=1&&z<=5&&!j&&e.jsx(so,{step:z,text:(xn[s]||xn.en)[z]}),e.jsx(d.Suspense,{fallback:e.jsx(Ua,{}),children:Ci()})]}),z<6&&!j&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[z===1&&he.length>=2&&!ai()&&(()=>{const n=ni();if(!n)return null;const g=s==="de"?`${n.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:s==="fr"?`${n.name} a des relations non dÃ©finies ("ne connaÃ®t pas")`:`${n.name} has undefined relationships ("not known to")`;return e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"âš ï¸"}),e.jsx("p",{className:"text-amber-700 text-sm",children:g})]})})(),z!==5&&e.jsxs("div",{className:`flex ${z===1?"justify-end":"justify-between"}`,children:[z>1&&e.jsxs("button",{onClick:Wa,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(en,{size:20})," ",f.back]}),e.jsxs("button",{onClick:wi,disabled:!br(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${br()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[f.next," ",e.jsx(Li,{size:20})]})]}),z===5&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:()=>yr(),disabled:!br(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${br()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Gr,{size:20})," ",f.generateStory," (",Q*10," Credits)"]}),xe&&e.jsxs("button",{onClick:()=>yr({skipImages:!0}),disabled:!br(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${br()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Gr,{size:20}),s==="de"?"Nur Text generieren (ohne Bilder)":s==="fr"?"GÃ©nÃ©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),xe&&e.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["ðŸ› ï¸ ",s==="de"?"Entwickler-Optionen - Schritte Ã¼berspringen":s==="fr"?"Options dÃ©veloppeur - Sauter des Ã©tapes":"Developer Options - Skip Steps"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Re,onChange:n=>Y(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Gliederung Ã¼berspringen":s==="fr"?"Sauter le plan":"Skip outline generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Ve,onChange:n=>Se(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Text Ã¼berspringen":s==="fr"?"Sauter le texte":"Skip text generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:qe,onChange:n=>me(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenenbeschreibungen Ã¼berspringen":s==="fr"?"Sauter les descriptions de scÃ¨nes":"Skip scene descriptions"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ue,onChange:n=>W(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Bilder Ã¼berspringen":s==="fr"?"Sauter les images":"Skip image generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ke,onChange:n=>et(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Cover Ã¼berspringen":s==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2",children:s==="de"?"Hinweis: Ãœbersprungene Schritte verwenden Platzhalter/leere Daten":s==="fr"?"Note: Les Ã©tapes sautÃ©es utiliseront des donnÃ©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["ðŸ”§ ",s==="de"?"Feature-Optionen":s==="fr"?"Options de fonctionnalitÃ©s":"Feature Options"]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:He,onChange:n=>gt(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Auto-Reparatur aktivieren":s==="fr"?"Activer la rÃ©paration auto":"Enable auto-repair"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":s==="fr"?"Essaie de corriger automatiquement les erreurs d'image dÃ©tectÃ©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),He&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:bt,onChange:n=>Kt(n.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Grid-Reparatur verwenden":s==="fr"?"Utiliser la rÃ©paration en grille":"Use grid repair"})]}),He&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":s==="fr"?"Extrait les rÃ©gions problÃ©matiques dans une grille, rÃ©pare avec Gemini, vÃ©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),He&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:s==="de"?"Reparatur-Schwelle:":s==="fr"?"Seuil de rÃ©paration:":"Force repair threshold:"}),e.jsxs("select",{value:yt===null?"default":yt,onChange:n=>Ms(n.target.value==="default"?null:parseInt(n.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"default",children:s==="de"?"Standard (nur bei Fehler)":s==="fr"?"DÃ©faut (seulement si erreur)":"Default (only on failure)"}),e.jsx("option",{value:"100",children:s==="de"?"100% (immer reparieren)":s==="fr"?"100% (toujours rÃ©parer)":"100% (always repair)"}),e.jsx("option",{value:"90",children:"90%"}),e.jsx("option",{value:"80",children:"80%"}),e.jsx("option",{value:"75",children:"75%"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die QualitÃ¤tsprÃ¼fung bestehen":s==="fr"?"Ã€ 100%, toutes les pages avec des problÃ¨mes sont rÃ©parÃ©es, mÃªme si elles passent le contrÃ´le qualitÃ©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Or,onChange:n=>ms(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"KonsistenzprÃ¼fung aktivieren":s==="fr"?"Activer la vÃ©rification de cohÃ©rence":"Enable final checks"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft Bilder und Text auf Konsistenz am Ende der Generierung":s==="fr"?"VÃ©rifie la cohÃ©rence des images et du texte Ã  la fin de la gÃ©nÃ©ration":"Checks images and text for consistency at end of generation"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:dr,onChange:n=>a(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Inkrementelle Konsistenz":s==="fr"?"CohÃ©rence incrÃ©mentielle":"Incremental consistency"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft jedes Bild gegen vorherige Bilder wÃ¤hrend der Generierung":s==="fr"?"VÃ©rifie chaque image par rapport aux images prÃ©cÃ©dentes pendant la gÃ©nÃ©ration":"Checks each image against previous images during generation"}),dr&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:Ce,onChange:n=>tt(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur Protokoll (Dry Run)":s==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),dr&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Zeigt nur an, was repariert wÃ¼rde, ohne tatsÃ¤chlich zu reparieren":s==="fr"?"Affiche uniquement ce qui serait rÃ©parÃ© sans effectuer de rÃ©parations":"Shows what would be fixed without actually fixing"}),dr&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-700 text-sm",children:s==="de"?"Vergleichsfenster:":s==="fr"?"FenÃªtre de comparaison:":"Lookback window:"}),e.jsx("input",{type:"range",min:"1",max:"5",value:ge,onChange:n=>Hr(parseInt(n.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),e.jsx("span",{className:"text-gray-600 font-medium w-4",children:ge})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?`Vergleicht jedes Bild mit den ${ge} vorherigen`:s==="fr"?`Compare chaque image avec les ${ge} prÃ©cÃ©dentes`:`Compares each image with the previous ${ge}`})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[e.jsx("input",{type:"checkbox",checked:lt,onChange:n=>Ot(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur PrÃ¼fung (keine Regenerierung)":s==="fr"?"VÃ©rification seule (pas de rÃ©gÃ©nÃ©ration)":"Check only (no regeneration)"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"FÃ¼hrt alle QualitÃ¤tsprÃ¼fungen durch, Ã¼berspringt aber Regenerierung/Reparatur":s==="fr"?"ExÃ©cute toutes les vÃ©rifications de qualitÃ© mais ignore la rÃ©gÃ©nÃ©ration/rÃ©paration":"Runs all quality checks but skips regeneration/repair"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:vt,onChange:n=>cr(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Alle Avatare laden":s==="fr"?"Charger tous les avatars":"Load all avatars"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"LÃ¤dt alle Avatar-Varianten (30MB+). NÃ¼tzlich zum Debuggen.":s==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le dÃ©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),xe&&((h==null?void 0:h.role)==="admin"||D)&&e.jsx(bo,{selections:rt,onChange:jr}),e.jsxs("button",{onClick:Wa,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(en,{size:20})," ",f.back]})]})]})]})}),nr&&!Dr&&!pt&&!ts.frontCover&&!Tn&&e.jsx(ao,{current:Us.current,total:Us.total,message:Us.message,coverImages:ts,characters:he,jobId:ea||void 0,isStalled:zn,onDismissStalled:()=>Ir(!1),isImpersonating:D,onMinimize:()=>Vs(!0),onCancel:ea?async()=>{try{await Oe.cancelJob(ea),u.info("Job cancelled by user"),$r(!1),js(null),Ir(!1),fr({current:0,total:0,message:""}),E(s==="de"?"Generierung abgebrochen":s==="fr"?"GÃ©nÃ©ration annulÃ©e":"Generation cancelled")}catch(n){u.error("Failed to cancel job:",n),v(s==="de"?"Abbruch fehlgeschlagen":s==="fr"?"Ã‰chec de l'annulation":"Failed to cancel")}}:void 0}),$n&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Geschichte wird im Hintergrund generiert":s==="fr"?"Histoire en cours de gÃ©nÃ©ration":"Story generating in background"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Was mÃ¶chtest du tun?":s==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{bs(!0),Vs(!1),t("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Neue Geschichte erstellen":s==="fr"?"CrÃ©er une autre histoire":"Create another story"}),Dn&&e.jsx("button",{onClick:()=>{bs(!0),Vs(!1),t("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Meine Geschichten lesen":s==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),In&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Nur ein Charakter":s==="fr"?"Un seul personnage":"Only One Character"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":s==="fr"?"Les histoires sont plus intÃ©ressantes avec plusieurs personnages. Vous n'avez crÃ©Ã© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{qs(!1),la()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Weiteren Charakter erstellen":s==="fr"?"CrÃ©er un autre personnage":"Create another character"}),e.jsx("button",{onClick:async()=>{qs(!1),await Vt(z+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Trotzdem weiter":s==="fr"?"Continuer quand mÃªme":"Continue anyway"})]})]})}),Pn&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[e.jsx("div",{className:"relative inline-block mb-4",children:e.jsx(ft,{size:40,className:"animate-spin text-indigo-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s==="de"?"Bild wird erstellt...":s==="fr"?"CrÃ©ation de l'image...":"Generating image..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:s==="de"?"Dies dauert etwa 30 Sekunden":s==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),Xn&&Je&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:s==="de"?"Bild bearbeiten":s==="fr"?"Modifier l'image":"Edit Image"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:Je.type==="image"?s==="de"?`Seite ${Je.pageNumber}`:s==="fr"?`Page ${Je.pageNumber}`:`Page ${Je.pageNumber}`:s==="de"?Je.coverType==="front"?"Titelseite":Je.coverType==="back"?"RÃ¼ckseite":"Einleitungsseite":s==="fr"?Je.coverType==="front"?"Couverture":Je.coverType==="back"?"Dos":"Page de dÃ©dicace":Je.coverType==="front"?"Front Cover":Je.coverType==="back"?"Back Cover":"Dedication Page"}),e.jsx("textarea",{value:rs,onChange:n=>ss(n.target.value),placeholder:s==="de"?`Beschreibe die gewÃ¼nschte Ã„nderung...
z.B. "Mach den Himmel blauer" oder "FÃ¼ge einen Schmetterling hinzu"`:s==="fr"?`DÃ©crivez le changement souhaitÃ©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{onClick:()=>{Ss(!1),Cs(null),ss("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:s==="de"?"Abbrechen":s==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:async()=>{if(!(!rs.trim()||!ve)){Ss(!1),ka(!0);try{if(Je.type==="image"&&Je.pageNumber){const n=await Oe.editImage(ve,Je.pageNumber,rs);if(u.info("Edit result:",{hasImageData:!!(n!=null&&n.imageData),score:n==null?void 0:n.qualityScore}),!(n!=null&&n.imageData))throw u.error("No imageData in edit response!",n),new Error("No image data returned from server");It(g=>g.map(c=>c.pageNumber===Je.pageNumber?{...c,imageData:n.imageData,qualityScore:n.qualityScore,qualityReasoning:n.qualityReasoning,wasEdited:!0,originalImage:n.originalImage,originalScore:n.originalScore,originalReasoning:n.originalReasoning}:c)),u.info("Image edited successfully, updated state with quality info")}else if(Je.type==="cover"&&Je.coverType){const n=await Oe.editCover(ve,Je.coverType,rs);Mt(g=>{if(!g)return g;const c=Je.coverType==="front"?"frontCover":Je.coverType==="back"?"backCover":"initialPage",S=g[c],x={...typeof S=="object"?S:{},imageData:n.imageData,qualityScore:n.qualityScore,qualityReasoning:n.qualityReasoning,wasEdited:!0,originalImage:n.originalImage,originalScore:n.originalScore,originalReasoning:n.originalReasoning};return{...g,[c]:x}}),u.info("Cover edited successfully with quality info")}}catch(n){u.error("Edit failed:",n),v(s==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de la modification. Veuillez rÃ©essayer.":"Edit failed. Please try again.")}finally{ka(!1),Cs(null),ss("")}}},disabled:!rs.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:s==="de"?"Bearbeiten":s==="fr"?"Modifier":"Edit"})]})]})}),e.jsx(ko,{isOpen:Ls,faces:ur,onSelect:li,onUploadNew:di,developerMode:xe}),e.jsx(No,{isOpen:En,onClose:()=>ys(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const n=localStorage.getItem("verificationGenerationStarted");if(n){const g=parseInt(n,10),c=Date.now()-120*1e3;if(g>c){console.log("[EmailVerification] Another window started recently, skipping"),ys(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),yr({skipEmailCheck:!0}),ys(!1)}})]}):e.jsx(Ua,{fullScreen:!0})}const gl=Object.freeze(Object.defineProperty({__proto__:null,default:Mo},Symbol.toStringTag,{value:"Module"}));export{io as I,Qi as S,Zi as U,Rr as a,yn as b,Ie as c,al as d,dl as e,So as f,wo as g,cl as h,cn as i,ol as j,ml as k,il as l,ll as m,ul as n,un as o,gn as p,nl as q,va as r,sl as s,hn as t,rl as u,pa as v,gl as w};
