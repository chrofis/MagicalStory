import{c as de,s as K,j as e,L as xe,C as he,T as _e}from"./index-Z-lQ-nSh.js";import{b as p}from"./vendor-react-CqfXSjHo.js";import{I as Le}from"./ImageLightbox-C2xNnLcf.js";import{W as Oe}from"./wrench-MHqRiUbu.js";import{R as Ge}from"./rotate-ccw-D0blr0hY.js";import{C as Pe}from"./chevron-down-DqC-tVz-.js";import{C as Ie}from"./chevron-right-BNt_wdWx.js";import{S as $e}from"./square-BuIZHixq.js";import{S as We}from"./search-BHxbosBG.js";import{C as Te}from"./circle-x-A0R27HUw.js";import{U as Fe}from"./Input-BbHCDbuX.js";import{I as qe,R as Ve}from"./Modal-BP-IM4BE.js";import"./vendor-firebase-DTVMaYMy.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=de("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=de("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=de("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=de("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=de("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function Ae(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending","cover-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{},pagesFailed:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const me=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair","cover-repair"];function Je({storyId:c,sceneImages:P,characters:te,finalChecksReport:W,imageModel:G,onImageUpdate:D}){const[b,F]=p.useState(Ae),[ee,V]=p.useState({current:0,total:0,currentPage:void 0}),h=p.useRef(null),[_,ae]=p.useState(!1),re=p.useMemo(()=>Object.values(b.stepStatus).some(a=>a==="in-progress"),[b.stepStatus]),H=p.useMemo(()=>me.indexOf(b.currentStep),[b.currentStep]),I=p.useCallback(a=>{F(r=>({...r,currentStep:a,stepStatus:{...r.stepStatus,[a]:"in-progress"}}))},[]),J=p.useCallback((a,r)=>{F(l=>({...l,stepStatus:{...l.stepStatus,[a]:"completed"},...a==="collect-feedback"&&r?{collectedFeedback:r}:{},...a==="re-evaluate"&&r?{reEvaluationResults:r}:{},...a==="consistency-check"&&r?{consistencyResults:r}:{}}))},[]),O=p.useCallback((a,r)=>{F(l=>({...l,stepStatus:{...l.stepStatus,[a]:"failed"}}))},[]),u=p.useCallback(a=>{F(r=>({...r,stepStatus:{...r.stepStatus,[a]:"skipped"}}))},[]),C=p.useCallback(()=>{F(Ae()),V({current:0,total:0,currentPage:void 0}),ae(!1),h.current=null},[]),be=p.useCallback(()=>{var a;console.log("[useRepairWorkflow] Aborting workflow"),(a=h.current)==null||a.abort(),ae(!0)},[]),le=p.useCallback(async()=>{var a,r,l,m,k;if(c){I("collect-feedback");try{const i={};let o=0;for(const n of P){const N={pageNumber:n.pageNumber,qualityScore:n.qualityScore,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},j=(a=n.retryHistory)==null?void 0:a.slice(-1)[0];if((r=j==null?void 0:j.postRepairEval)!=null&&r.fixableIssues?N.fixableIssues=j.postRepairEval.fixableIssues:(l=j==null?void 0:j.preRepairEval)!=null&&l.fixableIssues&&(N.fixableIssues=j.preRepairEval.fixableIssues),W!=null&&W.entity){for(const[A,S]of Object.entries(W.entity.characters||{})){const x=[];if(S.byClothing)for(const R of Object.values(S.byClothing))R.issues&&x.push(...R.issues);S.issues&&x.push(...S.issues);const T=x.filter(R=>{var q;return((q=R.pagesToFix)==null?void 0:q.includes(n.pageNumber))||R.pageNumber===n.pageNumber});for(const R of T)N.entityIssues.push({character:A,issue:R.description,severity:R.severity})}for(const[A,S]of Object.entries(W.entity.objects||{})){const x=[];if(S.byClothing)for(const R of Object.values(S.byClothing))R.issues&&x.push(...R.issues);S.issues&&x.push(...S.issues);const T=x.filter(R=>{var q;return((q=R.pagesToFix)==null?void 0:q.includes(n.pageNumber))||R.pageNumber===n.pageNumber});for(const R of T)N.objectIssues.push({object:A,issue:R.description,severity:R.severity})}}if(W!=null&&W.imageChecks)for(const A of W.imageChecks)for(const S of A.issues||[])(((m=S.pagesToFix)==null?void 0:m.includes(n.pageNumber))||((k=S.images)==null?void 0:k.includes(n.pageNumber)))&&N.semanticIssues.push({type:S.type,description:S.description,severity:S.severity,characterInvolved:S.characterInvolved,recommendation:S.recommendation});o+=N.fixableIssues.length+N.entityIssues.length+N.objectIssues.length+N.semanticIssues.length,i[n.pageNumber]=N}J("collect-feedback",{pages:i,totalIssues:o})}catch(i){console.error("Failed to collect feedback:",i),O("collect-feedback",i instanceof Error?i.message:"Unknown error")}}},[c,P,W,I,J,O]),fe=p.useCallback((a,r)=>{F(l=>({...l,collectedFeedback:{...l.collectedFeedback,pages:{...l.collectedFeedback.pages,[a]:{...l.collectedFeedback.pages[a],...r}}}}))},[]),pe=p.useCallback((a,r)=>{F(l=>{const m=l.redoPages.pageNumbers.includes(a),k=m?l.redoPages.pageNumbers.filter(o=>o!==a):[...l.redoPages.pageNumbers,a].sort((o,n)=>o-n),i={...l.redoPages.reasons};return m?delete i[a]:r&&(i[a]=r),{...l,redoPages:{pageNumbers:k,reasons:i}}})},[]),ye=p.useCallback((a=6,r=3)=>{I("identify-redo-pages");const l=[],m={};for(const[k,i]of Object.entries(b.collectedFeedback.pages)){const o=parseInt(k),n=i.fixableIssues.length+i.entityIssues.length,N=i.qualityScore??10;N<a?(l.push(o),m[o]=`Low quality score: ${N}`):n>=r?(l.push(o),m[o]=`Too many issues: ${n}`):i.needsFullRedo&&(l.push(o),m[o]="Manually marked for redo")}F(k=>({...k,redoPages:{pageNumbers:l.sort((i,o)=>i-o),reasons:m},stepStatus:{...k.stepStatus,"identify-redo-pages":"completed"}}))},[b.collectedFeedback.pages,I]),je=p.useCallback(async a=>{var k;if(!c||b.redoPages.pageNumbers.length===0)return;I("redo-pages");const r=b.redoPages.pageNumbers;V({current:0,total:r.length,currentPage:void 0});const l=[],m={};try{for(let i=0;i<r.length;i++){const o=r[i];V({current:i,total:r.length,currentPage:o});try{const n=await K.iteratePage(c,o,G,{useOriginalAsReference:a==null?void 0:a.useOriginalAsReference});if(n.success){l.push(o);const N=P.find(A=>A.pageNumber===o),j=((k=N==null?void 0:N.imageVersions)==null?void 0:k.length)??0;m[o]=j,D&&D(o,n.imageData,j)}}catch(n){console.error(`Failed to redo page ${o}:`,n)}}F(i=>({...i,redoResults:{pagesCompleted:l,newVersions:m},stepStatus:{...i.stepStatus,"redo-pages":"completed"}})),V({current:r.length,total:r.length,currentPage:void 0})}catch(i){console.error("Redo pages failed:",i),O("redo-pages",i instanceof Error?i.message:"Unknown error")}},[c,b.redoPages.pageNumbers,G,P,D,I,O]),U=p.useCallback(async a=>{if(!c)return;I("re-evaluate");const r=a??b.redoResults.pagesCompleted;if(r.length===0){u("re-evaluate");return}try{const l=await K.reEvaluatePages(c,r),m={};for(const[k,i]of Object.entries(l.pages||{})){const o=i;m[parseInt(k)]={qualityScore:o.qualityScore,rawScore:o.rawScore,verdict:o.verdict,issuesSummary:o.issuesSummary,reasoning:o.reasoning,fixableIssues:o.fixableIssues}}J("re-evaluate",{pages:m})}catch(l){console.error("Re-evaluation failed:",l),O("re-evaluate",l instanceof Error?l.message:"Unknown error")}},[c,b.redoResults.pagesCompleted,I,J,O,u]),ce=p.useCallback(async()=>{if(c){I("consistency-check");try{const a=await K.runEntityConsistency(c);J("consistency-check",{report:a.report})}catch(a){console.error("Consistency check failed:",a),O("consistency-check",a instanceof Error?a.message:"Unknown error")}}},[c,I,J,O]),ne=p.useCallback(async(a,r,l)=>{var m,k,i,o;if(!(!c||r.length===0)){I("character-repair");try{const n=await K.repairCharacters(c,[{character:a,pages:r}],l),N=((k=(m=n.results)==null?void 0:m[0])==null?void 0:k.pagesRepaired)||[],j=((o=(i=n.results)==null?void 0:i[0])==null?void 0:o.pagesFailed)||[];for(const x of N)if(x.imageData&&D)try{D(x.pageNumber,x.imageData,x.versionIndex)}catch(T){console.error(`[RepairWorkflow] Failed to notify parent of image update for page ${x.pageNumber}:`,T)}j.length>0&&console.warn(`[RepairWorkflow] ${j.length} pages failed repair for ${a}:`,j.map(x=>`page ${x.pageNumber}: ${x.reason}`).join(", "));const A=N.map(x=>typeof x=="number"?x:x.pageNumber),S=j.map(x=>({pageNumber:x.pageNumber,reason:x.reason,rejected:x.rejected}));F(x=>({...x,characterRepairResults:{charactersProcessed:[...x.characterRepairResults.charactersProcessed,a],pagesRepaired:{...x.characterRepairResults.pagesRepaired,[a]:A},pagesFailed:{...x.characterRepairResults.pagesFailed,[a]:S}},stepStatus:{...x.stepStatus,"character-repair":j.length>0&&N.length===0?"failed":"completed"}}))}catch(n){console.error("Character repair failed:",n),O("character-repair",n instanceof Error?n.message:"Unknown error")}}},[c,I,O,D]),ie=p.useCallback(async a=>{if(!(!c||a.length===0)){I("artifact-repair");try{const r=await K.repairArtifacts(c,a);F(l=>({...l,artifactRepairResults:{pagesProcessed:r.pagesProcessed||a,issuesFixed:r.issuesFixed||0},stepStatus:{...l.stepStatus,"artifact-repair":"completed"}}))}catch(r){console.error("Artifact repair failed:",r),O("artifact-repair",r instanceof Error?r.message:"Unknown error")}}},[c,I,O]),[Ne,oe]=p.useState({current:0,total:0,currentCover:void 0}),z=p.useCallback(async a=>{if(!c||a.length===0)return;I("cover-repair"),oe({current:0,total:a.length,currentCover:void 0});const r=[];try{for(let l=0;l<a.length;l++){const m=a[l];oe({current:l,total:a.length,currentCover:m});try{await K.regenerateCover(c,m),r.push(m)}catch(k){console.error(`Failed to regenerate ${m} cover:`,k)}}F(l=>({...l,stepStatus:{...l.stepStatus,"cover-repair":r.length>0?"completed":"failed"}})),oe({current:a.length,total:a.length,currentCover:void 0})}catch(l){console.error("Cover repair failed:",l),O("cover-repair",l instanceof Error?l.message:"Unknown error")}},[c,I,O]),ve=p.useCallback(a=>{const r=me.indexOf(a);if(a==="idle")return!0;if(re)return!1;switch(a){case"collect-feedback":return!0;case"identify-redo-pages":return b.stepStatus["collect-feedback"]==="completed";case"redo-pages":return b.redoPages.pageNumbers.length>0;case"re-evaluate":return b.stepStatus["redo-pages"]==="completed"||b.stepStatus["redo-pages"]==="skipped";case"consistency-check":return r>me.indexOf("collect-feedback");case"character-repair":return b.stepStatus["consistency-check"]==="completed";case"artifact-repair":return b.stepStatus["collect-feedback"]==="completed";case"cover-repair":return!0;default:return!1}},[b,re]),we=p.useCallback(a=>{const r=me.indexOf(a);return r>0?r:0},[]),ke=p.useCallback(()=>Object.entries(b.collectedFeedback.pages).filter(([a,r])=>{const l=r.qualityScore??10,m=r.fixableIssues.length+r.entityIssues.length;return l<7||m>0||r.needsFullRedo}).map(([a])=>parseInt(a)).sort((a,r)=>a-r),[b.collectedFeedback.pages]),Se=p.useCallback(()=>{const a=b.consistencyResults.report;return a!=null&&a.characters?Object.entries(a.characters).filter(([r,l])=>{var m;return"overallConsistent"in l?!l.overallConsistent||(l.totalIssues??0)>0:!l.consistent||(((m=l.issues)==null?void 0:m.length)??0)>0}).map(([r])=>r):[]},[b.consistencyResults.report]),ue=p.useCallback(a=>{var k;const r=b.consistencyResults.report;if(!((k=r==null?void 0:r.characters)!=null&&k[a]))return[];const l=r.characters[a],m=new Set;if(l.byClothing){for(const i of Object.values(l.byClothing))for(const o of i.issues||[])if(o.severity==="major"||o.severity==="critical"){for(const n of o.pagesToFix||[])m.add(n);o.pageNumber&&m.add(o.pageNumber)}}if(l.issues){for(const i of l.issues)if(i.severity==="major"||i.severity==="critical"){for(const o of i.pagesToFix||[])m.add(o);i.pageNumber&&m.add(i.pageNumber)}}return Array.from(m).sort((i,o)=>i-o)},[b.consistencyResults.report]),Ce=p.useCallback(async(a={})=>{var A,S,x;if(!c)return;const r=6,l=3,m=4,{scoreThreshold:k=r,issueThreshold:i=l,maxRetries:o=m,onProgress:n}=a;h.current=new AbortController,ae(!1);const N=h.current.signal,j=()=>{if(N.aborted)throw console.log("[useRepairWorkflow] Workflow aborted"),new Error("Workflow aborted")};try{j(),n==null||n("collect-feedback","Collecting existing issues..."),await le(),j(),n==null||n("re-evaluate","Evaluating all pages...");const T=await K.reEvaluatePages(c,P.map(w=>w.pageNumber)),R={};for(const[w,y]of Object.entries(T.pages||{})){const s=y;R[parseInt(w)]=s}j(),n==null||n("identify-redo-pages","Identifying pages needing redo...");const q=[];for(const[w,y]of Object.entries(R)){const s=parseInt(w),t=y.rawScore??Math.round(y.qualityScore/10);t>10&&console.error(`[RepairWorkflow] Invalid rawScore scale for page ${s}: ${t} (expected 0-10)`);const d=((A=y.fixableIssues)==null?void 0:A.length)??0;(t<k||d>=i)&&q.push(s)}q.sort((w,y)=>w-y),F(w=>({...w,redoPages:{pageNumbers:q,reasons:{}},stepStatus:{...w.stepStatus,"identify-redo-pages":"completed"}})),j();const B=[];if(q.length>0){n==null||n("redo-pages",`Redoing ${q.length} pages...`),I("redo-pages");const w={};for(let y=0;y<q.length;y++){j();const s=q[y];let t=0,d="",f=0;for(let g=1;g<=o;g++){j(),n==null||n("redo-pages",`Page ${s}: attempt ${g}/${o}`),V({current:y,total:q.length,currentPage:s});try{const v=await K.iteratePage(c,s,G);if(v.success){const M=v.qualityScore??0;if(M>t){t=M,d=v.imageData;const L=P.find(Z=>Z.pageNumber===s);f=(((S=L==null?void 0:L.imageVersions)==null?void 0:S.length)??0)+g-1}if(M>=k*10)break}}catch(v){console.error(`Failed to redo page ${s} attempt ${g}:`,v)}}d&&(w[s]={score:t,imageData:d,versionIndex:f},B.push(s),D==null||D(s,d,f))}F(y=>({...y,redoResults:{pagesCompleted:B,newVersions:Object.fromEntries(Object.entries(w).map(([s,t])=>[s,t.versionIndex]))},stepStatus:{...y.stepStatus,"redo-pages":"completed"}}))}B.length>0&&(j(),n==null||n("re-evaluate","Re-evaluating redone pages..."),await U(B)),j(),n==null||n("consistency-check","Running consistency check...");const se=(await K.runEntityConsistency(c)).report;if(F(w=>({...w,consistencyResults:{report:se},stepStatus:{...w.stepStatus,"consistency-check":"completed"}})),j(),se!=null&&se.characters){const w=Object.entries(se.characters).filter(([y,s])=>{var t;return"overallConsistent"in s?!s.overallConsistent||(s.totalIssues??0)>0:!s.consistent||(((t=s.issues)==null?void 0:t.length)??0)>0}).map(([y])=>y);if(w.length>0){n==null||n("character-repair",`Repairing ${w.length} characters...`);for(const y of w){j();const s=se.characters[y],t=new Set;if(s.byClothing){for(const f of Object.values(s.byClothing))for(const g of f.issues||[])if(g.severity==="major"||g.severity==="critical"){for(const v of g.pagesToFix||[])t.add(v);g.pageNumber&&t.add(g.pageNumber)}}if(s.issues){for(const f of s.issues)if(f.severity==="major"||f.severity==="critical"){for(const g of f.pagesToFix||[])t.add(g);f.pageNumber&&t.add(f.pageNumber)}}const d=Array.from(t).sort((f,g)=>f-g);d.length>0&&(n==null||n("character-repair",`Repairing ${y} on ${d.length} pages...`),await ne(y,d))}}}j();const X=[];for(const[w,y]of Object.entries(R))(x=y.fixableIssues)!=null&&x.some(s=>s.type==="artifact"||s.type==="distortion")&&X.push(parseInt(w));X.length>0&&(n==null||n("artifact-repair",`Repairing artifacts on ${X.length} pages...`),await ie(X)),n==null||n("complete","Workflow complete!")}catch(T){if(T instanceof Error&&T.message==="Workflow aborted"){console.log("[useRepairWorkflow] Workflow was aborted by user");return}throw console.error("Full workflow failed:",T),T}finally{h.current=null}},[c,P,G,D,le,U,I,V,ce,ne,ie]);return{workflowState:b,isRunning:re,currentStepIndex:H,startStep:I,completeStep:J,failStep:O,skipStep:u,resetWorkflow:C,collectFeedback:le,updatePageFeedback:fe,toggleRedoPage:pe,autoIdentifyRedoPages:ye,redoMarkedPages:je,redoProgress:ee,reEvaluatePages:U,runConsistencyCheck:ce,repairCharacter:ne,repairArtifacts:ie,regenerateCovers:z,coverRepairProgress:Ne,runFullWorkflow:Ce,abortWorkflow:be,isAborted:_,canProceedToStep:ve,getStepNumber:we,getPagesNeedingAttention:ke,getCharactersWithIssues:Se,getPagesWithSevereIssuesForCharacter:ue}}const Y={idle:{label:"Ready",icon:Me,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:We,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:_e,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:Ve,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:he,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:Fe,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:Fe,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:De,description:"Fix remaining artifacts via grid repair"},"cover-repair":{label:"8. Cover Repair",icon:qe,description:"Regenerate front, back, or dedication covers"}};function Be({status:c}){const P={pending:{color:"bg-gray-100 text-gray-600",icon:Me},"in-progress":{color:"bg-blue-100 text-blue-600",icon:xe},completed:{color:"bg-green-100 text-green-600",icon:he},skipped:{color:"bg-yellow-100 text-yellow-600",icon:Ue},failed:{color:"bg-red-100 text-red-600",icon:Te}},{color:te,icon:W}=P[c],G=c==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${te}`,children:[e.jsx(W,{className:`w-3 h-3 ${G?"animate-spin":""}`}),c]})}function Qe({feedback:c,isMarkedForRedo:P,onToggleRedo:te,onUpdateNotes:W}){var ee,V;const[G,D]=p.useState(!1),b=c.fixableIssues.length+c.entityIssues.length+(((ee=c.objectIssues)==null?void 0:ee.length)||0)+(((V=c.semanticIssues)==null?void 0:V.length)||0),F=b>0||c.qualityScore!==void 0&&c.qualityScore<7;return e.jsxs("div",{className:`border rounded-lg p-3 ${P?"border-red-300 bg-red-50":F?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>D(!G),className:"p-1 hover:bg-gray-100 rounded",children:G?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Ie,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",c.pageNumber]}),c.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${c.qualityScore>=8?"bg-green-100 text-green-700":c.qualityScore>=6?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",c.qualityScore]}),b>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[b," issues"]})]}),e.jsx("button",{onClick:te,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${P?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:P?"Marked for Redo":"Mark for Redo"})]}),G&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[c.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",c.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.fixableIssues.map((h,_)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${h.severity==="critical"?"bg-red-100 text-red-700":h.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:h.severity}),e.jsxs("span",{children:["[",h.type,"] ",h.description]})]},_))})]}),c.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",c.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.entityIssues.map((h,_)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:h.character}),e.jsx("span",{className:`px-1 rounded ${h.severity==="critical"?"bg-red-100 text-red-700":h.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:h.severity}),e.jsx("span",{children:h.issue})]},_))})]}),c.objectIssues&&c.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",c.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.objectIssues.map((h,_)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:h.object}),e.jsx("span",{className:`px-1 rounded ${h.severity==="critical"?"bg-red-100 text-red-700":h.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:h.severity}),e.jsx("span",{children:h.issue})]},_))})]}),c.semanticIssues&&c.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",c.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.semanticIssues.map((h,_)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:h.type.replace(/_/g," ")}),h.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:h.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${h.severity==="high"?"bg-red-100 text-red-700":h.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:h.severity}),e.jsx("span",{children:h.description})]},_))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:c.manualNotes,onChange:h=>W(h.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}const Re="repair-workflow-autorun-completed";function is({storyId:c,sceneImages:P,characters:te,finalChecksReport:W,imageModel:G,onImageUpdate:D,onRefreshStory:b,autoRunFullWorkflow:F=!1,onAutoRunComplete:ee,developerMode:V=!1,useMagicApiRepair:h=!1,setUseMagicApiRepair:_}){const[ae,re]=p.useState(!0),[H,I]=p.useState(new Set(["collect-feedback"])),[J,O]=p.useState(null),{workflowState:u,isRunning:C,resetWorkflow:be,collectFeedback:le,updatePageFeedback:fe,toggleRedoPage:pe,autoIdentifyRedoPages:ye,redoMarkedPages:je,redoProgress:U,reEvaluatePages:ce,runConsistencyCheck:ne,repairCharacter:ie,repairArtifacts:Ne,regenerateCovers:oe,coverRepairProgress:z,runFullWorkflow:ve,abortWorkflow:we,isAborted:ke,getStepNumber:Se,getCharactersWithIssues:ue,getPagesWithSevereIssuesForCharacter:Ce}=Je({storyId:c,sceneImages:P,characters:te,finalChecksReport:W,imageModel:G,onImageUpdate:D}),[a,r]=p.useState(null),[l,m]=p.useState(!1),k=p.useRef(null),i=s=>{try{return JSON.parse(localStorage.getItem(Re)||"[]").includes(s)}catch{return!1}},o=s=>{try{const t=JSON.parse(localStorage.getItem(Re)||"[]");if(!t.includes(s)){t.push(s);const d=t.slice(-10);localStorage.setItem(Re,JSON.stringify(d))}}catch(t){console.error("[RepairWorkflowPanel] Failed to save auto-run completion:",t)}};p.useEffect(()=>{if(F&&c&&P.length>0&&!C&&!l){const s=k.current===c,t=i(c);!s&&!t?(k.current=c,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",c),setTimeout(async()=>{await n(),o(c),ee==null||ee()},500)):console.log("[RepairWorkflowPanel] Skipping auto-run - already completed for story:",c,{alreadyRunThisSession:s,alreadyCompletedPreviously:t})}},[F,c,P.length,C,l]);const n=async()=>{m(!0);try{await ve({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(s,t)=>{r({step:s,detail:t})}}),b&&await b()}catch(s){console.error("Full workflow failed:",s)}finally{m(!1),r(null)}},[N,j]=p.useState(""),[A,S]=p.useState([]),[x,T]=p.useState([]),[R,q]=p.useState(!1),[B,Ee]=p.useState([]),se=s=>{I(t=>{const d=new Set(t);return d.has(s)?d.delete(s):d.add(s),d})},X=p.useMemo(()=>ue(),[ue]),w=p.useMemo(()=>{var t;const s=new Set;for(const[d,f]of Object.entries(u.collectedFeedback.pages))f.fixableIssues.some(g=>g.type==="artifact"||g.type==="distortion")&&s.add(parseInt(d));for(const[d,f]of Object.entries(u.reEvaluationResults.pages))(t=f.fixableIssues)!=null&&t.some(g=>g.type==="artifact"||g.type==="distortion")&&s.add(parseInt(d));return Array.from(s).sort((d,f)=>d-f)},[u.collectedFeedback.pages,u.reEvaluationResults.pages]),y=s=>{const t=Y[s],d=t.icon,f=u.stepStatus[s],g=H.has(s),v=Se(s);return e.jsxs("button",{onClick:()=>se(s),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${f==="in-progress"?"bg-blue-50":f==="completed"?"bg-green-50":f==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:v}),e.jsx(d,{className:`w-4 h-4 ${f==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:t.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{status:f}),g?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Ie,{className:"w-4 h-4"})]})]})};return c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>re(!ae),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Oe,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),u.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[u.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(xe,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:s=>{s.stopPropagation(),be()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(Ge,{className:"w-4 h-4 text-amber-700"})}),ae?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Ie,{className:"w-4 h-4"})]})]}),ae&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsxs("button",{onClick:()=>{we(),m(!1),r(null)},className:"flex items-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium",title:"Stop the workflow",children:[e.jsx($e,{className:"w-5 h-5"}),"Stop"]}),e.jsx("button",{onClick:n,disabled:C||l,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:l?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-5 h-5"}),"Run Full Workflow"]})})]})]}),a&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(xe,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[a.step,":"]}),e.jsx("span",{className:"text-purple-600",children:a.detail})]})}),ke&&!l&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx($e,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Workflow stopped"})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("collect-feedback"),H.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["collect-feedback"].description}),e.jsxs("button",{onClick:le,disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(We,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(u.collectedFeedback.pages).length>0&&(()=>{const s=Object.values(u.collectedFeedback.pages),t=s.reduce((E,$)=>E+$.fixableIssues.length,0),d=s.reduce((E,$)=>E+$.entityIssues.length,0),f=s.reduce((E,$)=>{var Q;return E+(((Q=$.objectIssues)==null?void 0:Q.length)||0)},0),g=s.reduce((E,$)=>{var Q;return E+(((Q=$.semanticIssues)==null?void 0:Q.length)||0)},0),v=t+d+f+g,M=Object.values(u.reEvaluationResults.pages),L=M.reduce((E,$)=>{var Q;return E+(((Q=$.fixableIssues)==null?void 0:Q.length)||0)},0),Z=M.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",v," issues from generation + ",Z?`${L} from re-evaluation`:"re-evaluate for fresh data"]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[t>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",t]}),d>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",d]}),f>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",f]}),g>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",g]}),Z&&L>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",L]}),v===0&&!Z&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"No issues detected (run re-evaluate for fresh assessment)"}),v===0&&Z&&L===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:s.sort((E,$)=>E.pageNumber-$.pageNumber).map(E=>e.jsx(Qe,{feedback:E,isMarkedForRedo:u.redoPages.pageNumbers.includes(E.pageNumber),onToggleRedo:()=>pe(E.pageNumber),onUpdateNotes:$=>fe(E.pageNumber,{manualNotes:$})},E.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("identify-redo-pages"),H.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>ye(6,3),disabled:C||u.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ge,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),u.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",u.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:u.redoPages.pageNumbers.map(s=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:u.redoPages.reasons[s],children:["Page ",s,e.jsx("button",{onClick:()=>pe(s),className:"hover:text-red-900",children:e.jsx(Te,{className:"w-3 h-3"})})]},s))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("redo-pages"),H.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["redo-pages"].description}),e.jsxs("label",{className:"flex items-start gap-2 p-2 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:s=>q(s.target.checked),className:"mt-0.5",disabled:C}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Use original as reference"}),e.jsx("p",{className:"text-xs text-blue-600",children:"Passes the current image to Gemini as reference â€” preserves composition, fixes details"})]})]}),e.jsxs("button",{onClick:()=>je({useOriginalAsReference:R}),disabled:C||u.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(He,{className:"w-4 h-4"}),"Redo ",u.redoPages.pageNumbers.length," Pages",R&&e.jsx("span",{className:"text-xs opacity-75",children:"(with reference)"})]}),U.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",U.current," / ",U.total]}),U.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",U.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${U.current/U.total*100}%`}})})]}),u.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",u.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:u.redoResults.pagesCompleted.map(s=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",s," (v",u.redoResults.newVersions[s]??"?",")"]},s))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("re-evaluate"),H.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[u.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>ce(),disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(he,{className:"w-4 h-4"}),"Re-evaluate ",u.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>ce(P.map(s=>s.pageNumber)),disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(he,{className:"w-4 h-4"}),"Re-evaluate All ",P.length," Pages"]})]}),Object.keys(u.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(u.reEvaluationResults.pages).map(([s,t])=>{var v,M,L,Z,E;const d=t.score??t.qualityScore,f=t.qualityScore,g=t.semanticScore;return t.score===null&&t.qualityScore!==null&&console.warn(`[RepairWorkflow] Page ${s}: Missing combined score, using qualityScore fallback`),e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-medium",children:["Page ",s,":"]}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:["Quality: ",f,"%"]}),g!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",g,"%"]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${d>=70?"bg-green-100 text-green-700":d>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",d,"%"]}),t.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${t.verdict==="PASS"?"bg-green-100 text-green-700":t.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:t.verdict}),t.fixableIssues&&t.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",t.fixableIssues.length," fixable issues)"]})]}),t.issuesSummary&&t.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${t.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:t.issuesSummary}),t.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["ðŸ” Semantic Analysis (Score: ",t.semanticResult.score??"N/A","):"]}),t.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸ‘ï¸ Visible:"}),t.semanticResult.visible.characters&&t.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",t.semanticResult.visible.characters.join(", ")]}),t.semanticResult.visible.objects&&t.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",t.semanticResult.visible.objects.join(", ")]}),t.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",t.semanticResult.visible.setting]}),t.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",t.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸŽ¯ Expected:"}),((v=t.semanticResult.expected)==null?void 0:v.characters)&&t.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",t.semanticResult.expected.characters.join(", ")]}),((M=t.semanticResult.expected)==null?void 0:M.objects)&&t.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",t.semanticResult.expected.objects.join(", ")]}),((L=t.semanticResult.expected)==null?void 0:L.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",t.semanticResult.expected.setting]}),((Z=t.semanticResult.expected)==null?void 0:Z.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",t.semanticResult.expected.action]})]})]}),t.semanticResult.semanticIssues&&t.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:t.semanticResult.semanticIssues.map(($,Q)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${$.severity==="CRITICAL"?"text-red-600":$.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",$.severity,"]"]})," ",$.problem]},Q))}),((E=t.semanticResult.semanticIssues)==null?void 0:E.length)===0&&!t.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"âœ“ No issues"})]})]},s)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("consistency-check"),H.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["consistency-check"].description}),e.jsxs("button",{onClick:()=>ne(),disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Run Consistency Check"]}),u.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${u.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:u.consistencyResults.report.overallConsistent?"All characters consistent!":`${u.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:u.consistencyResults.report.summary})]}),Object.entries(u.consistencyResults.report.characters||{}).map(([s,t])=>{var d,f;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${t.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:s}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${t.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",t.overallScore??t.score??"?","/10",(t.totalIssues??((d=t.issues)==null?void 0:d.length)??0)>0&&` â€¢ ${t.totalIssues??((f=t.issues)==null?void 0:f.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[t.byClothing&&Object.entries(t.byClothing).map(([g,v])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:g}),e.jsxs("span",{className:`text-xs ${v.score>=7?"text-green-600":"text-amber-600"}`,children:[v.score,"/10"]})]}),v.gridImage&&e.jsx("div",{className:"mt-2 mb-2",children:e.jsx("img",{src:v.gridImage,alt:`${s} - ${g} consistency grid`,className:"w-full max-h-48 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>O(v.gridImage),title:"Click to enlarge"})}),v.issues&&v.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:v.issues.map((M,L)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${M.severity==="critical"?"bg-red-400":M.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[M.description,M.pagesToFix&&M.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",M.pagesToFix.join(", "),")"]})]})]},L))})]},g)),!t.byClothing&&t.issues&&t.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:t.issues.map((g,v)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${g.severity==="critical"?"bg-red-400":g.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:g.description})]},v))}),(!t.byClothing||Object.values(t.byClothing).every(g=>{var v;return!((v=g.issues)!=null&&v.length)}))&&(!t.issues||t.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},s)}),X.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:X.map(s=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:s},s))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("character-repair"),H.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:N,onChange:s=>{j(s.target.value),S([])},className:"w-full p-2 border rounded text-sm",disabled:C,children:[e.jsx("option",{value:"",children:"Choose a character..."}),X.map(s=>e.jsxs("option",{value:s,children:[s," (has issues)"]},s)),te.filter(s=>!X.includes(s.name)).map(s=>e.jsx("option",{value:s.name,children:s.name},s.name))]})]}),N&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const s=Ce(N);S(s)},disabled:C||u.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(ge,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:P.map(s=>e.jsxs("button",{onClick:()=>{S(t=>t.includes(s.pageNumber)?t.filter(d=>d!==s.pageNumber):[...t,s.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${A.includes(s.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:C,children:["Page ",s.pageNumber]},s.pageNumber))})]}),V&&_&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("label",{className:"text-sm font-medium text-blue-800 mb-2 block",children:"Repair Method:"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:!h,onChange:()=>_(!1),className:"text-blue-600",disabled:C}),e.jsx("span",{className:"text-sm",children:"Gemini (default)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:h,onChange:()=>_(!0),className:"text-blue-600",disabled:C}),e.jsx("span",{className:"text-sm",children:"MagicAPI Face+Hair"}),e.jsx("span",{className:"text-xs text-blue-600",children:"(~$0.006/repair)"})]})]}),h&&e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Uses face swap + hair fix pipeline with iterative crop checking"})]}),e.jsxs("button",{onClick:async()=>{await ie(N,A,{useMagicApiRepair:h}),b&&await b()},disabled:C||!N||A.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(Oe,{className:"w-4 h-4"}),"Repair ",N||"Character"," on ",A.length," pages",h&&e.jsx("span",{className:"text-xs opacity-75",children:"(MagicAPI)"})]}),Object.keys(u.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800 mb-2",children:"Repair Results:"}),Object.entries(u.characterRepairResults.pagesRepaired).map(([s,t])=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[s,":"]})," ",e.jsxs("span",{className:"text-gray-600",children:["Pages ",t.join(", ")]})]},s))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("artifact-repair"),H.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>T(w),disabled:C||w.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(ge,{className:"w-3 h-3"}),"Auto-Identify (",w.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:w.length>0?w.map(s=>e.jsxs("button",{onClick:()=>{T(t=>t.includes(s)?t.filter(d=>d!==s):[...t,s])},className:`px-2 py-1 text-xs rounded border transition-colors ${x.includes(s)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:C,children:["Page ",s]},s)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),w.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),P.map(s=>e.jsxs("button",{onClick:()=>{T(t=>t.includes(s.pageNumber)?t.filter(d=>d!==s.pageNumber):[...t,s.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${x.includes(s.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:C,children:["Page ",s.pageNumber]},s.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await Ne(x),b&&await b()},disabled:C||x.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(De,{className:"w-4 h-4"}),"Run Grid Repair on ",x.length," pages"]}),u.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",u.artifactRepairResults.pagesProcessed.length," pages, fixed ",u.artifactRepairResults.issuesFixed," issues"]})})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[y("cover-repair"),H.has("cover-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["cover-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Covers to Regenerate:"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:["front","initial","back"].map(s=>{const t={front:"Front Cover",initial:"Dedication Page",back:"Back Cover"};return e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:B.includes(s),onChange:d=>{Ee(f=>d.target.checked?[...f,s]:f.filter(g=>g!==s))},disabled:C,className:"rounded text-amber-600"}),e.jsx("span",{className:"text-sm",children:t[s]})]},s)})})]}),e.jsxs("button",{onClick:async()=>{await oe(B),b&&await b()},disabled:C||B.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(qe,{className:"w-4 h-4"}),"Regenerate ",B.length," Cover",B.length!==1?"s":""]}),z.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",z.current," / ",z.total]}),z.currentCover&&e.jsxs("span",{className:"text-gray-500",children:["Currently: ",z.currentCover," cover"]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${z.current/z.total*100}%`}})})]}),u.stepStatus["cover-repair"]==="completed"&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("h5",{className:"text-sm font-medium text-green-800",children:"Covers regenerated successfully"})})]})]})]})]}),J&&e.jsx(Le,{src:J,alt:"Consistency Grid",onClose:()=>O(null)})]}):null}export{is as RepairWorkflowPanel,is as default};
