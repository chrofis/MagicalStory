import{c as w,u as E,a as R,j as e,e as A,I as V,T as q,b as K}from"./index-CjxkfiAN.js";import{u as _,e as Z,b as c}from"./vendor-react-k5uhsfqB.js";import{N as y}from"./Textarea-DVEt6fvE.js";import{B as W}from"./Input-Bau42SfN.js";import{s as X}from"./storyService-Y9WabKRl.js";import{g as j,B as N,M as Y}from"./Pricing-CE4e_0pt.js";import{A as J}from"./arrow-left-C4qhfmCB.js";import{S as Q}from"./shopping-cart-C2hwM3WK.js";import"./vendor-firebase-Ksn6Afo7.js";import"./api-CL93LcKs.js";import"./check-9_wT-Q8N.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=w("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=w("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=w("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),u=K("BookBuilder");function ue(){const x=_(),S=Z(),{language:l}=E(),{isAuthenticated:p,user:f}=R(),I=(f==null?void 0:f.role)==="admin",[o,k]=c.useState([]),[G,P]=c.useState(!0),[d,D]=c.useState("softcover"),[C,z]=c.useState(!1),[F,M]=c.useState(!1),B={en:{title:"Create Your Book",subtitle:"Arrange your stories and choose your cover type",noStories:"No stories selected",noStoriesDesc:"Please go back and select stories to combine.",backToStories:"Back to My Stories",storyOrder:"Story Order",storyOrderHint:"Drag stories to reorder. The first story's cover will be used as the book cover.",coverNote:"The cover from the first story will be used as your book cover.",moveUp:"Move up",moveDown:"Move down",pages:"pages",totalPages:"Total Pages",chooseFormat:"Choose Format",softcover:"Softcover",hardcover:"Hardcover",softcoverSize:"14 × 14 cm",hardcoverSize:"20 × 20 cm",price:"Price",includesShipping:"Includes shipping & taxes (Switzerland)",orderBook:"Order Book",tooManyPages:"Too many pages",tooManyPagesDesc:"Maximum is 100 pages. Please remove some stories.",processing:"Processing...",printPdf:"Print PDF (Test)",generatingPdf:"Generating PDF..."},de:{title:"Dein Buch erstellen",subtitle:"Ordne deine Geschichten an und wähle deinen Einband",noStories:"Keine Geschichten ausgewählt",noStoriesDesc:"Bitte geh zurück und wähle Geschichten zum Kombinieren aus.",backToStories:"Zurück zu Meine Geschichten",storyOrder:"Reihenfolge der Geschichten",storyOrderHint:"Verschiebe Geschichten, um die Reihenfolge zu ändern. Das Cover der ersten Geschichte wird als Buchcover verwendet.",coverNote:"Das Cover der ersten Geschichte wird als Buchcover verwendet.",moveUp:"Nach oben",moveDown:"Nach unten",pages:"Seiten",totalPages:"Seiten insgesamt",chooseFormat:"Format wählen",softcover:"Softcover",hardcover:"Hardcover",softcoverSize:"14 × 14 cm",hardcoverSize:"20 × 20 cm",price:"Preis",includesShipping:"Inkl. Versand & Steuern (Schweiz)",orderBook:"Buch bestellen",tooManyPages:"Zu viele Seiten",tooManyPagesDesc:"Maximal 100 Seiten erlaubt. Bitte entferne einige Geschichten.",processing:"Wird verarbeitet...",printPdf:"Druck-PDF (Test)",generatingPdf:"PDF wird erstellt..."},fr:{title:"Créer votre livre",subtitle:"Arrangez vos histoires et choisissez votre type de couverture",noStories:"Aucune histoire sélectionnée",noStoriesDesc:"Veuillez retourner et sélectionner des histoires à combiner.",backToStories:"Retour à Mes histoires",storyOrder:"Ordre des histoires",storyOrderHint:"Déplacez les histoires pour les réorganiser. La couverture de la première histoire sera utilisée comme couverture du livre.",coverNote:"La couverture de la première histoire sera utilisée comme couverture du livre.",moveUp:"Monter",moveDown:"Descendre",pages:"pages",totalPages:"Pages totales",chooseFormat:"Choisir le format",softcover:"Couverture souple",hardcover:"Couverture rigide",softcoverSize:"14 × 14 cm",hardcoverSize:"20 × 20 cm",price:"Prix",includesShipping:"Livraison & taxes incluses (Suisse)",orderBook:"Commander le livre",tooManyPages:"Trop de pages",tooManyPagesDesc:"Maximum 100 pages. Veuillez retirer quelques histoires.",processing:"Traitement en cours...",printPdf:"PDF impression (Test)",generatingPdf:"Génération du PDF..."}},s=B[l]||B.en;c.useEffect(()=>{if(!p){x("/");return}const r=S.state;r!=null&&r.selectedStories&&r.selectedStories.length>0&&k(r.selectedStories),P(!1)},[p,x,S.state]);const m=c.useMemo(()=>o.reduce((r,t)=>r+t.pages,0),[o]),b=c.useMemo(()=>j(m,d==="hardcover"),[m,d]),n=m>Y,T=(r,t)=>{const i=[...o],a=t==="up"?r-1:r+1;a<0||a>=o.length||([i[r],i[a]]=[i[a],i[r]],k(i))},$=async()=>{if(!(n||!b)){z(!0);try{u.info("Creating combined book checkout:",{storyIds:o.map(t=>t.id),coverType:d,totalPages:m});const{url:r}=await X.createCheckoutSession(o[0].id);window.location.href=r}catch(r){u.error("Checkout failed:",r),alert(l==="de"?"Checkout fehlgeschlagen. Bitte versuche es erneut.":l==="fr"?"Échec du paiement. Veuillez réessayer.":"Checkout failed. Please try again.")}finally{z(!1)}}},U=async()=>{var r,t;if(o.length!==0){M(!0);try{const i=o[0].id;u.info("Downloading print PDF for story:",i);const a=localStorage.getItem("auth_token"),h=await fetch(`/api/stories/${i}/print-pdf`,{headers:{Authorization:`Bearer ${a}`}});if(!h.ok){let v=`HTTP ${h.status}`;try{const L=await h.json();v=L.details||L.error||v}catch{}throw new Error(v)}const H=await h.blob(),O=window.URL.createObjectURL(H),g=document.createElement("a");g.href=O,g.download=((t=(r=h.headers.get("Content-Disposition"))==null?void 0:r.split("filename=")[1])==null?void 0:t.replace(/"/g,""))||"story-print.pdf",document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(O),u.info("Print PDF downloaded successfully")}catch(i){u.error("Failed to download print PDF:",i);const a=i instanceof Error?i.message:"Unknown error";alert(l==="de"?`PDF konnte nicht heruntergeladen werden: ${a}`:l==="fr"?`Impossible de télécharger le PDF: ${a}`:`Failed to download PDF: ${a}`)}finally{M(!1)}}};return p?G?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(y,{currentStep:0}),e.jsx(A,{message:l==="de"?"Laden...":l==="fr"?"Chargement...":"Loading..."})]}):o.length===0?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(y,{currentStep:0}),e.jsx("div",{className:"px-4 md:px-8 py-8 max-w-4xl mx-auto",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(N,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:s.noStories}),e.jsx("p",{className:"text-gray-500 mb-6",children:s.noStoriesDesc}),e.jsx("button",{onClick:()=>x("/stories"),className:"px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:s.backToStories})]})})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(y,{currentStep:0}),e.jsxs("div",{className:"px-4 md:px-8 py-8 max-w-4xl mx-auto",children:[e.jsxs("button",{onClick:()=>x("/stories"),className:"flex items-center gap-2 text-gray-600 hover:text-indigo-600 mb-6 transition-colors",children:[e.jsx(J,{size:20}),s.backToStories]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 mb-2",children:s.title}),e.jsx("p",{className:"text-gray-600",children:s.subtitle})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-3",children:s.storyOrder}),e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 flex items-start gap-2",children:[e.jsx(V,{size:18,className:"text-amber-600 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-amber-800",children:s.coverNote})]}),e.jsx("div",{className:"space-y-3",children:o.map((r,t)=>e.jsxs("div",{className:`bg-white rounded-xl shadow-md p-4 flex items-center gap-4 ${t===0?"ring-2 ring-indigo-400":""}`,children:[r.thumbnail?e.jsx("img",{src:r.thumbnail,alt:r.title,className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center",children:e.jsx(N,{size:24,className:"text-indigo-300"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-gray-800 truncate",children:r.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:[r.pages," ",s.pages]}),t===0&&e.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full font-medium",children:"Cover"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("button",{onClick:()=>T(t,"up"),disabled:t===0,className:"p-1.5 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed",title:s.moveUp,children:e.jsx(re,{size:18,className:"text-gray-600"})}),e.jsx("button",{onClick:()=>T(t,"down"),disabled:t===o.length-1,className:"p-1.5 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed",title:s.moveDown,children:e.jsx(ee,{size:18,className:"text-gray-600"})})]})]},r.id))}),e.jsxs("div",{className:`mt-4 p-4 rounded-xl ${n?"bg-red-50 border-2 border-red-300":"bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`font-semibold ${n?"text-red-700":"text-gray-700"}`,children:s.totalPages}),e.jsx("span",{className:`text-2xl font-bold ${n?"text-red-700":"text-gray-800"}`,children:m})]}),n&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-red-700",children:[e.jsx(q,{size:16}),e.jsx("span",{className:"text-sm",children:s.tooManyPagesDesc})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-3",children:s.chooseFormat}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx("button",{onClick:()=>D("softcover"),className:`w-full p-4 rounded-xl border-2 text-left transition-all ${d==="softcover"?"border-indigo-600 bg-indigo-50":"border-gray-200 hover:border-indigo-300"}`,children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(N,{size:32,className:d==="softcover"?"text-indigo-600":"text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-gray-800",children:s.softcover}),e.jsx("div",{className:"text-sm text-gray-500",children:s.softcoverSize})]}),!n&&e.jsxs("div",{className:"text-xl font-bold text-gray-800",children:["CHF ",j(m,!1),".-"]})]})}),e.jsx("button",{onClick:()=>D("hardcover"),className:`w-full p-4 rounded-xl border-2 text-left transition-all ${d==="hardcover"?"border-indigo-600 bg-indigo-50":"border-gray-200 hover:border-indigo-300"}`,children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(W,{size:32,className:d==="hardcover"?"text-indigo-600":"text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-gray-800",children:s.hardcover}),e.jsx("div",{className:"text-sm text-gray-500",children:s.hardcoverSize})]}),!n&&e.jsxs("div",{className:"text-xl font-bold text-indigo-700",children:["CHF ",j(m,!0),".-"]})]})})]}),!n&&b&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-gray-700",children:s.price}),e.jsxs("span",{className:"text-3xl font-bold text-indigo-700",children:["CHF ",b,".-"]})]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.includesShipping})]}),e.jsx("button",{onClick:$,disabled:n||C,className:"w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"}),s.processing]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:22}),s.orderBook]})}),I&&e.jsx("button",{onClick:U,disabled:F||o.length===0,className:"w-full mt-3 py-3 bg-purple-100 text-purple-700 border-2 border-purple-300 rounded-xl font-semibold hover:bg-purple-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-purple-700 border-t-transparent"}),s.generatingPdf]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{size:20}),s.printPdf]})})]})]})]})]}):e.jsx(A,{fullScreen:!0})}export{ue as default};
