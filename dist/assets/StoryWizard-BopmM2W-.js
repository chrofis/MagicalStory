const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WizardStep2Characters-TLqpS-RI.js","assets/index-CMe5K9vp.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-BrTiMJbR.css","assets/Input-D8vhWBqs.js","assets/Textarea-C2igIng7.js","assets/sparkles-BbYAHQ3L.js","assets/book-open-DzQ8Pvy3.js","assets/check-Hbvuxx8X.js","assets/pen-CItS5IfP.js","assets/trash-2-CVF7UGvP.js","assets/Modal-DxM1Ttnn.js","assets/download-epwAJ6_g.js","assets/chevron-right-CHTEqcfJ.js","assets/arrow-right-D16-oBYV.js","assets/camera-D1KvR28d.js","assets/pencil-DctFj_48.js","assets/circle-x-C_u62KLN.js","assets/clock-BaoFRE2d.js","assets/palette-DedvkhVa.js","assets/book-4MiNzwRD.js","assets/shopping-cart-DFZYJ80-.js","assets/arrow-left-B1zFDnRC.js","assets/WizardStep4StoryType-EDluRxM3.js","assets/WizardStep5ArtStyle-qM5u9sq6.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-x1HTqLtu.js"])))=>i.map(i=>d[i]);
import{c as rt,b as Oe,d as Pa,j as e,X as $t,u as Kt,a as Ta,L as et,T as wn,C as Xa,s as Be,E as Pi,e as Ti,f as Ii,g as en,_ as Ss}from"./index-CMe5K9vp.js";import{b as o,u as $i,e as Di}from"./vendor-react-CqfXSjHo.js";import{U as Ia,B as Js,I as tn}from"./Input-D8vhWBqs.js";import{S as Ri,A as rn,N as Ei}from"./Textarea-C2igIng7.js";import{C as Fi}from"./circle-x-C_u62KLN.js";import{C as zi}from"./clock-BaoFRE2d.js";import{M as Sn,H as Bi,C as sn,R as Ut,F as qr,P as an,a as Mi,I as nn,b as Li}from"./Modal-DxM1Ttnn.js";import{D as Ir,C as or}from"./download-epwAJ6_g.js";import{C as Ca}from"./chevron-right-CHTEqcfJ.js";import{P as Cn}from"./palette-DedvkhVa.js";import{B as Gi}from"./book-4MiNzwRD.js";import{C as Oi}from"./check-Hbvuxx8X.js";import{S as on}from"./shopping-cart-DFZYJ80-.js";import{B as Qs}from"./book-open-DzQ8Pvy3.js";import{S as Kr}from"./sparkles-BbYAHQ3L.js";import{A as ln}from"./arrow-left-B1zFDnRC.js";import{A as _i}from"./arrow-right-D16-oBYV.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hi=rt("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wi=rt("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vi=rt("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tr=rt("Images",[["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"m22 13-1.296-1.296a2.41 2.41 0 0 0-3.408 0L11 18",key:"nf6bnh"}],["circle",{cx:"12",cy:"8",r:"2",key:"1822b1"}],["rect",{width:"16",height:"16",x:"6",y:"2",rx:"2",key:"12espp"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qi=rt("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ui=rt("Link2Off",[["path",{d:"M9 17H7A5 5 0 0 1 7 7",key:"10o201"}],["path",{d:"M15 7h2a5 5 0 0 1 4 8",key:"1d3206"}],["line",{x1:"8",x2:"12",y1:"12",y2:"12",key:"rvw6j4"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ki=rt("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const js=rt("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ji=rt("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qi=rt("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=rt("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vr=rt("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zi=rt("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dn=rt("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yi=rt("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xi=rt("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Na=rt("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=rt("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]),eo={async login(r,l){const i=await Oe.post("/api/auth/login",{username:r,password:l},{skipAuth:!0}),b={id:i.user.id,username:i.user.username,email:i.user.email,role:i.user.role,credits:i.user.credits};return{token:i.token,user:b}},async register(r,l,i){return Oe.post("/api/auth/register",{username:r,password:l,email:i},{skipAuth:!0})},async loginWithFirebase(r){const l=await Oe.post("/api/auth/firebase",{idToken:r},{skipAuth:!0}),i={id:l.user.id,username:l.user.username,email:l.user.email,role:l.user.role,credits:l.user.credits};return{token:l.token,user:i}},async getQuota(){const r=await Oe.get("/api/user/quota");return{storyQuota:r.storyQuota,storiesGenerated:r.storiesGenerated,remaining:r.remaining}},async getCredits(){const r=await Oe.get("/api/user/quota");return{credits:r.credits,unlimited:r.unlimited}},async updateEmail(r){await Oe.put("/api/user/update-email",{email:r})},async getShippingAddress(){try{return await Oe.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(r){await Oe.put("/api/user/shipping-address",r)}},ue=Pa("CharacterService");function kn(r){if(!r)return;const l=parseInt(r,10);if(!(isNaN(l)||l<0))return l<=1?"infant":l<=2?"toddler":l<=4?"preschooler":l<=6?"kindergartner":l<=8?"young-school-age":l<=10?"school-age":l<=12?"preteen":l<=14?"young-teen":l<=17?"teenager":l<=25?"young-adult":l<=39?"adult":l<=59?"middle-aged":l<=75?"senior":"elderly"}function wa(r){const l={height:r.height,build:r.build,face:r.other_features||r.otherFeatures,eyeColor:r.eye_color||r.eyeColor,hairColor:r.hair_color||r.hairColor,hairLength:r.hair_length||r.hairLength,hairStyle:r.hair_style||r.hairStyle,facialHair:r.facial_hair||r.facialHair,skinTone:r.skin_tone||r.skinTone,skinUndertone:r.skin_undertone||r.skinUndertone,skinToneHex:r.skin_tone_hex||r.skinToneHex,hair:r.hair_color||r.hairColor,other:r.other,detailedHairAnalysis:r.detailed_hair_analysis||r.detailedHairAnalysis,apparentAge:r.apparent_age||r.apparentAge},i=r.age_category||r.ageCategory||kn(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,ageCategory:i,physical:l.height||l.build||l.face||l.eyeColor||l.hairColor||l.hairLength||l.hairStyle||l.facialHair||l.skinTone||l.hair||l.other||l.detailedHairAnalysis||l.apparentAge?l:void 0,physicalTraitsSource:r.physical_traits_source||r.physicalTraitsSource,traits:{strengths:r.strengths||[],flaws:r.flaws||r.weaknesses||[],challenges:r.challenges||r.fears||[],specialDetails:r.special_details||r.specialDetails},photos:{original:r.photo_url||r.photoUrl,face:r.thumbnail_url||r.thumbnailUrl,body:r.body_photo_url||r.bodyPhotoUrl,bodyNoBg:r.body_no_bg_url||r.bodyNoBgUrl,faceBox:r.face_box||r.faceBox,bodyBox:r.body_box||r.bodyBox},avatars:r.avatars||r.clothing_avatars||r.clothingAvatars,clothing:r.clothing||r.structured_clothing||r.structuredClothing?{current:r.clothing,structured:r.structured_clothing||r.structuredClothing}:void 0,generatedOutfits:r.generated_outfits||r.generatedOutfits,storyRole:r.storyRole}}function cn(r){var i,b,s,D,p,C,I,q,R,A,F,P,J,v,m,E,le,ne,se,B,y,G,_,N;const l=r.ageCategory||kn(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,age_category:l,apparent_age:(i=r.physical)==null?void 0:i.apparentAge,height:(b=r.physical)==null?void 0:b.height,build:(s=r.physical)==null?void 0:s.build,eye_color:(D=r.physical)==null?void 0:D.eyeColor,hair_color:(p=r.physical)==null?void 0:p.hairColor,hair_length:(C=r.physical)==null?void 0:C.hairLength,hair_style:(I=r.physical)==null?void 0:I.hairStyle,facial_hair:(q=r.physical)==null?void 0:q.facialHair,skin_tone:(R=r.physical)==null?void 0:R.skinTone,skin_undertone:(A=r.physical)==null?void 0:A.skinUndertone,skin_tone_hex:(F=r.physical)==null?void 0:F.skinToneHex,other_features:(P=r.physical)==null?void 0:P.face,other:(J=r.physical)==null?void 0:J.other,detailed_hair_analysis:(v=r.physical)==null?void 0:v.detailedHairAnalysis,physical_traits_source:r.physicalTraitsSource,face_box:(m=r.photos)==null?void 0:m.faceBox,body_box:(E=r.photos)==null?void 0:E.bodyBox,strengths:(le=r.traits)==null?void 0:le.strengths,flaws:(ne=r.traits)==null?void 0:ne.flaws,challenges:(se=r.traits)==null?void 0:se.challenges,special_details:(B=r.traits)==null?void 0:B.specialDetails,weaknesses:(y=r.traits)==null?void 0:y.flaws,fears:(G=r.traits)==null?void 0:G.challenges,clothing:(_=r.clothing)==null?void 0:_.current,structured_clothing:(N=r.clothing)==null?void 0:N.structured,generated_outfits:r.generatedOutfits,storyRole:r.storyRole}}function to(r){return!r||r.length===0?[]:typeof r[0]=="string"?r.map(l=>({forward:l,inverse:l})):r}const Ee={async getCharacters(r=!1){const l=r?"/api/characters?includeAllAvatars=true":"/api/characters";return((await Oe.get(l)).characters||[]).map(wa)},async getCharacterData(r=!1){const l=r?"/api/characters?includeAllAvatars=true":"/api/characters",i=await Oe.get(l);return{characters:(i.characters||[]).map(wa),relationships:i.relationships||{},relationshipTexts:i.relationshipTexts||{},customRelationships:to(i.customRelationships),customStrengths:i.customStrengths||[],customWeaknesses:i.customWeaknesses||[],customFears:i.customFears||[]}},async saveCharacters(r){await Oe.post("/api/characters",{characters:r.map(cn)})},async saveCharacterData(r,l){const i=s=>{var p,C,I,q;const D=cn(s);return l!=null&&l.includePhotos&&(D.photo_url=(p=s.photos)==null?void 0:p.original,D.thumbnail_url=(C=s.photos)==null?void 0:C.face,D.body_photo_url=(I=s.photos)==null?void 0:I.body,D.body_no_bg_url=(q=s.photos)==null?void 0:q.bodyNoBg),D},b={characters:r.characters.map(i),relationships:r.relationships,relationshipTexts:r.relationshipTexts,customRelationships:r.customRelationships,customStrengths:r.customStrengths,customWeaknesses:r.customWeaknesses,customFears:r.customFears};await Oe.post("/api/characters",b)},async deleteCharacter(r){try{const l=await Oe.delete(`/api/characters/${r}`);return ue.success(`Deleted character ${r}: ${l.message}`),{success:!0}}catch(l){return ue.error(`Failed to delete character ${r}:`,l),{success:!1,error:String(l)}}},async saveCharacterRoles(r){try{return await Oe.put("/api/characters/roles",{roles:r}),ue.success(`Saved character roles: ${Object.keys(r).length} characters`),{success:!0}}catch(l){return ue.error("Failed to save character roles:",l),{success:!1,error:String(l)}}},async loadCharacterAvatars(r){try{const l=await Oe.get(`/api/characters/${r}/avatars`);return ue.info(`Loaded full avatars for character ${r}`),l.avatars||null}catch(l){return ue.error(`Failed to load avatars for character ${r}:`,l),null}},async loadFullCharacter(r){try{const l=await Oe.get(`/api/characters/${r}/full`);return l.character?(ue.info(`Loaded full data for character ${r}`),wa(l.character)):null}catch(l){return ue.error(`Failed to load full data for character ${r}:`,l),null}},async generateAvatarOptions(r,l){try{return await Oe.post("/api/generate-avatar-options",{facePhoto:r,gender:l,category:"standard"})}catch(i){const b=i instanceof Error?i.message:"Unknown error";return{success:!1,options:[],error:b}}},async generateClothingAvatars(r,l){var i,b,s,D,p,C,I,q,R,A,F;try{const P=parseInt(r.age)||10,J=r.gender||"child";let v;J==="male"?v=P>=18?"man":"boy":J==="female"?v=P>=18?"woman":"girl":v=P>=18?"person":"child";let E=`${((i=r.name)==null?void 0:i.trim())||`This ${v}`} is a ${P}-year-old ${v}`;r.physical&&(r.physical.hair&&(E+=`, ${r.physical.hair}`),r.physical.face&&(E+=`, ${r.physical.face}`),r.physical.build&&(E+=`, ${r.physical.build}`),r.physical.other&&(E+=`, ${r.physical.other}`));const le=((b=r.photos)==null?void 0:b.bodyNoBg)||((s=r.photos)==null?void 0:s.body)||((D=r.photos)==null?void 0:D.face)||((p=r.photos)==null?void 0:p.original);ue.info(`ðŸŽ¨ Generating clothing avatars for ${r.name||"unnamed"} (id: ${r.id})`);const ne=await Oe.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:le,physicalDescription:E,name:r.name,age:r.age,apparentAge:(C=r.physical)==null?void 0:C.apparentAge,gender:r.gender,build:(I=r.physical)==null?void 0:I.build,clothing:(q=r.clothing)==null?void 0:q.structured,avatarModel:l==null?void 0:l.avatarModel});if(ne.async&&ne.jobId){ue.info(`Avatar job started: ${ne.jobId}, polling for completion...`);const B=60,y=2e3;for(let G=0;G<B;G++){await new Promise(N=>setTimeout(N,y));const _=await Oe.get(`/api/avatar-jobs/${ne.jobId}`);if(_.status==="complete"&&_.clothingAvatars){ue.success(`Avatar job ${ne.jobId} completed after ${(G+1)*2}s`);const N=_.clothingAvatars.extractedTraits,te=(R=_.clothingAvatars.structuredClothing)==null?void 0:R.standard;return ue.info(`ðŸ” [DEBUG] extractedTraits: ${(A=JSON.stringify(N))==null?void 0:A.substring(0,100)}`),ue.info(`ðŸ” [DEBUG] extractedClothing: ${JSON.stringify(te)}`),ue.info(`ðŸ” [DEBUG] structuredClothing keys: ${Object.keys(_.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:_.clothingAvatars,extractedTraits:N,extractedClothing:te}}if(_.status==="failed")return ue.error(`Avatar job failed: ${_.error}`),{success:!1,error:_.error};G%5===0&&ue.info(`Avatar job ${ne.jobId}: ${_.message||_.status} (${_.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const se=ne;if(se.success&&se.clothingAvatars){ue.success(`Clothing avatars generated for ${r.name}`);const B=se.clothingAvatars.extractedTraits,y=(F=se.clothingAvatars.structuredClothing)==null?void 0:F.standard;return B&&ue.info(`Extracted traits: ${JSON.stringify(B)}`),y&&ue.info(`Extracted clothing: ${JSON.stringify(y)}`),{success:!0,avatars:se.clothingAvatars,extractedTraits:B,extractedClothing:y}}else return ue.error(`Failed to generate avatars: ${se.error}`),{success:!1,error:se.error}}catch(P){return ue.error("Clothing avatar generation failed:",P),{success:!1,error:String(P)}}},async generateClothingAvatarsWithTraits(r){var l,i,b,s,D,p,C,I,q,R,A,F,P,J,v,m,E,le;try{const ne=parseInt(r.age)||10,se=r.gender||"child";let B;se==="male"?B=ne>=18?"man":"boy":se==="female"?B=ne>=18?"woman":"girl":B=ne>=18?"person":"child";let G=`${((l=r.name)==null?void 0:l.trim())||`This ${B}`} is a ${ne}-year-old ${B}`;r.physical&&(r.physical.hair&&(G+=`, ${r.physical.hair}`),r.physical.face&&(G+=`, ${r.physical.face}`),r.physical.build&&(G+=`, ${r.physical.build}`),r.physical.other&&(G+=`, ${r.physical.other}`));const _=((i=r.photos)==null?void 0:i.bodyNoBg)||((b=r.photos)==null?void 0:b.body)||((s=r.photos)==null?void 0:s.face)||((D=r.photos)==null?void 0:D.original),N=(p=r.photos)!=null&&p.bodyNoBg?"bodyNoBg":(C=r.photos)!=null&&C.body?"body":(I=r.photos)!=null&&I.face?"face":"original",te=_?Math.round(_.length/1024):0,fe=_==null?void 0:_.startsWith("data:image/png");ue.info(`ðŸŽ¨ Generating clothing avatars WITH TRAITS for ${r.name} (id: ${r.id})`),ue.info(`ðŸ“¸ Photo source: ${N}, size: ${te}KB, format: ${fe?"PNG":"JPEG"}`),ue.info(`ðŸ“¸ Available photos: bodyNoBg=${!!((q=r.photos)!=null&&q.bodyNoBg)}, body=${!!((R=r.photos)!=null&&R.body)}, face=${!!((A=r.photos)!=null&&A.face)}, original=${!!((F=r.photos)!=null&&F.original)}`),ue.info(`Physical traits: ${JSON.stringify(r.physical)}`);const M=r.physicalTraitsSource||{};ue.info(`Physical traits source: ${JSON.stringify(M)}`),ue.info(`Physical skinTone value: '${(P=r.physical)==null?void 0:P.skinTone}', source: '${M.skinTone}'`),ue.info(`Physical hairStyle value: '${(J=r.physical)==null?void 0:J.hairStyle}', source: '${M.hairStyle}'`);const H={};r.physical&&(M.eyeColor==="user"&&r.physical.eyeColor&&(H.eyeColor=r.physical.eyeColor),M.hairColor==="user"&&r.physical.hairColor&&(H.hairColor=r.physical.hairColor),M.hairLength==="user"&&r.physical.hairLength&&(H.hairLength=r.physical.hairLength),M.hairStyle==="user"&&r.physical.hairStyle&&(H.hairStyle=r.physical.hairStyle),M.build==="user"&&r.physical.build&&(H.build=r.physical.build),M.skinTone==="user"&&r.physical.skinTone&&(H.skinTone=r.physical.skinTone,r.physical.skinToneHex&&(H.skinToneHex=r.physical.skinToneHex)),M.face==="user"&&r.physical.face&&(H.face=r.physical.face),M.facialHair==="user"&&r.physical.facialHair&&(H.facialHair=r.physical.facialHair),M.other==="user"&&r.physical.other&&(H.other=r.physical.other));const de=Object.keys(H).length>0;ue.info(`Physical traits to send (user-edited only): ${de?JSON.stringify(H):"none"}`);const ve=r.clothingSource||{},ke={};(v=r.clothing)!=null&&v.structured&&(ve.upperBody==="user"&&r.clothing.structured.upperBody&&(ke.upperBody=r.clothing.structured.upperBody),ve.lowerBody==="user"&&r.clothing.structured.lowerBody&&(ke.lowerBody=r.clothing.structured.lowerBody),ve.shoes==="user"&&r.clothing.structured.shoes&&(ke.shoes=r.clothing.structured.shoes),ve.fullBody==="user"&&r.clothing.structured.fullBody&&(ke.fullBody=r.clothing.structured.fullBody));const $e=Object.keys(ke).length>0;ue.info(`Clothing to send (user-edited only): ${$e?JSON.stringify(ke):"none"}`);const Y=await Oe.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:_,physicalDescription:G,name:r.name,age:r.age,apparentAge:(m=r.physical)==null?void 0:m.apparentAge,gender:r.gender,build:H.build||"average",physicalTraits:de?H:void 0,clothing:$e?ke:void 0});if(Y.async&&Y.jobId){ue.info(`Avatar job started: ${Y.jobId}, polling for completion...`);const _e=60,Se=2e3;for(let He=0;He<_e;He++){await new Promise(xe=>setTimeout(xe,Se));const he=await Oe.get(`/api/avatar-jobs/${Y.jobId}`);if(he.status==="complete"&&he.clothingAvatars){ue.success(`Avatar job ${Y.jobId} completed after ${(He+1)*2}s`);const xe=he.clothingAvatars.extractedTraits,V=(E=he.clothingAvatars.structuredClothing)==null?void 0:E.standard;return{success:!0,avatars:he.clothingAvatars,extractedTraits:xe,extractedClothing:V}}if(he.status==="failed")return ue.error(`Avatar job failed: ${he.error}`),{success:!1,error:he.error};He%5===0&&ue.info(`Avatar job ${Y.jobId}: ${he.message||he.status} (${he.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(Y.success&&Y.clothingAvatars){ue.success(`Clothing avatars WITH TRAITS generated for ${r.name}`);const _e=Y.clothingAvatars.extractedTraits,Se=(le=Y.clothingAvatars.structuredClothing)==null?void 0:le.standard;return{success:!0,avatars:Y.clothingAvatars,extractedTraits:_e,extractedClothing:Se}}else return ue.error(`Failed to generate avatars with traits: ${Y.error}`),{success:!1,error:Y.error}}catch(ne){return ue.error("Clothing avatar generation with traits failed:",ne),{success:!1,error:String(ne)}}},async analyzePhoto(r,l,i,b,s){var D,p,C,I,q,R,A,F,P,J,v,m,E,le,ne,se,B,y,G,_;try{const N=await Oe.post("/api/analyze-photo",{imageData:r,language:l,selectedFaceId:i,cachedFaces:b,existingCharacterId:s});if(!N.success)return{success:!1,error:N.error};if(N.multipleFacesDetected&&N.faces)return ue.info(`Multiple faces detected (${N.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:N.faceCount,faces:N.faces};const te={height:(D=N.attributes)==null?void 0:D.height,build:(p=N.attributes)==null?void 0:p.build,face:(C=N.attributes)==null?void 0:C.face,eyeColor:((I=N.attributes)==null?void 0:I.eye_color)||((q=N.attributes)==null?void 0:q.eyeColor),hairColor:((R=N.attributes)==null?void 0:R.hair_color)||((A=N.attributes)==null?void 0:A.hairColor),hairLength:((F=N.attributes)==null?void 0:F.hair_length)||((P=N.attributes)==null?void 0:P.hairLength),hairStyle:((J=N.attributes)==null?void 0:J.hair_style)||((v=N.attributes)==null?void 0:v.hairStyle),hair:((m=N.attributes)==null?void 0:m.hair_color)||((E=N.attributes)==null?void 0:E.hairColor),other:(le=N.attributes)==null?void 0:le.other_features};return{success:N.success,characterId:N.characterId,multipleFacesDetected:!1,faceCount:N.faceCount,photos:{face:N.faceThumbnail,body:N.bodyCrop,bodyNoBg:N.bodyNoBg,faceBox:N.faceBox,bodyBox:N.bodyBox},age:(ne=N.attributes)==null?void 0:ne.age,apparentAge:(se=N.attributes)==null?void 0:se.apparent_age,gender:(B=N.attributes)==null?void 0:B.gender,physical:te.height||te.build||te.face||te.eyeColor||te.hairColor||te.hairLength||te.hairStyle||te.hair||te.other?te:void 0,clothing:(y=N.attributes)!=null&&y.clothing||(G=N.attributes)!=null&&G.clothingStyle||(_=N.attributes)!=null&&_.clothingColors?{current:N.attributes.clothing,style:N.attributes.clothingStyle||N.attributes.clothingColors}:void 0,_debug:N._debug}}catch(N){return ue.error("Photo analysis failed:",N),{success:!1,error:"unknown_error"}}},needsAvatars(r){var s,D,p,C;if(!!!((s=r.photos)!=null&&s.original||(D=r.photos)!=null&&D.face||(p=r.photos)!=null&&p.body||(C=r.photos)!=null&&C.bodyNoBg))return!1;const i=r.avatars;return i?i.status==="generating"||i.status==="pending"?!1:i.status==="failed"?!0:!!!(i.winter||i.standard||i.summer||i.formal||i.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(r,l,i){var s,D,p,C,I,q,R,A,F,P,J,v,m,E,le,ne,se,B,y,G;const b={characterId:r.id,characterName:r.name,success:!1};try{if(!!!((s=r.photos)!=null&&s.original||(D=r.photos)!=null&&D.face||(p=r.photos)!=null&&p.body||(C=r.photos)!=null&&C.bodyNoBg))return b.skipped=!0,b.skipReason="No photo available",b;l==null||l("generating",`Generating avatars for ${r.name}...`),ue.info(`ðŸŽ¨ Generating avatars for ${r.name} (id: ${r.id})${i!=null&&i.avatarModel?`, model: ${i.avatarModel}`:""}`);const N=await Ee.generateClothingAvatars(r,i);if(!N.success||!N.avatars)return b.error=N.error||"Avatar generation failed",l==null||l("error",b.error),b;b.avatars=N.avatars,b.extractedTraits=N.extractedTraits,b.extractedClothing=N.extractedClothing,l==null||l("saving",`Fetching updated data for ${r.name}...`);let te=null;const fe=30;for(let M=0;M<fe;M++){if(M>0){const H=Math.min(500*Math.pow(1.2,M),3e3);ue.info(`[AVATAR] Retry ${M+1}/${fe}: waiting ${Math.round(H)}ms for avatar data...`),await new Promise(de=>setTimeout(de,H))}if(te=await Ee.loadFullCharacter(r.id),(I=te==null?void 0:te.avatars)!=null&&I.standard||(q=te==null?void 0:te.avatars)!=null&&q.winter||(R=te==null?void 0:te.avatars)!=null&&R.summer){ue.info(`[AVATAR] Got fresh data with avatars on attempt ${M+1}`);break}}return te?(b.character=te,(A=te.avatars)!=null&&A.standard||(F=te.avatars)!=null&&F.winter||(P=te.avatars)!=null&&P.summer||ue.warn(`âš ï¸ Fresh DB data for ${r.name} missing avatars after ${fe} retries - server may not have saved them`),ue.info(`ðŸ“‹ Using server-saved data for ${r.name}`)):(ue.error(`âŒ Character ${r.name} (id: ${r.id}) not found in DB after avatar job - avatars lost!`),b.character={...r,avatars:{status:"failed"},physical:N.extractedTraits?{...r.physical,apparentAge:N.extractedTraits.apparentAge||((J=r.physical)==null?void 0:J.apparentAge),build:N.extractedTraits.build||((v=r.physical)==null?void 0:v.build),eyeColor:N.extractedTraits.eyeColor||((m=r.physical)==null?void 0:m.eyeColor),eyeColorHex:N.extractedTraits.eyeColorHex||((E=r.physical)==null?void 0:E.eyeColorHex),hairColor:N.extractedTraits.hairColor||((le=r.physical)==null?void 0:le.hairColor),hairColorHex:N.extractedTraits.hairColorHex||((ne=r.physical)==null?void 0:ne.hairColorHex),hairLength:N.extractedTraits.hairLength||((se=r.physical)==null?void 0:se.hairLength),hairStyle:N.extractedTraits.hairStyle||((B=r.physical)==null?void 0:B.hairStyle),skinTone:N.extractedTraits.skinTone||((y=r.physical)==null?void 0:y.skinTone),skinToneHex:N.extractedTraits.skinToneHex||((G=r.physical)==null?void 0:G.skinToneHex)}:r.physical,clothing:N.extractedClothing?{...r.clothing,structured:{upperBody:N.extractedClothing.upperBody||void 0,lowerBody:N.extractedClothing.lowerBody||void 0,shoes:N.extractedClothing.shoes||void 0,fullBody:N.extractedClothing.fullBody||void 0}}:r.clothing}),b.success=!0,l==null||l("complete",`Avatars saved for ${r.name}`),ue.success(`âœ… Avatars generated and saved for ${r.name}`),b}catch(_){return b.error=String(_),l==null||l("error",b.error),ue.error(`Failed to generate/save avatars for ${r.name}:`,_),b}},async generateAvatarsForCharacters(r,l){const{forceRegenerate:i=!1,maxConcurrent:b=2,onProgress:s}=l||{};ue.info("ðŸŽ¨ Starting batch avatar generation...");const D=await Ee.getCharacterData();let p;if(r&&r.length>0?p=D.characters.filter(F=>r.includes(F.id)):p=D.characters.filter(F=>{var P,J;return i?!!((P=F.photos)!=null&&P.original||(J=F.photos)!=null&&J.face):Ee.needsAvatars(F)}),p.length===0)return ue.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};ue.info(`Processing ${p.length} characters for avatar generation`);const C=[],I=new Map;for(let F=0;F<p.length;F+=b){const J=p.slice(F,F+b).map(async m=>{var le,ne,se,B,y;const E={characterId:m.id,characterName:m.name,success:!1};try{if(!!!((le=m.photos)!=null&&le.original||(ne=m.photos)!=null&&ne.face||(se=m.photos)!=null&&se.body||(B=m.photos)!=null&&B.bodyNoBg))return E.skipped=!0,E.skipReason="No photo available",E;if(!i&&((y=m.avatars)!=null&&y.winter))return E.skipped=!0,E.skipReason="Avatars already exist",E;s==null||s(m.id,"generating",`Generating avatars for ${m.name}...`),ue.info(`ðŸŽ¨ Generating avatars for ${m.name}...`);const _=await Ee.generateClothingAvatars(m);return!_.success||!_.avatars?(E.error=_.error||"Avatar generation failed",s==null||s(m.id,"error",E.error),E):(E.avatars=_.avatars,E.success=!0,I.set(m.id,{...m,avatars:_.avatars}),s==null||s(m.id,"complete",`Avatars generated for ${m.name}`),ue.success(`âœ… Avatars generated for ${m.name}`),E)}catch(G){return E.error=String(G),s==null||s(m.id,"error",E.error),ue.error(`Failed to generate avatars for ${m.name}:`,G),E}}),v=await Promise.all(J);C.push(...v)}if(I.size>0){ue.info(`ðŸ’¾ Saving ${I.size} character avatar updates...`);const F=await Ee.getCharacterData(),P=F.characters.map(J=>I.get(J.id)||J);await Ee.saveCharacterData({...F,characters:P}),ue.success(`ðŸ’¾ Saved character data for ${I.size} characters`)}const q=C.filter(F=>F.success).length,R=C.filter(F=>!F.success&&!F.skipped).length,A=C.filter(F=>F.skipped).length;return ue.info(`Avatar generation complete: ${q} success, ${R} failed, ${A} skipped`),{results:C,successCount:q,failCount:R,skipCount:A}},async regenerateAvatarsForCharacter(r,l,i){ue.info(`ðŸ”„ Regenerating avatars for character ${r}...`);const s=(await Ee.getCharacterData()).characters.find(p=>p.id===r);if(!s)return{characterId:r,characterName:"Unknown",success:!1,error:"Character not found"};const D={...s,avatars:{status:"pending"}};return Ee.generateAndSaveAvatarForCharacter(D,l?(p,C)=>l(p,C):void 0,i)}},mn={sm:"h-1",md:"h-2",lg:"h-3"},ro={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function so({value:r,max:l=100,label:i,showPercentage:b=!1,size:s="md",variant:D="gradient",className:p=""}){const C=Math.min(Math.max(r/l*100,0),100);return e.jsxs("div",{className:p,children:[(i||b)&&e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[i&&e.jsx("span",{className:"text-sm font-medium text-gray-700",children:i}),b&&e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(C),"%"]})]}),e.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${mn[s]}`,children:e.jsx("div",{className:`${mn[s]} ${ro[D]} rounded-full transition-all duration-500 ease-out`,style:{width:`${C}%`}})})]})}const pr=Pa("ImageLoad");function Vs({src:r,alt:l,className:i,label:b}){const[s,D]=o.useState(!0),[p,C]=o.useState(null),I=o.useRef(0),q=o.useRef(null);o.useEffect(()=>{r&&r.length>100?(I.current=Date.now(),pr.info(`â³ Loading ${b||l}`,{isBase64:r==null?void 0:r.startsWith("data:"),sizeKB:Math.round(r.length*3/4/1024)})):I.current=0,D(!0),C(null)},[r,l,b]);const R=()=>{if(D(!1),I.current===0){pr.info(`âœ… Loaded ${b||l} (placeholder/empty)`);return}const F=Date.now()-I.current;C(F);const J=(r==null?void 0:r.startsWith("data:"))?Math.round(r.length*3/4/1024):null,v=q.current?`${q.current.naturalWidth}x${q.current.naturalHeight}`:"unknown";F<100?pr.success(`âœ… Loaded ${b||l} in ${F}ms`,{sizeKB:J,naturalSize:v}):F<500?pr.info(`âœ… Loaded ${b||l} in ${F}ms`,{sizeKB:J,naturalSize:v}):F<2e3?pr.warn(`âš ï¸ Slow load: ${b||l} took ${F}ms`,{sizeKB:J,naturalSize:v}):pr.error(`ðŸ¢ Very slow: ${b||l} took ${F}ms`,{sizeKB:J,naturalSize:v}),F>1e3&&ao({type:"slow_image_load",label:b||l,loadTimeMs:F,sizeKB:J,naturalSize:v,userAgent:navigator.userAgent,timestamp:new Date().toISOString()})},A=()=>{if(D(!1),I.current===0){pr.error(`âŒ Failed to load ${b||l} (no data received)`);return}const F=Date.now()-I.current;pr.error(`âŒ Failed to load ${b||l} after ${F}ms`)};return e.jsx("img",{ref:q,src:r,alt:l,className:i,onLoad:R,onError:A,draggable:!1})}async function ao(r){try{await fetch("/api/log-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errorType:"Performance",message:`Slow image load: ${r.label} took ${r.loadTimeMs}ms`,userAgent:r.userAgent,timestamp:r.timestamp,url:window.location.href})})}catch{}}function no({step:r,text:l}){const i=`wizard_helper_dismissed_${r}`,[b,s]=o.useState(()=>localStorage.getItem(i)==="true");o.useEffect(()=>{const p=localStorage.getItem(i)==="true";s(p)},[r,i]);const D=()=>{localStorage.setItem(i,"true"),s(!0)};return b?null:e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[e.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:l}),e.jsx("button",{onClick:D,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:e.jsx($t,{size:16})})]})}function io({current:r,total:l,message:i,isGenerating:b=!0,coverImages:s,jobId:D,onCancel:p,onMinimize:C,characters:I=[],isStalled:q=!1,onDismissStalled:R,isImpersonating:A=!1}){const{language:F}=Kt(),{user:P}=Ta(),J=(P==null?void 0:P.role)==="admin"||A,[v,m]=o.useState(!1),[E,le]=o.useState(0),ne=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit fÃ¼r das grosse Abenteuer...",fr:"{name} se prÃ©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} Ã¼bt gerade die Heldenpose...",fr:"{name} s'entraÃ®ne Ã  prendre la pose du hÃ©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als NÃ¤chstes passiert!",fr:"{name} a hÃ¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} wÃ¤rmt sich fÃ¼r das bevorstehende Abenteuer auf...",fr:"{name} s'Ã©chauffe pour l'aventure Ã  venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir fÃ¼gen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au rÃ©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} flÃ¼stert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'Å“il au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne fÃ¼r die Geschichte...",fr:"{name} collectionne des Ã©toiles pour le rÃ©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],se=o.useRef({}),[B,y]=o.useState(null),G=o.useMemo(()=>I.filter(he=>{var V;const xe=he.avatars;return xe&&(((V=xe.faceThumbnails)==null?void 0:V.standard)||xe.standard||xe.summer||xe.winter||xe.formal||xe.hasFullAvatars)}),[I]),_=he=>{var Te;const xe=he.avatars;if(!xe)return"";if((Te=xe.faceThumbnails)!=null&&Te.standard)return xe.faceThumbnails.standard;const V=[];return xe.standard&&V.push(xe.standard),xe.summer&&V.push(xe.summer),xe.winter&&V.push(xe.winter),xe.formal&&V.push(xe.formal),V[Math.floor(Math.random()*V.length)]||""},N=o.useMemo(()=>{const he=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(G.length===0)return he;const xe=[],V=Math.max(he.length,G.length);for(let Te=0;Te<V;Te++)xe.push(he[Te%he.length]),xe.push({type:"character",char:G[Te%G.length]});return xe},[G]);if(o.useEffect(()=>{if(N.length<=1)return;const he=setInterval(()=>{le(xe=>(xe+1)%N.length)},8e3);return()=>clearInterval(he)},[N.length]),o.useEffect(()=>{if(N.length===0)return;const he=N[E];if(he.type==="character"){const xe=he.char,V=_(xe),st=((se.current[xe.id]??-1)+1)%ne.length;se.current[xe.id]=st;const We=ne[st],jt=(F==="de"?We.de:F==="fr"?We.fr:We.en).replace("{name}",xe.name);y({avatarUrl:V,message:jt})}else y(null)},[E,N,F]),!b||l===0)return null;const te=l===100?r:Math.round(r/l*100),fe=he=>{if(he)return typeof he=="string"?he:he.imageData},M=fe(s==null?void 0:s.frontCover),H=fe(s==null?void 0:s.initialPage),de=fe(s==null?void 0:s.backCover),ve=!!M,ke=!!H,$e=!!de,Y=ve||ke||$e,_e={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollstÃ¤ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erhÃ¤ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz persÃ¶nliches Abenteuer gestalten.',tipLocations:'FÃ¼ge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu fÃ¼r eine persÃ¶nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? FÃ¼r BilderbÃ¼cher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint hÃ¤ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"CrÃ©ation de votre histoire!",timeInfo:"Votre rÃ©cit commencera Ã  s'afficher dans environ 1 minute. Le rÃ©cit complet peut prendre jusqu'Ã  10 minutes.",emailInfo:"Vous recevrez un email quand votre rÃ©cit sera prÃªt.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre rÃ©cit continuera Ã  Ãªtre gÃ©nÃ©rÃ©.",tipCharacters:"Mieux vous dÃ©crivez vos personnages, plus le rÃ©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du rÃ©cit" vous permet de crÃ©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits prÃ©fÃ©rÃ©s Ã  "Intrigue / Contexte du rÃ©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique prÃ©fÃ©rÃ© ? Pour les livres d'images, l'aquarelle fonctionne trÃ¨s bien !",coversPreview:"AperÃ§u des couvertures",frontCover:"Avant",initialPage:"IntÃ©rieur",backCover:"ArriÃ¨re",cancelJob:"Annuler la gÃ©nÃ©ration",cancelling:"Annulation...",stalled:"La gÃ©nÃ©ration semble bloquÃ©e",stalledDesc:"Aucun progrÃ¨s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer Ã  attendre",continueInBackground:"Continuer en arriÃ¨re-plan"}},Se=_e[F]||_e.en,He=({imageData:he,label:xe,isReady:V})=>e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${V?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:V&&he?e.jsx("img",{src:he,alt:xe,className:"w-full h-full object-cover"}):e.jsx(et,{size:20,className:"animate-spin text-gray-400"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[V&&e.jsx(Xa,{size:12,className:"text-green-500"}),e.jsx("span",{className:`text-xs ${V?"text-green-600 font-medium":"text-gray-400"}`,children:xe})]})]});return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${Y?"max-w-lg":"max-w-md"}`,children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("div",{className:"relative inline-block mb-3",children:[e.jsx(et,{size:48,className:"animate-spin text-indigo-600"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"âœ¨"})]}),e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:Se.title})]}),!Y&&N.length>0&&e.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const he=N[E];if(he.type==="character"&&B)return e.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[e.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:e.jsx("img",{src:B.avatarUrl,alt:he.char.name,className:"w-full h-full object-contain"})}),e.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:B.message})]},`char-${he.char.id}-${E}`);if(he.type==="message"){const xe=he.key,V=Se[xe]||"",Te=xe==="timeInfo"?e.jsx(zi,{size:20,className:"text-indigo-500 shrink-0"}):xe==="emailInfo"?e.jsx(Sn,{size:20,className:"text-indigo-500 shrink-0"}):e.jsx(Xa,{size:20,className:"text-indigo-500 shrink-0"});return e.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[Te,e.jsx("p",{className:"text-sm text-gray-700",children:V})]})}return null})()}),Y&&e.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:Se.coversPreview}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(He,{imageData:M,label:Se.frontCover,isReady:ve}),e.jsx(He,{imageData:H,label:Se.initialPage,isReady:ke}),e.jsx(He,{imageData:de,label:Se.backCover,isReady:$e})]})]}),Y&&e.jsxs("div",{className:"mb-4 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[e.jsx(et,{size:14,className:"animate-spin text-indigo-500"}),F==="de"?"Bilder fÃ¼r die Seiten werden jetzt erstellt...":F==="fr"?"CrÃ©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:F==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":F==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),e.jsx("div",{className:"mb-4",children:e.jsx(so,{value:te,max:100,showPercentage:!0,size:"lg"})}),C&&e.jsx("button",{onClick:C,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:Se.continueInBackground}),q&&e.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(wn,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:Se.stalled}),e.jsx("p",{className:"text-sm text-amber-700 mb-3",children:Se.stalledDesc}),e.jsxs("div",{className:"flex gap-2",children:[R&&e.jsx("button",{onClick:R,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:Se.continueWaiting}),p&&e.jsx("button",{onClick:()=>{if(!v){m(!0);try{p()}finally{m(!1)}}},disabled:v,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:v?Se.cancelling:Se.cancelJob})]})]})]})}),J&&D&&p&&e.jsxs("button",{onClick:async()=>{if(!v){m(!0);try{p()}finally{m(!1)}}},disabled:v,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[v?e.jsx(et,{size:16,className:"animate-spin"}):e.jsx(Fi,{size:16}),v?Se.cancelling:Se.cancelJob]})]})})}function Jr(r,l){const i=new Blob([r],{type:"text/plain;charset=utf-8"}),b=URL.createObjectURL(i),s=document.createElement("a");s.href=b,s.download=l,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(b)}function ka(r,l=0){const i="  ".repeat(l);if(r==null)return`${i}null`;if(typeof r=="boolean")return`${i}${r?"YES":"NO"}`;if(typeof r=="number")return`${i}${r}`;if(typeof r=="string")return`${i}${r}`;if(Array.isArray(r))return r.length===0?`${i}[]`:r.map((b,s)=>`${i}[${s}]: ${ka(b,0)}`).join(`
`);if(typeof r=="object"){const b=Object.entries(r);return b.length===0?`${i}{}`:b.map(([s,D])=>{const p=ka(D,l+1);return typeof D=="object"&&D!==null?`${i}${s}:
${p}`:`${i}${s}: ${p.trim()}`}).join(`
`)}return`${i}${String(r)}`}function qs({data:r,language:l,title:i}){const[b,s]=o.useState(new Set);if(!r)return e.jsx("div",{className:"text-gray-400 italic text-sm",children:l==="de"?"Keine Daten":"No data"});let D=r;if(typeof r=="string")try{D=JSON.parse(r)}catch{return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-end mb-1",children:e.jsxs("button",{onClick:()=>Jr(r,`${i||"evaluation"}.txt`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Download as text file",children:[e.jsx(Ir,{size:12})," Download"]})}),e.jsx("pre",{className:"text-sm whitespace-pre-wrap bg-gray-50 p-3 rounded max-h-80 overflow-auto font-mono",children:r})]})}const p=q=>{const R=new Set(b);R.has(q)?R.delete(q):R.add(q),s(R)},C=()=>{const q=ka(D);Jr(q,`${i||"evaluation"}.txt`)},I=(q,R,A=0)=>{const F=b.has(q);if(R==null)return e.jsx("span",{className:"text-gray-400",children:"null"});if(typeof R=="boolean")return e.jsx("span",{className:R?"text-green-600 font-medium":"text-red-600 font-medium",children:R?"âœ“":"âœ—"});if(typeof R=="number"){const P=R>=70?"text-green-600":R>=50?"text-yellow-600":"text-red-600";return e.jsx("span",{className:`font-bold ${P}`,children:R})}if(typeof R=="string")return R.length>100?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>p(q),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[F?e.jsx(or,{size:14}):e.jsx(Ca,{size:14}),F?"Collapse":`Show (${R.length} chars)`]}),F&&e.jsx("div",{className:"mt-1 p-2 bg-gray-100 rounded text-sm whitespace-pre-wrap font-mono",children:R})]}):e.jsx("span",{className:"text-gray-700",children:R});if(Array.isArray(R))return R.length===0?e.jsx("span",{className:"text-gray-400",children:"[]"}):e.jsx("div",{className:"ml-2 border-l-2 border-gray-200 pl-2",children:R.map((P,J)=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"text-gray-400 text-xs",children:["[",J,"]"]})," ",I(`${q}.${J}`,P,A+1)]},J))});if(typeof R=="object"){const P=Object.entries(R);return P.length===0?e.jsx("span",{className:"text-gray-400",children:"{}"}):A>0?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>p(q),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[F?e.jsx(or,{size:14}):e.jsx(Ca,{size:14}),F?"Collapse":`{${P.length} fields}`]}),F&&e.jsx("div",{className:"ml-2 mt-1 border-l-2 border-gray-200 pl-2",children:P.map(([J,v])=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium text-gray-600",children:[J,":"]})," ",I(`${q}.${J}`,v,A+1)]},J))})]}):e.jsx("div",{className:"space-y-1",children:P.map(([J,v])=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-medium text-gray-600 min-w-[100px]",children:[J,":"]}),e.jsx("div",{className:"flex-1",children:I(`${q}.${J}`,v,A+1)})]},J))})}return e.jsx("span",{children:String(R)})};return e.jsxs("div",{className:"text-sm space-y-1 max-h-[500px] overflow-auto",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:C,className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",title:"Download as text file",children:[e.jsx(Ir,{size:12})," Download"]})}),I("root",D)]})}function oo({beforeImage:r,maskImage:l,onEnlarge:i}){return e.jsxs("div",{className:"relative w-40 h-40 cursor-pointer hover:ring-2 hover:ring-amber-400 rounded overflow-hidden border",onClick:()=>i(r,"Before with Mask"),children:[e.jsx("img",{src:r,alt:"Before",className:"w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 w-full h-full",style:{backgroundImage:`url(${l})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",mixBlendMode:"multiply",opacity:.5}}),e.jsx("img",{src:l,alt:"Mask overlay",className:"absolute inset-0 w-full h-full object-contain pointer-events-none",style:{mixBlendMode:"screen",opacity:.7,filter:"sepia(1) saturate(5) hue-rotate(-50deg)"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-[10px] text-center py-1 font-medium",children:"ðŸŽ¯ Edit Area"})]})}function Ur({retryHistory:r,totalAttempts:l,language:i,onRevertRepair:b,storyId:s,pageNumber:D}){const[p,C]=o.useState(null),[I,q]=o.useState({}),[R,A]=o.useState(new Set),F=async m=>{if(!(!s||D===void 0||R.has(m))){A(E=>new Set(E).add(m));try{const E=localStorage.getItem("auth_token"),le=new URLSearchParams({page:String(D),type:"retry",index:String(m)}),ne=await fetch(`/api/stories/${s}/dev-image?${le}`,{headers:E?{Authorization:`Bearer ${E}`}:{}});if(ne.ok){const se=await ne.json();q(B=>({...B,[m]:{annotatedOriginal:se.annotatedOriginal,grids:se.grids,bboxOverlayImage:se.bboxOverlayImage}}))}}catch(E){console.error(`Failed to load retry images for retry ${m}:`,E)}finally{A(E=>{const le=new Set(E);return le.delete(m),le})}}};if(!r||r.length===0)return null;const P=r.filter(m=>m.type==="auto_repair"||m.type==="grid_repair"||m.type==="grid_repair_failed").length,J=r.filter(m=>m.type==="grid_repair"||m.type==="grid_repair_failed").length,v=r.filter(m=>m.type==="grid_repair_failed").length;return e.jsxs(e.Fragment,{children:[p&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>C(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:p.title}),e.jsx("img",{src:p.src,alt:p.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>C(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-purple-700 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Bi,{size:14}),i==="de"?"Generierungshistorie":i==="fr"?"Historique de gÃ©nÃ©ration":"Generation History",P>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["ðŸ”§ ",P," ",i==="de"?"Reparatur":"repair",P>1?i==="de"?"en":"s":"",J>0&&e.jsxs("span",{className:"ml-1",children:["(",J," grid",v>0?`, ${v} failed`:"",")"]})]})]}),e.jsxs("span",{className:"text-purple-600",children:[l," ",i==="de"?"Versuche":i==="fr"?"tentatives":"attempts"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:r.map((m,E)=>{var le,ne,se,B;return e.jsxs("div",{className:`border rounded-lg p-3 ${m.type==="grid_repair_failed"?"bg-red-50 border-red-300":m.type==="grid_repair"?"bg-violet-50 border-violet-300":m.type==="auto_repair"?"bg-amber-50 border-amber-300":E===r.length-1?"bg-green-50 border-green-300":"bg-white border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[m.type==="grid_repair_failed"?e.jsx("span",{className:"text-red-700",children:"ðŸ”² Grid Repair Failed"}):m.type==="grid_repair"?e.jsx("span",{className:"text-violet-700",children:"ðŸ”² Grid Repair"}):m.type==="auto_repair"?e.jsx("span",{className:"text-amber-700",children:"ðŸ”§ Auto-Repair"}):e.jsx(e.Fragment,{children:i==="de"?`Versuch ${m.attempt}`:i==="fr"?`Tentative ${m.attempt}`:`Attempt ${m.attempt}`}),m.type==="text_edit"&&e.jsx("span",{className:"text-xs ml-2 text-blue-600",children:"(text edit)"}),m.type==="text_edit_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(text edit failed)"}),m.type==="auto_repair_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(auto-repair failed)"}),E===r.length-1&&m.type!=="auto_repair"&&e.jsx("span",{className:"text-xs ml-2 text-green-600 font-bold",children:"âœ“ USED"})]}),m.type==="auto_repair"&&m.preRepairScore!==void 0&&m.postRepairScore!==void 0?e.jsxs("span",{className:"font-bold text-sm",children:[e.jsxs("span",{className:m.preRepairScore>=70?"text-green-600":m.preRepairScore>=50?"text-yellow-600":"text-red-600",children:[m.preRepairScore,"%"]}),e.jsx("span",{className:"text-gray-400 mx-1",children:"â†’"}),e.jsxs("span",{className:m.postRepairScore>=70?"text-green-600":m.postRepairScore>=50?"text-yellow-600":"text-red-600",children:[m.postRepairScore,"%"]})]}):m.score!==void 0&&e.jsxs("span",{className:`font-bold ${m.score>=70?"text-green-600":m.score>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(m.score),"%"]})]}),m.error&&e.jsxs("div",{className:"text-xs text-red-600 mb-2",children:["Error: ",m.error]}),m.textIssue&&m.textIssue!=="NONE"&&e.jsxs("div",{className:"text-xs text-orange-600 mb-2",children:["Text issue: ",m.textIssue,m.expectedText&&e.jsxs("span",{className:"block",children:['Expected: "',m.expectedText,'"']}),m.actualText&&e.jsxs("span",{className:"block",children:['Actual: "',m.actualText,'"']})]}),m.type==="auto_repair"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[m.fixTargetsCount&&e.jsxs("div",{className:"text-xs text-amber-700",children:["Fixed ",m.fixTargetsCount," target",m.fixTargetsCount>1?"s":""]}),b&&((ne=(le=m.repairDetails)==null?void 0:le[0])==null?void 0:ne.beforeImage)&&m.postRepairScore!==void 0&&m.preRepairScore!==void 0&&m.postRepairScore<=m.preRepairScore&&e.jsxs("button",{onClick:()=>b(E,m.repairDetails[0].beforeImage),className:"text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded border border-red-300 transition-colors",children:["â†©ï¸ ",i==="de"?"ZurÃ¼cksetzen":"Revert to Original"]})]}),m.postRepairScore!==void 0&&m.preRepairScore!==void 0&&m.postRepairScore<m.preRepairScore&&e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200",children:["âš ï¸ ",i==="de"?`Bewertung verschlechtert: ${m.preRepairScore}% â†’ ${m.postRepairScore}%`:`Score decreased: ${m.preRepairScore}% â†’ ${m.postRepairScore}%`]}),m.bboxDetection&&Array.isArray(m.bboxDetection)&&m.bboxDetection.length>0&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900",children:["ðŸ“¦ ",i==="de"?"Bounding Box Erkennung":"Bounding Box Detection"," (",m.bboxDetection.length,")"]}),e.jsx("div",{className:"mt-3 space-y-2",children:m.bboxDetection.map((y,G)=>e.jsxs("div",{className:`p-3 rounded-lg border ${y.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:`font-medium text-sm ${y.success?"text-green-800":"text-red-800"}`,children:[y.success?"âœ“":"âœ—"," ",y.issue.substring(0,60),y.issue.length>60?"...":""]}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${y.severity==="CRITICAL"?"bg-red-200 text-red-800":y.severity==="MAJOR"?"bg-orange-200 text-orange-800":y.severity==="MODERATE"?"bg-yellow-200 text-yellow-800":"bg-gray-200 text-gray-800"}`,children:[y.severity," â€¢ ",y.type]})]}),y.success&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${y.faceBox?"bg-purple-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-purple-800",children:"Face Box:"}),y.faceBox?e.jsxs("span",{className:"ml-1 font-mono text-purple-600",children:["[",y.faceBox.map(_=>(_*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]}),e.jsxs("div",{className:`p-2 rounded ${y.bodyBox?"bg-blue-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Body Box:"}),y.bodyBox?e.jsxs("span",{className:"ml-1 font-mono text-blue-600",children:["[",y.bodyBox.map(_=>(_*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]})]}),y.label&&y.label!==y.issue&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Detected as:"})," ",y.label]}),y.usage&&e.jsxs("div",{className:"mt-1 text-xs text-gray-400",children:["Tokens: ",y.usage.input_tokens," in / ",y.usage.output_tokens," out"]})]},G))})]}),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ“Š ",i==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[m.preRepairScore,"%"]})]}),e.jsx(qs,{data:m.preRepairEval||m.reasoning,language:i,title:`evaluation-before-attempt-${E}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[m.postRepairScore,"%"]})]}),e.jsx(qs,{data:m.postRepairEval,language:i,title:`evaluation-after-attempt-${E}`})]})]})]}),m.repairDetails&&m.repairDetails.length>0&&e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ–¼ï¸ ",i==="de"?"Reparatur-Details":"Repair Details"," (",m.repairDetails.length,")"]}),e.jsx("div",{className:"mt-3 space-y-3",children:m.repairDetails.map((y,G)=>{var _,N;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("div",{className:"font-medium text-amber-800 text-base",children:y.description}),y.modelId&&e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded",children:y.modelId})]}),e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:["Show fix prompt",e.jsxs("button",{onClick:te=>{te.stopPropagation(),Jr(y.fullPrompt||y.fixPrompt||"",`fix-prompt-${G}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(Ir,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:y.fullPrompt||y.fixPrompt})]}),e.jsxs("div",{className:"flex gap-4 items-start",children:[y.beforeImage&&y.maskImage?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before + Mask"}),e.jsx(oo,{beforeImage:y.beforeImage,maskImage:y.maskImage,onEnlarge:(te,fe)=>C({src:te,title:fe})})]}):y.beforeImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before"}),e.jsx("img",{src:y.beforeImage,alt:"Before",className:"w-32 h-32 object-contain border rounded cursor-pointer hover:ring-2 hover:ring-amber-400",onClick:()=>C({src:y.beforeImage,title:"Before Repair"})})]}),e.jsx("div",{className:"flex items-center h-32 text-gray-400 text-2xl",children:"â†’"}),y.afterImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"After"}),e.jsx("img",{src:y.afterImage,alt:"After",className:"w-32 h-32 object-contain border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>C({src:y.afterImage,title:"After Repair"})})]})]}),y.verification&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded border text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"ðŸ” Verification:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[y.verification.lpips&&e.jsxs("div",{className:`p-2 rounded ${y.verification.lpips.changed?"bg-green-100":"bg-yellow-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LPIPS: "}),e.jsx("span",{className:y.verification.lpips.changed?"text-green-700":"text-yellow-700",children:(_=y.verification.lpips.lpipsScore)==null?void 0:_.toFixed(4)}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",y.verification.lpips.changed?"âœ“ changed":"âš  unchanged",")"]})]}),y.verification.llm&&e.jsxs("div",{className:`p-2 rounded ${y.verification.llm.fixed?"bg-green-100":"bg-red-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LLM: "}),e.jsx("span",{className:y.verification.llm.fixed?"text-green-700":"text-red-700",children:y.verification.llm.fixed?"âœ“ Fixed":"âœ— Not fixed"}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",Math.round(y.verification.llm.confidence*100),"%)"]})]})]}),((N=y.verification.llm)==null?void 0:N.explanation)&&e.jsx("div",{className:"mt-2 text-gray-600 text-sm italic",children:y.verification.llm.explanation})]})]},G)})})]})]}),(m.type==="grid_repair"||m.type==="grid_repair_failed")&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[m.gridTotalIssues!==void 0&&e.jsxs("span",{className:"text-violet-700",children:[i==="de"?"Probleme:":"Issues:"," ",m.gridTotalIssues]}),m.gridFixedCount!==void 0&&e.jsxs("span",{className:"text-green-600",children:["âœ“ ",i==="de"?"Behoben:":"Fixed:"," ",m.gridFixedCount]}),m.gridFailedCount!==void 0&&m.gridFailedCount>0&&e.jsxs("span",{className:"text-red-600",children:["âœ— ",i==="de"?"Fehlgeschlagen:":"Failed:"," ",m.gridFailedCount]})]}),m.type==="grid_repair_failed"&&m.failReason&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-100 p-2 rounded border border-red-200",children:["âš ï¸ ",i==="de"?"Fehlergrund:":"Failure reason:"," ",m.failReason==="no_repairs_made"?i==="de"?"Keine Reparaturen durchgefÃ¼hrt":"No repairs were made":m.failReason==="no_image_data"?i==="de"?"Keine Bilddaten zurÃ¼ckgegeben":"No image data returned":m.failReason==="image_too_small"?i==="de"?"ZurÃ¼ckgegebenes Bild zu klein/ungÃ¼ltig":"Returned image too small/invalid":m.failReason==="image_unchanged"?i==="de"?"Bild wurde nicht verÃ¤ndert":"Image was not changed":m.failReason]}),(()=>{var G;const y=m.annotatedOriginal||((G=I[E])==null?void 0:G.annotatedOriginal);return y?e.jsxs("details",{className:"text-sm",open:!0,children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“ ",i==="de"?"Schritt 1: Erkannte Probleme":"Step 1: Detected Issues"]}),e.jsxs("div",{className:"mt-3 bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-2 font-medium",children:[i==="de"?"Originalbild mit markierten Problembereichen":"Original image with marked issue regions",e.jsxs("span",{className:"ml-2 text-gray-400",children:["(ðŸ”´ ",i==="de"?"kritisch":"critical",", ðŸŸ  ",i==="de"?"wichtig":"major",", ðŸŸ¡ ",i==="de"?"gering":"minor",")"]})]}),e.jsx("img",{src:`data:image/jpeg;base64,${y}`,alt:"Annotated original",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>C({src:`data:image/jpeg;base64,${y}`,title:i==="de"?"Erkannte Probleme":"Detected Issues"})})]})]}):m.hasAnnotatedOriginal&&s&&D!==void 0?e.jsx("button",{onClick:()=>F(E),disabled:R.has(E),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:R.has(E)?e.jsxs(e.Fragment,{children:[e.jsx(et,{size:14,className:"animate-spin"})," Loading..."]}):e.jsx(e.Fragment,{children:"ðŸ“ Load Detected Issues"})}):null})(),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“Š ",i==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[m.preRepairScore,"%"]})]}),e.jsx(qs,{data:m.preRepairEval||m.reasoning,language:i,title:`evaluation-before-grid-${E}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[m.postRepairScore,"%"]})]}),e.jsx(qs,{data:m.postRepairEval,language:i,title:`evaluation-after-grid-${E}`})]})]})]}),(()=>{var G,_;const y=m.grids||((G=I[E])==null?void 0:G.grids);return y&&y.length>0?e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ”² ",i==="de"?"Grid-Details":"Grid Details"," (",y.length," ",y.length===1?"grid":"grids",")"]}),e.jsx("div",{className:"mt-3 space-y-4",children:y.map((N,te)=>{var fe,M;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("span",{className:"font-medium text-violet-800",children:["Grid"," ",N.batchNum||te+1]}),((fe=N.manifest)==null?void 0:fe.issues)&&e.jsxs("span",{className:"text-xs text-gray-500",children:[N.manifest.issues.length," ",i==="de"?"Regionen":"regions"]})]}),((M=N.manifest)==null?void 0:M.issues)&&N.manifest.issues.length>0&&e.jsxs("div",{className:"mb-3 p-2 bg-violet-50 rounded text-sm",children:[e.jsx("div",{className:"font-medium text-violet-800 mb-1",children:i==="de"?"Zu reparierende Probleme:":"Issues to repair:"}),e.jsx("div",{className:"space-y-1",children:N.manifest.issues.map((H,de)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-mono font-bold text-violet-600 min-w-[20px]",children:[H.letter,":"]}),e.jsx("span",{className:"text-gray-700",children:H.fixInstruction||H.description||"Unknown issue"})]},de))})]}),N.prompt&&e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:[i==="de"?"Reparatur-Prompt anzeigen":"Show repair prompt",e.jsxs("button",{onClick:H=>{H.stopPropagation(),Jr(N.prompt||"",`grid-repair-prompt-${te}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(Ir,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:N.prompt})]}),e.jsxs("div",{className:"flex gap-4 items-start flex-wrap",children:[N.original&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:i==="de"?"Original-Grid":"Input Grid"}),e.jsx("img",{src:N.original.startsWith("data:")?N.original:`data:image/png;base64,${N.original}`,alt:"Input grid",className:"max-w-xs border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>C({src:N.original.startsWith("data:")?N.original:`data:image/png;base64,${N.original}`,title:i==="de"?"Original-Grid":"Input Grid"})})]}),N.original&&N.repaired&&e.jsx("div",{className:"flex items-center self-center text-gray-400 text-2xl",children:"â†’"}),N.repaired&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:i==="de"?"Repariertes Grid":"Repaired Grid"}),e.jsx("img",{src:N.repaired.startsWith("data:")?N.repaired:`data:image/png;base64,${N.repaired}`,alt:"Repaired grid",className:"max-w-xs border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>C({src:N.repaired.startsWith("data:")?N.repaired:`data:image/png;base64,${N.repaired}`,title:i==="de"?"Repariertes Grid":"Repaired Grid"})})]})]}),N.repairs&&N.repairs.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"font-medium text-violet-800 mb-2",children:["âœ… ",i==="de"?"Verifizierungsergebnisse":"Verification Results"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-violet-100 text-violet-800",children:[e.jsx("th",{className:"px-2 py-1 text-left border",children:"Ltr"}),e.jsx("th",{className:"px-2 py-1 text-left border",children:i==="de"?"Problem":"Issue"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:i==="de"?"Vorher":"Before"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:i==="de"?"Nachher":"After"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:"Diff"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:"Status"}),e.jsx("th",{className:"px-2 py-1 text-center border",children:i==="de"?"Konfidenz":"Confidence"})]})}),e.jsx("tbody",{children:N.repairs.map((H,de)=>{var ve,ke,$e,Y,_e,Se,He,he;return e.jsxs("tr",{className:(ve=H.verification)!=null&&ve.accepted?"bg-green-50":"bg-red-50",children:[e.jsx("td",{className:"px-2 py-1 border font-mono font-bold text-violet-600",children:H.letter}),e.jsxs("td",{className:"px-2 py-1 border text-gray-700 max-w-[200px] truncate",title:H.description,children:[e.jsx("span",{className:`inline-block px-1 py-0.5 rounded text-xs mr-1 ${H.severity==="critical"?"bg-red-200 text-red-800":H.severity==="major"?"bg-orange-200 text-orange-800":"bg-yellow-200 text-yellow-800"}`,children:H.type||"unknown"}),(ke=H.description)==null?void 0:ke.substring(0,40),((($e=H.description)==null?void 0:$e.length)||0)>40?"...":""]}),e.jsx("td",{className:"px-2 py-1 border text-center",children:H.originalThumbnail&&e.jsx("img",{src:`data:image/jpeg;base64,${H.originalThumbnail}`,alt:"Before",className:"w-12 h-12 object-contain inline-block cursor-pointer hover:ring-2 hover:ring-violet-400 rounded",onClick:()=>C({src:`data:image/jpeg;base64,${H.originalThumbnail}`,title:`${H.letter}: Before`})})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:H.repairedThumbnail&&e.jsx("img",{src:`data:image/jpeg;base64,${H.repairedThumbnail}`,alt:"After",className:`w-12 h-12 object-contain inline-block cursor-pointer hover:ring-2 rounded ${(Y=H.verification)!=null&&Y.accepted?"hover:ring-green-400 border-green-300":"hover:ring-red-400 border-red-300"}`,onClick:()=>C({src:`data:image/jpeg;base64,${H.repairedThumbnail}`,title:`${H.letter}: After`})})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:H.diffImage?e.jsx("img",{src:`data:image/jpeg;base64,${H.diffImage}`,alt:"Diff",className:"w-12 h-12 object-contain inline-block cursor-pointer hover:ring-2 hover:ring-purple-400 rounded",onClick:()=>C({src:`data:image/jpeg;base64,${H.diffImage}`,title:`${H.letter}: Diff`})}):e.jsx("span",{className:"text-gray-400 text-xs",children:"-"})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:(_e=H.verification)!=null&&_e.accepted?e.jsx("span",{className:"text-green-600 font-bold",children:"âœ“"}):e.jsx("span",{className:"text-red-600 font-bold",children:"âœ—"})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:e.jsxs("span",{className:`font-medium ${(((Se=H.verification)==null?void 0:Se.confidence)??0)>=.7?"text-green-600":(((He=H.verification)==null?void 0:He.confidence)??0)>=.5?"text-yellow-600":"text-red-600"}`,children:[Math.round((((he=H.verification)==null?void 0:he.confidence)??0)*100),"%"]})})]},de)})})]})}),N.repairs.filter(H=>{var de;return!((de=H.verification)!=null&&de.accepted)}).map((H,de)=>{var ve,ke;return e.jsxs("div",{className:"mt-2 text-sm text-red-600 bg-red-50 p-2 rounded border border-red-200",children:[e.jsxs("span",{className:"font-mono font-bold",children:[H.letter,":"]})," ",((ve=H.verification)==null?void 0:ve.reason)||((ke=H.verification)==null?void 0:ke.explanation)||"Unknown failure reason"]},de)})]})]},te)})})]}):m.hasGrids&&s&&D!==void 0&&!((_=I[E])!=null&&_.grids)?e.jsx("button",{onClick:()=>F(E),disabled:R.has(E),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:R.has(E)?e.jsxs(e.Fragment,{children:[e.jsx(et,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ”² Load Grid Details (",m.gridsCount||"?"," grids)"]})}):null})()]}),m.bboxDetection&&typeof m.bboxDetection=="object"&&"figures"in m.bboxDetection&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¦ ",i==="de"?"Objekterkennung":"Object Detection",e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:[((se=m.bboxDetection.figures)==null?void 0:se.length)||0," ",i==="de"?"Figuren":"figures",","," ",((B=m.bboxDetection.objects)==null?void 0:B.length)||0," ",i==="de"?"Objekte":"objects"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[(()=>{var G;const y=m.bboxOverlayImage||((G=I[E])==null?void 0:G.bboxOverlayImage);return y?e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:[i==="de"?"Erkannte Regionen":"Detected Regions",e.jsx("span",{className:"ml-2 text-gray-400",children:"(ðŸŸ¢ Body, ðŸ”µ Face, ðŸŸ  Object)"})]}),e.jsx("img",{src:y,alt:"Bbox overlay",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-blue-400",onClick:()=>C({src:y,title:i==="de"?"Erkannte Regionen":"Detected Regions"})})]}):m.hasBboxOverlay&&s&&D!==void 0?e.jsx("button",{onClick:()=>F(E),disabled:R.has(E),className:"text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:R.has(E)?e.jsxs(e.Fragment,{children:[e.jsx(et,{size:14,className:"animate-spin"})," ",i==="de"?"LÃ¤dt...":"Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ“¦ ",i==="de"?"Erkannte Regionen laden":"Load Detected Regions"]})}):null})(),(()=>{const y=m.bboxDetection;return!(y!=null&&y.expectedPositions)||Object.keys(y.expectedPositions).length===0?null:e.jsxs("div",{className:"bg-purple-50 p-3 rounded border border-purple-200",children:[e.jsxs("div",{className:"font-medium text-purple-800 mb-2",children:["ðŸ“ ",i==="de"?"Erwartete Positionen":"Expected Positions"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:Object.entries(y.expectedPositions).map(([G,_])=>e.jsxs("div",{className:"bg-white p-2 rounded border flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-purple-700",children:G}),e.jsx("span",{className:"text-gray-600 text-xs",children:_})]},G))})]})})(),(()=>{const y=m.bboxDetection;return!(y!=null&&y.positionMismatches)||y.positionMismatches.length===0?null:e.jsxs("div",{className:"bg-yellow-50 p-3 rounded border border-yellow-300",children:[e.jsxs("div",{className:"font-medium text-yellow-800 mb-2",children:["âš ï¸ ",i==="de"?"Positionsabweichungen":"Position Mismatches"," (",y.positionMismatches.length,")"]}),e.jsx("div",{className:"space-y-2",children:y.positionMismatches.map((G,_)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border border-yellow-200",children:[e.jsx("div",{className:"font-medium text-yellow-700",children:G.character}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1 flex gap-3",children:[e.jsxs("span",{children:[i==="de"?"Erwartet":"Expected",": ",e.jsx("span",{className:"font-medium text-purple-600",children:G.expected}),e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",G.expectedLCR,")"]})]}),e.jsx("span",{className:"text-gray-400",children:"â†’"}),e.jsxs("span",{children:[i==="de"?"Erkannt":"Actual",": ",e.jsx("span",{className:"font-medium text-orange-600",children:G.actual})]})]})]},_))})]})})(),(()=>{const y=m.bboxDetection;return!(y!=null&&y.missingCharacters)||y.missingCharacters.length===0?null:e.jsxs("div",{className:"bg-red-50 p-3 rounded border border-red-300",children:[e.jsxs("div",{className:"font-medium text-red-800 mb-2",children:["âŒ ",i==="de"?"Fehlende Charaktere":"Missing Characters"," (",y.missingCharacters.length,")"]}),e.jsx("div",{className:"text-sm text-red-700",children:i==="de"?"Diese Charaktere wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These characters were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:y.missingCharacters.map((G,_)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-red-200 text-sm font-medium text-red-700",children:G},_))})]})})(),m.bboxDetection.figures&&m.bboxDetection.figures.length>0&&e.jsxs("div",{className:"bg-green-50 p-3 rounded border border-green-200",children:[e.jsxs("div",{className:"font-medium text-green-800 mb-2",children:[i==="de"?"Figuren":"Figures"," (",m.bboxDetection.figures.length,")"]}),e.jsx("div",{className:"space-y-2",children:m.bboxDetection.figures.map((y,G)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-green-700",children:y.label||`Figure ${G+1}`}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 grid grid-cols-2 gap-2",children:[y.bodyBox&&e.jsxs("span",{children:["Body: [",y.bodyBox.map(_=>(_*100).toFixed(0)+"%").join(", "),"]"]}),y.faceBox&&e.jsxs("span",{children:["Face: [",y.faceBox.map(_=>(_*100).toFixed(0)+"%").join(", "),"]"]}),y.position&&e.jsxs("span",{children:["Pos: ",y.position]})]})]},G))})]}),m.bboxDetection.objects&&m.bboxDetection.objects.length>0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsxs("div",{className:"font-medium text-orange-800 mb-2",children:[i==="de"?"Objekte":"Objects"," (",m.bboxDetection.objects.length,")"]}),e.jsx("div",{className:"space-y-2",children:m.bboxDetection.objects.map((y,G)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-orange-700",children:y.label||`Object ${G+1}`}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[y.bodyBox&&e.jsxs("span",{children:["Box: [",y.bodyBox.map(_=>(_*100).toFixed(0)+"%").join(", "),"]"]}),y.position&&e.jsxs("span",{className:"ml-2",children:["Pos: ",y.position]})]})]},G))})]}),e.jsxs("button",{onClick:()=>Jr(JSON.stringify(m.bboxDetection,null,2),`bbox-detection-attempt-${E}.json`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",children:[e.jsx(Ir,{size:12})," ",i==="de"?"JSON herunterladen":"Download JSON"]})]})]}),m.type!=="auto_repair"&&m.type!=="grid_repair"&&m.type!=="grid_repair_failed"&&m.prompt&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¤ ",i==="de"?"Eingabe-Prompt":"Input Prompt",e.jsxs("button",{onClick:y=>{y.stopPropagation(),Jr(m.prompt||"",`prompt-attempt-${m.attempt}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(Ir,{size:10})," Download"]})]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-blue-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono border border-blue-200",children:m.prompt})]}),m.type!=="auto_repair"&&m.type!=="grid_repair"&&m.type!=="grid_repair_failed"&&m.reasoning?e.jsxs("details",{className:"text-sm text-gray-600 mb-2",children:[e.jsxs("summary",{className:"cursor-pointer font-medium",children:["ðŸ“¥ ",i==="de"?"Bewertungs-Feedback":"Evaluation Feedback"]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-gray-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono",children:m.reasoning})]}):m.type!=="auto_repair"&&m.type!=="grid_repair"&&m.type!=="grid_repair_failed"&&m.score===0&&e.jsx("div",{className:"text-sm text-gray-500 italic mb-2",children:i==="de"?"QualitÃ¤tsbewertung fehlgeschlagen":i==="fr"?"Ã‰valuation de qualitÃ© Ã©chouÃ©e":"Quality evaluation failed"}),m.imageData&&m.type!=="auto_repair"&&m.type!=="grid_repair"&&m.type!=="grid_repair_failed"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:i==="de"?"Generiertes Bild":"Generated Image"}),e.jsx("img",{src:m.imageData,alt:`Attempt ${m.attempt}`,className:`w-48 h-48 object-contain rounded border cursor-pointer hover:ring-2 ${E===r.length-1?"border-green-300 hover:ring-green-400":"border-gray-200 opacity-75 hover:ring-gray-400"}`,onClick:()=>C({src:m.imageData,title:`${i==="de"?"Versuch":"Attempt"} ${m.attempt}`})})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(m.timestamp).toLocaleTimeString()})]},E)})})]})]})}function lo({src:r,alt:l,onClose:i}){const b=o.useCallback(s=>{s.key==="Escape"&&i()},[i]);return o.useEffect(()=>(r&&(document.addEventListener("keydown",b),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",b),document.body.style.overflow="unset"}),[r,b]),r?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm cursor-pointer",onClick:i,children:[e.jsx("button",{onClick:i,className:"absolute top-4 right-4 p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors z-10","aria-label":"Close",children:e.jsx($t,{size:24})}),e.jsx("img",{src:r,alt:l||"Enlarged image",className:"max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl",onClick:s=>s.stopPropagation()})]}):null}function ws({referencePhotos:r,landmarkPhotos:l,language:i,storyId:b,pageNumber:s}){var fe;const[D,p]=o.useState(null),[C,I]=o.useState(null),[q,R]=o.useState(null),[A,F]=o.useState(!1),[P,J]=o.useState(null),v=r==null?void 0:r.some(M=>M.hasPhoto&&!M.photoUrl),m=l==null?void 0:l.some(M=>M.hasPhoto&&!M.photoData),E=o.useCallback(async()=>{if(!(!b||!s||A)&&!(!v&&!m)){F(!0),J(null);try{if(v){const M=await Be.getDevImage(b,s,"reference");M!=null&&M.referencePhotos&&I(M.referencePhotos)}if(m){const M=await Be.getDevImage(b,s,"landmark");M!=null&&M.landmarkPhotos&&R(M.landmarkPhotos)}}catch(M){J(M instanceof Error?M.message:"Failed to load images")}finally{F(!1)}}},[b,s,A,v,m]),le=C||r,ne=q||l,se=le&&le.length>0,B=ne&&ne.length>0;if(!se&&!B)return null;const y=((r==null?void 0:r.length)||0)+((l==null?void 0:l.length)||0),G=M=>{switch(M){case"bodyNoBg":case"body-no-bg":return i==="de"?"GanzkÃ¶rper (freigestellt)":i==="fr"?"Corps entier (dÃ©tourÃ©)":"Full body (no bg)";case"body":return i==="de"?"GanzkÃ¶rper":i==="fr"?"Corps entier":"Full body";case"face":return i==="de"?"Gesicht":i==="fr"?"Visage":"Face only";case"clothing-winter":return i==="de"?"Winter-Avatar":i==="fr"?"Avatar hiver":"Winter avatar";case"clothing-summer":return i==="de"?"Sommer-Avatar":i==="fr"?"Avatar Ã©tÃ©":"Summer avatar";case"clothing-formal":return i==="de"?"Formell-Avatar":i==="fr"?"Avatar formel":"Formal avatar";case"clothing-standard":return i==="de"?"Standard-Avatar":i==="fr"?"Avatar standard":"Standard avatar";case"none":return i==="de"?"Kein Foto":i==="fr"?"Pas de photo":"No photo";default:return M}},_=M=>{switch(M){case"bodyNoBg":case"body-no-bg":return"bg-green-100 text-green-700 border-green-300";case"body":return"bg-blue-100 text-blue-700 border-blue-300";case"face":return"bg-yellow-100 text-yellow-700 border-yellow-300";case"clothing-winter":return"bg-cyan-100 text-cyan-700 border-cyan-300";case"clothing-summer":return"bg-orange-100 text-orange-700 border-orange-300";case"clothing-formal":return"bg-purple-100 text-purple-700 border-purple-300";case"clothing-standard":return"bg-teal-100 text-teal-700 border-teal-300";case"none":return"bg-red-100 text-red-700 border-red-300";default:return"bg-gray-100 text-gray-700 border-gray-300"}},N=(fe=le==null?void 0:le.find(M=>M.clothingCategory))==null?void 0:fe.clothingCategory,te=M=>{if(!M)return"";switch(M){case"winter":return i==="de"?"Winter":i==="fr"?"Hiver":"Winter";case"summer":return i==="de"?"Sommer":i==="fr"?"Ã‰tÃ©":"Summer";case"formal":return i==="de"?"Formell":i==="fr"?"Formel":"Formal";case"standard":return"Standard";default:return M}};return e.jsxs("details",{className:"bg-pink-50 border border-pink-300 rounded-lg p-3",onToggle:M=>{M.target.open&&(v||m)&&E()},children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-900 flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ“¸"}),i==="de"?"Referenzfotos":i==="fr"?"Photos de rÃ©fÃ©rence":"Reference Photos",e.jsxs("span",{className:"text-xs text-pink-600",children:["(",y,")"]}),N&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-pink-200 text-pink-800 text-xs rounded",children:["ðŸ‘• ",te(N)]}),B&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded",children:["ðŸ“ ",ne.length," ",i==="de"?"Wahrzeichen":"Landmark"]}),A&&e.jsx("span",{className:"ml-2 text-xs text-gray-500 animate-pulse",children:"Loading..."})]}),P&&e.jsx("div",{className:"mt-3 text-sm text-red-600 bg-red-50 p-2 rounded",children:P}),se&&e.jsx("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2",children:le.map((M,H)=>e.jsxs("div",{className:"bg-white rounded-lg p-2 border border-pink-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:M.name}),M.photoType&&e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap ${_(M.photoType)}`,children:G(M.photoType)})]}),M.photoUrl?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:M.photoUrl,alt:`${M.name} - ${G(M.photoType||"unknown")}`,className:`w-full max-h-32 object-contain rounded border bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity ${M.isStyled?"border-purple-400 ring-2 ring-purple-200":"border-gray-200"}`,onClick:()=>p(M.photoUrl),title:"Click to enlarge"}),M.isStyled&&e.jsx("span",{className:"absolute top-1 right-1 px-1 py-0.5 text-[9px] font-bold bg-purple-500 text-white rounded",children:"ðŸŽ¨ STYLED"})]}),M.photoHash&&e.jsxs("div",{className:"mt-1 text-[9px] font-mono text-gray-500 bg-gray-100 px-1 py-0.5 rounded text-center",children:["ðŸ” ",M.photoHash]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:i==="de"?"Foto nicht geladen":"Photo not loaded"})]},H))}),B&&e.jsxs("div",{className:se?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-amber-700 mb-2 flex items-center gap-1",children:["ðŸ“ ",i==="de"?"Wahrzeichen-Referenzfotos":i==="fr"?"Photos de monuments":"Landmark Reference Photos"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:ne.map((M,H)=>e.jsxs("div",{className:"bg-amber-50 rounded-lg p-2 border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:M.name}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-amber-100 text-amber-700 border-amber-300",children:"ðŸ“ LANDMARK"})]}),M.photoData?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:M.photoData,alt:`${M.name} landmark`,className:"w-full max-h-32 object-contain rounded border border-amber-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>p(M.photoData),title:"Click to enlarge"})}),M.attribution&&e.jsxs("div",{className:"mt-1 text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 rounded truncate",title:M.attribution,children:["ðŸ“· ",M.attribution]}),M.source&&e.jsxs("div",{className:"mt-0.5 text-[9px] text-gray-400",children:["Source: ",M.source]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:i==="de"?"Foto nicht geladen":"Photo not loaded"})]},H))})]}),e.jsx(lo,{src:D,onClose:()=>p(null)})]})}function co({pageNumber:r,scene:l,onSceneChange:i,onClose:b,onRegenerate:s,isRegenerating:D,imageRegenerationCost:p,characters:C=[],selectedCharacterIds:I=[],onCharacterSelectionChange:q,consistencyRegen:R}){const{language:A}=Kt(),[F,P]=o.useState(!1),[J,v]=o.useState(!1),m=E=>{q&&(I.includes(E)?q(I.filter(le=>le!==E)):q([...I,E]))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(ot,{size:20}),A==="de"?`Szene bearbeiten - Seite ${r}`:A==="fr"?`Modifier la scÃ¨ne - Page ${r}`:`Edit Scene - Page ${r}`]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:A==="de"?"Bearbeiten Sie die Szenenbeschreibung und wÃ¤hlen Sie die Charaktere aus.":A==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages.":"Edit the scene description and select the characters."})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[C.length>0&&q&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(Ia,{size:16}),A==="de"?"Charaktere in dieser Szene:":A==="fr"?"Personnages dans cette scÃ¨ne:":"Characters in this scene:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:C.map(E=>{const le=I.includes(E.id);return e.jsxs("button",{type:"button",onClick:()=>m(E.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${le?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:E.name}),le&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},E.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:A==="de"?"WÃ¤hlen Sie die Charaktere aus, die im Bild erscheinen sollen.":A==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre dans l'image.":"Select the characters that should appear in the image."})]}),R&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(wn,{className:"text-amber-600",size:20}),e.jsx("h4",{className:"font-semibold text-amber-800",children:A==="de"?"Konsistenz-Korrektur angewendet":A==="fr"?"Correction de cohÃ©rence appliquÃ©e":"Consistency Fix Applied"}),e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded",children:["Score: ",R.score,"%"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-amber-700 mb-2",children:A==="de"?"Behobene Probleme:":A==="fr"?"ProblÃ¨mes corrigÃ©s:":"Issues Fixed:"}),e.jsx("ul",{className:"text-sm text-amber-900 space-y-1",children:R.issues.map((E,le)=>e.jsxs("li",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium",children:[E.type.toUpperCase(),E.characterInvolved&&` (${E.characterInvolved})`,":"]}),e.jsx("span",{className:"text-amber-700 ml-2",children:E.description}),e.jsxs("span",{className:"text-amber-600 ml-2 text-xs",children:["â†’ ",E.recommendation]})]},le))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-1 text-center",children:"Original"}),e.jsx("img",{src:R.originalImage,alt:"Original",className:"w-full rounded-lg border border-gray-300",draggable:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-green-600 mb-1 text-center",children:A==="de"?"Korrigiert":A==="fr"?"CorrigÃ©":"Fixed"}),e.jsx("img",{src:R.fixedImage,alt:"Fixed",className:"w-full rounded-lg border-2 border-green-500",draggable:!1})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>P(!F),className:"flex items-center gap-1 text-xs text-gray-600 hover:text-gray-800",children:[F?e.jsx(sn,{size:14}):e.jsx(or,{size:14}),A==="de"?"Original-Prompt":A==="fr"?"Prompt original":"Original Prompt"]}),F&&e.jsx("pre",{className:"text-xs bg-gray-100 p-2 rounded overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:R.originalPrompt}),e.jsxs("button",{onClick:()=>v(!J),className:"flex items-center gap-1 text-xs text-green-600 hover:text-green-800",children:[J?e.jsx(sn,{size:14}):e.jsx(or,{size:14}),A==="de"?"Korrigierter Prompt (mit Korrekturen)":A==="fr"?"Prompt corrigÃ© (avec corrections)":"Fixed Prompt (with corrections)"]}),J&&e.jsx("pre",{className:"text-xs bg-green-50 p-2 rounded border border-green-200 overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:R.fixedPrompt})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:A==="de"?`Korrigiert am ${new Date(R.timestamp).toLocaleString()}`:A==="fr"?`CorrigÃ© le ${new Date(R.timestamp).toLocaleString()}`:`Fixed at ${new Date(R.timestamp).toLocaleString()}`}),R.clothing&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded",children:["ðŸŽ¨ ",R.clothing]})]}),R.avatarsUsed&&R.avatarsUsed.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-blue-50 rounded border border-blue-200",children:[e.jsx("p",{className:"text-xs font-medium text-blue-700 mb-1",children:A==="de"?"Verwendete Avatare:":A==="fr"?"Avatars utilisÃ©s:":"Avatars used:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.avatarsUsed.map((E,le)=>e.jsxs("span",{className:`text-xs px-2 py-1 rounded ${E.hasPhoto?"bg-green-100 text-green-700":"bg-gray-100 text-gray-500"}`,children:[E.name,E.category&&E.category!=="standard"&&e.jsxs("span",{className:"ml-1 opacity-75",children:["(",E.category,")"]}),!E.hasPhoto&&" âš ï¸"]},le))})]}),R.retryHistory&&R.retryHistory.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx(Ur,{retryHistory:R.retryHistory,totalAttempts:R.totalAttempts||1,language:A})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:A==="de"?"Szenenbeschreibung:":A==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:l,onChange:E=>i(E.target.value),className:"w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y",placeholder:A==="de"?"Beschreiben Sie die Szene...":A==="fr"?"DÃ©crivez la scÃ¨ne...":"Describe the scene..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:A==="de"?"Tipp: Beschreiben Sie die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":A==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:I.length>0&&e.jsx("span",{children:A==="de"?`${I.length} Charakter(e) ausgewÃ¤hlt`:A==="fr"?`${I.length} personnage(s) sÃ©lectionnÃ©(s)`:`${I.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:b,disabled:D,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium disabled:opacity-50 order-2 sm:order-1",children:A==="de"?"Abbrechen":A==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:s,disabled:D||!l.trim(),className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${D||!l.trim()?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:D?e.jsxs(e.Fragment,{children:[e.jsx(Ut,{size:16,className:"animate-spin"}),A==="de"?"Generiere...":A==="fr"?"GÃ©nÃ©ration...":"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ut,{size:16}),A==="de"?"Neu generieren":A==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",p,")"]})]})})]})]})]})})}function mo({pageNumber:r,versions:l,onClose:i,onSelectVersion:b,developerMode:s=!1}){const{language:D}=Kt();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Tr,{size:20}),D==="de"?`Bildversionen - Seite ${r}`:D==="fr"?`Versions d'image - Page ${r}`:`Image Versions - Page ${r}`]}),e.jsx("button",{onClick:i,className:"p-1 hover:bg-gray-100 rounded",children:e.jsx($t,{size:20})})]}),e.jsxs("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:l.map((p,C)=>e.jsxs("div",{className:`relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${p.isActive?"border-green-500 ring-2 ring-green-200":"border-gray-200 hover:border-indigo-300"}`,onClick:()=>b(r,C),children:[e.jsx("img",{src:p.imageData,alt:`Version ${C+1}`,className:"w-full aspect-square object-cover"}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:C===0?"Original":`V${C+1}`}),p.isActive&&e.jsx("span",{className:"bg-green-500 px-2 py-0.5 rounded text-[10px] font-bold",children:D==="de"?"Aktiv":D==="fr"?"Actif":"Active"})]}),e.jsx("div",{className:"text-[10px] text-gray-300 mt-1",children:new Date(p.createdAt).toLocaleDateString()})]})]},C))}),s&&l.length>1&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold text-gray-700",children:D==="de"?"Szenen- und Prompt-Vergleich":D==="fr"?"Comparaison de scÃ¨nes et prompts":"Scene & Prompt Comparison"}),l.map((p,C)=>e.jsxs("details",{className:`rounded-lg p-3 ${p.isActive?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-medium text-gray-700",children:[C===0?"Original":`V${C+1}`,p.isActive&&e.jsx("span",{className:"ml-2 text-green-600 text-xs",children:"(Active)"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[p.userInput&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-purple-700",children:D==="de"?"Benutzer-Eingabe:":D==="fr"?"EntrÃ©e utilisateur:":"User Input:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-purple-50 p-2 rounded border border-purple-200 max-h-24 overflow-y-auto",children:p.userInput})]}),p.description&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700",children:D==="de"?"Erweiterte Szene:":D==="fr"?"ScÃ¨ne Ã©tendue:":"Expanded Scene:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-24 overflow-y-auto",children:p.description})]}),p.prompt&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-700",children:D==="de"?"API-Prompt:":D==="fr"?"Prompt API:":"API Prompt:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-32 overflow-y-auto",children:p.prompt})]}),p.modelId&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Model: ",p.modelId]})]})]},C))]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-sm text-gray-500",children:D==="de"?"Klicken Sie auf ein Bild, um es auszuwÃ¤hlen":D==="fr"?"Cliquez sur une image pour la sÃ©lectionner":"Click an image to select it"})]})})}function uo({src:r,title:l,onClose:i}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:i,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-2 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:l}),e.jsx("button",{onClick:i,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx($t,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50",children:e.jsx("img",{src:r,alt:l,className:"max-w-full max-h-[80vh] object-contain mx-auto"})})]})})}function go({beforeImage:r,afterImage:l,diffImage:i,title:b,onClose:s}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:s,children:e.jsxs("div",{className:"relative bg-white rounded-lg overflow-hidden max-w-[95vw] max-h-[95vh]",onClick:D=>D.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:b}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx($t,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50 overflow-auto max-h-[calc(95vh-60px)]",children:e.jsxs("div",{className:`grid gap-4 ${i?"grid-cols-1 lg:grid-cols-3":"grid-cols-1 lg:grid-cols-2"}`,children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-red-100 px-3 py-1 rounded-full",children:"Before"}),e.jsx("img",{src:r,alt:"Before repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-green-100 px-3 py-1 rounded-full",children:"After"}),e.jsx("img",{src:l,alt:"After repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),i&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-purple-100 px-3 py-1 rounded-full",children:"Diff (changes in magenta)"}),e.jsx("img",{src:i,alt:"Difference",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]})]})})]})})}const un={en:{adventure:"Adventure","life-challenge":"Life Challenge",educational:"Educational",historical:"Historical"},de:{adventure:"Abenteuer","life-challenge":"Lebensherausforderung",educational:"Bildung",historical:"Historisch"},fr:{adventure:"Aventure","life-challenge":"DÃ©fi de vie",educational:"Ã‰ducatif",historical:"Historique"}},gn={en:{"1st-grade":"Picture Book (1st Grade)",standard:"Standard",advanced:"Advanced"},de:{"1st-grade":"Bilderbuch (1. Klasse)",standard:"Standard",advanced:"Fortgeschritten"},fr:{"1st-grade":"Livre illustrÃ© (1Ã¨re annÃ©e)",standard:"Standard",advanced:"AvancÃ©"}},ho={"de-CH":"Schweizerdeutsch","de-DE":"Deutsch (Deutschland)",en:"English",fr:"FranÃ§ais"};function xo({settings:r,language:l}){var P,J;const[i,b]=o.useState(!1),s=v=>{const m={en:{title:"Story Info",category:"Category",topic:"Topic",theme:"Theme",storyType:"Story Type",storyDetails:"Story Idea",artStyle:"Art Style",language:"Language",readingLevel:"Reading Level",pages:"Length",dedication:"Dedication",mainCharacters:"Main Characters",otherCharacters:"Other Characters",relationships:"Relationships",season:"Season",location:"Location",noData:"Not specified",spring:"Spring",summer:"Summer",autumn:"Autumn",winter:"Winter"},de:{title:"Story-Info",category:"Kategorie",topic:"Thema",theme:"Thema",storyType:"Story-Typ",storyDetails:"Story-Idee",artStyle:"Kunststil",language:"Sprache",readingLevel:"Lesestufe",pages:"LÃ¤nge",dedication:"Widmung",mainCharacters:"Hauptfiguren",otherCharacters:"Andere Figuren",relationships:"Beziehungen",season:"Jahreszeit",location:"Ort",noData:"Nicht angegeben",spring:"FrÃ¼hling",summer:"Sommer",autumn:"Herbst",winter:"Winter"},fr:{title:"Info histoire",category:"CatÃ©gorie",topic:"Sujet",theme:"ThÃ¨me",storyType:"Type d'histoire",storyDetails:"IdÃ©e d'histoire",artStyle:"Style artistique",language:"Langue",readingLevel:"Niveau de lecture",pages:"Longueur",dedication:"DÃ©dicace",mainCharacters:"Personnages principaux",otherCharacters:"Autres personnages",relationships:"Relations",season:"Saison",location:"Lieu",noData:"Non spÃ©cifiÃ©",spring:"Printemps",summer:"Ã‰tÃ©",autumn:"Automne",winter:"Hiver"}};return(m[l]||m.en)[v]||v},D=v=>(un[l]||un.en)[v]||v,p=v=>(gn[l]||gn.en)[v]||v,C=(v,m)=>v==null||v===""?e.jsx("span",{className:"text-gray-400 italic",children:s("noData")}):e.jsx("span",{className:"text-gray-800",children:v}),I=r.mainCharacters||[],q=((P=r.characters)==null?void 0:P.filter(v=>I.includes(v.id)))||[],R=((J=r.characters)==null?void 0:J.filter(v=>!I.includes(v.id)))||[],A=v=>s(v)||v,F=()=>{if(!r.userLocation)return null;const v=[r.userLocation.city,r.userLocation.region,r.userLocation.country].filter(Boolean);return v.length>0?v.join(", "):null};return e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>b(!i),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-amber-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ri,{size:16,className:"text-amber-600"}),e.jsx("span",{className:"font-medium text-amber-800",children:s("title")}),e.jsx("span",{className:"text-xs bg-amber-200 text-amber-700 px-2 py-0.5 rounded",children:"DEV"})]}),i?e.jsx(or,{size:18,className:"text-amber-600"}):e.jsx(Ca,{size:18,className:"text-amber-600"})]}),i&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[q.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(Na,{size:12}),s("mainCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:q.map(v=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800 border border-indigo-200",children:[e.jsx(Na,{size:10}),e.jsx("span",{children:v.name})]},v.id))})]}),R.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(Ia,{size:12}),s("otherCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.map(v=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-200",children:[e.jsx(Na,{size:10}),e.jsx("span",{children:v.name})]},v.id))})]}),r.relationships&&Object.keys(r.relationships).length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-2",children:s("relationships")}),e.jsx("div",{className:"text-xs bg-white/50 p-2 rounded border border-amber-100 space-y-1",children:Object.entries(r.relationships).map(([v,m])=>{var B,y;const[E,le]=v.split("-").map(G=>parseInt(G,10)),ne=(B=r.characters)==null?void 0:B.find(G=>G.id===E),se=(y=r.characters)==null?void 0:y.find(G=>G.id===le);return!ne||!se?null:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-amber-600 font-medium whitespace-nowrap",children:[ne.name," â†’ ",se.name,":"]}),e.jsx("span",{className:"text-gray-700",children:m})]},v)})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Vi,{size:12}),s("language")]}),e.jsx("div",{className:"text-sm",children:r.language?ho[r.language]||r.language:C(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("readingLevel")}),e.jsx("div",{className:"text-sm",children:r.languageLevel?p(r.languageLevel):C(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("pages")}),e.jsx("div",{className:"text-sm",children:r.pages?`${r.pages} ${l==="de"?"Seiten":"pages"}`:C(void 0)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("season")}),e.jsx("div",{className:"text-sm",children:r.season?A(r.season):C(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("location")}),e.jsx("div",{className:"text-sm",children:F()||C(void 0)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Cn,{size:12}),s("artStyle")]}),e.jsx("div",{className:"text-sm capitalize",children:C(r.artStyle)})]})]}),r.storyDetails&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(qr,{size:12}),s("storyDetails")]}),e.jsx("div",{className:"text-sm bg-white/50 p-2 rounded border border-amber-100 whitespace-pre-wrap",children:r.storyDetails})]}),(r.storyCategory||r.storyTheme||r.storyTopic)&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-amber-100",children:[r.storyCategory&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Gi,{size:12}),s("category")]}),e.jsx("div",{className:"text-sm",children:D(r.storyCategory)})]}),(r.storyTheme||r.storyTopic)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:r.storyCategory==="adventure"?s("theme"):s("topic")}),e.jsx("div",{className:"text-sm",children:r.storyCategory==="adventure"?r.storyTheme:r.storyTopic})]})]})]})]})}function po({storyId:r,onShareStatusChange:l,variant:i="compact"}){const{language:b}=Kt(),[s,D]=o.useState(!1),[p,C]=o.useState(null),[I,q]=o.useState(!1),[R,A]=o.useState(!1),[F,P]=o.useState(null),J=i==="full",v={share:b==="de"?"Teilen":b==="fr"?"Partager":"Share",shareStory:b==="de"?"Geschichte teilen":b==="fr"?"Partager l'histoire":"Share Story",enableSharing:b==="de"?"Link aktivieren":b==="fr"?"Activer le lien":"Enable sharing",disableSharing:b==="de"?"Link deaktivieren":b==="fr"?"DÃ©sactiver le lien":"Disable sharing",copyLink:b==="de"?"Link kopieren":b==="fr"?"Copier le lien":"Copy link",copied:b==="de"?"Kopiert!":b==="fr"?"CopiÃ©!":"Copied!",shareWhatsApp:b==="de"?"Per WhatsApp teilen":b==="fr"?"Partager sur WhatsApp":"Share on WhatsApp",sharingEnabled:b==="de"?"Teilen aktiv":b==="fr"?"Partage actif":"Sharing enabled",sharingDisabled:b==="de"?"Teilen inaktiv":b==="fr"?"Partage inactif":"Sharing disabled",anyoneWithLink:b==="de"?"Jeder mit dem Link kann die Geschichte lesen":b==="fr"?"Toute personne avec le lien peut lire l'histoire":"Anyone with the link can read the story",errorLoading:b==="de"?"Fehler beim Laden":b==="fr"?"Erreur de chargement":"Error loading"};o.useEffect(()=>{s&&!p&&m()},[s]);const m=async()=>{q(!0),P(null);try{const se=localStorage.getItem("auth_token"),B=await fetch(`/api/stories/${r}/share-status`,{headers:se?{Authorization:`Bearer ${se}`}:{}});if(!B.ok)throw new Error("Failed to fetch status");const y=await B.json();C(y)}catch{P(v.errorLoading)}finally{q(!1)}},E=async()=>{q(!0),P(null);try{const B=(p==null?void 0:p.isShared)?"DELETE":"POST",y=localStorage.getItem("auth_token"),G=await fetch(`/api/stories/${r}/share`,{method:B,headers:y?{Authorization:`Bearer ${y}`}:{}});if(!G.ok)throw new Error("Failed to toggle sharing");const _=await G.json();C({isShared:_.isShared,shareToken:_.shareToken,shareUrl:_.shareUrl}),l==null||l(_.isShared)}catch{P("Failed to update sharing")}finally{q(!1)}},le=async()=>{if(p!=null&&p.shareUrl)try{await navigator.clipboard.writeText(p.shareUrl),A(!0),setTimeout(()=>A(!1),2e3)}catch{const B=document.createElement("textarea");B.value=p.shareUrl,document.body.appendChild(B),B.select(),document.execCommand("copy"),document.body.removeChild(B),A(!0),setTimeout(()=>A(!1),2e3)}},ne=()=>{if(!(p!=null&&p.shareUrl))return;const se=encodeURIComponent(p.shareUrl);window.open(`https://wa.me/?text=${se}`,"_blank")};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>D(!s),className:J?"bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full hover:bg-indigo-600":"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg",title:v.share,children:[e.jsx(dn,{className:"w-4 h-4"}),e.jsx("span",{className:J?"":"hidden sm:inline",children:v.share}),(p==null?void 0:p.isShared)&&e.jsx("span",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>D(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(dn,{className:"w-5 h-5 text-blue-600"}),v.shareStory]})}),e.jsx("div",{className:"p-4 space-y-4",children:I&&!p?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(et,{className:"w-6 h-6 animate-spin text-blue-500"})}):F?e.jsx("div",{className:"text-red-500 text-sm py-2",children:F}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p!=null&&p.isShared?e.jsx(Ki,{className:"w-5 h-5 text-green-500"}):e.jsx(Ui,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:p!=null&&p.isShared?"text-green-700":"text-gray-600",children:p!=null&&p.isShared?v.sharingEnabled:v.sharingDisabled})]}),e.jsx("button",{onClick:E,disabled:I,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${p!=null&&p.isShared?"bg-red-100 text-red-700 hover:bg-red-200":"bg-green-100 text-green-700 hover:bg-green-200"} disabled:opacity-50`,children:I?e.jsx(et,{className:"w-4 h-4 animate-spin"}):p!=null&&p.isShared?v.disableSharing:v.enableSharing})]}),(p==null?void 0:p.isShared)&&p.shareUrl&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xs text-gray-500",children:v.anyoneWithLink}),e.jsx("button",{onClick:le,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-colors",children:R?e.jsxs(e.Fragment,{children:[e.jsx(Oi,{className:"w-4 h-4 text-green-500"}),v.copied]}):e.jsxs(e.Fragment,{children:[e.jsx(Hi,{className:"w-4 h-4"}),v.copyLink]})}),e.jsxs("button",{onClick:ne,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors",children:[e.jsx(Qi,{className:"w-4 h-4"}),v.shareWhatsApp]})]})]})})]})]})]})}function fo({title:r,dedication:l,story:i,outline:b,outlinePrompt:s,outlineModelId:D,outlineUsage:p,storyTextPrompts:C=[],visualBible:I,sceneImages:q,sceneDescriptions:R=[],coverImages:A,regeneratingCovers:F=new Set,languageLevel:P="standard",storyLanguage:J,isGenerating:v=!1,onDownloadPdf:m,onAddToBook:E,onPrintBook:le,onCreateAnother:ne,onDownloadTxt:se,onRegenerateImage:B,onRegenerateCover:y,characters:G=[],onEditImage:_,onEditCover:N,onRepairImage:te,onRevertRepair:fe,onVisualBibleChange:M,storyId:H,developerMode:de=!1,styledAvatarGeneration:ve=[],costumedAvatarGeneration:ke=[],generationLog:$e=[],finalChecksReport:Y,clothingRequirements:_e,isPartial:Se=!1,failureReason:He,generatedPages:he,totalPages:xe,progressiveMode:V=!1,progressiveData:Te,completedPageImages:st={},originalStory:We,onSaveStoryText:ht,onSaveTitleChange:jt,userCredits:lr=0,imageRegenerationCost:Nt=5,isImpersonating:Ys=!1,onSelectImageVersion:Qr,generationSettings:Cs}){var Ht,hr,Sr,rr,Cr,sr,Is,Mr,$s;const{t:fr,language:n}=Kt(),Pe=J?J.startsWith("de")?"de":J:n,at=Ys||lr===-1||lr>=Nt,[be,Zr]=o.useState(null),[ct,Jt]=o.useState(""),[Gt,br]=o.useState(!1),[Qt,$r]=o.useState(i),[tt,ks]=o.useState(!1),[wt,Ot]=o.useState(!1),[Ne,dr]=o.useState(r||""),[Me,Dr]=o.useState(!1),[Le,cr]=o.useState(null),[Ve,Zt]=o.useState(null),[,xt]=o.useState(!1),[lt,ye]=o.useState(new Set),[me,Yt]=o.useState(null),[Dt,w]=o.useState(null),[Ce,Yr]=o.useState(null),[Rr,Xr]=o.useState(null),[Xt,es]=o.useState(null),[Je,Er]=o.useState("square"),[St,yr]=o.useState(!1),[Ct,Xs]=o.useState({}),[ts,As]=o.useState(new Set),Fr=async t=>{if(!(!H||Ct[t]||ts.has(t))){As(g=>new Set(g).add(t));try{const g=localStorage.getItem("auth_token"),u=await fetch(`/api/stories/${H}/visual-bible-image/${t}`,{headers:g?{Authorization:`Bearer ${g}`}:{}});if(u.ok){const S=await u.json();Xs(c=>({...c,[t]:S.imageData}))}}catch(g){console.error(`Failed to load reference image for ${t}:`,g)}finally{As(g=>{const u=new Set(g);return u.delete(t),u})}}},vr=(t,g)=>{if(!g||!de)return null;const u=Ct[t],S=ts.has(t);return u?e.jsx("img",{src:u,alt:"Reference",className:"w-16 h-16 object-cover rounded border border-rose-300 cursor-pointer hover:opacity-80",onClick:()=>Xr({src:u,title:"Reference Image"})}):e.jsx("button",{onClick:()=>Fr(t),disabled:S,className:"w-16 h-16 flex items-center justify-center bg-rose-100 border border-rose-300 rounded text-rose-500 hover:bg-rose-200 disabled:opacity-50",title:"Load reference image",children:S?e.jsx(et,{size:16,className:"animate-spin"}):e.jsx(Tr,{size:16})})},[zr,ea]=o.useState({}),[rs,Ps]=o.useState(new Set),ta=async(t,g)=>{const u=`${t}-${g}`;if(!(!H||zr[u]||rs.has(u))){Ps(S=>new Set(S).add(u));try{const S=await Be.getAvatarGenerationImage(H,t,g);S&&ea(c=>({...c,[u]:S}))}catch(S){console.error(`Failed to load avatar generation images for ${u}:`,S)}finally{Ps(S=>{const c=new Set(S);return c.delete(u),c})}}},ss=(t,g,u,S)=>{var ie,qe,Ze,Ae,ut;const c=`${t}-${g}`,Q=zr[c];return Q&&Q[S]?Q[S]:S==="output"&&((ie=u.output)!=null&&ie.imageData)?u.output.imageData:S==="facePhoto"&&((qe=u.inputs.facePhoto)!=null&&qe.imageData)?u.inputs.facePhoto.imageData:S==="originalAvatar"&&"originalAvatar"in u.inputs&&((Ze=u.inputs.originalAvatar)!=null&&Ze.imageData)?u.inputs.originalAvatar.imageData:S==="styleSample"&&"styleSample"in u.inputs&&((Ae=u.inputs.styleSample)!=null&&Ae.imageData)?u.inputs.styleSample.imageData:S==="standardAvatar"&&"standardAvatar"in u.inputs&&((ut=u.inputs.standardAvatar)!=null&&ut.imageData)&&u.inputs.standardAvatar.imageData||null},_t=(t,g,u,S,c,Q)=>{const ie=ss(t,g,u,S),qe=`${t}-${g}`,Ze=rs.has(qe),Ae=!!zr[qe];return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:c}),ie?e.jsx("img",{src:ie,alt:c,className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>Xr({src:ie,title:c}),title:Q?`${Q} KB - Click to enlarge`:"Click to enlarge"}):Q?e.jsx("button",{onClick:()=>ta(t,g),disabled:Ze||Ae,className:"w-16 h-16 flex flex-col items-center justify-center bg-blue-50 border border-blue-300 rounded text-blue-500 hover:bg-blue-100 disabled:opacity-50 text-[10px]",title:"Click to load images",children:Ze?e.jsx(et,{size:16,className:"animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Tr,{size:14}),e.jsxs("span",{className:"mt-0.5",children:[Q," KB"]})]})}):e.jsx("span",{className:"text-gray-400 italic text-[10px]",children:"N/A"})]})};o.useEffect(()=>{Gt||$r(i)},[i,Gt]),o.useEffect(()=>{wt||dr(r||"")},[r,wt]);const as=async()=>{if(ht){ks(!0);try{await ht(Qt),br(!1)}catch(t){console.error("Failed to save story text:",t)}finally{ks(!1)}}},jr=async()=>{if(!(!jt||!Ne.trim())){Dr(!0);try{await jt(Ne.trim()),Ot(!1)}catch(t){console.error("Failed to save title:",t)}finally{Dr(!1)}}},ns=()=>{$r(i),br(!1)},Br=async t=>{if(!(!te||Dt!==null)){w(t);try{await te(t)}catch(g){console.error("Failed to repair image:",g)}finally{w(null)}}},is=async t=>{if(!(!H||Ce!==null)){Yr(t);try{const g=await fetch(`/api/stories/${H}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({entityName:t,entityType:"character"})});if(!g.ok){const S=await g.json();throw new Error(S.error||"Repair failed")}const u=await g.json();console.log("Entity repair result:",u),u.success&&!u.noChanges&&window.location.reload()}catch(g){console.error("Failed to repair entity consistency:",g),alert(`Failed to repair: ${g instanceof Error?g.message:"Unknown error"}`)}finally{Yr(null)}}},nt=(t,g)=>{const u=Qt.split(/(?=---\s*(?:Page|Seite)\s+\d+\s*---|(?=##\s*(?:Page|Seite)\s+\d+))/i);let S=0;for(let Q=0;Q<u.length;Q++)if(/^(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i.test(u[Q].trim())){S=Q;break}const c=S+t;if(c<u.length){const Q=u[c].match(/^(---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i),ie=Q?Q[0]:"";u[c]=ie+`
`+g.trim()+`
`}$r(u.join(""))},Rt=t=>{const g=q.find(u=>u.pageNumber===t);return(g==null?void 0:g.imageVersions)||[]},Et=async(t,g)=>{if(Qr)try{await Qr(t,g),cr(null)}catch(u){console.error("Failed to select image version:",u)}},os=t=>{if(!t)return"";let g;if(typeof t!="string"){const Q=t;if(Q.output)if(typeof Q.output=="string")g=Q.output;else if(typeof Q.output=="object"){const ie=Q.output.translatedSummary||Q.output.imageSummary||"";if(ie)return ie;g=JSON.stringify(t)}else g=JSON.stringify(t);else g=JSON.stringify(t)}else g=t;if(g.trim().startsWith("{"))try{const Q=JSON.parse(g);if(Q.output){if(typeof Q.output=="string")g=Q.output;else if(typeof Q.output=="object"){const ie=Q.output.translatedSummary||Q.output.imageSummary;if(ie)return ie}}}catch{}const u=g.match(/(?:#{1,3}\s*)?(?:\*\*)?6\.?\s*(?:\*\*)?\s*\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*\*?\*?\s*:?\s*\n?([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n---|\n```|$)/i);if(u&&u[2]&&u[2].trim())return u[2].trim();const S=g.match(/(?:#{1,3}\s*)?\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*:?\s*\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n\*\*|\n#{1,3}\s|$)/i);if(S&&S[2]&&S[2].trim())return S[2].trim();if(!g.includes("**")&&g.length<1e3)return g.trim();const c=g.match(/\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:\*\*)?\d+\.\s*\*\*|\n\s*\*\*\d+\.|$)/i);return c&&c[2]&&c[2].trim()?c[2].trim():g.substring(0,500).trim()+"..."},mr=t=>{if(!t||!G.length)return G.map(S=>S.id);let g;if(typeof t!="string"){const S=t;g=S.output&&typeof S.output=="string"?S.output:JSON.stringify(t)}else g=t;if(g.trim().startsWith("{"))try{const S=JSON.parse(g);S.output&&typeof S.output=="string"&&(g=S.output)}catch{}const u=g.toLowerCase();return G.filter(S=>u.includes(S.name.toLowerCase())).map(S=>S.id)},ls=t=>{const g=q.find(ie=>ie.pageNumber===t),u=R.find(ie=>ie.pageNumber===t),S=(g==null?void 0:g.description)||(u==null?void 0:u.description)||"",c=(u==null?void 0:u.translatedSummary)||os(S)||(u==null?void 0:u.imageSummary)||"",Q=mr(S);Zt({pageNumber:t,scene:c,selectedCharacterIds:Q})},ds=async()=>{if(!Ve||!B)return;const t=Ve.pageNumber,g=Ve.scene,u=Ve.selectedCharacterIds;Zt(null),ye(S=>new Set(S).add(t)),xt(!0);try{await B(t,g,u)}catch(S){console.error("Failed to regenerate image:",S)}finally{ye(S=>{const c=new Set(S);return c.delete(t),c}),ye(S=>(S.size===0&&xt(!1),S))}},cs=t=>{let g="",u=[];if(t==="front"&&(A!=null&&A.frontCover)){const ie=A.frontCover;typeof ie=="object"&&(g=ie.description||"",u=ie.referencePhotos||[])}else if(t==="initial"&&(A!=null&&A.initialPage)){const ie=A.initialPage;typeof ie=="object"&&(g=ie.description||"",u=ie.referencePhotos||[])}else if(t==="back"&&(A!=null&&A.backCover)){const ie=A.backCover;typeof ie=="object"&&(g=ie.description||"",u=ie.referencePhotos||[])}let S=[];u.length>0&&G.length>0&&(S=G.filter(ie=>u.some(qe=>qe.name===ie.name)).map(ie=>ie.id)),S.length===0&&(S=G.map(ie=>ie.id)),Yt({coverType:t,scene:g,selectedCharacterIds:S,title:t==="front"?r:void 0,dedication:t==="initial"?l:void 0})},ur=async()=>{if(!me||!y)return;const{coverType:t,scene:g,selectedCharacterIds:u,title:S,dedication:c}=me;Yt(null);try{await y(t,g,u,S,c)}catch(Q){console.error("Failed to regenerate cover:",Q)}},er=(t,g,u,S)=>{Zr({type:t,id:g,field:u}),Jt(S||"")},Nr=()=>{if(!be||!I||!M)return;const{type:t,id:g,field:u}=be,S={...I};if(t==="secondaryCharacter")S.secondaryCharacters=(S.secondaryCharacters||[]).map(c=>c.id===g?{...c,[u]:ct}:c);else if(t==="animal")S.animals=(S.animals||[]).map(c=>c.id===g?{...c,[u]:ct}:c);else if(t==="artifact")S.artifacts=(S.artifacts||[]).map(c=>c.id===g?{...c,[u]:ct}:c);else if(t==="location")S.locations=(S.locations||[]).map(c=>c.id===g?{...c,[u]:ct}:c);else if(t==="mainCharacter"){const c=parseInt(g);S.mainCharacters=(S.mainCharacters||[]).map(Q=>Q.id!==c?Q:u==="physical.face"?{...Q,physical:{...Q.physical,face:ct}}:u==="physical.hair"?{...Q,physical:{...Q.physical,hair:ct}}:u==="physical.build"?{...Q,physical:{...Q.physical,build:ct}}:Q)}M(S),Zr(null),Jt("")},pt=()=>{Zr(null),Jt("")},kt=(t=>t?t.split(/(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i).slice(1).filter(u=>u.trim().length>0):[])(Gt?Qt:i),Ft=q.length>0,dt=P==="1st-grade",ft=(()=>{if(!V)return kt.length;if(kt.length===0)return 0;let t=1;for(let g=2;g<=kt.length;g++){const u=g-1;if(q.some(c=>c.pageNumber===u&&c.imageData)||!!st[u])t=g;else break}return t})(),Ts=(Te==null?void 0:Te.totalPages)||kt.length;Te!=null&&Te.totalScenes||q.length||Math.ceil(Ts/(dt?1:2));const Qe=t=>t?typeof t=="string"?t:t.imageData||null:null,wr=t=>t?typeof t=="string"?{imageData:t}:t:null,At=t=>{var S;const g=(S=R.find(c=>c.pageNumber===t))==null?void 0:S.description;if(g)return g;const u=q.find(c=>c.pageNumber===t);return u==null?void 0:u.description},gr=t=>{const g=R.find(u=>u.pageNumber===t);return t===1&&g&&(console.log("[StoryDisplay] Page 1 scene keys:",Object.keys(g)),console.log("[StoryDisplay] Page 1 has outlineExtract:",!!g.outlineExtract),console.log("[StoryDisplay] Page 1 has scenePrompt:",!!g.scenePrompt)),g==null?void 0:g.outlineExtract},Pt=t=>{var g;return(g=R.find(u=>u.pageNumber===t))==null?void 0:g.scenePrompt},zt=t=>{var g;return(g=R.find(u=>u.pageNumber===t))==null?void 0:g.textModelId};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center gap-2",children:wt?e.jsxs("div",{className:"flex items-center gap-2 w-full max-w-2xl",children:[e.jsx("input",{type:"text",value:Ne,onChange:t=>dr(t.target.value),className:"flex-1 text-2xl md:text-3xl font-bold text-gray-800 text-center border-2 border-indigo-300 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500",autoFocus:!0,onKeyDown:t=>{t.key==="Enter"&&jr(),t.key==="Escape"&&(dr(r||""),Ot(!1))}}),e.jsx("button",{onClick:jr,disabled:Me||!Ne.trim(),className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",title:n==="de"?"Speichern":n==="fr"?"Sauvegarder":"Save",children:Me?e.jsx(js,{className:"animate-spin",size:20}):e.jsx(Vr,{size:20})}),e.jsx("button",{onClick:()=>{dr(r||""),Ot(!1)},disabled:Me,className:"p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",title:n==="de"?"Abbrechen":n==="fr"?"Annuler":"Cancel",children:e.jsx($t,{size:20})})]}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 text-center",children:r||fr.yourStory}),jt&&!v&&e.jsx("button",{onClick:()=>Ot(!0),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors",title:n==="de"?"Titel bearbeiten":n==="fr"?"Modifier le titre":"Edit title",children:e.jsx(ot,{size:18})})]})}),Se&&e.jsx("div",{className:"bg-amber-50 border-2 border-amber-400 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-amber-500 text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-amber-800",children:n==="de"?"UnvollstÃ¤ndige Geschichte":n==="fr"?"Histoire incomplÃ¨te":"Incomplete Story"}),e.jsx("p",{className:"text-amber-700 text-sm mt-1",children:n==="de"?`Diese Geschichte konnte nicht vollstÃ¤ndig generiert werden. ${he||q.length} von ${xe||"unbekannt"} Seiten wurden erstellt.`:n==="fr"?`Cette histoire n'a pas pu Ãªtre gÃ©nÃ©rÃ©e complÃ¨tement. ${he||q.length} sur ${xe||"inconnu"} pages ont Ã©tÃ© crÃ©Ã©es.`:`This story could not be fully generated. ${he||q.length} of ${xe||"unknown"} pages were created.`}),He&&de&&e.jsxs("details",{className:"mt-2 text-sm",children:[e.jsx("summary",{className:"cursor-pointer text-amber-600 hover:text-amber-700",children:n==="de"?"Fehlerdetails":n==="fr"?"DÃ©tails de l'erreur":"Error details"}),e.jsx("p",{className:"mt-1 bg-amber-100 p-2 rounded text-amber-800 font-mono text-xs",children:He})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[Ft&&H&&E&&e.jsxs("button",{onClick:E,disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(on,{size:16})," ",n==="de"?"Buch erstellen":n==="fr"?"CrÃ©er le livre":"Create Book"]}),Ft&&m&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>yr(!St),disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(qr,{size:16}),n==="de"?"PDF herunterladen":n==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(or,{size:14,className:`transition-transform ${St?"rotate-180":""}`})]}),St&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:Je==="square",onChange:()=>Er("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:Je==="A4",onChange:()=>Er("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{m(Je),yr(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:n==="de"?"Herunterladen":n==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),Ft&&H&&!v&&e.jsx(po,{storyId:H,variant:"full"}),ne&&e.jsxs("button",{onClick:ne,disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(an,{size:16})," ",n==="de"?"Neue Geschichte":n==="fr"?"Nouvelle histoire":"New Story"]})]}),de&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[se&&e.jsxs("button",{onClick:se,className:"bg-gray-500 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 hover:bg-gray-600",children:[e.jsx(Ir,{size:14})," TXT"]}),Ft&&H&&le&&e.jsxs("button",{onClick:le,disabled:v,className:`bg-yellow-500 text-black px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 ${v?"opacity-50 cursor-not-allowed":"hover:bg-yellow-600"}`,children:[e.jsx(Qs,{size:14})," Print (DEV)"]})]}),de&&Cs&&e.jsx("div",{className:"mt-4",children:e.jsx(xo,{settings:Cs,language:n})}),de&&e.jsxs("div",{className:"space-y-4 mt-6",children:[b&&e.jsxs("details",{className:"bg-purple-50 border-2 border-purple-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-purple-800 hover:text-purple-900 flex items-center gap-2",children:[e.jsx(qr,{size:20}),dt?n==="de"?"VollstÃ¤ndige API-Ausgabe (Kombiniert)":n==="fr"?"Sortie API complÃ¨te (CombinÃ©e)":"Full API Output (Combined)":n==="de"?"VollstÃ¤ndige API-Ausgabe (Outline)":n==="fr"?"Sortie API complÃ¨te (Plan)":"Full API Output (Outline)",D&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-purple-600",children:["(",D,")"]}),p&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-purple-500",children:["[",p.input_tokens.toLocaleString()," in / ",p.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[s&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:n==="de"?"ðŸ“¤ Prompt (Eingabe)":n==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:s})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:dt?n==="de"?"ðŸ“¥ API-Antwort (Kombiniert)":n==="fr"?"ðŸ“¥ RÃ©ponse API (CombinÃ©e)":"ðŸ“¥ API Response (Combined)":n==="de"?"ðŸ“¥ API-Antwort (Outline)":n==="fr"?"ðŸ“¥ RÃ©ponse API (Plan)":"ðŸ“¥ API Response (Outline)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:b})]})]})]}),i&&C.length>0&&e.jsxs("details",{className:"bg-amber-50 border-2 border-amber-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Qs,{size:20}),n==="de"?"VollstÃ¤ndige API-Ausgabe (Story-Text)":n==="fr"?"Sortie API complÃ¨te (Texte)":"Full API Output (Story Text)",((Ht=C[0])==null?void 0:Ht.modelId)&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-amber-600",children:["(",C[0].modelId,")"]}),((hr=C[0])==null?void 0:hr.usage)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-500",children:["[",C[0].usage.input_tokens.toLocaleString()," in / ",C[0].usage.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:n==="de"?"ðŸ“¤ Prompt (Eingabe)":n==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((Sr=C[0])==null?void 0:Sr.prompt)||"No prompt available"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:n==="de"?"ðŸ“¥ Rohe API-Antwort (ungefiltert)":n==="fr"?"ðŸ“¥ RÃ©ponse API brute (non filtrÃ©e)":"ðŸ“¥ Raw API Response (unfiltered)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((rr=C[0])==null?void 0:rr.rawResponse)||i})]})]})]}),I&&e.jsxs("details",{className:"bg-rose-50 border-2 border-rose-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-rose-800 hover:text-rose-900 flex items-center gap-2",children:[e.jsx(Qs,{size:20}),n==="de"?"Visual Bible (Wiederkehrende Elemente)":n==="fr"?"Bible Visuelle (Ã‰lÃ©ments RÃ©currents)":"Visual Bible (Recurring Elements)",I.changeLog&&I.changeLog.length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-rose-200 text-rose-800 rounded-full text-xs font-medium",children:[I.changeLog.length," ",n==="de"?"Ã„nderungen":n==="fr"?"changements":"changes"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[I.mainCharacters&&I.mainCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-purple-300 rounded-lg p-3",children:[e.jsxs("h4",{className:"text-sm font-bold text-purple-700 mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘—"}),n==="de"?"Hauptcharaktere (Style Profile)":n==="fr"?"Personnages Principaux (Profil Style)":"Main Characters (Style Profile)"]}),e.jsx("div",{className:"space-y-3",children:I.mainCharacters.map(t=>{var g,u,S,c;return e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-sm",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-800 hover:text-purple-900",children:[t.name,Object.keys(t.generatedOutfits||{}).length>0&&e.jsxs("span",{className:"ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs",children:[Object.keys(t.generatedOutfits).length," ",n==="de"?"Outfits":n==="fr"?"tenues":"outfits"]})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"font-medium text-gray-600",children:"Physical:"}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[((g=t.physical)==null?void 0:g.skinTone)||"N/A"," | ",((u=t.physical)==null?void 0:u.hair)||"N/A"," | ",((S=t.physical)==null?void 0:S.build)||"N/A",((c=t.physical)==null?void 0:c.other)&&` | ${t.physical.other}`]})]}),t.generatedOutfits&&Object.keys(t.generatedOutfits).length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-purple-200",children:[e.jsx("span",{className:"font-medium text-gray-600 text-xs",children:"Generated Outfits:"}),e.jsx("div",{className:"mt-1 space-y-1",children:Object.entries(t.generatedOutfits).map(([Q,ie])=>{var qe;return e.jsxs("div",{className:"bg-white p-1.5 rounded text-xs",children:[e.jsxs("span",{className:"font-medium text-purple-600",children:["Page ",Q,":"]}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[(qe=ie.outfit)==null?void 0:qe.substring(0,80),"..."]}),e.jsx("span",{className:`ml-1 px-1 py-0.5 rounded text-[10px] ${ie.setting==="outdoor-cold"?"bg-blue-100 text-blue-700":ie.setting==="outdoor-warm"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:ie.setting})]},Q)})})]})]})]},t.id)})})]}),I.secondaryCharacters&&I.secondaryCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:n==="de"?"Nebencharaktere":n==="fr"?"Personnages Secondaires":"Secondary Characters"}),e.jsx("div",{className:"space-y-2",children:I.secondaryCharacters.map(t=>{var g;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[vr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((g=t.appearsInPages)==null?void 0:g.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(be==null?void 0:be.type)==="secondaryCharacter"&&(be==null?void 0:be.id)===t.id&&(be==null?void 0:be.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:ct,onChange:u=>Jt(u.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Nr,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Vr,{size:12})," Save"]}),e.jsxs("button",{onClick:pt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx($t,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),de&&M&&e.jsx("button",{onClick:()=>er("secondaryCharacter",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ot,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Cr=I.animals)==null?void 0:Cr.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:n==="de"?"Tiere & Wesen":n==="fr"?"Animaux & CrÃ©atures":"Animals & Creatures"}),e.jsx("div",{className:"space-y-2",children:I.animals.map(t=>{var g;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[vr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((g=t.appearsInPages)==null?void 0:g.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(be==null?void 0:be.type)==="animal"&&(be==null?void 0:be.id)===t.id&&(be==null?void 0:be.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:ct,onChange:u=>Jt(u.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Nr,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Vr,{size:12})," Save"]}),e.jsxs("button",{onClick:pt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx($t,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),de&&M&&e.jsx("button",{onClick:()=>er("animal",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ot,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((sr=I.artifacts)==null?void 0:sr.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:n==="de"?"Artefakte & Objekte":n==="fr"?"Artefacts & Objets":"Artifacts & Objects"}),e.jsx("div",{className:"space-y-2",children:I.artifacts.map(t=>{var g;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[vr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((g=t.appearsInPages)==null?void 0:g.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(be==null?void 0:be.type)==="artifact"&&(be==null?void 0:be.id)===t.id&&(be==null?void 0:be.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:ct,onChange:u=>Jt(u.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Nr,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Vr,{size:12})," Save"]}),e.jsxs("button",{onClick:pt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx($t,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),de&&M&&e.jsx("button",{onClick:()=>er("artifact",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ot,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Is=I.locations)==null?void 0:Is.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:n==="de"?"Wiederkehrende Orte":n==="fr"?"Lieux RÃ©currents":"Recurring Locations"}),e.jsx("div",{className:"space-y-2",children:I.locations.map(t=>{var g;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[!t.isRealLandmark&&vr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.isRealLandmark&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 font-semibold",children:"ðŸ“ LANDMARK"}),t.photoFetchStatus==="success"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700",children:"ðŸ“· Photo"}),!t.isRealLandmark&&t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((g=t.appearsInPages)==null?void 0:g.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),t.isRealLandmark&&t.landmarkQuery&&e.jsxs("div",{className:"text-amber-700 text-xs mt-1",children:["Landmark: ",e.jsx("span",{className:"font-mono bg-amber-50 px-1 rounded",children:t.landmarkQuery})]}),(be==null?void 0:be.type)==="location"&&(be==null?void 0:be.id)===t.id&&(be==null?void 0:be.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:ct,onChange:u=>Jt(u.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Nr,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Vr,{size:12})," Save"]}),e.jsxs("button",{onClick:pt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx($t,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),de&&M&&e.jsx("button",{onClick:()=>er("location",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ot,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]}),t.referencePhotoData&&e.jsxs("div",{className:"mt-2 border border-amber-200 rounded overflow-hidden",children:[e.jsx("img",{src:t.referencePhotoData,alt:`${t.name} reference`,className:"w-full max-h-32 object-contain bg-gray-50"}),t.photoAttribution&&e.jsxs("div",{className:"text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 truncate",children:["ðŸ“· ",t.photoAttribution]})]})]})]},t.id)})})]}),I.vehicles&&I.vehicles.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:n==="de"?"Fahrzeuge":n==="fr"?"VÃ©hicules":"Vehicles"}),e.jsx("div",{className:"space-y-2",children:I.vehicles.map(t=>{var g;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[vr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((g=t.appearsInPages)==null?void 0:g.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),I.clothing&&I.clothing.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:n==="de"?"Kleidung & KostÃ¼me":n==="fr"?"VÃªtements & Costumes":"Clothing & Costumes"}),e.jsx("div",{className:"space-y-2",children:I.clothing.map(t=>{var g;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.wornBy&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:["worn by ",t.wornBy]}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),((g=t.appearsInPages)==null?void 0:g.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]},t.id)})})]}),I.changeLog&&I.changeLog.length>0&&e.jsxs("details",{className:"bg-white border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-bold text-amber-700 hover:text-amber-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“"}),n==="de"?"Ã„nderungsprotokoll":n==="fr"?"Journal des Modifications":"Change Log",e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-xs",children:I.changeLog.length})]}),e.jsx("div",{className:"mt-2 space-y-1 max-h-[500px] overflow-y-auto",children:I.changeLog.slice().reverse().map((t,g)=>{var u;return e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs border-l-2 border-amber-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.type==="mainCharacter"?"bg-purple-100 text-purple-700":t.type==="secondaryCharacter"?"bg-rose-100 text-rose-700":t.type==="generatedOutfit"?"bg-green-100 text-green-700":t.type==="animal"?"bg-orange-100 text-orange-700":t.type==="artifact"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:t.type}),e.jsx("span",{className:"font-semibold text-amber-800",children:t.element}),e.jsxs("span",{className:"text-gray-500",children:[Pe==="de"?"Seite":"Page"," ",t.page]})]}),e.jsxs("div",{className:"mt-1 text-gray-600",children:[e.jsxs("span",{className:"font-medium",children:[t.change,":"]}),e.jsxs("span",{className:"ml-1 text-gray-700",children:[(u=t.after)==null?void 0:u.substring(0,100),t.after&&t.after.length>100?"...":""]})]}),t.before&&e.jsxs("div",{className:"text-gray-400 line-through text-[10px] mt-0.5",children:[n==="de"?"Vorher":n==="fr"?"Avant":"Before",": ",t.before.substring(0,50),"..."]}),e.jsx("div",{className:"text-gray-400 text-[10px] mt-0.5",children:new Date(t.timestamp).toLocaleTimeString()})]},g)})})]}),(!I.mainCharacters||I.mainCharacters.length===0)&&(!I.secondaryCharacters||I.secondaryCharacters.length===0)&&(!I.animals||I.animals.length===0)&&(!I.artifacts||I.artifacts.length===0)&&(!I.locations||I.locations.length===0)&&(!I.vehicles||I.vehicles.length===0)&&(!I.clothing||I.clothing.length===0)&&e.jsx("div",{className:"text-gray-500 text-sm italic",children:n==="de"?"Keine wiederkehrenden Elemente gefunden":n==="fr"?"Aucun Ã©lÃ©ment rÃ©current trouvÃ©":"No recurring elements found in this story"})]})]}),_e&&Object.keys(_e).length>0&&e.jsxs("details",{className:"bg-teal-50 border-2 border-teal-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-teal-800 hover:text-teal-900 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸ‘”"}),n==="de"?`Kleidungsanforderungen (${Object.keys(_e).length} Charaktere)`:n==="fr"?`Exigences vestimentaires (${Object.keys(_e).length} personnages)`:`Clothing Requirements (${Object.keys(_e).length} characters)`]}),e.jsx("div",{className:"mt-4 space-y-3",children:Object.entries(_e).map(([t,g])=>{var u,S,c,Q,ie,qe,Ze,Ae,ut,bt,oe,yt,Wt,Ds,Bt;return e.jsxs("div",{className:"bg-white border border-teal-200 rounded-lg p-3",children:[e.jsx("h4",{className:"font-bold text-teal-700 mb-2",children:t}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${(u=g.standard)!=null&&u.used?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(S=g.standard)!=null&&S.used?"âœ…":"â¬œ"," Standard"]}),((c=g.standard)==null?void 0:c.used)&&((Q=g.standard)==null?void 0:Q.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:g.standard.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(ie=g.winter)!=null&&ie.used?"bg-blue-50 border border-blue-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(qe=g.winter)!=null&&qe.used?"â„ï¸":"â¬œ"," Winter"]}),((Ze=g.winter)==null?void 0:Ze.used)&&((Ae=g.winter)==null?void 0:Ae.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:g.winter.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(ut=g.summer)!=null&&ut.used?"bg-yellow-50 border border-yellow-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(bt=g.summer)!=null&&bt.used?"â˜€ï¸":"â¬œ"," Summer"]}),((oe=g.summer)==null?void 0:oe.used)&&((yt=g.summer)==null?void 0:yt.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:g.summer.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(Wt=g.costumed)!=null&&Wt.used?"bg-purple-50 border border-purple-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Ds=g.costumed)!=null&&Ds.used?"ðŸŽ­":"â¬œ"," Costumed"]}),((Bt=g.costumed)==null?void 0:Bt.used)&&e.jsxs("div",{className:"text-gray-600 mt-1",children:[g.costumed.costume&&e.jsxs("span",{className:"font-medium",children:[g.costumed.costume,": "]}),g.costumed.description]})]})]})]},t)})})]}),ve&&ve.length>0&&e.jsxs("details",{className:"bg-pink-50 border-2 border-pink-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-pink-800 hover:text-pink-900 flex items-center gap-2",children:[e.jsx(Tr,{size:20}),n==="de"?`Stilisierte Avatare (${ve.length})`:n==="fr"?`Avatars stylisÃ©s (${ve.length})`:`Styled Avatars (${ve.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:ve.map((t,g)=>{var u,S;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-pink-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.artStyle," (",t.clothingCategory||"standard",")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[_t("styled",g,t,"facePhoto","Face Photo",(u=t.inputs.facePhoto)==null?void 0:u.sizeKB),_t("styled",g,t,"originalAvatar","Original Avatar",(S=t.inputs.originalAvatar)==null?void 0:S.sizeKB),t.inputs.styleSample&&_t("styled",g,t,"styleSample","Style Sample",t.inputs.styleSample.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:_t("styled",g,t,"output","Styled Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},g)})})]}),ke&&ke.length>0&&e.jsxs("details",{className:"bg-orange-50 border-2 border-orange-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-orange-800 hover:text-orange-900 flex items-center gap-2",children:[e.jsx(Tr,{size:20}),n==="de"?`KostÃ¼m-Avatare (${ke.length})`:n==="fr"?`Avatars costumÃ©s (${ke.length})`:`Costumed Avatars (${ke.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:ke.map((t,g)=>{var u,S;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-orange-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 hover:text-orange-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.costumeType," (",t.artStyle,")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[t.costumeDescription&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-yellow-700",children:"Costume:"}),e.jsx("p",{className:"mt-1 text-gray-700",children:t.costumeDescription})]}),e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[_t("costumed",g,t,"facePhoto","Face Photo",(u=t.inputs.facePhoto)==null?void 0:u.sizeKB),_t("costumed",g,t,"standardAvatar","Standard Avatar",(S=t.inputs.standardAvatar)==null?void 0:S.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:_t("costumed",g,t,"output","Costumed Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},g)})})]}),$e&&$e.length>0&&e.jsxs("details",{className:"bg-slate-50 border-2 border-slate-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-slate-800 hover:text-slate-900 flex items-center gap-2",children:[e.jsx(qr,{size:20}),n==="de"?`Generierungslog (${$e.length})`:n==="fr"?`Journal de gÃ©nÃ©ration (${$e.length})`:`Generation Log (${$e.length})`,$e.filter(t=>t.level==="warn").length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded-full",children:[$e.filter(t=>t.level==="warn").length," warnings"]}),$e.filter(t=>t.level==="error").length>0&&e.jsxs("span",{className:"ml-1 px-2 py-0.5 bg-red-200 text-red-800 text-xs rounded-full",children:[$e.filter(t=>t.level==="error").length," errors"]})]}),e.jsx("div",{className:"mt-4 space-y-1 max-h-96 overflow-y-auto",children:$e.map((t,g)=>e.jsxs("div",{className:`text-xs p-2 rounded flex items-start gap-2 ${t.level==="error"?"bg-red-50 text-red-800":t.level==="warn"?"bg-yellow-50 text-yellow-800":t.level==="debug"?"bg-gray-50 text-gray-600":"bg-white text-slate-700"}`,children:[e.jsx("span",{className:"text-gray-400 font-mono text-[10px] whitespace-nowrap",children:new Date(t.timestamp).toLocaleTimeString()}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium whitespace-nowrap ${t.stage==="outline"?"bg-blue-100 text-blue-700":t.stage==="avatars"?"bg-purple-100 text-purple-700":t.stage==="scenes"?"bg-green-100 text-green-700":t.stage==="images"?"bg-orange-100 text-orange-700":t.stage==="covers"?"bg-pink-100 text-pink-700":"bg-gray-100 text-gray-700"}`,children:t.stage}),t.character&&e.jsxs("span",{className:"font-medium text-slate-600",children:["[",t.character,"]"]}),e.jsx("span",{className:"flex-1",children:t.message}),e.jsx("span",{className:"text-gray-400 text-[10px]",children:t.event})]},g))})]}),Y&&e.jsxs("details",{className:`border-2 rounded-xl p-4 ${Y.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsxs("summary",{className:`cursor-pointer text-lg font-bold flex items-center gap-2 ${Y.overallConsistent?"text-green-800 hover:text-green-900":"text-amber-800 hover:text-amber-900"}`,children:[Y.overallConsistent?"âœ“":"âš ï¸",n==="de"?`KonsistenzprÃ¼fung (${Y.totalIssues} Probleme)`:n==="fr"?`VÃ©rification de cohÃ©rence (${Y.totalIssues} problÃ¨mes)`:`Final Checks (${Y.totalIssues} issues)`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-700",children:Y.summary}),Y.imageChecks&&Y.imageChecks.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:n==="de"?"Bildkonsistenz":n==="fr"?"CohÃ©rence des images":"Image Consistency"}),Y.imageChecks.map((t,g)=>{var u,S;return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${t.consistent?"text-green-600":"text-amber-600"}`,children:t.consistent?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:t.type==="full"?"Full Check":t.type==="character"?`Character: ${t.characterName}`:t.type==="sequence"?"Sequence Check":t.type}),t.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",t.overallScore,"/10"]})]}),t.issues&&t.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:t.issues.map((c,Q)=>{var ie,qe;return e.jsxs("div",{className:`text-xs p-2 rounded ${c.severity==="high"?"bg-red-50 border-l-4 border-red-400":c.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${c.severity==="high"?"bg-red-200 text-red-800":c.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:c.severity}),e.jsxs("span",{className:"text-gray-500",children:["Pages ",(ie=c.images)==null?void 0:ie.join(", ")]}),c.pagesToFix&&c.pagesToFix.length>0&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px]",children:["Fix: ",c.pagesToFix.join(", ")]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:(qe=c.type)==null?void 0:qe.replace(/_/g," ")}),c.characterInvolved&&e.jsx("span",{className:"px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px]",children:c.characterInvolved})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:c.description}),c.details&&Object.keys(c.details).length>0&&e.jsx("div",{className:"mt-1 pl-2 border-l-2 border-gray-200",children:Object.entries(c.details).map(([Ze,Ae])=>e.jsxs("p",{className:"text-gray-500 text-[10px]",children:[e.jsxs("span",{className:"font-medium",children:[Ze,":"]})," ",Ae]},Ze))}),c.canonicalVersion&&e.jsxs("p",{className:"text-blue-700 mt-1",children:["ðŸŽ¯ Target: ",c.canonicalVersion]}),c.recommendation&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:["ðŸ’¡ ",c.recommendation]})]},Q)})}),t.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:t.summary}),(t.evaluationPrompts||t.evaluationPrompt)&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:["ðŸ” View Evaluation Prompt",(((u=t.evaluationPrompts)==null?void 0:u.length)??0)>1?`s (${(S=t.evaluationPrompts)==null?void 0:S.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:(t.evaluationPrompts??(t.evaluationPrompt?[t.evaluationPrompt]:[])).map((c,Q)=>{var ie;return e.jsxs("div",{children:[(((ie=t.evaluationPrompts)==null?void 0:ie.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-blue-700 mb-1",children:["Batch ",Q+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:c})]},Q)})})]}),e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result (Full JSON)"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-96 overflow-y-auto bg-white p-2 rounded border",children:JSON.stringify({type:t.type,characterName:t.characterName,consistent:t.consistent,overallScore:t.overallScore,issues:t.issues,summary:t.summary},null,2)})]}),t.rawResponses&&t.rawResponses.length>0&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:["ðŸ“ View Raw Response",t.rawResponses.length>1?`s (${t.rawResponses.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:t.rawResponses.map((c,Q)=>{var ie;return e.jsxs("div",{children:[(((ie=t.rawResponses)==null?void 0:ie.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-purple-700 mb-1",children:["Batch ",Q+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:c})]},Q)})})]})]},g)})]}),((Mr=Y.entity)==null?void 0:Mr.grids)&&Y.entity.grids.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:n==="de"?"EntitÃ¤ts-Konsistenz (Raster)":n==="fr"?"CohÃ©rence des entitÃ©s (grilles)":"Entity Consistency (Grids)"}),e.jsx("div",{className:"space-y-2",children:Y.entity.grids.map((t,g)=>{var ie,qe,Ze;const u=(qe=(ie=Y.entity)==null?void 0:ie.characters)==null?void 0:qe[t.entityName],S=(u==null?void 0:u.consistent)??!0,c=(u==null?void 0:u.score)??0,Q=(u==null?void 0:u.issues)??[];return e.jsxs("details",{className:`bg-white border rounded-lg overflow-hidden ${S?"border-green-200":"border-amber-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer p-3 flex items-center gap-2 hover:bg-gray-50",children:[e.jsx("span",{className:`text-sm ${S?"text-green-600":"text-amber-600"}`,children:S?"âœ“":"âš ï¸"}),e.jsx("span",{className:"font-medium text-sm text-gray-800",children:t.entityName}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",t.cellCount," appearances)"]}),e.jsxs("span",{className:`ml-auto text-xs px-2 py-0.5 rounded ${c>=8?"bg-green-100 text-green-700":c>=5?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:["Score: ",c,"/10"]})]}),e.jsxs("div",{className:"p-3 border-t border-gray-100 space-y-3",children:[e.jsx("div",{className:"flex justify-center bg-gray-50 rounded p-2",children:e.jsx("img",{src:t.gridImage,alt:`${t.entityName} consistency grid`,className:"max-w-full h-auto rounded shadow-sm",style:{maxHeight:"400px"}})}),((Ze=t.manifest)==null?void 0:Ze.cells)&&e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Cells: "}),t.manifest.cells.map((Ae,ut)=>e.jsxs("span",{className:"inline-block bg-gray-100 rounded px-1.5 py-0.5 mr-1 mb-1",children:[Ae.letter,": ",Ae.isReference?"Ref":`P${Ae.pageNumber}`,Ae.clothing&&Ae.clothing!=="standard"&&` (${Ae.clothing})`]},ut))]}),Q.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Issues:"}),Q.map((Ae,ut)=>e.jsxs("div",{className:`text-xs p-2 rounded ${Ae.severity==="critical"?"bg-red-50 border-l-4 border-red-400":Ae.severity==="major"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${Ae.severity==="critical"?"bg-red-200 text-red-800":Ae.severity==="major"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:Ae.subType||Ae.type}),Ae.pagesToFix&&e.jsxs("span",{className:"text-[10px] text-gray-500",children:["Fix page(s): ",Ae.pagesToFix.join(", ")]})]}),e.jsx("p",{className:"mt-1 text-gray-700",children:Ae.description}),Ae.fixInstruction&&e.jsx("p",{className:"mt-1 text-blue-600 italic",children:Ae.fixInstruction})]},ut))]}),(u==null?void 0:u.summary)&&e.jsx("p",{className:"text-xs text-gray-500 italic",children:u.summary}),H&&(!S||c<8)&&t.entityType==="character"&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[e.jsx("button",{onClick:()=>is(t.entityName),disabled:v||Ce!==null,className:`flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded transition-colors ${v||Ce!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:Ce===t.entityName?e.jsxs(e.Fragment,{children:[e.jsx(et,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Repairing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ns,{className:"w-3 h-3"}),e.jsx("span",{children:"Repair Consistency"})]})}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:"Regenerate appearances to match reference photo"})]})]})]},g)})}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:Y.entity.summary})]}),Y.textCheck&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:n==="de"?"TextqualitÃ¤t":n==="fr"?"QualitÃ© du texte":"Text Quality"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${Y.textCheck.quality==="good"?"text-green-600":Y.textCheck.quality==="needs_review"?"text-amber-600":"text-red-600"}`,children:Y.textCheck.quality==="good"?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:Y.textCheck.quality==="good"?"Good":Y.textCheck.quality==="needs_review"?"Needs Review":"Has Issues"}),Y.textCheck.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",Y.textCheck.overallScore,"/10"]})]}),Y.textCheck.issues&&Y.textCheck.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:Y.textCheck.issues.map((t,g)=>e.jsxs("div",{className:`text-xs p-2 rounded ${t.severity==="high"?"bg-red-50 border-l-4 border-red-400":t.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.severity==="high"?"bg-red-200 text-red-800":t.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:t.severity}),t.page&&e.jsxs("span",{className:"text-gray-500",children:["Page ",t.page]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:t.type})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:t.issue}),(t.originalText||t.text)&&e.jsxs("p",{className:"text-red-600 mt-1 line-through",children:['"',t.originalText||t.text,'"']}),t.correctedText&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:['âœ“ "',t.correctedText,'"']}),!t.correctedText&&t.suggestion&&e.jsxs("p",{className:"text-green-700 mt-1",children:["â†’ ",t.suggestion]})]},g))}),Y.textCheck.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:Y.textCheck.summary}),Y.textCheck.fullOriginalText&&e.jsxs("details",{className:"mt-3 bg-gray-50 border border-gray-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-gray-700",children:"ðŸ“„ View Original Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-600 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.fullOriginalText})]}),Y.textCheck.fullCorrectedText&&e.jsxs("details",{className:"mt-3 bg-green-50 border border-green-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-green-800",children:"ðŸ“‹ View Full Corrected Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.fullCorrectedText})]}),Y.textCheck.rawResponse&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:"ðŸ“ View Raw Response"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.rawResponse})]}),Y.textCheck&&e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:JSON.stringify({quality:Y.textCheck.quality,overallScore:Y.textCheck.overallScore,issues:Y.textCheck.issues,summary:Y.textCheck.summary,parseError:Y.textCheck.parseError},null,2)})]}),Y.textCheck.evaluationPrompt&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:"ðŸ” View Evaluation Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:Y.textCheck.evaluationPrompt})]})]})]}),Y.error&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-2 text-xs text-red-700",children:["Error: ",Y.error]})]})]}),R.length>0&&e.jsxs("details",{className:"bg-green-50 border-2 border-green-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-green-800 hover:text-green-900 flex items-center gap-2",children:[e.jsx(qr,{size:20}),n==="de"?`Alle Szenenbeschreibungen (${R.length})`:n==="fr"?`Toutes les descriptions de scÃ¨nes (${R.length})`:`All Scene Descriptions (${R.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:R.map(t=>e.jsxs("details",{className:"bg-white border border-green-200 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-700 hover:text-green-800",children:Pe==="de"?`Seite ${t.pageNumber}`:Pe==="fr"?`Page ${t.pageNumber}`:`Page ${t.pageNumber}`}),e.jsxs("div",{className:"mt-2 space-y-2",children:[t.outlineExtract&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-amber-700",children:"Outline Extract:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.outlineExtract})]}),t.scenePrompt&&e.jsxs("div",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-purple-700",children:"Scene Prompt:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.scenePrompt})]}),e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Scene Description:"}),t.textModelId&&e.jsxs("span",{className:"ml-2 text-green-600",children:["(",t.textModelId,")"]}),e.jsx("pre",{className:"text-gray-700 mt-1 whitespace-pre-wrap font-mono text-xs overflow-x-auto",children:(()=>{if(typeof t.description=="string")try{const g=JSON.parse(t.description);return JSON.stringify(g,null,2)}catch{return t.description}if(typeof t.description=="object"){const g=t.description;if(g!=null&&g.text)try{const u=JSON.parse(g.text);return JSON.stringify(u,null,2)}catch{return g.text}return JSON.stringify(t.description,null,2)}return String(t.description)})()})]})]})]},t.pageNumber))})]})]}),A&&Qe(A.frontCover)&&(()=>{var g,u;const t=wr(A.frontCover);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Pe==="de"?"Titelseite":Pe==="fr"?"Couverture":"Front Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{src:Qe(A.frontCover),alt:"Front Cover",className:"w-full rounded-lg shadow-lg",label:"Front Cover"}),F.has("frontCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(et,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),y&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>cs("front"),disabled:v||!at||F.has("frontCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||!at||F.has("frontCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:at?"":n==="de"?"Nicht genug Credits":n==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Ut,{size:14}),n==="de"?"Bild neu generieren":n==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Nt," ",n==="de"?"Credits":"credits",")"]})]})}),de&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[N&&e.jsxs("button",{onClick:()=>N("front"),disabled:v,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14})," ",n==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:n==="de"?"Szenenbeschreibung":n==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const S=t.description;if(typeof S=="string")try{return JSON.stringify(JSON.parse(S),null,2)}catch{return S}if(typeof S=="object"){const c=S;if(c!=null&&c.text)try{return JSON.stringify(JSON.parse(c.text),null,2)}catch{return c.text}return JSON.stringify(S,null,2)}return String(S)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[n==="de"?"API-Prompt":n==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((g=t.referencePhotos)==null?void 0:g.length)??0)>0||(((u=t.landmarkPhotos)==null?void 0:u.length)??0)>0)&&e.jsx(ws,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,language:n}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[n==="de"?"QualitÃ¤tsbewertung":n==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Feedback:":n==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(Ur,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:n}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[n==="de"?"Vorherige Version":n==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[n==="de"?"Originalbild":n==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),A&&Qe(A.initialPage)&&(()=>{var g,u;const t=wr(A.initialPage);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Pe==="de"?"Widmungsseite":Pe==="fr"?"Page de dÃ©dicace":"Dedication Page"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{src:Qe(A.initialPage),alt:"Dedication Page",className:"w-full rounded-lg shadow-lg",label:"Dedication Page"}),F.has("initialPage")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(et,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),y&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>cs("initial"),disabled:v||!at||F.has("initialPage"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||!at||F.has("initialPage")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:at?"":n==="de"?"Nicht genug Credits":n==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Ut,{size:14}),n==="de"?"Bild neu generieren":n==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Nt," ",n==="de"?"Credits":"credits",")"]})]})}),de&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[N&&e.jsxs("button",{onClick:()=>N("initial"),disabled:v,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14})," ",n==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:n==="de"?"Szenenbeschreibung":n==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const S=t.description;if(typeof S=="string")try{return JSON.stringify(JSON.parse(S),null,2)}catch{return S}if(typeof S=="object"){const c=S;if(c!=null&&c.text)try{return JSON.stringify(JSON.parse(c.text),null,2)}catch{return c.text}return JSON.stringify(S,null,2)}return String(S)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[n==="de"?"API-Prompt":n==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((g=t.referencePhotos)==null?void 0:g.length)??0)>0||(((u=t.landmarkPhotos)==null?void 0:u.length)??0)>0)&&e.jsx(ws,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,language:n}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[n==="de"?"QualitÃ¤tsbewertung":n==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Feedback:":n==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(Ur,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:n}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[n==="de"?"Vorherige Version":n==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[n==="de"?"Originalbild":n==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),V&&!i&&(A==null?void 0:A.frontCover)&&e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-8 mt-6",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-indigo-700",children:Pe==="de"?"Geschichte wird erstellt...":Pe==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:Pe==="de"?"Die Seiten werden gleich angezeigt":Pe==="fr"?"Les pages seront bientÃ´t affichÃ©es":"Pages will appear shortly"})]})}),Ft&&i&&e.jsxs("div",{className:"space-y-8 mt-8",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 text-center mb-6",children:r||(Pe==="de"?"Ihre Geschichte":Pe==="fr"?"Votre histoire":"Your Story")}),kt.slice(0,V?ft:kt.length).map((t,g)=>{var Ze,Ae,ut,bt;const u=g+1,S=u,c=q.find(oe=>oe.pageNumber===S),Q=V?st[S]:void 0,ie=!!(c!=null&&c.imageData||Q),qe=V&&u===ft&&!ie;return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:Pe==="de"?`Seite ${u}`:Pe==="fr"?`Page ${u}`:`Page ${u}`}),dt?e.jsxs("div",{className:"flex flex-col items-center max-w-2xl mx-auto",children:[qe?e.jsxs("div",{className:"w-full mb-4 aspect-[4/3] bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg shadow-md flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-indigo-600 font-medium",children:Pe==="de"?"Bild wird erstellt...":Pe==="fr"?"CrÃ©ation de l'image...":"Creating image..."}),e.jsx("p",{className:"text-indigo-400 text-sm mt-1",children:Pe==="de"?"Die nÃ¤chste Seite erscheint bald":Pe==="fr"?"La page suivante arrive bientÃ´t":"Next page coming soon"})]}):c!=null&&c.imageData||Q?e.jsxs("div",{className:"w-full mb-4 relative",children:[e.jsx(Vs,{src:((c==null?void 0:c.imageData)||Q)??"",alt:`Scene for page ${u}`,className:`w-full rounded-lg shadow-md object-cover ${lt.has(u)?"opacity-50":""}`,label:`Page ${u}`}),lt.has(u)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(js,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:n==="de"?"Neues Bild wird erstellt...":n==="fr"?"Nouvelle image en cours...":"Generating new image..."})]}),B&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>ls(u),disabled:v||lt.has(u)||!at,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||lt.has(u)||!at?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:at?"":n==="de"?"Nicht genug Credits":n==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Ut,{size:14}),n==="de"?"Bild neu generieren":n==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Nt," ",n==="de"?"Credits":"credits",")"]})]}),ht&&e.jsxs("button",{onClick:()=>br(!0),disabled:v,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14}),n==="de"?"Text bearbeiten":n==="fr"?"Modifier le texte":"Edit Text"]}),Rt(u).length>1&&e.jsxs("button",{onClick:()=>cr({pageNumber:u,versions:Rt(u)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(Tr,{size:14}),Rt(u).length]})]})}),de&&e.jsxs("div",{className:"mt-3 space-y-2",children:[_&&e.jsxs("button",{onClick:()=>_(u),disabled:v,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14})," ",n==="de"?"Bearbeiten":"Edit"]}),te&&e.jsx("button",{onClick:()=>Br(u),disabled:v||Dt!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||Dt!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:n==="de"?"Physik-Fehler automatisch erkennen und reparieren":n==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:Dt===u?e.jsxs(e.Fragment,{children:[e.jsx(js,{size:14,className:"animate-spin"}),n==="de"?"Repariere...":n==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ns,{size:14}),n==="de"?"Auto-Reparatur":n==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),(c==null?void 0:c.repairHistory)&&c.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Ns,{size:14}),n==="de"?"Reparatur-Historie":n==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",c.repairHistory.length," ",n==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:c.repairHistory.map((oe,yt)=>e.jsxs("div",{className:`border rounded-lg p-3 ${oe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[n==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${oe.success?"text-green-600":"text-red-600"}`,children:["(",oe.success?"âœ“":"âœ—"," ",oe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:oe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:n==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:n==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",oe.fixPrompt]}),oe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:n==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:oe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),oe.beforeImage&&oe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>es({beforeImage:oe.beforeImage,afterImage:oe.afterImage,diffImage:oe.diffImage,title:n==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`}),title:n==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:n==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:oe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:n==="de"?"Nachher:":"After:"}),e.jsx("img",{src:oe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),oe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:oe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(oe.timestamp).toLocaleTimeString()})]},yt))})]}),gr(u)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:n==="de"?"Auszug aus Gliederung":n==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:gr(u)})]}),Pt(u)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:n==="de"?"Szenen-Prompt":n==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:Pt(u)})]}),At(u)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[n==="de"?"Szenenbeschreibung":n==="fr"?"Description de scÃ¨ne":"Scene Description",zt(u)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",zt(u),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:At(u)})]}),(c==null?void 0:c.prompt)&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[n==="de"?"API-Prompt":n==="fr"?"Prompt API":"API Prompt",(c==null?void 0:c.modelId)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",c.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:c==null?void 0:c.prompt})]}),((((Ze=c==null?void 0:c.referencePhotos)==null?void 0:Ze.length)??0)>0||(((Ae=c==null?void 0:c.landmarkPhotos)==null?void 0:Ae.length)??0)>0)&&c&&e.jsx(ws,{referencePhotos:c.referencePhotos||[],landmarkPhotos:c.landmarkPhotos,language:n,storyId:H||void 0,pageNumber:u}),(c==null?void 0:c.qualityScore)!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[n==="de"?"QualitÃ¤tsbewertung":n==="fr"?"Score de qualitÃ©":"Quality Score",(c==null?void 0:c.qualityModelId)&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",c.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${((c==null?void 0:c.qualityScore)??0)>=70?"text-green-600":((c==null?void 0:c.qualityScore)??0)>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round((c==null?void 0:c.qualityScore)??0),"%"]})]}),(c==null?void 0:c.qualityReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Feedback:":n==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:c.qualityReasoning})]})]}),(c==null?void 0:c.retryHistory)&&c.retryHistory.length>0&&e.jsx(Ur,{retryHistory:c.retryHistory,totalAttempts:(c==null?void 0:c.totalAttempts)||c.retryHistory.length,language:n,onRevertRepair:fe?(oe,yt)=>fe(c.pageNumber,yt):void 0,storyId:H,pageNumber:c.pageNumber}),(c==null?void 0:c.wasRegenerated)&&(!(c!=null&&c.retryHistory)||c.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",n==="de"?"Bild regeneriert":n==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),(c==null?void 0:c.originalScore)!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(c.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:n==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":n==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),(c==null?void 0:c.originalImage)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:n==="de"?"Originalbild:":n==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:c.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),(c==null?void 0:c.originalReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Original Feedback:":n==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:c.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`w-full flex flex-col items-center justify-center rounded-lg p-8 mb-4 ${v?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Pe==="de"?"Bild wird noch erstellt...":Pe==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Pe==="de"?"Kein Bild fÃ¼r diese Seite":Pe==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"w-full bg-indigo-50 rounded-lg p-6 border-2 border-indigo-200",children:Gt?e.jsx("textarea",{value:t.trim(),onChange:oe=>nt(g,oe.target.value),className:"w-full min-h-[400px] p-3 text-gray-800 leading-snug font-serif text-xl text-center bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:n==="de"?"Text eingeben...":n==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl text-center",children:t.trim()})})]}):e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-stretch",children:[c&&c.imageData?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:c.imageData,alt:`Scene for page ${u}`,className:`w-full rounded-lg shadow-md object-cover ${lt.has(u)?"opacity-50":""}`}),lt.has(u)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(js,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:n==="de"?"Neues Bild wird erstellt...":n==="fr"?"Nouvelle image en cours...":"Generating new image..."})]})]}),B&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>ls(u),disabled:v||lt.has(u)||!at,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||lt.has(u)||!at?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:at?"":n==="de"?"Nicht genug Credits":n==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Ut,{size:14}),n==="de"?"Bild neu generieren":n==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Nt," ",n==="de"?"Credits":"credits",")"]})]}),ht&&e.jsxs("button",{onClick:()=>br(!0),disabled:v,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14}),n==="de"?"Text bearbeiten":n==="fr"?"Modifier le texte":"Edit Text"]}),Rt(u).length>1&&e.jsxs("button",{onClick:()=>cr({pageNumber:u,versions:Rt(u)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(Tr,{size:14}),Rt(u).length]})]})}),de&&e.jsxs("div",{className:"mt-3 space-y-2",children:[_&&e.jsxs("button",{onClick:()=>_(u),disabled:v,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14})," ",n==="de"?"Bearbeiten":"Edit"]}),te&&e.jsx("button",{onClick:()=>Br(u),disabled:v||Dt!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||Dt!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:n==="de"?"Physik-Fehler automatisch erkennen und reparieren":n==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:Dt===u?e.jsxs(e.Fragment,{children:[e.jsx(js,{size:14,className:"animate-spin"}),n==="de"?"Repariere...":n==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ns,{size:14}),n==="de"?"Auto-Reparatur":n==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),(c==null?void 0:c.repairHistory)&&c.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Ns,{size:14}),n==="de"?"Reparatur-Historie":n==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",c.repairHistory.length," ",n==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:c.repairHistory.map((oe,yt)=>e.jsxs("div",{className:`border rounded-lg p-3 ${oe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[n==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${oe.success?"text-green-600":"text-red-600"}`,children:["(",oe.success?"âœ“":"âœ—"," ",oe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:oe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:n==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:n==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",oe.fixPrompt]}),oe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:n==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:oe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),oe.beforeImage&&oe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>es({beforeImage:oe.beforeImage,afterImage:oe.afterImage,diffImage:oe.diffImage,title:n==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`}),title:n==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:n==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:oe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:n==="de"?"Nachher:":"After:"}),e.jsx("img",{src:oe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),oe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:oe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(oe.timestamp).toLocaleTimeString()})]},yt))})]}),gr(u)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:n==="de"?"Auszug aus Gliederung":n==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:gr(u)})]}),Pt(u)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:n==="de"?"Szenen-Prompt":n==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:Pt(u)})]}),At(u)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[n==="de"?"Szenenbeschreibung":n==="fr"?"Description de scÃ¨ne":"Scene Description",zt(u)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",zt(u),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:At(u)})]}),c.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[n==="de"?"API-Prompt":n==="fr"?"Prompt API":"API Prompt",c.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",c.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:c.prompt})]}),((((ut=c.referencePhotos)==null?void 0:ut.length)??0)>0||(((bt=c.landmarkPhotos)==null?void 0:bt.length)??0)>0)&&e.jsx(ws,{referencePhotos:c.referencePhotos||[],landmarkPhotos:c.landmarkPhotos,language:n,storyId:H||void 0,pageNumber:u}),c.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[n==="de"?"QualitÃ¤tsbewertung":n==="fr"?"Score de qualitÃ©":"Quality Score",c.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",c.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${c.qualityScore>=70?"text-green-600":c.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(c.qualityScore),"%"]})]}),c.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Feedback:":n==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:c.qualityReasoning})]})]}),c.retryHistory&&c.retryHistory.length>0&&e.jsx(Ur,{retryHistory:c.retryHistory,totalAttempts:c.totalAttempts||c.retryHistory.length,language:n,onRevertRepair:fe?(oe,yt)=>fe(c.pageNumber,yt):void 0,storyId:H,pageNumber:c.pageNumber}),c.wasRegenerated&&(!c.retryHistory||c.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",n==="de"?"Bild regeneriert":n==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),c.originalScore!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(c.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:n==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":n==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),c.originalImage&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:n==="de"?"Originalbild:":n==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:c.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),c.originalReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Original Feedback:":n==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:c.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`flex flex-col items-center justify-center rounded-lg p-8 ${v?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Pe==="de"?"Bild wird noch erstellt...":Pe==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Pe==="de"?"Kein Bild fÃ¼r diese Seite":Pe==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"flex flex-col w-full h-full",children:Gt?e.jsx("textarea",{value:t.trim(),onChange:oe=>nt(g,oe.target.value),className:"w-full flex-1 min-h-[300px] p-4 text-gray-800 leading-snug font-serif text-xl bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:n==="de"?"Text eingeben...":n==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("div",{className:"prose max-w-none",children:e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl",children:t.trim()})})})]})]},u)})]}),A&&Qe(A.backCover)&&(()=>{var g,u;const t=wr(A.backCover);return e.jsxs("div",{className:"mt-8 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Pe==="de"?"RÃ¼ckseite":Pe==="fr"?"QuatriÃ¨me de couverture":"Back Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{src:Qe(A.backCover),alt:"Back Cover",className:"w-full rounded-lg shadow-lg",label:"Back Cover"}),F.has("backCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(et,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),y&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>cs("back"),disabled:v||!at||F.has("backCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v||!at||F.has("backCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:at?"":n==="de"?"Nicht genug Credits":n==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Ut,{size:14}),n==="de"?"Bild neu generieren":n==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Nt," ",n==="de"?"Credits":"credits",")"]})]})}),de&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[N&&e.jsxs("button",{onClick:()=>N("back"),disabled:v,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:14})," ",n==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:n==="de"?"Szenenbeschreibung":n==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const S=t.description;if(typeof S=="string")try{return JSON.stringify(JSON.parse(S),null,2)}catch{return S}if(typeof S=="object"){const c=S;if(c!=null&&c.text)try{return JSON.stringify(JSON.parse(c.text),null,2)}catch{return c.text}return JSON.stringify(S,null,2)}return String(S)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[n==="de"?"API-Prompt":n==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((g=t.referencePhotos)==null?void 0:g.length)??0)>0||(((u=t.landmarkPhotos)==null?void 0:u.length)??0)>0)&&e.jsx(ws,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,language:n}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[n==="de"?"QualitÃ¤tsbewertung":n==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:n==="de"?"Feedback:":n==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(Ur,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:n}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[n==="de"?"Vorherige Version":n==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[n==="de"?"Originalbild":n==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),Ft&&i&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-4 mt-6",children:[e.jsx("h3",{className:"text-base font-bold text-gray-800 mb-3 text-center",children:n==="de"?"Was mÃ¶chten Sie als NÃ¤chstes tun?":n==="fr"?"Que souhaitez-vous faire ensuite ?":"What would you like to do next?"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[H&&E&&e.jsxs("button",{onClick:E,disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(on,{size:16})," ",n==="de"?"Buch erstellen":n==="fr"?"CrÃ©er le livre":"Create Book"]}),m&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>yr(!St),disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(qr,{size:16}),n==="de"?"PDF herunterladen":n==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(or,{size:14,className:`transition-transform ${St?"rotate-180":""}`})]}),St&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:Je==="square",onChange:()=>Er("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:Je==="A4",onChange:()=>Er("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{m(Je),yr(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:n==="de"?"Herunterladen":n==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),ht&&!Gt&&e.jsxs("button",{onClick:()=>br(!0),disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ot,{size:16})," ",n==="de"?"Text bearbeiten":n==="fr"?"Modifier le texte":"Edit Text"]}),ne&&e.jsxs("button",{onClick:ne,disabled:v,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${v?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(an,{size:16})," ",n==="de"?"Neue Geschichte":n==="fr"?"Nouvelle histoire":"New Story"]})]})]}),Gt&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-lg p-3 md:p-4 z-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-2 md:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-600",children:[e.jsx(ot,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"font-semibold text-sm md:text-base",children:n==="de"?"Bearbeitungsmodus":n==="fr"?"Mode Ã©dition":"Edit Mode"}),We&&e.jsxs("span",{className:"text-xs text-gray-500 hidden sm:inline",children:["(",n==="de"?"Original gespeichert":n==="fr"?"Original sauvegardÃ©":"Original saved",")"]})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto justify-center md:justify-end",children:[e.jsxs("button",{onClick:ns,disabled:tt,className:"px-3 md:px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx($t,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:n==="de"?"Abbrechen":n==="fr"?"Annuler":"Cancel"})]}),We&&Qt!==We&&e.jsxs("button",{onClick:()=>$r(We),disabled:tt,className:"px-3 md:px-4 py-2 border border-amber-400 text-amber-700 rounded-lg hover:bg-amber-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(Mi,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:n==="de"?"ZurÃ¼cksetzen":n==="fr"?"Restaurer":"Restore"})]}),e.jsxs("button",{onClick:as,disabled:tt,className:`px-3 md:px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold flex items-center gap-1.5 ${tt?"opacity-50 cursor-not-allowed":"hover:bg-green-600"}`,children:[e.jsx(Vr,{size:16}),tt?n==="de"?"Speichern...":n==="fr"?"Sauvegarde...":"Saving...":n==="de"?"Speichern":n==="fr"?"Sauvegarder":"Save"]})]})]})}),Ve&&e.jsx(co,{pageNumber:Ve.pageNumber,scene:Ve.scene,onSceneChange:t=>Zt({...Ve,scene:t}),onClose:()=>Zt(null),onRegenerate:ds,isRegenerating:lt.has(Ve.pageNumber),imageRegenerationCost:Nt,characters:G.map(t=>({id:t.id,name:t.name})),selectedCharacterIds:Ve.selectedCharacterIds,onCharacterSelectionChange:t=>Zt({...Ve,selectedCharacterIds:t}),consistencyRegen:de?($s=q.find(t=>t.pageNumber===Ve.pageNumber))==null?void 0:$s.consistencyRegen:void 0}),me&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Ut,{size:20}),n==="de"?"Cover bearbeiten":n==="fr"?"Modifier la couverture":"Edit Cover"," - ",me.coverType==="front"?n==="de"?"Titelseite":n==="fr"?"Couverture":"Front Cover":me.coverType==="initial"?n==="de"?"Einleitungsseite":n==="fr"?"Page de dÃ©dicace":"Dedication Page":n==="de"?"RÃ¼ckseite":n==="fr"?"Dos":"Back Cover"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:n==="de"?"Bearbeite die Szenenbeschreibung und wÃ¤hle die Charaktere aus":n==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages":"Edit the scene description and select the characters"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[G.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(Ia,{size:16}),n==="de"?"Charaktere auf dem Cover:":n==="fr"?"Personnages sur la couverture:":"Characters on the cover:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:G.map(t=>{const g=me.selectedCharacterIds.includes(t.id);return e.jsxs("button",{type:"button",onClick:()=>{const u=g?me.selectedCharacterIds.filter(S=>S!==t.id):[...me.selectedCharacterIds,t.id];Yt({...me,selectedCharacterIds:u})},className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${g?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:t.name}),g&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},t.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:n==="de"?"WÃ¤hle die Charaktere aus, die auf dem Cover erscheinen sollen.":n==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre sur la couverture.":"Select the characters that should appear on the cover."})]}),me.coverType==="front"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n==="de"?"Titel:":n==="fr"?"Titre:":"Title:"}),e.jsx("input",{type:"text",value:me.title||"",onChange:t=>Yt({...me,title:t.target.value}),placeholder:n==="de"?"Der Titel des Buches":n==="fr"?"Le titre du livre":"The book title",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),me.coverType==="initial"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n==="de"?"Widmung:":n==="fr"?"DÃ©dicace:":"Dedication:"}),e.jsx("input",{type:"text",value:me.dedication||"",onChange:t=>Yt({...me,dedication:t.target.value}),placeholder:n==="de"?'z.B. "FÃ¼r meine liebste Tochter Emma"':n==="fr"?'par ex. "Pour ma chÃ¨re fille Emma"':'e.g. "For my dear daughter Emma"',className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:n==="de"?"Leer lassen fÃ¼r keine Widmung":n==="fr"?"Laisser vide pour aucune dÃ©dicace":"Leave empty for no dedication"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n==="de"?"Szenenbeschreibung:":n==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:me.scene,onChange:t=>Yt({...me,scene:t.target.value}),placeholder:n==="de"?'z.B. "Die Hauptfigur steht vor einem magischen Schloss bei Sonnenuntergang"':n==="fr"?'par ex. "Le personnage principal devant un chÃ¢teau magique au coucher du soleil"':'e.g. "The main character standing in front of a magical castle at sunset"',className:"w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:n==="de"?"Tipp: Beschreibe die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":n==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:me.selectedCharacterIds.length>0&&e.jsx("span",{children:n==="de"?`${me.selectedCharacterIds.length} Charakter(e) ausgewÃ¤hlt`:n==="fr"?`${me.selectedCharacterIds.length} personnage(s) sÃ©lectionnÃ©(s)`:`${me.selectedCharacterIds.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:()=>Yt(null),className:"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium order-2 sm:order-1",children:n==="de"?"Abbrechen":n==="fr"?"Annuler":"Cancel"}),e.jsxs("button",{onClick:ur,disabled:F.has(me.coverType==="front"?"frontCover":me.coverType==="initial"?"initialPage":"backCover")||me.selectedCharacterIds.length===0,className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${F.has(me.coverType==="front"?"frontCover":me.coverType==="initial"?"initialPage":"backCover")||me.selectedCharacterIds.length===0?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:[e.jsx(Ut,{size:16}),n==="de"?"Neu generieren":n==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Nt," ",n==="de"?"Credits":"credits",")"]})]})]})]})]})}),Le&&e.jsx(mo,{pageNumber:Le.pageNumber,versions:Le.versions,onClose:()=>cr(null),onSelectVersion:Et,developerMode:de}),Rr&&e.jsx(uo,{src:Rr.src,title:Rr.title,onClose:()=>Xr(null)}),Xt&&e.jsx(go,{beforeImage:Xt.beforeImage,afterImage:Xt.afterImage,diffImage:Xt.diffImage,title:Xt.title,onClose:()=>es(null)})]})}const Us={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.5 - Best narrative quality",descriptionDe:"Claude Sonnet 4.5 - Beste ErzÃ¤hlqualitÃ¤t",descriptionFr:"Claude Sonnet 4.5 - Meilleure qualitÃ© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 3.5 - Fast and cheap",descriptionDe:"Claude Haiku 3.5 - Schnell und gÃ¼nstig",descriptionFr:"Claude Haiku 3.5 - Rapide et Ã©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe QualitÃ¤t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualitÃ©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - TrÃ¨s rapide"}},hn={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide de scÃ¨nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra gÃ¼nstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra Ã©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere QualitÃ¤t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualitÃ© ($0.004/image)"}},bo={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - Ã‰valuation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - GrÃ¼ndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},yo={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste QualitÃ¤t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualitÃ© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra gÃ¼nstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra Ã©conomique pour tests ($0.0006/image)"}},vo={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - GÃ¼nstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars Ã©conomiques avec visage cohÃ©rent (~$0.005)"}};function nr({label:r,icon:l,value:i,options:b,onChange:s,language:D}){const p=C=>D==="de"&&C.descriptionDe?C.descriptionDe:D==="fr"&&C.descriptionFr?C.descriptionFr:C.description;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[l,r]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:i||"",onChange:C=>s(C.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:D==="de"?"Server-Standard":D==="fr"?"Par dÃ©faut serveur":"Server Default"}),Object.entries(b).map(([C,I])=>e.jsxs("option",{value:C,children:[C," ",I.provider?`(${I.provider})`:""]},C))]}),e.jsx(or,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),i&&b[i]&&e.jsx("p",{className:"text-[10px] text-gray-500 italic",children:p(b[i])})]})}function jo({selections:r,onChange:l}){const{language:i}=Kt(),b=(s,D)=>{l({...r,[s]:D})};return e.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[e.jsx(Wi,{size:16}),i==="de"?"AI-Modell Auswahl (Dev)":i==="fr"?"SÃ©lection de modÃ¨le IA (Dev)":"AI Model Selection (Dev)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(nr,{label:i==="de"?"Ideen-Modell":i==="fr"?"ModÃ¨le d'idÃ©es":"Idea Model",icon:e.jsx(qi,{size:12}),value:r.ideaModel,options:Us,onChange:s=>b("ideaModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Geschichte (Kombiniert)":i==="fr"?"Histoire (CombinÃ©)":"Story (Combined)",icon:e.jsx(Kr,{size:12}),value:r.outlineModel,options:Us,onChange:s=>b("outlineModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Text-Modell":i==="fr"?"ModÃ¨le de texte":"Text Model",icon:e.jsx(Kr,{size:12}),value:r.textModel,options:Us,onChange:s=>b("textModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Szenen-Modell":i==="fr"?"ModÃ¨le de scÃ¨ne":"Scene Description Model",icon:e.jsx(Cn,{size:12}),value:r.sceneDescriptionModel,options:Us,onChange:s=>b("sceneDescriptionModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Bild-Modell":i==="fr"?"ModÃ¨le d'image":"Image Model",icon:e.jsx(nn,{size:12}),value:r.imageModel,options:hn,onChange:s=>b("imageModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Cover-Modell":i==="fr"?"ModÃ¨le de couverture":"Cover Image Model",icon:e.jsx(Yi,{size:12}),value:r.coverImageModel,options:hn,onChange:s=>b("coverImageModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Bewertungs-Modell":i==="fr"?"ModÃ¨le d'Ã©valuation":"Quality Eval Model",icon:e.jsx(Pi,{size:12}),value:r.qualityModel,options:bo,onChange:s=>b("qualityModel",s),language:i}),e.jsx(nr,{label:i==="de"?"Bild-Reparatur":i==="fr"?"RÃ©paration d'image":"Image Repair",icon:e.jsx(Zi,{size:12}),value:r.imageBackend,options:yo,onChange:s=>b("imageBackend",s),language:i}),e.jsx(nr,{label:i==="de"?"Avatar-Modell":i==="fr"?"ModÃ¨le d'avatar":"Avatar Model",icon:e.jsx(nn,{size:12}),value:r.avatarModel,options:vo,onChange:s=>b("avatarModel",s),language:i})]}),e.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:i==="de"?'Hinweis: Nur sichtbar fÃ¼r Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':i==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode dÃ©veloppeur. "Par dÃ©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}const xn=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"FranÃ§ais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],Ks={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"SÃ¼ddeutsch"},{code:"de-at",name:"Ã–sterreich"},{code:"de-it",name:"SÃ¼dtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"QuÃ©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"ZÃ¼ritÃ¼Ã¼tsch"},{code:"gsw-be",name:"BÃ¤rndÃ¼tsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"LuzÃ¤rndÃ¼tsch"},{code:"gsw-sg",name:"SanggallerdÃ¼tsch"},{code:"gsw-vs",name:"WalliserdÃ¼tsch"},{code:"gsw-gr",name:"BÃ¼ndnerdÃ¼tsch"}]};function Sa(r){return r.startsWith("gsw")?"gsw":r.startsWith("de")?"de":r.startsWith("fr")?"fr":r.startsWith("it")?"it":"en"}const No=["spring","summer","autumn","winter"];function An(){const r=new Date().getMonth();return r>=2&&r<=4?"spring":r>=5&&r<=7?"summer":r>=8&&r<=10?"autumn":"winter"}function wo({languageLevel:r,onLanguageLevelChange:l,pages:i,onPagesChange:b,storyLanguage:s,onStoryLanguageChange:D,developerMode:p,userLocation:C,onLocationChange:I,season:q,onSeasonChange:R,userCredits:A}){const{t:F,language:P}=Kt(),[J,v]=o.useState(!1),[m,E]=o.useState((C==null?void 0:C.city)||""),[le,ne]=o.useState((C==null?void 0:C.country)||""),[se,B]=o.useState(!1),y=o.useRef(null);o.useEffect(()=>{const V=Te=>{y.current&&!y.current.contains(Te.target)&&B(!1)};return document.addEventListener("mousedown",V),()=>document.removeEventListener("mousedown",V)},[]);const G=o.useCallback(()=>{const V=Sa(s),Te=xn.find(We=>We.family===V),st=Ks[V].find(We=>We.code===s)||Ks[V][0];return Te&&st?`${Te.name} (${st.name})`:(Te==null?void 0:Te.name)||s},[s]);o.useEffect(()=>{C&&(E(C.city||""),ne(C.country||""))},[C]);const _=()=>{I({city:m||null,region:null,country:le||null}),v(!1)},N={spring:{de:"FrÃ¼hling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"Ã‰tÃ©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},te=p?4:10,fe=50,M=2,H=10,de=A===-1,ve=de?fe:Math.floor(A/H),ke=Math.floor(ve/2)*2,$e=te*H,Y=!de&&A<$e,_e=$e-A,Se=Y?te:Math.min(fe,Math.max(te,ke)),He=!de&&ke<fe;o.useEffect(()=>{let V=i;V%2!==0&&(V=Math.round(V/2)*2),V=Math.max(te,Math.min(Se,V)),V!==i&&b(V)},[i,te,Se,b]);const he=[{value:"1st-grade",label:F.firstGrade,desc:F.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:F.standard,desc:F.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:F.advanced,desc:F.advancedDesc,image:"/images/dense text left.jpg"}],xe=(V,Te=!1)=>{const st=Te?" (Test)":"",We=V*10,ht=P==="de"?"Credits":P==="fr"?"crÃ©dits":"credits";if(r==="1st-grade")return`${V} ${P==="de"?"Seiten":"pages"} = ${We} ${ht}${st}`;const jt=Math.floor(V/2),lr=Math.floor(V/2);return P==="de"?`${V} Seiten (${jt} Text + ${lr} Bilder) = ${We} ${ht}${st}`:P==="fr"?`${V} pages (${jt} texte + ${lr} images) = ${We} ${ht}${st}`:`${V} pages (${jt} text + ${lr} images) = ${We} ${ht}${st}`};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Qs,{size:24}),P==="de"?"Buchformat":P==="fr"?"Format du livre":"Book Format"]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:P==="de"?"Sprache:":P==="fr"?"Langue:":"Language:"}),e.jsxs("div",{className:"relative",ref:y,children:[e.jsxs("button",{type:"button",onClick:()=>B(!se),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[G(),e.jsx(or,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${se?"rotate-180":""}`})]}),se&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[xn.map(V=>{const Te=Sa(s)===V.family;return e.jsx("button",{type:"button",onClick:()=>{const st=Ks[V.family][0];D(st.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${Te?"font-semibold text-indigo-600":"text-gray-700"}`,children:V.name},V.family)}),e.jsx("div",{className:"border-t border-gray-300 my-1"}),Ks[Sa(s)].map(V=>e.jsx("button",{type:"button",onClick:()=>{D(V.code),B(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${s===V.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:V.name},V.code))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ji,{className:"text-gray-500",size:16}),e.jsx("span",{className:"text-sm text-gray-600",children:P==="de"?"Ort:":P==="fr"?"Lieu:":"Location:"}),J?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"text",value:m,onChange:V=>E(V.target.value),placeholder:P==="de"?"Stadt":P==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("input",{type:"text",value:le,onChange:V=>ne(V.target.value),placeholder:P==="de"?"Land":P==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("button",{onClick:_,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),e.jsx("button",{onClick:()=>v(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"âœ•"})]}):e.jsx("button",{onClick:()=>v(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:C!=null&&C.city?`${C.city}${C.country?`, ${C.country}`:""}`:P==="de"?"Festlegen":P==="fr"?"DÃ©finir":"Set"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:P==="de"?"Jahreszeit:":P==="fr"?"Saison:":"Season:"}),e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:q,onChange:V=>R(V.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:No.map(V=>e.jsx("option",{value:V,children:N[V][P]||N[V].en},V))}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:F.readingLevel}),e.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:he.map(V=>e.jsxs("button",{onClick:()=>l(V.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${r===V.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[e.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:e.jsx("img",{src:V.image,alt:V.label,className:"w-full h-full object-contain"})}),e.jsxs("div",{className:"p-2 md:p-2.5",children:[e.jsx("div",{className:"font-semibold text-sm mb-0.5",children:V.label}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:V.desc})]})]},V.value))})]}),r&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:F.numberOfPages}),Y?e.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-red-700 font-semibold mb-2",children:P==="de"?"Nicht genÃ¼gend Credits":P==="fr"?"CrÃ©dits insuffisants":"Not enough credits"}),e.jsx("p",{className:"text-red-600 text-sm",children:P==="de"?`Du benÃ¶tigst mindestens ${$e} Credits fÃ¼r eine Geschichte mit ${te} Seiten. Dir fehlen noch ${_e} Credits.`:P==="fr"?`Vous avez besoin d'au moins ${$e} crÃ©dits pour une histoire de ${te} pages. Il vous manque ${_e} crÃ©dits.`:`You need at least ${$e} credits for a ${te}-page story. You need ${_e} more credits.`}),e.jsx("p",{className:"text-gray-500 text-xs mt-2",children:P==="de"?`Aktuell: ${A} Credits`:P==="fr"?`Actuel: ${A} crÃ©dits`:`Current: ${A} credits`})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"range",min:te,max:Se,step:M,value:Math.min(i,Se),onChange:V=>b(parseInt(V.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-400",children:te}),e.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[i," ",P==="de"?"Seiten":"pages"]}),e.jsxs("span",{className:`text-sm ${He?"text-orange-500 font-medium":"text-gray-400"}`,children:[Se,He&&" âš ï¸"]})]}),He&&e.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:P==="de"?`Max. ${Se} Seiten mit ${A} Credits mÃ¶glich`:P==="fr"?`Max. ${Se} pages possibles avec ${A} crÃ©dits`:`Max. ${Se} pages possible with ${A} credits`}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-base font-medium text-gray-700",children:xe(i,i===4)}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r==="1st-grade"?P==="de"?"Jede Seite enthÃ¤lt ein Bild mit Text darunter":P==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":P==="de"?"Abwechselnd Textseite und Bildseite":P==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const So=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:wo,getCurrentSeason:An},Symbol.toStringTag,{value:"Module"})),pn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail prÃ¼fen",description:"Wir haben Ihnen einen BestÃ¤tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail bestÃ¤tigen!",currentEmail:"BestÃ¤tigung gesendet an",sendVerification:"BestÃ¤tigungs-E-Mail senden",resendVerification:"BestÃ¤tigungs-E-Mail erneut senden",emailSent:"BestÃ¤tigungs-E-Mail gesendet! Bitte prÃ¼fen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? Ã„ndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"Ã„ndern & BestÃ¤tigen",cancel:"Abbrechen",emailChanged:"E-Mail geÃ¤ndert! Bitte prÃ¼fen Sie Ihren neuen Posteingang fÃ¼r die BestÃ¤tigung.",checkSpam:"Nicht gefunden? PrÃ¼fen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausfÃ¼llen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function Co({isOpen:r,onClose:l,onVerified:i}){const{language:b}=Kt(),{user:s,refreshUser:D}=Ta(),p=pn[b]||pn.en,[C,I]=o.useState("verify"),[q,R]=o.useState(!1),[A,F]=o.useState(!1),[P,J]=o.useState(""),[v,m]=o.useState(""),[E,le]=o.useState(!1),[ne,se]=o.useState(0),[B,y]=o.useState(""),[G,_]=o.useState(""),N=o.useRef(null),te=o.useRef(null),fe=o.useRef(!1);if(o.useEffect(()=>(ne>0&&(te.current=setTimeout(()=>{se(de=>de-1)},1e3)),()=>{te.current&&clearTimeout(te.current)}),[ne]),o.useEffect(()=>{if(r&&!fe.current&&!A){fe.current=!0;const de=setTimeout(async()=>{R(!0);try{const ve=await Oe.post("/api/auth/send-verification",{});F(!0),m(p.emailSent),ve.cooldown&&se(ve.cooldown)}catch(ve){const ke=ve;ke.retryAfter?(se(ke.retryAfter),F(!0)):J(ke.message||"Failed to send verification email")}finally{R(!1)}},300);return()=>clearTimeout(de)}r||(fe.current=!1)},[r,A,p.emailSent]),o.useEffect(()=>{if(!r){N.current&&(clearInterval(N.current),N.current=null);return}return le(!0),console.log("[EmailVerificationModal] Starting polling"),N.current=setInterval(async()=>{try{const de=await Oe.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",de.emailVerified),de.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await D(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),N.current&&(clearInterval(N.current),N.current=null),le(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),i==null||i(),console.log("[EmailVerificationModal] Calling onClose"),l())}catch(de){console.debug("Verification status poll error:",de)}},3e3),()=>{N.current&&(clearInterval(N.current),N.current=null)}},[r,D,i,l]),!r)return null;const M=async()=>{R(!0),J("");try{const de=await Oe.post("/api/auth/send-verification",{});F(!0),m(p.emailSent),de.cooldown&&se(de.cooldown)}catch(de){const ve=de;ve.retryAfter?(se(ve.retryAfter),J(b==="de"?`Bitte warten Sie ${ve.retryAfter} Sekunden`:b==="fr"?`Veuillez patienter ${ve.retryAfter} secondes`:`Please wait ${ve.retryAfter} seconds`)):J(ve.message||"Failed to send verification email")}finally{R(!1)}},H=async()=>{if(!B||!G){J(p.fillAllFields);return}R(!0),J("");try{await Oe.post("/api/auth/change-email",{newEmail:B,password:G}),m(p.emailChanged),I("verify"),y(""),_("")}catch(de){J(de instanceof Error?de.message:"Failed to change email")}finally{R(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[e.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:e.jsx($t,{size:20})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Sn,{className:"w-8 h-8 text-indigo-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:p.title}),e.jsx("p",{className:"text-gray-500",children:p.description})]}),P&&e.jsx(rn,{variant:"error",className:"mb-4",children:P}),v&&e.jsxs(rn,{variant:"success",className:"mb-4",children:[v,e.jsx("p",{className:"text-sm mt-1 opacity-80",children:p.checkSpam})]}),E&&A&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[e.jsx(et,{size:16,className:"animate-spin"}),e.jsx("span",{className:"text-sm",children:b==="de"?"Warte auf BestÃ¤tigung...":b==="fr"?"En attente de verification...":"Waiting for verification..."})]}),C==="verify"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:p.currentEmail}),e.jsx("p",{className:"font-medium text-gray-800",children:s==null?void 0:s.email})]}),e.jsxs(Js,{onClick:M,variant:"primary",loading:q,disabled:ne>0,className:"w-full",children:[e.jsx(Ut,{size:16,className:"mr-2"}),ne>0?`${b==="de"?"Warten":b==="fr"?"Patienter":"Wait"} ${ne}s`:A?p.resendVerification:p.sendVerification]}),e.jsxs("button",{onClick:()=>{I("change"),J(""),m("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[e.jsx(ot,{size:16}),p.changeEmail]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(tn,{type:"email",label:p.newEmail,value:B,onChange:de=>y(de.target.value),placeholder:"your@newemail.com",disabled:q}),e.jsx(tn,{type:"password",label:p.currentPassword,value:G,onChange:de=>_(de.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:q}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Js,{onClick:()=>{I("verify"),J(""),y(""),_("")},variant:"secondary",className:"flex-1",disabled:q,children:p.cancel}),e.jsx(Js,{onClick:H,variant:"primary",loading:q,className:"flex-1",children:p.confirmChange})]})]})]})})}const $a=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "},inverse:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"},inverse:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"},inverse:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function ko(r){const l=$a.find(i=>i.value.en==="Not Known to");return l?l.value[r]:"Not Known to"}function fn(r){const l=$a.find(i=>i.value.en==="Not Known to");return l?r===l.value.en||r===l.value.de||r===l.value.fr:!1}function Ao(r,l,i=[]){for(const b of $a)if(b.value[l]===r)return b.inverse[l];for(const b of i){if(b.forward===r)return b.inverse;if(b.inverse===r)return b.forward}return r}const Po=1440*60*1e3;function Zs(r){const l=`avatar_regen_${r}`,i=localStorage.getItem(l),b=Date.now();if(!i)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:s,lastAttempt:D}=JSON.parse(i);if(b-D>Po)return localStorage.removeItem(l),{canRegenerate:!0,waitSeconds:0,attempts:0};let p=0;s>=2&&s<4?p=30*1e3:s>=4&&s<6?p=60*1e3:s>=6&&s<8?p=120*1e3:s>=8&&s<10?p=300*1e3:s>=10&&(p=600*1e3);const C=b-D;return C>=p?{canRegenerate:!0,waitSeconds:0,attempts:s}:{canRegenerate:!1,waitSeconds:Math.ceil((p-C)/1e3),attempts:s}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function Pn(r){const l=`avatar_regen_${r}`,i=localStorage.getItem(l),b=Date.now();let s=1;if(i)try{s=(JSON.parse(i).attempts||0)+1}catch{}localStorage.setItem(l,JSON.stringify({attempts:s,lastAttempt:b}))}function nl(r){const[l,i]=o.useState(()=>Zs(r));o.useEffect(()=>{if(l.waitSeconds>0){const s=setInterval(()=>{i(Zs(r))},1e3);return()=>clearInterval(s)}},[l.waitSeconds,r]);const b=o.useCallback(()=>{Pn(r),i(Zs(r))},[r]);return{...l,recordRegeneration:b}}const bn={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte wÃ¤hlen Sie aus, welches Gesicht zu dem Charakter gehÃ¶rt, den Sie erstellen mÃ¶chten.",selectFace:"Gesicht auswÃ¤hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages dÃ©tectÃ©s",description:"Nous avons dÃ©tectÃ© plusieurs personnes sur votre photo. Veuillez sÃ©lectionner le visage du personnage que vous souhaitez crÃ©er.",selectFace:"SÃ©lectionner le visage",uploadDifferent:"TÃ©lÃ©charger une autre photo",confidence:"Confiance"}};function To({isOpen:r,faces:l,onSelect:i,onUploadNew:b,developerMode:s=!1}){const{language:D}=Kt(),p=bn[D]||bn.en;return e.jsx(Li,{isOpen:r,onClose:b,title:p.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-600 text-center",children:p.description}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:l.map((C,I)=>e.jsxs("button",{onClick:()=>i(C.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:e.jsx("img",{draggable:!1,src:C.thumbnail,alt:`Face ${I+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[p.selectFace," ",I+1]})}),s&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[p.confidence,": ",Math.round(C.confidence*100),"%"]})]},C.id))}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("button",{onClick:b,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[e.jsx(Xi,{size:20}),p.uploadDifferent]})})]})})}const il=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et quÃªtes hÃ©roÃ¯ques"},emoji:"ðŸ—¡ï¸"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"CompÃ©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei alltÃ¤glichen Herausforderungen",fr:"Aide pour surmonter les dÃ©fis quotidiens"},emoji:"ðŸ’ª"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"ðŸ“š"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais Ã©vÃ©nements historiques"},emoji:"ðŸ›ï¸"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"DÃ©cris ta propre idÃ©e d'histoire"},emoji:"âœ¨"}],Io=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],ol=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"Ã‰poques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"HÃ©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"PersonnalisÃ©"}}],Aa=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"ðŸ´â€â˜ ï¸",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"âš”ï¸",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ðŸ¤ ",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ðŸ¥·",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"âš“",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"ðŸ›ï¸",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes Ã„gypten",fr:"Ã‰gypte Ancienne"},emoji:"ðŸº",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"GrÃ¨ce Antique"},emoji:"ðŸº",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"Ã‚ge de Pierre"},emoji:"ðŸ¦´",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure SamouraÃ¯"},emoji:"ðŸŽŒ",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & SorciÃ¨re"},emoji:"ðŸ§™",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"QuÃªte du Dragon"},emoji:"ðŸ‰",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ðŸ¦„",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de SirÃ¨ne"},emoji:"ðŸ§œâ€â™€ï¸",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ðŸ¦–",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-hÃ©ros"},emoji:"ðŸ¦¸",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"ðŸš€",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des OcÃ©ans"},emoji:"ðŸŒŠ",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"ðŸŒ´",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie Ã  la Ferme"},emoji:"ðŸ„",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la ForÃªt"},emoji:"ðŸ¦Š",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"ðŸš’",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"ðŸ‘¨â€âš•ï¸",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"ðŸ‘®",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"MystÃ¨re DÃ©tective"},emoji:"ðŸ”",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de NoÃ«l"},emoji:"ðŸŽ„",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"ðŸŽ†",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de PÃ¢ques"},emoji:"ðŸ°",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"ðŸŽƒ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},emoji:"âœ¨",group:"custom"}],ll={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"ðŸ "},yn=[{id:"potty-training",name:{en:"Potty Training",de:"TÃ¶pfchen-Training",fr:"Apprentissage du pot"},emoji:"ðŸš½",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"HÃ¤nde waschen",fr:"Se laver les mains"},emoji:"ðŸ§¼",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"ZÃ¤hne putzen",fr:"Se brosser les dents"},emoji:"ðŸª¥",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"GemÃ¼se essen",fr:"Manger des lÃ©gumes"},emoji:"ðŸ¥¦",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"ðŸ›ï¸",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"ðŸ‘‹",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de tÃ©tine"},emoji:"ðŸ¼",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"AufrÃ¤umen",fr:"Ranger les jouets"},emoji:"ðŸ§¹",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ðŸª‘",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre Ã  partager"},emoji:"ðŸ¤",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten kÃ¶nnen",fr:"Attendre son tour"},emoji:"â³",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"ðŸŽ’",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"ðŸ‘«",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"ÃŠtre courageux"},emoji:"ðŸ’ª",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau bÃ©bÃ© dans la famille"},emoji:"ðŸ‘¶",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'Ã©cole"},emoji:"ðŸ«",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"ðŸ“",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre Ã  lire"},emoji:"ðŸ“–",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren kÃ¶nnen",fr:"Savoir perdre"},emoji:"ðŸŽ¯",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"ÃŠtre diffÃ©rent c'est bien"},emoji:"ðŸŒˆ",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit HÃ¤nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"ðŸ›¡ï¸",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la vÃ©ritÃ©"},emoji:"âœ…",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"ðŸŒŸ",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"DÃ©mÃ©nagement"},emoji:"ðŸ ",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"âœˆï¸",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents sÃ©parÃ©s"},emoji:"ðŸ’”",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le mÃ©decin"},emoji:"ðŸ¥",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"SÃ©jour Ã  l'hÃ´pital"},emoji:"ðŸ©º",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"ðŸŒˆ",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"â¤ï¸",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"Ã‰conomiser de l'argent"},emoji:"ðŸ’°",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"DÃ©penser intelligemment"},emoji:"ðŸ›’",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"Ã‰quilibre du temps d'Ã©cran"},emoji:"ðŸ“±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"ðŸ‘¥",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"KÃ¶rperliche VerÃ¤nderungen",fr:"Changements corporels"},emoji:"ðŸŒ±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung Ã¼bernehmen",fr:"Prendre ses responsabilitÃ©s"},emoji:"ðŸŽ¯",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"â°",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"SÃ©curitÃ© en ligne"},emoji:"ðŸ”’",ageGroup:"preteen"}],$o=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],dl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-VerÃ¤nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"PrÃ©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"Ã‰cole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"VorpubertÃ¤t (9-12)",fr:"PrÃ©adolescent (9-12)"},ageRange:"9-12"}],vn=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"ðŸ”¤",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"ðŸ…°ï¸",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"ReimwÃ¶rter",fr:"Mots qui riment"},emoji:"ðŸŽµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"ðŸ”¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"ðŸ”¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"ZÃ¤hlen lernen",fr:"Apprendre Ã  compter"},emoji:"âœ‹",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"ðŸ”·",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"âž•",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"ðŸŒˆ",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"MÃ©langer les couleurs"},emoji:"ðŸŽ¨",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"PlanÃ¨tes & Espace"},emoji:"ðŸª",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"ðŸ‚",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"MÃ©tÃ©o"},emoji:"â›…",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"ðŸ’§",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"ðŸŒ±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"ðŸŒ™",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"ðŸ·",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ðŸ¦",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"ðŸ‹",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & KÃ¤fer",fr:"Insectes"},emoji:"ðŸ›",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ðŸ¦•",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"KÃ¶rperteile",fr:"Parties du corps"},emoji:"ðŸ«€",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die fÃ¼nf Sinne",fr:"Les cinq sens"},emoji:"ðŸ‘ï¸",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ðŸ¥—",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"ðŸ“…",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'annÃ©e"},emoji:"ðŸ—“ï¸",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"ðŸ•",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"ðŸŒ",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"LÃ¤nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"ðŸ³ï¸",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"ðŸŽ¸",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"BerÃ¼hmte KÃ¼nstler",fr:"Artistes cÃ©lÃ¨bres"},emoji:"ðŸ–¼ï¸",group:"arts"}],Do=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],cl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"KÃ¶rper & Gesundheit",fr:"Corps & SantÃ©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & GÃ©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],Ro=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],ml=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"â­"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"ðŸ‡¨ðŸ‡­"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & DÃ©couverte"},icon:"ðŸ§­"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & MÃ©decine"},icon:"ðŸ”¬"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"ðŸ’¡"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & LibertÃ©"},icon:"âœŠ"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"ðŸ—ï¸"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"ðŸŽ­"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"ArchÃ¤ologische Entdeckungen",fr:"DÃ©couvertes ArchÃ©ologiques"},icon:"ðŸº"}],jn=[{id:"swiss-founding",name:{en:"Founding of Switzerland (RÃ¼tlischwur)",de:"GrÃ¼ndung der Schweiz (RÃ¼tlischwur)",fr:"Fondation de la Suisse (Serment du GrÃ¼tli)"},shortName:{en:"RÃ¼tlischwur",de:"RÃ¼tlischwur",fr:"Serment du GrÃ¼tli"},emoji:"ðŸ¤",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"ðŸ¹",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"âš”ï¸",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"ðŸ›¡ï¸",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"RÃ©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"RÃ©forme"},emoji:"ðŸ“œ",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant grÃ¼ndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"â¤ï¸",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"GÃ©nÃ©ral Dufour et l'unitÃ© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"GÃ©nÃ©ral Dufour"},emoji:"ðŸŽ–ï¸",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"ðŸ”ï¸",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution fÃ©dÃ©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"ðŸ“‹",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"ðŸš‚",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer NeutralitÃ¤t im 1. Weltkrieg",fr:"NeutralitÃ© suisse pendant la PremiÃ¨re Guerre"},shortName:{en:"WWI Neutrality",de:"NeutralitÃ¤t 1. WK",fr:"NeutralitÃ© 1GM"},emoji:"ðŸ•Šï¸",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the RÃ¼tli Report",de:"General Guisan und der RÃ¼tlirapport",fr:"GÃ©nÃ©ral Guisan et le Rapport du GrÃ¼tli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"GÃ©nÃ©ral Guisan"},emoji:"ðŸŽ–ï¸",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2Ã¨me GM"},emoji:"ðŸ”ï¸",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"ðŸŒ™",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les AmÃ©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"DÃ©couverte de l'AmÃ©rique"},emoji:"â›µ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motorisÃ©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"âœˆï¸",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"PremiÃ¨re traversÃ©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"ðŸ›©ï¸",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"ðŸ”ï¸",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am SÃ¼dpol",fr:"Premier au PÃ´le Sud"},shortName:{en:"South Pole",de:"SÃ¼dpol",fr:"PÃ´le Sud"},emoji:"â„ï¸",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"ðŸŒ",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"PlongÃ©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"PlongÃ©e profonde"},emoji:"ðŸŒŠ",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"ExpÃ©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"ElektrizitÃ¤t entdeckt",fr:"DÃ©couverte Ã©lectricitÃ©"},emoji:"âš¡",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"DÃ©couverte de la pÃ©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"PÃ©nicilline"},emoji:"ðŸ’Š",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"ðŸ’‰",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN dÃ©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"DÃ©couverte ADN"},emoji:"ðŸ§¬",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nommÃ©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"DÃ©couverte dinosaure"},emoji:"ðŸ¦•",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins RelativitÃ¤tstheorie",fr:"RelativitÃ© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"ThÃ©orie d'Einstein"},emoji:"ðŸ§ ",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits GalÃ¡pagos",de:"Darwin auf GalÃ¡pagos",fr:"Darwin aux GalÃ¡pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"ðŸ¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"PremiÃ¨re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"â¤ï¸",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschlÃ¼sselt",fr:"GÃ©nome humain dÃ©codÃ©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet GÃ©nome"},emoji:"ðŸ§ª",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement tÃ©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"TÃ©lescope Hubble"},emoji:"ðŸ”­",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel tÃ©lÃ©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"TÃ©lÃ©phone"},emoji:"ðŸ“ž",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons GlÃ¼hbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"GlÃ¼hbirne",fr:"Ampoule"},emoji:"ðŸ’¡",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"ðŸ“–",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"ðŸŒ",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"â›“ï¸",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"ðŸšŒ",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"ðŸ§±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela libÃ©rÃ©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"âœŠ",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"ðŸ”º",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm erÃ¶ffnet",fr:"Tour Eiffel inaugurÃ©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"ðŸ—¼",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal erÃ¶ffnet",fr:"Canal de Panama inaugurÃ©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"ðŸš¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"ðŸŒ‰",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel erÃ¶ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"ðŸš‡",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"ðŸ…",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland erÃ¶ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"ðŸ°",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cinÃ©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"ðŸŽ¬",year:1895,category:"culture",mainPerson:"LumiÃ¨re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ðŸ¦",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"MusÃ©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"MusÃ©e Histoire Naturelle"},emoji:"ðŸ›ï¸",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de ToutÃ¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"ToutÃ¢nkhamon"},emoji:"ðŸ‘‘",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"RedÃ©couverte de PompÃ©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"PompÃ©i"},emoji:"ðŸŒ‹",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"ArmÃ©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"ArmÃ©e terre cuite"},emoji:"ðŸ—¿",year:1974,category:"archaeology"}];function ul(r){return r==="popular"?Aa.filter(l=>Io.includes(l.id)):Aa.filter(l=>l.group===r)}function gl(r){return r==="popular"?yn.filter(l=>$o.includes(l.id)):yn.filter(l=>l.ageGroup===r)}function hl(r){return r==="popular"?vn.filter(l=>Do.includes(l.id)):vn.filter(l=>l.group===r)}function xl(r){return r==="popular"?jn.filter(l=>Ro.includes(l.id)):jn.filter(l=>l.category===r)}const Eo={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},ir={enableAutoRepair:!1,enableFinalChecks:!0,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null,enableSceneValidation:!1};function Fo(){const r=localStorage.getItem("developer_mode")==="true",[l,i]=o.useState(r),[b,s]=o.useState(null),[D,p]=o.useState("auto"),[C,I]=o.useState(!1),[q,R]=o.useState(!1),[A,F]=o.useState(!1),[P,J]=o.useState(!1),[v,m]=o.useState(r),[E,le]=o.useState(ir.enableAutoRepair),[ne,se]=o.useState(ir.enableFinalChecks),[B,y]=o.useState(ir.incrementalConsistency),[G,_]=o.useState(ir.incrementalConsistencyDryRun),[N,te]=o.useState(ir.lookbackCount),[fe,M]=o.useState(ir.checkOnlyMode),[H,de]=o.useState(ir.useGridRepair),[ve,ke]=o.useState(ir.forceRepairThreshold),[$e,Y]=o.useState(ir.enableSceneValidation),[_e,Se]=o.useState(!1),[He,he]=o.useState({...Eo}),xe=V=>{i(V),m(!!V)};return o.useEffect(()=>{l?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[l]),{developerMode:l,setDeveloperMode:xe,imageGenMode:b,setImageGenMode:s,generationMode:D,setGenerationMode:p,devSkipOutline:C,setDevSkipOutline:I,devSkipText:q,setDevSkipText:R,devSkipSceneDescriptions:A,setDevSkipSceneDescriptions:F,devSkipImages:P,setDevSkipImages:J,devSkipCovers:v,setDevSkipCovers:m,enableAutoRepair:E,setEnableAutoRepair:le,enableFinalChecks:ne,setEnableFinalChecks:se,incrementalConsistency:B,setIncrementalConsistency:y,incrementalConsistencyDryRun:G,setIncrementalConsistencyDryRun:_,lookbackCount:N,setLookbackCount:te,checkOnlyMode:fe,setCheckOnlyMode:M,useGridRepair:H,setUseGridRepair:de,forceRepairThreshold:ve,setForceRepairThreshold:ke,enableSceneValidation:$e,setEnableSceneValidation:Y,loadAllAvatars:_e,setLoadAllAvatars:Se,modelSelections:He,setModelSelections:he}}const zo=o.lazy(()=>Ss(()=>import("./WizardStep2Characters-TLqpS-RI.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])).then(r=>({default:r.WizardStep2Characters}))),Bo=o.lazy(()=>Ss(()=>Promise.resolve().then(()=>So),void 0).then(r=>({default:r.WizardStep3BookSettings}))),Mo=o.lazy(()=>Ss(()=>import("./WizardStep4StoryType-EDluRxM3.js"),__vite__mapDeps([24,1,2,3,4,7,17,12,13,5,6,8,18,19,14,20,21,9,22,23,15])).then(r=>({default:r.WizardStep4StoryType}))),Lo=o.lazy(()=>Ss(()=>import("./WizardStep5ArtStyle-qM5u9sq6.js"),__vite__mapDeps([25,1,2,3,4,26,20])).then(r=>({default:r.WizardStep5ArtStyle}))),Go=o.lazy(()=>Ss(()=>import("./WizardStep6Summary-x1HTqLtu.js"),__vite__mapDeps([27,1,2,3,4,26,17,9,7,5,6,8,18,19,12,13,14,20,21,22,23,15])).then(r=>({default:r.WizardStep6Summary}))),h=Pa("StoryWizard"),Nn={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"FÃ¼ge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die BuchlÃ¤nge und das Leseniveau fÃ¼r dein Publikum fest",3:"WÃ¤hle einen Geschichtstyp und ein Thema",4:"WÃ¤hle einen Illustrationsstil fÃ¼r dein Buch",5:"ÃœberprÃ¼fe deine Auswahl, fÃ¼ge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils apparaÃ®tront de maniÃ¨re cohÃ©rente dans toute votre histoire!",2:"DÃ©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un thÃ¨me",4:"Choisissez un style d'illustration pour votre livre",5:"VÃ©rifiez vos choix, ajoutez des dÃ©tails de l'intrigue, puis gÃ©nÃ©rez votre histoire!"}};function Oo(){const r=$i(),[l,i]=Di(),{t:b,language:s}=Kt(),{isAuthenticated:D,user:p,updateCredits:C,refreshUser:I,isLoading:q,isImpersonating:R}=Ta(),{showSuccess:A,showInfo:F,showError:P}=Ti(),{startTracking:J,stopTracking:v,activeJob:m,isComplete:E,completedStoryId:le,markCompletionViewed:ne,hasUnviewedCompletion:se}=Ii(),[B,y]=o.useState(()=>{const a=new URLSearchParams(window.location.search);if(a.get("storyId"))return 6;if(a.get("new")==="true")return 1;const x=localStorage.getItem("wizard_step");return x?parseInt(x,10):1}),[G,_]=o.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[N,te]=o.useState(null),{developerMode:fe,setDeveloperMode:M,imageGenMode:H,setImageGenMode:de,generationMode:ve,setGenerationMode:ke,devSkipOutline:$e,setDevSkipOutline:Y,devSkipText:_e,setDevSkipText:Se,devSkipSceneDescriptions:He,setDevSkipSceneDescriptions:he,devSkipImages:xe,setDevSkipImages:V,devSkipCovers:Te,setDevSkipCovers:st,enableAutoRepair:We,setEnableAutoRepair:ht,useGridRepair:jt,setUseGridRepair:lr,forceRepairThreshold:Nt,setForceRepairThreshold:Ys,enableFinalChecks:Qr,setEnableFinalChecks:Cs,incrementalConsistency:fr,setIncrementalConsistency:n,incrementalConsistencyDryRun:Pe,setIncrementalConsistencyDryRun:at,lookbackCount:be,setLookbackCount:Zr,checkOnlyMode:ct,setCheckOnlyMode:Jt,enableSceneValidation:Gt,setEnableSceneValidation:br,loadAllAvatars:Qt,setLoadAllAvatars:$r,modelSelections:tt,setModelSelections:ks}=Fo(),[wt,Ot]=o.useState(()=>localStorage.getItem("story_type")||""),[Ne,dr]=o.useState(()=>localStorage.getItem("story_category")||""),[Me,Dr]=o.useState(()=>localStorage.getItem("story_topic")||""),[Le,cr]=o.useState(()=>localStorage.getItem("story_theme")||""),[Ve,Zt]=o.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[xt,lt]=o.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[ye,me]=o.useState([]),[Yt,Dt]=o.useState(null),[w,Ce]=o.useState(null),Yr=o.useRef([]),Rr=o.useRef(null),[Xr,Xt]=o.useState(!1),[es,Je]=o.useState("photo"),[Er,St]=o.useState(!1),[yr,Ct]=o.useState(null),[Xs,ts]=o.useState(!1),[As,Fr]=o.useState(!1),[vr,zr]=o.useState(void 0),[ea,rs]=o.useState(void 0),Ps=o.useRef(null),[ta,ss]=o.useState(!1),[_t,as]=o.useState([]),[jr,ns]=o.useState(null),[Br,is]=o.useState(null),[nt,Rt]=o.useState({}),[Et,os]=o.useState({}),[mr,ls]=o.useState([]),ds=o.useRef(null),cs=o.useRef(!1),ur=o.useRef(!1),[er,Nr]=o.useState(!1),[pt,tr]=o.useState([]),[mt,kt]=o.useState([]),Ft=o.useRef(!1),[dt,ms]=o.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[ft,Ts]=o.useState(()=>{try{const a=localStorage.getItem("story_language");if(a){if(a==="de")return"de-ch";if(a==="fr")return"fr-ch";if(a==="it")return"it-ch";if(a==="en")return"en-gb";if(a.startsWith("de")||a.startsWith("fr")||a.startsWith("it")||a.startsWith("en")||a.startsWith("gsw"))return a}return"de-ch"}catch{return"de-ch"}}),[Qe,wr]=o.useState(()=>{try{const a=localStorage.getItem("story_pages");return a?parseInt(a):30}catch{return 30}}),[At,gr]=o.useState(()=>localStorage.getItem("story_dedication")||""),[Pt,zt]=o.useState(()=>localStorage.getItem("story_details")||""),[Ht,hr]=o.useState(!1),[Sr,rr]=o.useState(!1),[Cr,sr]=o.useState(!1),[Is,Mr]=o.useState(0),[$s,t]=o.useState(0),[g,u]=o.useState(null),[S,c]=o.useState(""),[Q,ie]=o.useState([]),[qe,Ze]=o.useState(null),[Ae,ut]=o.useState(null),bt=o.useRef(null),[oe,yt]=o.useState(null),[Wt,Ds]=o.useState(()=>An()),[Bt,Lr]=o.useState(!1),[Tn,Da]=o.useState(new Set),[In,Ra]=o.useState(!1),[$n,Rs]=o.useState(!1),[Dn,ra]=o.useState(!1),[Rn,sa]=o.useState(!1),[En,Ea]=o.useState(!1),[Fn,Es]=o.useState(!1),[aa,kr]=o.useState({current:0,total:0,message:""}),[Vt,us]=o.useState(null),[zn,Gr]=o.useState(!1),[na,xr]=o.useState(""),[Or,gs]=o.useState(""),[Bn,Fa]=o.useState(""),[Mn,za]=o.useState(""),[Ln,Ba]=o.useState(""),[Gn,Ma]=o.useState(),[On,La]=o.useState(),[_n,Ga]=o.useState([]),[Hn,_r]=o.useState(null),[Wn,Fs]=o.useState(null),[Vn,ia]=o.useState([]),[qn,oa]=o.useState([]),[Un,la]=o.useState([]),[Kn,Oa]=o.useState(null),[Jn,hs]=o.useState([]),[da,Mt]=o.useState([]),[xs,qt]=o.useState({frontCover:null,initialPage:null,backCover:null}),[je,ca]=o.useState(null),[ma,zs]=o.useState(null),[Qn,_a]=o.useState(!1),[Zn,Ha]=o.useState(),[Yn,Wa]=o.useState(),[Xn,Va]=o.useState(),[ei,ua]=o.useState(null),ga=o.useRef(!1),Hr=o.useRef(!1),[vt,Bs]=o.useState(null),[ha,Ms]=o.useState({}),[ti,Ls]=o.useState(!1),[Ye,Gs]=o.useState(null),[ps,fs]=o.useState("");o.useEffect(()=>{Yr.current=ye},[ye]),o.useEffect(()=>{Rr.current=w},[w]),o.useEffect(()=>{if(!q&&!D){if(!!localStorage.getItem("auth_token")){h.debug("Token found but not authenticated yet, waiting for state sync...");return}const x=window.location.pathname+window.location.search,d=encodeURIComponent(x);r(`/?login=true&redirect=${d}`)}},[D,q,r]);const xa=o.useCallback(a=>{var x,d,k,f,j,$,z,T,re,Z;if(a){if((x=a.sceneImages)!=null&&x.length&&Mt(X=>X.map(ge=>{const we=a.sceneImages.find(Ke=>Ke.pageNumber===ge.pageNumber);return we?{...ge,prompt:we.prompt??ge.prompt,qualityReasoning:we.qualityReasoning??ge.qualityReasoning,retryHistory:we.retryHistory??ge.retryHistory,repairHistory:we.repairHistory??ge.repairHistory,wasRegenerated:we.wasRegenerated??ge.wasRegenerated,originalScore:we.originalScore??ge.originalScore,originalReasoning:we.originalReasoning??ge.originalReasoning,totalAttempts:we.totalAttempts??ge.totalAttempts,faceEvaluation:we.faceEvaluation??ge.faceEvaluation,referencePhotos:we.referencePhotos??ge.referencePhotos,landmarkPhotos:we.landmarkPhotos??ge.landmarkPhotos,consistencyRegen:we.consistencyRegen??ge.consistencyRegen}:ge})),a.coverImages&&qt(X=>{var Ke;const ge={...X},we=["frontCover","initialPage","backCover"];for(const Ue of we){const ee=(Ke=a.coverImages)==null?void 0:Ke[Ue],ze=X[Ue];ee&&typeof ze=="object"&&ze!==null&&(ge[Ue]={...ze,prompt:ee.prompt??ze.prompt,qualityReasoning:ee.qualityReasoning??ze.qualityReasoning,retryHistory:ee.retryHistory??ze.retryHistory,referencePhotos:ee.referencePhotos??ze.referencePhotos,landmarkPhotos:ee.landmarkPhotos??ze.landmarkPhotos})}return ge}),console.log("[StoryWizard] Dev metadata generationLog:",((d=a.generationLog)==null?void 0:d.length)||0,"entries"),(k=a.generationLog)!=null&&k.length&&la(a.generationLog),(f=a.styledAvatarGeneration)!=null&&f.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",((j=a.styledAvatarGeneration)==null?void 0:j.length)??0,"entries"),ia(a.styledAvatarGeneration)),($=a.costumedAvatarGeneration)!=null&&$.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",((z=a.costumedAvatarGeneration)==null?void 0:z.length)??0,"entries"),oa(a.costumedAvatarGeneration)),a.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",a.finalChecksReport.totalIssues,"issues"),Oa(a.finalChecksReport)),(T=a.sceneDescriptions)!=null&&T.length){const X=a.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",X.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(X[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((re=X[0])!=null&&re.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((Z=X[0])!=null&&Z.scenePrompt)),hs(a.sceneDescriptions)}a.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),_r(a.visualBible))}},[]);o.useEffect(()=>{Be.getUserLocation().then(a=>{yt(a),a!=null&&a.city&&Be.triggerLandmarkDiscovery(a.city,a.country)})},[]),o.useEffect(()=>{D&&Be.getStories({limit:1}).then(({pagination:a})=>{Ea(a.total>0)}).catch(()=>Ea(!1))},[D]);const pa=o.useRef(null);o.useEffect(()=>{const a=l.get("storyId");l.get("new")!=="true"&&(a&&(pa.current=null),m&&!a&&pa.current!==m.jobId&&(h.info("Returning during active generation, restoring progress for job:",m.jobId),pa.current=m.jobId,y(6),Lr(!0),xr(m.storyTitle),zs(m.jobId),Be.getJobStatus(m.jobId).then(d=>{var k,f;if(h.info("Restored job status:",{progress:d.progress,hasStoryText:!!d.storyText,storyTextKeys:d.storyText?Object.keys(d.storyText):[],pageTextsCount:(k=d.storyText)!=null&&k.pageTexts?Object.keys(d.storyText.pageTexts).length:0,partialPages:((f=d.partialPages)==null?void 0:f.length)||0}),d.progress&&kr(j=>d.progress.current>=j.current?d.progress:{...j,message:d.progress.message}),d.storyText){const j=d.storyText.pageTexts||{};h.info("Setting progressiveStoryData with",Object.keys(j).length,"pages"),Bs({title:d.storyText.title||m.storyTitle,dedication:d.storyText.dedication,pageTexts:j,sceneDescriptions:d.storyText.sceneDescriptions||[],totalPages:d.storyText.totalPages||Qe})}else h.warn("No storyText in job status response");if(d.partialPages&&d.partialPages.length>0){const j={};d.partialPages.forEach($=>{$.pageNumber&&$.imageData&&(j[$.pageNumber]=$.imageData)}),h.info("Restored",Object.keys(j).length,"page images"),Ms(j)}d.partialCovers&&qt(j=>{var $,z,T;return{frontCover:(($=d.partialCovers)==null?void 0:$.frontCover)||j.frontCover,initialPage:((z=d.partialCovers)==null?void 0:z.initialPage)||j.initialPage,backCover:((T=d.partialCovers)==null?void 0:T.backCover)||j.backCover}})}).catch(d=>{h.error("Failed to restore job status:",d)})),h.debug("Auto-nav check:",{generationComplete:E,completedStoryId:le,urlStoryId:a,hasActiveJob:!!m}),E&&le&&!a&&(h.info("Generation completed, navigating to story:",le),i({storyId:le},{replace:!0})))},[m,E,le,l,i,Qe]),o.useEffect(()=>{if(l.get("new")==="true"){h.info("New story requested - resetting all story settings"),Ot(""),dr(""),Dr(""),cr(""),Zt(""),lt("watercolor"),ms("standard"),wr(30),gr(""),zt(""),Dt(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const x=new URLSearchParams(l);x.delete("new"),i(x,{replace:!0}),Ce(null),Je("photo"),y(1)}},[l,i]),o.useEffect(()=>{const a=l.get("storyId");a&&B!==6&&y(6),(async()=>{if(!(!a||!D)){if(ga.current){ga.current=!1,h.info("Skipping story reload - just finished generating");return}h.info("Loading saved story progressively:",a),_(!0),te(null),us(null);try{await Be.getStoryProgressively(a,(d,k)=>{var f,j,$,z;h.info("Metadata loaded:",d.title,`(${k} images to load)`),ca(d.id),xr(d.title||""),Ot(d.storyType||""),lt(d.artStyle||"pixar"),za(d.outline||""),Ba(d.outlinePrompt||""),Ma(d.outlineModelId),La(d.outlineUsage),Ga(d.storyTextPrompts||[]),ia(d.styledAvatarGeneration||[]),oa(d.costumedAvatarGeneration||[]),(f=d.generationLog)!=null&&f.length&&(console.log("[StoryWizard] Loading story metadata, generationLog:",((j=d.generationLog)==null?void 0:j.length)??0,"entries"),la(d.generationLog)),d.visualBible?_r({mainCharacters:d.visualBible.mainCharacters||[],secondaryCharacters:d.visualBible.secondaryCharacters||[],animals:d.visualBible.animals||[],artifacts:d.visualBible.artifacts||[],locations:d.visualBible.locations||[],vehicles:d.visualBible.vehicles||[],clothing:d.visualBible.clothing||[],changeLog:d.visualBible.changeLog||[]}):_r(null),d.clothingRequirements?Fs(d.clothingRequirements):Fs(null),Mt(d.sceneImages||[]),hs(d.sceneDescriptions||[]),qt(d.coverImages||{frontCover:null,initialPage:null,backCover:null}),ms(d.languageLevel||"standard"),d.language&&Ts(d.language),Lr(!1),_a(d.isPartial||!1),Ha(d.failureReason),Wa(d.generatedPages),Va(d.totalPages),gs(d.story||""),Fa(d.originalStory||d.story||""),ua({storyCategory:d.storyCategory,storyTopic:d.storyTopic,storyTheme:d.storyTheme,storyTypeName:d.storyTypeName,storyDetails:d.storyDetails,artStyle:d.artStyle,language:d.language,languageLevel:d.languageLevel,pages:d.pages,dedication:d.dedication,characters:($=d.characters)==null?void 0:$.map(T=>{var re;return{id:T.id,name:T.name,isMain:(re=d.mainCharacters)==null?void 0:re.includes(T.id)}}),mainCharacters:d.mainCharacters,relationships:d.relationships,relationshipTexts:d.relationshipTexts,season:d.season,userLocation:d.userLocation}),(z=d.characters)!=null&&z.length&&Dt(d.characters.map(T=>{var re,Z;return{id:T.id,name:T.name,photoData:T.photoData||((re=T.photos)==null?void 0:re.face)||((Z=T.photos)==null?void 0:Z.original)}})),y(6),_(!1),te(null),k>0&&us({loaded:0,total:k}),Hr.current=!0,Be.getStoryDevMetadata(a).then(T=>{xa(T),h.debug("Dev metadata merged into story")}).catch(T=>{h.warn("Failed to load dev metadata:",T),Hr.current=!1})},(d,k,f,j)=>{if(typeof d=="number")Mt($=>$.map(z=>z.pageNumber===d?{...z,imageData:k,imageVersions:f}:z));else{const $=d;qt(z=>{const T=z[$];return typeof T=="object"&&T!==null?{...z,[$]:{...T,imageData:k}}:{...z,[$]:k}})}j!==void 0&&us($=>$?{...$,loaded:j}:null)},()=>{h.info("All images loaded"),us(null)})}catch(d){h.error("Failed to load story:",d),_(!1),te(null),us(null)}}})()},[l,D]),o.useEffect(()=>{B===6&&se&&(h.info("Clearing unviewed completion - user is viewing story"),ne())},[B,se,ne]),o.useEffect(()=>{(async()=>{const x=l.get("payment"),d=l.get("session_id");if(x==="success"&&d){h.info("Payment successful! Checking order status..."),h.info("Session ID:",d);try{const j=await Be.getOrderStatus(d);if(h.info("Order Status:",j),j.order){const $=`CHF ${(j.order.amount_total/100).toFixed(2)}`,z={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement rÃ©ussi!"},T={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a Ã©tÃ© reÃ§ue et sera bientÃ´t imprimÃ©e."},re=[`${s==="de"?"Kunde":s==="fr"?"Client":"Customer"}: ${j.order.customer_name}`,`Email: ${j.order.customer_email}`,`${s==="de"?"Betrag":s==="fr"?"Montant":"Amount"}: ${$}`,`${s==="de"?"Versand an":s==="fr"?"ExpÃ©diÃ© Ã ":"Shipping to"}: ${j.order.shipping_name}`,`${j.order.shipping_address_line1}`,`${j.order.shipping_postal_code} ${j.order.shipping_city}`,`${j.order.shipping_country}`];A(T[s]||T.en,z[s]||z.en,re)}}catch(j){h.error("Error checking order status:",j)}const f=new URLSearchParams(l);f.delete("payment"),f.delete("session_id"),i(f,{replace:!0})}else if(x==="cancelled"){h.info("Payment cancelled by user");const f={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie kÃ¶nnen es erneut versuchen.",fr:"Paiement annulÃ©. Vous pouvez rÃ©essayer quand vous Ãªtes prÃªt."};F(f[s]||f.en,s==="de"?"Abgebrochen":s==="fr"?"AnnulÃ©":"Cancelled");const j=new URLSearchParams(l);j.delete("payment"),i(j,{replace:!0})}const k=l.get("credits_payment");if(k==="success"){h.info("Credits payment successful!"),await I();const f={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},j={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};A(j[s]||j.en,f[s]||f.en);const $=new URLSearchParams(l);$.delete("credits_payment"),$.delete("session_id"),i($,{replace:!0})}else if(k==="cancelled"){h.info("Credits payment cancelled by user");const f={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};F(f[s]||f.en,s==="de"?"Abgebrochen":s==="fr"?"Annule":"Cancelled");const j=new URLSearchParams(l);j.delete("credits_payment"),i(j,{replace:!0})}})()},[l,i,s,A,F,I]);const Os=o.useRef(!1);o.useEffect(()=>{if(l.get("autoGenerate")==="true"&&!Os.current){Os.current=!0;const x=localStorage.getItem("pending_story_type"),d=localStorage.getItem("pending_art_style");x&&(Ot(x),localStorage.removeItem("pending_story_type")),d&&(lt(d),localStorage.removeItem("pending_art_style")),y(6);const k=new URLSearchParams(l);k.delete("autoGenerate"),i(k,{replace:!0})}},[l,i]);const fa=a=>{if(a.length===0)return;const x=a.filter(d=>{const k=parseInt(d.age);return k>=1&&k<=10});if(x.length>0){const d=x.map(k=>k.id);tr(d),h.info(`Auto-selected ${x.length} main character(s) aged 1-10`)}else{const d=a.reduce((k,f)=>{const j=parseInt(f.age)||999,$=parseInt(k.age)||999;return j<$?f:k});tr([d.id]),h.info(`Auto-selected youngest character as main: ${d.name} (age ${d.age})`)}};o.useEffect(()=>{D?(async()=>{try{_(!0);const x=await Ee.getCharacterData(Qt);if(h.info("Loaded character data from API:",{characters:x.characters.length,relationships:Object.keys(x.relationships).length}),me(x.characters),Object.keys(x.relationships).length>0&&(Rt(x.relationships),cs.current=!0),Object.keys(x.relationshipTexts).length>0&&os(x.relationshipTexts),x.customRelationships.length>0&&ls(x.customRelationships),x.characters.some(k=>k.storyRole)){const k=[],f=[];for(const j of x.characters)j.storyRole==="main"?k.push(j.id):j.storyRole==="out"&&f.push(j.id);tr(k),kt(f),h.info(`Loaded character roles from database: ${k.length} main, ${f.length} excluded`)}else x.characters.length>0&&fa(x.characters)}catch(x){h.error("Failed to load character data:",x)}finally{_(!1),Nr(!0)}})():q||Nr(!0)},[D,q]),o.useEffect(()=>{fe&&je&&!Hr.current&&(Hr.current=!0,h.info("Developer mode enabled, fetching dev metadata for story:",je),Be.getStoryDevMetadata(je).then(a=>{xa(a),h.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(a=>{h.warn("Failed to load dev metadata on toggle:",a),Hr.current=!1})),(!fe||!je)&&(Hr.current=!1)},[fe,je,xa]),o.useEffect(()=>{Qt&&D&&er&&(async()=>{try{h.info("Reloading characters with full avatars (dev mode)");const x=await Ee.getCharacterData(!0);me(x.characters),h.info(`Loaded ${x.characters.length} characters with full avatars`)}catch(x){h.error("Failed to reload with full avatars:",x)}})()},[Qt,D,er]),o.useEffect(()=>{B===1&&ye.length===0&&!w&&!G&&er&&ya()},[B,ye.length,w,G,er]);const ba=o.useRef(mt);o.useEffect(()=>{ba.current!==mt&&JSON.stringify(ba.current)!==JSON.stringify(mt)&&(ie([]),zt(""),ba.current=mt)},[mt]),o.useEffect(()=>{localStorage.setItem("story_language_level",dt)},[dt]),o.useEffect(()=>{localStorage.setItem("story_language",ft)},[ft]),o.useEffect(()=>{localStorage.setItem("story_pages",Qe.toString())},[Qe]),o.useEffect(()=>{localStorage.setItem("story_dedication",At)},[At]),o.useEffect(()=>{localStorage.setItem("story_details",Pt)},[Pt]),o.useEffect(()=>{localStorage.setItem("story_type",wt)},[wt]),o.useEffect(()=>{Ne?localStorage.setItem("story_category",Ne):localStorage.removeItem("story_category")},[Ne]),o.useEffect(()=>{Me?localStorage.setItem("story_topic",Me):localStorage.removeItem("story_topic")},[Me]),o.useEffect(()=>{Le?localStorage.setItem("story_theme",Le):localStorage.removeItem("story_theme")},[Le]),o.useEffect(()=>{Ve?localStorage.setItem("story_custom_theme_text",Ve):localStorage.removeItem("story_custom_theme_text")},[Ve]);const qa=o.useRef(Ne),Ua=o.useRef(Me),Ka=o.useRef(Le),Ja=o.useRef(!0);o.useEffect(()=>{if(Ja.current){Ja.current=!1;return}const a=qa.current!==Ne,x=Ua.current!==Me,d=Ka.current!==Le;(a||x||d)&&(zt(""),localStorage.removeItem("story_details"),ie([])),qa.current=Ne,Ua.current=Me,Ka.current=Le},[Ne,Me,Le]),o.useEffect(()=>{localStorage.setItem("story_art_style",xt)},[xt]);const bs=o.useRef(!1);o.useEffect(()=>{if(B===4&&!bs.current&&!Ht&&Q.length===0){const a=!!Ne,x=!!Le||!!Me,d=ye.length>0;a&&x&&d&&(bs.current=!0,h.info("[StoryWizard] Pre-generating story ideas while user selects art style"),Ya())}bs.current&&Q.length===0&&(bs.current=!1)},[B,Ne,Le,Me,ye.length,Ht,Q.length]);const Qa=o.useRef({storyCategory:Ne,storyTheme:Le,storyTopic:Me});o.useEffect(()=>{const a=Qa.current,x=a.storyCategory!==Ne||a.storyTheme!==Le||a.storyTopic!==Me;Qa.current={storyCategory:Ne,storyTheme:Le,storyTopic:Me},x&&(Ht||Q.length>0)&&(h.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),bt.current&&(bt.current.abort(),bt.current=null),hr(!1),rr(!1),sr(!1),ie([]),u(null),c(""),bs.current=!1)},[Ne,Le,Me,Ht,Q.length]),o.useEffect(()=>{if(!Ht)return;const x=setTimeout(()=>{h.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),hr(!1),rr(!1),sr(!1),P(s==="de"?"ZeitÃ¼berschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":s==="fr"?"DÃ©lai d'attente de gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(x)},[Ht,s]),o.useEffect(()=>{if(!Sr&&!Cr){Mr(0),t(0);return}const a=35e3,x=80,d=100,k=Date.now(),f=setInterval(()=>{const j=Date.now()-k,$=Math.min(j/a,1),z=1-Math.pow(1-$,3),T=Math.round(z*x);Sr&&Mr(T),Cr&&t(T),$>=1&&clearInterval(f)},d);return()=>clearInterval(f)},[Sr,Cr]),o.useEffect(()=>{B>=1&&B<=5&&localStorage.setItem("wizard_step",B.toString())},[B]);const ri=a=>{dr(a)},si=a=>{cr(a),!(a==="custom"||a==="realistic"||a==="")&&(Ne==="adventure"||(Ne==="life-challenge"||Ne==="educational")&&Me!=="")&&ar(4)},ai=a=>{Dr(a),Ne==="historical"&&a!==""&&ar(4)},ni=a=>{lt(a),ar(5)};o.useEffect(()=>{if(B===2&&ye.length>=2&&!G){const a=ye.map(x=>x.id).sort().join("-");if(!ds.current||ds.current!==a){const d=ko(s);h.debug("Initializing relationships for step 2",{charKey:a,existingCount:Object.keys(nt).length}),Rt(k=>{const f={...k};let j=!1;return ye.forEach(($,z)=>{ye.forEach((T,re)=>{if(z!==re){const Z=`${$.id}-${T.id}`;f[Z]||(f[Z]=d,j=!0,h.debug("Initializing missing relationship:",Z))}})}),j?f:k}),ds.current=a}}},[B,ye,s,G]);const ii=()=>{if(ye.length<2)return!0;for(let a=0;a<ye.length;a++)for(let x=0;x<ye.length;x++)if(a!==x){const d=`${ye[a].id}-${ye[x].id}`,k=nt[d];if(!k||fn(k))return!1}return!0},oi=()=>{if(ye.length<2)return null;let a=0,x=null;for(const d of ye){let k=0;for(const f of ye)if(d.id!==f.id){const j=`${d.id}-${f.id}`,$=nt[j];(!$||fn($))&&k++}k>a&&(a=k,x=d)}return x},ya=()=>{Ce({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),Je("photo"),Xt(!1)},li=(a,x=1500)=>new Promise(d=>{const k=new Image;k.onload=()=>{const f=document.createElement("canvas");let{width:j,height:$}=k;(j>x||$>x)&&(j>$?($=Math.round($*x/j),j=x):(j=Math.round(j*x/$),$=x)),f.width=j,f.height=$;const z=f.getContext("2d");z==null||z.drawImage(k,0,0,j,$),d(f.toDataURL("image/jpeg",.85))},k.onerror=()=>d(a),k.src=a}),di=async(a,x)=>{var f,j,$,z,T;if(h.info(`ðŸ“¸ handlePhotoSelect called: file=${a==null?void 0:a.name}, character=${w==null?void 0:w.name}, developerMode=${fe}`),w&&!fe){const re=!!((f=w.avatars)!=null&&f.winter||(j=w.avatars)!=null&&j.standard||($=w.avatars)!=null&&$.summer||(z=w.avatars)!=null&&z.hasFullAvatars);if(h.info(`ðŸ“¸ hasAvatars=${re}`),re){const Z=Zs(w.id);if(h.info(`ðŸ“¸ cooldown check: canRegenerate=${Z.canRegenerate}, waitSeconds=${Z.waitSeconds}`),!Z.canRegenerate){const X=s==="de"?`Bitte warten Sie ${Z.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${Z.waitSeconds} seconds before uploading a new photo.`;P(X);return}Pn(w.id)}}const d=x&&((T=w==null?void 0:w.clothing)!=null&&T.structured)?{...w.clothing.structured}:null,k=new FileReader;k.onload=async re=>{var X,ge,we,Ke,Ue,ee,ze,ae,W,L,U,O;const Z=(X=re.target)==null?void 0:X.result;w&&(Ps.current={physical:w.physical,gender:w.gender,age:w.age}),zr(void 0),St(!0),!(w!=null&&w.name)||w.name.trim().length<2?Je("name"):(Je("traits"),h.info("ðŸ“¸ Character has name, going to traits step to show avatar regeneration"));try{const ce=await li(Z),De=Math.round(Z.length/1024),K=Math.round(ce.length/1024);h.info(`Starting photo analysis... (${De}KB -> ${K}KB)`);const Ie=w!=null&&w.id&&w.id>0?w.id:void 0,pe=await Ee.analyzePhoto(ce,s,void 0,void 0,Ie);if(pe.success){if(pe.multipleFacesDetected&&pe.faces&&pe.faces.length>1){h.info(`Multiple faces detected (${pe.faces.length}), showing selection modal`),ns(ce),is(d?{structured:d}:null),as(pe.faces),ss(!0),St(!1);return}h.info("Photo analysis complete:",{hasPhotos:!!pe.photos,hasPhysical:!!pe.physical,hasClothing:!!pe.clothing,age:pe.age,gender:pe.gender}),pe._debug&&(rs(pe._debug),pe._debug.rawResponse,pe._debug.error&&console.warn("ðŸ“¸ [DEBUG] Gemini error:",pe._debug.error));const Ge={original:((ge=pe.photos)==null?void 0:ge.face)||Z,face:(we=pe.photos)==null?void 0:we.face,body:((Ke=pe.photos)==null?void 0:Ke.body)||Z,bodyNoBg:(Ue=pe.photos)==null?void 0:Ue.bodyNoBg,faceBox:(ee=pe.photos)==null?void 0:ee.faceBox,bodyBox:(ze=pe.photos)==null?void 0:ze.bodyBox},Xe=(ae=pe.photos)!=null&&ae.bodyNoBg?Math.round(pe.photos.bodyNoBg.length/1024):0,it=(W=pe.photos)!=null&&W.body?Math.round(pe.photos.body.length/1024):0,_s=(L=pe.photos)!=null&&L.face?Math.round(pe.photos.face.length/1024):0;if(h.info(`ðŸ“¸ [PHOTO CHANGE] Analysis returned: bodyNoBg=${Xe}KB, body=${it}KB, face=${_s}KB`),(U=pe.photos)!=null&&U.bodyNoBg){const Re=pe.photos.bodyNoBg.substring(pe.photos.bodyNoBg.indexOf("base64,")+7,pe.photos.bodyNoBg.indexOf("base64,")+27);h.info(`ðŸ“¸ [PHOTO CHANGE] bodyNoBg fingerprint: ${Re}...`)}let Lt,Hs;d?(Lt={structured:d},Hs={upperBody:d.upperBody?"user":void 0,lowerBody:d.lowerBody?"user":void 0,shoes:d.shoes?"user":void 0,fullBody:d.fullBody?"user":void 0},h.info(`ðŸ‘• Keeping old clothing (marked as user-edited): ${JSON.stringify(d)}`)):h.info("ðŸ‘• Using new photo's clothing (cleared existing)");const Ws=pe.characterId,ja=(w==null?void 0:w.id)&&w.id>0,Wr=ja?w.id:Ws;ja?h.info(`ðŸ“¸ [PHOTO] Keeping existing character ID: ${w.id} (server created new ID ${Ws} but ignoring)`):Ws&&h.info(`ðŸ“¸ [PHOTO] Using server-created character ID: ${Ws}`);const Tt=w?{...w,id:Wr||w.id,photos:Ge,avatars:{status:"generating"},clothing:Lt,clothingSource:Hs}:null;if(Tt){const Re=(O=Tt.photos)==null?void 0:O.bodyNoBg,gt=Re?Math.round(Re.length/1024):0;if(h.info(`ðŸ“¸ [CHAR FOR GEN] bodyNoBg=${gt}KB, has photos: ${!!Tt.photos}`),Re){const Fe=Re.substring(Re.indexOf("base64,")+7,Re.indexOf("base64,")+27);h.info(`ðŸ“¸ [CHAR FOR GEN] fingerprint: ${Fe}...`)}}if(Ce(Re=>{var Fe;if(!Re)return null;const gt=(Fe=Re.avatars)!=null&&Fe.standard?{...Re.avatars,status:"generating",stale:!0}:{status:"generating"};return{...Re,id:Wr||Re.id,photos:Ge,avatars:gt,clothing:Lt,clothingSource:Hs}}),Wr&&!ja&&me(Re=>{if(!Re.some(Fe=>Fe.id===Wr)){const Fe={...w,id:Wr,photos:Ge,avatars:{status:"generating"},clothing:Lt,clothingSource:Hs};return h.info(`ðŸ“¸ Adding new character ${Wr} to array to prevent data loss`),[...Re,Fe]}return Re}),h.info("ðŸŽ¨ Auto-starting avatar generation in background..."),h.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Ge.bodyNoBg}, body=${!!Ge.body}, face=${!!Ge.face}`),Tt&&Tt.id&&Tt.name&&Tt.name.trim()){const Re=Tt.id;Ct(Re),Ee.generateAndSaveAvatarForCharacter(Tt,void 0,{avatarModel:tt.avatarModel||void 0}).then(gt=>{gt.success&&gt.character?(Ce(Fe=>!Fe||Fe.id!==Re?Fe:{...Fe,avatars:gt.character.avatars,physical:gt.character.physical,clothing:gt.character.clothing}),me(Fe=>Fe.map(It=>It.id===Re?{...It,...gt.character,id:It.id}:It)),h.success(`âœ… Avatar generated and traits extracted for ${Tt.name}`)):(h.error(`âŒ Avatar generation failed: ${gt.error}`),Ce(Fe=>Fe&&Fe.id===Re?{...Fe,avatars:{status:"failed"}}:Fe),me(Fe=>Fe.map(It=>It.id===Re?{...It,avatars:{status:"failed"}}:It)))}).catch(gt=>{h.error("âŒ Avatar generation error:",gt),Ce(Fe=>Fe&&Fe.id===Re?{...Fe,avatars:{status:"failed"}}:Fe),me(Fe=>Fe.map(It=>It.id===Re?{...It,avatars:{status:"failed"}}:It))}).finally(()=>{Ct(null)})}else Tt&&Tt.id?(h.info("â­ï¸ Skipping auto-generation: character has no name yet"),Ct(null),Ce(Re=>Re&&{...Re,avatars:{status:"pending"}})):(h.warn("â­ï¸ Skipping auto-generation: no character data available"),Ct(null))}else pe.error==="no_face_detected"?(h.warn("No face detected in photo"),P(b.noFaceDetected)):(h.warn("Photo analysis returned no data, using original photo"),Ce(Ge=>Ge?{...Ge,photos:{original:Z},avatars:void 0}:null))}catch(ce){h.error("Photo analysis error:",ce),Ce(De=>De?{...De,photos:{original:Z},avatars:void 0}:null)}finally{St(!1)}},k.readAsDataURL(a)},ci=async a=>{var x,d,k,f,j,$,z,T;if(!jr){h.error("No pending photo data for face selection");return}ss(!1),St(!0);try{h.info(`Re-analyzing photo with selected face ID: ${a}`);const re=_t.map(ge=>({id:ge.id,x:ge.faceBox.x,y:ge.faceBox.y,width:ge.faceBox.width,height:ge.faceBox.height,confidence:ge.confidence})),Z=w!=null&&w.id&&w.id>0?w.id:void 0,X=await Ee.analyzePhoto(jr,s,a,re,Z);if(X.success){h.info("Photo analysis complete with selected face:",{hasPhotos:!!X.photos,hasPhysical:!!X.physical,hasClothing:!!X.clothing,age:X.age,gender:X.gender}),X._debug&&rs(X._debug);const ge=Br==null?void 0:Br.structured,we={original:((x=X.photos)==null?void 0:x.face)||jr,face:(d=X.photos)==null?void 0:d.face,body:((k=X.photos)==null?void 0:k.body)||jr,bodyNoBg:(f=X.photos)==null?void 0:f.bodyNoBg,faceBox:(j=X.photos)==null?void 0:j.faceBox,bodyBox:($=X.photos)==null?void 0:$.bodyBox},Ke=(z=X.photos)!=null&&z.bodyNoBg?Math.round(X.photos.bodyNoBg.length/1024):0;if(h.info(`ðŸ“¸ [FACE SELECT] Analysis returned: bodyNoBg=${Ke}KB`),(T=X.photos)!=null&&T.bodyNoBg){const U=X.photos.bodyNoBg.substring(X.photos.bodyNoBg.indexOf("base64,")+7,X.photos.bodyNoBg.indexOf("base64,")+27);h.info(`ðŸ“¸ [FACE SELECT] bodyNoBg fingerprint: ${U}...`)}let Ue,ee;ge&&(Ue={structured:ge},ee={upperBody:ge.upperBody?"user":void 0,lowerBody:ge.lowerBody?"user":void 0,shoes:ge.shoes?"user":void 0,fullBody:ge.fullBody?"user":void 0});const ze=X.characterId,ae=(w==null?void 0:w.id)&&w.id>0,W=ae?w.id:ze;ae?h.info(`ðŸ“¸ [FACE SELECT] Keeping existing character ID: ${w.id} (server created new ID ${ze} but ignoring)`):ze&&h.info(`ðŸ“¸ [FACE SELECT] Using server-created character ID: ${ze}`);const L=w?{...w,id:W||w.id,photos:we,avatars:{status:"generating"},clothing:Ue,clothingSource:ee}:null;if(Ce(U=>{var ce;if(!U)return null;const O=(ce=U.avatars)!=null&&ce.standard?{...U.avatars,status:"generating",stale:!0}:{status:"generating"};return{...U,id:W||U.id,photos:we,avatars:O,clothing:Ue,clothingSource:ee}}),W&&!ae&&me(U=>{if(!U.some(ce=>ce.id===W)){const ce={...w,id:W,photos:we,avatars:{status:"generating"},clothing:Ue,clothingSource:ee};return h.info(`ðŸ“¸ [FACE SELECT] Adding new character ${W} to array to prevent data loss`),[...U,ce]}return U}),w!=null&&w.name&&w.name.trim().length>=2?(Je("traits"),h.info("ðŸ“¸ Face selected, character has name, going to traits step")):Je("name"),h.info("ðŸŽ¨ Auto-starting avatar generation in background after face selection..."),h.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!we.bodyNoBg}, body=${!!we.body}, face=${!!we.face}`),L&&L.name&&L.name.trim()){const U=L.id;Ct(U),Ee.generateAndSaveAvatarForCharacter(L,void 0,{avatarModel:tt.avatarModel||void 0}).then(O=>{O.success&&O.character?(Ce(ce=>!ce||ce.id!==U?ce:{...ce,avatars:O.character.avatars,physical:O.character.physical,clothing:O.character.clothing}),me(ce=>ce.map(De=>De.id===U?{...De,...O.character,id:De.id}:De)),h.success(`âœ… Avatar generated for ${L.name} (face selection)`)):(h.error(`âŒ Avatar generation failed: ${O.error}`),Ce(ce=>ce&&ce.id===U?{...ce,avatars:{status:"failed"}}:ce),me(ce=>ce.map(De=>De.id===U?{...De,avatars:{status:"failed"}}:De)))}).catch(O=>{h.error("âŒ Avatar generation error:",O),Ce(ce=>ce&&ce.id===U?{...ce,avatars:{status:"failed"}}:ce),me(ce=>ce.map(De=>De.id===U?{...De,avatars:{status:"failed"}}:De))}).finally(()=>{Ct(null)})}else h.info("â­ï¸ Skipping auto-generation: character has no name yet"),Ct(null),Ce(U=>U&&{...U,avatars:{status:"pending"}})}else h.warn("Photo analysis failed after face selection"),P(b.noFaceDetected)}catch(re){h.error("Photo analysis error after face selection:",re),P("Failed to analyze photo. Please try again.")}finally{St(!1),ns(null),is(null),as([])}},mi=()=>{ss(!1),ns(null),is(null),as([]),Je("photo")},ui=async()=>{if(w){Ce(a=>a&&{...a,avatars:void 0}),ts(!0);try{h.info(`ðŸ”„ Regenerating avatars for ${w.name}...`);const a=await Ee.regenerateAvatarsForCharacter(w.id,(x,d)=>h.info(`[${x}] ${d}`),{avatarModel:tt.avatarModel||void 0});if(a.success&&a.character){const x={...a.character.avatars,stale:!1};Ce(d=>d&&{...d,avatars:x,physical:a.character.physical,clothing:a.character.clothing}),me(d=>d.map(k=>k.id===w.id?{...k,avatars:x,physical:a.character.physical,clothing:a.character.clothing}:k)),h.success(`âœ… Avatars and traits regenerated for ${w.name}`)}else h.error(`âŒ Failed to regenerate avatars: ${a.error}`),P(`Failed to regenerate avatars: ${a.error||"Unknown error"}`)}catch(a){h.error(`âŒ Failed to regenerate avatars for ${w.name}:`,a),P(`Failed to regenerate avatars: ${a instanceof Error?a.message:"Unknown error"}`)}finally{ts(!1)}}},gi=async()=>{var a,x,d,k,f,j,$,z,T,re,Z,X,ge,we,Ke,Ue;if(w){Ce(ee=>ee&&{...ee,avatars:void 0}),Fr(!0);try{h.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${w.name}...`),h.info(`Physical traits: ${JSON.stringify(w.physical)}`);const ee=await Ee.generateClothingAvatarsWithTraits(w);if(ee.success&&ee.avatars){const ze={...ee.avatars,stale:!1,generatedAt:new Date().toISOString()},ae=w.physicalTraitsSource||{},W=ee.extractedTraits?{height:(a=w.physical)==null?void 0:a.height,eyeColor:ae.eyeColor==="user"?(x=w.physical)==null?void 0:x.eyeColor:ee.extractedTraits.eyeColor,eyeColorHex:ae.eyeColor==="user"?(d=w.physical)==null?void 0:d.eyeColorHex:ee.extractedTraits.eyeColorHex,hairColor:ae.hairColor==="user"?(k=w.physical)==null?void 0:k.hairColor:ee.extractedTraits.hairColor,hairColorHex:ae.hairColor==="user"?(f=w.physical)==null?void 0:f.hairColorHex:ee.extractedTraits.hairColorHex,hairLength:ae.hairLength==="user"?(j=w.physical)==null?void 0:j.hairLength:ee.extractedTraits.hairLength,hairStyle:ae.hairStyle==="user"?($=w.physical)==null?void 0:$.hairStyle:ee.extractedTraits.hairStyle,build:ae.build==="user"?(z=w.physical)==null?void 0:z.build:ee.extractedTraits.build,face:ae.face==="user"?(T=w.physical)==null?void 0:T.face:ee.extractedTraits.face,facialHair:ae.facialHair==="user"?(re=w.physical)==null?void 0:re.facialHair:ee.extractedTraits.facialHair,other:ae.other==="user"?(Z=w.physical)==null?void 0:Z.other:ee.extractedTraits.other,skinTone:ae.skinTone==="user"?(X=w.physical)==null?void 0:X.skinTone:ee.extractedTraits.skinTone,skinToneHex:ae.skinTone==="user"?(ge=w.physical)==null?void 0:ge.skinToneHex:ee.extractedTraits.skinToneHex,detailedHairAnalysis:ee.extractedTraits.detailedHairAnalysis||((we=w.physical)==null?void 0:we.detailedHairAnalysis),apparentAge:ae.apparentAge==="user"?(Ke=w.physical)==null?void 0:Ke.apparentAge:ee.extractedTraits.apparentAge||((Ue=w.physical)==null?void 0:Ue.apparentAge)}:w.physical,L=ee.extractedTraits?{eyeColor:ae.eyeColor==="user"?"user":ee.extractedTraits.eyeColor?"extracted":void 0,hairColor:ae.hairColor==="user"?"user":ee.extractedTraits.hairColor?"extracted":void 0,hairLength:ae.hairLength==="user"?"user":ee.extractedTraits.hairLength?"extracted":void 0,hairStyle:ae.hairStyle==="user"?"user":ee.extractedTraits.hairStyle?"extracted":void 0,build:ae.build==="user"?"user":ee.extractedTraits.build?"extracted":void 0,face:ae.face==="user"?"user":ee.extractedTraits.face?"extracted":void 0,facialHair:ae.facialHair==="user"?"user":ee.extractedTraits.facialHair?"extracted":void 0,other:ae.other==="user"?"user":ee.extractedTraits.other?"extracted":void 0,skinTone:ae.skinTone==="user"?"user":ee.extractedTraits.skinTone?"extracted":void 0,apparentAge:ae.apparentAge==="user"?"user":ee.extractedTraits.apparentAge?"extracted":void 0}:w.physicalTraitsSource,U=ee.extractedClothing?{...w.clothing,structured:{upperBody:ee.extractedClothing.upperBody||void 0,lowerBody:ee.extractedClothing.lowerBody||void 0,shoes:ee.extractedClothing.shoes||void 0,fullBody:ee.extractedClothing.fullBody||void 0}}:w.clothing;Ce(O=>O&&{...O,avatars:ze,physical:W,physicalTraitsSource:L,clothing:U}),me(O=>O.map(ce=>ce.id===w.id?{...ce,avatars:ze,physical:W,physicalTraitsSource:L,clothing:U}:ce)),h.success(`âœ… Avatars WITH TRAITS regenerated for ${w.name}`),ee.extractedTraits&&h.info(`ðŸ“‹ Extracted traits saved: ${JSON.stringify(ee.extractedTraits)}`),ee.extractedClothing&&h.info(`ðŸ‘• Extracted clothing saved: ${JSON.stringify(ee.extractedClothing)}`)}else h.error(`âŒ Failed to regenerate avatars with traits: ${ee.error}`),P(`Failed to regenerate avatars: ${ee.error||"Unknown error"}`)}catch(ee){h.error(`âŒ Failed to regenerate avatars with traits for ${w.name}:`,ee),P(`Failed to regenerate avatars: ${ee instanceof Error?ee.message:"Unknown error"}`)}finally{Fr(!1)}}},hi=async()=>{var d,k,f,j,$,z,T,re,Z,X,ge,we,Ke,Ue,ee,ze;if(!w)return;const a={...w},x=w.id;Fr(!0);try{h.info(`ðŸ’¾ Saving character and regenerating avatars for ${a.name}...`),await va(),h.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${a.name}...`);const W=(await new Promise(U=>{me(O=>(U(O),O))})).find(U=>U.id===x);if(!W){h.warn("Character not found in characters array after save");return}const L=await Ee.generateClothingAvatarsWithTraits(W);if(L.success&&L.avatars){const U={...L.avatars,stale:!1,generatedAt:new Date().toISOString()},O=W.physicalTraitsSource||{},ce=L.extractedTraits?{height:(d=W.physical)==null?void 0:d.height,eyeColor:O.eyeColor==="user"?(k=W.physical)==null?void 0:k.eyeColor:L.extractedTraits.eyeColor,eyeColorHex:O.eyeColor==="user"?(f=W.physical)==null?void 0:f.eyeColorHex:L.extractedTraits.eyeColorHex,hairColor:O.hairColor==="user"?(j=W.physical)==null?void 0:j.hairColor:L.extractedTraits.hairColor,hairColorHex:O.hairColor==="user"?($=W.physical)==null?void 0:$.hairColorHex:L.extractedTraits.hairColorHex,hairLength:O.hairLength==="user"?(z=W.physical)==null?void 0:z.hairLength:L.extractedTraits.hairLength,hairStyle:O.hairStyle==="user"?(T=W.physical)==null?void 0:T.hairStyle:L.extractedTraits.hairStyle,build:O.build==="user"?(re=W.physical)==null?void 0:re.build:L.extractedTraits.build,face:O.face==="user"?(Z=W.physical)==null?void 0:Z.face:L.extractedTraits.face,facialHair:O.facialHair==="user"?(X=W.physical)==null?void 0:X.facialHair:L.extractedTraits.facialHair,other:O.other==="user"?(ge=W.physical)==null?void 0:ge.other:L.extractedTraits.other,skinTone:O.skinTone==="user"?(we=W.physical)==null?void 0:we.skinTone:L.extractedTraits.skinTone,skinToneHex:O.skinTone==="user"?(Ke=W.physical)==null?void 0:Ke.skinToneHex:L.extractedTraits.skinToneHex,detailedHairAnalysis:L.extractedTraits.detailedHairAnalysis||((Ue=W.physical)==null?void 0:Ue.detailedHairAnalysis),apparentAge:O.apparentAge==="user"?(ee=W.physical)==null?void 0:ee.apparentAge:L.extractedTraits.apparentAge||((ze=W.physical)==null?void 0:ze.apparentAge)}:W.physical,De=L.extractedTraits?{eyeColor:O.eyeColor==="user"?"user":L.extractedTraits.eyeColor?"extracted":void 0,hairColor:O.hairColor==="user"?"user":L.extractedTraits.hairColor?"extracted":void 0,hairLength:O.hairLength==="user"?"user":L.extractedTraits.hairLength?"extracted":void 0,hairStyle:O.hairStyle==="user"?"user":L.extractedTraits.hairStyle?"extracted":void 0,build:O.build==="user"?"user":L.extractedTraits.build?"extracted":void 0,face:O.face==="user"?"user":L.extractedTraits.face?"extracted":void 0,facialHair:O.facialHair==="user"?"user":L.extractedTraits.facialHair?"extracted":void 0,other:O.other==="user"?"user":L.extractedTraits.other?"extracted":void 0,skinTone:O.skinTone==="user"?"user":L.extractedTraits.skinTone?"extracted":void 0,apparentAge:O.apparentAge==="user"?"user":L.extractedTraits.apparentAge?"extracted":void 0}:W.physicalTraitsSource,K=L.extractedClothing?{...W.clothing,structured:{upperBody:L.extractedClothing.upperBody||void 0,lowerBody:L.extractedClothing.lowerBody||void 0,shoes:L.extractedClothing.shoes||void 0,fullBody:L.extractedClothing.fullBody||void 0}}:W.clothing;Ce(Xe=>Xe&&Xe.id===x?{...Xe,avatars:U,physical:ce,physicalTraitsSource:De,clothing:K}:Xe),me(Xe=>Xe.map(it=>it.id===x?{...it,avatars:U,physical:ce,physicalTraitsSource:De,clothing:K}:it)),h.success(`âœ… Avatars regenerated for ${W.name}`);const Ie={...W,avatars:U,physical:ce,physicalTraitsSource:De,clothing:K},Ge=(await new Promise(Xe=>{me(it=>(Xe(it),it))})).map(Xe=>Xe.id===x?Ie:Xe);await Ee.saveCharacterData({characters:Ge,relationships:nt,relationshipTexts:Et,customRelationships:mr,customStrengths:[],customWeaknesses:[],customFears:[]}),h.success("ðŸ’¾ Character saved with new avatars, traits, and clothing"),A(s==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else h.error(`âŒ Failed to regenerate avatars: ${L.error}`),P(`Failed to regenerate avatars: ${L.error||"Unknown error"}`)}catch(ae){h.error("âŒ Failed to save and regenerate:",ae),P(`Failed: ${ae instanceof Error?ae.message:"Unknown error"}`)}finally{Fr(!1)}},xi=async()=>{var k,f,j,$,z,T,re,Z,X,ge,we,Ke,Ue,ee,ze,ae,W,L;if(!w)return;const a=w.id;zr(void 0),Je("traits");const x=(k=w.avatars)==null?void 0:k.status,d=!!((f=w.avatars)!=null&&f.standard||(j=w.avatars)!=null&&j.winter||($=w.avatars)!=null&&$.summer||(z=w.avatars)!=null&&z.hasFullAvatars);if(x==="generating"||x==="complete"&&d){h.info(`â­ï¸ Skipping avatar generation - already ${x}${d?" with avatars":""}`);return}Ct(a),Ce(U=>U&&U.id===a?{...U,avatars:{status:"generating"}}:U),h.info(`ðŸŽ¨ Starting avatar generation for ${w.name||"unnamed"} (id: ${a})...`);try{const U=await Ee.generateClothingAvatarsWithTraits(w);if(U.success&&U.avatars){const O={...U.avatars,stale:!1,generatedAt:new Date().toISOString()},ce=U.extractedTraits?{...w.physical,build:U.extractedTraits.build||((T=w.physical)==null?void 0:T.build),eyeColor:U.extractedTraits.eyeColor||((re=w.physical)==null?void 0:re.eyeColor),eyeColorHex:U.extractedTraits.eyeColorHex||((Z=w.physical)==null?void 0:Z.eyeColorHex),hairColor:U.extractedTraits.hairColor||((X=w.physical)==null?void 0:X.hairColor),hairColorHex:U.extractedTraits.hairColorHex||((ge=w.physical)==null?void 0:ge.hairColorHex),hairLength:U.extractedTraits.hairLength||((we=w.physical)==null?void 0:we.hairLength),hairStyle:U.extractedTraits.hairStyle||((Ke=w.physical)==null?void 0:Ke.hairStyle),facialHair:U.extractedTraits.facialHair||((Ue=w.physical)==null?void 0:Ue.facialHair),skinTone:U.extractedTraits.skinTone||((ee=w.physical)==null?void 0:ee.skinTone),skinToneHex:U.extractedTraits.skinToneHex||((ze=w.physical)==null?void 0:ze.skinToneHex),face:U.extractedTraits.face||((ae=w.physical)==null?void 0:ae.face),other:U.extractedTraits.other||((W=w.physical)==null?void 0:W.other),detailedHairAnalysis:U.extractedTraits.detailedHairAnalysis||((L=w.physical)==null?void 0:L.detailedHairAnalysis)}:w.physical,De=U.extractedClothing?{...w.clothing,structured:{upperBody:U.extractedClothing.upperBody||void 0,lowerBody:U.extractedClothing.lowerBody||void 0,shoes:U.extractedClothing.shoes||void 0,fullBody:U.extractedClothing.fullBody||void 0}}:w.clothing;me(K=>K.map(Ie=>Ie.id===a?{...Ie,avatars:O,physical:ce,clothing:De}:Ie)),Ce(K=>K&&K.id===a?{...K,avatars:O,physical:ce,clothing:De}:K),h.success(`âœ… Avatar generated for ${w.name} (id: ${a})`)}else h.error(`âŒ Failed to generate avatar: ${U.error}`),P(`Failed to generate avatar: ${U.error||"Unknown error"}`),me(O=>O.map(ce=>ce.id===a?{...ce,avatars:{status:"failed"}}:ce)),Ce(O=>O&&O.id===a?{...O,avatars:{status:"failed"}}:O)}catch(U){h.error("âŒ Avatar generation failed:",U),P(`Avatar generation failed: ${U instanceof Error?U.message:"Unknown error"}`),me(O=>O.map(ce=>ce.id===a?{...ce,avatars:{status:"failed"}}:ce)),Ce(O=>O&&O.id===a?{...O,avatars:{status:"failed"}}:O)}finally{Ct(null)}},va=async()=>{var a;if(w){_(!0);try{const x=Rr.current,d=Yr.current;if(!x){h.warn("No current character to save");return}const k=x.id&&d.find(z=>z.id===x.id),f=k?d.map(z=>z.id===x.id?x:z):[...d,x];h.info("Saving characters with relationships:",f.length);const j=!k&&!!((a=x.photos)!=null&&a.original);await Ee.saveCharacterData({characters:f,relationships:nt,relationshipTexts:Et,customRelationships:mr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:j}),ur.current=!1,h.success("Character data saved successfully"),me(f),fa(f);const $=f.find(z=>z.id===w.id);$&&Ee.needsAvatars($)&&yr!==$.id&&(h.info(`ðŸŽ¨ Starting background avatar generation for ${$.name}...`),Ee.generateAndSaveAvatarForCharacter($,void 0,{avatarModel:tt.avatarModel||void 0}).then(z=>{z.success&&z.character?(me(T=>T.map(re=>re.id===$.id?{...re,avatars:z.character.avatars,physical:z.character.physical,clothing:z.character.clothing}:re)),h.success(`âœ… Avatars and traits saved for ${$.name}`)):z.skipped||(h.warn(`Avatar generation failed for ${$.name}: ${z.error}`),me(T=>T.map(re=>re.id===$.id?{...re,avatars:{status:"failed"}}:re)))}).catch(z=>{h.error(`âŒ Background avatar generation error for ${$.name}:`,z),me(T=>T.map(re=>re.id===$.id?{...re,avatars:{status:"failed"}}:re))})),Ce(null),Xt(!0)}catch(x){h.error("Failed to save character:",x),P(s==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de l'enregistrement du personnage. Veuillez rÃ©essayer.":"Failed to save character. Please try again.")}finally{_(!1)}}},pi=async a=>{Ce({...a}),Je("traits"),Xt(!1);const x=await Ee.loadFullCharacter(a.id);x&&(Ce(d=>d&&d.id===a.id?{...d,...x}:d),me(d=>d.map(k=>k.id===a.id?{...k,...x}:k)))},fi=async a=>{try{const x=await Ee.deleteCharacter(a);x.success?(me(d=>d.filter(k=>k.id!==a)),Rt(d=>{const k={...d};return Object.keys(k).forEach(f=>{(f.includes(`${a}-`)||f.includes(`-${a}`))&&delete k[f]}),k}),os(d=>{const k={...d};return Object.keys(k).forEach(f=>{(f.includes(`${a}-`)||f.includes(`-${a}`))&&delete k[f]}),k}),tr(d=>d.filter(k=>k!==a)),Ft.current=!0,h.success(`Character ${a} deleted`)):(h.error("Failed to delete character:",x.error),P(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character"))}catch(x){h.error("Failed to delete character:",x),P(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character")}},bi=(a,x,d)=>{const f=Ao(d,s),j=`${a}-${x}`,$=`${x}-${a}`;h.debug("Updating relationship:",j,"=",d,", inverse:",$,"=",f),ur.current=!0,Rt(z=>({...z,[j]:d,[$]:f}))},yi=(a,x)=>{ur.current=!0;const[d,k]=a.split("-").map(Number),f=`${k}-${d}`;os(j=>({...j,[a]:x,[f]:x}))},vi=(a,x)=>{ur.current=!0,ls(d=>[...d,{forward:a,inverse:x}])},ji=(a,x)=>{x==="out"?(kt(d=>d.includes(a)?d:[...d,a]),tr(d=>d.filter(k=>k!==a))):x==="in"?(kt(d=>d.filter(k=>k!==a)),tr(d=>d.filter(k=>k!==a))):x==="main"&&(kt(d=>d.filter(k=>k!==a)),tr(d=>d.includes(a)?d:[...d,a])),Ft.current=!0,me(d=>d.map(k=>k.id===a?{...k,storyRole:x}:k))},Ni=async()=>{const[a,x,d]=await Promise.all([new Promise(f=>{me(j=>(f(j),j))}),new Promise(f=>{tr(j=>(f(j),j))}),new Promise(f=>{kt(j=>(f(j),j))})]);if(a.length===0)return;if(!Ft.current){h.debug("Roles not modified, skipping save");return}const k={};for(const f of a)x.includes(f.id)?k[f.id]="main":d.includes(f.id)?k[f.id]="out":k[f.id]="in";try{await Ee.saveCharacterRoles(k),Ft.current=!1}catch(f){h.error("Failed to save character roles:",f)}},ys=o.useRef(null),ar=async a=>{a>=0&&a<=7&&(B===1&&w&&a!==1&&await va(),B===1&&a!==1&&(ys.current=(async()=>{await Si(),await Ni()})(),ys.current.catch(x=>h.error("Background save failed:",x))),a===1&&B!==1&&Ce(null),y(a),window.scrollTo(0,0))},wi=a=>a===1?!0:a===2||a===3?ye.length>0:a===4?ye.length>0&&Ne!=="":a===5?ye.length>0&&Ne!==""&&xt!=="":a===6?Or!=="":!1,Ar=()=>B===1?ye.length>0&&pt.length>0:B===2?!0:B===3?!(!Ne||Ne==="adventure"&&!Le||(Ne==="life-challenge"||Ne==="educational")&&!Me||Ne==="historical"&&!Me||Ne==="custom"&&!(Ve!=null&&Ve.trim())):B===4?xt!=="":B===5?ye.filter(x=>!mt.includes(x.id)).length>0&&pt.length>0&&Pt.trim().length>0:!1,Si=async()=>{const a=await new Promise(x=>{me(d=>(x(d),d))});if(a.length!==0){if(!ur.current){h.debug("Relationships not modified, skipping save");return}try{h.debug("Auto-saving character data with latest state..."),await Ee.saveCharacterData({characters:a,relationships:nt,relationshipTexts:Et,customRelationships:mr,customStrengths:[],customWeaknesses:[],customFears:[]}),ur.current=!1,h.debug("Character data auto-saved")}catch(x){h.error("Failed to auto-save character data:",x)}}},Ci=async()=>{if(B<5&&Ar()){if(B===1&&ye.length===1){sa(!0);return}await ar(B+1)}},Za=async()=>{B>0&&await ar(B-1)},ki=(a,x)=>{zt(a),Ze(x??null)},Ya=async()=>{bt.current&&bt.current.abort(),hr(!0),rr(!0),sr(!0),ie([]),u(null),c(""),Ze(null);const a=ye.filter(x=>!mt.includes(x.id));ut({storyType:wt,storyCategory:Ne||"",storyTopic:Me||"",storyTheme:Le||"",characters:a.map(x=>({id:x.id,name:x.name})),language:ft,languageLevel:dt,pages:Qe,userLocation:oe||void 0,season:Wt||void 0}),bt.current=Be.generateStoryIdeasStream({storyType:wt,storyTypeName:vs(),storyCategory:Ne||void 0,storyTopic:Me||void 0,storyTheme:Le||void 0,customThemeText:Le==="custom"?Ve:void 0,language:ft,languageLevel:dt,pages:Qe,characters:a.map(x=>({name:x.name,age:x.age,gender:x.gender,traits:x.traits,isMain:pt.includes(x.id)})),relationships:Object.entries(nt).map(([x,d])=>{const[k,f]=x.split("-").map(Number),j=a.find(z=>z.id===k),$=a.find(z=>z.id===f);return{character1:(j==null?void 0:j.name)||"",character2:($==null?void 0:$.name)||"",relationship:d}}).filter(x=>x.character1&&x.character2),ideaModel:(p==null?void 0:p.role)==="admin"||R?tt.ideaModel:void 0,userLocation:oe||void 0,season:Wt},{onStatus:(x,d,k)=>{d&&k&&u({prompt:d,model:k})},onStory1:x=>{ie(d=>{const k=[...d];return k[0]=x,k}),Mr(100),rr(!1)},onStory2:x=>{ie(d=>{const k=[...d];return k[1]=x,k}),t(100),sr(!1)},onError:x=>{h.error("Failed to generate story ideas:",x),P(s==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":s==="fr"?"Erreur lors de la gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Failed to generate ideas. Please try again."),hr(!1),rr(!1),sr(!1)},onDone:x=>{hr(!1),rr(!1),sr(!1),x&&c(x),bt.current=null,h.info("[IDEAS] onDone complete")}})},vs=()=>{const a=Aa.find(x=>x.id===wt);return a?a.name[s]:wt},Pr=async a=>{var d,k,f,j,$,z,T,re,Z,X,ge,we,Ke,Ue,ee,ze;if(console.log("[generateStory] Called with overrides:",a),console.log("[generateStory] user:",p==null?void 0:p.email,"emailVerified:",p==null?void 0:p.emailVerified,"isImpersonating:",R),ys.current&&(await ys.current,ys.current=null),!(a!=null&&a.skipEmailCheck)&&!R&&p&&p.emailVerified!==!0){await I();const ae=localStorage.getItem("currentUser");let W=p.emailVerified;if(ae)try{W=JSON.parse(ae).emailVerified}catch{}if(W===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",wt),localStorage.setItem("pending_art_style",xt),Es(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),Lr(!0),Rs(!1),y(6),ua({storyCategory:Ne||void 0,storyTopic:Me||void 0,storyTheme:Le||void 0,storyTypeName:vs(),storyDetails:Pt||void 0,artStyle:xt||void 0,language:ft||void 0,languageLevel:dt||void 0,pages:Qe||void 0,dedication:At||void 0,characters:ye.filter(ae=>!mt.includes(ae.id)).map(ae=>({id:ae.id,name:ae.name})),mainCharacters:pt,relationships:nt,relationshipTexts:Et,season:Wt||void 0,userLocation:oe||void 0}),gs(""),xr(""),Mt([]),hs([]),Bs(null),Ms({}),qt({frontCover:null,initialPage:null,backCover:null});const x=ye.filter(ae=>!mt.includes(ae.id)).filter(ae=>!ae.avatars||ae.avatars.stale||ae.avatars.status!=="complete");if(x.length>0){console.log("[generateStory] Characters needing avatar regeneration:",x.map(ae=>ae.name)),kr({current:1,total:100,message:s==="de"?`Aktualisiere Avatare fÃ¼r ${x.length} Charakter(e)...`:s==="fr"?`Mise Ã  jour des avatars pour ${x.length} personnage(s)...`:`Updating avatars for ${x.length} character(s)...`});for(let ae=0;ae<x.length;ae++){const W=x[ae];try{console.log(`[generateStory] Regenerating avatars for ${W.name} (${ae+1}/${x.length})`),kr({current:2,total:100,message:s==="de"?`Generiere Avatare fÃ¼r ${W.name}...`:s==="fr"?`GÃ©nÃ©ration des avatars pour ${W.name}...`:`Generating avatars for ${W.name}...`});const L=await Ee.generateClothingAvatarsWithTraits(W);if(L.success&&L.avatars){const U={...L.avatars,stale:!1,generatedAt:new Date().toISOString()},O=W.physicalTraitsSource||{},ce=L.extractedTraits?{...W.physical,height:(d=W.physical)==null?void 0:d.height,build:O.build==="user"?(k=W.physical)==null?void 0:k.build:L.extractedTraits.build,eyeColor:O.eyeColor==="user"?(f=W.physical)==null?void 0:f.eyeColor:L.extractedTraits.eyeColor,eyeColorHex:O.eyeColor==="user"?(j=W.physical)==null?void 0:j.eyeColorHex:L.extractedTraits.eyeColorHex,hairColor:O.hairColor==="user"?($=W.physical)==null?void 0:$.hairColor:L.extractedTraits.hairColor,hairColorHex:O.hairColor==="user"?(z=W.physical)==null?void 0:z.hairColorHex:L.extractedTraits.hairColorHex,hairLength:O.hairLength==="user"?(T=W.physical)==null?void 0:T.hairLength:L.extractedTraits.hairLength,hairStyle:O.hairStyle==="user"?(re=W.physical)==null?void 0:re.hairStyle:L.extractedTraits.hairStyle,facialHair:O.facialHair==="user"?(Z=W.physical)==null?void 0:Z.facialHair:L.extractedTraits.facialHair,skinTone:O.skinTone==="user"?(X=W.physical)==null?void 0:X.skinTone:L.extractedTraits.skinTone,skinToneHex:O.skinTone==="user"?(ge=W.physical)==null?void 0:ge.skinToneHex:L.extractedTraits.skinToneHex,face:O.face==="user"?(we=W.physical)==null?void 0:we.face:L.extractedTraits.face,other:O.other==="user"?(Ke=W.physical)==null?void 0:Ke.other:L.extractedTraits.other,detailedHairAnalysis:L.extractedTraits.detailedHairAnalysis||((Ue=W.physical)==null?void 0:Ue.detailedHairAnalysis),apparentAge:O.apparentAge==="user"?(ee=W.physical)==null?void 0:ee.apparentAge:L.extractedTraits.apparentAge||((ze=W.physical)==null?void 0:ze.apparentAge)}:W.physical,De=L.extractedTraits?{...O,build:O.build==="user"?"user":L.extractedTraits.build?"extracted":void 0,eyeColor:O.eyeColor==="user"?"user":L.extractedTraits.eyeColor?"extracted":void 0,hairColor:O.hairColor==="user"?"user":L.extractedTraits.hairColor?"extracted":void 0,hairLength:O.hairLength==="user"?"user":L.extractedTraits.hairLength?"extracted":void 0,hairStyle:O.hairStyle==="user"?"user":L.extractedTraits.hairStyle?"extracted":void 0,face:O.face==="user"?"user":L.extractedTraits.face?"extracted":void 0,facialHair:O.facialHair==="user"?"user":L.extractedTraits.facialHair?"extracted":void 0,other:O.other==="user"?"user":L.extractedTraits.other?"extracted":void 0,skinTone:O.skinTone==="user"?"user":L.extractedTraits.skinTone?"extracted":void 0,apparentAge:O.apparentAge==="user"?"user":L.extractedTraits.apparentAge?"extracted":void 0}:W.physicalTraitsSource,K=L.extractedClothing?{...W.clothing,structured:{upperBody:L.extractedClothing.upperBody||void 0,lowerBody:L.extractedClothing.lowerBody||void 0,shoes:L.extractedClothing.shoes||void 0,fullBody:L.extractedClothing.fullBody||void 0}}:W.clothing;me(Ie=>Ie.map(pe=>pe.id===W.id?{...pe,avatars:U,physical:ce,physicalTraitsSource:De,clothing:K}:pe)),Ce(Ie=>Ie&&Ie.id===W.id?{...Ie,avatars:U,physical:ce,physicalTraitsSource:De,clothing:K}:Ie),me(Ie=>{const pe=Ie.map(Ge=>Ge.id===W.id?{...Ge,avatars:U,physical:ce,physicalTraitsSource:De,clothing:K}:Ge);return Ee.saveCharacterData({characters:pe,relationships:nt,relationshipTexts:Et,customRelationships:mr,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(Ge=>console.error("Failed to save avatar update:",Ge)),pe}),console.log(`[generateStory] âœ… Avatars regenerated for ${W.name}`)}else console.warn(`[generateStory] âš ï¸ Failed to regenerate avatars for ${W.name}: ${L.error}`)}catch(L){console.error(`[generateStory] âŒ Error regenerating avatars for ${W.name}:`,L)}}}kr({current:5,total:100,message:s==="de"?"Starte Generierung...":s==="fr"?"DÃ©marrage de la gÃ©nÃ©ration...":"Starting generation..."});try{const ae=ye.filter(K=>!mt.includes(K.id)),{jobId:W,creditsRemaining:L}=await Be.createStoryJob({storyType:wt,storyTypeName:vs(),storyCategory:Ne||void 0,storyTopic:Me||void 0,storyTheme:Le||void 0,customThemeText:Le==="custom"?Ve:void 0,artStyle:xt,language:ft,languageLevel:dt,pages:Qe,dedication:At,storyDetails:Pt,characters:ae,mainCharacters:pt,relationships:nt,relationshipTexts:Et,skipImages:(a==null?void 0:a.skipImages)??xe,imageGenMode:H,generationMode:ve!=="auto"?ve:void 0,skipOutline:$e,skipText:_e,skipSceneDescriptions:He,skipCovers:Te,enableAutoRepair:We,useGridRepair:jt,forceRepairThreshold:Nt,enableFinalChecks:Qr,checkOnlyMode:ct,enableSceneValidation:Gt,incrementalConsistency:fr?{enabled:!0,dryRun:Pe,lookbackCount:be}:void 0,modelOverrides:(p==null?void 0:p.role)==="admin"||R?{outlineModel:tt.outlineModel,textModel:tt.textModel,sceneDescriptionModel:tt.sceneDescriptionModel,imageModel:tt.imageModel,coverImageModel:tt.coverImageModel,qualityModel:tt.qualityModel}:void 0,userLocation:oe||void 0,season:Wt||void 0,ideaGeneration:Ae&&g&&Q.length>0?{input:Ae,output:Q,rawResponse:S,prompt:g.prompt,model:g.model,selectedIndex:qe}:void 0});zs(W),h.info("Story job created:",W),J(W,vs()||"New Story"),L!=null&&C(L);let U=!1,O=0,ce=Date.now();const De=180*1e3;for(Gr(!1);!U;){await new Promise(Ie=>setTimeout(Ie,2e3));const K=await Be.getJobStatus(W);if(K.progress&&(K.progress.current!==O?(h.debug(`Progress: ${K.progress.current}% - ${K.progress.message||""}`),O=K.progress.current,ce=Date.now(),Gr(!1)):Date.now()-ce>=De&&Gr(!0),kr(Ie=>K.progress.current>=Ie.current?K.progress:K.progress.message?{...Ie,message:K.progress.message}:Ie)),K.partialCovers){let Ie=!1;qt(pe=>{var Xe,it,_s;const Ge={...pe};if((Xe=K.partialCovers)!=null&&Xe.frontCover&&!pe.frontCover){Ge.frontCover=K.partialCovers.frontCover,h.debug("Front cover received during streaming");const Lt=K.partialCovers.frontCover;typeof Lt=="object"&&(Lt!=null&&Lt.storyTitle)&&(xr(Lt.storyTitle),h.debug(`Story title from front cover: ${Lt.storyTitle}`)),Ie=!0}return(it=K.partialCovers)!=null&&it.initialPage&&!pe.initialPage&&(Ge.initialPage=K.partialCovers.initialPage,h.debug("Initial page cover received during streaming")),(_s=K.partialCovers)!=null&&_s.backCover&&!pe.backCover&&(Ge.backCover=K.partialCovers.backCover,h.debug("Back cover received during streaming")),Ge}),Ie&&(h.debug("Transitioning to StoryDisplay - front cover ready"),y(6))}if(K.storyText&&!vt&&(Bs(K.storyText),xr(K.storyText.title),h.debug(`Story text received: ${K.storyText.totalPages} pages ready for display`)),K.partialPages&&K.partialPages.length>0&&Ms(Ie=>{var Xe;const pe={...Ie};let Ge=0;return(Xe=K.partialPages)==null||Xe.forEach(it=>{it.imageData&&!Ie[it.pageNumber]&&(pe[it.pageNumber]=it.imageData,Ge++)}),Ge>0&&h.debug(`${Ge} new page images received (total: ${Object.keys(pe).length})`),pe}),console.log("[StoryWizard] Job status check:",{status:K.status,hasResult:!!K.result,resultKeys:K.result?Object.keys(K.result):[],progress:K.progress}),K.status==="completed"&&K.result)ca(K.result.storyId),xr(K.result.title),za(K.result.outline),Ba(K.result.outlinePrompt||""),Ma(K.result.outlineModelId),La(K.result.outlineUsage),Ga(K.result.storyTextPrompts||[]),ia(K.result.styledAvatarGeneration||[]),oa(K.result.costumedAvatarGeneration||[]),la(K.result.generationLog||[]),Oa(K.result.finalChecksReport||null),K.result.visualBible?_r({mainCharacters:K.result.visualBible.mainCharacters||[],secondaryCharacters:K.result.visualBible.secondaryCharacters||[],animals:K.result.visualBible.animals||[],artifacts:K.result.visualBible.artifacts||[],locations:K.result.visualBible.locations||[],vehicles:K.result.visualBible.vehicles||[],clothing:K.result.visualBible.clothing||[],changeLog:K.result.visualBible.changeLog||[]}):_r(null),K.result.clothingRequirements?Fs(K.result.clothingRequirements):Fs(null),gs(K.result.story),Fa(K.result.story),hs(K.result.sceneDescriptions||[]),Mt(K.result.sceneImages||[]),qt(K.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),Bs(null),Ms({}),U=!0,K.currentCredits!==null&&K.currentCredits!==void 0&&C(K.currentCredits),y(6),h.success("Story generation completed!"),ua({storyCategory:Ne||void 0,storyTopic:Me||void 0,storyTheme:Le||void 0,storyTypeName:vs(),storyDetails:Pt||void 0,artStyle:xt||void 0,language:ft||void 0,languageLevel:dt||void 0,pages:Qe||void 0,dedication:At||void 0,characters:ye.map(Ie=>({id:Ie.id,name:Ie.name})),mainCharacters:pt,relationships:nt,relationshipTexts:Et,season:Wt||void 0,userLocation:oe||void 0}),ga.current=!0,v();else if(K.status==="failed")throw new Error(K.error||"Story generation failed")}kr({current:100,total:100,message:s==="de"?"Fertig!":s==="fr"?"TerminÃ©!":"Complete!"})}catch(ae){h.error("Generation failed:",ae);const W=ae instanceof Error?ae.message:String(ae);if(W.includes("already in progress")){const L=W.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),U=L?L[1]:null,O=s==="de"?"Eine Geschichte wird bereits erstellt. MÃ¶chtest du diese abbrechen und eine neue starten?":s==="fr"?"Une histoire est dÃ©jÃ  en cours de crÃ©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(U&&window.confirm(O))try{await Be.cancelJob(U),h.info("Cancelled existing job:",U),await Pr(a);return}catch(ce){h.error("Failed to cancel existing job:",ce),P(s==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es spÃ¤ter erneut.":s==="fr"?"Ã‰chec de l'annulation. Veuillez rÃ©essayer plus tard.":"Failed to cancel. Please try again later.")}Lr(!1);return}else P(s==="de"?`Generierung fehlgeschlagen: ${W}`:s==="fr"?`Ã‰chec de la gÃ©nÃ©ration: ${W}`:`Generation failed: ${W}`)}finally{Gr(!1),v(),setTimeout(()=>Lr(!1),500)}};o.useEffect(()=>{if(Os.current&&D&&ye.length>0&&B===5&&!Bt){Os.current=!1;const a=localStorage.getItem("verificationGenerationStarted");if(a){const d=parseInt(a,10),k=Date.now()-120*1e3;if(d>k){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await I(),setTimeout(()=>{Pr({skipEmailCheck:!0})},500)})()}},[D,ye,B,Bt,I]);const Ai=()=>{switch(B){case 1:return e.jsx(zo,{characters:ye,currentCharacter:w,characterStep:es,showCharacterCreated:Xr,isLoading:G,isAnalyzingPhoto:Er,isGeneratingAvatar:yr===(w==null?void 0:w.id),isRegeneratingAvatars:Xs,isRegeneratingAvatarsWithTraits:As,developerMode:fe,isImpersonating:R,changedTraits:vr,photoAnalysisDebug:ea,mainCharacters:pt,excludedCharacters:mt,onCharacterRoleChange:ji,onCharacterChange:Ce,onCharacterStepChange:Je,onContinueToAvatar:()=>Je("avatar"),onPhotoSelect:di,onSaveAndGenerateAvatar:xi,onSaveCharacter:va,onEditCharacter:pi,onDeleteCharacter:fi,onStartNewCharacter:ya,onRegenerateAvatars:ui,onRegenerateAvatarsWithTraits:gi,onSaveAndRegenerateWithTraits:hi,onSaveAndTryNewPhoto:async()=>{var d;if(h.info(`ðŸ“¸ onSaveAndTryNewPhoto called, currentCharacter: ${w==null?void 0:w.name}`),!w){h.warn("ðŸ“¸ No currentCharacter, returning early");return}_(!0);try{const k=w.id&&ye.find($=>$.id===w.id),f=k?ye.map($=>$.id===w.id?w:$):[...ye,w],j=!k&&!!((d=w.photos)!=null&&d.original);await Ee.saveCharacterData({characters:f,relationships:nt,relationshipTexts:Et,customRelationships:mr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:j}),me(f),fa(f),h.info(`ðŸ“¸ Setting characterStep to 'photo', currentCharacter still: ${w==null?void 0:w.name}`),Je("photo")}catch(k){h.error("ðŸ“¸ Error saving character:",k)}finally{_(!1),h.info("ðŸ“¸ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:nt,relationshipTexts:Et,onRelationshipChange:bi,onRelationshipTextChange:yi,customRelationships:mr,onAddCustomRelationship:vi});case 2:return e.jsx(Bo,{languageLevel:dt,onLanguageLevelChange:ms,pages:Qe,onPagesChange:wr,storyLanguage:ft,onStoryLanguageChange:Ts,developerMode:fe,userLocation:oe,onLocationChange:yt,season:Wt,onSeasonChange:Ds,userCredits:R?-1:(p==null?void 0:p.credits)??0});case 3:return e.jsx(Mo,{storyCategory:Ne,storyTopic:Me,storyTheme:Le,customThemeText:Ve,onCategoryChange:ri,onTopicChange:ai,onThemeChange:si,onCustomThemeTextChange:Zt,onLegacyStoryTypeChange:Ot});case 4:return e.jsx(Lo,{artStyle:xt,onArtStyleChange:ni});case 5:return e.jsx(Go,{characters:ye,mainCharacters:pt,excludedCharacters:mt,storyCategory:Ne,storyTopic:Me,storyTheme:Le,customThemeText:Ve,onCustomThemeTextChange:Zt,artStyle:xt,storyLanguage:ft,languageLevel:dt,pages:Qe,userLocation:oe,season:Wt,storyDetails:Pt,onStoryDetailsChange:zt,dedication:At,onDedicationChange:gr,onGenerateIdeas:Ya,isGeneratingIdeas:Ht,isGeneratingIdea1:Sr,isGeneratingIdea2:Cr,ideaProgress1:Is,ideaProgress2:$s,ideaPrompt:g,ideaFullResponse:S,generatedIdeas:Q,onSelectIdea:ki,onUseDirectly:()=>Pr(),onEditStep:ar,developerMode:fe,imageGenMode:H,onImageGenModeChange:de,generationMode:ve,onGenerationModeChange:ke});case 6:const a=xs.frontCover||xs.initialPage||Object.keys(ha).length>0||da.some(d=>d.imageData);if(Or&&a||vt&&a||Bt&&a){const d=Or?da:Object.entries(ha).map(([f,j])=>{var $;return{pageNumber:parseInt(f),imageData:j,description:(($=vt==null?void 0:vt.sceneDescriptions.find(z=>z.pageNumber===parseInt(f)))==null?void 0:$.description)||""}}),k=Or||Object.entries((vt==null?void 0:vt.pageTexts)||{}).sort(([f],[j])=>parseInt(f)-parseInt(j)).map(([f,j])=>`--- Page ${f} ---
${j}`).join(`

`);return e.jsxs(e.Fragment,{children:[Vt&&Vt.total>0&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${Vt.loaded/Vt.total*100}%`}})}),e.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:s==="de"?`Bilder: ${Vt.loaded}/${Vt.total}`:s==="fr"?`Images: ${Vt.loaded}/${Vt.total}`:`Images: ${Vt.loaded}/${Vt.total}`})]}),e.jsx(fo,{title:na,dedication:At||void 0,story:k,originalStory:Bn,outline:Mn,outlinePrompt:Ln,outlineModelId:Gn,outlineUsage:On,storyTextPrompts:_n,visualBible:Hn||void 0,sceneImages:d,sceneDescriptions:(vt==null?void 0:vt.sceneDescriptions)||Jn,characters:Yt||ye.filter(f=>!mt.includes(f.id)),progressiveMode:Bt,progressiveData:vt||void 0,completedPageImages:ha,coverImages:xs,regeneratingCovers:Tn,languageLevel:dt,storyLanguage:ft,isGenerating:Bt,developerMode:fe,styledAvatarGeneration:Vn,costumedAvatarGeneration:qn,generationLog:Un,finalChecksReport:Kn,clothingRequirements:Wn||void 0,storyId:je,onVisualBibleChange:je?async f=>{try{h.info("Updating Visual Bible for story:",je),await Be.updateVisualBible(je,f),_r(f),h.success("Visual Bible updated successfully")}catch(j){h.error("Failed to update Visual Bible:",j),P(s==="de"?"Visual Bible konnte nicht aktualisiert werden":s==="fr"?"Ã‰chec de la mise Ã  jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:je?async(f,j,$)=>{var z;try{h.info("Regenerating image for page:",f,j?"(scene edited)":"",$?`(${$.length} characters)`:"");const T=await Be.regenerateImage(je,f,j,$);if(h.info("Regenerate result:",{hasImageData:!!(T!=null&&T.imageData),length:(z=T==null?void 0:T.imageData)==null?void 0:z.length,versionCount:T==null?void 0:T.versionCount,creditsRemaining:T==null?void 0:T.creditsRemaining}),!(T!=null&&T.imageData))throw h.error("No imageData in response!",T),new Error("No image data returned from server");Mt(re=>re.map(Z=>Z.pageNumber===f?{...Z,imageData:T.imageData,description:T.newDescription||Z.description,prompt:T.newPrompt,qualityScore:T.qualityScore,qualityReasoning:T.qualityReasoning,totalAttempts:T.totalAttempts,retryHistory:T.retryHistory,wasRegenerated:!0,originalImage:T.originalImage,originalScore:T.originalScore,originalReasoning:T.originalReasoning,imageVersions:T.imageVersions}:Z)),T.creditsRemaining!==void 0&&C&&C(T.creditsRemaining),h.info("Image regenerated successfully, updated state")}catch(T){h.error("Image regeneration failed:",T);const re=T instanceof Error?T.message:String(T);P(s==="de"?`Bildgenerierung fehlgeschlagen: ${re}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${re}`:`Image regeneration failed: ${re}`)}}:void 0,onDownloadTxt:()=>{const f=new Blob([Or],{type:"text/plain"}),j=URL.createObjectURL(f),$=document.createElement("a");$.href=j,$.download=`${na}.txt`,$.click(),URL.revokeObjectURL(j)},onDownloadPdf:je?async f=>{try{const j=await Be.generatePdf(je,f),$=URL.createObjectURL(j),z=document.createElement("a");z.href=$,z.download=`${na}.pdf`,z.click(),URL.revokeObjectURL($)}catch(j){h.error("PDF download failed:",j),P(s==="de"?"PDF-Download fehlgeschlagen":s==="fr"?"Ã‰chec du tÃ©lÃ©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:je?()=>{try{const f=sessionStorage.getItem("mystories_selected"),j=f?JSON.parse(f):[];j.includes(je)||(j.push(je),sessionStorage.setItem("mystories_selected",JSON.stringify(j))),h.info("Added story to book selection:",je),A(s==="de"?"Geschichte zum Buch hinzugefÃ¼gt. Du kannst weitere hinzufÃ¼gen oder das Buch bestellen.":s==="fr"?"Histoire ajoutÃ©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",s==="de"?"Zum Buch hinzugefÃ¼gt":s==="fr"?"AjoutÃ© au livre":"Added to Book"),r("/stories")}catch(f){h.error("Failed to add story to selection:",f)}}:void 0,onPrintBook:je?async()=>{let f=await eo.getShippingAddress();if(!f){const z=prompt(s==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":s==="fr"?"Aucune adresse enregistrÃ©e. Veuillez entrer (Format: PrÃ©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!z)return;const T=z.split(",").map(re=>re.trim());if(T.length<7){P(s==="de"?"UngÃ¼ltiges Adressformat":s==="fr"?"Format d'adresse invalide":"Invalid address format");return}f={firstName:T[0],lastName:T[1],addressLine1:T[2],postCode:T[3],city:T[4],country:T[5],email:T[6]}}const j=`${f.firstName} ${f.lastName}
${f.addressLine1}
${f.postCode} ${f.city}
${f.country}`,$=s==="de"?`Druckauftrag an folgende Adresse senden?

${j}`:s==="fr"?`Envoyer la commande Ã  cette adresse?

${j}`:`Send print order to this address?

${j}`;if(confirm($))try{h.info("Creating print order for story:",je);const z=await Be.createPrintOrder(je,{firstName:f.firstName,lastName:f.lastName,addressLine1:f.addressLine1,city:f.city,postCode:f.postCode,country:f.country,email:f.email||""}),T=s==="de"?`âœ… Druckauftrag erfolgreich erstellt!

Order ID: ${z.orderId}
${z.isDraft?"(Entwurf - muss in Gelato bestÃ¤tigt werden)":""}

MÃ¶chten Sie das Gelato Dashboard Ã¶ffnen, um den Auftrag zu verfolgen?`:s==="fr"?`âœ… Commande d'impression crÃ©Ã©e avec succÃ¨s!

ID de commande: ${z.orderId}
${z.isDraft?"(Brouillon - doit Ãªtre confirmÃ© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`âœ… Print order created successfully!

Order ID: ${z.orderId}
${z.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;z.dashboardUrl&&confirm(T)?window.open(z.dashboardUrl,"_blank"):z.dashboardUrl||A(s==="de"?`Druckauftrag erstellt! Order ID: ${z.orderId}`:s==="fr"?`Commande crÃ©Ã©e! ID: ${z.orderId}`:`Print order created! Order ID: ${z.orderId}`)}catch(z){h.error("Print order failed:",z);const T=z instanceof Error?z.message:String(z);P(s==="de"?`Druckauftrag fehlgeschlagen: ${T}`:s==="fr"?`Ã‰chec de la commande d'impression: ${T}`:`Print order failed: ${T}`)}}:void 0,onCreateAnother:()=>{h.info("Creating new story - resetting settings"),ca(null),zs(null),Dt(null);const f=new URLSearchParams(l);f.delete("storyId"),i(f,{replace:!0}),gs(""),xr(""),hs([]),Mt([]),qt({frontCover:null,initialPage:null,backCover:null}),_a(!1),Ha(void 0),Wa(void 0),Va(void 0),Ot(""),dr(""),Dr(""),cr(""),lt("watercolor"),ms("standard"),wr(30),gr(""),zt(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),Ce(null),Je("photo"),y(1)},onRegenerateCover:je?async(f,j,$,z,T)=>{const re=f==="front"?"frontCover":f==="back"?"backCover":"initialPage";try{h.info("Regenerating cover:",f,j?`with scene: "${j.substring(0,50)}..."`:"",$?`with ${$.length} characters`:""),Da(X=>new Set(X).add(re));const Z=await Be.regenerateCover(je,f,j,$,z,T);qt(X=>X&&{...X,[f==="front"?"frontCover":f==="back"?"backCover":"initialPage"]:{imageData:Z.imageData,description:Z.description,prompt:Z.prompt,qualityScore:Z.qualityScore,qualityReasoning:Z.qualityReasoning,totalAttempts:Z.totalAttempts,retryHistory:Z.retryHistory,referencePhotos:Z.referencePhotos,wasRegenerated:Z.wasRegenerated,regenerationCount:Z.regenerationCount,previousImage:Z.previousImage,previousScore:Z.previousScore,originalImage:Z.originalImage,originalScore:Z.originalScore,modelId:Z.modelId}}),Z.creditsRemaining!==void 0&&C&&C(Z.creditsRemaining),h.info("Cover regenerated successfully")}catch(Z){h.error("Cover regeneration failed:",Z);const X=Z instanceof Error?Z.message:String(Z);P(s==="de"?`Cover-Generierung fehlgeschlagen: ${X}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${X}`:`Cover regeneration failed: ${X}`)}finally{Da(Z=>{const X=new Set(Z);return X.delete(re),X})}}:void 0,onEditImage:f=>{Gs({type:"image",pageNumber:f}),fs(""),Ls(!0)},onEditCover:f=>{Gs({type:"cover",coverType:f}),fs(""),Ls(!0)},onRepairImage:je&&((p==null?void 0:p.role)==="admin"||R)?async f=>{var j,$,z;try{h.info("Starting auto-repair for page:",f);const T=da.find(X=>X.pageNumber===f);let re=T==null?void 0:T.fixTargets;if(!re||re.length===0){const X=($=(j=T==null?void 0:T.retryHistory)==null?void 0:j.filter(ge=>ge.type==="auto_repair"))==null?void 0:$.slice(-1)[0];(z=X==null?void 0:X.preRepairEval)!=null&&z.fixTargets&&X.preRepairEval.fixTargets.length>0&&(re=X.preRepairEval.fixTargets,h.info(`Using ${re.length} fix targets from retryHistory.preRepairEval`))}re&&re.length>0?h.info(`Using ${re.length} existing fix targets`):h.info("No stored fix targets found, will re-evaluate");const Z=await Be.repairImage(je,f,re);Z.repaired?(Mt(X=>X.map(ge=>ge.pageNumber===f?{...ge,imageData:Z.imageData,wasAutoRepaired:!0,repairHistory:Z.repairHistory,repairedAt:new Date().toISOString()}:ge)),h.info("Auto-repair completed successfully:",{repaired:Z.repaired,repairs:Z.repairHistory.length})):Z.noErrorsFound&&h.info("No physics errors detected in the image")}catch(T){throw h.error("Auto-repair failed:",T),T}}:void 0,onRevertRepair:je&&((p==null?void 0:p.role)==="admin"||R)?async(f,j)=>{try{h.info("Reverting repair for page:",f),Mt($=>$.map(z=>z.pageNumber===f?{...z,imageData:j,wasAutoRepaired:!1}:z)),await Be.updateSceneImage(je,f,j),h.info("Repair reverted successfully")}catch($){throw h.error("Failed to revert repair:",$),$}}:void 0,onSaveStoryText:je?async f=>{try{h.info("Saving story text for story:",je),await Be.saveStoryText(je,f),gs(f),h.info("Story text saved successfully")}catch(j){throw h.error("Failed to save story text:",j),j}}:void 0,onSaveTitleChange:je?async f=>{try{h.info("Saving title for story:",je,f),await Be.saveStoryTitle(je,f),xr(f),h.info("Title saved successfully")}catch(j){throw h.error("Failed to save title:",j),j}}:void 0,userCredits:R?-1:(p==null?void 0:p.credits)||0,imageRegenerationCost:5,isImpersonating:R,onSelectImageVersion:je?async(f,j)=>{try{h.info("Selecting image version:",{pageNumber:f,versionIndex:j});const $=await Be.setActiveImage(je,f,j);Mt(z=>z.map(T=>{if(T.pageNumber===f&&T.imageVersions){const re=T.imageVersions[j];return{...T,imageData:(re==null?void 0:re.imageData)||T.imageData,imageVersions:T.imageVersions.map((Z,X)=>({...Z,isActive:X===j}))}}return T})),h.info("Image version selected:",$)}catch($){throw h.error("Failed to select image version:",$),$}}:void 0,isPartial:Qn,failureReason:Zn,generatedPages:Yn,totalPages:Xn,generationSettings:ei||void 0})]})}return l.get("storyId")?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(et,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):Bt?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:s==="de"?"Geschichte wird erstellt...":s==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:s==="de"?"Einen Moment Geduld bitte":s==="fr"?"Veuillez patienter":"Please wait a moment"})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Kr,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:b.generateStory}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Bereit, deine Geschichte zu erstellen!":s==="fr"?"PrÃªt Ã  crÃ©er votre histoire!":"Ready to create your story!"}),e.jsxs(Js,{onClick:()=>Pr(),size:"lg",icon:Kr,children:[b.generateStory," (",Qe*10," Credits)"]})]});default:return null}};return D?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Ei,{currentStep:B,onStepClick:ar,canAccessStep:wi,developerMode:fe,onDeveloperModeChange:M,hideSteps:B===6&&!!je,onShowGenerationProgress:()=>{Rs(!1),y(6)}}),e.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:e.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[G&&!Bt?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(et,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:N?s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story...":s==="de"?"Wird geladen...":s==="fr"?"Chargement...":"Loading..."}),N&&e.jsxs("div",{className:"w-64 mt-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:N.total?`${Math.min(100,N.loaded/N.total*100)}%`:"100%"}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[(N.loaded/(1024*1024)).toFixed(1)," MB",N.total&&e.jsxs("span",{children:[" (",Math.round(N.loaded/N.total*100),"%)"]})]})]})]}):e.jsxs(e.Fragment,{children:[B>=1&&B<=5&&!w&&e.jsx(no,{step:B,text:(Nn[s]||Nn.en)[B]}),e.jsx(o.Suspense,{fallback:e.jsx(en,{}),children:Ai()})]}),B<6&&!w&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[B===1&&ye.length>=2&&!ii()&&(()=>{const a=oi();if(!a)return null;const x=s==="de"?`${a.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:s==="fr"?`${a.name} a des relations non dÃ©finies ("ne connaÃ®t pas")`:`${a.name} has undefined relationships ("not known to")`;return e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"âš ï¸"}),e.jsx("p",{className:"text-amber-700 text-sm",children:x})]})})(),B!==5&&e.jsxs("div",{className:`flex ${B===1?"justify-end":"justify-between"}`,children:[B>1&&e.jsxs("button",{onClick:Za,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(ln,{size:20})," ",b.back]}),e.jsxs("button",{onClick:Ci,disabled:!Ar(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${Ar()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[b.next," ",e.jsx(_i,{size:20})]})]}),B===5&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:()=>Pr(),disabled:!Ar(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Ar()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Kr,{size:20})," ",b.generateStory," (",Qe*10," Credits)"]}),fe&&e.jsxs("button",{onClick:()=>Pr({skipImages:!0}),disabled:!Ar(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Ar()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Kr,{size:20}),s==="de"?"Nur Text generieren (ohne Bilder)":s==="fr"?"GÃ©nÃ©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),fe&&e.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["ðŸ› ï¸ ",s==="de"?"Entwickler-Optionen - Schritte Ã¼berspringen":s==="fr"?"Options dÃ©veloppeur - Sauter des Ã©tapes":"Developer Options - Skip Steps"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:$e,onChange:a=>Y(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Gliederung Ã¼berspringen":s==="fr"?"Sauter le plan":"Skip outline generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_e,onChange:a=>Se(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Text Ã¼berspringen":s==="fr"?"Sauter le texte":"Skip text generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:He,onChange:a=>he(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenenbeschreibungen Ã¼berspringen":s==="fr"?"Sauter les descriptions de scÃ¨nes":"Skip scene descriptions"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:xe,onChange:a=>V(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Bilder Ã¼berspringen":s==="fr"?"Sauter les images":"Skip image generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Te,onChange:a=>st(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Cover Ã¼berspringen":s==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2",children:s==="de"?"Hinweis: Ãœbersprungene Schritte verwenden Platzhalter/leere Daten":s==="fr"?"Note: Les Ã©tapes sautÃ©es utiliseront des donnÃ©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["ðŸ”§ ",s==="de"?"Feature-Optionen":s==="fr"?"Options de fonctionnalitÃ©s":"Feature Options"]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:We,onChange:a=>ht(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Auto-Reparatur aktivieren":s==="fr"?"Activer la rÃ©paration auto":"Enable auto-repair"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":s==="fr"?"Essaie de corriger automatiquement les erreurs d'image dÃ©tectÃ©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),We&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:jt,onChange:a=>lr(a.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Grid-Reparatur verwenden":s==="fr"?"Utiliser la rÃ©paration en grille":"Use grid repair"})]}),We&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":s==="fr"?"Extrait les rÃ©gions problÃ©matiques dans une grille, rÃ©pare avec Gemini, vÃ©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),We&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:s==="de"?"Reparatur-Schwelle:":s==="fr"?"Seuil de rÃ©paration:":"Force repair threshold:"}),e.jsxs("select",{value:Nt===null?"default":Nt,onChange:a=>Ys(a.target.value==="default"?null:parseInt(a.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"default",children:s==="de"?"Standard (nur bei Fehler)":s==="fr"?"DÃ©faut (seulement si erreur)":"Default (only on failure)"}),e.jsx("option",{value:"100",children:s==="de"?"100% (immer reparieren)":s==="fr"?"100% (toujours rÃ©parer)":"100% (always repair)"}),e.jsx("option",{value:"90",children:"90%"}),e.jsx("option",{value:"80",children:"80%"}),e.jsx("option",{value:"75",children:"75%"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die QualitÃ¤tsprÃ¼fung bestehen":s==="fr"?"Ã€ 100%, toutes les pages avec des problÃ¨mes sont rÃ©parÃ©es, mÃªme si elles passent le contrÃ´le qualitÃ©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Qr,onChange:a=>Cs(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"KonsistenzprÃ¼fung aktivieren":s==="fr"?"Activer la vÃ©rification de cohÃ©rence":"Enable final checks"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft Bilder und Text auf Konsistenz am Ende der Generierung":s==="fr"?"VÃ©rifie la cohÃ©rence des images et du texte Ã  la fin de la gÃ©nÃ©ration":"Checks images and text for consistency at end of generation"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Gt,onChange:a=>br(a.target.checked),className:"rounded border-cyan-300 text-cyan-600 focus:ring-cyan-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenen-Validierung":s==="fr"?"Validation de scÃ¨ne":"Scene validation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt gÃ¼nstige Vorschau, prÃ¼ft Geometrie, repariert Kompositionsprobleme":s==="fr"?"GÃ©nÃ¨re un aperÃ§u Ã©conomique, vÃ©rifie la gÃ©omÃ©trie, rÃ©pare les problÃ¨mes de composition":"Generates cheap preview, checks geometry, repairs composition issues"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:fr,onChange:a=>n(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Inkrementelle Konsistenz":s==="fr"?"CohÃ©rence incrÃ©mentielle":"Incremental consistency"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft jedes Bild gegen vorherige Bilder wÃ¤hrend der Generierung":s==="fr"?"VÃ©rifie chaque image par rapport aux images prÃ©cÃ©dentes pendant la gÃ©nÃ©ration":"Checks each image against previous images during generation"}),fr&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:Pe,onChange:a=>at(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur Protokoll (Dry Run)":s==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),fr&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Zeigt nur an, was repariert wÃ¼rde, ohne tatsÃ¤chlich zu reparieren":s==="fr"?"Affiche uniquement ce qui serait rÃ©parÃ© sans effectuer de rÃ©parations":"Shows what would be fixed without actually fixing"}),fr&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-700 text-sm",children:s==="de"?"Vergleichsfenster:":s==="fr"?"FenÃªtre de comparaison:":"Lookback window:"}),e.jsx("input",{type:"range",min:"1",max:"5",value:be,onChange:a=>Zr(parseInt(a.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),e.jsx("span",{className:"text-gray-600 font-medium w-4",children:be})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?`Vergleicht jedes Bild mit den ${be} vorherigen`:s==="fr"?`Compare chaque image avec les ${be} prÃ©cÃ©dentes`:`Compares each image with the previous ${be}`})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[e.jsx("input",{type:"checkbox",checked:ct,onChange:a=>Jt(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur PrÃ¼fung (keine Regenerierung)":s==="fr"?"VÃ©rification seule (pas de rÃ©gÃ©nÃ©ration)":"Check only (no regeneration)"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"FÃ¼hrt alle QualitÃ¤tsprÃ¼fungen durch, Ã¼berspringt aber Regenerierung/Reparatur":s==="fr"?"ExÃ©cute toutes les vÃ©rifications de qualitÃ© mais ignore la rÃ©gÃ©nÃ©ration/rÃ©paration":"Runs all quality checks but skips regeneration/repair"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Qt,onChange:a=>$r(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Alle Avatare laden":s==="fr"?"Charger tous les avatars":"Load all avatars"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"LÃ¤dt alle Avatar-Varianten (30MB+). NÃ¼tzlich zum Debuggen.":s==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le dÃ©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),fe&&((p==null?void 0:p.role)==="admin"||R)&&e.jsx(jo,{selections:tt,onChange:ks}),e.jsxs("button",{onClick:Za,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(ln,{size:20})," ",b.back]})]})]})]})}),Bt&&!Or&&!vt&&!xs.frontCover&&!$n&&e.jsx(io,{current:aa.current,total:aa.total,message:aa.message,coverImages:xs,characters:ye,jobId:ma||void 0,isStalled:zn,onDismissStalled:()=>Gr(!1),isImpersonating:R,onMinimize:()=>ra(!0),onCancel:ma?async()=>{try{await Be.cancelJob(ma),h.info("Job cancelled by user"),Lr(!1),zs(null),Gr(!1),kr({current:0,total:0,message:""}),F(s==="de"?"Generierung abgebrochen":s==="fr"?"GÃ©nÃ©ration annulÃ©e":"Generation cancelled")}catch(a){h.error("Failed to cancel job:",a),P(s==="de"?"Abbruch fehlgeschlagen":s==="fr"?"Ã‰chec de l'annulation":"Failed to cancel")}}:void 0}),Dn&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Geschichte wird im Hintergrund generiert":s==="fr"?"Histoire en cours de gÃ©nÃ©ration":"Story generating in background"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Was mÃ¶chtest du tun?":s==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{Rs(!0),ra(!1),r("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Neue Geschichte erstellen":s==="fr"?"CrÃ©er une autre histoire":"Create another story"}),En&&e.jsx("button",{onClick:()=>{Rs(!0),ra(!1),r("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Meine Geschichten lesen":s==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),Rn&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Nur ein Charakter":s==="fr"?"Un seul personnage":"Only One Character"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":s==="fr"?"Les histoires sont plus intÃ©ressantes avec plusieurs personnages. Vous n'avez crÃ©Ã© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{sa(!1),ya()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Weiteren Charakter erstellen":s==="fr"?"CrÃ©er un autre personnage":"Create another character"}),e.jsx("button",{onClick:async()=>{sa(!1),await ar(B+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Trotzdem weiter":s==="fr"?"Continuer quand mÃªme":"Continue anyway"})]})]})}),In&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[e.jsx("div",{className:"relative inline-block mb-4",children:e.jsx(et,{size:40,className:"animate-spin text-indigo-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s==="de"?"Bild wird erstellt...":s==="fr"?"CrÃ©ation de l'image...":"Generating image..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:s==="de"?"Dies dauert etwa 30 Sekunden":s==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),ti&&Ye&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:s==="de"?"Bild bearbeiten":s==="fr"?"Modifier l'image":"Edit Image"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:Ye.type==="image"?s==="de"?`Seite ${Ye.pageNumber}`:s==="fr"?`Page ${Ye.pageNumber}`:`Page ${Ye.pageNumber}`:s==="de"?Ye.coverType==="front"?"Titelseite":Ye.coverType==="back"?"RÃ¼ckseite":"Einleitungsseite":s==="fr"?Ye.coverType==="front"?"Couverture":Ye.coverType==="back"?"Dos":"Page de dÃ©dicace":Ye.coverType==="front"?"Front Cover":Ye.coverType==="back"?"Back Cover":"Dedication Page"}),e.jsx("textarea",{value:ps,onChange:a=>fs(a.target.value),placeholder:s==="de"?`Beschreibe die gewÃ¼nschte Ã„nderung...
z.B. "Mach den Himmel blauer" oder "FÃ¼ge einen Schmetterling hinzu"`:s==="fr"?`DÃ©crivez le changement souhaitÃ©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{onClick:()=>{Ls(!1),Gs(null),fs("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:s==="de"?"Abbrechen":s==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:async()=>{if(!(!ps.trim()||!je)){Ls(!1),Ra(!0);try{if(Ye.type==="image"&&Ye.pageNumber){const a=await Be.editImage(je,Ye.pageNumber,ps);if(h.info("Edit result:",{hasImageData:!!(a!=null&&a.imageData),score:a==null?void 0:a.qualityScore}),!(a!=null&&a.imageData))throw h.error("No imageData in edit response!",a),new Error("No image data returned from server");Mt(x=>x.map(d=>d.pageNumber===Ye.pageNumber?{...d,imageData:a.imageData,qualityScore:a.qualityScore,qualityReasoning:a.qualityReasoning,wasEdited:!0,originalImage:a.originalImage,originalScore:a.originalScore,originalReasoning:a.originalReasoning}:d)),h.info("Image edited successfully, updated state with quality info")}else if(Ye.type==="cover"&&Ye.coverType){const a=await Be.editCover(je,Ye.coverType,ps);qt(x=>{if(!x)return x;const d=Ye.coverType==="front"?"frontCover":Ye.coverType==="back"?"backCover":"initialPage",k=x[d],f={...typeof k=="object"?k:{},imageData:a.imageData,qualityScore:a.qualityScore,qualityReasoning:a.qualityReasoning,wasEdited:!0,originalImage:a.originalImage,originalScore:a.originalScore,originalReasoning:a.originalReasoning};return{...x,[d]:f}}),h.info("Cover edited successfully with quality info")}}catch(a){h.error("Edit failed:",a),P(s==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de la modification. Veuillez rÃ©essayer.":"Edit failed. Please try again.")}finally{Ra(!1),Gs(null),fs("")}}},disabled:!ps.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:s==="de"?"Bearbeiten":s==="fr"?"Modifier":"Edit"})]})]})}),e.jsx(To,{isOpen:ta,faces:_t,onSelect:ci,onUploadNew:mi,developerMode:fe}),e.jsx(Co,{isOpen:Fn,onClose:()=>Es(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const a=localStorage.getItem("verificationGenerationStarted");if(a){const x=parseInt(a,10),d=Date.now()-120*1e3;if(x>d){console.log("[EmailVerification] Another window started recently, skipping"),Es(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),Pr({skipEmailCheck:!0}),Es(!1)}})]}):e.jsx(en,{fullScreen:!0})}const pl=Object.freeze(Object.defineProperty({__proto__:null,default:Oo},Symbol.toStringTag,{value:"Module"}));export{lo as I,Yi as S,Xi as U,Vr as a,kn as b,Ee as c,ol as d,ul as e,Ao as f,ko as g,gl as h,fn as i,cl as j,hl as k,dl as l,ml as m,xl as n,yn as o,vn as p,ll as q,$a as r,il as s,jn as t,nl as u,Aa as v,pl as w};
