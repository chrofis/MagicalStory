const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WizardStep2Characters-fZ81qkoc.js","assets/index-CnblZ_0r.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-CErl-XGl.css","assets/Input-DUQA-0RG.js","assets/Textarea-thHAEXc0.js","assets/sparkles-Drpfyv2H.js","assets/book-open-C158aA6D.js","assets/check-C3eu9waY.js","assets/pen-iWgyRlt6.js","assets/trash-2-C0fE1y0D.js","assets/Modal-Ch3z2gvl.js","assets/download-B4IeXOgB.js","assets/chevron-right-DVvPdHoC.js","assets/arrow-right-CqucND7m.js","assets/camera-C3KFuXz3.js","assets/pencil-C_0GTQRE.js","assets/circle-x-BjXpt07U.js","assets/clock-BA0-FNoP.js","assets/palette-Dv7-8698.js","assets/book-tysP6VS5.js","assets/shopping-cart-B-ctIKBG.js","assets/arrow-left-D0an8Tlb.js","assets/WizardStep4StoryType-SfqxNJhe.js","assets/WizardStep5ArtStyle-Czf3x7pR.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-B3yYkLL0.js"])))=>i.map(i=>d[i]);
import{c as ot,b as Ve,d as dn,j as e,X as zt,u as ir,a as cn,L as Ye,T as Kn,C as Sn,s as Fe,E as Ei,e as Fi,f as zi,g as Cn,_ as Qs}from"./index-CnblZ_0r.js";import{b as l,u as Bi,e as Mi}from"./vendor-react-CqfXSjHo.js";import{U as mn,B as Ma,I as kn}from"./Input-DUQA-0RG.js";import{S as Li,A as An,N as Oi}from"./Textarea-thHAEXc0.js";import{C as Gi}from"./circle-x-BjXpt07U.js";import{C as _i}from"./clock-BA0-FNoP.js";import{M as Jn,H as Hi,C as Pn,R as nr,F as ys,P as $n,a as tn,I as In,b as Vi}from"./Modal-Ch3z2gvl.js";import{D as Xr,C as Sr}from"./download-B4IeXOgB.js";import{C as nn}from"./chevron-right-DVvPdHoC.js";import{P as Qn}from"./palette-Dv7-8698.js";import{B as Wi}from"./book-tysP6VS5.js";import{C as qi}from"./check-C3eu9waY.js";import{S as Tn}from"./shopping-cart-B-ctIKBG.js";import{B as La}from"./book-open-C158aA6D.js";import{S as js}from"./sparkles-Drpfyv2H.js";import{A as Dn}from"./arrow-left-D0an8Tlb.js";import{A as Ui}from"./arrow-right-CqucND7m.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ki=ot("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ji=ot("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qi=ot("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Br=ot("Images",[["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"m22 13-1.296-1.296a2.41 2.41 0 0 0-3.408 0L11 18",key:"nf6bnh"}],["circle",{cx:"12",cy:"8",r:"2",key:"1822b1"}],["rect",{width:"16",height:"16",x:"6",y:"2",rx:"2",key:"12espp"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zi=ot("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yi=ot("Link2Off",[["path",{d:"M9 17H7A5 5 0 0 1 7 7",key:"10o201"}],["path",{d:"M15 7h2a5 5 0 0 1 4 8",key:"1d3206"}],["line",{x1:"8",x2:"12",y1:"12",y2:"12",key:"rvw6j4"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xi=ot("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yr=ot("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eo=ot("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const to=ot("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ct=ot("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fs=ot("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ro=ot("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rn=ot("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const so=ot("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ao=ot("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rn=ot("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bs=ot("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]),no={async login(r,i){const o=await Ve.post("/api/auth/login",{username:r,password:i},{skipAuth:!0}),h={id:o.user.id,username:o.user.username,email:o.user.email,role:o.user.role,credits:o.user.credits};return{token:o.token,user:h}},async register(r,i,o){return Ve.post("/api/auth/register",{username:r,password:i,email:o},{skipAuth:!0})},async loginWithFirebase(r){const i=await Ve.post("/api/auth/firebase",{idToken:r},{skipAuth:!0}),o={id:i.user.id,username:i.user.username,email:i.user.email,role:i.user.role,credits:i.user.credits};return{token:i.token,user:o}},async getQuota(){const r=await Ve.get("/api/user/quota");return{storyQuota:r.storyQuota,storiesGenerated:r.storiesGenerated,remaining:r.remaining}},async getCredits(){const r=await Ve.get("/api/user/quota");return{credits:r.credits,unlimited:r.unlimited}},async updateEmail(r){await Ve.put("/api/user/update-email",{email:r})},async getShippingAddress(){try{return await Ve.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(r){await Ve.put("/api/user/shipping-address",r)}},ge=dn("CharacterService");function Zn(r){if(!r)return;const i=parseInt(r,10);if(!(isNaN(i)||i<0))return i<=1?"infant":i<=2?"toddler":i<=4?"preschooler":i<=6?"kindergartner":i<=8?"young-school-age":i<=10?"school-age":i<=12?"preteen":i<=14?"young-teen":i<=17?"teenager":i<=25?"young-adult":i<=39?"adult":i<=59?"middle-aged":i<=75?"senior":"elderly"}function sn(r){const i={height:r.height,build:r.build,face:r.other_features||r.otherFeatures,eyeColor:r.eye_color||r.eyeColor,hairColor:r.hair_color||r.hairColor,hairLength:r.hair_length||r.hairLength,hairStyle:r.hair_style||r.hairStyle,facialHair:r.facial_hair||r.facialHair,skinTone:r.skin_tone||r.skinTone,skinUndertone:r.skin_undertone||r.skinUndertone,skinToneHex:r.skin_tone_hex||r.skinToneHex,hair:r.hair_color||r.hairColor,other:r.other,detailedHairAnalysis:r.detailed_hair_analysis||r.detailedHairAnalysis,apparentAge:r.apparent_age||r.apparentAge},o=r.age_category||r.ageCategory||Zn(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,ageCategory:o,physical:i.height||i.build||i.face||i.eyeColor||i.hairColor||i.hairLength||i.hairStyle||i.facialHair||i.skinTone||i.hair||i.other||i.detailedHairAnalysis||i.apparentAge?i:void 0,physicalTraitsSource:r.physical_traits_source||r.physicalTraitsSource,traits:{strengths:r.strengths||[],flaws:r.flaws||r.weaknesses||[],challenges:r.challenges||r.fears||[],specialDetails:r.special_details||r.specialDetails},photos:{original:r.photo_url||r.photoUrl,face:r.thumbnail_url||r.thumbnailUrl,body:r.body_photo_url||r.bodyPhotoUrl,bodyNoBg:r.body_no_bg_url||r.bodyNoBgUrl,faceBox:r.face_box||r.faceBox,bodyBox:r.body_box||r.bodyBox},avatars:r.avatars||r.clothing_avatars||r.clothingAvatars,clothing:r.clothing||r.structured_clothing||r.structuredClothing?{current:r.clothing,structured:r.structured_clothing||r.structuredClothing}:void 0,generatedOutfits:r.generated_outfits||r.generatedOutfits,storyRole:r.storyRole}}function En(r){var o,h,s,R,p,A,T,W,y,I,M,D,X,j,g,F,de,z,v,C,H,O,K,E;const i=r.ageCategory||Zn(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,age_category:i,apparent_age:(o=r.physical)==null?void 0:o.apparentAge,height:(h=r.physical)==null?void 0:h.height,build:(s=r.physical)==null?void 0:s.build,eye_color:(R=r.physical)==null?void 0:R.eyeColor,hair_color:(p=r.physical)==null?void 0:p.hairColor,hair_length:(A=r.physical)==null?void 0:A.hairLength,hair_style:(T=r.physical)==null?void 0:T.hairStyle,facial_hair:(W=r.physical)==null?void 0:W.facialHair,skin_tone:(y=r.physical)==null?void 0:y.skinTone,skin_undertone:(I=r.physical)==null?void 0:I.skinUndertone,skin_tone_hex:(M=r.physical)==null?void 0:M.skinToneHex,other_features:(D=r.physical)==null?void 0:D.face,other:(X=r.physical)==null?void 0:X.other,detailed_hair_analysis:(j=r.physical)==null?void 0:j.detailedHairAnalysis,physical_traits_source:r.physicalTraitsSource,face_box:(g=r.photos)==null?void 0:g.faceBox,body_box:(F=r.photos)==null?void 0:F.bodyBox,strengths:(de=r.traits)==null?void 0:de.strengths,flaws:(z=r.traits)==null?void 0:z.flaws,challenges:(v=r.traits)==null?void 0:v.challenges,special_details:(C=r.traits)==null?void 0:C.specialDetails,weaknesses:(H=r.traits)==null?void 0:H.flaws,fears:(O=r.traits)==null?void 0:O.challenges,clothing:(K=r.clothing)==null?void 0:K.current,structured_clothing:(E=r.clothing)==null?void 0:E.structured,generated_outfits:r.generatedOutfits,storyRole:r.storyRole}}function io(r){return!r||r.length===0?[]:typeof r[0]=="string"?r.map(i=>({forward:i,inverse:i})):r}const ze={async getCharacters(r=!1){const i=r?"/api/characters?includeAllAvatars=true":"/api/characters";return((await Ve.get(i)).characters||[]).map(sn)},async getCharacterData(r=!1){const i=r?"/api/characters?includeAllAvatars=true":"/api/characters",o=await Ve.get(i);return{characters:(o.characters||[]).map(sn),relationships:o.relationships||{},relationshipTexts:o.relationshipTexts||{},customRelationships:io(o.customRelationships),customStrengths:o.customStrengths||[],customWeaknesses:o.customWeaknesses||[],customFears:o.customFears||[]}},async saveCharacters(r){await Ve.post("/api/characters",{characters:r.map(En)})},async saveCharacterData(r,i){const o=s=>{var p,A,T,W;const R=En(s);return i!=null&&i.includePhotos&&(R.photo_url=(p=s.photos)==null?void 0:p.original,R.thumbnail_url=(A=s.photos)==null?void 0:A.face,R.body_photo_url=(T=s.photos)==null?void 0:T.body,R.body_no_bg_url=(W=s.photos)==null?void 0:W.bodyNoBg),R},h={characters:r.characters.map(o),relationships:r.relationships,relationshipTexts:r.relationshipTexts,customRelationships:r.customRelationships,customStrengths:r.customStrengths,customWeaknesses:r.customWeaknesses,customFears:r.customFears};await Ve.post("/api/characters",h)},async deleteCharacter(r){try{const i=await Ve.delete(`/api/characters/${r}`);return ge.success(`Deleted character ${r}: ${i.message}`),{success:!0}}catch(i){return ge.error(`Failed to delete character ${r}:`,i),{success:!1,error:String(i)}}},async saveCharacterRoles(r){try{return await Ve.put("/api/characters/roles",{roles:r}),ge.success(`Saved character roles: ${Object.keys(r).length} characters`),{success:!0}}catch(i){return ge.error("Failed to save character roles:",i),{success:!1,error:String(i)}}},async loadCharacterAvatars(r){try{const i=await Ve.get(`/api/characters/${r}/avatars`);return ge.info(`Loaded full avatars for character ${r}`),i.avatars||null}catch(i){return ge.error(`Failed to load avatars for character ${r}:`,i),null}},async loadFullCharacter(r){try{const i=await Ve.get(`/api/characters/${r}/full`);return i.character?(ge.info(`Loaded full data for character ${r}`),sn(i.character)):null}catch(i){return ge.error(`Failed to load full data for character ${r}:`,i),null}},async generateAvatarOptions(r,i){try{return await Ve.post("/api/generate-avatar-options",{facePhoto:r,gender:i,category:"standard"})}catch(o){const h=o instanceof Error?o.message:"Unknown error";return{success:!1,options:[],error:h}}},async generateClothingAvatars(r,i){var o,h,s,R,p,A,T,W,y,I,M;try{const D=parseInt(r.age)||10,X=r.gender||"child";let j;X==="male"?j=D>=18?"man":"boy":X==="female"?j=D>=18?"woman":"girl":j=D>=18?"person":"child";let F=`${((o=r.name)==null?void 0:o.trim())||`This ${j}`} is a ${D}-year-old ${j}`;r.physical&&(r.physical.hair&&(F+=`, ${r.physical.hair}`),r.physical.face&&(F+=`, ${r.physical.face}`),r.physical.build&&(F+=`, ${r.physical.build}`),r.physical.other&&(F+=`, ${r.physical.other}`));const de=((h=r.photos)==null?void 0:h.bodyNoBg)||((s=r.photos)==null?void 0:s.body)||((R=r.photos)==null?void 0:R.face)||((p=r.photos)==null?void 0:p.original);ge.info(`ðŸŽ¨ Generating clothing avatars for ${r.name||"unnamed"} (id: ${r.id})`);const z=await Ve.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:de,physicalDescription:F,name:r.name,age:r.age,apparentAge:(A=r.physical)==null?void 0:A.apparentAge,gender:r.gender,build:(T=r.physical)==null?void 0:T.build,clothing:(W=r.clothing)==null?void 0:W.structured,avatarModel:i==null?void 0:i.avatarModel});if(z.async&&z.jobId){ge.info(`Avatar job started: ${z.jobId}, polling for completion...`);const C=60,H=2e3;for(let O=0;O<C;O++){await new Promise(E=>setTimeout(E,H));const K=await Ve.get(`/api/avatar-jobs/${z.jobId}`);if(K.status==="complete"&&K.clothingAvatars){ge.success(`Avatar job ${z.jobId} completed after ${(O+1)*2}s`);const E=K.clothingAvatars.extractedTraits,ie=(y=K.clothingAvatars.structuredClothing)==null?void 0:y.standard;return ge.info(`ðŸ” [DEBUG] extractedTraits: ${(I=JSON.stringify(E))==null?void 0:I.substring(0,100)}`),ge.info(`ðŸ” [DEBUG] extractedClothing: ${JSON.stringify(ie)}`),ge.info(`ðŸ” [DEBUG] structuredClothing keys: ${Object.keys(K.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:K.clothingAvatars,extractedTraits:E,extractedClothing:ie}}if(K.status==="failed")return ge.error(`Avatar job failed: ${K.error}`),{success:!1,error:K.error};O%5===0&&ge.info(`Avatar job ${z.jobId}: ${K.message||K.status} (${K.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const v=z;if(v.success&&v.clothingAvatars){ge.success(`Clothing avatars generated for ${r.name}`);const C=v.clothingAvatars.extractedTraits,H=(M=v.clothingAvatars.structuredClothing)==null?void 0:M.standard;return C&&ge.info(`Extracted traits: ${JSON.stringify(C)}`),H&&ge.info(`Extracted clothing: ${JSON.stringify(H)}`),{success:!0,avatars:v.clothingAvatars,extractedTraits:C,extractedClothing:H}}else return ge.error(`Failed to generate avatars: ${v.error}`),{success:!1,error:v.error}}catch(D){return ge.error("Clothing avatar generation failed:",D),{success:!1,error:String(D)}}},async generateClothingAvatarsWithTraits(r){var i,o,h,s,R,p,A,T,W,y,I,M,D,X,j,g,F,de;try{const z=parseInt(r.age)||10,v=r.gender||"child";let C;v==="male"?C=z>=18?"man":"boy":v==="female"?C=z>=18?"woman":"girl":C=z>=18?"person":"child";let O=`${((i=r.name)==null?void 0:i.trim())||`This ${C}`} is a ${z}-year-old ${C}`;r.physical&&(r.physical.hair&&(O+=`, ${r.physical.hair}`),r.physical.face&&(O+=`, ${r.physical.face}`),r.physical.build&&(O+=`, ${r.physical.build}`),r.physical.other&&(O+=`, ${r.physical.other}`));const K=((o=r.photos)==null?void 0:o.bodyNoBg)||((h=r.photos)==null?void 0:h.body)||((s=r.photos)==null?void 0:s.face)||((R=r.photos)==null?void 0:R.original),E=(p=r.photos)!=null&&p.bodyNoBg?"bodyNoBg":(A=r.photos)!=null&&A.body?"body":(T=r.photos)!=null&&T.face?"face":"original",ie=K?Math.round(K.length/1024):0,ee=K==null?void 0:K.startsWith("data:image/png");ge.info(`ðŸŽ¨ Generating clothing avatars WITH TRAITS for ${r.name} (id: ${r.id})`),ge.info(`ðŸ“¸ Photo source: ${E}, size: ${ie}KB, format: ${ee?"PNG":"JPEG"}`),ge.info(`ðŸ“¸ Available photos: bodyNoBg=${!!((W=r.photos)!=null&&W.bodyNoBg)}, body=${!!((y=r.photos)!=null&&y.body)}, face=${!!((I=r.photos)!=null&&I.face)}, original=${!!((M=r.photos)!=null&&M.original)}`),ge.info(`Physical traits: ${JSON.stringify(r.physical)}`);const ve=r.physicalTraitsSource||{};ge.info(`Physical traits source: ${JSON.stringify(ve)}`),ge.info(`Physical skinTone value: '${(D=r.physical)==null?void 0:D.skinTone}', source: '${ve.skinTone}'`),ge.info(`Physical hairStyle value: '${(X=r.physical)==null?void 0:X.hairStyle}', source: '${ve.hairStyle}'`);const ye={};r.physical&&(ve.eyeColor==="user"&&r.physical.eyeColor&&(ye.eyeColor=r.physical.eyeColor),ve.hairColor==="user"&&r.physical.hairColor&&(ye.hairColor=r.physical.hairColor),ve.hairLength==="user"&&r.physical.hairLength&&(ye.hairLength=r.physical.hairLength),ve.hairStyle==="user"&&r.physical.hairStyle&&(ye.hairStyle=r.physical.hairStyle),ve.build==="user"&&r.physical.build&&(ye.build=r.physical.build),ve.skinTone==="user"&&r.physical.skinTone&&(ye.skinTone=r.physical.skinTone,r.physical.skinToneHex&&(ye.skinToneHex=r.physical.skinToneHex)),ve.face==="user"&&r.physical.face&&(ye.face=r.physical.face),ve.facialHair==="user"&&r.physical.facialHair&&(ye.facialHair=r.physical.facialHair),ve.other==="user"&&r.physical.other&&(ye.other=r.physical.other));const B=Object.keys(ye).length>0;ge.info(`Physical traits to send (user-edited only): ${B?JSON.stringify(ye):"none"}`);const xe=r.clothingSource||{},De={};(j=r.clothing)!=null&&j.structured&&(xe.upperBody==="user"&&r.clothing.structured.upperBody&&(De.upperBody=r.clothing.structured.upperBody),xe.lowerBody==="user"&&r.clothing.structured.lowerBody&&(De.lowerBody=r.clothing.structured.lowerBody),xe.shoes==="user"&&r.clothing.structured.shoes&&(De.shoes=r.clothing.structured.shoes),xe.fullBody==="user"&&r.clothing.structured.fullBody&&(De.fullBody=r.clothing.structured.fullBody));const _e=Object.keys(De).length>0;ge.info(`Clothing to send (user-edited only): ${_e?JSON.stringify(De):"none"}`);const Se=await Ve.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:K,physicalDescription:O,name:r.name,age:r.age,apparentAge:(g=r.physical)==null?void 0:g.apparentAge,gender:r.gender,build:ye.build||"average",physicalTraits:B?ye:void 0,clothing:_e?De:void 0});if(Se.async&&Se.jobId){ge.info(`Avatar job started: ${Se.jobId}, polling for completion...`);const U=60,Ne=2e3;for(let Qe=0;Qe<U;Qe++){await new Promise(he=>setTimeout(he,Ne));const pe=await Ve.get(`/api/avatar-jobs/${Se.jobId}`);if(pe.status==="complete"&&pe.clothingAvatars){ge.success(`Avatar job ${Se.jobId} completed after ${(Qe+1)*2}s`);const he=pe.clothingAvatars.extractedTraits,q=(F=pe.clothingAvatars.structuredClothing)==null?void 0:F.standard;return{success:!0,avatars:pe.clothingAvatars,extractedTraits:he,extractedClothing:q}}if(pe.status==="failed")return ge.error(`Avatar job failed: ${pe.error}`),{success:!1,error:pe.error};Qe%5===0&&ge.info(`Avatar job ${Se.jobId}: ${pe.message||pe.status} (${pe.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(Se.success&&Se.clothingAvatars){ge.success(`Clothing avatars WITH TRAITS generated for ${r.name}`);const U=Se.clothingAvatars.extractedTraits,Ne=(de=Se.clothingAvatars.structuredClothing)==null?void 0:de.standard;return{success:!0,avatars:Se.clothingAvatars,extractedTraits:U,extractedClothing:Ne}}else return ge.error(`Failed to generate avatars with traits: ${Se.error}`),{success:!1,error:Se.error}}catch(z){return ge.error("Clothing avatar generation with traits failed:",z),{success:!1,error:String(z)}}},async analyzePhoto(r,i,o,h,s){var R,p,A,T,W,y,I,M,D,X,j,g,F,de,z,v,C,H,O,K;try{const E=await Ve.post("/api/analyze-photo",{imageData:r,language:i,selectedFaceId:o,cachedFaces:h,existingCharacterId:s});if(!E.success)return{success:!1,error:E.error};if(E.multipleFacesDetected&&E.faces)return ge.info(`Multiple faces detected (${E.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:E.faceCount,faces:E.faces};const ie={height:(R=E.attributes)==null?void 0:R.height,build:(p=E.attributes)==null?void 0:p.build,face:(A=E.attributes)==null?void 0:A.face,eyeColor:((T=E.attributes)==null?void 0:T.eye_color)||((W=E.attributes)==null?void 0:W.eyeColor),hairColor:((y=E.attributes)==null?void 0:y.hair_color)||((I=E.attributes)==null?void 0:I.hairColor),hairLength:((M=E.attributes)==null?void 0:M.hair_length)||((D=E.attributes)==null?void 0:D.hairLength),hairStyle:((X=E.attributes)==null?void 0:X.hair_style)||((j=E.attributes)==null?void 0:j.hairStyle),hair:((g=E.attributes)==null?void 0:g.hair_color)||((F=E.attributes)==null?void 0:F.hairColor),other:(de=E.attributes)==null?void 0:de.other_features};return{success:E.success,characterId:E.characterId,multipleFacesDetected:!1,faceCount:E.faceCount,photos:{face:E.faceThumbnail,body:E.bodyCrop,bodyNoBg:E.bodyNoBg,faceBox:E.faceBox,bodyBox:E.bodyBox},age:(z=E.attributes)==null?void 0:z.age,apparentAge:(v=E.attributes)==null?void 0:v.apparent_age,gender:(C=E.attributes)==null?void 0:C.gender,physical:ie.height||ie.build||ie.face||ie.eyeColor||ie.hairColor||ie.hairLength||ie.hairStyle||ie.hair||ie.other?ie:void 0,clothing:(H=E.attributes)!=null&&H.clothing||(O=E.attributes)!=null&&O.clothingStyle||(K=E.attributes)!=null&&K.clothingColors?{current:E.attributes.clothing,style:E.attributes.clothingStyle||E.attributes.clothingColors}:void 0,_debug:E._debug}}catch(E){return ge.error("Photo analysis failed:",E),{success:!1,error:"unknown_error"}}},needsAvatars(r){var s,R,p,A;if(!!!((s=r.photos)!=null&&s.original||(R=r.photos)!=null&&R.face||(p=r.photos)!=null&&p.body||(A=r.photos)!=null&&A.bodyNoBg))return!1;const o=r.avatars;return o?o.status==="generating"||o.status==="pending"?!1:o.status==="failed"?!0:!!!(o.winter||o.standard||o.summer||o.formal||o.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(r,i,o){var s,R,p,A,T,W,y,I,M,D,X,j,g,F,de,z,v,C,H,O;const h={characterId:r.id,characterName:r.name,success:!1};try{if(!!!((s=r.photos)!=null&&s.original||(R=r.photos)!=null&&R.face||(p=r.photos)!=null&&p.body||(A=r.photos)!=null&&A.bodyNoBg))return h.skipped=!0,h.skipReason="No photo available",h;i==null||i("generating",`Generating avatars for ${r.name}...`),ge.info(`ðŸŽ¨ Generating avatars for ${r.name} (id: ${r.id})${o!=null&&o.avatarModel?`, model: ${o.avatarModel}`:""}`);const E=await ze.generateClothingAvatars(r,o);if(!E.success||!E.avatars)return h.error=E.error||"Avatar generation failed",i==null||i("error",h.error),h;h.avatars=E.avatars,h.extractedTraits=E.extractedTraits,h.extractedClothing=E.extractedClothing,i==null||i("saving",`Fetching updated data for ${r.name}...`);let ie=null;const ee=30;for(let ve=0;ve<ee;ve++){if(ve>0){const ye=Math.min(500*Math.pow(1.2,ve),3e3);ge.info(`[AVATAR] Retry ${ve+1}/${ee}: waiting ${Math.round(ye)}ms for avatar data...`),await new Promise(B=>setTimeout(B,ye))}if(ie=await ze.loadFullCharacter(r.id),(T=ie==null?void 0:ie.avatars)!=null&&T.standard||(W=ie==null?void 0:ie.avatars)!=null&&W.winter||(y=ie==null?void 0:ie.avatars)!=null&&y.summer){ge.info(`[AVATAR] Got fresh data with avatars on attempt ${ve+1}`);break}}return ie?(h.character=ie,(I=ie.avatars)!=null&&I.standard||(M=ie.avatars)!=null&&M.winter||(D=ie.avatars)!=null&&D.summer||ge.warn(`âš ï¸ Fresh DB data for ${r.name} missing avatars after ${ee} retries - server may not have saved them`),ge.info(`ðŸ“‹ Using server-saved data for ${r.name}`)):(ge.error(`âŒ Character ${r.name} (id: ${r.id}) not found in DB after avatar job - avatars lost!`),h.character={...r,avatars:{status:"failed"},physical:E.extractedTraits?{...r.physical,apparentAge:E.extractedTraits.apparentAge||((X=r.physical)==null?void 0:X.apparentAge),build:E.extractedTraits.build||((j=r.physical)==null?void 0:j.build),eyeColor:E.extractedTraits.eyeColor||((g=r.physical)==null?void 0:g.eyeColor),eyeColorHex:E.extractedTraits.eyeColorHex||((F=r.physical)==null?void 0:F.eyeColorHex),hairColor:E.extractedTraits.hairColor||((de=r.physical)==null?void 0:de.hairColor),hairColorHex:E.extractedTraits.hairColorHex||((z=r.physical)==null?void 0:z.hairColorHex),hairLength:E.extractedTraits.hairLength||((v=r.physical)==null?void 0:v.hairLength),hairStyle:E.extractedTraits.hairStyle||((C=r.physical)==null?void 0:C.hairStyle),skinTone:E.extractedTraits.skinTone||((H=r.physical)==null?void 0:H.skinTone),skinToneHex:E.extractedTraits.skinToneHex||((O=r.physical)==null?void 0:O.skinToneHex)}:r.physical,clothing:E.extractedClothing?{...r.clothing,structured:{upperBody:E.extractedClothing.upperBody||void 0,lowerBody:E.extractedClothing.lowerBody||void 0,shoes:E.extractedClothing.shoes||void 0,fullBody:E.extractedClothing.fullBody||void 0}}:r.clothing}),h.success=!0,i==null||i("complete",`Avatars saved for ${r.name}`),ge.success(`âœ… Avatars generated and saved for ${r.name}`),h}catch(K){return h.error=String(K),i==null||i("error",h.error),ge.error(`Failed to generate/save avatars for ${r.name}:`,K),h}},async generateAvatarsForCharacters(r,i){const{forceRegenerate:o=!1,maxConcurrent:h=2,onProgress:s}=i||{};ge.info("ðŸŽ¨ Starting batch avatar generation...");const R=await ze.getCharacterData();let p;if(r&&r.length>0?p=R.characters.filter(M=>r.includes(M.id)):p=R.characters.filter(M=>{var D,X;return o?!!((D=M.photos)!=null&&D.original||(X=M.photos)!=null&&X.face):ze.needsAvatars(M)}),p.length===0)return ge.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};ge.info(`Processing ${p.length} characters for avatar generation`);const A=[],T=new Map;for(let M=0;M<p.length;M+=h){const X=p.slice(M,M+h).map(async g=>{var de,z,v,C,H;const F={characterId:g.id,characterName:g.name,success:!1};try{if(!!!((de=g.photos)!=null&&de.original||(z=g.photos)!=null&&z.face||(v=g.photos)!=null&&v.body||(C=g.photos)!=null&&C.bodyNoBg))return F.skipped=!0,F.skipReason="No photo available",F;if(!o&&((H=g.avatars)!=null&&H.winter))return F.skipped=!0,F.skipReason="Avatars already exist",F;s==null||s(g.id,"generating",`Generating avatars for ${g.name}...`),ge.info(`ðŸŽ¨ Generating avatars for ${g.name}...`);const K=await ze.generateClothingAvatars(g);return!K.success||!K.avatars?(F.error=K.error||"Avatar generation failed",s==null||s(g.id,"error",F.error),F):(F.avatars=K.avatars,F.success=!0,T.set(g.id,{...g,avatars:K.avatars}),s==null||s(g.id,"complete",`Avatars generated for ${g.name}`),ge.success(`âœ… Avatars generated for ${g.name}`),F)}catch(O){return F.error=String(O),s==null||s(g.id,"error",F.error),ge.error(`Failed to generate avatars for ${g.name}:`,O),F}}),j=await Promise.all(X);A.push(...j)}if(T.size>0){ge.info(`ðŸ’¾ Saving ${T.size} character avatar updates...`);const M=await ze.getCharacterData(),D=M.characters.map(X=>T.get(X.id)||X);await ze.saveCharacterData({...M,characters:D}),ge.success(`ðŸ’¾ Saved character data for ${T.size} characters`)}const W=A.filter(M=>M.success).length,y=A.filter(M=>!M.success&&!M.skipped).length,I=A.filter(M=>M.skipped).length;return ge.info(`Avatar generation complete: ${W} success, ${y} failed, ${I} skipped`),{results:A,successCount:W,failCount:y,skipCount:I}},async regenerateAvatarsForCharacter(r,i,o){ge.info(`ðŸ”„ Regenerating avatars for character ${r}...`);const s=(await ze.getCharacterData()).characters.find(p=>p.id===r);if(!s)return{characterId:r,characterName:"Unknown",success:!1,error:"Character not found"};const R={...s,avatars:{status:"pending"}};return ze.generateAndSaveAvatarForCharacter(R,i?(p,A)=>i(p,A):void 0,o)}},Fn={sm:"h-1",md:"h-2",lg:"h-3"},oo={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function lo({value:r,max:i=100,label:o,showPercentage:h=!1,size:s="md",variant:R="gradient",className:p=""}){const A=Math.min(Math.max(r/i*100,0),100);return e.jsxs("div",{className:p,children:[(o||h)&&e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[o&&e.jsx("span",{className:"text-sm font-medium text-gray-700",children:o}),h&&e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(A),"%"]})]}),e.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${Fn[s]}`,children:e.jsx("div",{className:`${Fn[s]} ${oo[R]} rounded-full transition-all duration-500 ease-out`,style:{width:`${A}%`}})})]})}const zr=dn("ImageLoad");function Ea({src:r,alt:i,className:o,label:h}){const[s,R]=l.useState(!0),[p,A]=l.useState(null),T=l.useRef(0),W=l.useRef(null);l.useEffect(()=>{r&&r.length>100?(T.current=Date.now(),zr.info(`â³ Loading ${h||i}`,{isBase64:r==null?void 0:r.startsWith("data:"),sizeKB:Math.round(r.length*3/4/1024)})):T.current=0,R(!0),A(null)},[r,i,h]);const y=()=>{if(R(!1),T.current===0){zr.info(`âœ… Loaded ${h||i} (placeholder/empty)`);return}const M=Date.now()-T.current;A(M);const X=(r==null?void 0:r.startsWith("data:"))?Math.round(r.length*3/4/1024):null,j=W.current?`${W.current.naturalWidth}x${W.current.naturalHeight}`:"unknown";M<100?zr.success(`âœ… Loaded ${h||i} in ${M}ms`,{sizeKB:X,naturalSize:j}):M<500?zr.info(`âœ… Loaded ${h||i} in ${M}ms`,{sizeKB:X,naturalSize:j}):M<2e3?zr.warn(`âš ï¸ Slow load: ${h||i} took ${M}ms`,{sizeKB:X,naturalSize:j}):zr.error(`ðŸ¢ Very slow: ${h||i} took ${M}ms`,{sizeKB:X,naturalSize:j}),M>1e3&&co({type:"slow_image_load",label:h||i,loadTimeMs:M,sizeKB:X,naturalSize:j,userAgent:navigator.userAgent,timestamp:new Date().toISOString()})},I=()=>{if(R(!1),T.current===0){zr.error(`âŒ Failed to load ${h||i} (no data received)`);return}const M=Date.now()-T.current;zr.error(`âŒ Failed to load ${h||i} after ${M}ms`)};return e.jsx("img",{ref:W,src:r,alt:i,className:o,onLoad:y,onError:I,draggable:!1})}async function co(r){try{await fetch("/api/log-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errorType:"Performance",message:`Slow image load: ${r.label} took ${r.loadTimeMs}ms`,userAgent:r.userAgent,timestamp:r.timestamp,url:window.location.href})})}catch{}}function mo({step:r,text:i}){const o=`wizard_helper_dismissed_${r}`,[h,s]=l.useState(()=>localStorage.getItem(o)==="true");l.useEffect(()=>{const p=localStorage.getItem(o)==="true";s(p)},[r,o]);const R=()=>{localStorage.setItem(o,"true"),s(!0)};return h?null:e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[e.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:i}),e.jsx("button",{onClick:R,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:e.jsx(zt,{size:16})})]})}function uo({current:r,total:i,message:o,isGenerating:h=!0,coverImages:s,jobId:R,onCancel:p,onMinimize:A,characters:T=[],isStalled:W=!1,onDismissStalled:y,isImpersonating:I=!1}){const{language:M}=ir(),{user:D}=cn(),X=(D==null?void 0:D.role)==="admin"||I,[j,g]=l.useState(!1),[F,de]=l.useState(0),z=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit fÃ¼r das grosse Abenteuer...",fr:"{name} se prÃ©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} Ã¼bt gerade die Heldenpose...",fr:"{name} s'entraÃ®ne Ã  prendre la pose du hÃ©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als NÃ¤chstes passiert!",fr:"{name} a hÃ¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} wÃ¤rmt sich fÃ¼r das bevorstehende Abenteuer auf...",fr:"{name} s'Ã©chauffe pour l'aventure Ã  venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir fÃ¼gen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au rÃ©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} flÃ¼stert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'Å“il au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne fÃ¼r die Geschichte...",fr:"{name} collectionne des Ã©toiles pour le rÃ©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],v=l.useRef({}),[C,H]=l.useState(null),O=l.useMemo(()=>T.filter(pe=>{var q;const he=pe.avatars;return he&&(((q=he.faceThumbnails)==null?void 0:q.standard)||he.standard||he.summer||he.winter||he.formal||he.hasFullAvatars)}),[T]),K=pe=>{var Ie;const he=pe.avatars;if(!he)return"";if((Ie=he.faceThumbnails)!=null&&Ie.standard)return he.faceThumbnails.standard;const q=[];return he.standard&&q.push(he.standard),he.summer&&q.push(he.summer),he.winter&&q.push(he.winter),he.formal&&q.push(he.formal),q[Math.floor(Math.random()*q.length)]||""},E=l.useMemo(()=>{const pe=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(O.length===0)return pe;const he=[],q=Math.max(pe.length,O.length);for(let Ie=0;Ie<q;Ie++)he.push(pe[Ie%pe.length]),he.push({type:"character",char:O[Ie%O.length]});return he},[O]);if(l.useEffect(()=>{if(E.length<=1)return;const pe=setInterval(()=>{de(he=>(he+1)%E.length)},8e3);return()=>clearInterval(pe)},[E.length]),l.useEffect(()=>{if(E.length===0)return;const pe=E[F];if(pe.type==="character"){const he=pe.char,q=K(he),We=((v.current[he.id]??-1)+1)%z.length;v.current[he.id]=We;const Xe=z[We],bt=(M==="de"?Xe.de:M==="fr"?Xe.fr:Xe.en).replace("{name}",he.name);H({avatarUrl:q,message:bt})}else H(null)},[F,E,M]),!h||i===0)return null;const ie=i===100?r:Math.round(r/i*100),ee=pe=>{if(pe)return typeof pe=="string"?pe:pe.imageData},ve=ee(s==null?void 0:s.frontCover),ye=ee(s==null?void 0:s.initialPage),B=ee(s==null?void 0:s.backCover),xe=!!ve,De=!!ye,_e=!!B,Se=xe||De||_e,U={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollstÃ¤ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erhÃ¤ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz persÃ¶nliches Abenteuer gestalten.',tipLocations:'FÃ¼ge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu fÃ¼r eine persÃ¶nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? FÃ¼r BilderbÃ¼cher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint hÃ¤ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"CrÃ©ation de votre histoire!",timeInfo:"Votre rÃ©cit commencera Ã  s'afficher dans environ 1 minute. Le rÃ©cit complet peut prendre jusqu'Ã  10 minutes.",emailInfo:"Vous recevrez un email quand votre rÃ©cit sera prÃªt.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre rÃ©cit continuera Ã  Ãªtre gÃ©nÃ©rÃ©.",tipCharacters:"Mieux vous dÃ©crivez vos personnages, plus le rÃ©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du rÃ©cit" vous permet de crÃ©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits prÃ©fÃ©rÃ©s Ã  "Intrigue / Contexte du rÃ©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique prÃ©fÃ©rÃ© ? Pour les livres d'images, l'aquarelle fonctionne trÃ¨s bien !",coversPreview:"AperÃ§u des couvertures",frontCover:"Avant",initialPage:"IntÃ©rieur",backCover:"ArriÃ¨re",cancelJob:"Annuler la gÃ©nÃ©ration",cancelling:"Annulation...",stalled:"La gÃ©nÃ©ration semble bloquÃ©e",stalledDesc:"Aucun progrÃ¨s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer Ã  attendre",continueInBackground:"Continuer en arriÃ¨re-plan"}},Ne=U[M]||U.en,Qe=({imageData:pe,label:he,isReady:q})=>e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${q?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:q&&pe?e.jsx("img",{src:pe,alt:he,className:"w-full h-full object-cover"}):e.jsx(Ye,{size:20,className:"animate-spin text-gray-400"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[q&&e.jsx(Sn,{size:12,className:"text-green-500"}),e.jsx("span",{className:`text-xs ${q?"text-green-600 font-medium":"text-gray-400"}`,children:he})]})]});return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${Se?"max-w-lg":"max-w-md"}`,children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("div",{className:"relative inline-block mb-3",children:[e.jsx(Ye,{size:48,className:"animate-spin text-indigo-600"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"âœ¨"})]}),e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:Ne.title})]}),!Se&&E.length>0&&e.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const pe=E[F];if(pe.type==="character"&&C)return e.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[e.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:e.jsx("img",{src:C.avatarUrl,alt:pe.char.name,className:"w-full h-full object-contain"})}),e.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:C.message})]},`char-${pe.char.id}-${F}`);if(pe.type==="message"){const he=pe.key,q=Ne[he]||"",Ie=he==="timeInfo"?e.jsx(_i,{size:20,className:"text-indigo-500 shrink-0"}):he==="emailInfo"?e.jsx(Jn,{size:20,className:"text-indigo-500 shrink-0"}):e.jsx(Sn,{size:20,className:"text-indigo-500 shrink-0"});return e.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[Ie,e.jsx("p",{className:"text-sm text-gray-700",children:q})]})}return null})()}),Se&&e.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:Ne.coversPreview}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(Qe,{imageData:ve,label:Ne.frontCover,isReady:xe}),e.jsx(Qe,{imageData:ye,label:Ne.initialPage,isReady:De}),e.jsx(Qe,{imageData:B,label:Ne.backCover,isReady:_e})]})]}),Se&&e.jsxs("div",{className:"mb-4 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[e.jsx(Ye,{size:14,className:"animate-spin text-indigo-500"}),M==="de"?"Bilder fÃ¼r die Seiten werden jetzt erstellt...":M==="fr"?"CrÃ©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:M==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":M==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),e.jsx("div",{className:"mb-4",children:e.jsx(lo,{value:ie,max:100,showPercentage:!0,size:"lg"})}),A&&e.jsx("button",{onClick:A,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:Ne.continueInBackground}),W&&e.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Kn,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:Ne.stalled}),e.jsx("p",{className:"text-sm text-amber-700 mb-3",children:Ne.stalledDesc}),e.jsxs("div",{className:"flex gap-2",children:[y&&e.jsx("button",{onClick:y,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:Ne.continueWaiting}),p&&e.jsx("button",{onClick:()=>{if(!j){g(!0);try{p()}finally{g(!1)}}},disabled:j,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:j?Ne.cancelling:Ne.cancelJob})]})]})]})}),X&&R&&p&&e.jsxs("button",{onClick:async()=>{if(!j){g(!0);try{p()}finally{g(!1)}}},disabled:j,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[j?e.jsx(Ye,{size:16,className:"animate-spin"}):e.jsx(Gi,{size:16}),j?Ne.cancelling:Ne.cancelJob]})]})})}function Js(r,i){const o=new Blob([r],{type:"text/plain;charset=utf-8"}),h=URL.createObjectURL(o),s=document.createElement("a");s.href=h,s.download=i,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(h)}function on(r,i=0){const o="  ".repeat(i);if(r==null)return`${o}null`;if(typeof r=="boolean")return`${o}${r?"YES":"NO"}`;if(typeof r=="number")return`${o}${r}`;if(typeof r=="string")return`${o}${r}`;if(Array.isArray(r))return r.length===0?`${o}[]`:r.map((h,s)=>`${o}[${s}]: ${on(h,0)}`).join(`
`);if(typeof r=="object"){const h=Object.entries(r);return h.length===0?`${o}{}`:h.map(([s,R])=>{const p=on(R,i+1);return typeof R=="object"&&R!==null?`${o}${s}:
${p}`:`${o}${s}: ${p.trim()}`}).join(`
`)}return`${o}${String(r)}`}function Fa({data:r,language:i,title:o}){const[h,s]=l.useState(new Set);if(!r)return e.jsx("div",{className:"text-gray-400 italic text-sm",children:i==="de"?"Keine Daten":"No data"});let R=r;if(typeof r=="string")try{R=JSON.parse(r)}catch{return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-end mb-1",children:e.jsxs("button",{onClick:()=>Js(r,`${o||"evaluation"}.txt`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Download as text file",children:[e.jsx(Xr,{size:12})," Download"]})}),e.jsx("pre",{className:"text-sm whitespace-pre-wrap bg-gray-50 p-3 rounded max-h-80 overflow-auto font-mono",children:r})]})}const p=W=>{const y=new Set(h);y.has(W)?y.delete(W):y.add(W),s(y)},A=()=>{const W=on(R);Js(W,`${o||"evaluation"}.txt`)},T=(W,y,I=0)=>{const M=h.has(W);if(y==null)return e.jsx("span",{className:"text-gray-400",children:"null"});if(typeof y=="boolean")return e.jsx("span",{className:y?"text-green-600 font-medium":"text-red-600 font-medium",children:y?"âœ“":"âœ—"});if(typeof y=="number"){const D=y>=70?"text-green-600":y>=50?"text-yellow-600":"text-red-600";return e.jsx("span",{className:`font-bold ${D}`,children:y})}if(typeof y=="string")return y.length>100?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>p(W),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[M?e.jsx(Sr,{size:14}):e.jsx(nn,{size:14}),M?"Collapse":`Show (${y.length} chars)`]}),M&&e.jsx("div",{className:"mt-1 p-2 bg-gray-100 rounded text-sm whitespace-pre-wrap font-mono",children:y})]}):e.jsx("span",{className:"text-gray-700",children:y});if(Array.isArray(y))return y.length===0?e.jsx("span",{className:"text-gray-400",children:"[]"}):e.jsx("div",{className:"ml-2 border-l-2 border-gray-200 pl-2",children:y.map((D,X)=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"text-gray-400 text-xs",children:["[",X,"]"]})," ",T(`${W}.${X}`,D,I+1)]},X))});if(typeof y=="object"){const D=Object.entries(y);return D.length===0?e.jsx("span",{className:"text-gray-400",children:"{}"}):I>0?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>p(W),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[M?e.jsx(Sr,{size:14}):e.jsx(nn,{size:14}),M?"Collapse":`{${D.length} fields}`]}),M&&e.jsx("div",{className:"ml-2 mt-1 border-l-2 border-gray-200 pl-2",children:D.map(([X,j])=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium text-gray-600",children:[X,":"]})," ",T(`${W}.${X}`,j,I+1)]},X))})]}):e.jsx("div",{className:"space-y-1",children:D.map(([X,j])=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-medium text-gray-600 min-w-[100px]",children:[X,":"]}),e.jsx("div",{className:"flex-1",children:T(`${W}.${X}`,j,I+1)})]},X))})}return e.jsx("span",{children:String(y)})};return e.jsxs("div",{className:"text-sm space-y-1 max-h-[500px] overflow-auto",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:A,className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",title:"Download as text file",children:[e.jsx(Xr,{size:12})," Download"]})}),T("root",R)]})}function go({beforeImage:r,maskImage:i,onEnlarge:o}){return e.jsxs("div",{className:"relative w-40 h-40 cursor-pointer hover:ring-2 hover:ring-amber-400 rounded overflow-hidden border",onClick:()=>o(r,"Before with Mask"),children:[e.jsx("img",{src:r,alt:"Before",className:"w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 w-full h-full",style:{backgroundImage:`url(${i})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",mixBlendMode:"multiply",opacity:.5}}),e.jsx("img",{src:i,alt:"Mask overlay",className:"absolute inset-0 w-full h-full object-contain pointer-events-none",style:{mixBlendMode:"screen",opacity:.7,filter:"sepia(1) saturate(5) hue-rotate(-50deg)"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-[10px] text-center py-1 font-medium",children:"ðŸŽ¯ Edit Area"})]})}function vs({retryHistory:r,totalAttempts:i,language:o,onRevertRepair:h,storyId:s,pageNumber:R}){const[p,A]=l.useState(null),[T,W]=l.useState({}),[y,I]=l.useState(new Set),M=async g=>{if(!(!s||R===void 0||y.has(g))){I(F=>new Set(F).add(g));try{const F=localStorage.getItem("auth_token"),de=new URLSearchParams({page:String(R),type:"retry",index:String(g)}),z=await fetch(`/api/stories/${s}/dev-image?${de}`,{headers:F?{Authorization:`Bearer ${F}`}:{}});if(z.ok){const v=await z.json();W(C=>({...C,[g]:{imageData:v.imageData,annotatedOriginal:v.annotatedOriginal,grids:v.grids,bboxOverlayImage:v.bboxOverlayImage}}))}}catch(F){console.error(`Failed to load retry images for retry ${g}:`,F)}finally{I(F=>{const de=new Set(F);return de.delete(g),de})}}};if(!r||r.length===0)return null;const D=r.filter(g=>g.type==="auto_repair"||g.type==="grid_repair"||g.type==="grid_repair_failed").length,X=r.filter(g=>g.type==="grid_repair"||g.type==="grid_repair_failed").length,j=r.filter(g=>g.type==="grid_repair_failed").length;return e.jsxs(e.Fragment,{children:[p&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>A(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:p.title}),e.jsx("img",{src:p.src,alt:p.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>A(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-purple-700 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Hi,{size:14}),o==="de"?"Generierungshistorie":o==="fr"?"Historique de gÃ©nÃ©ration":"Generation History",D>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["ðŸ”§ ",D," ",o==="de"?"Reparatur":"repair",D>1?o==="de"?"en":"s":"",X>0&&e.jsxs("span",{className:"ml-1",children:["(",X," grid",j>0?`, ${j} failed`:"",")"]})]})]}),e.jsxs("span",{className:"text-purple-600",children:[i," ",o==="de"?"Versuche":o==="fr"?"tentatives":"attempts"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:r.map((g,F)=>{var de,z;return e.jsxs("div",{className:`border rounded-lg p-3 ${g.type==="grid_repair_failed"?"bg-red-50 border-red-300":g.type==="grid_repair"?"bg-violet-50 border-violet-300":g.type==="auto_repair"?"bg-amber-50 border-amber-300":F===r.length-1?"bg-green-50 border-green-300":"bg-white border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[g.type==="grid_repair_failed"?e.jsx("span",{className:"text-red-700",children:"ðŸ”² Grid Repair Failed"}):g.type==="grid_repair"?e.jsx("span",{className:"text-violet-700",children:"ðŸ”² Grid Repair"}):g.type==="auto_repair"?e.jsx("span",{className:"text-amber-700",children:"ðŸ”§ Auto-Repair"}):e.jsx(e.Fragment,{children:o==="de"?`Versuch ${g.attempt}`:o==="fr"?`Tentative ${g.attempt}`:`Attempt ${g.attempt}`}),g.type==="text_edit"&&e.jsx("span",{className:"text-xs ml-2 text-blue-600",children:"(text edit)"}),g.type==="text_edit_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(text edit failed)"}),g.type==="auto_repair_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(auto-repair failed)"}),F===r.length-1&&g.type!=="auto_repair"&&e.jsx("span",{className:"text-xs ml-2 text-green-600 font-bold",children:"âœ“ USED"})]}),g.type==="auto_repair"&&g.preRepairScore!==void 0&&g.postRepairScore!==void 0?e.jsxs("span",{className:"font-bold text-sm",children:[e.jsxs("span",{className:g.preRepairScore>=70?"text-green-600":g.preRepairScore>=50?"text-yellow-600":"text-red-600",children:[g.preRepairScore,"%"]}),e.jsx("span",{className:"text-gray-400 mx-1",children:"â†’"}),e.jsxs("span",{className:g.postRepairScore>=70?"text-green-600":g.postRepairScore>=50?"text-yellow-600":"text-red-600",children:[g.postRepairScore,"%"]})]}):g.score!==void 0&&e.jsxs("span",{className:`font-bold ${g.score>=70?"text-green-600":g.score>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(g.score),"%"]})]}),g.error&&e.jsxs("div",{className:"text-xs text-red-600 mb-2",children:["Error: ",g.error]}),g.textIssue&&g.textIssue!=="NONE"&&e.jsxs("div",{className:"text-xs text-orange-600 mb-2",children:["Text issue: ",g.textIssue,g.expectedText&&e.jsxs("span",{className:"block",children:['Expected: "',g.expectedText,'"']}),g.actualText&&e.jsxs("span",{className:"block",children:['Actual: "',g.actualText,'"']})]}),g.type==="auto_repair"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[g.fixTargetsCount&&e.jsxs("div",{className:"text-xs text-amber-700",children:["Fixed ",g.fixTargetsCount," target",g.fixTargetsCount>1?"s":""]}),h&&((z=(de=g.repairDetails)==null?void 0:de[0])==null?void 0:z.beforeImage)&&g.postRepairScore!==void 0&&g.preRepairScore!==void 0&&g.postRepairScore<=g.preRepairScore&&e.jsxs("button",{onClick:()=>h(F,g.repairDetails[0].beforeImage),className:"text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded border border-red-300 transition-colors",children:["â†©ï¸ ",o==="de"?"ZurÃ¼cksetzen":"Revert to Original"]})]}),g.postRepairScore!==void 0&&g.preRepairScore!==void 0&&g.postRepairScore<g.preRepairScore&&e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200",children:["âš ï¸ ",o==="de"?`Bewertung verschlechtert: ${g.preRepairScore}% â†’ ${g.postRepairScore}%`:`Score decreased: ${g.preRepairScore}% â†’ ${g.postRepairScore}%`]}),g.bboxDetection&&Array.isArray(g.bboxDetection)&&g.bboxDetection.length>0&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900",children:["ðŸ“¦ ",o==="de"?"Bounding Box Erkennung":"Bounding Box Detection"," (",g.bboxDetection.length,")"]}),e.jsx("div",{className:"mt-3 space-y-2",children:g.bboxDetection.map((v,C)=>e.jsxs("div",{className:`p-3 rounded-lg border ${v.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:`font-medium text-sm ${v.success?"text-green-800":"text-red-800"}`,children:[v.success?"âœ“":"âœ—"," ",v.issue.substring(0,60),v.issue.length>60?"...":""]}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${v.severity==="CRITICAL"?"bg-red-200 text-red-800":v.severity==="MAJOR"?"bg-orange-200 text-orange-800":v.severity==="MODERATE"?"bg-yellow-200 text-yellow-800":"bg-gray-200 text-gray-800"}`,children:[v.severity," â€¢ ",v.type]})]}),v.success&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${v.faceBox?"bg-purple-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-purple-800",children:"Face Box:"}),v.faceBox?e.jsxs("span",{className:"ml-1 font-mono text-purple-600",children:["[",v.faceBox.map(H=>(H*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]}),e.jsxs("div",{className:`p-2 rounded ${v.bodyBox?"bg-blue-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Body Box:"}),v.bodyBox?e.jsxs("span",{className:"ml-1 font-mono text-blue-600",children:["[",v.bodyBox.map(H=>(H*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]})]}),v.label&&v.label!==v.issue&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Detected as:"})," ",v.label]}),v.usage&&e.jsxs("div",{className:"mt-1 text-xs text-gray-400",children:["Tokens: ",v.usage.input_tokens," in / ",v.usage.output_tokens," out"]})]},C))})]}),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ“Š ",o==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[g.preRepairScore,"%"]})]}),e.jsx(Fa,{data:g.preRepairEval||g.reasoning,language:o,title:`evaluation-before-attempt-${F}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[g.postRepairScore,"%"]})]}),e.jsx(Fa,{data:g.postRepairEval,language:o,title:`evaluation-after-attempt-${F}`})]})]})]}),g.repairDetails&&g.repairDetails.length>0&&e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ–¼ï¸ ",o==="de"?"Reparatur-Details":"Repair Details"," (",g.repairDetails.length,")"]}),e.jsx("div",{className:"mt-3 space-y-3",children:g.repairDetails.map((v,C)=>{var H,O;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("div",{className:"font-medium text-amber-800 text-base",children:v.description}),v.modelId&&e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded",children:v.modelId})]}),e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:["Show fix prompt",e.jsxs("button",{onClick:K=>{K.stopPropagation(),Js(v.fullPrompt||v.fixPrompt||"",`fix-prompt-${C}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(Xr,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:v.fullPrompt||v.fixPrompt})]}),e.jsxs("div",{className:"flex gap-4 items-start",children:[v.beforeImage&&v.maskImage?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before + Mask"}),e.jsx(go,{beforeImage:v.beforeImage,maskImage:v.maskImage,onEnlarge:(K,E)=>A({src:K,title:E})})]}):v.beforeImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before"}),e.jsx("img",{src:v.beforeImage,alt:"Before",className:"w-32 h-32 object-contain border rounded cursor-pointer hover:ring-2 hover:ring-amber-400",onClick:()=>A({src:v.beforeImage,title:"Before Repair"})})]}),e.jsx("div",{className:"flex items-center h-32 text-gray-400 text-2xl",children:"â†’"}),v.afterImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"After"}),e.jsx("img",{src:v.afterImage,alt:"After",className:"w-32 h-32 object-contain border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>A({src:v.afterImage,title:"After Repair"})})]})]}),v.verification&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded border text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"ðŸ” Verification:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[v.verification.lpips&&e.jsxs("div",{className:`p-2 rounded ${v.verification.lpips.changed?"bg-green-100":"bg-yellow-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LPIPS: "}),e.jsx("span",{className:v.verification.lpips.changed?"text-green-700":"text-yellow-700",children:(H=v.verification.lpips.lpipsScore)==null?void 0:H.toFixed(4)}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",v.verification.lpips.changed?"âœ“ changed":"âš  unchanged",")"]})]}),v.verification.llm&&e.jsxs("div",{className:`p-2 rounded ${v.verification.llm.fixed?"bg-green-100":"bg-red-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LLM: "}),e.jsx("span",{className:v.verification.llm.fixed?"text-green-700":"text-red-700",children:v.verification.llm.fixed?"âœ“ Fixed":"âœ— Not fixed"}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",Math.round(v.verification.llm.confidence*100),"%)"]})]})]}),((O=v.verification.llm)==null?void 0:O.explanation)&&e.jsx("div",{className:"mt-2 text-gray-600 text-sm italic",children:v.verification.llm.explanation})]})]},C)})})]})]}),(g.type==="grid_repair"||g.type==="grid_repair_failed")&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[g.gridTotalIssues!==void 0&&e.jsxs("span",{className:"text-violet-700",children:[o==="de"?"Probleme:":"Issues:"," ",g.gridTotalIssues]}),g.gridFixedCount!==void 0&&e.jsxs("span",{className:"text-green-600",children:["âœ“ ",o==="de"?"Behoben:":"Fixed:"," ",g.gridFixedCount]}),g.gridFailedCount!==void 0&&g.gridFailedCount>0&&e.jsxs("span",{className:"text-red-600",children:["âœ— ",o==="de"?"Fehlgeschlagen:":"Failed:"," ",g.gridFailedCount]})]}),g.type==="grid_repair_failed"&&g.failReason&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-100 p-2 rounded border border-red-200",children:["âš ï¸ ",o==="de"?"Fehlergrund:":"Failure reason:"," ",g.failReason==="no_repairs_made"?o==="de"?"Keine Reparaturen durchgefÃ¼hrt":"No repairs were made":g.failReason==="no_image_data"?o==="de"?"Keine Bilddaten zurÃ¼ckgegeben":"No image data returned":g.failReason==="image_too_small"?o==="de"?"ZurÃ¼ckgegebenes Bild zu klein/ungÃ¼ltig":"Returned image too small/invalid":g.failReason==="image_unchanged"?o==="de"?"Bild wurde nicht verÃ¤ndert":"Image was not changed":g.failReason]}),(()=>{var C;const v=g.annotatedOriginal||((C=T[F])==null?void 0:C.annotatedOriginal);return v?e.jsxs("details",{className:"text-sm",open:!0,children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“ ",o==="de"?"Schritt 1: Erkannte Probleme":"Step 1: Detected Issues"]}),e.jsxs("div",{className:"mt-3 bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-2 font-medium",children:[o==="de"?"Originalbild mit markierten Problembereichen":"Original image with marked issue regions",e.jsxs("span",{className:"ml-2 text-gray-400",children:["(ðŸ”´ ",o==="de"?"kritisch":"critical",", ðŸŸ  ",o==="de"?"wichtig":"major",", ðŸŸ¡ ",o==="de"?"gering":"minor",")"]})]}),e.jsx("img",{src:`data:image/jpeg;base64,${v}`,alt:"Annotated original",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>A({src:`data:image/jpeg;base64,${v}`,title:o==="de"?"Erkannte Probleme":"Detected Issues"})})]})]}):g.hasAnnotatedOriginal&&s&&R!==void 0?e.jsx("button",{onClick:()=>M(F),disabled:y.has(F),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:y.has(F)?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{size:14,className:"animate-spin"})," Loading..."]}):e.jsx(e.Fragment,{children:"ðŸ“ Load Detected Issues"})}):null})(),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“Š ",o==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[g.preRepairScore,"%"]})]}),e.jsx(Fa,{data:g.preRepairEval||g.reasoning,language:o,title:`evaluation-before-grid-${F}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[g.postRepairScore,"%"]})]}),e.jsx(Fa,{data:g.postRepairEval,language:o,title:`evaluation-after-grid-${F}`})]})]})]}),(()=>{var C,H;const v=g.grids||((C=T[F])==null?void 0:C.grids);return v&&v.length>0?e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ”² ",o==="de"?"Grid-Details":"Grid Details"," (",v.length," ",v.length===1?"grid":"grids",")"]}),e.jsx("div",{className:"mt-3 space-y-4",children:v.map((O,K)=>{var E,ie;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("span",{className:"font-medium text-violet-800",children:["Grid"," ",O.batchNum||K+1]}),((E=O.manifest)==null?void 0:E.issues)&&e.jsxs("span",{className:"text-xs text-gray-500",children:[O.manifest.issues.length," ",o==="de"?"Regionen":"regions"]})]}),((ie=O.manifest)==null?void 0:ie.issues)&&O.manifest.issues.length>0&&e.jsxs("div",{className:"mb-3 p-2 bg-violet-50 rounded text-sm",children:[e.jsx("div",{className:"font-medium text-violet-800 mb-1",children:o==="de"?"Zu reparierende Probleme:":"Issues to repair:"}),e.jsx("div",{className:"space-y-1",children:O.manifest.issues.map((ee,ve)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-mono font-bold text-violet-600 min-w-[20px]",children:[ee.letter,":"]}),e.jsx("span",{className:"text-gray-700",children:ee.fixInstruction||ee.description||"Unknown issue"})]},ve))})]}),O.prompt&&e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:[o==="de"?"Reparatur-Prompt anzeigen":"Show repair prompt",e.jsxs("button",{onClick:ee=>{ee.stopPropagation(),Js(O.prompt||"",`grid-repair-prompt-${K}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(Xr,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:O.prompt})]}),e.jsxs("div",{className:"flex gap-4 items-start flex-wrap",children:[O.original&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Original-Grid":"Input Grid"}),e.jsx("img",{src:O.original.startsWith("data:")?O.original:`data:image/png;base64,${O.original}`,alt:"Input grid",className:"max-w-xs border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>A({src:O.original.startsWith("data:")?O.original:`data:image/png;base64,${O.original}`,title:o==="de"?"Original-Grid":"Input Grid"})})]}),O.original&&O.repaired&&e.jsx("div",{className:"flex items-center self-center text-gray-400 text-2xl",children:"â†’"}),O.repaired&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Repariertes Grid":"Repaired Grid"}),e.jsx("img",{src:O.repaired.startsWith("data:")?O.repaired:`data:image/png;base64,${O.repaired}`,alt:"Repaired grid",className:"max-w-xs border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>A({src:O.repaired.startsWith("data:")?O.repaired:`data:image/png;base64,${O.repaired}`,title:o==="de"?"Repariertes Grid":"Repaired Grid"})})]})]}),O.repairs&&O.repairs.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"font-medium text-violet-800 mb-2",children:["âœ… ",o==="de"?"Verifizierungsergebnisse":"Verification Results"]}),e.jsx("div",{className:"space-y-2",children:O.repairs.map((ee,ve)=>{var ye,B,xe,De,_e,Se,U,Ne,Qe,pe,he,q;return e.jsxs("div",{className:`mb-3 p-3 rounded-lg border ${(ye=ee.verification)!=null&&ye.accepted?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:"font-mono font-bold text-xl text-violet-600 w-8",children:ee.letter}),e.jsxs("div",{className:"flex items-center gap-2",children:[ee.originalThumbnail&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:o==="de"?"Vorher":"Before"}),e.jsx("img",{src:`data:image/jpeg;base64,${ee.originalThumbnail}`,alt:"Before",className:"w-16 h-16 object-contain cursor-pointer hover:ring-2 hover:ring-violet-400 rounded border",onClick:()=>A({src:`data:image/jpeg;base64,${ee.originalThumbnail}`,title:`${ee.letter}: Before`})})]}),ee.repairedThumbnail&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:o==="de"?"Nachher":"After"}),e.jsx("img",{src:`data:image/jpeg;base64,${ee.repairedThumbnail}`,alt:"After",className:`w-16 h-16 object-contain cursor-pointer hover:ring-2 rounded border ${(B=ee.verification)!=null&&B.accepted?"border-green-300":"border-red-300"}`,onClick:()=>A({src:`data:image/jpeg;base64,${ee.repairedThumbnail}`,title:`${ee.letter}: After`})})]}),ee.diffImage&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Diff"}),e.jsx("img",{src:`data:image/jpeg;base64,${ee.diffImage}`,alt:"Diff",className:"w-16 h-16 object-contain cursor-pointer hover:ring-2 hover:ring-purple-400 rounded border",onClick:()=>A({src:`data:image/jpeg;base64,${ee.diffImage}`,title:`${ee.letter}: Diff`})})]})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-3",children:[e.jsx("span",{className:`text-2xl ${(xe=ee.verification)!=null&&xe.accepted?"text-green-600":"text-red-600"}`,children:(De=ee.verification)!=null&&De.accepted?"âœ“":"âœ—"}),e.jsxs("span",{className:`text-lg font-medium ${(((_e=ee.verification)==null?void 0:_e.confidence)??0)>=.7?"text-green-600":(((Se=ee.verification)==null?void 0:Se.confidence)??0)>=.5?"text-yellow-600":"text-red-600"}`,children:[Math.round((((U=ee.verification)==null?void 0:U.confidence)??0)*100),"%"]})]})]}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsx("span",{className:`inline-block px-2 py-0.5 rounded text-xs mr-2 ${ee.severity==="critical"?"bg-red-200 text-red-800":ee.severity==="major"?"bg-orange-200 text-orange-800":"bg-yellow-200 text-yellow-800"}`,children:ee.type||"unknown"}),e.jsx("span",{className:"text-gray-700",children:ee.description})]}),ee.fixInstruction&&e.jsxs("div",{className:"mt-1 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Fix:"})," ",ee.fixInstruction]}),(((Ne=ee.verification)==null?void 0:Ne.explanation)||((Qe=ee.verification)==null?void 0:Qe.reason))&&e.jsxs("div",{className:`mt-2 text-sm p-2 rounded ${(pe=ee.verification)!=null&&pe.accepted?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:[e.jsx("span",{className:"font-medium",children:o==="de"?"Ergebnis:":"Result:"})," ",((he=ee.verification)==null?void 0:he.explanation)||((q=ee.verification)==null?void 0:q.reason)]})]},ve)})})]})]},K)})})]}):g.hasGrids&&s&&R!==void 0&&!((H=T[F])!=null&&H.grids)?e.jsx("button",{onClick:()=>M(F),disabled:y.has(F),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:y.has(F)?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ”² Load Grid Details (",g.gridsCount||"?"," grids)"]})}):null})()]}),g.type!=="auto_repair"&&g.type!=="grid_repair"&&g.type!=="grid_repair_failed"&&g.prompt&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¤ ",o==="de"?"Eingabe-Prompt":"Input Prompt",e.jsxs("button",{onClick:v=>{v.stopPropagation(),Js(g.prompt||"",`prompt-attempt-${g.attempt}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(Xr,{size:10})," Download"]})]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-blue-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono border border-blue-200",children:g.prompt})]}),g.type!=="auto_repair"&&g.type!=="grid_repair"&&g.type!=="grid_repair_failed"&&g.reasoning?e.jsxs("details",{className:"text-sm text-gray-600 mb-2",children:[e.jsxs("summary",{className:"cursor-pointer font-medium",children:["ðŸ“¥ ",o==="de"?"Bewertungs-Feedback":"Evaluation Feedback"]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-gray-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono",children:g.reasoning})]}):g.type!=="auto_repair"&&g.type!=="grid_repair"&&g.type!=="grid_repair_failed"&&g.score===0&&e.jsx("div",{className:"text-sm text-gray-500 italic mb-2",children:o==="de"?"QualitÃ¤tsbewertung fehlgeschlagen":o==="fr"?"Ã‰valuation de qualitÃ© Ã©chouÃ©e":"Quality evaluation failed"}),(()=>{var C;if(g.type==="auto_repair"||g.type==="grid_repair"||g.type==="grid_repair_failed"||g.type==="bbox_detection_only")return null;const v=g.imageData||((C=T[F])==null?void 0:C.imageData);return v?e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Generiertes Bild":"Generated Image"}),e.jsx("img",{src:v,alt:`Attempt ${g.attempt}`,className:`w-48 h-48 object-contain rounded border cursor-pointer hover:ring-2 ${F===r.length-1?"border-green-300 hover:ring-green-400":"border-gray-200 opacity-75 hover:ring-gray-400"}`,onClick:()=>A({src:v,title:`${o==="de"?"Versuch":"Attempt"} ${g.attempt}`})})]}):g.type==="generation"&&s&&R!==void 0&&!T[F]?e.jsx("button",{onClick:()=>M(F),disabled:y.has(F),className:"mt-2 text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:y.has(F)?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ–¼ï¸ ",o==="de"?"Bild laden":"Load Image"]})}):null})(),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(g.timestamp).toLocaleTimeString()})]},F)})})]})]})}function ho(r){if(!r||r.length===0)return{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1};const i=r.find(h=>h.type==="bbox_detection_only"&&h.bboxDetection)||r.find(h=>h.bboxDetection);if(!i)return{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1};const o=i.bboxDetection;return o&&typeof o=="object"&&"figures"in o?{bboxDetection:o,bboxOverlayImage:i.bboxOverlayImage||null,hasBboxOverlay:!!i.hasBboxOverlay||!!i.bboxOverlayImage}:{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1}}function xo(r,i){const o=new Blob([r],{type:"text/plain;charset=utf-8"}),h=URL.createObjectURL(o),s=document.createElement("a");s.href=h,s.download=i,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(h)}function zn({retryHistory:r,language:i,storyId:o,pageNumber:h}){var F,de;const[s,R]=l.useState(null),[p,A]=l.useState(null),[T,W]=l.useState(!1),{bboxDetection:y,bboxOverlayImage:I,hasBboxOverlay:M}=ho(r);if(!y)return null;const D=((F=y.figures)==null?void 0:F.length)||0,X=((de=y.objects)==null?void 0:de.length)||0,j=async()=>{if(!o||h===void 0||T)return;const z=(r==null?void 0:r.findIndex(v=>v.type==="bbox_detection_only"&&v.bboxDetection||v.bboxDetection))??0;W(!0);try{const v=localStorage.getItem("auth_token"),C=new URLSearchParams({page:String(h),type:"retry",index:String(z),field:"bboxOverlay"}),H=await fetch(`/api/stories/${o}/dev-image?${C}`,{headers:v?{Authorization:`Bearer ${v}`}:{}});if(H.ok){const O=await H.json();O.bboxOverlayImage&&A(O.bboxOverlayImage)}}catch(v){console.error("Failed to load bbox overlay:",v)}finally{W(!1)}},g=I||p;return e.jsxs(e.Fragment,{children:[s&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>R(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:s.title}),e.jsx("img",{src:s.src,alt:s.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>R(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-blue-700 flex items-center justify-between",children:e.jsxs("span",{className:"flex items-center gap-2",children:["ðŸ“¦ ",i==="de"?"Objekterkennung":"Object Detection",e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:[D," ",i==="de"?"Figuren":"figures",","," ",X," ",i==="de"?"Objekte":"objects"]}),y.positionMismatches&&y.positionMismatches.length>0&&e.jsxs("span",{className:"text-xs bg-yellow-200 text-yellow-800 px-1.5 py-0.5 rounded",children:["âš ï¸ ",y.positionMismatches.length," ",i==="de"?"Abweichungen":"mismatches"]}),y.missingCharacters&&y.missingCharacters.length>0&&e.jsxs("span",{className:"text-xs bg-red-200 text-red-800 px-1.5 py-0.5 rounded",children:["âŒ ",y.missingCharacters.length," ",i==="de"?"Char fehlt":"char missing"]}),y.missingObjects&&y.missingObjects.length>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["âš ï¸ ",y.missingObjects.length," ",i==="de"?"Obj fehlt":"obj missing"]}),y.matchedObjects&&y.matchedObjects.length>0&&e.jsxs("span",{className:"text-xs bg-green-200 text-green-800 px-1.5 py-0.5 rounded",children:["âœ“ ",y.matchedObjects.length," ",i==="de"?"Obj gefunden":"obj matched"]})]})}),e.jsxs("div",{className:"mt-3 space-y-3",children:[g?e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:[i==="de"?"Erkannte Regionen":"Detected Regions",e.jsx("span",{className:"ml-2 text-gray-400",children:"(ðŸŸ¢ Body, ðŸ”µ Face, ðŸŸ  Object, ðŸŸ£ Matched)"})]}),e.jsx("img",{src:g,alt:"Bbox overlay",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-blue-400",onClick:()=>R({src:g,title:i==="de"?"Erkannte Regionen":"Detected Regions"})})]}):M&&o&&h!==void 0?e.jsx("button",{onClick:j,disabled:T,className:"text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:T?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{size:14,className:"animate-spin"})," ",i==="de"?"LÃ¤dt...":"Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ“¦ ",i==="de"?"Erkannte Regionen laden":"Load Detected Regions"]})}):null,y.expectedCharacters&&y.expectedCharacters.length>0&&e.jsxs("details",{className:"bg-violet-50 p-3 rounded border border-violet-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-violet-800",children:["ðŸ‘¥ ",i==="de"?"Erwartete Charaktere":"Expected Characters"," (",y.expectedCharacters.length,")"]}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2 text-sm",children:y.expectedCharacters.map((z,v)=>e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-violet-700",children:z.name}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:[z.description,z.position&&e.jsxs("span",{className:"ml-2 text-violet-500",children:["@ ",z.position]})]})]},v))})]}),y.expectedPositions&&Object.keys(y.expectedPositions).length>0&&e.jsxs("div",{className:"bg-purple-50 p-3 rounded border border-purple-200",children:[e.jsxs("div",{className:"font-medium text-purple-800 mb-2",children:["ðŸ“ ",i==="de"?"Erwartete Positionen":"Expected Positions"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:Object.entries(y.expectedPositions).map(([z,v])=>e.jsxs("div",{className:"bg-white p-2 rounded border flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-purple-700",children:z}),e.jsx("span",{className:"text-gray-600 text-xs",children:v})]},z))})]}),y.positionMismatches&&y.positionMismatches.length>0&&e.jsxs("div",{className:"bg-yellow-50 p-3 rounded border border-yellow-300",children:[e.jsxs("div",{className:"font-medium text-yellow-800 mb-2",children:["âš ï¸ ",i==="de"?"Positionsabweichungen":"Position Mismatches"," (",y.positionMismatches.length,")"]}),e.jsx("div",{className:"space-y-2",children:y.positionMismatches.map((z,v)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border border-yellow-200",children:[e.jsx("div",{className:"font-medium text-yellow-700",children:z.character}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1 flex gap-3",children:[e.jsxs("span",{children:[i==="de"?"Erwartet":"Expected",": ",e.jsx("span",{className:"font-medium text-purple-600",children:z.expected}),e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",z.expectedLCR,")"]})]}),e.jsx("span",{className:"text-gray-400",children:"â†’"}),e.jsxs("span",{children:[i==="de"?"Erkannt":"Actual",": ",e.jsx("span",{className:"font-medium text-orange-600",children:z.actual})]})]})]},v))})]}),y.missingCharacters&&y.missingCharacters.length>0&&e.jsxs("div",{className:"bg-red-50 p-3 rounded border border-red-300",children:[e.jsxs("div",{className:"font-medium text-red-800 mb-2",children:["âŒ ",i==="de"?"Fehlende Charaktere":"Missing Characters"," (",y.missingCharacters.length,")"]}),e.jsx("div",{className:"text-sm text-red-700",children:i==="de"?"Diese Charaktere wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These characters were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:y.missingCharacters.map((z,v)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-red-200 text-sm font-medium text-red-700",children:z},v))})]}),y.expectedObjects&&y.expectedObjects.length>0&&e.jsxs("div",{className:"bg-indigo-50 p-3 rounded border border-indigo-200",children:[e.jsxs("div",{className:"font-medium text-indigo-800 mb-2",children:["ðŸŽ¯ ",i==="de"?"Erwartete Objekte":"Expected Objects"," (",y.expectedObjects.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:y.expectedObjects.map((z,v)=>{var O,K;const C=(O=y.matchedObjects)==null?void 0:O.find(E=>E.expected===z),H=(K=y.missingObjects)==null?void 0:K.includes(z);return e.jsxs("div",{className:`bg-white p-2 rounded border flex justify-between items-center ${H?"border-red-300":C?"border-green-300":""}`,children:[e.jsxs("span",{className:`font-medium ${H?"text-red-600":C?"text-green-600":"text-indigo-700"}`,children:[H?"âŒ":C?"âœ“":"â€¢"," ",z]}),C&&e.jsxs("span",{className:"text-xs text-gray-500 truncate ml-2",children:["â†’ ",C.matched]})]},v)})})]}),y.missingObjects&&y.missingObjects.length>0&&!y.expectedObjects&&e.jsxs("div",{className:"bg-amber-50 p-3 rounded border border-amber-300",children:[e.jsxs("div",{className:"font-medium text-amber-800 mb-2",children:["âš ï¸ ",i==="de"?"Fehlende Objekte":"Missing Objects"," (",y.missingObjects.length,")"]}),e.jsx("div",{className:"text-sm text-amber-700",children:i==="de"?"Diese Objekte wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These objects were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:y.missingObjects.map((z,v)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-amber-200 text-sm font-medium text-amber-700",children:z},v))})]}),y.figures&&y.figures.length>0&&e.jsxs("div",{className:"bg-green-50 p-3 rounded border border-green-200",children:[e.jsxs("div",{className:"font-medium text-green-800 mb-2",children:[i==="de"?"Figuren":"Figures"," (",y.figures.length,")",y.unknownFigures!==void 0&&y.unknownFigures>0&&e.jsxs("span",{className:"ml-2 text-xs bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded",children:[y.unknownFigures," ",i==="de"?"unbekannt":"unknown"]})]}),e.jsx("div",{className:"space-y-2",children:y.figures.map((z,v)=>{const C=z.name&&z.name!=="UNKNOWN",H=z.confidence==="high"?"text-green-600":z.confidence==="medium"?"text-yellow-600":"text-orange-600",O=z.confidence==="high"?"â˜…":z.confidence==="medium"?"â—†":"â—‹";return e.jsxs("div",{className:`text-sm bg-white p-2 rounded border ${C?"border-green-300":"border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:`font-medium ${C?"text-green-700":"text-gray-600"}`,children:C?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:H,children:O})," ",z.name]}):e.jsxs(e.Fragment,{children:["? ",z.label||`Figure ${v+1}`]})}),C&&z.confidence&&e.jsx("span",{className:`text-xs ${H}`,children:z.confidence})]}),C&&z.label&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:z.label}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1 grid grid-cols-2 gap-2",children:[z.bodyBox&&e.jsxs("span",{children:["Body: [",z.bodyBox.map(K=>(K*100).toFixed(0)+"%").join(", "),"]"]}),z.faceBox&&e.jsxs("span",{children:["Face: [",z.faceBox.map(K=>(K*100).toFixed(0)+"%").join(", "),"]"]}),z.position&&e.jsxs("span",{children:["Pos: ",z.position]})]})]},v)})})]}),y.objects&&y.objects.length>0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsxs("div",{className:"font-medium text-orange-800 mb-2",children:[i==="de"?"Objekte":"Objects"," (",y.objects.length,")"]}),e.jsx("div",{className:"space-y-2",children:y.objects.map((z,v)=>{const C=!!z.name,H=z.found!==!1;return e.jsxs("div",{className:`text-sm bg-white p-2 rounded border ${C&&H?"border-green-300":C&&!H?"border-red-300":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:`font-medium ${C&&H?"text-green-700":C&&!H?"text-red-600":"text-orange-700"}`,children:C?e.jsxs(e.Fragment,{children:[H?"âœ“":"âœ—"," ",z.name]}):z.label||`Object ${v+1}`}),C&&e.jsx("span",{className:`text-xs ${H?"text-green-600":"text-red-600"}`,children:H?i==="de"?"gefunden":"found":i==="de"?"fehlt":"missing"})]}),C&&z.label&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:z.label}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[z.bodyBox&&e.jsxs("span",{children:["Box: [",z.bodyBox.map(O=>(O*100).toFixed(0)+"%").join(", "),"]"]}),z.position&&e.jsxs("span",{className:"ml-2",children:["Pos: ",z.position]})]})]},v)})})]}),y.characterDescriptions&&Object.keys(y.characterDescriptions).length>0&&e.jsxs("details",{className:"bg-cyan-50 p-3 rounded border border-cyan-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-cyan-800",children:["ðŸ‘¤ ",i==="de"?"Charakter-Beschreibungen":"Character Descriptions"," (",Object.keys(y.characterDescriptions).length,")"]}),e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2 text-sm",children:Object.entries(y.characterDescriptions).map(([z,v])=>e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("span",{className:"font-medium text-cyan-700",children:z}),e.jsxs("span",{className:"text-gray-600 ml-2",children:[v.genderTerm||v.gender||"?",", ",v.age?`${v.age}y`:"?",v.isChild?" (child)":v.isChild===!1?" (adult)":""]})]},z))})]}),y.rawPrompt&&e.jsxs("details",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-gray-700",children:["ðŸ“ ",i==="de"?"Bbox-Prompt":"Bbox Prompt"]}),e.jsx("pre",{className:"mt-2 text-xs bg-white p-2 rounded border overflow-x-auto whitespace-pre-wrap max-h-48 overflow-y-auto",children:y.rawPrompt})]}),y.rawResponse&&e.jsxs("details",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-gray-700",children:["ðŸ“¤ ",i==="de"?"Bbox-Antwort":"Bbox Response"]}),e.jsx("pre",{className:"mt-2 text-xs bg-white p-2 rounded border overflow-x-auto whitespace-pre-wrap max-h-64 overflow-y-auto",children:y.rawResponse})]}),e.jsxs("button",{onClick:()=>xo(JSON.stringify(y,null,2),`object-detection-page-${h}.json`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",children:[e.jsx(Xr,{size:12})," ",i==="de"?"JSON herunterladen":"Download JSON"]})]})]})]})}function po({src:r,alt:i,onClose:o}){const h=l.useCallback(s=>{s.key==="Escape"&&o()},[o]);return l.useEffect(()=>(r&&(document.addEventListener("keydown",h),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",h),document.body.style.overflow="unset"}),[r,h]),r?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm cursor-pointer",onClick:o,children:[e.jsx("button",{onClick:o,className:"absolute top-4 right-4 p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors z-10","aria-label":"Close",children:e.jsx(zt,{size:24})}),e.jsx("img",{src:r,alt:i||"Enlarged image",className:"max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl",onClick:s=>s.stopPropagation()})]}):null}function Ks({referencePhotos:r,landmarkPhotos:i,visualBibleGrid:o,language:h,storyId:s,pageNumber:R}){var ye;const[p,A]=l.useState(null),[T,W]=l.useState(null),[y,I]=l.useState(null),[M,D]=l.useState(!1),[X,j]=l.useState(null),g=r==null?void 0:r.some(B=>B.hasPhoto&&!B.photoUrl),F=i==null?void 0:i.some(B=>B.hasPhoto&&!B.photoData),de=l.useCallback(async()=>{if(!(!s||!R||M)&&!(!g&&!F)){D(!0),j(null);try{if(g){const B=await Fe.getDevImage(s,R,"reference");B!=null&&B.referencePhotos&&W(B.referencePhotos)}if(F){const B=await Fe.getDevImage(s,R,"landmark");B!=null&&B.landmarkPhotos&&I(B.landmarkPhotos)}}catch(B){j(B instanceof Error?B.message:"Failed to load images")}finally{D(!1)}}},[s,R,M,g,F]),z=T||r,v=y||i,C=z&&z.length>0,H=v&&v.length>0,O=!!o;if(!C&&!H&&!O)return null;const K=((r==null?void 0:r.length)||0)+((i==null?void 0:i.length)||0)+(O?1:0),E=B=>{switch(B){case"bodyNoBg":case"body-no-bg":return h==="de"?"GanzkÃ¶rper (freigestellt)":h==="fr"?"Corps entier (dÃ©tourÃ©)":"Full body (no bg)";case"body":return h==="de"?"GanzkÃ¶rper":h==="fr"?"Corps entier":"Full body";case"face":return h==="de"?"Gesicht":h==="fr"?"Visage":"Face only";case"clothing-winter":return h==="de"?"Winter-Avatar":h==="fr"?"Avatar hiver":"Winter avatar";case"clothing-summer":return h==="de"?"Sommer-Avatar":h==="fr"?"Avatar Ã©tÃ©":"Summer avatar";case"clothing-formal":return h==="de"?"Formell-Avatar":h==="fr"?"Avatar formel":"Formal avatar";case"clothing-standard":return h==="de"?"Standard-Avatar":h==="fr"?"Avatar standard":"Standard avatar";case"none":return h==="de"?"Kein Foto":h==="fr"?"Pas de photo":"No photo";default:return B}},ie=B=>{switch(B){case"bodyNoBg":case"body-no-bg":return"bg-green-100 text-green-700 border-green-300";case"body":return"bg-blue-100 text-blue-700 border-blue-300";case"face":return"bg-yellow-100 text-yellow-700 border-yellow-300";case"clothing-winter":return"bg-cyan-100 text-cyan-700 border-cyan-300";case"clothing-summer":return"bg-orange-100 text-orange-700 border-orange-300";case"clothing-formal":return"bg-purple-100 text-purple-700 border-purple-300";case"clothing-standard":return"bg-teal-100 text-teal-700 border-teal-300";case"none":return"bg-red-100 text-red-700 border-red-300";default:return"bg-gray-100 text-gray-700 border-gray-300"}},ee=(ye=z==null?void 0:z.find(B=>B.clothingCategory))==null?void 0:ye.clothingCategory,ve=B=>{if(!B)return"";switch(B){case"winter":return h==="de"?"Winter":h==="fr"?"Hiver":"Winter";case"summer":return h==="de"?"Sommer":h==="fr"?"Ã‰tÃ©":"Summer";case"formal":return h==="de"?"Formell":h==="fr"?"Formel":"Formal";case"standard":return"Standard";default:return B}};return e.jsxs("details",{className:"bg-pink-50 border border-pink-300 rounded-lg p-3",onToggle:B=>{B.target.open&&(g||F)&&de()},children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-900 flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ“¸"}),h==="de"?"Referenzfotos":h==="fr"?"Photos de rÃ©fÃ©rence":"Reference Photos",e.jsxs("span",{className:"text-xs text-pink-600",children:["(",K,")"]}),ee&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-pink-200 text-pink-800 text-xs rounded",children:["ðŸ‘• ",ve(ee)]}),H&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded",children:["ðŸ“ ",v.length," ",h==="de"?"Wahrzeichen":"Landmark"]}),O&&e.jsx("span",{className:"ml-2 px-2 py-0.5 bg-indigo-200 text-indigo-800 text-xs rounded",children:"ðŸ”² VB Grid"}),M&&e.jsx("span",{className:"ml-2 text-xs text-gray-500 animate-pulse",children:"Loading..."})]}),X&&e.jsx("div",{className:"mt-3 text-sm text-red-600 bg-red-50 p-2 rounded",children:X}),C&&e.jsx("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2",children:z.map((B,xe)=>e.jsxs("div",{className:"bg-white rounded-lg p-2 border border-pink-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:B.name}),B.photoType&&e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap ${ie(B.photoType)}`,children:E(B.photoType)})]}),B.photoUrl?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:B.photoUrl,alt:`${B.name} - ${E(B.photoType||"unknown")}`,className:`w-full max-h-32 object-contain rounded border bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity ${B.isStyled?"border-purple-400 ring-2 ring-purple-200":"border-gray-200"}`,onClick:()=>A(B.photoUrl),title:"Click to enlarge"}),B.isStyled&&e.jsx("span",{className:"absolute top-1 right-1 px-1 py-0.5 text-[9px] font-bold bg-purple-500 text-white rounded",children:"ðŸŽ¨ STYLED"})]}),B.photoHash&&e.jsxs("div",{className:"mt-1 text-[9px] font-mono text-gray-500 bg-gray-100 px-1 py-0.5 rounded text-center",children:["ðŸ” ",B.photoHash]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:h==="de"?"Foto nicht geladen":"Photo not loaded"})]},xe))}),H&&e.jsxs("div",{className:C?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-amber-700 mb-2 flex items-center gap-1",children:["ðŸ“ ",h==="de"?"Wahrzeichen-Referenzfotos":h==="fr"?"Photos de monuments":"Landmark Reference Photos"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:v.map((B,xe)=>e.jsxs("div",{className:"bg-amber-50 rounded-lg p-2 border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:B.name}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-amber-100 text-amber-700 border-amber-300",children:"ðŸ“ LANDMARK"})]}),B.photoData?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:B.photoData,alt:`${B.name} landmark`,className:"w-full max-h-32 object-contain rounded border border-amber-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>A(B.photoData),title:"Click to enlarge"})}),B.attribution&&e.jsxs("div",{className:"mt-1 text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 rounded truncate",title:B.attribution,children:["ðŸ“· ",B.attribution]}),B.source&&e.jsxs("div",{className:"mt-0.5 text-[9px] text-gray-400",children:["Source: ",B.source]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:h==="de"?"Foto nicht geladen":"Photo not loaded"})]},xe))})]}),O&&e.jsxs("div",{className:C||H?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-indigo-700 mb-2 flex items-center gap-1",children:["ðŸ”² ",h==="de"?"Visual Bible Referenzgitter":h==="fr"?"Grille Visual Bible":"Visual Bible Reference Grid"]}),e.jsxs("div",{className:"bg-indigo-50 rounded-lg p-2 border border-indigo-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800",children:h==="de"?"Kombinierte Referenzen":h==="fr"?"RÃ©fÃ©rences combinÃ©es":"Combined References"}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-indigo-100 text-indigo-700 border-indigo-300",children:"ðŸ”² VB GRID"})]}),e.jsx("div",{className:"text-[10px] text-gray-500 mb-2",children:h==="de"?"SekundÃ¤re Charaktere, Tiere, Artefakte, Fahrzeuge und zusÃ¤tzliche Wahrzeichen":h==="fr"?"Personnages secondaires, animaux, artefacts, vÃ©hicules et monuments supplÃ©mentaires":"Secondary characters, animals, artifacts, vehicles, and additional landmarks"}),e.jsx("img",{src:o,alt:"Visual Bible Reference Grid",className:"w-full max-h-64 object-contain rounded border border-indigo-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>A(o),title:"Click to enlarge"})]})]}),e.jsx(po,{src:p,onClose:()=>A(null)})]})}function fo({pageNumber:r,scene:i,onSceneChange:o,onClose:h,onRegenerate:s,isRegenerating:R,imageRegenerationCost:p,characters:A=[],selectedCharacterIds:T=[],onCharacterSelectionChange:W,consistencyRegen:y}){const{language:I}=ir(),[M,D]=l.useState(!1),[X,j]=l.useState(!1),g=F=>{W&&(T.includes(F)?W(T.filter(de=>de!==F)):W([...T,F]))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(ct,{size:20}),I==="de"?`Szene bearbeiten - Seite ${r}`:I==="fr"?`Modifier la scÃ¨ne - Page ${r}`:`Edit Scene - Page ${r}`]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:I==="de"?"Bearbeiten Sie die Szenenbeschreibung und wÃ¤hlen Sie die Charaktere aus.":I==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages.":"Edit the scene description and select the characters."})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[A.length>0&&W&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(mn,{size:16}),I==="de"?"Charaktere in dieser Szene:":I==="fr"?"Personnages dans cette scÃ¨ne:":"Characters in this scene:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:A.map(F=>{const de=T.includes(F.id);return e.jsxs("button",{type:"button",onClick:()=>g(F.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${de?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:F.name}),de&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},F.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:I==="de"?"WÃ¤hlen Sie die Charaktere aus, die im Bild erscheinen sollen.":I==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre dans l'image.":"Select the characters that should appear in the image."})]}),y&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Kn,{className:"text-amber-600",size:20}),e.jsx("h4",{className:"font-semibold text-amber-800",children:I==="de"?"Konsistenz-Korrektur angewendet":I==="fr"?"Correction de cohÃ©rence appliquÃ©e":"Consistency Fix Applied"}),e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded",children:["Score: ",y.score,"%"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-amber-700 mb-2",children:I==="de"?"Behobene Probleme:":I==="fr"?"ProblÃ¨mes corrigÃ©s:":"Issues Fixed:"}),e.jsx("ul",{className:"text-sm text-amber-900 space-y-1",children:y.issues.map((F,de)=>e.jsxs("li",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium",children:[F.type.toUpperCase(),F.characterInvolved&&` (${F.characterInvolved})`,":"]}),e.jsx("span",{className:"text-amber-700 ml-2",children:F.description}),e.jsxs("span",{className:"text-amber-600 ml-2 text-xs",children:["â†’ ",F.recommendation]})]},de))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-1 text-center",children:"Original"}),e.jsx("img",{src:y.originalImage,alt:"Original",className:"w-full rounded-lg border border-gray-300",draggable:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-green-600 mb-1 text-center",children:I==="de"?"Korrigiert":I==="fr"?"CorrigÃ©":"Fixed"}),e.jsx("img",{src:y.fixedImage,alt:"Fixed",className:"w-full rounded-lg border-2 border-green-500",draggable:!1})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>D(!M),className:"flex items-center gap-1 text-xs text-gray-600 hover:text-gray-800",children:[M?e.jsx(Pn,{size:14}):e.jsx(Sr,{size:14}),I==="de"?"Original-Prompt":I==="fr"?"Prompt original":"Original Prompt"]}),M&&e.jsx("pre",{className:"text-xs bg-gray-100 p-2 rounded overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:y.originalPrompt}),e.jsxs("button",{onClick:()=>j(!X),className:"flex items-center gap-1 text-xs text-green-600 hover:text-green-800",children:[X?e.jsx(Pn,{size:14}):e.jsx(Sr,{size:14}),I==="de"?"Korrigierter Prompt (mit Korrekturen)":I==="fr"?"Prompt corrigÃ© (avec corrections)":"Fixed Prompt (with corrections)"]}),X&&e.jsx("pre",{className:"text-xs bg-green-50 p-2 rounded border border-green-200 overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:y.fixedPrompt})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:I==="de"?`Korrigiert am ${new Date(y.timestamp).toLocaleString()}`:I==="fr"?`CorrigÃ© le ${new Date(y.timestamp).toLocaleString()}`:`Fixed at ${new Date(y.timestamp).toLocaleString()}`}),y.clothing&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded",children:["ðŸŽ¨ ",y.clothing]})]}),y.avatarsUsed&&y.avatarsUsed.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-blue-50 rounded border border-blue-200",children:[e.jsx("p",{className:"text-xs font-medium text-blue-700 mb-1",children:I==="de"?"Verwendete Avatare:":I==="fr"?"Avatars utilisÃ©s:":"Avatars used:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:y.avatarsUsed.map((F,de)=>e.jsxs("span",{className:`text-xs px-2 py-1 rounded ${F.hasPhoto?"bg-green-100 text-green-700":"bg-gray-100 text-gray-500"}`,children:[F.name,F.category&&F.category!=="standard"&&e.jsxs("span",{className:"ml-1 opacity-75",children:["(",F.category,")"]}),!F.hasPhoto&&" âš ï¸"]},de))})]}),y.retryHistory&&y.retryHistory.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx(vs,{retryHistory:y.retryHistory,totalAttempts:y.totalAttempts||1,language:I})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:I==="de"?"Szenenbeschreibung:":I==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:i,onChange:F=>o(F.target.value),className:"w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y",placeholder:I==="de"?"Beschreiben Sie die Szene...":I==="fr"?"DÃ©crivez la scÃ¨ne...":"Describe the scene..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:I==="de"?"Tipp: Beschreiben Sie die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":I==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:T.length>0&&e.jsx("span",{children:I==="de"?`${T.length} Charakter(e) ausgewÃ¤hlt`:I==="fr"?`${T.length} personnage(s) sÃ©lectionnÃ©(s)`:`${T.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:h,disabled:R,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium disabled:opacity-50 order-2 sm:order-1",children:I==="de"?"Abbrechen":I==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:s,disabled:R||!i.trim(),className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${R||!i.trim()?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:R?e.jsxs(e.Fragment,{children:[e.jsx(nr,{size:16,className:"animate-spin"}),I==="de"?"Generiere...":I==="fr"?"GÃ©nÃ©ration...":"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(nr,{size:16}),I==="de"?"Neu generieren":I==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",p,")"]})]})})]})]})]})})}function bo({pageNumber:r,versions:i,onClose:o,onSelectVersion:h,developerMode:s=!1}){const{language:R}=ir();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Br,{size:20}),R==="de"?`Bildversionen - Seite ${r}`:R==="fr"?`Versions d'image - Page ${r}`:`Image Versions - Page ${r}`]}),e.jsx("button",{onClick:o,className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(zt,{size:20})})]}),e.jsxs("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:i.map((p,A)=>e.jsxs("div",{className:`relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${p.isActive?"border-green-500 ring-2 ring-green-200":"border-gray-200 hover:border-indigo-300"}`,onClick:()=>h(r,A),children:[e.jsx("img",{src:p.imageData,alt:`Version ${A+1}`,className:"w-full aspect-square object-cover"}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:A===0?"Original":`V${A+1}`}),p.isActive&&e.jsx("span",{className:"bg-green-500 px-2 py-0.5 rounded text-[10px] font-bold",children:R==="de"?"Aktiv":R==="fr"?"Actif":"Active"})]}),e.jsx("div",{className:"text-[10px] text-gray-300 mt-1",children:new Date(p.createdAt).toLocaleDateString()})]})]},A))}),s&&i.length>1&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold text-gray-700",children:R==="de"?"Szenen- und Prompt-Vergleich":R==="fr"?"Comparaison de scÃ¨nes et prompts":"Scene & Prompt Comparison"}),i.map((p,A)=>e.jsxs("details",{className:`rounded-lg p-3 ${p.isActive?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-medium text-gray-700",children:[A===0?"Original":`V${A+1}`,p.isActive&&e.jsx("span",{className:"ml-2 text-green-600 text-xs",children:"(Active)"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[p.userInput&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-purple-700",children:R==="de"?"Benutzer-Eingabe:":R==="fr"?"EntrÃ©e utilisateur:":"User Input:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-purple-50 p-2 rounded border border-purple-200 max-h-24 overflow-y-auto",children:p.userInput})]}),p.description&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700",children:R==="de"?"Erweiterte Szene:":R==="fr"?"ScÃ¨ne Ã©tendue:":"Expanded Scene:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-24 overflow-y-auto",children:p.description})]}),p.prompt&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-700",children:R==="de"?"API-Prompt:":R==="fr"?"Prompt API:":"API Prompt:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-32 overflow-y-auto",children:p.prompt})]}),p.modelId&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Model: ",p.modelId]})]})]},A))]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-sm text-gray-500",children:R==="de"?"Klicken Sie auf ein Bild, um es auszuwÃ¤hlen":R==="fr"?"Cliquez sur une image pour la sÃ©lectionner":"Click an image to select it"})]})})}function yo({src:r,title:i,onClose:o}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:o,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden",onClick:h=>h.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-2 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:i}),e.jsx("button",{onClick:o,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(zt,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50",children:e.jsx("img",{src:r,alt:i,className:"max-w-full max-h-[80vh] object-contain mx-auto"})})]})})}function vo({beforeImage:r,afterImage:i,diffImage:o,title:h,onClose:s}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:s,children:e.jsxs("div",{className:"relative bg-white rounded-lg overflow-hidden max-w-[95vw] max-h-[95vh]",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:h}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(zt,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50 overflow-auto max-h-[calc(95vh-60px)]",children:e.jsxs("div",{className:`grid gap-4 ${o?"grid-cols-1 lg:grid-cols-3":"grid-cols-1 lg:grid-cols-2"}`,children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-red-100 px-3 py-1 rounded-full",children:"Before"}),e.jsx("img",{src:r,alt:"Before repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-green-100 px-3 py-1 rounded-full",children:"After"}),e.jsx("img",{src:i,alt:"After repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),o&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-purple-100 px-3 py-1 rounded-full",children:"Diff (changes in magenta)"}),e.jsx("img",{src:o,alt:"Difference",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]})]})})]})})}const Bn={en:{adventure:"Adventure","life-challenge":"Life Challenge",educational:"Educational",historical:"Historical"},de:{adventure:"Abenteuer","life-challenge":"Lebensherausforderung",educational:"Bildung",historical:"Historisch"},fr:{adventure:"Aventure","life-challenge":"DÃ©fi de vie",educational:"Ã‰ducatif",historical:"Historique"}},Mn={en:{"1st-grade":"Picture Book (1st Grade)",standard:"Standard",advanced:"Advanced"},de:{"1st-grade":"Bilderbuch (1. Klasse)",standard:"Standard",advanced:"Fortgeschritten"},fr:{"1st-grade":"Livre illustrÃ© (1Ã¨re annÃ©e)",standard:"Standard",advanced:"AvancÃ©"}},jo={"de-CH":"Schweizerdeutsch","de-DE":"Deutsch (Deutschland)",en:"English",fr:"FranÃ§ais"};function No({settings:r,language:i}){var D,X;const[o,h]=l.useState(!1),s=j=>{const g={en:{title:"Story Info",category:"Category",topic:"Topic",theme:"Theme",storyType:"Story Type",storyDetails:"Story Idea",artStyle:"Art Style",language:"Language",readingLevel:"Reading Level",pages:"Length",dedication:"Dedication",mainCharacters:"Main Characters",otherCharacters:"Other Characters",relationships:"Relationships",season:"Season",location:"Location",noData:"Not specified",spring:"Spring",summer:"Summer",autumn:"Autumn",winter:"Winter"},de:{title:"Story-Info",category:"Kategorie",topic:"Thema",theme:"Thema",storyType:"Story-Typ",storyDetails:"Story-Idee",artStyle:"Kunststil",language:"Sprache",readingLevel:"Lesestufe",pages:"LÃ¤nge",dedication:"Widmung",mainCharacters:"Hauptfiguren",otherCharacters:"Andere Figuren",relationships:"Beziehungen",season:"Jahreszeit",location:"Ort",noData:"Nicht angegeben",spring:"FrÃ¼hling",summer:"Sommer",autumn:"Herbst",winter:"Winter"},fr:{title:"Info histoire",category:"CatÃ©gorie",topic:"Sujet",theme:"ThÃ¨me",storyType:"Type d'histoire",storyDetails:"IdÃ©e d'histoire",artStyle:"Style artistique",language:"Langue",readingLevel:"Niveau de lecture",pages:"Longueur",dedication:"DÃ©dicace",mainCharacters:"Personnages principaux",otherCharacters:"Autres personnages",relationships:"Relations",season:"Saison",location:"Lieu",noData:"Non spÃ©cifiÃ©",spring:"Printemps",summer:"Ã‰tÃ©",autumn:"Automne",winter:"Hiver"}};return(g[i]||g.en)[j]||j},R=j=>(Bn[i]||Bn.en)[j]||j,p=j=>(Mn[i]||Mn.en)[j]||j,A=(j,g)=>j==null||j===""?e.jsx("span",{className:"text-gray-400 italic",children:s("noData")}):e.jsx("span",{className:"text-gray-800",children:j}),T=r.mainCharacters||[],W=((D=r.characters)==null?void 0:D.filter(j=>T.includes(j.id)))||[],y=((X=r.characters)==null?void 0:X.filter(j=>!T.includes(j.id)))||[],I=j=>s(j)||j,M=()=>{if(!r.userLocation)return null;const j=[r.userLocation.city,r.userLocation.region,r.userLocation.country].filter(Boolean);return j.length>0?j.join(", "):null};return e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>h(!o),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-amber-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Li,{size:16,className:"text-amber-600"}),e.jsx("span",{className:"font-medium text-amber-800",children:s("title")}),e.jsx("span",{className:"text-xs bg-amber-200 text-amber-700 px-2 py-0.5 rounded",children:"DEV"})]}),o?e.jsx(Sr,{size:18,className:"text-amber-600"}):e.jsx(nn,{size:18,className:"text-amber-600"})]}),o&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[W.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(rn,{size:12}),s("mainCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:W.map(j=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800 border border-indigo-200",children:[e.jsx(rn,{size:10}),e.jsx("span",{children:j.name})]},j.id))})]}),y.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(mn,{size:12}),s("otherCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:y.map(j=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-200",children:[e.jsx(rn,{size:10}),e.jsx("span",{children:j.name})]},j.id))})]}),r.relationships&&Object.keys(r.relationships).length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-2",children:s("relationships")}),e.jsx("div",{className:"text-xs bg-white/50 p-2 rounded border border-amber-100 space-y-1",children:Object.entries(r.relationships).map(([j,g])=>{var C,H;const[F,de]=j.split("-").map(O=>parseInt(O,10)),z=(C=r.characters)==null?void 0:C.find(O=>O.id===F),v=(H=r.characters)==null?void 0:H.find(O=>O.id===de);return!z||!v?null:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-amber-600 font-medium whitespace-nowrap",children:[z.name," â†’ ",v.name,":"]}),e.jsx("span",{className:"text-gray-700",children:g})]},j)})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Qi,{size:12}),s("language")]}),e.jsx("div",{className:"text-sm",children:r.language?jo[r.language]||r.language:A(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("readingLevel")}),e.jsx("div",{className:"text-sm",children:r.languageLevel?p(r.languageLevel):A(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("pages")}),e.jsx("div",{className:"text-sm",children:r.pages?`${r.pages} ${i==="de"?"Seiten":"pages"}`:A(void 0)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("season")}),e.jsx("div",{className:"text-sm",children:r.season?I(r.season):A(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("location")}),e.jsx("div",{className:"text-sm",children:M()||A(void 0)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Qn,{size:12}),s("artStyle")]}),e.jsx("div",{className:"text-sm capitalize",children:A(r.artStyle)})]})]}),r.storyDetails&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(ys,{size:12}),s("storyDetails")]}),e.jsx("div",{className:"text-sm bg-white/50 p-2 rounded border border-amber-100 whitespace-pre-wrap",children:r.storyDetails})]}),(r.storyCategory||r.storyTheme||r.storyTopic)&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-amber-100",children:[r.storyCategory&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Wi,{size:12}),s("category")]}),e.jsx("div",{className:"text-sm",children:R(r.storyCategory)})]}),(r.storyTheme||r.storyTopic)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:r.storyCategory==="adventure"?s("theme"):s("topic")}),e.jsx("div",{className:"text-sm",children:r.storyCategory==="adventure"?r.storyTheme:r.storyTopic})]})]})]})]})}function wo({storyId:r,onShareStatusChange:i,variant:o="compact"}){const{language:h}=ir(),[s,R]=l.useState(!1),[p,A]=l.useState(null),[T,W]=l.useState(!1),[y,I]=l.useState(!1),[M,D]=l.useState(null),X=o==="full",j={share:h==="de"?"Teilen":h==="fr"?"Partager":"Share",shareStory:h==="de"?"Geschichte teilen":h==="fr"?"Partager l'histoire":"Share Story",enableSharing:h==="de"?"Link aktivieren":h==="fr"?"Activer le lien":"Enable sharing",disableSharing:h==="de"?"Link deaktivieren":h==="fr"?"DÃ©sactiver le lien":"Disable sharing",copyLink:h==="de"?"Link kopieren":h==="fr"?"Copier le lien":"Copy link",copied:h==="de"?"Kopiert!":h==="fr"?"CopiÃ©!":"Copied!",shareWhatsApp:h==="de"?"Per WhatsApp teilen":h==="fr"?"Partager sur WhatsApp":"Share on WhatsApp",sharingEnabled:h==="de"?"Teilen aktiv":h==="fr"?"Partage actif":"Sharing enabled",sharingDisabled:h==="de"?"Teilen inaktiv":h==="fr"?"Partage inactif":"Sharing disabled",anyoneWithLink:h==="de"?"Jeder mit dem Link kann die Geschichte lesen":h==="fr"?"Toute personne avec le lien peut lire l'histoire":"Anyone with the link can read the story",errorLoading:h==="de"?"Fehler beim Laden":h==="fr"?"Erreur de chargement":"Error loading"};l.useEffect(()=>{s&&!p&&g()},[s]);const g=async()=>{W(!0),D(null);try{const v=localStorage.getItem("auth_token"),C=await fetch(`/api/stories/${r}/share-status`,{headers:v?{Authorization:`Bearer ${v}`}:{}});if(!C.ok)throw new Error("Failed to fetch status");const H=await C.json();A(H)}catch{D(j.errorLoading)}finally{W(!1)}},F=async()=>{W(!0),D(null);try{const C=(p==null?void 0:p.isShared)?"DELETE":"POST",H=localStorage.getItem("auth_token"),O=await fetch(`/api/stories/${r}/share`,{method:C,headers:H?{Authorization:`Bearer ${H}`}:{}});if(!O.ok)throw new Error("Failed to toggle sharing");const K=await O.json();A({isShared:K.isShared,shareToken:K.shareToken,shareUrl:K.shareUrl}),i==null||i(K.isShared)}catch{D("Failed to update sharing")}finally{W(!1)}},de=async()=>{if(p!=null&&p.shareUrl)try{await navigator.clipboard.writeText(p.shareUrl),I(!0),setTimeout(()=>I(!1),2e3)}catch{const C=document.createElement("textarea");C.value=p.shareUrl,document.body.appendChild(C),C.select(),document.execCommand("copy"),document.body.removeChild(C),I(!0),setTimeout(()=>I(!1),2e3)}},z=()=>{if(!(p!=null&&p.shareUrl))return;const v=encodeURIComponent(p.shareUrl);window.open(`https://wa.me/?text=${v}`,"_blank")};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>R(!s),className:X?"bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full hover:bg-indigo-600":"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg",title:j.share,children:[e.jsx(Rn,{className:"w-4 h-4"}),e.jsx("span",{className:X?"":"hidden sm:inline",children:j.share}),(p==null?void 0:p.isShared)&&e.jsx("span",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>R(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Rn,{className:"w-5 h-5 text-blue-600"}),j.shareStory]})}),e.jsx("div",{className:"p-4 space-y-4",children:T&&!p?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(Ye,{className:"w-6 h-6 animate-spin text-blue-500"})}):M?e.jsx("div",{className:"text-red-500 text-sm py-2",children:M}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p!=null&&p.isShared?e.jsx(Xi,{className:"w-5 h-5 text-green-500"}):e.jsx(Yi,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:p!=null&&p.isShared?"text-green-700":"text-gray-600",children:p!=null&&p.isShared?j.sharingEnabled:j.sharingDisabled})]}),e.jsx("button",{onClick:F,disabled:T,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${p!=null&&p.isShared?"bg-red-100 text-red-700 hover:bg-red-200":"bg-green-100 text-green-700 hover:bg-green-200"} disabled:opacity-50`,children:T?e.jsx(Ye,{className:"w-4 h-4 animate-spin"}):p!=null&&p.isShared?j.disableSharing:j.enableSharing})]}),(p==null?void 0:p.isShared)&&p.shareUrl&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xs text-gray-500",children:j.anyoneWithLink}),e.jsx("button",{onClick:de,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-colors",children:y?e.jsxs(e.Fragment,{children:[e.jsx(qi,{className:"w-4 h-4 text-green-500"}),j.copied]}):e.jsxs(e.Fragment,{children:[e.jsx(Ki,{className:"w-4 h-4"}),j.copyLink]})}),e.jsxs("button",{onClick:z,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors",children:[e.jsx(to,{className:"w-4 h-4"}),j.shareWhatsApp]})]})]})})]})]})]})}function So({title:r,dedication:i,story:o,outline:h,outlinePrompt:s,outlineModelId:R,outlineUsage:p,storyTextPrompts:A=[],visualBible:T,sceneImages:W,sceneDescriptions:y=[],coverImages:I,regeneratingCovers:M=new Set,languageLevel:D="standard",storyLanguage:X,isGenerating:j=!1,onDownloadPdf:g,onAddToBook:F,onPrintBook:de,onCreateAnother:z,onDownloadTxt:v,onRegenerateImage:C,onRegenerateCover:H,characters:O=[],onEditImage:K,onEditCover:E,onRepairImage:ie,onIteratePage:ee,onRevertRepair:ve,onVisualBibleChange:ye,storyId:B,developerMode:xe=!1,styledAvatarGeneration:De=[],costumedAvatarGeneration:_e=[],generationLog:Se=[],finalChecksReport:U,clothingRequirements:Ne,isPartial:Qe=!1,failureReason:pe,generatedPages:he,totalPages:q,progressiveMode:Ie=!1,progressiveData:We,completedPageImages:Xe={},originalStory:Pt,onSaveStoryText:bt,onSaveTitleChange:or,userCredits:es=0,imageRegenerationCost:Kt=5,isImpersonating:Zs=!1,onSelectImageVersion:Ys,generationSettings:Cr,onRefreshStory:kr}){var ca,Rs,Es,ma,Yt,Xt,Fs,er,ua;const{t:Xs,language:a}=ir(),ke=X?X.startsWith("de")?"de":X:a,lt=Zs||es===-1||es>=Kt,[we,Ns]=l.useState(null),[yt,lr]=l.useState(""),[Jt,Mr]=l.useState(!1),[dr,ts]=l.useState(o),[tt,ea]=l.useState(!1),[$t,Qt]=l.useState(!1),[Ae,Ar]=l.useState(r||""),[Oe,rs]=l.useState(!1),[Ge,Pr]=l.useState(null),[Ue,cr]=l.useState(null),[,jt]=l.useState(!1),[mt,be]=l.useState(new Set),[ue,mr]=l.useState(null),[ut,w]=l.useState(null),[Pe,ws]=l.useState(null),[$r,ta]=l.useState(null),[at,ra]=l.useState(null),[et,sa]=l.useState(null),[ur,Ir]=l.useState(null),[gt,Ss]=l.useState(null),[gr,ss]=l.useState("square"),[Bt,as]=l.useState(!1),[Cs,Ga]=l.useState({}),[ks,aa]=l.useState(new Set),_a=async t=>{if(!(!B||Cs[t]||ks.has(t))){aa(u=>new Set(u).add(t));try{const u=localStorage.getItem("auth_token"),c=await fetch(`/api/stories/${B}/visual-bible-image/${t}`,{headers:u?{Authorization:`Bearer ${u}`}:{}});if(c.ok){const S=await c.json();Ga(d=>({...d,[t]:S.imageData}))}}catch(u){console.error(`Failed to load reference image for ${t}:`,u)}finally{aa(u=>{const c=new Set(u);return c.delete(t),c})}}},hr=(t,u)=>{if(!u||!xe)return null;const c=Cs[t],S=ks.has(t);return c?e.jsx("img",{src:c,alt:"Reference",className:"w-16 h-16 object-cover rounded border border-rose-300 cursor-pointer hover:opacity-80",onClick:()=>Ir({src:c,title:"Reference Image"})}):e.jsx("button",{onClick:()=>_a(t),disabled:S,className:"w-16 h-16 flex items-center justify-center bg-rose-100 border border-rose-300 rounded text-rose-500 hover:bg-rose-200 disabled:opacity-50",title:"Load reference image",children:S?e.jsx(Ye,{size:16,className:"animate-spin"}):e.jsx(Br,{size:16})})},[ns,As]=l.useState({}),[Lr,is]=l.useState(new Set),Ps=async(t,u)=>{const c=`${t}-${u}`;if(!(!B||ns[c]||Lr.has(c))){is(S=>new Set(S).add(c));try{const S=await Fe.getAvatarGenerationImage(B,t,u);S&&As(d=>({...d,[c]:S}))}catch(S){console.error(`Failed to load avatar generation images for ${c}:`,S)}finally{is(S=>{const d=new Set(S);return d.delete(c),d})}}},[Or,ht]=l.useState({}),[Gr,It]=l.useState(new Set),$s=async t=>{if(!(!B||Or[t]||Gr.has(t))){It(u=>new Set(u).add(t));try{const u=await Fe.getEntityGridImage(B,t);u!=null&&u.gridImage&&ht(c=>({...c,[t]:u.gridImage}))}catch(u){console.error(`Failed to load entity grid image for ${t}:`,u)}finally{It(u=>{const c=new Set(u);return c.delete(t),c})}}},Tr=async(t,u,c)=>new Promise((S,d)=>{const J=new Image;J.onload=()=>{const ne=document.createElement("canvas"),Be=ne.getContext("2d");if(!Be){d(new Error("Could not get canvas context"));return}const{cellSize:$e,cols:Ze}=c,ft=Math.floor(u/Ze),oe=u%Ze*$e,it=ft*$e;ne.width=$e,ne.height=$e,Be.drawImage(J,oe,it,$e,$e,0,0,$e,$e),S(ne.toDataURL("image/png"))},J.onerror=()=>d(new Error("Failed to load grid image")),J.src=t}),na=async(t,u)=>{try{const c=t.manifest.cells[u],S=await Tr(t.gridImage,u,t.manifest),d=c.isReference?"Reference":`Page ${c.pageNumber}`,J=c.clothing&&c.clothing!=="standard"?` (${c.clothing})`:"";Ir({src:S,title:`${t.entityName} - ${d}${J}`})}catch(c){console.error("Failed to crop cell:",c)}},Is=(t,u,c,S)=>{var ne,Be,$e,Ze,ft;const d=`${t}-${u}`,J=ns[d];return J&&J[S]?J[S]:S==="output"&&((ne=c.output)!=null&&ne.imageData)?c.output.imageData:S==="facePhoto"&&((Be=c.inputs.facePhoto)!=null&&Be.imageData)?c.inputs.facePhoto.imageData:S==="originalAvatar"&&"originalAvatar"in c.inputs&&(($e=c.inputs.originalAvatar)!=null&&$e.imageData)?c.inputs.originalAvatar.imageData:S==="styleSample"&&"styleSample"in c.inputs&&((Ze=c.inputs.styleSample)!=null&&Ze.imageData)?c.inputs.styleSample.imageData:S==="standardAvatar"&&"standardAvatar"in c.inputs&&((ft=c.inputs.standardAvatar)!=null&&ft.imageData)&&c.inputs.standardAvatar.imageData||null},xr=(t,u,c,S,d,J)=>{const ne=Is(t,u,c,S),Be=`${t}-${u}`,$e=Lr.has(Be),Ze=!!ns[Be];return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:d}),ne?e.jsx("img",{src:ne,alt:d,className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>Ir({src:ne,title:d}),title:J?`${J} KB - Click to enlarge`:"Click to enlarge"}):J?e.jsx("button",{onClick:()=>Ps(t,u),disabled:$e||Ze,className:"w-16 h-16 flex flex-col items-center justify-center bg-blue-50 border border-blue-300 rounded text-blue-500 hover:bg-blue-100 disabled:opacity-50 text-[10px]",title:"Click to load images",children:$e?e.jsx(Ye,{size:16,className:"animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Br,{size:14}),e.jsxs("span",{className:"mt-0.5",children:[J," KB"]})]})}):e.jsx("span",{className:"text-gray-400 italic text-[10px]",children:"N/A"})]})};l.useEffect(()=>{Jt||ts(o)},[o,Jt]),l.useEffect(()=>{$t||Ar(r||"")},[r,$t]);const Dr=async()=>{if(bt){ea(!0);try{await bt(dr),Mr(!1)}catch(t){console.error("Failed to save story text:",t)}finally{ea(!1)}}},_r=async()=>{if(!(!or||!Ae.trim())){rs(!0);try{await or(Ae.trim()),Qt(!1)}catch(t){console.error("Failed to save title:",t)}finally{rs(!1)}}},ia=()=>{ts(o),Mr(!1)},Mt=async t=>{if(!(!ie||ut!==null)){w(t);try{await ie(t)}catch(u){console.error("Failed to repair image:",u)}finally{w(null)}}},Lt=async t=>{if(!(!ee||et!==null)){sa(t);try{await ee(t)}catch(u){console.error("Failed to iterate page:",u)}finally{sa(null)}}},xt=async t=>{if(!(!B||Pe!==null)){ws(t);try{const u=await fetch(`/api/stories/${B}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({entityName:t,entityType:"character"})});if(!u.ok){const S=await u.json();throw new Error(S.error||"Repair failed")}const c=await u.json();console.log("Entity repair result:",c),c.success&&!c.noChanges&&(kr?await kr():window.location.reload())}catch(u){console.error("Failed to repair entity consistency:",u),alert(`Failed to repair: ${u instanceof Error?u.message:"Unknown error"}`)}finally{ws(null)}}},Hr=async(t,u)=>{if(!(!B||at!==null)){ra({entity:t,page:u});try{const c=await fetch(`/api/stories/${B}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({entityName:t,entityType:"character",pageNumber:u})});if(!c.ok){const d=await c.json();throw new Error(d.error||"Repair failed")}const S=await c.json();console.log("Single-page entity repair result:",S),S.success&&(kr?await kr():window.location.reload())}catch(c){console.error("Failed to repair single page:",c),alert(`Failed to repair page ${u}: ${c instanceof Error?c.message:"Unknown error"}`)}finally{ra(null)}}},os=async(t,u)=>{if(!(!B||$r!==null)){ta(t);try{const c=await fetch(`/api/stories/${B}/repair/image/${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({correctionNotes:`${u.type||""}: ${u.description||""}
Target: ${u.canonicalVersion||""}
Fix: ${u.recommendation||""}`})});if(!c.ok){const d=await c.json();throw new Error(d.error||"Repair failed")}const S=await c.json();console.log("Image issue repair result:",S),S.success&&(kr?await kr():window.location.reload())}catch(c){console.error("Failed to repair image issue:",c),alert(`Failed to repair: ${c instanceof Error?c.message:"Unknown error"}`)}finally{ta(null)}}},Nt=(t,u)=>{const c=dr.split(/(?=---\s*(?:Page|Seite)\s+\d+\s*---|(?=##\s*(?:Page|Seite)\s+\d+))/i);let S=0;for(let J=0;J<c.length;J++)if(/^(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i.test(c[J].trim())){S=J;break}const d=S+t;if(d<c.length){const J=c[d].match(/^(---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i),ne=J?J[0]:"";c[d]=ne+`
`+u.trim()+`
`}ts(c.join(""))},Ot=t=>{const u=W.find(c=>c.pageNumber===t);return(u==null?void 0:u.imageVersions)||[]},Tt=async(t,u)=>{if(Ys)try{await Ys(t,u),Pr(null)}catch(c){console.error("Failed to select image version:",c)}},oa=t=>{if(!t)return"";let u;if(typeof t!="string"){const J=t;if(J.output)if(typeof J.output=="string")u=J.output;else if(typeof J.output=="object"){const ne=J.output.translatedSummary||J.output.imageSummary||"";if(ne)return ne;u=JSON.stringify(t)}else u=JSON.stringify(t);else u=JSON.stringify(t)}else u=t;if(u.trim().startsWith("{"))try{const J=JSON.parse(u);if(J.output){if(typeof J.output=="string")u=J.output;else if(typeof J.output=="object"){const ne=J.output.translatedSummary||J.output.imageSummary;if(ne)return ne}}}catch{}const c=u.match(/(?:#{1,3}\s*)?(?:\*\*)?6\.?\s*(?:\*\*)?\s*\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*\*?\*?\s*:?\s*\n?([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n---|\n```|$)/i);if(c&&c[2]&&c[2].trim())return c[2].trim();const S=u.match(/(?:#{1,3}\s*)?\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*:?\s*\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n\*\*|\n#{1,3}\s|$)/i);if(S&&S[2]&&S[2].trim())return S[2].trim();if(!u.includes("**")&&u.length<1e3)return u.trim();const d=u.match(/\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:\*\*)?\d+\.\s*\*\*|\n\s*\*\*\d+\.|$)/i);return d&&d[2]&&d[2].trim()?d[2].trim():u.substring(0,500).trim()+"..."},pt=t=>{if(!t||!O.length)return O.map(S=>S.id);let u;if(typeof t!="string"){const S=t;u=S.output&&typeof S.output=="string"?S.output:JSON.stringify(t)}else u=t;if(u.trim().startsWith("{"))try{const S=JSON.parse(u);S.output&&typeof S.output=="string"&&(u=S.output)}catch{}const c=u.toLowerCase();return O.filter(S=>c.includes(S.name.toLowerCase())).map(S=>S.id)},ls=t=>{const u=W.find(ne=>ne.pageNumber===t),c=y.find(ne=>ne.pageNumber===t),S=(u==null?void 0:u.description)||(c==null?void 0:c.description)||"",d=(c==null?void 0:c.translatedSummary)||oa(S)||(c==null?void 0:c.imageSummary)||"",J=pt(S);cr({pageNumber:t,scene:d,selectedCharacterIds:J})},pr=async()=>{if(!Ue||!C)return;const t=Ue.pageNumber,u=Ue.scene,c=Ue.selectedCharacterIds;cr(null),be(S=>new Set(S).add(t)),jt(!0);try{await C(t,u,c)}catch(S){console.error("Failed to regenerate image:",S)}finally{be(S=>{const d=new Set(S);return d.delete(t),d}),be(S=>(S.size===0&&jt(!1),S))}},Vr=t=>{let u="",c=[];if(t==="front"&&(I!=null&&I.frontCover)){const ne=I.frontCover;typeof ne=="object"&&(u=ne.description||"",c=ne.referencePhotos||[])}else if(t==="initial"&&(I!=null&&I.initialPage)){const ne=I.initialPage;typeof ne=="object"&&(u=ne.description||"",c=ne.referencePhotos||[])}else if(t==="back"&&(I!=null&&I.backCover)){const ne=I.backCover;typeof ne=="object"&&(u=ne.description||"",c=ne.referencePhotos||[])}let S=[];c.length>0&&O.length>0&&(S=O.filter(ne=>c.some(Be=>Be.name===ne.name)).map(ne=>ne.id)),S.length===0&&(S=O.map(ne=>ne.id)),mr({coverType:t,scene:u,selectedCharacterIds:S,title:t==="front"?r:void 0,dedication:t==="initial"?i:void 0})},fr=async()=>{if(!ue||!H)return;const{coverType:t,scene:u,selectedCharacterIds:c,title:S,dedication:d}=ue;mr(null);try{await H(t,u,c,S,d)}catch(J){console.error("Failed to regenerate cover:",J)}},Gt=(t,u,c,S)=>{Ns({type:t,id:u,field:c}),lr(S||"")},Dt=()=>{if(!we||!T||!ye)return;const{type:t,id:u,field:c}=we,S={...T};if(t==="secondaryCharacter")S.secondaryCharacters=(S.secondaryCharacters||[]).map(d=>d.id===u?{...d,[c]:yt}:d);else if(t==="animal")S.animals=(S.animals||[]).map(d=>d.id===u?{...d,[c]:yt}:d);else if(t==="artifact")S.artifacts=(S.artifacts||[]).map(d=>d.id===u?{...d,[c]:yt}:d);else if(t==="location")S.locations=(S.locations||[]).map(d=>d.id===u?{...d,[c]:yt}:d);else if(t==="mainCharacter"){const d=parseInt(u);S.mainCharacters=(S.mainCharacters||[]).map(J=>J.id!==d?J:c==="physical.face"?{...J,physical:{...J.physical,face:yt}}:c==="physical.hair"?{...J,physical:{...J.physical,hair:yt}}:c==="physical.build"?{...J,physical:{...J.physical,build:yt}}:J)}ye(S),Ns(null),lr("")},Zt=()=>{Ns(null),lr("")},_t=(t=>t?t.split(/(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i).slice(1).filter(c=>c.trim().length>0):[])(Jt?dr:o),wt=W.length>0,ds=D==="1st-grade",da=(()=>{if(!Ie)return _t.length;if(_t.length===0)return 0;let t=1;for(let u=2;u<=_t.length;u++){const c=u-1;if(W.some(d=>d.pageNumber===c&&d.imageData)||!!Xe[c])t=u;else break}return t})(),Ds=(We==null?void 0:We.totalPages)||_t.length;We!=null&&We.totalScenes||W.length||Math.ceil(Ds/(ds?1:2));const Ht=t=>t?typeof t=="string"?t:t.imageData||null:null,qr=t=>t?typeof t=="string"?{imageData:t}:t:null,Ur=t=>{var S,d;const c=((S=y.find(J=>J.pageNumber===t))==null?void 0:S.description)||((d=W.find(J=>J.pageNumber===t))==null?void 0:d.description);if(c){if(typeof c=="string")try{const J=JSON.parse(c);return JSON.stringify(J,null,2)}catch{return c}return typeof c=="object"?JSON.stringify(c,null,2):String(c)}},Rr=t=>{const u=y.find(c=>c.pageNumber===t);return t===1&&u&&(console.log("[StoryDisplay] Page 1 scene keys:",Object.keys(u)),console.log("[StoryDisplay] Page 1 has outlineExtract:",!!u.outlineExtract),console.log("[StoryDisplay] Page 1 has scenePrompt:",!!u.scenePrompt)),u==null?void 0:u.outlineExtract},St=t=>{var u;return(u=y.find(c=>c.pageNumber===t))==null?void 0:u.scenePrompt},Vt=t=>{var u;return(u=y.find(c=>c.pageNumber===t))==null?void 0:u.textModelId};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center gap-2",children:$t?e.jsxs("div",{className:"flex items-center gap-2 w-full max-w-2xl",children:[e.jsx("input",{type:"text",value:Ae,onChange:t=>Ar(t.target.value),className:"flex-1 text-2xl md:text-3xl font-bold text-gray-800 text-center border-2 border-indigo-300 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500",autoFocus:!0,onKeyDown:t=>{t.key==="Enter"&&_r(),t.key==="Escape"&&(Ar(r||""),Qt(!1))}}),e.jsx("button",{onClick:_r,disabled:Oe||!Ae.trim(),className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",title:a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save",children:Oe?e.jsx(Yr,{className:"animate-spin",size:20}):e.jsx(fs,{size:20})}),e.jsx("button",{onClick:()=>{Ar(r||""),Qt(!1)},disabled:Oe,className:"p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",title:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel",children:e.jsx(zt,{size:20})})]}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 text-center",children:r||Xs.yourStory}),or&&!j&&e.jsx("button",{onClick:()=>Qt(!0),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors",title:a==="de"?"Titel bearbeiten":a==="fr"?"Modifier le titre":"Edit title",children:e.jsx(ct,{size:18})})]})}),Qe&&e.jsx("div",{className:"bg-amber-50 border-2 border-amber-400 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-amber-500 text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-amber-800",children:a==="de"?"UnvollstÃ¤ndige Geschichte":a==="fr"?"Histoire incomplÃ¨te":"Incomplete Story"}),e.jsx("p",{className:"text-amber-700 text-sm mt-1",children:a==="de"?`Diese Geschichte konnte nicht vollstÃ¤ndig generiert werden. ${he||W.length} von ${q||"unbekannt"} Seiten wurden erstellt.`:a==="fr"?`Cette histoire n'a pas pu Ãªtre gÃ©nÃ©rÃ©e complÃ¨tement. ${he||W.length} sur ${q||"inconnu"} pages ont Ã©tÃ© crÃ©Ã©es.`:`This story could not be fully generated. ${he||W.length} of ${q||"unknown"} pages were created.`}),pe&&xe&&e.jsxs("details",{className:"mt-2 text-sm",children:[e.jsx("summary",{className:"cursor-pointer text-amber-600 hover:text-amber-700",children:a==="de"?"Fehlerdetails":a==="fr"?"DÃ©tails de l'erreur":"Error details"}),e.jsx("p",{className:"mt-1 bg-amber-100 p-2 rounded text-amber-800 font-mono text-xs",children:pe})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[wt&&B&&F&&e.jsxs("button",{onClick:F,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Tn,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),wt&&g&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>as(!Bt),disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ys,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Sr,{size:14,className:`transition-transform ${Bt?"rotate-180":""}`})]}),Bt&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:gr==="square",onChange:()=>ss("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:gr==="A4",onChange:()=>ss("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{g(gr),as(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),wt&&B&&!j&&e.jsx(wo,{storyId:B,variant:"full"}),z&&e.jsxs("button",{onClick:z,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx($n,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]}),xe&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[v&&e.jsxs("button",{onClick:v,className:"bg-gray-500 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 hover:bg-gray-600",children:[e.jsx(Xr,{size:14})," TXT"]}),wt&&B&&de&&e.jsxs("button",{onClick:de,disabled:j,className:`bg-yellow-500 text-black px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 ${j?"opacity-50 cursor-not-allowed":"hover:bg-yellow-600"}`,children:[e.jsx(La,{size:14})," Print (DEV)"]})]}),xe&&Cr&&e.jsx("div",{className:"mt-4",children:e.jsx(No,{settings:Cr,language:a})}),xe&&e.jsxs("div",{className:"space-y-4 mt-6",children:[h&&e.jsxs("details",{className:"bg-purple-50 border-2 border-purple-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-purple-800 hover:text-purple-900 flex items-center gap-2",children:[e.jsx(ys,{size:20}),ds?a==="de"?"VollstÃ¤ndige API-Ausgabe (Kombiniert)":a==="fr"?"Sortie API complÃ¨te (CombinÃ©e)":"Full API Output (Combined)":a==="de"?"VollstÃ¤ndige API-Ausgabe (Outline)":a==="fr"?"Sortie API complÃ¨te (Plan)":"Full API Output (Outline)",R&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-purple-600",children:["(",R,")"]}),p&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-purple-500",children:["[",p.input_tokens.toLocaleString()," in / ",p.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[s&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:s})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:ds?a==="de"?"ðŸ“¥ API-Antwort (Kombiniert)":a==="fr"?"ðŸ“¥ RÃ©ponse API (CombinÃ©e)":"ðŸ“¥ API Response (Combined)":a==="de"?"ðŸ“¥ API-Antwort (Outline)":a==="fr"?"ðŸ“¥ RÃ©ponse API (Plan)":"ðŸ“¥ API Response (Outline)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:h})]})]})]}),o&&A.length>0&&e.jsxs("details",{className:"bg-amber-50 border-2 border-amber-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(La,{size:20}),a==="de"?"VollstÃ¤ndige API-Ausgabe (Story-Text)":a==="fr"?"Sortie API complÃ¨te (Texte)":"Full API Output (Story Text)",((ca=A[0])==null?void 0:ca.modelId)&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-amber-600",children:["(",A[0].modelId,")"]}),((Rs=A[0])==null?void 0:Rs.usage)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-500",children:["[",A[0].usage.input_tokens.toLocaleString()," in / ",A[0].usage.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((Es=A[0])==null?void 0:Es.prompt)||"No prompt available"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¥ Rohe API-Antwort (ungefiltert)":a==="fr"?"ðŸ“¥ RÃ©ponse API brute (non filtrÃ©e)":"ðŸ“¥ Raw API Response (unfiltered)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((ma=A[0])==null?void 0:ma.rawResponse)||o})]})]})]}),T&&e.jsxs("details",{className:"bg-rose-50 border-2 border-rose-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-rose-800 hover:text-rose-900 flex items-center gap-2",children:[e.jsx(La,{size:20}),a==="de"?"Visual Bible (Wiederkehrende Elemente)":a==="fr"?"Bible Visuelle (Ã‰lÃ©ments RÃ©currents)":"Visual Bible (Recurring Elements)",T.changeLog&&T.changeLog.length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-rose-200 text-rose-800 rounded-full text-xs font-medium",children:[T.changeLog.length," ",a==="de"?"Ã„nderungen":a==="fr"?"changements":"changes"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[T.mainCharacters&&T.mainCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-purple-300 rounded-lg p-3",children:[e.jsxs("h4",{className:"text-sm font-bold text-purple-700 mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘—"}),a==="de"?"Hauptcharaktere (Style Profile)":a==="fr"?"Personnages Principaux (Profil Style)":"Main Characters (Style Profile)"]}),e.jsx("div",{className:"space-y-3",children:T.mainCharacters.map(t=>{var u,c,S,d;return e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-sm",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-800 hover:text-purple-900",children:[t.name,Object.keys(t.generatedOutfits||{}).length>0&&e.jsxs("span",{className:"ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs",children:[Object.keys(t.generatedOutfits).length," ",a==="de"?"Outfits":a==="fr"?"tenues":"outfits"]})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"font-medium text-gray-600",children:"Physical:"}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[((u=t.physical)==null?void 0:u.skinTone)||"N/A"," | ",((c=t.physical)==null?void 0:c.hair)||"N/A"," | ",((S=t.physical)==null?void 0:S.build)||"N/A",((d=t.physical)==null?void 0:d.other)&&` | ${t.physical.other}`]})]}),t.generatedOutfits&&Object.keys(t.generatedOutfits).length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-purple-200",children:[e.jsx("span",{className:"font-medium text-gray-600 text-xs",children:"Generated Outfits:"}),e.jsx("div",{className:"mt-1 space-y-1",children:Object.entries(t.generatedOutfits).map(([J,ne])=>{var Be;return e.jsxs("div",{className:"bg-white p-1.5 rounded text-xs",children:[e.jsxs("span",{className:"font-medium text-purple-600",children:["Page ",J,":"]}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[(Be=ne.outfit)==null?void 0:Be.substring(0,80),"..."]}),e.jsx("span",{className:`ml-1 px-1 py-0.5 rounded text-[10px] ${ne.setting==="outdoor-cold"?"bg-blue-100 text-blue-700":ne.setting==="outdoor-warm"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:ne.setting})]},J)})})]})]})]},t.id)})})]}),T.secondaryCharacters&&T.secondaryCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Nebencharaktere":a==="fr"?"Personnages Secondaires":"Secondary Characters"}),e.jsx("div",{className:"space-y-2",children:T.secondaryCharacters.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[hr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(we==null?void 0:we.type)==="secondaryCharacter"&&(we==null?void 0:we.id)===t.id&&(we==null?void 0:we.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:yt,onChange:c=>lr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Dt,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(fs,{size:12})," Save"]}),e.jsxs("button",{onClick:Zt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),xe&&ye&&e.jsx("button",{onClick:()=>Gt("secondaryCharacter",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ct,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Yt=T.animals)==null?void 0:Yt.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Tiere & Wesen":a==="fr"?"Animaux & CrÃ©atures":"Animals & Creatures"}),e.jsx("div",{className:"space-y-2",children:T.animals.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[hr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(we==null?void 0:we.type)==="animal"&&(we==null?void 0:we.id)===t.id&&(we==null?void 0:we.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:yt,onChange:c=>lr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Dt,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(fs,{size:12})," Save"]}),e.jsxs("button",{onClick:Zt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),xe&&ye&&e.jsx("button",{onClick:()=>Gt("animal",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ct,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Xt=T.artifacts)==null?void 0:Xt.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Artefakte & Objekte":a==="fr"?"Artefacts & Objets":"Artifacts & Objects"}),e.jsx("div",{className:"space-y-2",children:T.artifacts.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[hr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(we==null?void 0:we.type)==="artifact"&&(we==null?void 0:we.id)===t.id&&(we==null?void 0:we.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:yt,onChange:c=>lr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Dt,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(fs,{size:12})," Save"]}),e.jsxs("button",{onClick:Zt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),xe&&ye&&e.jsx("button",{onClick:()=>Gt("artifact",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ct,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Fs=T.locations)==null?void 0:Fs.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Wiederkehrende Orte":a==="fr"?"Lieux RÃ©currents":"Recurring Locations"}),e.jsx("div",{className:"space-y-2",children:T.locations.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[!t.isRealLandmark&&hr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.isRealLandmark&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 font-semibold",children:"ðŸ“ LANDMARK"}),t.photoFetchStatus==="success"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700",children:"ðŸ“· Photo"}),!t.isRealLandmark&&t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),t.isRealLandmark&&t.landmarkQuery&&e.jsxs("div",{className:"text-amber-700 text-xs mt-1",children:["Landmark: ",e.jsx("span",{className:"font-mono bg-amber-50 px-1 rounded",children:t.landmarkQuery})]}),(we==null?void 0:we.type)==="location"&&(we==null?void 0:we.id)===t.id&&(we==null?void 0:we.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:yt,onChange:c=>lr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Dt,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(fs,{size:12})," Save"]}),e.jsxs("button",{onClick:Zt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),xe&&ye&&e.jsx("button",{onClick:()=>Gt("location",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(ct,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]}),t.referencePhotoData&&e.jsxs("div",{className:"mt-2 border border-amber-200 rounded overflow-hidden",children:[e.jsx("img",{src:t.referencePhotoData,alt:`${t.name} reference`,className:"w-full max-h-32 object-contain bg-gray-50"}),t.photoAttribution&&e.jsxs("div",{className:"text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 truncate",children:["ðŸ“· ",t.photoAttribution]})]})]})]},t.id)})})]}),T.vehicles&&T.vehicles.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Fahrzeuge":a==="fr"?"VÃ©hicules":"Vehicles"}),e.jsx("div",{className:"space-y-2",children:T.vehicles.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[hr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),T.clothing&&T.clothing.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Kleidung & KostÃ¼me":a==="fr"?"VÃªtements & Costumes":"Clothing & Costumes"}),e.jsx("div",{className:"space-y-2",children:T.clothing.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.wornBy&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:["worn by ",t.wornBy]}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]},t.id)})})]}),T.changeLog&&T.changeLog.length>0&&e.jsxs("details",{className:"bg-white border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-bold text-amber-700 hover:text-amber-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“"}),a==="de"?"Ã„nderungsprotokoll":a==="fr"?"Journal des Modifications":"Change Log",e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-xs",children:T.changeLog.length})]}),e.jsx("div",{className:"mt-2 space-y-1 max-h-[500px] overflow-y-auto",children:T.changeLog.slice().reverse().map((t,u)=>{var c;return e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs border-l-2 border-amber-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.type==="mainCharacter"?"bg-purple-100 text-purple-700":t.type==="secondaryCharacter"?"bg-rose-100 text-rose-700":t.type==="generatedOutfit"?"bg-green-100 text-green-700":t.type==="animal"?"bg-orange-100 text-orange-700":t.type==="artifact"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:t.type}),e.jsx("span",{className:"font-semibold text-amber-800",children:t.element}),e.jsxs("span",{className:"text-gray-500",children:[ke==="de"?"Seite":"Page"," ",t.page]})]}),e.jsxs("div",{className:"mt-1 text-gray-600",children:[e.jsxs("span",{className:"font-medium",children:[t.change,":"]}),e.jsxs("span",{className:"ml-1 text-gray-700",children:[(c=t.after)==null?void 0:c.substring(0,100),t.after&&t.after.length>100?"...":""]})]}),t.before&&e.jsxs("div",{className:"text-gray-400 line-through text-[10px] mt-0.5",children:[a==="de"?"Vorher":a==="fr"?"Avant":"Before",": ",t.before.substring(0,50),"..."]}),e.jsx("div",{className:"text-gray-400 text-[10px] mt-0.5",children:new Date(t.timestamp).toLocaleTimeString()})]},u)})})]}),(!T.mainCharacters||T.mainCharacters.length===0)&&(!T.secondaryCharacters||T.secondaryCharacters.length===0)&&(!T.animals||T.animals.length===0)&&(!T.artifacts||T.artifacts.length===0)&&(!T.locations||T.locations.length===0)&&(!T.vehicles||T.vehicles.length===0)&&(!T.clothing||T.clothing.length===0)&&e.jsx("div",{className:"text-gray-500 text-sm italic",children:a==="de"?"Keine wiederkehrenden Elemente gefunden":a==="fr"?"Aucun Ã©lÃ©ment rÃ©current trouvÃ©":"No recurring elements found in this story"})]})]}),Ne&&Object.keys(Ne).length>0&&e.jsxs("details",{className:"bg-teal-50 border-2 border-teal-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-teal-800 hover:text-teal-900 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸ‘”"}),a==="de"?`Kleidungsanforderungen (${Object.keys(Ne).length} Charaktere)`:a==="fr"?`Exigences vestimentaires (${Object.keys(Ne).length} personnages)`:`Clothing Requirements (${Object.keys(Ne).length} characters)`]}),e.jsx("div",{className:"mt-4 space-y-3",children:Object.entries(Ne).map(([t,u])=>{var c,S,d,J,ne,Be,$e,Ze,ft,Ct,oe,it,Kr,tr,br;return e.jsxs("div",{className:"bg-white border border-teal-200 rounded-lg p-3",children:[e.jsx("h4",{className:"font-bold text-teal-700 mb-2",children:t}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${(c=u.standard)!=null&&c.used?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(S=u.standard)!=null&&S.used?"âœ…":"â¬œ"," Standard"]}),((d=u.standard)==null?void 0:d.used)&&((J=u.standard)==null?void 0:J.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:u.standard.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(ne=u.winter)!=null&&ne.used?"bg-blue-50 border border-blue-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Be=u.winter)!=null&&Be.used?"â„ï¸":"â¬œ"," Winter"]}),(($e=u.winter)==null?void 0:$e.used)&&((Ze=u.winter)==null?void 0:Ze.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:u.winter.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(ft=u.summer)!=null&&ft.used?"bg-yellow-50 border border-yellow-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Ct=u.summer)!=null&&Ct.used?"â˜€ï¸":"â¬œ"," Summer"]}),((oe=u.summer)==null?void 0:oe.used)&&((it=u.summer)==null?void 0:it.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:u.summer.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(Kr=u.costumed)!=null&&Kr.used?"bg-purple-50 border border-purple-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(tr=u.costumed)!=null&&tr.used?"ðŸŽ­":"â¬œ"," Costumed"]}),((br=u.costumed)==null?void 0:br.used)&&e.jsxs("div",{className:"text-gray-600 mt-1",children:[u.costumed.costume&&e.jsxs("span",{className:"font-medium",children:[u.costumed.costume,": "]}),u.costumed.description]})]})]})]},t)})})]}),De&&De.length>0&&e.jsxs("details",{className:"bg-pink-50 border-2 border-pink-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-pink-800 hover:text-pink-900 flex items-center gap-2",children:[e.jsx(Br,{size:20}),a==="de"?`Stilisierte Avatare (${De.length})`:a==="fr"?`Avatars stylisÃ©s (${De.length})`:`Styled Avatars (${De.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:De.map((t,u)=>{var c,S;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-pink-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.artStyle," (",t.clothingCategory||"standard",")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[xr("styled",u,t,"facePhoto","Face Photo",(c=t.inputs.facePhoto)==null?void 0:c.sizeKB),xr("styled",u,t,"originalAvatar","Original Avatar",(S=t.inputs.originalAvatar)==null?void 0:S.sizeKB),t.inputs.styleSample&&xr("styled",u,t,"styleSample","Style Sample",t.inputs.styleSample.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:xr("styled",u,t,"output","Styled Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},u)})})]}),_e&&_e.length>0&&e.jsxs("details",{className:"bg-orange-50 border-2 border-orange-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-orange-800 hover:text-orange-900 flex items-center gap-2",children:[e.jsx(Br,{size:20}),a==="de"?`KostÃ¼m-Avatare (${_e.length})`:a==="fr"?`Avatars costumÃ©s (${_e.length})`:`Costumed Avatars (${_e.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:_e.map((t,u)=>{var c,S;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-orange-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 hover:text-orange-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.costumeType," (",t.artStyle,")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[t.costumeDescription&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-yellow-700",children:"Costume:"}),e.jsx("p",{className:"mt-1 text-gray-700",children:t.costumeDescription})]}),e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[xr("costumed",u,t,"facePhoto","Face Photo",(c=t.inputs.facePhoto)==null?void 0:c.sizeKB),xr("costumed",u,t,"standardAvatar","Standard Avatar",(S=t.inputs.standardAvatar)==null?void 0:S.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:xr("costumed",u,t,"output","Costumed Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},u)})})]}),Se&&Se.length>0&&e.jsxs("details",{className:"bg-slate-50 border-2 border-slate-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-slate-800 hover:text-slate-900 flex items-center gap-2",children:[e.jsx(ys,{size:20}),a==="de"?`Generierungslog (${Se.length})`:a==="fr"?`Journal de gÃ©nÃ©ration (${Se.length})`:`Generation Log (${Se.length})`,Se.filter(t=>t.level==="warn").length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded-full",children:[Se.filter(t=>t.level==="warn").length," warnings"]}),Se.filter(t=>t.level==="error").length>0&&e.jsxs("span",{className:"ml-1 px-2 py-0.5 bg-red-200 text-red-800 text-xs rounded-full",children:[Se.filter(t=>t.level==="error").length," errors"]})]}),e.jsx("div",{className:"mt-4 space-y-1 max-h-96 overflow-y-auto",children:Se.map((t,u)=>e.jsxs("div",{className:`text-xs p-2 rounded flex items-start gap-2 ${t.level==="error"?"bg-red-50 text-red-800":t.level==="warn"?"bg-yellow-50 text-yellow-800":t.level==="debug"?"bg-gray-50 text-gray-600":"bg-white text-slate-700"}`,children:[e.jsx("span",{className:"text-gray-400 font-mono text-[10px] whitespace-nowrap",children:new Date(t.timestamp).toLocaleTimeString()}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium whitespace-nowrap ${t.stage==="outline"?"bg-blue-100 text-blue-700":t.stage==="avatars"?"bg-purple-100 text-purple-700":t.stage==="scenes"?"bg-green-100 text-green-700":t.stage==="images"?"bg-orange-100 text-orange-700":t.stage==="covers"?"bg-pink-100 text-pink-700":"bg-gray-100 text-gray-700"}`,children:t.stage}),t.character&&e.jsxs("span",{className:"font-medium text-slate-600",children:["[",t.character,"]"]}),e.jsx("span",{className:"flex-1",children:t.message}),e.jsx("span",{className:"text-gray-400 text-[10px]",children:t.event})]},u))})]}),U&&e.jsxs("details",{className:`border-2 rounded-xl p-4 ${U.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsxs("summary",{className:`cursor-pointer text-lg font-bold flex items-center gap-2 ${U.overallConsistent?"text-green-800 hover:text-green-900":"text-amber-800 hover:text-amber-900"}`,children:[U.overallConsistent?"âœ“":"âš ï¸",a==="de"?`KonsistenzprÃ¼fung (${U.totalIssues} Probleme)`:a==="fr"?`VÃ©rification de cohÃ©rence (${U.totalIssues} problÃ¨mes)`:`Final Checks (${U.totalIssues} issues)`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-700",children:U.summary}),U.imageChecks&&U.imageChecks.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"Bildkonsistenz":a==="fr"?"CohÃ©rence des images":"Image Consistency"}),U.imageChecks.map((t,u)=>{var c,S;return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${t.consistent?"text-green-600":"text-amber-600"}`,children:t.consistent?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:t.type==="full"?"Full Check":t.type==="character"?`Character: ${t.characterName}`:t.type==="sequence"?"Sequence Check":t.type}),t.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",t.overallScore,"/10"]})]}),t.issues&&t.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:t.issues.map((d,J)=>{var ne,Be;return e.jsxs("div",{className:`text-xs p-2 rounded ${d.severity==="high"?"bg-red-50 border-l-4 border-red-400":d.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${d.severity==="high"?"bg-red-200 text-red-800":d.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:d.severity}),e.jsxs("span",{className:"text-gray-500",children:["Pages ",(ne=d.images)==null?void 0:ne.join(", ")]}),d.pagesToFix&&d.pagesToFix.length>0&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px]",children:["Fix: ",d.pagesToFix.join(", ")]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:(Be=d.type)==null?void 0:Be.replace(/_/g," ")}),d.characterInvolved&&e.jsx("span",{className:"px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px]",children:d.characterInvolved})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:d.description}),d.details&&Object.keys(d.details).length>0&&e.jsx("div",{className:"mt-1 pl-2 border-l-2 border-gray-200",children:Object.entries(d.details).map(([$e,Ze])=>e.jsxs("p",{className:"text-gray-500 text-[10px]",children:[e.jsxs("span",{className:"font-medium",children:[$e,":"]})," ",Ze]},$e))}),d.canonicalVersion&&e.jsxs("p",{className:"text-blue-700 mt-1",children:["ðŸŽ¯ Target: ",d.canonicalVersion]}),d.recommendation&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:["ðŸ’¡ ",d.recommendation]}),B&&d.pagesToFix&&d.pagesToFix.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:d.pagesToFix.map($e=>e.jsx("button",{onClick:()=>os($e,d),disabled:j||$r!==null,className:`flex items-center gap-1 px-2 py-1 text-[10px] font-medium rounded transition-colors ${$r===$e?"bg-amber-300 text-amber-800":j||$r!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:$r===$e?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3 h-3 animate-spin"}),e.jsxs("span",{children:["Repairing P",$e,"..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(bs,{className:"w-3 h-3"}),e.jsxs("span",{children:["Repair P",$e]})]})},$e))})]},J)})}),t.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:t.summary}),(t.evaluationPrompts||t.evaluationPrompt)&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:["ðŸ” View Evaluation Prompt",(((c=t.evaluationPrompts)==null?void 0:c.length)??0)>1?`s (${(S=t.evaluationPrompts)==null?void 0:S.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:(t.evaluationPrompts??(t.evaluationPrompt?[t.evaluationPrompt]:[])).map((d,J)=>{var ne;return e.jsxs("div",{children:[(((ne=t.evaluationPrompts)==null?void 0:ne.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-blue-700 mb-1",children:["Batch ",J+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:d})]},J)})})]}),e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result (Full JSON)"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-96 overflow-y-auto bg-white p-2 rounded border",children:JSON.stringify({type:t.type,characterName:t.characterName,consistent:t.consistent,overallScore:t.overallScore,issues:t.issues,summary:t.summary},null,2)})]}),t.rawResponses&&t.rawResponses.length>0&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:["ðŸ“ View Raw Response",t.rawResponses.length>1?`s (${t.rawResponses.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:t.rawResponses.map((d,J)=>{var ne;return e.jsxs("div",{children:[(((ne=t.rawResponses)==null?void 0:ne.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-purple-700 mb-1",children:["Batch ",J+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:d})]},J)})})]})]},u)})]}),((er=U.entity)==null?void 0:er.grids)&&U.entity.grids.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"EntitÃ¤ts-Konsistenz (Raster)":a==="fr"?"CohÃ©rence des entitÃ©s (grilles)":"Entity Consistency (Grids)"}),e.jsx("div",{className:"space-y-2",children:U.entity.grids.map((t,u)=>{var ne,Be,$e,Ze,ft,Ct,oe,it,Kr,tr,br,rr,kt,Er,ga,yr,cs,Wt,vr,Fr,ha,zs,xa,Bs,pa,Ms,fa,Ls,ba,Os,ya,Gs,va,jr,ja,Jr,Na,ms,wa,us,Sa,gs;const c=(Be=(ne=U.entity)==null?void 0:ne.characters)==null?void 0:Be[t.entityName],S=(c==null?void 0:c.consistent)??!0,d=(c==null?void 0:c.score)??0,J=(c==null?void 0:c.issues)??[];return e.jsxs("details",{className:`bg-white border rounded-lg overflow-hidden ${S?"border-green-200":"border-amber-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer p-3 flex items-center gap-2 hover:bg-gray-50",children:[e.jsx("span",{className:`text-sm ${S?"text-green-600":"text-amber-600"}`,children:S?"âœ“":"âš ï¸"}),e.jsx("span",{className:"font-medium text-sm text-gray-800",children:t.entityName}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",t.cellCount," appearances)"]}),e.jsxs("span",{className:`ml-auto text-xs px-2 py-0.5 rounded ${d>=8?"bg-green-100 text-green-700":d>=5?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:["Score: ",d,"/10"]})]}),e.jsxs("div",{className:"p-3 border-t border-gray-100 space-y-3",children:[(()=>{const me=t.gridImage||Or[t.entityName],rt=Gr.has(t.entityName),Ke=t.gridImageSizeKB;return me?e.jsx("div",{className:"flex justify-center bg-gray-50 rounded p-2",children:e.jsx("img",{src:me,alt:`${t.entityName} consistency grid`,className:"max-w-full h-auto rounded shadow-sm cursor-pointer hover:opacity-90 transition-opacity",style:{maxHeight:"400px"},onClick:()=>Ir({src:me,title:`${t.entityName} - Entity Consistency Grid`}),title:"Click to enlarge"})}):e.jsx("div",{className:"flex justify-center bg-gray-50 rounded p-2",children:e.jsx("button",{onClick:()=>$s(t.entityName),disabled:rt,className:"flex items-center gap-2 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm text-gray-700 disabled:opacity-50",children:rt?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading grid..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Br,{className:"w-4 h-4"}),e.jsxs("span",{children:["Load Grid Image",Ke?` (${Ke} KB)`:""]})]})})})})(),(($e=t.manifest)==null?void 0:$e.cells)&&e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Cells: "}),t.manifest.cells.map((me,rt)=>{const Ke=t.gridImage||Or[t.entityName];return e.jsxs("span",{className:"inline-flex items-center bg-gray-100 rounded px-1.5 py-0.5 mr-1 mb-1 gap-1",children:[e.jsxs("button",{onClick:()=>Ke&&na({...t,gridImage:Ke},rt),className:`${Ke?"hover:text-blue-600 hover:underline cursor-pointer":"text-gray-400 cursor-not-allowed"}`,title:Ke?"Click to enlarge this cell":"Load grid image first",disabled:!Ke,children:[me.letter,": ",me.isReference?"Ref":`P${me.pageNumber}`,me.clothing&&me.clothing!=="standard"&&` (${me.clothing})`]}),!me.isReference&&B&&typeof me.pageNumber=="number"&&e.jsx("button",{onClick:qt=>{qt.stopPropagation(),Hr(t.entityName,me.pageNumber)},disabled:j||at!==null||Pe!==null,className:`ml-0.5 px-1 py-0 text-[9px] rounded transition-colors ${(at==null?void 0:at.entity)===t.entityName&&(at==null?void 0:at.page)===me.pageNumber?"bg-amber-300 text-amber-800":j||at!==null||Pe!==null?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,title:`Repair page ${me.pageNumber} for ${t.entityName}`,children:(at==null?void 0:at.entity)===t.entityName&&(at==null?void 0:at.page)===me.pageNumber?"...":"âš¡"})]},rt)})]}),J.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Issues:"}),J.map((me,rt)=>e.jsxs("div",{className:`text-xs p-2 rounded ${me.severity==="critical"?"bg-red-50 border-l-4 border-red-400":me.severity==="major"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${me.severity==="critical"?"bg-red-200 text-red-800":me.severity==="major"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:me.subType||me.type}),me.pagesToFix&&e.jsxs("span",{className:"text-[10px] text-gray-500",children:["Fix page(s): ",me.pagesToFix.join(", ")]})]}),e.jsx("p",{className:"mt-1 text-gray-700",children:me.description}),me.fixInstruction&&e.jsx("p",{className:"mt-1 text-blue-600 italic",children:me.fixInstruction})]},rt))]}),(c==null?void 0:c.summary)&&e.jsx("p",{className:"text-xs text-gray-500 italic",children:c.summary}),B&&(!S||d<8)&&t.entityType==="character"&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[e.jsx("button",{onClick:()=>xt(t.entityName),disabled:j||Pe!==null,className:`flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded transition-colors ${j||Pe!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:Pe===t.entityName?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Repairing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(bs,{className:"w-3 h-3"}),e.jsx("span",{children:"Repair Consistency"})]})}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:"Regenerate appearances to match reference photo"})]}),((Ze=U.entityRepairs)==null?void 0:Ze[t.entityName])&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-medium text-green-600",children:"âœ“ Repaired"}),e.jsxs("span",{className:"text-[10px] text-gray-400",children:[(Ct=(ft=U.entityRepairs)==null?void 0:ft[t.entityName])!=null&&Ct.cellsRepaired?`${(oe=U.entityRepairs[t.entityName])==null?void 0:oe.cellsRepaired} pages updated`:(Kr=(it=U.entityRepairs)==null?void 0:it[t.entityName])!=null&&Kr.pages?`${Object.keys(((tr=U.entityRepairs[t.entityName])==null?void 0:tr.pages)||{}).length} page(s) repaired individually`:"repair complete",(((rr=(br=U.entityRepairs)==null?void 0:br[t.entityName])==null?void 0:rr.clothingGroupCount)??0)>1&&` (${(Er=(kt=U.entityRepairs)==null?void 0:kt[t.entityName])==null?void 0:Er.clothingGroupCount} clothing groups)`]})]}),(cs=(yr=(ga=U.entityRepairs)==null?void 0:ga[t.entityName])==null?void 0:yr.gridsByClothing)!=null&&cs.length?e.jsx("div",{className:"space-y-4",children:(Fr=(vr=(Wt=U.entityRepairs)==null?void 0:Wt[t.entityName])==null?void 0:vr.gridsByClothing)==null?void 0:Fr.map(me=>{var rt;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 border-b border-gray-100 pb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase",children:me.clothingCategory}),e.jsxs("span",{className:"text-[9px] text-gray-400",children:["(",me.cropCount," pages)"]}),e.jsxs("span",{className:"text-[9px] text-gray-400 ml-auto",children:["ref: ",me.referenceUsed]})]}),(rt=me.cellComparisons)!=null&&rt.length?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[9px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Cell"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),me.cellComparisons.map(Ke=>e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-xs font-bold text-gray-700",children:Ke.letter}),e.jsxs("div",{className:"text-[9px] text-gray-400",children:["P",Ke.pageNumber]})]}),e.jsx("img",{src:Ke.before,alt:`${Ke.letter} before`,className:"w-full h-auto rounded"}),e.jsx("img",{src:Ke.after,alt:`${Ke.letter} after`,className:"w-full h-auto rounded"}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:Ke.diff,alt:`${Ke.letter} diff`,className:"w-full h-auto rounded"})})]},`${me.clothingCategory}-${Ke.letter}`))]}):e.jsxs("div",{className:`grid gap-2 ${me.gridDiff?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"Before"}),e.jsx("div",{className:"bg-gray-50 rounded p-0.5",children:e.jsx("img",{src:me.gridBefore,alt:"Before repair",className:"w-full h-auto rounded"})})]}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"After"}),e.jsx("div",{className:"bg-gray-50 rounded p-0.5",children:e.jsx("img",{src:me.gridAfter,alt:"After repair",className:"w-full h-auto rounded"})})]}),me.gridDiff&&e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"Diff"}),e.jsx("div",{className:"bg-gray-900 rounded p-0.5",children:e.jsx("img",{src:me.gridDiff,alt:"Difference",className:"w-full h-auto rounded"})})]})]})]},me.clothingCategory)})}):(xa=(zs=(ha=U.entityRepairs)==null?void 0:ha[t.entityName])==null?void 0:zs.cellComparisons)!=null&&xa.length?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[10px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Cell"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),(Ms=(pa=(Bs=U.entityRepairs)==null?void 0:Bs[t.entityName])==null?void 0:pa.cellComparisons)==null?void 0:Ms.map(me=>e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-xs font-bold text-gray-700",children:me.letter}),e.jsxs("div",{className:"text-[9px] text-gray-400",children:["P",me.pageNumber]})]}),e.jsx("img",{src:me.before,alt:`${me.letter} before`,className:"w-full h-auto rounded"}),e.jsx("img",{src:me.after,alt:`${me.letter} after`,className:"w-full h-auto rounded"}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:me.diff,alt:`${me.letter} diff`,className:"w-full h-auto rounded"})})]},me.letter))]}):(Ls=(fa=U.entityRepairs)==null?void 0:fa[t.entityName])!=null&&Ls.pages&&Object.keys(((ba=U.entityRepairs[t.entityName])==null?void 0:ba.pages)||{}).length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[10px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Page"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),Object.entries(((Os=U.entityRepairs[t.entityName])==null?void 0:Os.pages)||{}).map(([me,rt])=>{var Ke,qt,hs;return e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("span",{className:"text-xs font-bold text-gray-700",children:["P",me]}),rt.clothingCategory&&rt.clothingCategory!=="standard"&&e.jsx("div",{className:"text-[8px] text-gray-400",children:rt.clothingCategory})]}),e.jsx("img",{src:(Ke=rt.comparison)==null?void 0:Ke.before,alt:`P${me} before`,className:"w-full h-auto rounded"}),e.jsx("img",{src:(qt=rt.comparison)==null?void 0:qt.after,alt:`P${me} after`,className:"w-full h-auto rounded"}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:(hs=rt.comparison)==null?void 0:hs.diff,alt:`P${me} diff`,className:"w-full h-auto rounded"})})]},me)})]}):(Gs=(ya=U.entityRepairs)==null?void 0:ya[t.entityName])!=null&&Gs.gridBeforeRepair?e.jsxs("div",{className:`grid gap-3 ${(jr=(va=U.entityRepairs)==null?void 0:va[t.entityName])!=null&&jr.gridDiff?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"Before Repair"}),e.jsx("div",{className:"bg-gray-50 rounded p-1",children:e.jsx("img",{src:(Jr=(ja=U.entityRepairs)==null?void 0:ja[t.entityName])==null?void 0:Jr.gridBeforeRepair,alt:"Before repair",className:"w-full h-auto rounded"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"After Repair"}),e.jsx("div",{className:"bg-gray-50 rounded p-1",children:e.jsx("img",{src:(ms=(Na=U.entityRepairs)==null?void 0:Na[t.entityName])==null?void 0:ms.gridAfterRepair,alt:"After repair",className:"w-full h-auto rounded"})})]}),((us=(wa=U.entityRepairs)==null?void 0:wa[t.entityName])==null?void 0:us.gridDiff)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"Difference"}),e.jsx("div",{className:"bg-gray-900 rounded p-1",children:e.jsx("img",{src:((gs=(Sa=U.entityRepairs)==null?void 0:Sa[t.entityName])==null?void 0:gs.gridDiff)??void 0,alt:"Difference",className:"w-full h-auto rounded"})})]})]}):null]})]})]},u)})}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:U.entity.summary})]}),U.textCheck&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"TextqualitÃ¤t":a==="fr"?"QualitÃ© du texte":"Text Quality"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${U.textCheck.quality==="good"?"text-green-600":U.textCheck.quality==="needs_review"?"text-amber-600":"text-red-600"}`,children:U.textCheck.quality==="good"?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:U.textCheck.quality==="good"?"Good":U.textCheck.quality==="needs_review"?"Needs Review":"Has Issues"}),U.textCheck.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",U.textCheck.overallScore,"/10"]})]}),U.textCheck.issues&&U.textCheck.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:U.textCheck.issues.map((t,u)=>e.jsxs("div",{className:`text-xs p-2 rounded ${t.severity==="high"?"bg-red-50 border-l-4 border-red-400":t.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.severity==="high"?"bg-red-200 text-red-800":t.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:t.severity}),t.page&&e.jsxs("span",{className:"text-gray-500",children:["Page ",t.page]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:t.type})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:t.issue}),(t.originalText||t.text)&&e.jsxs("p",{className:"text-red-600 mt-1 line-through",children:['"',t.originalText||t.text,'"']}),t.correctedText&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:['âœ“ "',t.correctedText,'"']}),!t.correctedText&&t.suggestion&&e.jsxs("p",{className:"text-green-700 mt-1",children:["â†’ ",t.suggestion]})]},u))}),U.textCheck.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:U.textCheck.summary}),U.textCheck.fullOriginalText&&e.jsxs("details",{className:"mt-3 bg-gray-50 border border-gray-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-gray-700",children:"ðŸ“„ View Original Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-600 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:U.textCheck.fullOriginalText})]}),U.textCheck.fullCorrectedText&&e.jsxs("details",{className:"mt-3 bg-green-50 border border-green-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-green-800",children:"ðŸ“‹ View Full Corrected Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:U.textCheck.fullCorrectedText})]}),U.textCheck.rawResponse&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:"ðŸ“ View Raw Response"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:U.textCheck.rawResponse})]}),U.textCheck&&e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:JSON.stringify({quality:U.textCheck.quality,overallScore:U.textCheck.overallScore,issues:U.textCheck.issues,summary:U.textCheck.summary,parseError:U.textCheck.parseError},null,2)})]}),U.textCheck.evaluationPrompt&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:"ðŸ” View Evaluation Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:U.textCheck.evaluationPrompt})]})]})]}),U.error&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-2 text-xs text-red-700",children:["Error: ",U.error]})]})]}),y.length>0&&e.jsxs("details",{className:"bg-green-50 border-2 border-green-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-green-800 hover:text-green-900 flex items-center gap-2",children:[e.jsx(ys,{size:20}),a==="de"?`Alle Szenenbeschreibungen (${y.length})`:a==="fr"?`Toutes les descriptions de scÃ¨nes (${y.length})`:`All Scene Descriptions (${y.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:y.map(t=>e.jsxs("details",{className:"bg-white border border-green-200 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-700 hover:text-green-800",children:ke==="de"?`Seite ${t.pageNumber}`:ke==="fr"?`Page ${t.pageNumber}`:`Page ${t.pageNumber}`}),e.jsxs("div",{className:"mt-2 space-y-2",children:[t.outlineExtract&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-amber-700",children:"Outline Extract:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.outlineExtract})]}),t.scenePrompt&&e.jsxs("div",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-purple-700",children:"Scene Prompt:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.scenePrompt})]}),e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Scene Description:"}),t.textModelId&&e.jsxs("span",{className:"ml-2 text-green-600",children:["(",t.textModelId,")"]}),e.jsx("pre",{className:"text-gray-700 mt-1 whitespace-pre-wrap font-mono text-xs overflow-x-auto",children:(()=>{if(typeof t.description=="string")try{const u=JSON.parse(t.description);return JSON.stringify(u,null,2)}catch{return t.description}if(typeof t.description=="object"){const u=t.description;if(u!=null&&u.text)try{const c=JSON.parse(u.text);return JSON.stringify(c,null,2)}catch{return u.text}return JSON.stringify(t.description,null,2)}return String(t.description)})()})]})]})]},t.pageNumber))})]})]}),I&&Ht(I.frontCover)&&(()=>{var u,c;const t=qr(I.frontCover);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:ke==="de"?"Titelseite":ke==="fr"?"Couverture":"Front Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ea,{src:Ht(I.frontCover),alt:"Front Cover",className:"w-full rounded-lg shadow-lg",label:"Front Cover"}),M.has("frontCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(Ye,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),H&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Vr("front"),disabled:j||!lt||M.has("frontCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||!lt||M.has("frontCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:lt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(nr,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Kt," ",a==="de"?"Credits":"credits",")"]})]})}),xe&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[E&&e.jsxs("button",{onClick:()=>E("front"),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const S=t.description;if(typeof S=="string")try{return JSON.stringify(JSON.parse(S),null,2)}catch{return S}if(typeof S=="object"){const d=S;if(d!=null&&d.text)try{return JSON.stringify(JSON.parse(d.text),null,2)}catch{return d.text}return JSON.stringify(S,null,2)}return String(S)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((u=t.referencePhotos)==null?void 0:u.length)??0)>0||(((c=t.landmarkPhotos)==null?void 0:c.length)??0)>0||t.visualBibleGrid)&&e.jsx(Ks,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(vs,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),I&&Ht(I.initialPage)&&(()=>{var u,c;const t=qr(I.initialPage);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:ke==="de"?"Widmungsseite":ke==="fr"?"Page de dÃ©dicace":"Dedication Page"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ea,{src:Ht(I.initialPage),alt:"Dedication Page",className:"w-full rounded-lg shadow-lg",label:"Dedication Page"}),M.has("initialPage")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(Ye,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),H&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Vr("initial"),disabled:j||!lt||M.has("initialPage"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||!lt||M.has("initialPage")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:lt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(nr,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Kt," ",a==="de"?"Credits":"credits",")"]})]})}),xe&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[E&&e.jsxs("button",{onClick:()=>E("initial"),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const S=t.description;if(typeof S=="string")try{return JSON.stringify(JSON.parse(S),null,2)}catch{return S}if(typeof S=="object"){const d=S;if(d!=null&&d.text)try{return JSON.stringify(JSON.parse(d.text),null,2)}catch{return d.text}return JSON.stringify(S,null,2)}return String(S)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((u=t.referencePhotos)==null?void 0:u.length)??0)>0||(((c=t.landmarkPhotos)==null?void 0:c.length)??0)>0||t.visualBibleGrid)&&e.jsx(Ks,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(vs,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),Ie&&!o&&(I==null?void 0:I.frontCover)&&e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-8 mt-6",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-indigo-700",children:ke==="de"?"Geschichte wird erstellt...":ke==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:ke==="de"?"Die Seiten werden gleich angezeigt":ke==="fr"?"Les pages seront bientÃ´t affichÃ©es":"Pages will appear shortly"})]})}),wt&&o&&e.jsxs("div",{className:"space-y-8 mt-8",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 text-center mb-6",children:r||(ke==="de"?"Ihre Geschichte":ke==="fr"?"Votre histoire":"Your Story")}),_t.slice(0,Ie?da:_t.length).map((t,u)=>{var $e,Ze,ft,Ct;const c=u+1,S=c,d=W.find(oe=>oe.pageNumber===S),J=Ie?Xe[S]:void 0,ne=!!(d!=null&&d.imageData||J),Be=Ie&&c===da&&!ne;return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:ke==="de"?`Seite ${c}`:ke==="fr"?`Page ${c}`:`Page ${c}`}),ds?e.jsxs("div",{className:"flex flex-col items-center max-w-2xl mx-auto",children:[Be?e.jsxs("div",{className:"w-full mb-4 aspect-[4/3] bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg shadow-md flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-indigo-600 font-medium",children:ke==="de"?"Bild wird erstellt...":ke==="fr"?"CrÃ©ation de l'image...":"Creating image..."}),e.jsx("p",{className:"text-indigo-400 text-sm mt-1",children:ke==="de"?"Die nÃ¤chste Seite erscheint bald":ke==="fr"?"La page suivante arrive bientÃ´t":"Next page coming soon"})]}):d!=null&&d.imageData||J?e.jsxs("div",{className:"w-full mb-4 relative",children:[e.jsx(Ea,{src:((d==null?void 0:d.imageData)||J)??"",alt:`Scene for page ${c}`,className:`w-full rounded-lg shadow-md object-cover ${mt.has(c)?"opacity-50":""}`,label:`Page ${c}`}),mt.has(c)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(Yr,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]}),C&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>ls(c),disabled:j||mt.has(c)||!lt,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||mt.has(c)||!lt?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:lt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(nr,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Kt," ",a==="de"?"Credits":"credits",")"]})]}),bt&&e.jsxs("button",{onClick:()=>Mr(!0),disabled:j,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),Ot(c).length>1&&e.jsxs("button",{onClick:()=>Pr({pageNumber:c,versions:Ot(c)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(Br,{size:14}),Ot(c).length]})]})}),xe&&e.jsxs("div",{className:"mt-3 space-y-2",children:[K&&e.jsxs("button",{onClick:()=>K(c),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),ie&&e.jsx("button",{onClick:()=>Mt(c),disabled:j||ut!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||ut!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:ut===c?e.jsxs(e.Fragment,{children:[e.jsx(Yr,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(bs,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),ee&&e.jsx("button",{onClick:()=>Lt(c),disabled:j||et!==null||ut!==null,className:`w-full bg-purple-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||et!==null||ut!==null?"opacity-50 cursor-not-allowed":"hover:bg-purple-600"}`,title:a==="de"?"Bild analysieren, 17 Checks durchfÃ¼hren, mit korrigierter Szene neu generieren":a==="fr"?"Analyser l'image, exÃ©cuter 17 vÃ©rifications, rÃ©gÃ©nÃ©rer avec scÃ¨ne corrigÃ©e":"Analyze image, run 17 checks, regenerate with corrected scene",children:et===c?e.jsxs(e.Fragment,{children:[e.jsx(Yr,{size:14,className:"animate-spin"}),a==="de"?"Iteriere...":a==="fr"?"ItÃ©ration...":"Iterating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(tn,{size:14}),a==="de"?"NÃ¤chste Iteration":a==="fr"?"Prochaine ItÃ©ration":"Next Iteration"]})}),(d==null?void 0:d.repairHistory)&&d.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(bs,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",d.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:d.repairHistory.map((oe,it)=>e.jsxs("div",{className:`border rounded-lg p-3 ${oe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${oe.success?"text-green-600":"text-red-600"}`,children:["(",oe.success?"âœ“":"âœ—"," ",oe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:oe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",oe.fixPrompt]}),oe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:oe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),oe.beforeImage&&oe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>Ss({beforeImage:oe.beforeImage,afterImage:oe.afterImage,diffImage:oe.diffImage,title:a==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`}),title:a==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:oe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:oe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),oe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:oe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(oe.timestamp).toLocaleTimeString()})]},it))})]}),Rr(c)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Rr(c)})]}),St(c)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:St(c)})]}),Ur(c)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",Vt(c)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",Vt(c),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Ur(c)})]}),(d==null?void 0:d.prompt)&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",(d==null?void 0:d.modelId)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",d.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:d==null?void 0:d.prompt})]}),(((($e=d==null?void 0:d.referencePhotos)==null?void 0:$e.length)??0)>0||(((Ze=d==null?void 0:d.landmarkPhotos)==null?void 0:Ze.length)??0)>0||(d==null?void 0:d.visualBibleGrid))&&d&&e.jsx(Ks,{referencePhotos:d.referencePhotos||[],landmarkPhotos:d.landmarkPhotos,visualBibleGrid:d.visualBibleGrid,language:a,storyId:B||void 0,pageNumber:c}),(d==null?void 0:d.qualityScore)!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",(d==null?void 0:d.qualityModelId)&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",d.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${((d==null?void 0:d.qualityScore)??0)>=70?"text-green-600":((d==null?void 0:d.qualityScore)??0)>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round((d==null?void 0:d.qualityScore)??0),"%"]})]}),(d==null?void 0:d.qualityReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.qualityReasoning})]})]}),e.jsx(zn,{retryHistory:d==null?void 0:d.retryHistory,language:a,storyId:B,pageNumber:d==null?void 0:d.pageNumber}),(d==null?void 0:d.retryHistory)&&d.retryHistory.length>0&&e.jsx(vs,{retryHistory:d.retryHistory,totalAttempts:(d==null?void 0:d.totalAttempts)||d.retryHistory.length,language:a,onRevertRepair:ve?(oe,it)=>ve(d.pageNumber,it):void 0,storyId:B,pageNumber:d.pageNumber}),(d==null?void 0:d.wasRegenerated)&&(!(d!=null&&d.retryHistory)||d.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),(d==null?void 0:d.originalScore)!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(d.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),(d==null?void 0:d.originalImage)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:d.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),(d==null?void 0:d.originalReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`w-full flex flex-col items-center justify-center rounded-lg p-8 mb-4 ${j?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:ke==="de"?"Bild wird noch erstellt...":ke==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:ke==="de"?"Kein Bild fÃ¼r diese Seite":ke==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"w-full bg-indigo-50 rounded-lg p-6 border-2 border-indigo-200",children:Jt?e.jsx("textarea",{value:t.trim(),onChange:oe=>Nt(u,oe.target.value),className:"w-full min-h-[400px] p-3 text-gray-800 leading-snug font-serif text-xl text-center bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl text-center",children:t.trim()})})]}):e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-stretch",children:[d&&d.imageData?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:d.imageData,alt:`Scene for page ${c}`,className:`w-full rounded-lg shadow-md object-cover ${mt.has(c)?"opacity-50":""}`}),mt.has(c)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(Yr,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]})]}),C&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>ls(c),disabled:j||mt.has(c)||!lt,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||mt.has(c)||!lt?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:lt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(nr,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Kt," ",a==="de"?"Credits":"credits",")"]})]}),bt&&e.jsxs("button",{onClick:()=>Mr(!0),disabled:j,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),Ot(c).length>1&&e.jsxs("button",{onClick:()=>Pr({pageNumber:c,versions:Ot(c)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(Br,{size:14}),Ot(c).length]})]})}),xe&&e.jsxs("div",{className:"mt-3 space-y-2",children:[K&&e.jsxs("button",{onClick:()=>K(c),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),ie&&e.jsx("button",{onClick:()=>Mt(c),disabled:j||ut!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||ut!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:ut===c?e.jsxs(e.Fragment,{children:[e.jsx(Yr,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(bs,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),ee&&e.jsx("button",{onClick:()=>Lt(c),disabled:j||et!==null||ut!==null,className:`w-full bg-purple-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||et!==null||ut!==null?"opacity-50 cursor-not-allowed":"hover:bg-purple-600"}`,title:a==="de"?"Bild analysieren, 17 Checks durchfÃ¼hren, mit korrigierter Szene neu generieren":a==="fr"?"Analyser l'image, exÃ©cuter 17 vÃ©rifications, rÃ©gÃ©nÃ©rer avec scÃ¨ne corrigÃ©e":"Analyze image, run 17 checks, regenerate with corrected scene",children:et===c?e.jsxs(e.Fragment,{children:[e.jsx(Yr,{size:14,className:"animate-spin"}),a==="de"?"Iteriere...":a==="fr"?"ItÃ©ration...":"Iterating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(tn,{size:14}),a==="de"?"NÃ¤chste Iteration":a==="fr"?"Prochaine ItÃ©ration":"Next Iteration"]})}),(d==null?void 0:d.repairHistory)&&d.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(bs,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",d.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:d.repairHistory.map((oe,it)=>e.jsxs("div",{className:`border rounded-lg p-3 ${oe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${oe.success?"text-green-600":"text-red-600"}`,children:["(",oe.success?"âœ“":"âœ—"," ",oe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:oe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",oe.fixPrompt]}),oe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:oe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),oe.beforeImage&&oe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>Ss({beforeImage:oe.beforeImage,afterImage:oe.afterImage,diffImage:oe.diffImage,title:a==="de"?`Reparatur ${oe.attempt}`:`Repair ${oe.attempt}`}),title:a==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:oe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:oe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),oe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:oe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(oe.timestamp).toLocaleTimeString()})]},it))})]}),Rr(c)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Rr(c)})]}),St(c)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:St(c)})]}),Ur(c)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",Vt(c)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",Vt(c),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Ur(c)})]}),d.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",d.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",d.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:d.prompt})]}),((((ft=d.referencePhotos)==null?void 0:ft.length)??0)>0||(((Ct=d.landmarkPhotos)==null?void 0:Ct.length)??0)>0||d.visualBibleGrid)&&e.jsx(Ks,{referencePhotos:d.referencePhotos||[],landmarkPhotos:d.landmarkPhotos,visualBibleGrid:d.visualBibleGrid,language:a,storyId:B||void 0,pageNumber:c}),d.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",d.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",d.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${d.qualityScore>=70?"text-green-600":d.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(d.qualityScore),"%"]})]}),d.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.qualityReasoning})]})]}),e.jsx(zn,{retryHistory:d.retryHistory,language:a,storyId:B,pageNumber:d.pageNumber}),d.retryHistory&&d.retryHistory.length>0&&e.jsx(vs,{retryHistory:d.retryHistory,totalAttempts:d.totalAttempts||d.retryHistory.length,language:a,onRevertRepair:ve?(oe,it)=>ve(d.pageNumber,it):void 0,storyId:B,pageNumber:d.pageNumber}),d.wasRegenerated&&(!d.retryHistory||d.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),d.originalScore!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(d.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),d.originalImage&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:d.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),d.originalReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`flex flex-col items-center justify-center rounded-lg p-8 ${j?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:ke==="de"?"Bild wird noch erstellt...":ke==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:ke==="de"?"Kein Bild fÃ¼r diese Seite":ke==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"flex flex-col w-full h-full",children:Jt?e.jsx("textarea",{value:t.trim(),onChange:oe=>Nt(u,oe.target.value),className:"w-full flex-1 min-h-[300px] p-4 text-gray-800 leading-snug font-serif text-xl bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("div",{className:"prose max-w-none",children:e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl",children:t.trim()})})})]})]},c)})]}),I&&Ht(I.backCover)&&(()=>{var u,c;const t=qr(I.backCover);return e.jsxs("div",{className:"mt-8 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:ke==="de"?"RÃ¼ckseite":ke==="fr"?"QuatriÃ¨me de couverture":"Back Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ea,{src:Ht(I.backCover),alt:"Back Cover",className:"w-full rounded-lg shadow-lg",label:"Back Cover"}),M.has("backCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(Ye,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),H&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Vr("back"),disabled:j||!lt||M.has("backCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||!lt||M.has("backCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:lt?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(nr,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Kt," ",a==="de"?"Credits":"credits",")"]})]})}),xe&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[E&&e.jsxs("button",{onClick:()=>E("back"),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const S=t.description;if(typeof S=="string")try{return JSON.stringify(JSON.parse(S),null,2)}catch{return S}if(typeof S=="object"){const d=S;if(d!=null&&d.text)try{return JSON.stringify(JSON.parse(d.text),null,2)}catch{return d.text}return JSON.stringify(S,null,2)}return String(S)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((u=t.referencePhotos)==null?void 0:u.length)??0)>0||(((c=t.landmarkPhotos)==null?void 0:c.length)??0)>0||t.visualBibleGrid)&&e.jsx(Ks,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(vs,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),wt&&o&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-4 mt-6",children:[e.jsx("h3",{className:"text-base font-bold text-gray-800 mb-3 text-center",children:a==="de"?"Was mÃ¶chten Sie als NÃ¤chstes tun?":a==="fr"?"Que souhaitez-vous faire ensuite ?":"What would you like to do next?"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[B&&F&&e.jsxs("button",{onClick:F,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Tn,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),g&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>as(!Bt),disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ys,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Sr,{size:14,className:`transition-transform ${Bt?"rotate-180":""}`})]}),Bt&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:gr==="square",onChange:()=>ss("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:gr==="A4",onChange:()=>ss("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{g(gr),as(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),bt&&!Jt&&e.jsxs("button",{onClick:()=>Mr(!0),disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(ct,{size:16})," ",a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),z&&e.jsxs("button",{onClick:z,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx($n,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]})]}),Jt&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-lg p-3 md:p-4 z-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-2 md:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-600",children:[e.jsx(ct,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"font-semibold text-sm md:text-base",children:a==="de"?"Bearbeitungsmodus":a==="fr"?"Mode Ã©dition":"Edit Mode"}),Pt&&e.jsxs("span",{className:"text-xs text-gray-500 hidden sm:inline",children:["(",a==="de"?"Original gespeichert":a==="fr"?"Original sauvegardÃ©":"Original saved",")"]})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto justify-center md:justify-end",children:[e.jsxs("button",{onClick:ia,disabled:tt,className:"px-3 md:px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(zt,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"})]}),Pt&&dr!==Pt&&e.jsxs("button",{onClick:()=>ts(Pt),disabled:tt,className:"px-3 md:px-4 py-2 border border-amber-400 text-amber-700 rounded-lg hover:bg-amber-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(tn,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"ZurÃ¼cksetzen":a==="fr"?"Restaurer":"Restore"})]}),e.jsxs("button",{onClick:Dr,disabled:tt,className:`px-3 md:px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold flex items-center gap-1.5 ${tt?"opacity-50 cursor-not-allowed":"hover:bg-green-600"}`,children:[e.jsx(fs,{size:16}),tt?a==="de"?"Speichern...":a==="fr"?"Sauvegarde...":"Saving...":a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save"]})]})]})}),Ue&&e.jsx(fo,{pageNumber:Ue.pageNumber,scene:Ue.scene,onSceneChange:t=>cr({...Ue,scene:t}),onClose:()=>cr(null),onRegenerate:pr,isRegenerating:mt.has(Ue.pageNumber),imageRegenerationCost:Kt,characters:O.map(t=>({id:t.id,name:t.name})),selectedCharacterIds:Ue.selectedCharacterIds,onCharacterSelectionChange:t=>cr({...Ue,selectedCharacterIds:t}),consistencyRegen:xe?(ua=W.find(t=>t.pageNumber===Ue.pageNumber))==null?void 0:ua.consistencyRegen:void 0}),ue&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(nr,{size:20}),a==="de"?"Cover bearbeiten":a==="fr"?"Modifier la couverture":"Edit Cover"," - ",ue.coverType==="front"?a==="de"?"Titelseite":a==="fr"?"Couverture":"Front Cover":ue.coverType==="initial"?a==="de"?"Einleitungsseite":a==="fr"?"Page de dÃ©dicace":"Dedication Page":a==="de"?"RÃ¼ckseite":a==="fr"?"Dos":"Back Cover"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a==="de"?"Bearbeite die Szenenbeschreibung und wÃ¤hle die Charaktere aus":a==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages":"Edit the scene description and select the characters"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[O.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(mn,{size:16}),a==="de"?"Charaktere auf dem Cover:":a==="fr"?"Personnages sur la couverture:":"Characters on the cover:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:O.map(t=>{const u=ue.selectedCharacterIds.includes(t.id);return e.jsxs("button",{type:"button",onClick:()=>{const c=u?ue.selectedCharacterIds.filter(S=>S!==t.id):[...ue.selectedCharacterIds,t.id];mr({...ue,selectedCharacterIds:c})},className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${u?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:t.name}),u&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},t.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"WÃ¤hle die Charaktere aus, die auf dem Cover erscheinen sollen.":a==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre sur la couverture.":"Select the characters that should appear on the cover."})]}),ue.coverType==="front"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Titel:":a==="fr"?"Titre:":"Title:"}),e.jsx("input",{type:"text",value:ue.title||"",onChange:t=>mr({...ue,title:t.target.value}),placeholder:a==="de"?"Der Titel des Buches":a==="fr"?"Le titre du livre":"The book title",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),ue.coverType==="initial"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Widmung:":a==="fr"?"DÃ©dicace:":"Dedication:"}),e.jsx("input",{type:"text",value:ue.dedication||"",onChange:t=>mr({...ue,dedication:t.target.value}),placeholder:a==="de"?'z.B. "FÃ¼r meine liebste Tochter Emma"':a==="fr"?'par ex. "Pour ma chÃ¨re fille Emma"':'e.g. "For my dear daughter Emma"',className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:a==="de"?"Leer lassen fÃ¼r keine Widmung":a==="fr"?"Laisser vide pour aucune dÃ©dicace":"Leave empty for no dedication"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Szenenbeschreibung:":a==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:ue.scene,onChange:t=>mr({...ue,scene:t.target.value}),placeholder:a==="de"?'z.B. "Die Hauptfigur steht vor einem magischen Schloss bei Sonnenuntergang"':a==="fr"?'par ex. "Le personnage principal devant un chÃ¢teau magique au coucher du soleil"':'e.g. "The main character standing in front of a magical castle at sunset"',className:"w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"Tipp: Beschreibe die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":a==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:ue.selectedCharacterIds.length>0&&e.jsx("span",{children:a==="de"?`${ue.selectedCharacterIds.length} Charakter(e) ausgewÃ¤hlt`:a==="fr"?`${ue.selectedCharacterIds.length} personnage(s) sÃ©lectionnÃ©(s)`:`${ue.selectedCharacterIds.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:()=>mr(null),className:"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium order-2 sm:order-1",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"}),e.jsxs("button",{onClick:fr,disabled:M.has(ue.coverType==="front"?"frontCover":ue.coverType==="initial"?"initialPage":"backCover")||ue.selectedCharacterIds.length===0,className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${M.has(ue.coverType==="front"?"frontCover":ue.coverType==="initial"?"initialPage":"backCover")||ue.selectedCharacterIds.length===0?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:[e.jsx(nr,{size:16}),a==="de"?"Neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Kt," ",a==="de"?"Credits":"credits",")"]})]})]})]})]})}),Ge&&e.jsx(bo,{pageNumber:Ge.pageNumber,versions:Ge.versions,onClose:()=>Pr(null),onSelectVersion:Tt,developerMode:xe}),ur&&e.jsx(yo,{src:ur.src,title:ur.title,onClose:()=>Ir(null)}),gt&&e.jsx(vo,{beforeImage:gt.beforeImage,afterImage:gt.afterImage,diffImage:gt.diffImage,title:gt.title,onClose:()=>Ss(null)})]})}const za={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.5 - Best narrative quality",descriptionDe:"Claude Sonnet 4.5 - Beste ErzÃ¤hlqualitÃ¤t",descriptionFr:"Claude Sonnet 4.5 - Meilleure qualitÃ© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 3.5 - Fast and cheap",descriptionDe:"Claude Haiku 3.5 - Schnell und gÃ¼nstig",descriptionFr:"Claude Haiku 3.5 - Rapide et Ã©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe QualitÃ¤t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualitÃ©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - TrÃ¨s rapide"}},Ln={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide de scÃ¨nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra gÃ¼nstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra Ã©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere QualitÃ¤t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualitÃ© ($0.004/image)"}},Co={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - Ã‰valuation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - GrÃ¼ndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},ko={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste QualitÃ¤t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualitÃ© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra gÃ¼nstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra Ã©conomique pour tests ($0.0006/image)"}},Ao={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - GÃ¼nstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars Ã©conomiques avec visage cohÃ©rent (~$0.005)"}};function wr({label:r,icon:i,value:o,options:h,onChange:s,language:R}){const p=A=>R==="de"&&A.descriptionDe?A.descriptionDe:R==="fr"&&A.descriptionFr?A.descriptionFr:A.description;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[i,r]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:o||"",onChange:A=>s(A.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:R==="de"?"Server-Standard":R==="fr"?"Par dÃ©faut serveur":"Server Default"}),Object.entries(h).map(([A,T])=>e.jsxs("option",{value:A,children:[A," ",T.provider?`(${T.provider})`:""]},A))]}),e.jsx(Sr,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),o&&h[o]&&e.jsx("p",{className:"text-[10px] text-gray-500 italic",children:p(h[o])})]})}function Po({selections:r,onChange:i}){const{language:o}=ir(),h=(s,R)=>{i({...r,[s]:R})};return e.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[e.jsx(Ji,{size:16}),o==="de"?"AI-Modell Auswahl (Dev)":o==="fr"?"SÃ©lection de modÃ¨le IA (Dev)":"AI Model Selection (Dev)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(wr,{label:o==="de"?"Ideen-Modell":o==="fr"?"ModÃ¨le d'idÃ©es":"Idea Model",icon:e.jsx(Zi,{size:12}),value:r.ideaModel,options:za,onChange:s=>h("ideaModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Geschichte (Kombiniert)":o==="fr"?"Histoire (CombinÃ©)":"Story (Combined)",icon:e.jsx(js,{size:12}),value:r.outlineModel,options:za,onChange:s=>h("outlineModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Text-Modell":o==="fr"?"ModÃ¨le de texte":"Text Model",icon:e.jsx(js,{size:12}),value:r.textModel,options:za,onChange:s=>h("textModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Szenen-Modell":o==="fr"?"ModÃ¨le de scÃ¨ne":"Scene Description Model",icon:e.jsx(Qn,{size:12}),value:r.sceneDescriptionModel,options:za,onChange:s=>h("sceneDescriptionModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Bild-Modell":o==="fr"?"ModÃ¨le d'image":"Image Model",icon:e.jsx(In,{size:12}),value:r.imageModel,options:Ln,onChange:s=>h("imageModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Cover-Modell":o==="fr"?"ModÃ¨le de couverture":"Cover Image Model",icon:e.jsx(so,{size:12}),value:r.coverImageModel,options:Ln,onChange:s=>h("coverImageModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Bewertungs-Modell":o==="fr"?"ModÃ¨le d'Ã©valuation":"Quality Eval Model",icon:e.jsx(Ei,{size:12}),value:r.qualityModel,options:Co,onChange:s=>h("qualityModel",s),language:o}),e.jsx(wr,{label:o==="de"?"Bild-Reparatur":o==="fr"?"RÃ©paration d'image":"Image Repair",icon:e.jsx(ro,{size:12}),value:r.imageBackend,options:ko,onChange:s=>h("imageBackend",s),language:o}),e.jsx(wr,{label:o==="de"?"Avatar-Modell":o==="fr"?"ModÃ¨le d'avatar":"Avatar Model",icon:e.jsx(In,{size:12}),value:r.avatarModel,options:Ao,onChange:s=>h("avatarModel",s),language:o})]}),e.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:o==="de"?'Hinweis: Nur sichtbar fÃ¼r Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':o==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode dÃ©veloppeur. "Par dÃ©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}const On=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"FranÃ§ais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],Ba={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"SÃ¼ddeutsch"},{code:"de-at",name:"Ã–sterreich"},{code:"de-it",name:"SÃ¼dtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"QuÃ©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"ZÃ¼ritÃ¼Ã¼tsch"},{code:"gsw-be",name:"BÃ¤rndÃ¼tsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"LuzÃ¤rndÃ¼tsch"},{code:"gsw-sg",name:"SanggallerdÃ¼tsch"},{code:"gsw-vs",name:"WalliserdÃ¼tsch"},{code:"gsw-gr",name:"BÃ¼ndnerdÃ¼tsch"}]};function an(r){return r.startsWith("gsw")?"gsw":r.startsWith("de")?"de":r.startsWith("fr")?"fr":r.startsWith("it")?"it":"en"}const $o=["spring","summer","autumn","winter"];function Yn(){const r=new Date().getMonth();return r>=2&&r<=4?"spring":r>=5&&r<=7?"summer":r>=8&&r<=10?"autumn":"winter"}function Io({languageLevel:r,onLanguageLevelChange:i,pages:o,onPagesChange:h,storyLanguage:s,onStoryLanguageChange:R,developerMode:p,userLocation:A,onLocationChange:T,season:W,onSeasonChange:y,userCredits:I}){const{t:M,language:D}=ir(),[X,j]=l.useState(!1),[g,F]=l.useState((A==null?void 0:A.city)||""),[de,z]=l.useState((A==null?void 0:A.country)||""),[v,C]=l.useState(!1),H=l.useRef(null);l.useEffect(()=>{const q=Ie=>{H.current&&!H.current.contains(Ie.target)&&C(!1)};return document.addEventListener("mousedown",q),()=>document.removeEventListener("mousedown",q)},[]);const O=l.useCallback(()=>{const q=an(s),Ie=On.find(Xe=>Xe.family===q),We=Ba[q].find(Xe=>Xe.code===s)||Ba[q][0];return Ie&&We?`${Ie.name} (${We.name})`:(Ie==null?void 0:Ie.name)||s},[s]);l.useEffect(()=>{A&&(F(A.city||""),z(A.country||""))},[A]);const K=()=>{T({city:g||null,region:null,country:de||null}),j(!1)},E={spring:{de:"FrÃ¼hling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"Ã‰tÃ©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},ie=p?4:10,ee=50,ve=2,ye=10,B=I===-1,xe=B?ee:Math.floor(I/ye),De=Math.floor(xe/2)*2,_e=ie*ye,Se=!B&&I<_e,U=_e-I,Ne=Se?ie:Math.min(ee,Math.max(ie,De)),Qe=!B&&De<ee;l.useEffect(()=>{let q=o;q%2!==0&&(q=Math.round(q/2)*2),q=Math.max(ie,Math.min(Ne,q)),q!==o&&h(q)},[o,ie,Ne,h]);const pe=[{value:"1st-grade",label:M.firstGrade,desc:M.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:M.standard,desc:M.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:M.advanced,desc:M.advancedDesc,image:"/images/dense text left.jpg"}],he=(q,Ie=!1)=>{const We=Ie?" (Test)":"",Xe=q*10,Pt=D==="de"?"Credits":D==="fr"?"crÃ©dits":"credits";if(r==="1st-grade")return`${q} ${D==="de"?"Seiten":"pages"} = ${Xe} ${Pt}${We}`;const bt=Math.floor(q/2),or=Math.floor(q/2);return D==="de"?`${q} Seiten (${bt} Text + ${or} Bilder) = ${Xe} ${Pt}${We}`:D==="fr"?`${q} pages (${bt} texte + ${or} images) = ${Xe} ${Pt}${We}`:`${q} pages (${bt} text + ${or} images) = ${Xe} ${Pt}${We}`};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(La,{size:24}),D==="de"?"Buchformat":D==="fr"?"Format du livre":"Book Format"]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:D==="de"?"Sprache:":D==="fr"?"Langue:":"Language:"}),e.jsxs("div",{className:"relative",ref:H,children:[e.jsxs("button",{type:"button",onClick:()=>C(!v),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[O(),e.jsx(Sr,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${v?"rotate-180":""}`})]}),v&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[On.map(q=>{const Ie=an(s)===q.family;return e.jsx("button",{type:"button",onClick:()=>{const We=Ba[q.family][0];R(We.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${Ie?"font-semibold text-indigo-600":"text-gray-700"}`,children:q.name},q.family)}),e.jsx("div",{className:"border-t border-gray-300 my-1"}),Ba[an(s)].map(q=>e.jsx("button",{type:"button",onClick:()=>{R(q.code),C(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${s===q.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:q.name},q.code))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(eo,{className:"text-gray-500",size:16}),e.jsx("span",{className:"text-sm text-gray-600",children:D==="de"?"Ort:":D==="fr"?"Lieu:":"Location:"}),X?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"text",value:g,onChange:q=>F(q.target.value),placeholder:D==="de"?"Stadt":D==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("input",{type:"text",value:de,onChange:q=>z(q.target.value),placeholder:D==="de"?"Land":D==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("button",{onClick:K,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),e.jsx("button",{onClick:()=>j(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"âœ•"})]}):e.jsx("button",{onClick:()=>j(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:A!=null&&A.city?`${A.city}${A.country?`, ${A.country}`:""}`:D==="de"?"Festlegen":D==="fr"?"DÃ©finir":"Set"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:D==="de"?"Jahreszeit:":D==="fr"?"Saison:":"Season:"}),e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:W,onChange:q=>y(q.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:$o.map(q=>e.jsx("option",{value:q,children:E[q][D]||E[q].en},q))}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:M.readingLevel}),e.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:pe.map(q=>e.jsxs("button",{onClick:()=>i(q.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${r===q.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[e.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:e.jsx("img",{src:q.image,alt:q.label,className:"w-full h-full object-contain"})}),e.jsxs("div",{className:"p-2 md:p-2.5",children:[e.jsx("div",{className:"font-semibold text-sm mb-0.5",children:q.label}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:q.desc})]})]},q.value))})]}),r&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:M.numberOfPages}),Se?e.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-red-700 font-semibold mb-2",children:D==="de"?"Nicht genÃ¼gend Credits":D==="fr"?"CrÃ©dits insuffisants":"Not enough credits"}),e.jsx("p",{className:"text-red-600 text-sm",children:D==="de"?`Du benÃ¶tigst mindestens ${_e} Credits fÃ¼r eine Geschichte mit ${ie} Seiten. Dir fehlen noch ${U} Credits.`:D==="fr"?`Vous avez besoin d'au moins ${_e} crÃ©dits pour une histoire de ${ie} pages. Il vous manque ${U} crÃ©dits.`:`You need at least ${_e} credits for a ${ie}-page story. You need ${U} more credits.`}),e.jsx("p",{className:"text-gray-500 text-xs mt-2",children:D==="de"?`Aktuell: ${I} Credits`:D==="fr"?`Actuel: ${I} crÃ©dits`:`Current: ${I} credits`})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"range",min:ie,max:Ne,step:ve,value:Math.min(o,Ne),onChange:q=>h(parseInt(q.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-400",children:ie}),e.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[o," ",D==="de"?"Seiten":"pages"]}),e.jsxs("span",{className:`text-sm ${Qe?"text-orange-500 font-medium":"text-gray-400"}`,children:[Ne,Qe&&" âš ï¸"]})]}),Qe&&e.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:D==="de"?`Max. ${Ne} Seiten mit ${I} Credits mÃ¶glich`:D==="fr"?`Max. ${Ne} pages possibles avec ${I} crÃ©dits`:`Max. ${Ne} pages possible with ${I} credits`}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-base font-medium text-gray-700",children:he(o,o===4)}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r==="1st-grade"?D==="de"?"Jede Seite enthÃ¤lt ein Bild mit Text darunter":D==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":D==="de"?"Abwechselnd Textseite und Bildseite":D==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const To=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:Io,getCurrentSeason:Yn},Symbol.toStringTag,{value:"Module"})),Gn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail prÃ¼fen",description:"Wir haben Ihnen einen BestÃ¤tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail bestÃ¤tigen!",currentEmail:"BestÃ¤tigung gesendet an",sendVerification:"BestÃ¤tigungs-E-Mail senden",resendVerification:"BestÃ¤tigungs-E-Mail erneut senden",emailSent:"BestÃ¤tigungs-E-Mail gesendet! Bitte prÃ¼fen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? Ã„ndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"Ã„ndern & BestÃ¤tigen",cancel:"Abbrechen",emailChanged:"E-Mail geÃ¤ndert! Bitte prÃ¼fen Sie Ihren neuen Posteingang fÃ¼r die BestÃ¤tigung.",checkSpam:"Nicht gefunden? PrÃ¼fen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausfÃ¼llen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function Do({isOpen:r,onClose:i,onVerified:o}){const{language:h}=ir(),{user:s,refreshUser:R}=cn(),p=Gn[h]||Gn.en,[A,T]=l.useState("verify"),[W,y]=l.useState(!1),[I,M]=l.useState(!1),[D,X]=l.useState(""),[j,g]=l.useState(""),[F,de]=l.useState(!1),[z,v]=l.useState(0),[C,H]=l.useState(""),[O,K]=l.useState(""),E=l.useRef(null),ie=l.useRef(null),ee=l.useRef(!1);if(l.useEffect(()=>(z>0&&(ie.current=setTimeout(()=>{v(B=>B-1)},1e3)),()=>{ie.current&&clearTimeout(ie.current)}),[z]),l.useEffect(()=>{if(r&&!ee.current&&!I){ee.current=!0;const B=setTimeout(async()=>{y(!0);try{const xe=await Ve.post("/api/auth/send-verification",{});M(!0),g(p.emailSent),xe.cooldown&&v(xe.cooldown)}catch(xe){const De=xe;De.retryAfter?(v(De.retryAfter),M(!0)):X(De.message||"Failed to send verification email")}finally{y(!1)}},300);return()=>clearTimeout(B)}r||(ee.current=!1)},[r,I,p.emailSent]),l.useEffect(()=>{if(!r){E.current&&(clearInterval(E.current),E.current=null);return}return de(!0),console.log("[EmailVerificationModal] Starting polling"),E.current=setInterval(async()=>{try{const B=await Ve.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",B.emailVerified),B.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await R(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),E.current&&(clearInterval(E.current),E.current=null),de(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),o==null||o(),console.log("[EmailVerificationModal] Calling onClose"),i())}catch(B){console.debug("Verification status poll error:",B)}},3e3),()=>{E.current&&(clearInterval(E.current),E.current=null)}},[r,R,o,i]),!r)return null;const ve=async()=>{y(!0),X("");try{const B=await Ve.post("/api/auth/send-verification",{});M(!0),g(p.emailSent),B.cooldown&&v(B.cooldown)}catch(B){const xe=B;xe.retryAfter?(v(xe.retryAfter),X(h==="de"?`Bitte warten Sie ${xe.retryAfter} Sekunden`:h==="fr"?`Veuillez patienter ${xe.retryAfter} secondes`:`Please wait ${xe.retryAfter} seconds`)):X(xe.message||"Failed to send verification email")}finally{y(!1)}},ye=async()=>{if(!C||!O){X(p.fillAllFields);return}y(!0),X("");try{await Ve.post("/api/auth/change-email",{newEmail:C,password:O}),g(p.emailChanged),T("verify"),H(""),K("")}catch(B){X(B instanceof Error?B.message:"Failed to change email")}finally{y(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[e.jsx("button",{onClick:i,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:e.jsx(zt,{size:20})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Jn,{className:"w-8 h-8 text-indigo-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:p.title}),e.jsx("p",{className:"text-gray-500",children:p.description})]}),D&&e.jsx(An,{variant:"error",className:"mb-4",children:D}),j&&e.jsxs(An,{variant:"success",className:"mb-4",children:[j,e.jsx("p",{className:"text-sm mt-1 opacity-80",children:p.checkSpam})]}),F&&I&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[e.jsx(Ye,{size:16,className:"animate-spin"}),e.jsx("span",{className:"text-sm",children:h==="de"?"Warte auf BestÃ¤tigung...":h==="fr"?"En attente de verification...":"Waiting for verification..."})]}),A==="verify"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:p.currentEmail}),e.jsx("p",{className:"font-medium text-gray-800",children:s==null?void 0:s.email})]}),e.jsxs(Ma,{onClick:ve,variant:"primary",loading:W,disabled:z>0,className:"w-full",children:[e.jsx(nr,{size:16,className:"mr-2"}),z>0?`${h==="de"?"Warten":h==="fr"?"Patienter":"Wait"} ${z}s`:I?p.resendVerification:p.sendVerification]}),e.jsxs("button",{onClick:()=>{T("change"),X(""),g("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[e.jsx(ct,{size:16}),p.changeEmail]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(kn,{type:"email",label:p.newEmail,value:C,onChange:B=>H(B.target.value),placeholder:"your@newemail.com",disabled:W}),e.jsx(kn,{type:"password",label:p.currentPassword,value:O,onChange:B=>K(B.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:W}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ma,{onClick:()=>{T("verify"),X(""),H(""),K("")},variant:"secondary",className:"flex-1",disabled:W,children:p.cancel}),e.jsx(Ma,{onClick:ye,variant:"primary",loading:W,className:"flex-1",children:p.confirmChange})]})]})]})})}const un=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "},inverse:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"},inverse:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"},inverse:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function Ro(r){const i=un.find(o=>o.value.en==="Not Known to");return i?i.value[r]:"Not Known to"}function _n(r){const i=un.find(o=>o.value.en==="Not Known to");return i?r===i.value.en||r===i.value.de||r===i.value.fr:!1}function Eo(r,i,o=[]){for(const h of un)if(h.value[i]===r)return h.inverse[i];for(const h of o){if(h.forward===r)return h.inverse;if(h.inverse===r)return h.forward}return r}const Fo=1440*60*1e3;function Oa(r){const i=`avatar_regen_${r}`,o=localStorage.getItem(i),h=Date.now();if(!o)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:s,lastAttempt:R}=JSON.parse(o);if(h-R>Fo)return localStorage.removeItem(i),{canRegenerate:!0,waitSeconds:0,attempts:0};let p=0;s>=2&&s<4?p=30*1e3:s>=4&&s<6?p=60*1e3:s>=6&&s<8?p=120*1e3:s>=8&&s<10?p=300*1e3:s>=10&&(p=600*1e3);const A=h-R;return A>=p?{canRegenerate:!0,waitSeconds:0,attempts:s}:{canRegenerate:!1,waitSeconds:Math.ceil((p-A)/1e3),attempts:s}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function Xn(r){const i=`avatar_regen_${r}`,o=localStorage.getItem(i),h=Date.now();let s=1;if(o)try{s=(JSON.parse(o).attempts||0)+1}catch{}localStorage.setItem(i,JSON.stringify({attempts:s,lastAttempt:h}))}function ul(r){const[i,o]=l.useState(()=>Oa(r));l.useEffect(()=>{if(i.waitSeconds>0){const s=setInterval(()=>{o(Oa(r))},1e3);return()=>clearInterval(s)}},[i.waitSeconds,r]);const h=l.useCallback(()=>{Xn(r),o(Oa(r))},[r]);return{...i,recordRegeneration:h}}const Hn={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte wÃ¤hlen Sie aus, welches Gesicht zu dem Charakter gehÃ¶rt, den Sie erstellen mÃ¶chten.",selectFace:"Gesicht auswÃ¤hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages dÃ©tectÃ©s",description:"Nous avons dÃ©tectÃ© plusieurs personnes sur votre photo. Veuillez sÃ©lectionner le visage du personnage que vous souhaitez crÃ©er.",selectFace:"SÃ©lectionner le visage",uploadDifferent:"TÃ©lÃ©charger une autre photo",confidence:"Confiance"}};function zo({isOpen:r,faces:i,onSelect:o,onUploadNew:h,developerMode:s=!1}){const{language:R}=ir(),p=Hn[R]||Hn.en;return e.jsx(Vi,{isOpen:r,onClose:h,title:p.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-600 text-center",children:p.description}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:i.map((A,T)=>e.jsxs("button",{onClick:()=>o(A.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:e.jsx("img",{draggable:!1,src:A.thumbnail,alt:`Face ${T+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[p.selectFace," ",T+1]})}),s&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[p.confidence,": ",Math.round(A.confidence*100),"%"]})]},A.id))}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("button",{onClick:h,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[e.jsx(ao,{size:20}),p.uploadDifferent]})})]})})}const gl=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et quÃªtes hÃ©roÃ¯ques"},emoji:"ðŸ—¡ï¸"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"CompÃ©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei alltÃ¤glichen Herausforderungen",fr:"Aide pour surmonter les dÃ©fis quotidiens"},emoji:"ðŸ’ª"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"ðŸ“š"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais Ã©vÃ©nements historiques"},emoji:"ðŸ›ï¸"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"DÃ©cris ta propre idÃ©e d'histoire"},emoji:"âœ¨"}],Bo=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],hl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"Ã‰poques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"HÃ©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"PersonnalisÃ©"}}],ln=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"ðŸ´â€â˜ ï¸",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"âš”ï¸",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ðŸ¤ ",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ðŸ¥·",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"âš“",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"ðŸ›ï¸",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes Ã„gypten",fr:"Ã‰gypte Ancienne"},emoji:"ðŸº",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"GrÃ¨ce Antique"},emoji:"ðŸº",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"Ã‚ge de Pierre"},emoji:"ðŸ¦´",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure SamouraÃ¯"},emoji:"ðŸŽŒ",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & SorciÃ¨re"},emoji:"ðŸ§™",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"QuÃªte du Dragon"},emoji:"ðŸ‰",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ðŸ¦„",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de SirÃ¨ne"},emoji:"ðŸ§œâ€â™€ï¸",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ðŸ¦–",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-hÃ©ros"},emoji:"ðŸ¦¸",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"ðŸš€",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des OcÃ©ans"},emoji:"ðŸŒŠ",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"ðŸŒ´",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie Ã  la Ferme"},emoji:"ðŸ„",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la ForÃªt"},emoji:"ðŸ¦Š",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"ðŸš’",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"ðŸ‘¨â€âš•ï¸",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"ðŸ‘®",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"MystÃ¨re DÃ©tective"},emoji:"ðŸ”",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de NoÃ«l"},emoji:"ðŸŽ„",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"ðŸŽ†",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de PÃ¢ques"},emoji:"ðŸ°",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"ðŸŽƒ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},emoji:"âœ¨",group:"custom"}],xl={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"ðŸ "},Vn=[{id:"potty-training",name:{en:"Potty Training",de:"TÃ¶pfchen-Training",fr:"Apprentissage du pot"},emoji:"ðŸš½",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"HÃ¤nde waschen",fr:"Se laver les mains"},emoji:"ðŸ§¼",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"ZÃ¤hne putzen",fr:"Se brosser les dents"},emoji:"ðŸª¥",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"GemÃ¼se essen",fr:"Manger des lÃ©gumes"},emoji:"ðŸ¥¦",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"ðŸ›ï¸",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"ðŸ‘‹",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de tÃ©tine"},emoji:"ðŸ¼",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"AufrÃ¤umen",fr:"Ranger les jouets"},emoji:"ðŸ§¹",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ðŸª‘",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre Ã  partager"},emoji:"ðŸ¤",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten kÃ¶nnen",fr:"Attendre son tour"},emoji:"â³",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"ðŸŽ’",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"ðŸ‘«",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"ÃŠtre courageux"},emoji:"ðŸ’ª",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau bÃ©bÃ© dans la famille"},emoji:"ðŸ‘¶",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'Ã©cole"},emoji:"ðŸ«",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"ðŸ“",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre Ã  lire"},emoji:"ðŸ“–",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren kÃ¶nnen",fr:"Savoir perdre"},emoji:"ðŸŽ¯",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"ÃŠtre diffÃ©rent c'est bien"},emoji:"ðŸŒˆ",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit HÃ¤nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"ðŸ›¡ï¸",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la vÃ©ritÃ©"},emoji:"âœ…",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"ðŸŒŸ",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"DÃ©mÃ©nagement"},emoji:"ðŸ ",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"âœˆï¸",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents sÃ©parÃ©s"},emoji:"ðŸ’”",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le mÃ©decin"},emoji:"ðŸ¥",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"SÃ©jour Ã  l'hÃ´pital"},emoji:"ðŸ©º",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"ðŸŒˆ",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"â¤ï¸",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"Ã‰conomiser de l'argent"},emoji:"ðŸ’°",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"DÃ©penser intelligemment"},emoji:"ðŸ›’",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"Ã‰quilibre du temps d'Ã©cran"},emoji:"ðŸ“±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"ðŸ‘¥",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"KÃ¶rperliche VerÃ¤nderungen",fr:"Changements corporels"},emoji:"ðŸŒ±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung Ã¼bernehmen",fr:"Prendre ses responsabilitÃ©s"},emoji:"ðŸŽ¯",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"â°",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"SÃ©curitÃ© en ligne"},emoji:"ðŸ”’",ageGroup:"preteen"}],Mo=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],pl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-VerÃ¤nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"PrÃ©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"Ã‰cole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"VorpubertÃ¤t (9-12)",fr:"PrÃ©adolescent (9-12)"},ageRange:"9-12"}],Wn=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"ðŸ”¤",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"ðŸ…°ï¸",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"ReimwÃ¶rter",fr:"Mots qui riment"},emoji:"ðŸŽµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"ðŸ”¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"ðŸ”¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"ZÃ¤hlen lernen",fr:"Apprendre Ã  compter"},emoji:"âœ‹",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"ðŸ”·",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"âž•",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"ðŸŒˆ",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"MÃ©langer les couleurs"},emoji:"ðŸŽ¨",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"PlanÃ¨tes & Espace"},emoji:"ðŸª",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"ðŸ‚",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"MÃ©tÃ©o"},emoji:"â›…",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"ðŸ’§",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"ðŸŒ±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"ðŸŒ™",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"ðŸ·",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ðŸ¦",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"ðŸ‹",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & KÃ¤fer",fr:"Insectes"},emoji:"ðŸ›",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ðŸ¦•",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"KÃ¶rperteile",fr:"Parties du corps"},emoji:"ðŸ«€",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die fÃ¼nf Sinne",fr:"Les cinq sens"},emoji:"ðŸ‘ï¸",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ðŸ¥—",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"ðŸ“…",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'annÃ©e"},emoji:"ðŸ—“ï¸",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"ðŸ•",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"ðŸŒ",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"LÃ¤nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"ðŸ³ï¸",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"ðŸŽ¸",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"BerÃ¼hmte KÃ¼nstler",fr:"Artistes cÃ©lÃ¨bres"},emoji:"ðŸ–¼ï¸",group:"arts"}],Lo=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],fl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"KÃ¶rper & Gesundheit",fr:"Corps & SantÃ©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & GÃ©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],Oo=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],bl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"â­"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"ðŸ‡¨ðŸ‡­"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & DÃ©couverte"},icon:"ðŸ§­"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & MÃ©decine"},icon:"ðŸ”¬"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"ðŸ’¡"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & LibertÃ©"},icon:"âœŠ"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"ðŸ—ï¸"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"ðŸŽ­"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"ArchÃ¤ologische Entdeckungen",fr:"DÃ©couvertes ArchÃ©ologiques"},icon:"ðŸº"}],qn=[{id:"swiss-founding",name:{en:"Founding of Switzerland (RÃ¼tlischwur)",de:"GrÃ¼ndung der Schweiz (RÃ¼tlischwur)",fr:"Fondation de la Suisse (Serment du GrÃ¼tli)"},shortName:{en:"RÃ¼tlischwur",de:"RÃ¼tlischwur",fr:"Serment du GrÃ¼tli"},emoji:"ðŸ¤",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"ðŸ¹",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"âš”ï¸",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"ðŸ›¡ï¸",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"RÃ©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"RÃ©forme"},emoji:"ðŸ“œ",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant grÃ¼ndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"â¤ï¸",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"GÃ©nÃ©ral Dufour et l'unitÃ© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"GÃ©nÃ©ral Dufour"},emoji:"ðŸŽ–ï¸",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"ðŸ”ï¸",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution fÃ©dÃ©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"ðŸ“‹",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"ðŸš‚",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer NeutralitÃ¤t im 1. Weltkrieg",fr:"NeutralitÃ© suisse pendant la PremiÃ¨re Guerre"},shortName:{en:"WWI Neutrality",de:"NeutralitÃ¤t 1. WK",fr:"NeutralitÃ© 1GM"},emoji:"ðŸ•Šï¸",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the RÃ¼tli Report",de:"General Guisan und der RÃ¼tlirapport",fr:"GÃ©nÃ©ral Guisan et le Rapport du GrÃ¼tli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"GÃ©nÃ©ral Guisan"},emoji:"ðŸŽ–ï¸",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2Ã¨me GM"},emoji:"ðŸ”ï¸",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"ðŸŒ™",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les AmÃ©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"DÃ©couverte de l'AmÃ©rique"},emoji:"â›µ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motorisÃ©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"âœˆï¸",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"PremiÃ¨re traversÃ©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"ðŸ›©ï¸",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"ðŸ”ï¸",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am SÃ¼dpol",fr:"Premier au PÃ´le Sud"},shortName:{en:"South Pole",de:"SÃ¼dpol",fr:"PÃ´le Sud"},emoji:"â„ï¸",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"ðŸŒ",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"PlongÃ©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"PlongÃ©e profonde"},emoji:"ðŸŒŠ",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"ExpÃ©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"ElektrizitÃ¤t entdeckt",fr:"DÃ©couverte Ã©lectricitÃ©"},emoji:"âš¡",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"DÃ©couverte de la pÃ©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"PÃ©nicilline"},emoji:"ðŸ’Š",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"ðŸ’‰",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN dÃ©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"DÃ©couverte ADN"},emoji:"ðŸ§¬",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nommÃ©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"DÃ©couverte dinosaure"},emoji:"ðŸ¦•",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins RelativitÃ¤tstheorie",fr:"RelativitÃ© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"ThÃ©orie d'Einstein"},emoji:"ðŸ§ ",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits GalÃ¡pagos",de:"Darwin auf GalÃ¡pagos",fr:"Darwin aux GalÃ¡pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"ðŸ¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"PremiÃ¨re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"â¤ï¸",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschlÃ¼sselt",fr:"GÃ©nome humain dÃ©codÃ©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet GÃ©nome"},emoji:"ðŸ§ª",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement tÃ©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"TÃ©lescope Hubble"},emoji:"ðŸ”­",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel tÃ©lÃ©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"TÃ©lÃ©phone"},emoji:"ðŸ“ž",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons GlÃ¼hbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"GlÃ¼hbirne",fr:"Ampoule"},emoji:"ðŸ’¡",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"ðŸ“–",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"ðŸŒ",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"â›“ï¸",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"ðŸšŒ",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"ðŸ§±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela libÃ©rÃ©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"âœŠ",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"ðŸ”º",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm erÃ¶ffnet",fr:"Tour Eiffel inaugurÃ©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"ðŸ—¼",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal erÃ¶ffnet",fr:"Canal de Panama inaugurÃ©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"ðŸš¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"ðŸŒ‰",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel erÃ¶ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"ðŸš‡",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"ðŸ…",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland erÃ¶ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"ðŸ°",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cinÃ©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"ðŸŽ¬",year:1895,category:"culture",mainPerson:"LumiÃ¨re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ðŸ¦",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"MusÃ©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"MusÃ©e Histoire Naturelle"},emoji:"ðŸ›ï¸",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de ToutÃ¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"ToutÃ¢nkhamon"},emoji:"ðŸ‘‘",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"RedÃ©couverte de PompÃ©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"PompÃ©i"},emoji:"ðŸŒ‹",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"ArmÃ©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"ArmÃ©e terre cuite"},emoji:"ðŸ—¿",year:1974,category:"archaeology"}];function yl(r){return r==="popular"?ln.filter(i=>Bo.includes(i.id)):ln.filter(i=>i.group===r)}function vl(r){return r==="popular"?Vn.filter(i=>Mo.includes(i.id)):Vn.filter(i=>i.ageGroup===r)}function jl(r){return r==="popular"?Wn.filter(i=>Lo.includes(i.id)):Wn.filter(i=>i.group===r)}function Nl(r){return r==="popular"?qn.filter(i=>Oo.includes(i.id)):qn.filter(i=>i.category===r)}const Go={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},ar={enableAutoRepair:!1,enableFinalChecks:!0,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null,enableSceneValidation:!1,separatedEvaluation:!1};function _o(){const r=localStorage.getItem("developer_mode")==="true",[i,o]=l.useState(r),[h,s]=l.useState(null),[R,p]=l.useState("auto"),[A,T]=l.useState(!1),[W,y]=l.useState(!1),[I,M]=l.useState(!1),[D,X]=l.useState(!1),[j,g]=l.useState(r),[F,de]=l.useState(ar.enableAutoRepair),[z,v]=l.useState(ar.enableFinalChecks),[C,H]=l.useState(ar.incrementalConsistency),[O,K]=l.useState(ar.incrementalConsistencyDryRun),[E,ie]=l.useState(ar.lookbackCount),[ee,ve]=l.useState(ar.checkOnlyMode),[ye,B]=l.useState(ar.useGridRepair),[xe,De]=l.useState(ar.forceRepairThreshold),[_e,Se]=l.useState(ar.enableSceneValidation),[U,Ne]=l.useState(ar.separatedEvaluation),[Qe,pe]=l.useState(!1),[he,q]=l.useState({...Go}),Ie=We=>{o(We),g(!!We)};return l.useEffect(()=>{i?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[i]),{developerMode:i,setDeveloperMode:Ie,imageGenMode:h,setImageGenMode:s,generationMode:R,setGenerationMode:p,devSkipOutline:A,setDevSkipOutline:T,devSkipText:W,setDevSkipText:y,devSkipSceneDescriptions:I,setDevSkipSceneDescriptions:M,devSkipImages:D,setDevSkipImages:X,devSkipCovers:j,setDevSkipCovers:g,enableAutoRepair:F,setEnableAutoRepair:de,enableFinalChecks:z,setEnableFinalChecks:v,incrementalConsistency:C,setIncrementalConsistency:H,incrementalConsistencyDryRun:O,setIncrementalConsistencyDryRun:K,lookbackCount:E,setLookbackCount:ie,checkOnlyMode:ee,setCheckOnlyMode:ve,useGridRepair:ye,setUseGridRepair:B,forceRepairThreshold:xe,setForceRepairThreshold:De,enableSceneValidation:_e,setEnableSceneValidation:Se,separatedEvaluation:U,setSeparatedEvaluation:Ne,loadAllAvatars:Qe,setLoadAllAvatars:pe,modelSelections:he,setModelSelections:q}}const Ho=l.lazy(()=>Qs(()=>import("./WizardStep2Characters-fZ81qkoc.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])).then(r=>({default:r.WizardStep2Characters}))),Vo=l.lazy(()=>Qs(()=>Promise.resolve().then(()=>To),void 0).then(r=>({default:r.WizardStep3BookSettings}))),Wo=l.lazy(()=>Qs(()=>import("./WizardStep4StoryType-SfqxNJhe.js"),__vite__mapDeps([24,1,2,3,4,7,17,12,13,5,6,8,18,19,14,20,21,9,22,23,15])).then(r=>({default:r.WizardStep4StoryType}))),qo=l.lazy(()=>Qs(()=>import("./WizardStep5ArtStyle-Czf3x7pR.js"),__vite__mapDeps([25,1,2,3,4,26,20])).then(r=>({default:r.WizardStep5ArtStyle}))),Uo=l.lazy(()=>Qs(()=>import("./WizardStep6Summary-B3yYkLL0.js"),__vite__mapDeps([27,1,2,3,4,26,17,9,7,5,6,8,18,19,12,13,14,20,21,22,23,15])).then(r=>({default:r.WizardStep6Summary}))),x=dn("StoryWizard"),Un={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"FÃ¼ge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die BuchlÃ¤nge und das Leseniveau fÃ¼r dein Publikum fest",3:"WÃ¤hle einen Geschichtstyp und ein Thema",4:"WÃ¤hle einen Illustrationsstil fÃ¼r dein Buch",5:"ÃœberprÃ¼fe deine Auswahl, fÃ¼ge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils apparaÃ®tront de maniÃ¨re cohÃ©rente dans toute votre histoire!",2:"DÃ©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un thÃ¨me",4:"Choisissez un style d'illustration pour votre livre",5:"VÃ©rifiez vos choix, ajoutez des dÃ©tails de l'intrigue, puis gÃ©nÃ©rez votre histoire!"}};function Ko(){const r=Bi(),[i,o]=Mi(),{t:h,language:s}=ir(),{isAuthenticated:R,user:p,updateCredits:A,refreshUser:T,isLoading:W,isImpersonating:y}=cn(),{showSuccess:I,showInfo:M,showError:D}=Fi(),{startTracking:X,stopTracking:j,activeJob:g,isComplete:F,completedStoryId:de,markCompletionViewed:z,hasUnviewedCompletion:v}=zi(),[C,H]=l.useState(()=>{const n=new URLSearchParams(window.location.search);if(n.get("storyId"))return 6;if(n.get("new")==="true")return 1;const b=localStorage.getItem("wizard_step");return b?parseInt(b,10):1}),[O,K]=l.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[E,ie]=l.useState(null),{developerMode:ee,setDeveloperMode:ve,imageGenMode:ye,setImageGenMode:B,generationMode:xe,setGenerationMode:De,devSkipOutline:_e,setDevSkipOutline:Se,devSkipText:U,setDevSkipText:Ne,devSkipSceneDescriptions:Qe,setDevSkipSceneDescriptions:pe,devSkipImages:he,setDevSkipImages:q,devSkipCovers:Ie,setDevSkipCovers:We,enableAutoRepair:Xe,setEnableAutoRepair:Pt,useGridRepair:bt,setUseGridRepair:or,forceRepairThreshold:es,setForceRepairThreshold:Kt,enableFinalChecks:Zs,setEnableFinalChecks:Ys,incrementalConsistency:Cr,setIncrementalConsistency:kr,incrementalConsistencyDryRun:Xs,setIncrementalConsistencyDryRun:a,lookbackCount:ke,setLookbackCount:lt,checkOnlyMode:we,setCheckOnlyMode:Ns,enableSceneValidation:yt,setEnableSceneValidation:lr,separatedEvaluation:Jt,setSeparatedEvaluation:Mr,loadAllAvatars:dr,setLoadAllAvatars:ts,modelSelections:tt,setModelSelections:ea}=_o(),[$t,Qt]=l.useState(()=>localStorage.getItem("story_type")||""),[Ae,Ar]=l.useState(()=>localStorage.getItem("story_category")||""),[Oe,rs]=l.useState(()=>localStorage.getItem("story_topic")||""),[Ge,Pr]=l.useState(()=>localStorage.getItem("story_theme")||""),[Ue,cr]=l.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[jt,mt]=l.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[be,ue]=l.useState([]),[mr,ut]=l.useState(null),[w,Pe]=l.useState(null),ws=l.useRef([]),$r=l.useRef(null),[ta,at]=l.useState(!1),[ra,et]=l.useState("photo"),[sa,ur]=l.useState(!1),[Ir,gt]=l.useState(null),[Ss,gr]=l.useState(!1),[ss,Bt]=l.useState(!1),[as,Cs]=l.useState(void 0),[Ga,ks]=l.useState(void 0),aa=l.useRef(null),[_a,hr]=l.useState(!1),[ns,As]=l.useState([]),[Lr,is]=l.useState(null),[Ps,Or]=l.useState(null),[ht,Gr]=l.useState({}),[It,$s]=l.useState({}),[Tr,na]=l.useState([]),Is=l.useRef(null),xr=l.useRef(!1),Dr=l.useRef(!1),[_r,ia]=l.useState(!1),[Mt,Lt]=l.useState([]),[xt,Hr]=l.useState([]),os=l.useRef(!1),[Nt,Ot]=l.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[Tt,oa]=l.useState(()=>{try{const n=localStorage.getItem("story_language");if(n){if(n==="de")return"de-ch";if(n==="fr")return"fr-ch";if(n==="it")return"it-ch";if(n==="en")return"en-gb";if(n.startsWith("de")||n.startsWith("fr")||n.startsWith("it")||n.startsWith("en")||n.startsWith("gsw"))return n}return"de-ch"}catch{return"de-ch"}}),[pt,ls]=l.useState(()=>{try{const n=localStorage.getItem("story_pages");return n?parseInt(n):30}catch{return 30}}),[pr,Vr]=l.useState(()=>localStorage.getItem("story_dedication")||""),[fr,Gt]=l.useState(()=>localStorage.getItem("story_details")||""),[Dt,Zt]=l.useState(!1),[Ts,Wr]=l.useState(!1),[_t,wt]=l.useState(!1),[ds,la]=l.useState(0),[da,Ds]=l.useState(0),[Ht,qr]=l.useState(null),[Ur,Rr]=l.useState(""),[St,Vt]=l.useState([]),[ca,Rs]=l.useState(null),[Es,ma]=l.useState(null),Yt=l.useRef(null),[Xt,Fs]=l.useState(null),[er,ua]=l.useState(()=>Yn()),[t,u]=l.useState(!1),[c,S]=l.useState(new Set),[d,J]=l.useState(!1),[ne,Be]=l.useState(!1),[$e,Ze]=l.useState(!1),[ft,Ct]=l.useState(!1),[oe,it]=l.useState(!1),[Kr,tr]=l.useState(!1),[br,rr]=l.useState({current:0,total:0,message:""}),[kt,Er]=l.useState(null),[ga,yr]=l.useState(!1),[cs,Wt]=l.useState(""),[vr,Fr]=l.useState(""),[ha,zs]=l.useState(""),[xa,Bs]=l.useState(""),[pa,Ms]=l.useState(""),[fa,Ls]=l.useState(),[ba,Os]=l.useState(),[ya,Gs]=l.useState([]),[va,jr]=l.useState(null),[ja,Jr]=l.useState(null),[Na,ms]=l.useState([]),[wa,us]=l.useState([]),[Sa,gs]=l.useState([]),[me,rt]=l.useState(null),[Ke,qt]=l.useState([]),[hs,Rt]=l.useState([]),[_s,sr]=l.useState({frontCover:null,initialPage:null,backCover:null}),[je,Ha]=l.useState(null),[ei,ti]=l.useState(0),[Va,Ca]=l.useState(null),[ri,gn]=l.useState(!1),[si,hn]=l.useState(),[ai,xn]=l.useState(),[ni,pn]=l.useState(),[ii,Wa]=l.useState(null),qa=l.useRef(!1),xs=l.useRef(!1),[At,ka]=l.useState(null),[Ua,Aa]=l.useState({}),[oi,Pa]=l.useState(!1),[st,$a]=l.useState(null),[Hs,Vs]=l.useState("");l.useEffect(()=>{ws.current=be},[be]),l.useEffect(()=>{$r.current=w},[w]),l.useEffect(()=>{if(!W&&!R){if(!!localStorage.getItem("auth_token")){x.debug("Token found but not authenticated yet, waiting for state sync...");return}const b=window.location.pathname+window.location.search,m=encodeURIComponent(b);r(`/?login=true&redirect=${m}`)}},[R,W,r]);const Ka=l.useCallback(n=>{var b,m,$,f,N,P,L,k,re,Q;if(n){if((b=n.sceneImages)!=null&&b.length&&Rt(te=>te.map(le=>{const Ce=n.sceneImages.find(qe=>qe.pageNumber===le.pageNumber);return Ce?{...le,prompt:Ce.prompt??le.prompt,qualityReasoning:Ce.qualityReasoning??le.qualityReasoning,retryHistory:Ce.retryHistory??le.retryHistory,repairHistory:Ce.repairHistory??le.repairHistory,wasRegenerated:Ce.wasRegenerated??le.wasRegenerated,originalScore:Ce.originalScore??le.originalScore,originalReasoning:Ce.originalReasoning??le.originalReasoning,totalAttempts:Ce.totalAttempts??le.totalAttempts,faceEvaluation:Ce.faceEvaluation??le.faceEvaluation,referencePhotos:Ce.referencePhotos??le.referencePhotos,landmarkPhotos:Ce.landmarkPhotos??le.landmarkPhotos,consistencyRegen:Ce.consistencyRegen??le.consistencyRegen}:le})),n.coverImages&&sr(te=>{var qe;const le={...te},Ce=["frontCover","initialPage","backCover"];for(const Je of Ce){const se=(qe=n.coverImages)==null?void 0:qe[Je],Le=te[Je];se&&typeof Le=="object"&&Le!==null&&(le[Je]={...Le,prompt:se.prompt??Le.prompt,qualityReasoning:se.qualityReasoning??Le.qualityReasoning,retryHistory:se.retryHistory??Le.retryHistory,referencePhotos:se.referencePhotos??Le.referencePhotos,landmarkPhotos:se.landmarkPhotos??Le.landmarkPhotos})}return le}),console.log("[StoryWizard] Dev metadata generationLog:",((m=n.generationLog)==null?void 0:m.length)||0,"entries"),($=n.generationLog)!=null&&$.length&&gs(n.generationLog),(f=n.styledAvatarGeneration)!=null&&f.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",((N=n.styledAvatarGeneration)==null?void 0:N.length)??0,"entries"),ms(n.styledAvatarGeneration)),(P=n.costumedAvatarGeneration)!=null&&P.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",((L=n.costumedAvatarGeneration)==null?void 0:L.length)??0,"entries"),us(n.costumedAvatarGeneration)),n.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",n.finalChecksReport.totalIssues,"issues"),rt(n.finalChecksReport)),(k=n.sceneDescriptions)!=null&&k.length){const te=n.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",te.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(te[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((re=te[0])!=null&&re.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((Q=te[0])!=null&&Q.scenePrompt)),qt(n.sceneDescriptions)}n.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),jr(n.visualBible))}},[]);l.useEffect(()=>{Fe.getUserLocation().then(n=>{Fs(n),n!=null&&n.city&&Fe.triggerLandmarkDiscovery(n.city,n.country)})},[]),l.useEffect(()=>{R&&Fe.getStories({limit:1}).then(({pagination:n})=>{it(n.total>0)}).catch(()=>it(!1))},[R]);const Ja=l.useRef(null);l.useEffect(()=>{const n=i.get("storyId");i.get("new")!=="true"&&(n&&(Ja.current=null),g&&!n&&Ja.current!==g.jobId&&(x.info("Returning during active generation, restoring progress for job:",g.jobId),Ja.current=g.jobId,H(6),u(!0),Wt(g.storyTitle),Ca(g.jobId),Fe.getJobStatus(g.jobId).then(m=>{var $,f;if(x.info("Restored job status:",{progress:m.progress,hasStoryText:!!m.storyText,storyTextKeys:m.storyText?Object.keys(m.storyText):[],pageTextsCount:($=m.storyText)!=null&&$.pageTexts?Object.keys(m.storyText.pageTexts).length:0,partialPages:((f=m.partialPages)==null?void 0:f.length)||0}),m.progress&&rr(N=>m.progress.current>=N.current?m.progress:{...N,message:m.progress.message}),m.storyText){const N=m.storyText.pageTexts||{};x.info("Setting progressiveStoryData with",Object.keys(N).length,"pages"),ka({title:m.storyText.title||g.storyTitle,dedication:m.storyText.dedication,pageTexts:N,sceneDescriptions:m.storyText.sceneDescriptions||[],totalPages:m.storyText.totalPages||pt})}else x.warn("No storyText in job status response");if(m.partialPages&&m.partialPages.length>0){const N={};m.partialPages.forEach(P=>{P.pageNumber&&P.imageData&&(N[P.pageNumber]=P.imageData)}),x.info("Restored",Object.keys(N).length,"page images"),Aa(N)}m.partialCovers&&sr(N=>{var P,L,k;return{frontCover:((P=m.partialCovers)==null?void 0:P.frontCover)||N.frontCover,initialPage:((L=m.partialCovers)==null?void 0:L.initialPage)||N.initialPage,backCover:((k=m.partialCovers)==null?void 0:k.backCover)||N.backCover}})}).catch(m=>{x.error("Failed to restore job status:",m)})),x.debug("Auto-nav check:",{generationComplete:F,completedStoryId:de,urlStoryId:n,hasActiveJob:!!g}),F&&de&&!n&&(x.info("Generation completed, navigating to story:",de),o({storyId:de},{replace:!0})))},[g,F,de,i,o,pt]),l.useEffect(()=>{if(i.get("new")==="true"){x.info("New story requested - resetting all story settings"),Qt(""),Ar(""),rs(""),Pr(""),cr(""),mt("watercolor"),Ot("standard"),ls(30),Vr(""),Gt(""),ut(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const b=new URLSearchParams(i);b.delete("new"),o(b,{replace:!0}),Pe(null),et("photo"),H(1)}},[i,o]),l.useEffect(()=>{const n=i.get("storyId");n&&C!==6&&H(6),(async()=>{if(!(!n||!R)){if(qa.current){qa.current=!1,x.info("Skipping story reload - just finished generating");return}x.info("Loading saved story progressively:",n),K(!0),ie(null),Er(null);try{await Fe.getStoryProgressively(n,(m,$)=>{var f,N,P,L;x.info("Metadata loaded:",m.title,`(${$} images to load)`),Ha(m.id),Wt(m.title||""),Qt(m.storyType||""),mt(m.artStyle||"pixar"),Bs(m.outline||""),Ms(m.outlinePrompt||""),Ls(m.outlineModelId),Os(m.outlineUsage),Gs(m.storyTextPrompts||[]),ms(m.styledAvatarGeneration||[]),us(m.costumedAvatarGeneration||[]),(f=m.generationLog)!=null&&f.length&&(console.log("[StoryWizard] Loading story metadata, generationLog:",((N=m.generationLog)==null?void 0:N.length)??0,"entries"),gs(m.generationLog)),m.visualBible?jr({mainCharacters:m.visualBible.mainCharacters||[],secondaryCharacters:m.visualBible.secondaryCharacters||[],animals:m.visualBible.animals||[],artifacts:m.visualBible.artifacts||[],locations:m.visualBible.locations||[],vehicles:m.visualBible.vehicles||[],clothing:m.visualBible.clothing||[],changeLog:m.visualBible.changeLog||[]}):jr(null),m.clothingRequirements?Jr(m.clothingRequirements):Jr(null),Rt(m.sceneImages||[]),qt(m.sceneDescriptions||[]),sr(m.coverImages||{frontCover:null,initialPage:null,backCover:null}),Ot(m.languageLevel||"standard"),m.language&&oa(m.language),u(!1),gn(m.isPartial||!1),hn(m.failureReason),xn(m.generatedPages),pn(m.totalPages),Fr(m.story||""),zs(m.originalStory||m.story||""),Wa({storyCategory:m.storyCategory,storyTopic:m.storyTopic,storyTheme:m.storyTheme,storyTypeName:m.storyTypeName,storyDetails:m.storyDetails,artStyle:m.artStyle,language:m.language,languageLevel:m.languageLevel,pages:m.pages,dedication:m.dedication,characters:(P=m.characters)==null?void 0:P.map(k=>{var re;return{id:k.id,name:k.name,isMain:(re=m.mainCharacters)==null?void 0:re.includes(k.id)}}),mainCharacters:m.mainCharacters,relationships:m.relationships,relationshipTexts:m.relationshipTexts,season:m.season,userLocation:m.userLocation}),(L=m.characters)!=null&&L.length&&ut(m.characters.map(k=>{var re,Q;return{id:k.id,name:k.name,photoData:k.photoData||((re=k.photos)==null?void 0:re.face)||((Q=k.photos)==null?void 0:Q.original)}})),H(6),K(!1),ie(null),$>0&&Er({loaded:0,total:$}),xs.current=!0,Fe.getStoryDevMetadata(n).then(k=>{Ka(k),x.debug("Dev metadata merged into story")}).catch(k=>{x.warn("Failed to load dev metadata:",k),xs.current=!1})},(m,$,f,N)=>{if(typeof m=="number")Rt(P=>P.map(L=>{if(L.pageNumber!==m)return L;const k=L.imageVersions||[],re=f==null?void 0:f.map((Q,te)=>({...k[te]||{},...Q}));return{...L,imageData:$,imageVersions:re||k}}));else{const P=m;sr(L=>{const k=L[P];return typeof k=="object"&&k!==null?{...L,[P]:{...k,imageData:$}}:{...L,[P]:$}})}N!==void 0&&Er(P=>P?{...P,loaded:N}:null)},()=>{x.info("All images loaded"),Er(null)})}catch(m){x.error("Failed to load story:",m),K(!1),ie(null),Er(null)}}})()},[i,R,ei]),l.useEffect(()=>{C===6&&v&&(x.info("Clearing unviewed completion - user is viewing story"),z())},[C,v,z]),l.useEffect(()=>{(async()=>{const b=i.get("payment"),m=i.get("session_id");if(b==="success"&&m){x.info("Payment successful! Checking order status..."),x.info("Session ID:",m);try{const N=await Fe.getOrderStatus(m);if(x.info("Order Status:",N),N.order){const P=`CHF ${(N.order.amount_total/100).toFixed(2)}`,L={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement rÃ©ussi!"},k={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a Ã©tÃ© reÃ§ue et sera bientÃ´t imprimÃ©e."},re=[`${s==="de"?"Kunde":s==="fr"?"Client":"Customer"}: ${N.order.customer_name}`,`Email: ${N.order.customer_email}`,`${s==="de"?"Betrag":s==="fr"?"Montant":"Amount"}: ${P}`,`${s==="de"?"Versand an":s==="fr"?"ExpÃ©diÃ© Ã ":"Shipping to"}: ${N.order.shipping_name}`,`${N.order.shipping_address_line1}`,`${N.order.shipping_postal_code} ${N.order.shipping_city}`,`${N.order.shipping_country}`];I(k[s]||k.en,L[s]||L.en,re)}}catch(N){x.error("Error checking order status:",N)}const f=new URLSearchParams(i);f.delete("payment"),f.delete("session_id"),o(f,{replace:!0})}else if(b==="cancelled"){x.info("Payment cancelled by user");const f={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie kÃ¶nnen es erneut versuchen.",fr:"Paiement annulÃ©. Vous pouvez rÃ©essayer quand vous Ãªtes prÃªt."};M(f[s]||f.en,s==="de"?"Abgebrochen":s==="fr"?"AnnulÃ©":"Cancelled");const N=new URLSearchParams(i);N.delete("payment"),o(N,{replace:!0})}const $=i.get("credits_payment");if($==="success"){x.info("Credits payment successful!"),await T();const f={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},N={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};I(N[s]||N.en,f[s]||f.en);const P=new URLSearchParams(i);P.delete("credits_payment"),P.delete("session_id"),o(P,{replace:!0})}else if($==="cancelled"){x.info("Credits payment cancelled by user");const f={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};M(f[s]||f.en,s==="de"?"Abgebrochen":s==="fr"?"Annule":"Cancelled");const N=new URLSearchParams(i);N.delete("credits_payment"),o(N,{replace:!0})}})()},[i,o,s,I,M,T]);const Ia=l.useRef(!1);l.useEffect(()=>{if(i.get("autoGenerate")==="true"&&!Ia.current){Ia.current=!0;const b=localStorage.getItem("pending_story_type"),m=localStorage.getItem("pending_art_style");b&&(Qt(b),localStorage.removeItem("pending_story_type")),m&&(mt(m),localStorage.removeItem("pending_art_style")),H(6);const $=new URLSearchParams(i);$.delete("autoGenerate"),o($,{replace:!0})}},[i,o]);const Qa=n=>{if(n.length===0)return;const b=n.filter(m=>{const $=parseInt(m.age);return $>=1&&$<=10});if(b.length>0){const m=b.map($=>$.id);Lt(m),x.info(`Auto-selected ${b.length} main character(s) aged 1-10`)}else{const m=n.reduce(($,f)=>{const N=parseInt(f.age)||999,P=parseInt($.age)||999;return N<P?f:$});Lt([m.id]),x.info(`Auto-selected youngest character as main: ${m.name} (age ${m.age})`)}};l.useEffect(()=>{R?(async()=>{try{K(!0);const b=await ze.getCharacterData(dr);if(x.info("Loaded character data from API:",{characters:b.characters.length,relationships:Object.keys(b.relationships).length}),ue(b.characters),Object.keys(b.relationships).length>0&&(Gr(b.relationships),xr.current=!0),Object.keys(b.relationshipTexts).length>0&&$s(b.relationshipTexts),b.customRelationships.length>0&&na(b.customRelationships),b.characters.some($=>$.storyRole)){const $=[],f=[];for(const N of b.characters)N.storyRole==="main"?$.push(N.id):N.storyRole==="out"&&f.push(N.id);Lt($),Hr(f),x.info(`Loaded character roles from database: ${$.length} main, ${f.length} excluded`)}else b.characters.length>0&&Qa(b.characters)}catch(b){x.error("Failed to load character data:",b)}finally{K(!1),ia(!0)}})():W||ia(!0)},[R,W]),l.useEffect(()=>{ee&&je&&!xs.current&&(xs.current=!0,x.info("Developer mode enabled, fetching dev metadata for story:",je),Fe.getStoryDevMetadata(je).then(n=>{Ka(n),x.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(n=>{x.warn("Failed to load dev metadata on toggle:",n),xs.current=!1})),(!ee||!je)&&(xs.current=!1)},[ee,je,Ka]),l.useEffect(()=>{dr&&R&&_r&&(async()=>{try{x.info("Reloading characters with full avatars (dev mode)");const b=await ze.getCharacterData(!0);ue(b.characters),x.info(`Loaded ${b.characters.length} characters with full avatars`)}catch(b){x.error("Failed to reload with full avatars:",b)}})()},[dr,R,_r]),l.useEffect(()=>{C===1&&be.length===0&&!w&&!O&&_r&&Ya()},[C,be.length,w,O,_r]);const Za=l.useRef(xt);l.useEffect(()=>{Za.current!==xt&&JSON.stringify(Za.current)!==JSON.stringify(xt)&&(Vt([]),Gt(""),Za.current=xt)},[xt]),l.useEffect(()=>{localStorage.setItem("story_language_level",Nt)},[Nt]),l.useEffect(()=>{localStorage.setItem("story_language",Tt)},[Tt]),l.useEffect(()=>{localStorage.setItem("story_pages",pt.toString())},[pt]),l.useEffect(()=>{localStorage.setItem("story_dedication",pr)},[pr]),l.useEffect(()=>{localStorage.setItem("story_details",fr)},[fr]),l.useEffect(()=>{localStorage.setItem("story_type",$t)},[$t]),l.useEffect(()=>{Ae?localStorage.setItem("story_category",Ae):localStorage.removeItem("story_category")},[Ae]),l.useEffect(()=>{Oe?localStorage.setItem("story_topic",Oe):localStorage.removeItem("story_topic")},[Oe]),l.useEffect(()=>{Ge?localStorage.setItem("story_theme",Ge):localStorage.removeItem("story_theme")},[Ge]),l.useEffect(()=>{Ue?localStorage.setItem("story_custom_theme_text",Ue):localStorage.removeItem("story_custom_theme_text")},[Ue]);const fn=l.useRef(Ae),bn=l.useRef(Oe),yn=l.useRef(Ge),vn=l.useRef(!0);l.useEffect(()=>{if(vn.current){vn.current=!1;return}const n=fn.current!==Ae,b=bn.current!==Oe,m=yn.current!==Ge;(n||b||m)&&(Gt(""),localStorage.removeItem("story_details"),Vt([])),fn.current=Ae,bn.current=Oe,yn.current=Ge},[Ae,Oe,Ge]),l.useEffect(()=>{localStorage.setItem("story_art_style",jt)},[jt]);const Ws=l.useRef(!1);l.useEffect(()=>{if(C===4&&!Ws.current&&!Dt&&St.length===0){const n=!!Ae,b=!!Ge||!!Oe,m=be.length>0;n&&b&&m&&(Ws.current=!0,x.info("[StoryWizard] Pre-generating story ideas while user selects art style"),wn())}Ws.current&&St.length===0&&(Ws.current=!1)},[C,Ae,Ge,Oe,be.length,Dt,St.length]);const jn=l.useRef({storyCategory:Ae,storyTheme:Ge,storyTopic:Oe});l.useEffect(()=>{const n=jn.current,b=n.storyCategory!==Ae||n.storyTheme!==Ge||n.storyTopic!==Oe;jn.current={storyCategory:Ae,storyTheme:Ge,storyTopic:Oe},b&&(Dt||St.length>0)&&(x.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),Yt.current&&(Yt.current.abort(),Yt.current=null),Zt(!1),Wr(!1),wt(!1),Vt([]),qr(null),Rr(""),Ws.current=!1)},[Ae,Ge,Oe,Dt,St.length]),l.useEffect(()=>{if(!Dt)return;const b=setTimeout(()=>{x.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),Zt(!1),Wr(!1),wt(!1),D(s==="de"?"ZeitÃ¼berschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":s==="fr"?"DÃ©lai d'attente de gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(b)},[Dt,s]),l.useEffect(()=>{if(!Ts&&!_t){la(0),Ds(0);return}const n=35e3,b=80,m=100,$=Date.now(),f=setInterval(()=>{const N=Date.now()-$,P=Math.min(N/n,1),L=1-Math.pow(1-P,3),k=Math.round(L*b);Ts&&la(k),_t&&Ds(k),P>=1&&clearInterval(f)},m);return()=>clearInterval(f)},[Ts,_t]),l.useEffect(()=>{C>=1&&C<=5&&localStorage.setItem("wizard_step",C.toString())},[C]);const li=n=>{Ar(n)},di=n=>{Pr(n),!(n==="custom"||n==="realistic"||n==="")&&(Ae==="adventure"||(Ae==="life-challenge"||Ae==="educational")&&Oe!=="")&&Nr(4)},ci=n=>{rs(n),Ae==="historical"&&n!==""&&Nr(4)},mi=n=>{mt(n),Nr(5)};l.useEffect(()=>{if(C===2&&be.length>=2&&!O){const n=be.map(b=>b.id).sort().join("-");if(!Is.current||Is.current!==n){const m=Ro(s);x.debug("Initializing relationships for step 2",{charKey:n,existingCount:Object.keys(ht).length}),Gr($=>{const f={...$};let N=!1;return be.forEach((P,L)=>{be.forEach((k,re)=>{if(L!==re){const Q=`${P.id}-${k.id}`;f[Q]||(f[Q]=m,N=!0,x.debug("Initializing missing relationship:",Q))}})}),N?f:$}),Is.current=n}}},[C,be,s,O]);const ui=()=>{if(be.length<2)return!0;for(let n=0;n<be.length;n++)for(let b=0;b<be.length;b++)if(n!==b){const m=`${be[n].id}-${be[b].id}`,$=ht[m];if(!$||_n($))return!1}return!0},gi=()=>{if(be.length<2)return null;let n=0,b=null;for(const m of be){let $=0;for(const f of be)if(m.id!==f.id){const N=`${m.id}-${f.id}`,P=ht[N];(!P||_n(P))&&$++}$>n&&(n=$,b=m)}return b},Ya=()=>{Pe({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),et("photo"),at(!1)},hi=(n,b=1500)=>new Promise(m=>{const $=new Image;$.onload=()=>{const f=document.createElement("canvas");let{width:N,height:P}=$;(N>b||P>b)&&(N>P?(P=Math.round(P*b/N),N=b):(N=Math.round(N*b/P),P=b)),f.width=N,f.height=P;const L=f.getContext("2d");L==null||L.drawImage($,0,0,N,P),m(f.toDataURL("image/jpeg",.85))},$.onerror=()=>m(n),$.src=n}),xi=async(n,b)=>{var f,N,P,L,k;if(x.info(`ðŸ“¸ handlePhotoSelect called: file=${n==null?void 0:n.name}, character=${w==null?void 0:w.name}, developerMode=${ee}`),w&&!ee){const re=!!((f=w.avatars)!=null&&f.winter||(N=w.avatars)!=null&&N.standard||(P=w.avatars)!=null&&P.summer||(L=w.avatars)!=null&&L.hasFullAvatars);if(x.info(`ðŸ“¸ hasAvatars=${re}`),re){const Q=Oa(w.id);if(x.info(`ðŸ“¸ cooldown check: canRegenerate=${Q.canRegenerate}, waitSeconds=${Q.waitSeconds}`),!Q.canRegenerate){const te=s==="de"?`Bitte warten Sie ${Q.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${Q.waitSeconds} seconds before uploading a new photo.`;D(te);return}Xn(w.id)}}const m=b&&((k=w==null?void 0:w.clothing)!=null&&k.structured)?{...w.clothing.structured}:null,$=new FileReader;$.onload=async re=>{var te,le,Ce,qe,Je,se,Le,ae,V,G,Z,_;const Q=(te=re.target)==null?void 0:te.result;w&&(aa.current={physical:w.physical,gender:w.gender,age:w.age}),Cs(void 0),ur(!0),!(w!=null&&w.name)||w.name.trim().length<2?et("name"):(et("traits"),x.info("ðŸ“¸ Character has name, going to traits step to show avatar regeneration"));try{const ce=await hi(Q),Re=Math.round(Q.length/1024),Y=Math.round(ce.length/1024);x.info(`Starting photo analysis... (${Re}KB -> ${Y}KB)`);const Te=w!=null&&w.id&&w.id>0?w.id:void 0,fe=await ze.analyzePhoto(ce,s,void 0,void 0,Te);if(fe.success){if(fe.multipleFacesDetected&&fe.faces&&fe.faces.length>1){x.info(`Multiple faces detected (${fe.faces.length}), showing selection modal`),is(ce),Or(m?{structured:m}:null),As(fe.faces),hr(!0),ur(!1);return}x.info("Photo analysis complete:",{hasPhotos:!!fe.photos,hasPhysical:!!fe.physical,hasClothing:!!fe.clothing,age:fe.age,gender:fe.gender}),fe._debug&&(ks(fe._debug),fe._debug.rawResponse,fe._debug.error&&console.warn("ðŸ“¸ [DEBUG] Gemini error:",fe._debug.error));const He={original:((le=fe.photos)==null?void 0:le.face)||Q,face:(Ce=fe.photos)==null?void 0:Ce.face,body:((qe=fe.photos)==null?void 0:qe.body)||Q,bodyNoBg:(Je=fe.photos)==null?void 0:Je.bodyNoBg,faceBox:(se=fe.photos)==null?void 0:se.faceBox,bodyBox:(Le=fe.photos)==null?void 0:Le.bodyBox},nt=(ae=fe.photos)!=null&&ae.bodyNoBg?Math.round(fe.photos.bodyNoBg.length/1024):0,dt=(V=fe.photos)!=null&&V.body?Math.round(fe.photos.body.length/1024):0,Ta=(G=fe.photos)!=null&&G.face?Math.round(fe.photos.face.length/1024):0;if(x.info(`ðŸ“¸ [PHOTO CHANGE] Analysis returned: bodyNoBg=${nt}KB, body=${dt}KB, face=${Ta}KB`),(Z=fe.photos)!=null&&Z.bodyNoBg){const Ee=fe.photos.bodyNoBg.substring(fe.photos.bodyNoBg.indexOf("base64,")+7,fe.photos.bodyNoBg.indexOf("base64,")+27);x.info(`ðŸ“¸ [PHOTO CHANGE] bodyNoBg fingerprint: ${Ee}...`)}let Ut,Da;m?(Ut={structured:m},Da={upperBody:m.upperBody?"user":void 0,lowerBody:m.lowerBody?"user":void 0,shoes:m.shoes?"user":void 0,fullBody:m.fullBody?"user":void 0},x.info(`ðŸ‘• Keeping old clothing (marked as user-edited): ${JSON.stringify(m)}`)):x.info("ðŸ‘• Using new photo's clothing (cleared existing)");const Ra=fe.characterId,en=(w==null?void 0:w.id)&&w.id>0,ps=en?w.id:Ra;en?x.info(`ðŸ“¸ [PHOTO] Keeping existing character ID: ${w.id} (server created new ID ${Ra} but ignoring)`):Ra&&x.info(`ðŸ“¸ [PHOTO] Using server-created character ID: ${Ra}`);const Et=w?{...w,id:ps||w.id,photos:He,avatars:{status:"generating"},clothing:Ut,clothingSource:Da}:null;if(Et){const Ee=(_=Et.photos)==null?void 0:_.bodyNoBg,vt=Ee?Math.round(Ee.length/1024):0;if(x.info(`ðŸ“¸ [CHAR FOR GEN] bodyNoBg=${vt}KB, has photos: ${!!Et.photos}`),Ee){const Me=Ee.substring(Ee.indexOf("base64,")+7,Ee.indexOf("base64,")+27);x.info(`ðŸ“¸ [CHAR FOR GEN] fingerprint: ${Me}...`)}}if(Pe(Ee=>{var Me;if(!Ee)return null;const vt=(Me=Ee.avatars)!=null&&Me.standard?{...Ee.avatars,status:"generating",stale:!0}:{status:"generating"};return{...Ee,id:ps||Ee.id,photos:He,avatars:vt,clothing:Ut,clothingSource:Da}}),ps&&!en&&ue(Ee=>{if(!Ee.some(Me=>Me.id===ps)){const Me={...w,id:ps,photos:He,avatars:{status:"generating"},clothing:Ut,clothingSource:Da};return x.info(`ðŸ“¸ Adding new character ${ps} to array to prevent data loss`),[...Ee,Me]}return Ee}),x.info("ðŸŽ¨ Auto-starting avatar generation in background..."),x.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!He.bodyNoBg}, body=${!!He.body}, face=${!!He.face}`),Et&&Et.id&&Et.name&&Et.name.trim()){const Ee=Et.id;gt(Ee),ze.generateAndSaveAvatarForCharacter(Et,void 0,{avatarModel:tt.avatarModel||void 0}).then(vt=>{vt.success&&vt.character?(Pe(Me=>!Me||Me.id!==Ee?Me:{...Me,avatars:vt.character.avatars,physical:vt.character.physical,clothing:vt.character.clothing}),ue(Me=>Me.map(Ft=>Ft.id===Ee?{...Ft,...vt.character,id:Ft.id}:Ft)),x.success(`âœ… Avatar generated and traits extracted for ${Et.name}`)):(x.error(`âŒ Avatar generation failed: ${vt.error}`),Pe(Me=>Me&&Me.id===Ee?{...Me,avatars:{status:"failed"}}:Me),ue(Me=>Me.map(Ft=>Ft.id===Ee?{...Ft,avatars:{status:"failed"}}:Ft)))}).catch(vt=>{x.error("âŒ Avatar generation error:",vt),Pe(Me=>Me&&Me.id===Ee?{...Me,avatars:{status:"failed"}}:Me),ue(Me=>Me.map(Ft=>Ft.id===Ee?{...Ft,avatars:{status:"failed"}}:Ft))}).finally(()=>{gt(null)})}else Et&&Et.id?(x.info("â­ï¸ Skipping auto-generation: character has no name yet"),gt(null),Pe(Ee=>Ee&&{...Ee,avatars:{status:"pending"}})):(x.warn("â­ï¸ Skipping auto-generation: no character data available"),gt(null))}else fe.error==="no_face_detected"?(x.warn("No face detected in photo"),D(h.noFaceDetected)):(x.warn("Photo analysis returned no data, using original photo"),Pe(He=>He?{...He,photos:{original:Q},avatars:void 0}:null))}catch(ce){x.error("Photo analysis error:",ce),Pe(Re=>Re?{...Re,photos:{original:Q},avatars:void 0}:null)}finally{ur(!1)}},$.readAsDataURL(n)},pi=async n=>{var b,m,$,f,N,P,L,k;if(!Lr){x.error("No pending photo data for face selection");return}hr(!1),ur(!0);try{x.info(`Re-analyzing photo with selected face ID: ${n}`);const re=ns.map(le=>({id:le.id,x:le.faceBox.x,y:le.faceBox.y,width:le.faceBox.width,height:le.faceBox.height,confidence:le.confidence})),Q=w!=null&&w.id&&w.id>0?w.id:void 0,te=await ze.analyzePhoto(Lr,s,n,re,Q);if(te.success){x.info("Photo analysis complete with selected face:",{hasPhotos:!!te.photos,hasPhysical:!!te.physical,hasClothing:!!te.clothing,age:te.age,gender:te.gender}),te._debug&&ks(te._debug);const le=Ps==null?void 0:Ps.structured,Ce={original:((b=te.photos)==null?void 0:b.face)||Lr,face:(m=te.photos)==null?void 0:m.face,body:(($=te.photos)==null?void 0:$.body)||Lr,bodyNoBg:(f=te.photos)==null?void 0:f.bodyNoBg,faceBox:(N=te.photos)==null?void 0:N.faceBox,bodyBox:(P=te.photos)==null?void 0:P.bodyBox},qe=(L=te.photos)!=null&&L.bodyNoBg?Math.round(te.photos.bodyNoBg.length/1024):0;if(x.info(`ðŸ“¸ [FACE SELECT] Analysis returned: bodyNoBg=${qe}KB`),(k=te.photos)!=null&&k.bodyNoBg){const Z=te.photos.bodyNoBg.substring(te.photos.bodyNoBg.indexOf("base64,")+7,te.photos.bodyNoBg.indexOf("base64,")+27);x.info(`ðŸ“¸ [FACE SELECT] bodyNoBg fingerprint: ${Z}...`)}let Je,se;le&&(Je={structured:le},se={upperBody:le.upperBody?"user":void 0,lowerBody:le.lowerBody?"user":void 0,shoes:le.shoes?"user":void 0,fullBody:le.fullBody?"user":void 0});const Le=te.characterId,ae=(w==null?void 0:w.id)&&w.id>0,V=ae?w.id:Le;ae?x.info(`ðŸ“¸ [FACE SELECT] Keeping existing character ID: ${w.id} (server created new ID ${Le} but ignoring)`):Le&&x.info(`ðŸ“¸ [FACE SELECT] Using server-created character ID: ${Le}`);const G=w?{...w,id:V||w.id,photos:Ce,avatars:{status:"generating"},clothing:Je,clothingSource:se}:null;if(Pe(Z=>{var ce;if(!Z)return null;const _=(ce=Z.avatars)!=null&&ce.standard?{...Z.avatars,status:"generating",stale:!0}:{status:"generating"};return{...Z,id:V||Z.id,photos:Ce,avatars:_,clothing:Je,clothingSource:se}}),V&&!ae&&ue(Z=>{if(!Z.some(ce=>ce.id===V)){const ce={...w,id:V,photos:Ce,avatars:{status:"generating"},clothing:Je,clothingSource:se};return x.info(`ðŸ“¸ [FACE SELECT] Adding new character ${V} to array to prevent data loss`),[...Z,ce]}return Z}),w!=null&&w.name&&w.name.trim().length>=2?(et("traits"),x.info("ðŸ“¸ Face selected, character has name, going to traits step")):et("name"),x.info("ðŸŽ¨ Auto-starting avatar generation in background after face selection..."),x.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Ce.bodyNoBg}, body=${!!Ce.body}, face=${!!Ce.face}`),G&&G.name&&G.name.trim()){const Z=G.id;gt(Z),ze.generateAndSaveAvatarForCharacter(G,void 0,{avatarModel:tt.avatarModel||void 0}).then(_=>{_.success&&_.character?(Pe(ce=>!ce||ce.id!==Z?ce:{...ce,avatars:_.character.avatars,physical:_.character.physical,clothing:_.character.clothing}),ue(ce=>ce.map(Re=>Re.id===Z?{...Re,..._.character,id:Re.id}:Re)),x.success(`âœ… Avatar generated for ${G.name} (face selection)`)):(x.error(`âŒ Avatar generation failed: ${_.error}`),Pe(ce=>ce&&ce.id===Z?{...ce,avatars:{status:"failed"}}:ce),ue(ce=>ce.map(Re=>Re.id===Z?{...Re,avatars:{status:"failed"}}:Re)))}).catch(_=>{x.error("âŒ Avatar generation error:",_),Pe(ce=>ce&&ce.id===Z?{...ce,avatars:{status:"failed"}}:ce),ue(ce=>ce.map(Re=>Re.id===Z?{...Re,avatars:{status:"failed"}}:Re))}).finally(()=>{gt(null)})}else x.info("â­ï¸ Skipping auto-generation: character has no name yet"),gt(null),Pe(Z=>Z&&{...Z,avatars:{status:"pending"}})}else x.warn("Photo analysis failed after face selection"),D(h.noFaceDetected)}catch(re){x.error("Photo analysis error after face selection:",re),D("Failed to analyze photo. Please try again.")}finally{ur(!1),is(null),Or(null),As([])}},fi=()=>{hr(!1),is(null),Or(null),As([]),et("photo")},bi=async()=>{if(w){Pe(n=>n&&{...n,avatars:void 0}),gr(!0);try{x.info(`ðŸ”„ Regenerating avatars for ${w.name}...`);const n=await ze.regenerateAvatarsForCharacter(w.id,(b,m)=>x.info(`[${b}] ${m}`),{avatarModel:tt.avatarModel||void 0});if(n.success&&n.character){const b={...n.character.avatars,stale:!1};Pe(m=>m&&{...m,avatars:b,physical:n.character.physical,clothing:n.character.clothing}),ue(m=>m.map($=>$.id===w.id?{...$,avatars:b,physical:n.character.physical,clothing:n.character.clothing}:$)),x.success(`âœ… Avatars and traits regenerated for ${w.name}`)}else x.error(`âŒ Failed to regenerate avatars: ${n.error}`),D(`Failed to regenerate avatars: ${n.error||"Unknown error"}`)}catch(n){x.error(`âŒ Failed to regenerate avatars for ${w.name}:`,n),D(`Failed to regenerate avatars: ${n instanceof Error?n.message:"Unknown error"}`)}finally{gr(!1)}}},yi=async()=>{var n,b,m,$,f,N,P,L,k,re,Q,te,le,Ce,qe,Je;if(w){Pe(se=>se&&{...se,avatars:void 0}),Bt(!0);try{x.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${w.name}...`),x.info(`Physical traits: ${JSON.stringify(w.physical)}`);const se=await ze.generateClothingAvatarsWithTraits(w);if(se.success&&se.avatars){const Le={...se.avatars,stale:!1,generatedAt:new Date().toISOString()},ae=w.physicalTraitsSource||{},V=se.extractedTraits?{height:(n=w.physical)==null?void 0:n.height,eyeColor:ae.eyeColor==="user"?(b=w.physical)==null?void 0:b.eyeColor:se.extractedTraits.eyeColor,eyeColorHex:ae.eyeColor==="user"?(m=w.physical)==null?void 0:m.eyeColorHex:se.extractedTraits.eyeColorHex,hairColor:ae.hairColor==="user"?($=w.physical)==null?void 0:$.hairColor:se.extractedTraits.hairColor,hairColorHex:ae.hairColor==="user"?(f=w.physical)==null?void 0:f.hairColorHex:se.extractedTraits.hairColorHex,hairLength:ae.hairLength==="user"?(N=w.physical)==null?void 0:N.hairLength:se.extractedTraits.hairLength,hairStyle:ae.hairStyle==="user"?(P=w.physical)==null?void 0:P.hairStyle:se.extractedTraits.hairStyle,build:ae.build==="user"?(L=w.physical)==null?void 0:L.build:se.extractedTraits.build,face:ae.face==="user"?(k=w.physical)==null?void 0:k.face:se.extractedTraits.face,facialHair:ae.facialHair==="user"?(re=w.physical)==null?void 0:re.facialHair:se.extractedTraits.facialHair,other:ae.other==="user"?(Q=w.physical)==null?void 0:Q.other:se.extractedTraits.other,skinTone:ae.skinTone==="user"?(te=w.physical)==null?void 0:te.skinTone:se.extractedTraits.skinTone,skinToneHex:ae.skinTone==="user"?(le=w.physical)==null?void 0:le.skinToneHex:se.extractedTraits.skinToneHex,detailedHairAnalysis:se.extractedTraits.detailedHairAnalysis||((Ce=w.physical)==null?void 0:Ce.detailedHairAnalysis),apparentAge:ae.apparentAge==="user"?(qe=w.physical)==null?void 0:qe.apparentAge:se.extractedTraits.apparentAge||((Je=w.physical)==null?void 0:Je.apparentAge)}:w.physical,G=se.extractedTraits?{eyeColor:ae.eyeColor==="user"?"user":se.extractedTraits.eyeColor?"extracted":void 0,hairColor:ae.hairColor==="user"?"user":se.extractedTraits.hairColor?"extracted":void 0,hairLength:ae.hairLength==="user"?"user":se.extractedTraits.hairLength?"extracted":void 0,hairStyle:ae.hairStyle==="user"?"user":se.extractedTraits.hairStyle?"extracted":void 0,build:ae.build==="user"?"user":se.extractedTraits.build?"extracted":void 0,face:ae.face==="user"?"user":se.extractedTraits.face?"extracted":void 0,facialHair:ae.facialHair==="user"?"user":se.extractedTraits.facialHair?"extracted":void 0,other:ae.other==="user"?"user":se.extractedTraits.other?"extracted":void 0,skinTone:ae.skinTone==="user"?"user":se.extractedTraits.skinTone?"extracted":void 0,apparentAge:ae.apparentAge==="user"?"user":se.extractedTraits.apparentAge?"extracted":void 0}:w.physicalTraitsSource,Z=se.extractedClothing?{...w.clothing,structured:{upperBody:se.extractedClothing.upperBody||void 0,lowerBody:se.extractedClothing.lowerBody||void 0,shoes:se.extractedClothing.shoes||void 0,fullBody:se.extractedClothing.fullBody||void 0}}:w.clothing;Pe(_=>_&&{..._,avatars:Le,physical:V,physicalTraitsSource:G,clothing:Z}),ue(_=>_.map(ce=>ce.id===w.id?{...ce,avatars:Le,physical:V,physicalTraitsSource:G,clothing:Z}:ce)),x.success(`âœ… Avatars WITH TRAITS regenerated for ${w.name}`),se.extractedTraits&&x.info(`ðŸ“‹ Extracted traits saved: ${JSON.stringify(se.extractedTraits)}`),se.extractedClothing&&x.info(`ðŸ‘• Extracted clothing saved: ${JSON.stringify(se.extractedClothing)}`)}else x.error(`âŒ Failed to regenerate avatars with traits: ${se.error}`),D(`Failed to regenerate avatars: ${se.error||"Unknown error"}`)}catch(se){x.error(`âŒ Failed to regenerate avatars with traits for ${w.name}:`,se),D(`Failed to regenerate avatars: ${se instanceof Error?se.message:"Unknown error"}`)}finally{Bt(!1)}}},vi=async()=>{var m,$,f,N,P,L,k,re,Q,te,le,Ce,qe,Je,se,Le;if(!w)return;const n={...w},b=w.id;Bt(!0);try{x.info(`ðŸ’¾ Saving character and regenerating avatars for ${n.name}...`),await Xa(),x.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${n.name}...`);const V=(await new Promise(Z=>{ue(_=>(Z(_),_))})).find(Z=>Z.id===b);if(!V){x.warn("Character not found in characters array after save");return}const G=await ze.generateClothingAvatarsWithTraits(V);if(G.success&&G.avatars){const Z={...G.avatars,stale:!1,generatedAt:new Date().toISOString()},_=V.physicalTraitsSource||{},ce=G.extractedTraits?{height:(m=V.physical)==null?void 0:m.height,eyeColor:_.eyeColor==="user"?($=V.physical)==null?void 0:$.eyeColor:G.extractedTraits.eyeColor,eyeColorHex:_.eyeColor==="user"?(f=V.physical)==null?void 0:f.eyeColorHex:G.extractedTraits.eyeColorHex,hairColor:_.hairColor==="user"?(N=V.physical)==null?void 0:N.hairColor:G.extractedTraits.hairColor,hairColorHex:_.hairColor==="user"?(P=V.physical)==null?void 0:P.hairColorHex:G.extractedTraits.hairColorHex,hairLength:_.hairLength==="user"?(L=V.physical)==null?void 0:L.hairLength:G.extractedTraits.hairLength,hairStyle:_.hairStyle==="user"?(k=V.physical)==null?void 0:k.hairStyle:G.extractedTraits.hairStyle,build:_.build==="user"?(re=V.physical)==null?void 0:re.build:G.extractedTraits.build,face:_.face==="user"?(Q=V.physical)==null?void 0:Q.face:G.extractedTraits.face,facialHair:_.facialHair==="user"?(te=V.physical)==null?void 0:te.facialHair:G.extractedTraits.facialHair,other:_.other==="user"?(le=V.physical)==null?void 0:le.other:G.extractedTraits.other,skinTone:_.skinTone==="user"?(Ce=V.physical)==null?void 0:Ce.skinTone:G.extractedTraits.skinTone,skinToneHex:_.skinTone==="user"?(qe=V.physical)==null?void 0:qe.skinToneHex:G.extractedTraits.skinToneHex,detailedHairAnalysis:G.extractedTraits.detailedHairAnalysis||((Je=V.physical)==null?void 0:Je.detailedHairAnalysis),apparentAge:_.apparentAge==="user"?(se=V.physical)==null?void 0:se.apparentAge:G.extractedTraits.apparentAge||((Le=V.physical)==null?void 0:Le.apparentAge)}:V.physical,Re=G.extractedTraits?{eyeColor:_.eyeColor==="user"?"user":G.extractedTraits.eyeColor?"extracted":void 0,hairColor:_.hairColor==="user"?"user":G.extractedTraits.hairColor?"extracted":void 0,hairLength:_.hairLength==="user"?"user":G.extractedTraits.hairLength?"extracted":void 0,hairStyle:_.hairStyle==="user"?"user":G.extractedTraits.hairStyle?"extracted":void 0,build:_.build==="user"?"user":G.extractedTraits.build?"extracted":void 0,face:_.face==="user"?"user":G.extractedTraits.face?"extracted":void 0,facialHair:_.facialHair==="user"?"user":G.extractedTraits.facialHair?"extracted":void 0,other:_.other==="user"?"user":G.extractedTraits.other?"extracted":void 0,skinTone:_.skinTone==="user"?"user":G.extractedTraits.skinTone?"extracted":void 0,apparentAge:_.apparentAge==="user"?"user":G.extractedTraits.apparentAge?"extracted":void 0}:V.physicalTraitsSource,Y=G.extractedClothing?{...V.clothing,structured:{upperBody:G.extractedClothing.upperBody||void 0,lowerBody:G.extractedClothing.lowerBody||void 0,shoes:G.extractedClothing.shoes||void 0,fullBody:G.extractedClothing.fullBody||void 0}}:V.clothing;Pe(nt=>nt&&nt.id===b?{...nt,avatars:Z,physical:ce,physicalTraitsSource:Re,clothing:Y}:nt),ue(nt=>nt.map(dt=>dt.id===b?{...dt,avatars:Z,physical:ce,physicalTraitsSource:Re,clothing:Y}:dt)),x.success(`âœ… Avatars regenerated for ${V.name}`);const Te={...V,avatars:Z,physical:ce,physicalTraitsSource:Re,clothing:Y},He=(await new Promise(nt=>{ue(dt=>(nt(dt),dt))})).map(nt=>nt.id===b?Te:nt);await ze.saveCharacterData({characters:He,relationships:ht,relationshipTexts:It,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]}),x.success("ðŸ’¾ Character saved with new avatars, traits, and clothing"),I(s==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else x.error(`âŒ Failed to regenerate avatars: ${G.error}`),D(`Failed to regenerate avatars: ${G.error||"Unknown error"}`)}catch(ae){x.error("âŒ Failed to save and regenerate:",ae),D(`Failed: ${ae instanceof Error?ae.message:"Unknown error"}`)}finally{Bt(!1)}},ji=async()=>{var $,f,N,P,L,k,re,Q,te,le,Ce,qe,Je,se,Le,ae,V,G;if(!w)return;const n=w.id;Cs(void 0),et("traits");const b=($=w.avatars)==null?void 0:$.status,m=!!((f=w.avatars)!=null&&f.standard||(N=w.avatars)!=null&&N.winter||(P=w.avatars)!=null&&P.summer||(L=w.avatars)!=null&&L.hasFullAvatars);if(b==="generating"||b==="complete"&&m){x.info(`â­ï¸ Skipping avatar generation - already ${b}${m?" with avatars":""}`);return}gt(n),Pe(Z=>Z&&Z.id===n?{...Z,avatars:{status:"generating"}}:Z),x.info(`ðŸŽ¨ Starting avatar generation for ${w.name||"unnamed"} (id: ${n})...`);try{const Z=await ze.generateClothingAvatarsWithTraits(w);if(Z.success&&Z.avatars){const _={...Z.avatars,stale:!1,generatedAt:new Date().toISOString()},ce=Z.extractedTraits?{...w.physical,build:Z.extractedTraits.build||((k=w.physical)==null?void 0:k.build),eyeColor:Z.extractedTraits.eyeColor||((re=w.physical)==null?void 0:re.eyeColor),eyeColorHex:Z.extractedTraits.eyeColorHex||((Q=w.physical)==null?void 0:Q.eyeColorHex),hairColor:Z.extractedTraits.hairColor||((te=w.physical)==null?void 0:te.hairColor),hairColorHex:Z.extractedTraits.hairColorHex||((le=w.physical)==null?void 0:le.hairColorHex),hairLength:Z.extractedTraits.hairLength||((Ce=w.physical)==null?void 0:Ce.hairLength),hairStyle:Z.extractedTraits.hairStyle||((qe=w.physical)==null?void 0:qe.hairStyle),facialHair:Z.extractedTraits.facialHair||((Je=w.physical)==null?void 0:Je.facialHair),skinTone:Z.extractedTraits.skinTone||((se=w.physical)==null?void 0:se.skinTone),skinToneHex:Z.extractedTraits.skinToneHex||((Le=w.physical)==null?void 0:Le.skinToneHex),face:Z.extractedTraits.face||((ae=w.physical)==null?void 0:ae.face),other:Z.extractedTraits.other||((V=w.physical)==null?void 0:V.other),detailedHairAnalysis:Z.extractedTraits.detailedHairAnalysis||((G=w.physical)==null?void 0:G.detailedHairAnalysis)}:w.physical,Re=Z.extractedClothing?{...w.clothing,structured:{upperBody:Z.extractedClothing.upperBody||void 0,lowerBody:Z.extractedClothing.lowerBody||void 0,shoes:Z.extractedClothing.shoes||void 0,fullBody:Z.extractedClothing.fullBody||void 0}}:w.clothing;ue(Y=>Y.map(Te=>Te.id===n?{...Te,avatars:_,physical:ce,clothing:Re}:Te)),Pe(Y=>Y&&Y.id===n?{...Y,avatars:_,physical:ce,clothing:Re}:Y),x.success(`âœ… Avatar generated for ${w.name} (id: ${n})`)}else x.error(`âŒ Failed to generate avatar: ${Z.error}`),D(`Failed to generate avatar: ${Z.error||"Unknown error"}`),ue(_=>_.map(ce=>ce.id===n?{...ce,avatars:{status:"failed"}}:ce)),Pe(_=>_&&_.id===n?{..._,avatars:{status:"failed"}}:_)}catch(Z){x.error("âŒ Avatar generation failed:",Z),D(`Avatar generation failed: ${Z instanceof Error?Z.message:"Unknown error"}`),ue(_=>_.map(ce=>ce.id===n?{...ce,avatars:{status:"failed"}}:ce)),Pe(_=>_&&_.id===n?{..._,avatars:{status:"failed"}}:_)}finally{gt(null)}},Xa=async()=>{var n;if(w){K(!0);try{const b=$r.current,m=ws.current;if(!b){x.warn("No current character to save");return}const $=b.id&&m.find(L=>L.id===b.id),f=$?m.map(L=>L.id===b.id?b:L):[...m,b];x.info("Saving characters with relationships:",f.length);const N=!$&&!!((n=b.photos)!=null&&n.original);await ze.saveCharacterData({characters:f,relationships:ht,relationshipTexts:It,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:N}),Dr.current=!1,x.success("Character data saved successfully"),ue(f),Qa(f);const P=f.find(L=>L.id===w.id);P&&ze.needsAvatars(P)&&Ir!==P.id&&(x.info(`ðŸŽ¨ Starting background avatar generation for ${P.name}...`),ze.generateAndSaveAvatarForCharacter(P,void 0,{avatarModel:tt.avatarModel||void 0}).then(L=>{L.success&&L.character?(ue(k=>k.map(re=>re.id===P.id?{...re,avatars:L.character.avatars,physical:L.character.physical,clothing:L.character.clothing}:re)),x.success(`âœ… Avatars and traits saved for ${P.name}`)):L.skipped||(x.warn(`Avatar generation failed for ${P.name}: ${L.error}`),ue(k=>k.map(re=>re.id===P.id?{...re,avatars:{status:"failed"}}:re)))}).catch(L=>{x.error(`âŒ Background avatar generation error for ${P.name}:`,L),ue(k=>k.map(re=>re.id===P.id?{...re,avatars:{status:"failed"}}:re))})),Pe(null),at(!0)}catch(b){x.error("Failed to save character:",b),D(s==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de l'enregistrement du personnage. Veuillez rÃ©essayer.":"Failed to save character. Please try again.")}finally{K(!1)}}},Ni=async n=>{Pe({...n}),et("traits"),at(!1);const b=await ze.loadFullCharacter(n.id);b&&(Pe(m=>m&&m.id===n.id?{...m,...b}:m),ue(m=>m.map($=>$.id===n.id?{...$,...b}:$)))},wi=async n=>{try{const b=await ze.deleteCharacter(n);b.success?(ue(m=>m.filter($=>$.id!==n)),Gr(m=>{const $={...m};return Object.keys($).forEach(f=>{(f.includes(`${n}-`)||f.includes(`-${n}`))&&delete $[f]}),$}),$s(m=>{const $={...m};return Object.keys($).forEach(f=>{(f.includes(`${n}-`)||f.includes(`-${n}`))&&delete $[f]}),$}),Lt(m=>m.filter($=>$!==n)),os.current=!0,x.success(`Character ${n} deleted`)):(x.error("Failed to delete character:",b.error),D(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character"))}catch(b){x.error("Failed to delete character:",b),D(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character")}},Si=(n,b,m)=>{const f=Eo(m,s),N=`${n}-${b}`,P=`${b}-${n}`;x.debug("Updating relationship:",N,"=",m,", inverse:",P,"=",f),Dr.current=!0,Gr(L=>({...L,[N]:m,[P]:f}))},Ci=(n,b)=>{Dr.current=!0;const[m,$]=n.split("-").map(Number),f=`${$}-${m}`;$s(N=>({...N,[n]:b,[f]:b}))},ki=(n,b)=>{Dr.current=!0,na(m=>[...m,{forward:n,inverse:b}])},Ai=(n,b)=>{b==="out"?(Hr(m=>m.includes(n)?m:[...m,n]),Lt(m=>m.filter($=>$!==n))):b==="in"?(Hr(m=>m.filter($=>$!==n)),Lt(m=>m.filter($=>$!==n))):b==="main"&&(Hr(m=>m.filter($=>$!==n)),Lt(m=>m.includes(n)?m:[...m,n])),os.current=!0,ue(m=>m.map($=>$.id===n?{...$,storyRole:b}:$))},Pi=async()=>{const[n,b,m]=await Promise.all([new Promise(f=>{ue(N=>(f(N),N))}),new Promise(f=>{Lt(N=>(f(N),N))}),new Promise(f=>{Hr(N=>(f(N),N))})]);if(n.length===0)return;if(!os.current){x.debug("Roles not modified, skipping save");return}const $={};for(const f of n)b.includes(f.id)?$[f.id]="main":m.includes(f.id)?$[f.id]="out":$[f.id]="in";try{await ze.saveCharacterRoles($),os.current=!1}catch(f){x.error("Failed to save character roles:",f)}},qs=l.useRef(null),Nr=async n=>{n>=0&&n<=7&&(C===1&&w&&n!==1&&await Xa(),C===1&&n!==1&&(qs.current=(async()=>{await Ii(),await Pi()})(),qs.current.catch(b=>x.error("Background save failed:",b))),n===1&&C!==1&&Pe(null),H(n),window.scrollTo(0,0))},$i=n=>n===1?!0:n===2||n===3?be.length>0:n===4?be.length>0&&Ae!=="":n===5?be.length>0&&Ae!==""&&jt!=="":n===6?vr!=="":!1,Qr=()=>C===1?be.length>0&&Mt.length>0:C===2?!0:C===3?!(!Ae||Ae==="adventure"&&!Ge||(Ae==="life-challenge"||Ae==="educational")&&!Oe||Ae==="historical"&&!Oe||Ae==="custom"&&!(Ue!=null&&Ue.trim())):C===4?jt!=="":C===5?be.filter(b=>!xt.includes(b.id)).length>0&&Mt.length>0&&fr.trim().length>0:!1,Ii=async()=>{const n=await new Promise(b=>{ue(m=>(b(m),m))});if(n.length!==0){if(!Dr.current){x.debug("Relationships not modified, skipping save");return}try{x.debug("Auto-saving character data with latest state..."),await ze.saveCharacterData({characters:n,relationships:ht,relationshipTexts:It,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]}),Dr.current=!1,x.debug("Character data auto-saved")}catch(b){x.error("Failed to auto-save character data:",b)}}},Ti=async()=>{if(C<5&&Qr()){if(C===1&&be.length===1){Ct(!0);return}await Nr(C+1)}},Nn=async()=>{C>0&&await Nr(C-1)},Di=(n,b)=>{Gt(n),Rs(b??null)},wn=async()=>{Yt.current&&Yt.current.abort(),Zt(!0),Wr(!0),wt(!0),Vt([]),qr(null),Rr(""),Rs(null);const n=be.filter(b=>!xt.includes(b.id));ma({storyType:$t,storyCategory:Ae||"",storyTopic:Oe||"",storyTheme:Ge||"",characters:n.map(b=>({id:b.id,name:b.name})),language:Tt,languageLevel:Nt,pages:pt,userLocation:Xt||void 0,season:er||void 0}),Yt.current=Fe.generateStoryIdeasStream({storyType:$t,storyTypeName:Us(),storyCategory:Ae||void 0,storyTopic:Oe||void 0,storyTheme:Ge||void 0,customThemeText:Ge==="custom"?Ue:void 0,language:Tt,languageLevel:Nt,pages:pt,characters:n.map(b=>({name:b.name,age:b.age,gender:b.gender,traits:b.traits,isMain:Mt.includes(b.id)})),relationships:Object.entries(ht).map(([b,m])=>{const[$,f]=b.split("-").map(Number),N=n.find(L=>L.id===$),P=n.find(L=>L.id===f);return{character1:(N==null?void 0:N.name)||"",character2:(P==null?void 0:P.name)||"",relationship:m}}).filter(b=>b.character1&&b.character2),ideaModel:(p==null?void 0:p.role)==="admin"||y?tt.ideaModel:void 0,userLocation:Xt||void 0,season:er},{onStatus:(b,m,$)=>{m&&$&&qr({prompt:m,model:$})},onStory1:b=>{Vt(m=>{const $=[...m];return $[0]=b,$}),la(100),Wr(!1)},onStory2:b=>{Vt(m=>{const $=[...m];return $[1]=b,$}),Ds(100),wt(!1)},onError:b=>{x.error("Failed to generate story ideas:",b),D(s==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":s==="fr"?"Erreur lors de la gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Failed to generate ideas. Please try again."),Zt(!1),Wr(!1),wt(!1)},onDone:b=>{Zt(!1),Wr(!1),wt(!1),b&&Rr(b),Yt.current=null,x.info("[IDEAS] onDone complete")}})},Us=()=>{const n=ln.find(b=>b.id===$t);return n?n.name[s]:$t},Zr=async n=>{var m,$,f,N,P,L,k,re,Q,te,le,Ce,qe,Je,se,Le;if(console.log("[generateStory] Called with overrides:",n),console.log("[generateStory] user:",p==null?void 0:p.email,"emailVerified:",p==null?void 0:p.emailVerified,"isImpersonating:",y),qs.current&&(await qs.current,qs.current=null),!(n!=null&&n.skipEmailCheck)&&!y&&p&&p.emailVerified!==!0){await T();const ae=localStorage.getItem("currentUser");let V=p.emailVerified;if(ae)try{V=JSON.parse(ae).emailVerified}catch{}if(V===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",$t),localStorage.setItem("pending_art_style",jt),tr(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),u(!0),Be(!1),H(6),Wa({storyCategory:Ae||void 0,storyTopic:Oe||void 0,storyTheme:Ge||void 0,storyTypeName:Us(),storyDetails:fr||void 0,artStyle:jt||void 0,language:Tt||void 0,languageLevel:Nt||void 0,pages:pt||void 0,dedication:pr||void 0,characters:be.filter(ae=>!xt.includes(ae.id)).map(ae=>({id:ae.id,name:ae.name})),mainCharacters:Mt,relationships:ht,relationshipTexts:It,season:er||void 0,userLocation:Xt||void 0}),Fr(""),Wt(""),Rt([]),qt([]),ka(null),Aa({}),sr({frontCover:null,initialPage:null,backCover:null});const b=be.filter(ae=>!xt.includes(ae.id)).filter(ae=>!ae.avatars||ae.avatars.stale||ae.avatars.status!=="complete");if(b.length>0){console.log("[generateStory] Characters needing avatar regeneration:",b.map(ae=>ae.name)),rr({current:1,total:100,message:s==="de"?`Aktualisiere Avatare fÃ¼r ${b.length} Charakter(e)...`:s==="fr"?`Mise Ã  jour des avatars pour ${b.length} personnage(s)...`:`Updating avatars for ${b.length} character(s)...`});for(let ae=0;ae<b.length;ae++){const V=b[ae];try{console.log(`[generateStory] Regenerating avatars for ${V.name} (${ae+1}/${b.length})`),rr({current:2,total:100,message:s==="de"?`Generiere Avatare fÃ¼r ${V.name}...`:s==="fr"?`GÃ©nÃ©ration des avatars pour ${V.name}...`:`Generating avatars for ${V.name}...`});const G=await ze.generateClothingAvatarsWithTraits(V);if(G.success&&G.avatars){const Z={...G.avatars,stale:!1,generatedAt:new Date().toISOString()},_=V.physicalTraitsSource||{},ce=G.extractedTraits?{...V.physical,height:(m=V.physical)==null?void 0:m.height,build:_.build==="user"?($=V.physical)==null?void 0:$.build:G.extractedTraits.build,eyeColor:_.eyeColor==="user"?(f=V.physical)==null?void 0:f.eyeColor:G.extractedTraits.eyeColor,eyeColorHex:_.eyeColor==="user"?(N=V.physical)==null?void 0:N.eyeColorHex:G.extractedTraits.eyeColorHex,hairColor:_.hairColor==="user"?(P=V.physical)==null?void 0:P.hairColor:G.extractedTraits.hairColor,hairColorHex:_.hairColor==="user"?(L=V.physical)==null?void 0:L.hairColorHex:G.extractedTraits.hairColorHex,hairLength:_.hairLength==="user"?(k=V.physical)==null?void 0:k.hairLength:G.extractedTraits.hairLength,hairStyle:_.hairStyle==="user"?(re=V.physical)==null?void 0:re.hairStyle:G.extractedTraits.hairStyle,facialHair:_.facialHair==="user"?(Q=V.physical)==null?void 0:Q.facialHair:G.extractedTraits.facialHair,skinTone:_.skinTone==="user"?(te=V.physical)==null?void 0:te.skinTone:G.extractedTraits.skinTone,skinToneHex:_.skinTone==="user"?(le=V.physical)==null?void 0:le.skinToneHex:G.extractedTraits.skinToneHex,face:_.face==="user"?(Ce=V.physical)==null?void 0:Ce.face:G.extractedTraits.face,other:_.other==="user"?(qe=V.physical)==null?void 0:qe.other:G.extractedTraits.other,detailedHairAnalysis:G.extractedTraits.detailedHairAnalysis||((Je=V.physical)==null?void 0:Je.detailedHairAnalysis),apparentAge:_.apparentAge==="user"?(se=V.physical)==null?void 0:se.apparentAge:G.extractedTraits.apparentAge||((Le=V.physical)==null?void 0:Le.apparentAge)}:V.physical,Re=G.extractedTraits?{..._,build:_.build==="user"?"user":G.extractedTraits.build?"extracted":void 0,eyeColor:_.eyeColor==="user"?"user":G.extractedTraits.eyeColor?"extracted":void 0,hairColor:_.hairColor==="user"?"user":G.extractedTraits.hairColor?"extracted":void 0,hairLength:_.hairLength==="user"?"user":G.extractedTraits.hairLength?"extracted":void 0,hairStyle:_.hairStyle==="user"?"user":G.extractedTraits.hairStyle?"extracted":void 0,face:_.face==="user"?"user":G.extractedTraits.face?"extracted":void 0,facialHair:_.facialHair==="user"?"user":G.extractedTraits.facialHair?"extracted":void 0,other:_.other==="user"?"user":G.extractedTraits.other?"extracted":void 0,skinTone:_.skinTone==="user"?"user":G.extractedTraits.skinTone?"extracted":void 0,apparentAge:_.apparentAge==="user"?"user":G.extractedTraits.apparentAge?"extracted":void 0}:V.physicalTraitsSource,Y=G.extractedClothing?{...V.clothing,structured:{upperBody:G.extractedClothing.upperBody||void 0,lowerBody:G.extractedClothing.lowerBody||void 0,shoes:G.extractedClothing.shoes||void 0,fullBody:G.extractedClothing.fullBody||void 0}}:V.clothing;ue(Te=>Te.map(fe=>fe.id===V.id?{...fe,avatars:Z,physical:ce,physicalTraitsSource:Re,clothing:Y}:fe)),Pe(Te=>Te&&Te.id===V.id?{...Te,avatars:Z,physical:ce,physicalTraitsSource:Re,clothing:Y}:Te),ue(Te=>{const fe=Te.map(He=>He.id===V.id?{...He,avatars:Z,physical:ce,physicalTraitsSource:Re,clothing:Y}:He);return ze.saveCharacterData({characters:fe,relationships:ht,relationshipTexts:It,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(He=>console.error("Failed to save avatar update:",He)),fe}),console.log(`[generateStory] âœ… Avatars regenerated for ${V.name}`)}else console.warn(`[generateStory] âš ï¸ Failed to regenerate avatars for ${V.name}: ${G.error}`)}catch(G){console.error(`[generateStory] âŒ Error regenerating avatars for ${V.name}:`,G)}}}rr({current:5,total:100,message:s==="de"?"Starte Generierung...":s==="fr"?"DÃ©marrage de la gÃ©nÃ©ration...":"Starting generation..."});try{const ae=be.filter(Y=>!xt.includes(Y.id)),{jobId:V,creditsRemaining:G}=await Fe.createStoryJob({storyType:$t,storyTypeName:Us(),storyCategory:Ae||void 0,storyTopic:Oe||void 0,storyTheme:Ge||void 0,customThemeText:Ge==="custom"?Ue:void 0,artStyle:jt,language:Tt,languageLevel:Nt,pages:pt,dedication:pr,storyDetails:fr,characters:ae,mainCharacters:Mt,relationships:ht,relationshipTexts:It,skipImages:(n==null?void 0:n.skipImages)??he,imageGenMode:ye,generationMode:xe!=="auto"?xe:void 0,skipOutline:_e,skipText:U,skipSceneDescriptions:Qe,skipCovers:Ie,enableAutoRepair:Xe,useGridRepair:bt,forceRepairThreshold:es,enableFinalChecks:Zs,checkOnlyMode:we,enableSceneValidation:yt,separatedEvaluation:Jt,incrementalConsistency:Cr?{enabled:!0,dryRun:Xs,lookbackCount:ke}:void 0,modelOverrides:(p==null?void 0:p.role)==="admin"||y?{outlineModel:tt.outlineModel,textModel:tt.textModel,sceneDescriptionModel:tt.sceneDescriptionModel,imageModel:tt.imageModel,coverImageModel:tt.coverImageModel,qualityModel:tt.qualityModel}:void 0,userLocation:Xt||void 0,season:er||void 0,ideaGeneration:Es&&Ht&&St.length>0?{input:Es,output:St,rawResponse:Ur,prompt:Ht.prompt,model:Ht.model,selectedIndex:ca}:void 0});Ca(V),x.info("Story job created:",V),X(V,Us()||"New Story"),G!=null&&A(G);let Z=!1,_=0,ce=Date.now();const Re=180*1e3;for(yr(!1);!Z;){await new Promise(Te=>setTimeout(Te,2e3));const Y=await Fe.getJobStatus(V);if(Y.progress&&(Y.progress.current!==_?(x.debug(`Progress: ${Y.progress.current}% - ${Y.progress.message||""}`),_=Y.progress.current,ce=Date.now(),yr(!1)):Date.now()-ce>=Re&&yr(!0),rr(Te=>Y.progress.current>=Te.current?Y.progress:Y.progress.message?{...Te,message:Y.progress.message}:Te)),Y.partialCovers){let Te=!1;sr(fe=>{var nt,dt,Ta;const He={...fe};if((nt=Y.partialCovers)!=null&&nt.frontCover&&!fe.frontCover){He.frontCover=Y.partialCovers.frontCover,x.debug("Front cover received during streaming");const Ut=Y.partialCovers.frontCover;typeof Ut=="object"&&(Ut!=null&&Ut.storyTitle)&&(Wt(Ut.storyTitle),x.debug(`Story title from front cover: ${Ut.storyTitle}`)),Te=!0}return(dt=Y.partialCovers)!=null&&dt.initialPage&&!fe.initialPage&&(He.initialPage=Y.partialCovers.initialPage,x.debug("Initial page cover received during streaming")),(Ta=Y.partialCovers)!=null&&Ta.backCover&&!fe.backCover&&(He.backCover=Y.partialCovers.backCover,x.debug("Back cover received during streaming")),He}),Te&&(x.debug("Transitioning to StoryDisplay - front cover ready"),H(6))}if(Y.storyText&&!At&&(ka(Y.storyText),Wt(Y.storyText.title),x.debug(`Story text received: ${Y.storyText.totalPages} pages ready for display`)),Y.partialPages&&Y.partialPages.length>0&&Aa(Te=>{var nt;const fe={...Te};let He=0;return(nt=Y.partialPages)==null||nt.forEach(dt=>{dt.imageData&&!Te[dt.pageNumber]&&(fe[dt.pageNumber]=dt.imageData,He++)}),He>0&&x.debug(`${He} new page images received (total: ${Object.keys(fe).length})`),fe}),console.log("[StoryWizard] Job status check:",{status:Y.status,hasResult:!!Y.result,resultKeys:Y.result?Object.keys(Y.result):[],progress:Y.progress}),Y.status==="completed"&&Y.result)Ha(Y.result.storyId),Wt(Y.result.title),Bs(Y.result.outline),Ms(Y.result.outlinePrompt||""),Ls(Y.result.outlineModelId),Os(Y.result.outlineUsage),Gs(Y.result.storyTextPrompts||[]),ms(Y.result.styledAvatarGeneration||[]),us(Y.result.costumedAvatarGeneration||[]),gs(Y.result.generationLog||[]),rt(Y.result.finalChecksReport||null),Y.result.visualBible?jr({mainCharacters:Y.result.visualBible.mainCharacters||[],secondaryCharacters:Y.result.visualBible.secondaryCharacters||[],animals:Y.result.visualBible.animals||[],artifacts:Y.result.visualBible.artifacts||[],locations:Y.result.visualBible.locations||[],vehicles:Y.result.visualBible.vehicles||[],clothing:Y.result.visualBible.clothing||[],changeLog:Y.result.visualBible.changeLog||[]}):jr(null),Y.result.clothingRequirements?Jr(Y.result.clothingRequirements):Jr(null),Fr(Y.result.story),zs(Y.result.story),qt(Y.result.sceneDescriptions||[]),Rt(Y.result.sceneImages||[]),sr(Y.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),ka(null),Aa({}),Z=!0,Y.currentCredits!==null&&Y.currentCredits!==void 0&&A(Y.currentCredits),H(6),x.success("Story generation completed!"),Wa({storyCategory:Ae||void 0,storyTopic:Oe||void 0,storyTheme:Ge||void 0,storyTypeName:Us(),storyDetails:fr||void 0,artStyle:jt||void 0,language:Tt||void 0,languageLevel:Nt||void 0,pages:pt||void 0,dedication:pr||void 0,characters:be.map(Te=>({id:Te.id,name:Te.name})),mainCharacters:Mt,relationships:ht,relationshipTexts:It,season:er||void 0,userLocation:Xt||void 0}),qa.current=!0,j();else if(Y.status==="failed")throw new Error(Y.error||"Story generation failed")}rr({current:100,total:100,message:s==="de"?"Fertig!":s==="fr"?"TerminÃ©!":"Complete!"})}catch(ae){x.error("Generation failed:",ae);const V=ae instanceof Error?ae.message:String(ae);if(V.includes("already in progress")){const G=V.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),Z=G?G[1]:null,_=s==="de"?"Eine Geschichte wird bereits erstellt. MÃ¶chtest du diese abbrechen und eine neue starten?":s==="fr"?"Une histoire est dÃ©jÃ  en cours de crÃ©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(Z&&window.confirm(_))try{await Fe.cancelJob(Z),x.info("Cancelled existing job:",Z),await Zr(n);return}catch(ce){x.error("Failed to cancel existing job:",ce),D(s==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es spÃ¤ter erneut.":s==="fr"?"Ã‰chec de l'annulation. Veuillez rÃ©essayer plus tard.":"Failed to cancel. Please try again later.")}u(!1);return}else D(s==="de"?`Generierung fehlgeschlagen: ${V}`:s==="fr"?`Ã‰chec de la gÃ©nÃ©ration: ${V}`:`Generation failed: ${V}`)}finally{yr(!1),j(),setTimeout(()=>u(!1),500)}};l.useEffect(()=>{if(Ia.current&&R&&be.length>0&&C===5&&!t){Ia.current=!1;const n=localStorage.getItem("verificationGenerationStarted");if(n){const m=parseInt(n,10),$=Date.now()-120*1e3;if(m>$){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await T(),setTimeout(()=>{Zr({skipEmailCheck:!0})},500)})()}},[R,be,C,t,T]);const Ri=()=>{switch(C){case 1:return e.jsx(Ho,{characters:be,currentCharacter:w,characterStep:ra,showCharacterCreated:ta,isLoading:O,isAnalyzingPhoto:sa,isGeneratingAvatar:Ir===(w==null?void 0:w.id),isRegeneratingAvatars:Ss,isRegeneratingAvatarsWithTraits:ss,developerMode:ee,isImpersonating:y,changedTraits:as,photoAnalysisDebug:Ga,mainCharacters:Mt,excludedCharacters:xt,onCharacterRoleChange:Ai,onCharacterChange:Pe,onCharacterStepChange:et,onContinueToAvatar:()=>et("avatar"),onPhotoSelect:xi,onSaveAndGenerateAvatar:ji,onSaveCharacter:Xa,onEditCharacter:Ni,onDeleteCharacter:wi,onStartNewCharacter:Ya,onRegenerateAvatars:bi,onRegenerateAvatarsWithTraits:yi,onSaveAndRegenerateWithTraits:vi,onSaveAndTryNewPhoto:async()=>{var m;if(x.info(`ðŸ“¸ onSaveAndTryNewPhoto called, currentCharacter: ${w==null?void 0:w.name}`),!w){x.warn("ðŸ“¸ No currentCharacter, returning early");return}K(!0);try{const $=w.id&&be.find(P=>P.id===w.id),f=$?be.map(P=>P.id===w.id?w:P):[...be,w],N=!$&&!!((m=w.photos)!=null&&m.original);await ze.saveCharacterData({characters:f,relationships:ht,relationshipTexts:It,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:N}),ue(f),Qa(f),x.info(`ðŸ“¸ Setting characterStep to 'photo', currentCharacter still: ${w==null?void 0:w.name}`),et("photo")}catch($){x.error("ðŸ“¸ Error saving character:",$)}finally{K(!1),x.info("ðŸ“¸ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:ht,relationshipTexts:It,onRelationshipChange:Si,onRelationshipTextChange:Ci,customRelationships:Tr,onAddCustomRelationship:ki});case 2:return e.jsx(Vo,{languageLevel:Nt,onLanguageLevelChange:Ot,pages:pt,onPagesChange:ls,storyLanguage:Tt,onStoryLanguageChange:oa,developerMode:ee,userLocation:Xt,onLocationChange:Fs,season:er,onSeasonChange:ua,userCredits:y?-1:(p==null?void 0:p.credits)??0});case 3:return e.jsx(Wo,{storyCategory:Ae,storyTopic:Oe,storyTheme:Ge,customThemeText:Ue,onCategoryChange:li,onTopicChange:ci,onThemeChange:di,onCustomThemeTextChange:cr,onLegacyStoryTypeChange:Qt});case 4:return e.jsx(qo,{artStyle:jt,onArtStyleChange:mi});case 5:return e.jsx(Uo,{characters:be,mainCharacters:Mt,excludedCharacters:xt,storyCategory:Ae,storyTopic:Oe,storyTheme:Ge,customThemeText:Ue,onCustomThemeTextChange:cr,artStyle:jt,storyLanguage:Tt,languageLevel:Nt,pages:pt,userLocation:Xt,season:er,storyDetails:fr,onStoryDetailsChange:Gt,dedication:pr,onDedicationChange:Vr,onGenerateIdeas:wn,isGeneratingIdeas:Dt,isGeneratingIdea1:Ts,isGeneratingIdea2:_t,ideaProgress1:ds,ideaProgress2:da,ideaPrompt:Ht,ideaFullResponse:Ur,generatedIdeas:St,onSelectIdea:Di,onUseDirectly:()=>Zr(),onEditStep:Nr,developerMode:ee,imageGenMode:ye,onImageGenModeChange:B,generationMode:xe,onGenerationModeChange:De});case 6:const n=_s.frontCover||_s.initialPage||Object.keys(Ua).length>0||hs.some(m=>m.imageData);if(vr&&n||At&&n||t&&n){const m=vr?hs:Object.entries(Ua).map(([f,N])=>{var P;return{pageNumber:parseInt(f),imageData:N,description:((P=At==null?void 0:At.sceneDescriptions.find(L=>L.pageNumber===parseInt(f)))==null?void 0:P.description)||""}}),$=vr||Object.entries((At==null?void 0:At.pageTexts)||{}).sort(([f],[N])=>parseInt(f)-parseInt(N)).map(([f,N])=>`--- Page ${f} ---
${N}`).join(`

`);return e.jsxs(e.Fragment,{children:[kt&&kt.total>0&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${kt.loaded/kt.total*100}%`}})}),e.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:s==="de"?`Bilder: ${kt.loaded}/${kt.total}`:s==="fr"?`Images: ${kt.loaded}/${kt.total}`:`Images: ${kt.loaded}/${kt.total}`})]}),e.jsx(So,{title:cs,dedication:pr||void 0,story:$,originalStory:ha,outline:xa,outlinePrompt:pa,outlineModelId:fa,outlineUsage:ba,storyTextPrompts:ya,visualBible:va||void 0,sceneImages:m,sceneDescriptions:(At==null?void 0:At.sceneDescriptions)||Ke,characters:mr||be.filter(f=>!xt.includes(f.id)),progressiveMode:t,progressiveData:At||void 0,completedPageImages:Ua,coverImages:_s,regeneratingCovers:c,languageLevel:Nt,storyLanguage:Tt,isGenerating:t,developerMode:ee,styledAvatarGeneration:Na,costumedAvatarGeneration:wa,generationLog:Sa,finalChecksReport:me,clothingRequirements:ja||void 0,storyId:je,onVisualBibleChange:je?async f=>{try{x.info("Updating Visual Bible for story:",je),await Fe.updateVisualBible(je,f),jr(f),x.success("Visual Bible updated successfully")}catch(N){x.error("Failed to update Visual Bible:",N),D(s==="de"?"Visual Bible konnte nicht aktualisiert werden":s==="fr"?"Ã‰chec de la mise Ã  jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:je?async(f,N,P)=>{var L;try{x.info("Regenerating image for page:",f,N?"(scene edited)":"",P?`(${P.length} characters)`:"");const k=await Fe.regenerateImage(je,f,N,P);if(x.info("Regenerate result:",{hasImageData:!!(k!=null&&k.imageData),length:(L=k==null?void 0:k.imageData)==null?void 0:L.length,versionCount:k==null?void 0:k.versionCount,creditsRemaining:k==null?void 0:k.creditsRemaining}),!(k!=null&&k.imageData))throw x.error("No imageData in response!",k),new Error("No image data returned from server");Rt(re=>re.map(Q=>Q.pageNumber===f?{...Q,imageData:k.imageData,description:k.newDescription||Q.description,prompt:k.newPrompt,qualityScore:k.qualityScore,qualityReasoning:k.qualityReasoning,totalAttempts:k.totalAttempts,retryHistory:k.retryHistory,wasRegenerated:!0,originalImage:k.originalImage,originalScore:k.originalScore,originalReasoning:k.originalReasoning,imageVersions:k.imageVersions,referencePhotos:k.referencePhotos||Q.referencePhotos,landmarkPhotos:k.landmarkPhotos||Q.landmarkPhotos,visualBibleGrid:k.visualBibleGrid||Q.visualBibleGrid}:Q)),k.creditsRemaining!==void 0&&A&&A(k.creditsRemaining),x.info("Image regenerated successfully, updated state")}catch(k){x.error("Image regeneration failed:",k);const re=k instanceof Error?k.message:String(k);D(s==="de"?`Bildgenerierung fehlgeschlagen: ${re}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${re}`:`Image regeneration failed: ${re}`)}}:void 0,onDownloadTxt:()=>{const f=new Blob([vr],{type:"text/plain"}),N=URL.createObjectURL(f),P=document.createElement("a");P.href=N,P.download=`${cs}.txt`,P.click(),URL.revokeObjectURL(N)},onDownloadPdf:je?async f=>{try{const N=await Fe.generatePdf(je,f),P=URL.createObjectURL(N),L=document.createElement("a");L.href=P,L.download=`${cs}.pdf`,L.click(),URL.revokeObjectURL(P)}catch(N){x.error("PDF download failed:",N),D(s==="de"?"PDF-Download fehlgeschlagen":s==="fr"?"Ã‰chec du tÃ©lÃ©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:je?()=>{try{const f=sessionStorage.getItem("mystories_selected"),N=f?JSON.parse(f):[];N.includes(je)||(N.push(je),sessionStorage.setItem("mystories_selected",JSON.stringify(N))),x.info("Added story to book selection:",je),I(s==="de"?"Geschichte zum Buch hinzugefÃ¼gt. Du kannst weitere hinzufÃ¼gen oder das Buch bestellen.":s==="fr"?"Histoire ajoutÃ©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",s==="de"?"Zum Buch hinzugefÃ¼gt":s==="fr"?"AjoutÃ© au livre":"Added to Book"),r("/stories")}catch(f){x.error("Failed to add story to selection:",f)}}:void 0,onPrintBook:je?async()=>{let f=await no.getShippingAddress();if(!f){const L=prompt(s==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":s==="fr"?"Aucune adresse enregistrÃ©e. Veuillez entrer (Format: PrÃ©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!L)return;const k=L.split(",").map(re=>re.trim());if(k.length<7){D(s==="de"?"UngÃ¼ltiges Adressformat":s==="fr"?"Format d'adresse invalide":"Invalid address format");return}f={firstName:k[0],lastName:k[1],addressLine1:k[2],postCode:k[3],city:k[4],country:k[5],email:k[6]}}const N=`${f.firstName} ${f.lastName}
${f.addressLine1}
${f.postCode} ${f.city}
${f.country}`,P=s==="de"?`Druckauftrag an folgende Adresse senden?

${N}`:s==="fr"?`Envoyer la commande Ã  cette adresse?

${N}`:`Send print order to this address?

${N}`;if(confirm(P))try{x.info("Creating print order for story:",je);const L=await Fe.createPrintOrder(je,{firstName:f.firstName,lastName:f.lastName,addressLine1:f.addressLine1,city:f.city,postCode:f.postCode,country:f.country,email:f.email||""}),k=s==="de"?`âœ… Druckauftrag erfolgreich erstellt!

Order ID: ${L.orderId}
${L.isDraft?"(Entwurf - muss in Gelato bestÃ¤tigt werden)":""}

MÃ¶chten Sie das Gelato Dashboard Ã¶ffnen, um den Auftrag zu verfolgen?`:s==="fr"?`âœ… Commande d'impression crÃ©Ã©e avec succÃ¨s!

ID de commande: ${L.orderId}
${L.isDraft?"(Brouillon - doit Ãªtre confirmÃ© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`âœ… Print order created successfully!

Order ID: ${L.orderId}
${L.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;L.dashboardUrl&&confirm(k)?window.open(L.dashboardUrl,"_blank"):L.dashboardUrl||I(s==="de"?`Druckauftrag erstellt! Order ID: ${L.orderId}`:s==="fr"?`Commande crÃ©Ã©e! ID: ${L.orderId}`:`Print order created! Order ID: ${L.orderId}`)}catch(L){x.error("Print order failed:",L);const k=L instanceof Error?L.message:String(L);D(s==="de"?`Druckauftrag fehlgeschlagen: ${k}`:s==="fr"?`Ã‰chec de la commande d'impression: ${k}`:`Print order failed: ${k}`)}}:void 0,onCreateAnother:()=>{x.info("Creating new story - resetting settings"),Ha(null),Ca(null),ut(null);const f=new URLSearchParams(i);f.delete("storyId"),o(f,{replace:!0}),Fr(""),Wt(""),qt([]),Rt([]),sr({frontCover:null,initialPage:null,backCover:null}),gn(!1),hn(void 0),xn(void 0),pn(void 0),Qt(""),Ar(""),rs(""),Pr(""),mt("watercolor"),Ot("standard"),ls(30),Vr(""),Gt(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),Pe(null),et("photo"),H(1)},onRegenerateCover:je?async(f,N,P,L,k)=>{const re=f==="front"?"frontCover":f==="back"?"backCover":"initialPage";try{x.info("Regenerating cover:",f,N?`with scene: "${N.substring(0,50)}..."`:"",P?`with ${P.length} characters`:""),S(te=>new Set(te).add(re));const Q=await Fe.regenerateCover(je,f,N,P,L,k);sr(te=>te&&{...te,[f==="front"?"frontCover":f==="back"?"backCover":"initialPage"]:{imageData:Q.imageData,description:Q.description,prompt:Q.prompt,qualityScore:Q.qualityScore,qualityReasoning:Q.qualityReasoning,totalAttempts:Q.totalAttempts,retryHistory:Q.retryHistory,referencePhotos:Q.referencePhotos,wasRegenerated:Q.wasRegenerated,regenerationCount:Q.regenerationCount,previousImage:Q.previousImage,previousScore:Q.previousScore,originalImage:Q.originalImage,originalScore:Q.originalScore,modelId:Q.modelId}}),Q.creditsRemaining!==void 0&&A&&A(Q.creditsRemaining),x.info("Cover regenerated successfully")}catch(Q){x.error("Cover regeneration failed:",Q);const te=Q instanceof Error?Q.message:String(Q);D(s==="de"?`Cover-Generierung fehlgeschlagen: ${te}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${te}`:`Cover regeneration failed: ${te}`)}finally{S(Q=>{const te=new Set(Q);return te.delete(re),te})}}:void 0,onEditImage:f=>{$a({type:"image",pageNumber:f}),Vs(""),Pa(!0)},onEditCover:f=>{$a({type:"cover",coverType:f}),Vs(""),Pa(!0)},onRepairImage:je&&((p==null?void 0:p.role)==="admin"||y)?async f=>{var N,P,L;try{x.info("Starting auto-repair for page:",f);const k=hs.find(te=>te.pageNumber===f);let re=k==null?void 0:k.fixTargets;if(!re||re.length===0){const te=(P=(N=k==null?void 0:k.retryHistory)==null?void 0:N.filter(le=>le.type==="auto_repair"))==null?void 0:P.slice(-1)[0];(L=te==null?void 0:te.preRepairEval)!=null&&L.fixTargets&&te.preRepairEval.fixTargets.length>0&&(re=te.preRepairEval.fixTargets,x.info(`Using ${re.length} fix targets from retryHistory.preRepairEval`))}re&&re.length>0?x.info(`Using ${re.length} existing fix targets`):x.info("No stored fix targets found, will re-evaluate");const Q=await Fe.repairImage(je,f,re);Q.repaired?(Rt(te=>te.map(le=>le.pageNumber===f?{...le,imageData:Q.imageData,wasAutoRepaired:!0,repairHistory:Q.repairHistory,repairedAt:new Date().toISOString()}:le)),x.info("Auto-repair completed successfully:",{repaired:Q.repaired,repairs:Q.repairHistory.length})):Q.noErrorsFound&&x.info("No physics errors detected in the image")}catch(k){throw x.error("Auto-repair failed:",k),k}}:void 0,onIteratePage:je&&((p==null?void 0:p.role)==="admin"||y)?async f=>{var N;try{x.info("Starting iteration for page:",f,"imageModel:",tt.imageModel);const P=await Fe.iteratePage(je,f,tt.imageModel||void 0);P.success&&(Rt(L=>L.map(k=>{var re;if(k.pageNumber===f){const Q=k.imageVersions||[],te=(re=P.imageVersions)==null?void 0:re.map((le,Ce)=>{var qe;return{imageData:le.imageData||((qe=Q[Ce])==null?void 0:qe.imageData)||"",description:le.description,prompt:le.prompt,modelId:le.modelId,createdAt:le.createdAt||new Date().toISOString(),isActive:le.isActive??!1,type:le.type,qualityScore:le.qualityScore}});return{...k,imageData:P.imageData,description:P.sceneDescription,prompt:P.imagePrompt,qualityScore:P.qualityScore,qualityReasoning:P.qualityReasoning,wasIterated:!0,iteratedAt:new Date().toISOString(),iterationFeedback:P.composition,previewMismatches:P.previewMismatches,imageVersions:te||k.imageVersions}}return k})),qt(L=>L.map(k=>k.pageNumber===f?{...k,description:P.sceneDescription,iteratedAt:new Date().toISOString()}:k)),x.info("Iteration completed successfully:",{mismatches:((N=P.previewMismatches)==null?void 0:N.length)||0,score:P.qualityScore,message:P.message}))}catch(P){throw x.error("Iteration failed:",P),P}}:void 0,onRevertRepair:je&&((p==null?void 0:p.role)==="admin"||y)?async(f,N)=>{try{x.info("Reverting repair for page:",f),Rt(P=>P.map(L=>L.pageNumber===f?{...L,imageData:N,wasAutoRepaired:!1}:L)),await Fe.updateSceneImage(je,f,N),x.info("Repair reverted successfully")}catch(P){throw x.error("Failed to revert repair:",P),P}}:void 0,onSaveStoryText:je?async f=>{try{x.info("Saving story text for story:",je),await Fe.saveStoryText(je,f),Fr(f),x.info("Story text saved successfully")}catch(N){throw x.error("Failed to save story text:",N),N}}:void 0,onSaveTitleChange:je?async f=>{try{x.info("Saving title for story:",je,f),await Fe.saveStoryTitle(je,f),Wt(f),x.info("Title saved successfully")}catch(N){throw x.error("Failed to save title:",N),N}}:void 0,userCredits:y?-1:(p==null?void 0:p.credits)||0,imageRegenerationCost:5,isImpersonating:y,onSelectImageVersion:je?async(f,N)=>{try{x.info("Selecting image version:",{pageNumber:f,versionIndex:N});const P=await Fe.setActiveImage(je,f,N);Rt(L=>L.map(k=>{if(k.pageNumber===f&&k.imageVersions){const re=k.imageVersions[N];return{...k,imageData:(re==null?void 0:re.imageData)||k.imageData,imageVersions:k.imageVersions.map((Q,te)=>({...Q,isActive:te===N}))}}return k})),x.info("Image version selected:",P)}catch(P){throw x.error("Failed to select image version:",P),P}}:void 0,isPartial:ri,failureReason:si,generatedPages:ai,totalPages:ni,generationSettings:ii||void 0,onRefreshStory:je?async()=>{x.info("Refreshing story data:",je),ti(f=>f+1)}:void 0})]})}return i.get("storyId")?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(Ye,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):t?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:s==="de"?"Geschichte wird erstellt...":s==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:s==="de"?"Einen Moment Geduld bitte":s==="fr"?"Veuillez patienter":"Please wait a moment"})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(js,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:h.generateStory}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Bereit, deine Geschichte zu erstellen!":s==="fr"?"PrÃªt Ã  crÃ©er votre histoire!":"Ready to create your story!"}),e.jsxs(Ma,{onClick:()=>Zr(),size:"lg",icon:js,children:[h.generateStory," (",pt*10," Credits)"]})]});default:return null}};return R?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Oi,{currentStep:C,onStepClick:Nr,canAccessStep:$i,developerMode:ee,onDeveloperModeChange:ve,hideSteps:C===6&&!!je,onShowGenerationProgress:()=>{Be(!1),H(6)}}),e.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:e.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[O&&!t?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(Ye,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:E?s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story...":s==="de"?"Wird geladen...":s==="fr"?"Chargement...":"Loading..."}),E&&e.jsxs("div",{className:"w-64 mt-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:E.total?`${Math.min(100,E.loaded/E.total*100)}%`:"100%"}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[(E.loaded/(1024*1024)).toFixed(1)," MB",E.total&&e.jsxs("span",{children:[" (",Math.round(E.loaded/E.total*100),"%)"]})]})]})]}):e.jsxs(e.Fragment,{children:[C>=1&&C<=5&&!w&&e.jsx(mo,{step:C,text:(Un[s]||Un.en)[C]}),e.jsx(l.Suspense,{fallback:e.jsx(Cn,{}),children:Ri()})]}),C<6&&!w&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[C===1&&be.length>=2&&!ui()&&(()=>{const n=gi();if(!n)return null;const b=s==="de"?`${n.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:s==="fr"?`${n.name} a des relations non dÃ©finies ("ne connaÃ®t pas")`:`${n.name} has undefined relationships ("not known to")`;return e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"âš ï¸"}),e.jsx("p",{className:"text-amber-700 text-sm",children:b})]})})(),C!==5&&e.jsxs("div",{className:`flex ${C===1?"justify-end":"justify-between"}`,children:[C>1&&e.jsxs("button",{onClick:Nn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(Dn,{size:20})," ",h.back]}),e.jsxs("button",{onClick:Ti,disabled:!Qr(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${Qr()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[h.next," ",e.jsx(Ui,{size:20})]})]}),C===5&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:()=>Zr(),disabled:!Qr(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Qr()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(js,{size:20})," ",h.generateStory," (",pt*10," Credits)"]}),ee&&e.jsxs("button",{onClick:()=>Zr({skipImages:!0}),disabled:!Qr(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Qr()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(js,{size:20}),s==="de"?"Nur Text generieren (ohne Bilder)":s==="fr"?"GÃ©nÃ©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),ee&&e.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["ðŸ› ï¸ ",s==="de"?"Entwickler-Optionen - Schritte Ã¼berspringen":s==="fr"?"Options dÃ©veloppeur - Sauter des Ã©tapes":"Developer Options - Skip Steps"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_e,onChange:n=>Se(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Gliederung Ã¼berspringen":s==="fr"?"Sauter le plan":"Skip outline generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:U,onChange:n=>Ne(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Text Ã¼berspringen":s==="fr"?"Sauter le texte":"Skip text generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Qe,onChange:n=>pe(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenenbeschreibungen Ã¼berspringen":s==="fr"?"Sauter les descriptions de scÃ¨nes":"Skip scene descriptions"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:he,onChange:n=>q(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Bilder Ã¼berspringen":s==="fr"?"Sauter les images":"Skip image generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Ie,onChange:n=>We(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Cover Ã¼berspringen":s==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2",children:s==="de"?"Hinweis: Ãœbersprungene Schritte verwenden Platzhalter/leere Daten":s==="fr"?"Note: Les Ã©tapes sautÃ©es utiliseront des donnÃ©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["ðŸ”§ ",s==="de"?"Feature-Optionen":s==="fr"?"Options de fonctionnalitÃ©s":"Feature Options"]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Xe,onChange:n=>Pt(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Auto-Reparatur aktivieren":s==="fr"?"Activer la rÃ©paration auto":"Enable auto-repair"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":s==="fr"?"Essaie de corriger automatiquement les erreurs d'image dÃ©tectÃ©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),Xe&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:bt,onChange:n=>or(n.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Grid-Reparatur verwenden":s==="fr"?"Utiliser la rÃ©paration en grille":"Use grid repair"})]}),Xe&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":s==="fr"?"Extrait les rÃ©gions problÃ©matiques dans une grille, rÃ©pare avec Gemini, vÃ©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),Xe&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:s==="de"?"Reparatur-Schwelle:":s==="fr"?"Seuil de rÃ©paration:":"Force repair threshold:"}),e.jsxs("select",{value:es===null?"default":es,onChange:n=>Kt(n.target.value==="default"?null:parseInt(n.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"default",children:s==="de"?"Standard (nur bei Fehler)":s==="fr"?"DÃ©faut (seulement si erreur)":"Default (only on failure)"}),e.jsx("option",{value:"100",children:s==="de"?"100% (immer reparieren)":s==="fr"?"100% (toujours rÃ©parer)":"100% (always repair)"}),e.jsx("option",{value:"90",children:"90%"}),e.jsx("option",{value:"80",children:"80%"}),e.jsx("option",{value:"75",children:"75%"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die QualitÃ¤tsprÃ¼fung bestehen":s==="fr"?"Ã€ 100%, toutes les pages avec des problÃ¨mes sont rÃ©parÃ©es, mÃªme si elles passent le contrÃ´le qualitÃ©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Zs,onChange:n=>Ys(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"KonsistenzprÃ¼fung aktivieren":s==="fr"?"Activer la vÃ©rification de cohÃ©rence":"Enable final checks"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft Bilder und Text auf Konsistenz am Ende der Generierung":s==="fr"?"VÃ©rifie la cohÃ©rence des images et du texte Ã  la fin de la gÃ©nÃ©ration":"Checks images and text for consistency at end of generation"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:yt,onChange:n=>lr(n.target.checked),className:"rounded border-cyan-300 text-cyan-600 focus:ring-cyan-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenen-Validierung":s==="fr"?"Validation de scÃ¨ne":"Scene validation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt gÃ¼nstige Vorschau, prÃ¼ft Geometrie, repariert Kompositionsprobleme":s==="fr"?"GÃ©nÃ¨re un aperÃ§u Ã©conomique, vÃ©rifie la gÃ©omÃ©trie, rÃ©pare les problÃ¨mes de composition":"Generates cheap preview, checks geometry, repairs composition issues"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Jt,onChange:n=>Mr(n.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Getrennte Auswertung":s==="fr"?"Ã‰valuation sÃ©parÃ©e":"Separated evaluation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt alle Bilder zuerst, dann wertet alle parallel aus und repariert":s==="fr"?"GÃ©nÃ¨re toutes les images d'abord, puis Ã©value et rÃ©pare en parallÃ¨le":"Generates all images first, then evaluates and repairs in batch"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Cr,onChange:n=>kr(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Inkrementelle Konsistenz":s==="fr"?"CohÃ©rence incrÃ©mentielle":"Incremental consistency"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft jedes Bild gegen vorherige Bilder wÃ¤hrend der Generierung":s==="fr"?"VÃ©rifie chaque image par rapport aux images prÃ©cÃ©dentes pendant la gÃ©nÃ©ration":"Checks each image against previous images during generation"}),Cr&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:Xs,onChange:n=>a(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur Protokoll (Dry Run)":s==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),Cr&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Zeigt nur an, was repariert wÃ¼rde, ohne tatsÃ¤chlich zu reparieren":s==="fr"?"Affiche uniquement ce qui serait rÃ©parÃ© sans effectuer de rÃ©parations":"Shows what would be fixed without actually fixing"}),Cr&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-700 text-sm",children:s==="de"?"Vergleichsfenster:":s==="fr"?"FenÃªtre de comparaison:":"Lookback window:"}),e.jsx("input",{type:"range",min:"1",max:"5",value:ke,onChange:n=>lt(parseInt(n.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),e.jsx("span",{className:"text-gray-600 font-medium w-4",children:ke})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?`Vergleicht jedes Bild mit den ${ke} vorherigen`:s==="fr"?`Compare chaque image avec les ${ke} prÃ©cÃ©dentes`:`Compares each image with the previous ${ke}`})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[e.jsx("input",{type:"checkbox",checked:we,onChange:n=>Ns(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur PrÃ¼fung (keine Regenerierung)":s==="fr"?"VÃ©rification seule (pas de rÃ©gÃ©nÃ©ration)":"Check only (no regeneration)"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"FÃ¼hrt alle QualitÃ¤tsprÃ¼fungen durch, Ã¼berspringt aber Regenerierung/Reparatur":s==="fr"?"ExÃ©cute toutes les vÃ©rifications de qualitÃ© mais ignore la rÃ©gÃ©nÃ©ration/rÃ©paration":"Runs all quality checks but skips regeneration/repair"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:dr,onChange:n=>ts(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Alle Avatare laden":s==="fr"?"Charger tous les avatars":"Load all avatars"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"LÃ¤dt alle Avatar-Varianten (30MB+). NÃ¼tzlich zum Debuggen.":s==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le dÃ©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),ee&&((p==null?void 0:p.role)==="admin"||y)&&e.jsx(Po,{selections:tt,onChange:ea}),e.jsxs("button",{onClick:Nn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(Dn,{size:20})," ",h.back]})]})]})]})}),t&&!vr&&!At&&!_s.frontCover&&!ne&&e.jsx(uo,{current:br.current,total:br.total,message:br.message,coverImages:_s,characters:be,jobId:Va||void 0,isStalled:ga,onDismissStalled:()=>yr(!1),isImpersonating:y,onMinimize:()=>Ze(!0),onCancel:Va?async()=>{try{await Fe.cancelJob(Va),x.info("Job cancelled by user"),u(!1),Ca(null),yr(!1),rr({current:0,total:0,message:""}),M(s==="de"?"Generierung abgebrochen":s==="fr"?"GÃ©nÃ©ration annulÃ©e":"Generation cancelled")}catch(n){x.error("Failed to cancel job:",n),D(s==="de"?"Abbruch fehlgeschlagen":s==="fr"?"Ã‰chec de l'annulation":"Failed to cancel")}}:void 0}),$e&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Geschichte wird im Hintergrund generiert":s==="fr"?"Histoire en cours de gÃ©nÃ©ration":"Story generating in background"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Was mÃ¶chtest du tun?":s==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{Be(!0),Ze(!1),r("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Neue Geschichte erstellen":s==="fr"?"CrÃ©er une autre histoire":"Create another story"}),oe&&e.jsx("button",{onClick:()=>{Be(!0),Ze(!1),r("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Meine Geschichten lesen":s==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),ft&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Nur ein Charakter":s==="fr"?"Un seul personnage":"Only One Character"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":s==="fr"?"Les histoires sont plus intÃ©ressantes avec plusieurs personnages. Vous n'avez crÃ©Ã© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{Ct(!1),Ya()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Weiteren Charakter erstellen":s==="fr"?"CrÃ©er un autre personnage":"Create another character"}),e.jsx("button",{onClick:async()=>{Ct(!1),await Nr(C+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Trotzdem weiter":s==="fr"?"Continuer quand mÃªme":"Continue anyway"})]})]})}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[e.jsx("div",{className:"relative inline-block mb-4",children:e.jsx(Ye,{size:40,className:"animate-spin text-indigo-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s==="de"?"Bild wird erstellt...":s==="fr"?"CrÃ©ation de l'image...":"Generating image..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:s==="de"?"Dies dauert etwa 30 Sekunden":s==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),oi&&st&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:s==="de"?"Bild bearbeiten":s==="fr"?"Modifier l'image":"Edit Image"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:st.type==="image"?s==="de"?`Seite ${st.pageNumber}`:s==="fr"?`Page ${st.pageNumber}`:`Page ${st.pageNumber}`:s==="de"?st.coverType==="front"?"Titelseite":st.coverType==="back"?"RÃ¼ckseite":"Einleitungsseite":s==="fr"?st.coverType==="front"?"Couverture":st.coverType==="back"?"Dos":"Page de dÃ©dicace":st.coverType==="front"?"Front Cover":st.coverType==="back"?"Back Cover":"Dedication Page"}),e.jsx("textarea",{value:Hs,onChange:n=>Vs(n.target.value),placeholder:s==="de"?`Beschreibe die gewÃ¼nschte Ã„nderung...
z.B. "Mach den Himmel blauer" oder "FÃ¼ge einen Schmetterling hinzu"`:s==="fr"?`DÃ©crivez le changement souhaitÃ©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{onClick:()=>{Pa(!1),$a(null),Vs("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:s==="de"?"Abbrechen":s==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:async()=>{if(!(!Hs.trim()||!je)){Pa(!1),J(!0);try{if(st.type==="image"&&st.pageNumber){const n=await Fe.editImage(je,st.pageNumber,Hs);if(x.info("Edit result:",{hasImageData:!!(n!=null&&n.imageData),score:n==null?void 0:n.qualityScore}),!(n!=null&&n.imageData))throw x.error("No imageData in edit response!",n),new Error("No image data returned from server");Rt(b=>b.map(m=>m.pageNumber===st.pageNumber?{...m,imageData:n.imageData,qualityScore:n.qualityScore,qualityReasoning:n.qualityReasoning,wasEdited:!0,originalImage:n.originalImage,originalScore:n.originalScore,originalReasoning:n.originalReasoning}:m)),x.info("Image edited successfully, updated state with quality info")}else if(st.type==="cover"&&st.coverType){const n=await Fe.editCover(je,st.coverType,Hs);sr(b=>{if(!b)return b;const m=st.coverType==="front"?"frontCover":st.coverType==="back"?"backCover":"initialPage",$=b[m],f={...typeof $=="object"?$:{},imageData:n.imageData,qualityScore:n.qualityScore,qualityReasoning:n.qualityReasoning,wasEdited:!0,originalImage:n.originalImage,originalScore:n.originalScore,originalReasoning:n.originalReasoning};return{...b,[m]:f}}),x.info("Cover edited successfully with quality info")}}catch(n){x.error("Edit failed:",n),D(s==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de la modification. Veuillez rÃ©essayer.":"Edit failed. Please try again.")}finally{J(!1),$a(null),Vs("")}}},disabled:!Hs.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:s==="de"?"Bearbeiten":s==="fr"?"Modifier":"Edit"})]})]})}),e.jsx(zo,{isOpen:_a,faces:ns,onSelect:pi,onUploadNew:fi,developerMode:ee}),e.jsx(Do,{isOpen:Kr,onClose:()=>tr(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const n=localStorage.getItem("verificationGenerationStarted");if(n){const b=parseInt(n,10),m=Date.now()-120*1e3;if(b>m){console.log("[EmailVerification] Another window started recently, skipping"),tr(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),Zr({skipEmailCheck:!0}),tr(!1)}})]}):e.jsx(Cn,{fullScreen:!0})}const wl=Object.freeze(Object.defineProperty({__proto__:null,default:Ko},Symbol.toStringTag,{value:"Module"}));export{po as I,so as S,ao as U,fs as a,Zn as b,ze as c,hl as d,yl as e,Eo as f,Ro as g,vl as h,_n as i,fl as j,jl as k,pl as l,bl as m,Nl as n,Vn as o,Wn as p,xl as q,un as r,gl as s,qn as t,ul as u,ln as v,wl as w};
