import{c as le,u as ce,a as de,d as me,b as ue,j as e,e as Q,T as te,E as ge}from"./index-Dg82FFex.js";import{u as he,d as xe,b as l}from"./vendor-react-CHhk3aw2.js";import{s as R,N as fe}from"./Textarea-aT9RIafr.js";import{a as q}from"./api-CfwEHKrY.js";import{B as J,M as pe}from"./Pricing-Bvo_RRbB.js";import{T as be}from"./trash-2-D1VsHEhV.js";import"./vendor-firebase-DTVMaYMy.js";import"./arrow-left-Dk9vPuXj.js";import"./check-CqYe_0WB.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=le("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),f=ue("MyStories");let c={data:null,total:0,timestamp:0,userId:null};const ye=300*1e3,ve=6,ee=18,je=l.memo(function({story:a,language:x,onView:s,onDelete:C,formatDate:y,isSelected:m,onToggleSelect:L,onLoadCover:I,t:M}){const[u,p]=l.useState(!1),[v,j]=l.useState(!1),[b,E]=l.useState(!1),[w,$]=l.useState(!1),N=l.useRef(null);return l.useEffect(()=>{const g=new IntersectionObserver(([T])=>{T.isIntersecting&&(E(!0),g.disconnect())},{rootMargin:"100px"});return N.current&&g.observe(N.current),()=>g.disconnect()},[]),l.useEffect(()=>{b&&a.hasThumbnail&&!a.thumbnail&&!w&&($(!0),I(a.id))},[b,a.hasThumbnail,a.thumbnail,a.id,w,I]),e.jsxs("div",{ref:N,className:`bg-white rounded-xl shadow-md overflow-hidden transition-all flex flex-col hover:shadow-lg ${a.isPartial?"ring-2 ring-amber-400":""} ${m?"ring-8 ring-green-500":""}`,children:[e.jsxs("div",{className:"relative",children:[b&&a.thumbnail&&!v?e.jsxs("div",{className:"relative w-full h-48 bg-gray-100",children:[!u&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 spinner"})}),e.jsx("img",{src:a.thumbnail,alt:a.title,className:`w-full h-48 object-cover transition-opacity duration-300 ${u?"opacity-100":"opacity-0"}`,onLoad:()=>p(!0),onError:()=>j(!0)})]}):!b||a.hasThumbnail&&!a.thumbnail&&!v?e.jsx("div",{className:"relative w-full h-48 bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 spinner"})}):e.jsx("div",{className:"relative w-full h-48 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center",children:e.jsx(J,{className:"w-12 h-12 text-indigo-300"})}),a.isPartial&&e.jsxs("div",{className:"absolute top-2 left-2 bg-amber-500 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1",children:[e.jsx(te,{size:12}),x==="de"?"Teilweise":x==="fr"?"Partiel":"Partial"]}),e.jsx("button",{onClick:g=>{g.stopPropagation(),C()},className:"absolute top-2 right-2 p-2 bg-white/90 text-red-600 hover:bg-red-100 rounded-lg shadow-sm",children:e.jsx(be,{size:16})})]}),e.jsxs("div",{className:"p-4 flex flex-col flex-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:a.title}),a.isPartial?e.jsxs("p",{className:"text-sm text-amber-600 mb-3",children:[a.generatedPages||0,"/",a.totalPages||a.pages," ",x==="de"?"Seiten generiert":x==="fr"?"pages générées":"pages generated"," • ",y(a.created_at||a.createdAt)]}):e.jsxs("p",{className:"text-sm text-gray-500 mb-3",children:[a.pageCount||a.pages," ",x==="de"?"Seiten":"pages"," • ",y(a.created_at||a.createdAt)]})]}),e.jsxs("div",{className:"flex gap-2 mt-auto",children:[e.jsxs("button",{onClick:g=>{g.stopPropagation(),s()},className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",children:[e.jsx(ge,{size:18}),x==="de"?"Ansehen":x==="fr"?"Voir":"View"]}),!a.isPartial&&e.jsx("button",{onClick:g=>{g.stopPropagation(),L()},className:`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${m?"bg-red-600 text-white hover:bg-red-700":"bg-green-600 text-white hover:bg-green-700"}`,children:m?M.remove:M.add})]})]})]})});function $e(){const S=he(),[a,x]=xe(),{language:s}=ce(),{isAuthenticated:C,isLoading:y,user:m}=de(),{showSuccess:L,showInfo:I,showError:M}=me(),[u,p]=l.useState([]),[v,j]=l.useState(!0),[b,E]=l.useState(!1),[w,$]=l.useState(!1),[N,g]=l.useState(0),[T,O]=l.useState(null),z=l.useRef(!1),[h,D]=l.useState(()=>{try{const t=sessionStorage.getItem("mystories_selected");if(t)return new Set(JSON.parse(t))}catch{}return new Set});l.useEffect(()=>{sessionStorage.setItem("mystories_selected",JSON.stringify([...h]))},[h]),l.useEffect(()=>{(async()=>{const r=a.get("payment"),i=a.get("session_id");if(r==="success"&&i){f.info("Payment successful! Checking order status...");try{const o=await R.getOrderStatus(i);if(f.info("Order Status:",o),o.order){D(new Set),sessionStorage.removeItem("mystories_selected");const k=`CHF ${(o.order.amount_total/100).toFixed(2)}`,B={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement réussi!"},F={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a été reçue et sera bientôt imprimée."},H=[`${s==="de"?"Kunde":s==="fr"?"Client":"Customer"}: ${o.order.customer_name}`,`Email: ${o.order.customer_email}`,`${s==="de"?"Betrag":s==="fr"?"Montant":"Amount"}: ${k}`,`${s==="de"?"Versand an":s==="fr"?"Expédié à":"Shipping to"}: ${o.order.shipping_name}`,`${o.order.shipping_address_line1}`,`${o.order.shipping_postal_code} ${o.order.shipping_city}`,`${o.order.shipping_country}`];L(F[s]||F.en,B[s]||B.en,H)}}catch(o){f.error("Error checking order status:",o)}const n=new URLSearchParams(a);n.delete("payment"),n.delete("session_id"),x(n,{replace:!0})}else if(r==="cancelled"){f.info("Payment cancelled by user");const n={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie können es erneut versuchen.",fr:"Paiement annulé. Vous pouvez réessayer quand vous êtes prêt."};I(n[s]||n.en,s==="de"?"Abgebrochen":s==="fr"?"Annulé":"Cancelled");const o=new URLSearchParams(a);o.delete("payment"),x(o,{replace:!0})}})()},[a,x,s,L,I]);const K={en:{myStories:"My Stories",createStory:"Create Story",noStories:"No stories created yet",seePricing:"See Pricing",selectHint:"Select stories to create a book",selected:"selected",pages:"pages",createBook:"Create Book",tooManyPages:"Too many pages (max 100)",add:"Add",remove:"Remove",loadAll:"Load All"},de:{myStories:"Meine Geschichten",createStory:"Geschichte erstellen",noStories:"Noch keine Geschichten erstellt",seePricing:"Preise ansehen",selectHint:"Wähle Geschichten, um ein Buch zu erstellen",selected:"ausgewählt",pages:"Seiten",createBook:"Buch erstellen",tooManyPages:"Zu viele Seiten (max. 100)",add:"Hinzufügen",remove:"Entfernen",loadAll:"Alle laden"},fr:{myStories:"Mes histoires",createStory:"Créer une histoire",noStories:"Aucune histoire créée",seePricing:"Voir les tarifs",selectHint:"Sélectionnez des histoires pour créer un livre",selected:"sélectionné(s)",pages:"pages",createBook:"Créer le livre",tooManyPages:"Trop de pages (max 100)",add:"Ajouter",remove:"Retirer",loadAll:"Tout charger"}},d=K[s]||K.en;l.useEffect(()=>{const t=(m==null?void 0:m.id)||null;c.userId!==null&&c.userId!==t&&(f.debug(`User changed (${c.userId} -> ${t}), clearing stories`),p([]),g(0),z.current=!1,c={data:null,total:0,timestamp:0,userId:null})},[m==null?void 0:m.id]),l.useEffect(()=>{if(!y){if(!C){S("/");return}z.current||(z.current=!0,_())}},[C,y,S]);const _=async(t={})=>{const{loadMore:r=!1,loadAll:i=!1}=t,n=Date.now();f.debug("Loading stories...",{loadMore:r,loadAll:i});try{O(null);const o=Date.now(),k=(m==null?void 0:m.id)||null,B=c.data&&c.userId===k&&o-c.timestamp<ye;if(!r&&!i&&B){const Z=Math.round((o-c.timestamp)/1e3);f.debug(`Using cached stories (${c.data.length} stories, cache age: ${Z}s, user: ${k})`),p(c.data),g(c.total),$(c.data.length<c.total),j(!1);return}r||i?E(!0):j(!0);const F=r||i?u.length:0,H=i?1e3:ve,{stories:W,pagination:A}=await R.getStories({limit:H,offset:F}),oe=Date.now()-n;f.info(`Loaded ${W.length} stories in ${oe}ms (total: ${A.total})`);const U=W;r||i?p(Z=>{const X=[...Z,...U];return c={data:X,total:A.total,timestamp:o,userId:k},X}):(p(U),c={data:U,total:A.total,timestamp:o,userId:k}),g(A.total),$(A.hasMore)}catch(o){f.error("Failed to load stories:",o),O(s==="de"?"Geschichten konnten nicht geladen werden":s==="fr"?"Impossible de charger les histoires":"Failed to load stories"),c={data:null,total:0,timestamp:0,userId:null}}finally{j(!1),E(!1)}};l.useEffect(()=>{!v&&!b&&w&&u.length<ee&&u.length>0&&_({loadMore:!0})},[u.length,w,v,b]);const se=l.useCallback(async t=>{try{const r=await R.getStoryCover(t),i=n=>n.id===t?{...n,thumbnail:r||void 0,hasThumbnail:!!r}:n;p(n=>n.map(i)),c.data&&(c.data=c.data.map(i))}catch(r){f.error("Failed to load cover for story:",t,r);const i=n=>n.id===t?{...n,hasThumbnail:!1}:n;p(n=>n.map(i)),c.data&&(c.data=c.data.map(i))}},[]),ae=async t=>{if(confirm(s==="de"?"Diese Geschichte wirklich löschen?":s==="fr"?"Voulez-vous vraiment supprimer cette histoire?":"Are you sure you want to delete this story?"))try{await R.deleteStory(t);const i=u.filter(n=>n.id!==t);p(i),g(n=>Math.max(0,n-1)),c={data:i,total:Math.max(0,N-1),timestamp:Date.now(),userId:(m==null?void 0:m.id)||null},D(n=>{const o=new Set(n);return o.delete(t),o})}catch(i){f.error("Failed to delete story:",i),M(s==="de"?"Geschichte konnte nicht gelöscht werden. Bitte versuche es erneut.":s==="fr"?"Impossible de supprimer l'histoire. Veuillez réessayer.":"Failed to delete story. Please try again.")}},re=l.useCallback(t=>{if(!t)return"";try{return new Date(t).toLocaleDateString(s==="de"?"de-DE":s==="fr"?"fr-FR":"en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return""}},[s]),ne=t=>{D(r=>{const i=new Set(r);return i.has(t)?i.delete(t):i.add(t),i})},V=l.useMemo(()=>u.filter(t=>h.has(t.id)),[u,h]),G=l.useMemo(()=>V.reduce((t,r)=>t+(r.pageCount||r.pages),0),[V]),P=G>pe,Y=()=>{const t=V.map(r=>({id:r.id,title:r.title,pages:r.pageCount||r.pages,thumbnail:r.thumbnail}));S("/book-builder",{state:{selectedStories:t}})};if(y||!C)return e.jsx(Q,{fullScreen:!0});const ie=u.filter(t=>!t.isPartial).length>=1;return e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-24",children:[e.jsx(fe,{currentStep:0}),e.jsxs("div",{className:"px-4 md:px-8 py-8 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(J,{size:28}),d.myStories]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("button",{onClick:()=>S("/pricing"),className:"flex items-center gap-2 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 font-medium transition-colors",children:[e.jsx(Se,{size:18}),d.seePricing]}),ie&&e.jsxs("button",{onClick:Y,disabled:h.size===0||P,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(q,{size:18}),d.createBook,h.size>0&&e.jsx("span",{className:"bg-white text-indigo-600 text-xs px-2 py-0.5 rounded-full",children:h.size})]}),e.jsx("button",{onClick:()=>S("/create"),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors",children:d.createStory})]})]}),u.length>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6 flex items-center gap-3",children:[e.jsx(q,{size:20,className:"text-blue-600 flex-shrink-0"}),e.jsx("p",{className:"text-blue-800 text-sm",children:d.selectHint}),h.size>0&&e.jsxs("span",{className:`ml-auto text-sm font-medium ${P?"text-red-600":"text-blue-600"}`,children:[h.size," ",d.selected," • ",G," ",d.pages,P&&` (${d.tooManyPages})`]})]}),v?e.jsx(Q,{message:s==="de"?"Laden...":s==="fr"?"Chargement...":"Loading..."}):T?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(te,{className:"w-16 h-16 text-amber-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700 text-lg mb-4",children:T}),e.jsx("button",{onClick:()=>{z.current=!1,O(null),j(!0),_()},className:"px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:s==="de"?"Erneut versuchen":s==="fr"?"Réessayer":"Try Again"})]}):u.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(J,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg",children:d.noStories}),e.jsx("button",{onClick:()=>S("/create"),className:"mt-4 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:d.createStory})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:u.map(t=>e.jsx(je,{story:t,language:s,onView:()=>S(`/create?storyId=${t.id}`),onDelete:()=>ae(t.id),formatDate:re,isSelected:h.has(t.id),onToggleSelect:()=>ne(t.id),onLoadCover:se,t:{add:d.add,remove:d.remove}},t.id))}),w&&u.length>=ee&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx("button",{onClick:()=>_({loadAll:!0}),disabled:b,className:"flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors disabled:opacity-50",children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 spinner"}),s==="de"?"Laden...":s==="fr"?"Chargement...":"Loading..."]}):e.jsxs(e.Fragment,{children:[d.loadAll," (",N-u.length," ",s==="de"?"weitere":s==="fr"?"autres":"more",")"]})})})]}),h.size>0&&e.jsx("div",{className:"h-24"})]}),h.size>0&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[h.size," ",d.selected," • ",G," ",d.pages]}),P&&e.jsxs("span",{className:"text-red-600 font-medium",children:["(",d.tooManyPages,")"]})]}),e.jsxs("button",{onClick:Y,disabled:P,className:`flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-colors ${P?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:[e.jsx(q,{size:20}),d.createBook]})]})})]})}export{$e as default};
