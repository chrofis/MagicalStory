const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StoryDisplay-B0F3Y_QC.js","assets/index-Z-lQ-nSh.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-Ca9HU76l.css","assets/Input-BbHCDbuX.js","assets/Textarea-BTtSVnvt.js","assets/sparkles-k5Ff9_tk.js","assets/book-open-BvI9BdsH.js","assets/history-CqDTu5cr.js","assets/download--6AMrbyo.js","assets/chevron-down-DqC-tVz-.js","assets/chevron-right-BNt_wdWx.js","assets/ImageLightbox-C2xNnLcf.js","assets/rotate-ccw-D0blr0hY.js","assets/chevron-up-0zjrdJmW.js","assets/Modal-BP-IM4BE.js","assets/palette-C1H2NFIr.js","assets/book-BBIVcQUK.js","assets/check-BM5y4HnJ.js","assets/save-Cdx_TuGW.js","assets/shopping-cart-Bc98iJoV.js","assets/plus-CVnxQll3.js","assets/wrench-MHqRiUbu.js","assets/circle-x-A0R27HUw.js","assets/clock-CfIpOe4p.js","assets/arrow-left-C-4xOtn4.js","assets/arrow-right-J50q20XW.js","assets/RepairWorkflowPanel-_YgDgWK3.js","assets/square-BuIZHixq.js","assets/search-BHxbosBG.js","assets/WizardStep2Characters-Bt5vXZdL.js","assets/pen-deribgZN.js","assets/trash-2-CzInmazt.js","assets/camera-BwuoGgkA.js","assets/pencil-C2tynmvj.js","assets/WizardStep4StoryType-C1QUF6vN.js","assets/WizardStep5ArtStyle-BtVS8Ump.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-3Zeg4XUz.js"])))=>i.map(i=>d[i]);
import{c as Pt,b as Pe,d as $n,j as t,X as Rn,u as qt,a as jr,L as ut,T as fi,C as fn,E as pi,e as yi,f as vi,s as ye,g as pn,_ as It}from"./index-Z-lQ-nSh.js";import{b as s,u as xi,e as bi}from"./vendor-react-CqfXSjHo.js";import{B as Ga,I as yn}from"./Input-BbHCDbuX.js";import{A as vn,N as Si}from"./Textarea-BTtSVnvt.js";import{C as wi}from"./circle-x-A0R27HUw.js";import{C as Ci}from"./clock-CfIpOe4p.js";import{M as En,I as xn,R as ji,a as ki}from"./Modal-BP-IM4BE.js";import{S as Ot}from"./sparkles-k5Ff9_tk.js";import{P as Ai}from"./palette-C1H2NFIr.js";import{C as Gn}from"./chevron-down-DqC-tVz-.js";import{B as Ni}from"./book-open-BvI9BdsH.js";import{A as bn}from"./arrow-left-C-4xOtn4.js";import{A as Ti}from"./arrow-right-J50q20XW.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pi=Pt("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ii=Pt("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Di=Pt("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $i=Pt("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ri=Pt("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ei=Pt("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gi=Pt("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Bi={async login(e,n){const u=await Pe.post("/api/auth/login",{username:e,password:n},{skipAuth:!0}),S={id:u.user.id,username:u.user.username,email:u.user.email,role:u.user.role,credits:u.user.credits};return{token:u.token,user:S}},async register(e,n,u){return Pe.post("/api/auth/register",{username:e,password:n,email:u},{skipAuth:!0})},async loginWithFirebase(e){const n=await Pe.post("/api/auth/firebase",{idToken:e},{skipAuth:!0}),u={id:n.user.id,username:n.user.username,email:n.user.email,role:n.user.role,credits:n.user.credits};return{token:n.token,user:u}},async getQuota(){const e=await Pe.get("/api/user/quota");return{storyQuota:e.storyQuota,storiesGenerated:e.storiesGenerated,remaining:e.remaining}},async getCredits(){const e=await Pe.get("/api/user/quota");return{credits:e.credits,unlimited:e.unlimited}},async updateEmail(e){await Pe.put("/api/user/update-email",{email:e})},async getShippingAddress(){try{return await Pe.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(e){await Pe.put("/api/user/shipping-address",e)}},_=$n("CharacterService");function Bn(e){if(!e)return;const n=parseInt(e,10);if(!(isNaN(n)||n<0))return n<=1?"infant":n<=2?"toddler":n<=4?"preschooler":n<=6?"kindergartner":n<=8?"young-school-age":n<=10?"school-age":n<=12?"preteen":n<=14?"young-teen":n<=17?"teenager":n<=25?"young-adult":n<=39?"adult":n<=59?"middle-aged":n<=75?"senior":"elderly"}function Sr(e){var r,G,x,D,U,re,Z,Y,M,T;const n=e.physical,u={height:(n==null?void 0:n.height)||e.height,build:(n==null?void 0:n.build)||e.build,face:(n==null?void 0:n.face)||e.other_features||e.otherFeatures,eyeColor:(n==null?void 0:n.eyeColor)||e.eye_color||e.eyeColor,hairColor:(n==null?void 0:n.hairColor)||e.hair_color||e.hairColor,hairLength:(n==null?void 0:n.hairLength)||e.hair_length||e.hairLength,hairStyle:(n==null?void 0:n.hairStyle)||e.hair_style||e.hairStyle,facialHair:(n==null?void 0:n.facialHair)||e.facial_hair||e.facialHair,skinTone:(n==null?void 0:n.skinTone)||e.skin_tone||e.skinTone,skinUndertone:(n==null?void 0:n.skinUndertone)||e.skin_undertone||e.skinUndertone,skinToneHex:(n==null?void 0:n.skinToneHex)||e.skin_tone_hex||e.skinToneHex,hair:(n==null?void 0:n.hairColor)||e.hair_color||e.hairColor,other:(n==null?void 0:n.other)||e.other,detailedHairAnalysis:(n==null?void 0:n.detailedHairAnalysis)||e.detailed_hair_analysis||e.detailedHairAnalysis,apparentAge:(n==null?void 0:n.apparentAge)||e.apparent_age||e.apparentAge},S=e.age_category||e.ageCategory||Bn(e.age);return{id:e.id,name:e.name,gender:e.gender,age:e.age,ageCategory:S,physical:u.height||u.build||u.face||u.eyeColor||u.hairColor||u.hairLength||u.hairStyle||u.facialHair||u.skinTone||u.hair||u.other||u.detailedHairAnalysis||u.apparentAge?u:void 0,physicalTraitsSource:e.physical_traits_source||e.physicalTraitsSource,traits:{strengths:((r=e.traits)==null?void 0:r.strengths)||e.strengths||[],flaws:((G=e.traits)==null?void 0:G.flaws)||e.flaws||e.weaknesses||[],challenges:((x=e.traits)==null?void 0:x.challenges)||e.challenges||e.fears||[],specialDetails:((D=e.traits)==null?void 0:D.specialDetails)||e.special_details||e.specialDetails},photos:{original:((U=e.photos)==null?void 0:U.original)||e.photo_url||e.photoUrl,face:((re=e.photos)==null?void 0:re.face)||e.thumbnail_url||e.thumbnailUrl,body:((Z=e.photos)==null?void 0:Z.body)||e.body_photo_url||e.bodyPhotoUrl,bodyNoBg:((Y=e.photos)==null?void 0:Y.bodyNoBg)||e.body_no_bg_url||e.bodyNoBgUrl,faceBox:((M=e.photos)==null?void 0:M.faceBox)||e.face_box||e.faceBox,bodyBox:((T=e.photos)==null?void 0:T.bodyBox)||e.body_box||e.bodyBox},avatars:e.avatars||e.clothing_avatars||e.clothingAvatars,clothing:e.clothing||e.structured_clothing||e.structuredClothing?{current:e.clothing,structured:e.structured_clothing||e.structuredClothing}:void 0,generatedOutfits:e.generated_outfits||e.generatedOutfits,storyRole:e.storyRole}}function Sn(e){var u,S,r,G,x,D,U,re,Z,Y,M,T,ne,le,K,J,ce,ge,ie,E,X,V,ee,p;const n=e.ageCategory||Bn(e.age);return{id:e.id,name:e.name,gender:e.gender,age:e.age,age_category:n,apparent_age:(u=e.physical)==null?void 0:u.apparentAge,height:(S=e.physical)==null?void 0:S.height,build:(r=e.physical)==null?void 0:r.build,eye_color:(G=e.physical)==null?void 0:G.eyeColor,hair_color:(x=e.physical)==null?void 0:x.hairColor,hair_length:(D=e.physical)==null?void 0:D.hairLength,hair_style:(U=e.physical)==null?void 0:U.hairStyle,facial_hair:(re=e.physical)==null?void 0:re.facialHair,skin_tone:(Z=e.physical)==null?void 0:Z.skinTone,skin_undertone:(Y=e.physical)==null?void 0:Y.skinUndertone,skin_tone_hex:(M=e.physical)==null?void 0:M.skinToneHex,other_features:(T=e.physical)==null?void 0:T.face,other:(ne=e.physical)==null?void 0:ne.other,detailed_hair_analysis:(le=e.physical)==null?void 0:le.detailedHairAnalysis,physical_traits_source:e.physicalTraitsSource,face_box:(K=e.photos)==null?void 0:K.faceBox,body_box:(J=e.photos)==null?void 0:J.bodyBox,strengths:(ce=e.traits)==null?void 0:ce.strengths,flaws:(ge=e.traits)==null?void 0:ge.flaws,challenges:(ie=e.traits)==null?void 0:ie.challenges,special_details:(E=e.traits)==null?void 0:E.specialDetails,weaknesses:(X=e.traits)==null?void 0:X.flaws,fears:(V=e.traits)==null?void 0:V.challenges,clothing:(ee=e.clothing)==null?void 0:ee.current,structured_clothing:(p=e.clothing)==null?void 0:p.structured,generated_outfits:e.generatedOutfits,storyRole:e.storyRole}}function Fi(e){return!e||e.length===0?[]:typeof e[0]=="string"?e.map(n=>({forward:n,inverse:n})):e}const he={async getCharacters(e=!1){const n=e?"/api/characters?includeAllAvatars=true":"/api/characters";return((await Pe.get(n)).characters||[]).map(Sr)},async getCharacterData(e=!1){const n=e?"/api/characters?includeAllAvatars=true":"/api/characters",u=await Pe.get(n);return{characters:(u.characters||[]).map(Sr),relationships:u.relationships||{},relationshipTexts:u.relationshipTexts||{},customRelationships:Fi(u.customRelationships),customStrengths:u.customStrengths||[],customWeaknesses:u.customWeaknesses||[],customFears:u.customFears||[]}},async saveCharacters(e){await Pe.post("/api/characters",{characters:e.map(Sn)})},async saveCharacterData(e,n){const u=r=>{var x,D,U,re;const G=Sn(r);return n!=null&&n.includePhotos&&(G.photo_url=(x=r.photos)==null?void 0:x.original,G.thumbnail_url=(D=r.photos)==null?void 0:D.face,G.body_photo_url=(U=r.photos)==null?void 0:U.body,G.body_no_bg_url=(re=r.photos)==null?void 0:re.bodyNoBg),G},S={characters:e.characters.map(u),relationships:e.relationships,relationshipTexts:e.relationshipTexts,customRelationships:e.customRelationships,customStrengths:e.customStrengths,customWeaknesses:e.customWeaknesses,customFears:e.customFears};await Pe.post("/api/characters",S)},async deleteCharacter(e){try{const n=await Pe.delete(`/api/characters/${e}`);return _.success(`Deleted character ${e}: ${n.message}`),{success:!0}}catch(n){return _.error(`Failed to delete character ${e}:`,n),{success:!1,error:String(n)}}},async saveCharacterRoles(e){try{return await Pe.put("/api/characters/roles",{roles:e}),_.success(`Saved character roles: ${Object.keys(e).length} characters`),{success:!0}}catch(n){return _.error("Failed to save character roles:",n),{success:!1,error:String(n)}}},async loadCharacterAvatars(e){try{const n=await Pe.get(`/api/characters/${e}/avatars`);return _.info(`Loaded full avatars for character ${e}`),n.avatars||null}catch(n){return _.error(`Failed to load avatars for character ${e}:`,n),null}},async loadFullCharacter(e){try{const n=await Pe.get(`/api/characters/${e}/full`);return n.character?(_.info(`Loaded full data for character ${e}`),Sr(n.character)):null}catch(n){return _.error(`Failed to load full data for character ${e}:`,n),null}},async generateAvatarOptions(e,n){try{return await Pe.post("/api/generate-avatar-options",{facePhoto:e,gender:n,category:"standard"})}catch(u){const S=u instanceof Error?u.message:"Unknown error";return{success:!1,options:[],error:S}}},async generateClothingAvatars(e,n){var u,S,r,G,x,D,U,re,Z,Y,M,T,ne,le,K;try{if(!!!((u=e.photos)!=null&&u.bodyNoBg||(S=e.photos)!=null&&S.body||(r=e.photos)!=null&&r.face||(G=e.photos)!=null&&G.original)&&e.id){_.info(`ðŸ“¸ No photos in character object for ${e.name} (id: ${e.id}), loading full data...`);const B=await he.loadFullCharacter(e.id);if(B!=null&&B.photos)e={...e,photos:B.photos},_.info(`ðŸ“¸ Loaded photos: bodyNoBg=${!!B.photos.bodyNoBg}, body=${!!B.photos.body}, face=${!!B.photos.face}, original=${!!B.photos.original}`);else return _.warn(`ðŸ“¸ Failed to load photos for ${e.name} (id: ${e.id})`),{success:!1,error:"No photo available - upload a photo first"}}const ce=parseInt(e.age)||10,ge=e.gender||"child";let ie;ge==="male"?ie=ce>=18?"man":"boy":ge==="female"?ie=ce>=18?"woman":"girl":ie=ce>=18?"person":"child";let X=`${((x=e.name)==null?void 0:x.trim())||`This ${ie}`} is a ${ce}-year-old ${ie}`;e.physical&&(e.physical.hair&&(X+=`, ${e.physical.hair}`),e.physical.face&&(X+=`, ${e.physical.face}`),e.physical.build&&(X+=`, ${e.physical.build}`),e.physical.other&&(X+=`, ${e.physical.other}`));const V=((D=e.photos)==null?void 0:D.bodyNoBg)||((U=e.photos)==null?void 0:U.body)||((re=e.photos)==null?void 0:re.face)||((Z=e.photos)==null?void 0:Z.original);_.info(`ðŸŽ¨ Generating clothing avatars for ${e.name||"unnamed"} (id: ${e.id})`);const ee=await Pe.post("/api/generate-clothing-avatars?async=true",{characterId:e.id,facePhoto:V,physicalDescription:X,name:e.name,age:e.age,apparentAge:(Y=e.physical)==null?void 0:Y.apparentAge,gender:e.gender,build:(M=e.physical)==null?void 0:M.build,clothing:(T=e.clothing)==null?void 0:T.structured,avatarModel:n==null?void 0:n.avatarModel});if(ee.async&&ee.jobId){_.info(`Avatar job started: ${ee.jobId}, polling for completion...`);const B=60,te=2e3;for(let oe=0;oe<B;oe++){await new Promise(se=>setTimeout(se,te));const de=await Pe.get(`/api/avatar-jobs/${ee.jobId}`);if(de.status==="complete"&&de.clothingAvatars){_.success(`Avatar job ${ee.jobId} completed after ${(oe+1)*2}s`);const se=de.clothingAvatars.extractedTraits,ke=(ne=de.clothingAvatars.structuredClothing)==null?void 0:ne.standard;return _.info(`ðŸ” [DEBUG] extractedTraits: ${(le=JSON.stringify(se))==null?void 0:le.substring(0,100)}`),_.info(`ðŸ” [DEBUG] extractedClothing: ${JSON.stringify(ke)}`),_.info(`ðŸ” [DEBUG] structuredClothing keys: ${Object.keys(de.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:de.clothingAvatars,extractedTraits:se,extractedClothing:ke}}if(de.status==="failed")return _.error(`Avatar job failed: ${de.error}`),{success:!1,error:de.error};oe%5===0&&_.info(`Avatar job ${ee.jobId}: ${de.message||de.status} (${de.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const p=ee;if(p.success&&p.clothingAvatars){_.success(`Clothing avatars generated for ${e.name}`);const B=p.clothingAvatars.extractedTraits,te=(K=p.clothingAvatars.structuredClothing)==null?void 0:K.standard;return B&&_.info(`Extracted traits: ${JSON.stringify(B)}`),te&&_.info(`Extracted clothing: ${JSON.stringify(te)}`),{success:!0,avatars:p.clothingAvatars,extractedTraits:B,extractedClothing:te}}else return _.error(`Failed to generate avatars: ${p.error}`),{success:!1,error:p.error}}catch(J){return _.error("Clothing avatar generation failed:",J),{success:!1,error:String(J)}}},async generateClothingAvatarsWithTraits(e){var n,u,S,r,G,x,D,U,re,Z,Y,M,T,ne,le,K,J,ce,ge,ie,E,X;try{if(!!!((n=e.photos)!=null&&n.bodyNoBg||(u=e.photos)!=null&&u.body||(S=e.photos)!=null&&S.face||(r=e.photos)!=null&&r.original)&&e.id){_.info(`ðŸ“¸ No photos in character object for ${e.name} (id: ${e.id}), loading full data...`);const P=await he.loadFullCharacter(e.id);if(P!=null&&P.photos)e={...e,photos:P.photos},_.info(`ðŸ“¸ Loaded photos: bodyNoBg=${!!P.photos.bodyNoBg}, body=${!!P.photos.body}, face=${!!P.photos.face}, original=${!!P.photos.original}`);else return _.warn(`ðŸ“¸ Failed to load photos for ${e.name} (id: ${e.id})`),{success:!1,error:"No photo available - upload a photo first"}}const ee=parseInt(e.age)||10,p=e.gender||"child";let B;p==="male"?B=ee>=18?"man":"boy":p==="female"?B=ee>=18?"woman":"girl":B=ee>=18?"person":"child";let oe=`${((G=e.name)==null?void 0:G.trim())||`This ${B}`} is a ${ee}-year-old ${B}`;e.physical&&(e.physical.hair&&(oe+=`, ${e.physical.hair}`),e.physical.face&&(oe+=`, ${e.physical.face}`),e.physical.build&&(oe+=`, ${e.physical.build}`),e.physical.other&&(oe+=`, ${e.physical.other}`));const de=((x=e.photos)==null?void 0:x.bodyNoBg)||((D=e.photos)==null?void 0:D.body)||((U=e.photos)==null?void 0:U.face)||((re=e.photos)==null?void 0:re.original),se=(Z=e.photos)!=null&&Z.bodyNoBg?"bodyNoBg":(Y=e.photos)!=null&&Y.body?"body":(M=e.photos)!=null&&M.face?"face":"original",ke=de?Math.round(de.length/1024):0,Me=de==null?void 0:de.startsWith("data:image/png");_.info(`ðŸŽ¨ Generating clothing avatars WITH TRAITS for ${e.name} (id: ${e.id})`),_.info(`ðŸ“¸ Photo source: ${se}, size: ${ke}KB, format: ${Me?"PNG":"JPEG"}`),_.info(`ðŸ“¸ Available photos: bodyNoBg=${!!((T=e.photos)!=null&&T.bodyNoBg)}, body=${!!((ne=e.photos)!=null&&ne.body)}, face=${!!((le=e.photos)!=null&&le.face)}, original=${!!((K=e.photos)!=null&&K.original)}`),_.info(`Physical traits: ${JSON.stringify(e.physical)}`);const Ae=e.physicalTraitsSource||{};_.info(`Physical traits source: ${JSON.stringify(Ae)}`),_.info(`Physical skinTone value: '${(J=e.physical)==null?void 0:J.skinTone}', source: '${Ae.skinTone}'`),_.info(`Physical hairStyle value: '${(ce=e.physical)==null?void 0:ce.hairStyle}', source: '${Ae.hairStyle}'`);const Ne={};e.physical&&(Ae.eyeColor==="user"&&e.physical.eyeColor&&(Ne.eyeColor=e.physical.eyeColor),Ae.hairColor==="user"&&e.physical.hairColor&&(Ne.hairColor=e.physical.hairColor),Ae.hairLength==="user"&&e.physical.hairLength&&(Ne.hairLength=e.physical.hairLength),Ae.hairStyle==="user"&&e.physical.hairStyle&&(Ne.hairStyle=e.physical.hairStyle),Ae.build==="user"&&e.physical.build&&(Ne.build=e.physical.build),Ae.skinTone==="user"&&e.physical.skinTone&&(Ne.skinTone=e.physical.skinTone,e.physical.skinToneHex&&(Ne.skinToneHex=e.physical.skinToneHex)),Ae.face==="user"&&e.physical.face&&(Ne.face=e.physical.face),Ae.facialHair==="user"&&e.physical.facialHair&&(Ne.facialHair=e.physical.facialHair),Ae.other==="user"&&e.physical.other&&(Ne.other=e.physical.other));const Le=Object.keys(Ne).length>0;_.info(`Physical traits to send (user-edited only): ${Le?JSON.stringify(Ne):"none"}`);const me=e.clothingSource||{},Re={};(ge=e.clothing)!=null&&ge.structured&&(me.upperBody==="user"&&e.clothing.structured.upperBody&&(Re.upperBody=e.clothing.structured.upperBody),me.lowerBody==="user"&&e.clothing.structured.lowerBody&&(Re.lowerBody=e.clothing.structured.lowerBody),me.shoes==="user"&&e.clothing.structured.shoes&&(Re.shoes=e.clothing.structured.shoes),me.fullBody==="user"&&e.clothing.structured.fullBody&&(Re.fullBody=e.clothing.structured.fullBody));const ue=Object.keys(Re).length>0;_.info(`Clothing to send (user-edited only): ${ue?JSON.stringify(Re):"none"}`);const H=await Pe.post("/api/generate-clothing-avatars?async=true",{characterId:e.id,facePhoto:de,physicalDescription:oe,name:e.name,age:e.age,apparentAge:(ie=e.physical)==null?void 0:ie.apparentAge,gender:e.gender,build:Ne.build||"average",physicalTraits:Le?Ne:void 0,clothing:ue?Re:void 0});if(H.async&&H.jobId){_.info(`Avatar job started: ${H.jobId}, polling for completion...`);const P=60,ve=2e3;for(let $e=0;$e<P;$e++){await new Promise(We=>setTimeout(We,ve));const Ce=await Pe.get(`/api/avatar-jobs/${H.jobId}`);if(Ce.status==="complete"&&Ce.clothingAvatars){_.success(`Avatar job ${H.jobId} completed after ${($e+1)*2}s`);const We=Ce.clothingAvatars.extractedTraits,ze=(E=Ce.clothingAvatars.structuredClothing)==null?void 0:E.standard;return{success:!0,avatars:Ce.clothingAvatars,extractedTraits:We,extractedClothing:ze}}if(Ce.status==="failed")return _.error(`Avatar job failed: ${Ce.error}`),{success:!1,error:Ce.error};$e%5===0&&_.info(`Avatar job ${H.jobId}: ${Ce.message||Ce.status} (${Ce.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(H.success&&H.clothingAvatars){_.success(`Clothing avatars WITH TRAITS generated for ${e.name}`);const P=H.clothingAvatars.extractedTraits,ve=(X=H.clothingAvatars.structuredClothing)==null?void 0:X.standard;return{success:!0,avatars:H.clothingAvatars,extractedTraits:P,extractedClothing:ve}}else return _.error(`Failed to generate avatars with traits: ${H.error}`),{success:!1,error:H.error}}catch(V){return _.error("Clothing avatar generation with traits failed:",V),{success:!1,error:String(V)}}},async analyzePhoto(e,n,u,S,r){var G,x,D,U,re,Z,Y,M,T,ne,le,K,J,ce,ge,ie,E,X,V,ee;try{const p=await Pe.post("/api/analyze-photo",{imageData:e,language:n,selectedFaceId:u,cachedFaces:S,existingCharacterId:r});if(!p.success)return{success:!1,error:p.error};if(p.multipleFacesDetected&&p.faces)return _.info(`Multiple faces detected (${p.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:p.faceCount,faces:p.faces};const B={height:(G=p.attributes)==null?void 0:G.height,build:(x=p.attributes)==null?void 0:x.build,face:(D=p.attributes)==null?void 0:D.face,eyeColor:((U=p.attributes)==null?void 0:U.eye_color)||((re=p.attributes)==null?void 0:re.eyeColor),hairColor:((Z=p.attributes)==null?void 0:Z.hair_color)||((Y=p.attributes)==null?void 0:Y.hairColor),hairLength:((M=p.attributes)==null?void 0:M.hair_length)||((T=p.attributes)==null?void 0:T.hairLength),hairStyle:((ne=p.attributes)==null?void 0:ne.hair_style)||((le=p.attributes)==null?void 0:le.hairStyle),hair:((K=p.attributes)==null?void 0:K.hair_color)||((J=p.attributes)==null?void 0:J.hairColor),other:(ce=p.attributes)==null?void 0:ce.other_features};return{success:p.success,characterId:p.characterId,multipleFacesDetected:!1,faceCount:p.faceCount,photos:{face:p.faceThumbnail,body:p.bodyCrop,bodyNoBg:p.bodyNoBg,faceBox:p.faceBox,bodyBox:p.bodyBox},age:(ge=p.attributes)==null?void 0:ge.age,apparentAge:(ie=p.attributes)==null?void 0:ie.apparent_age,gender:(E=p.attributes)==null?void 0:E.gender,physical:B.height||B.build||B.face||B.eyeColor||B.hairColor||B.hairLength||B.hairStyle||B.hair||B.other?B:void 0,clothing:(X=p.attributes)!=null&&X.clothing||(V=p.attributes)!=null&&V.clothingStyle||(ee=p.attributes)!=null&&ee.clothingColors?{current:p.attributes.clothing,style:p.attributes.clothingStyle||p.attributes.clothingColors}:void 0,_debug:p._debug}}catch(p){return _.error("Photo analysis failed:",p),{success:!1,error:"unknown_error"}}},needsAvatars(e){var r,G,x,D;if(!!!((r=e.photos)!=null&&r.original||(G=e.photos)!=null&&G.face||(x=e.photos)!=null&&x.body||(D=e.photos)!=null&&D.bodyNoBg))return!1;const u=e.avatars;return u?u.status==="generating"||u.status==="pending"?!1:u.status==="failed"?!0:!!!(u.winter||u.standard||u.summer||u.formal||u.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(e,n,u){var r,G,x,D,U,re,Z,Y,M,T,ne,le,K,J,ce,ge,ie,E,X,V;const S={characterId:e.id,characterName:e.name,success:!1};try{let ee=!!((r=e.photos)!=null&&r.original||(G=e.photos)!=null&&G.face||(x=e.photos)!=null&&x.body||(D=e.photos)!=null&&D.bodyNoBg);if(!ee&&e.id){_.info(`ðŸ“¸ No photos in character object for ${e.name} (id: ${e.id}), loading full data...`);const oe=await he.loadFullCharacter(e.id);oe!=null&&oe.photos&&(e={...e,photos:oe.photos},ee=!!(oe.photos.original||oe.photos.face||oe.photos.body||oe.photos.bodyNoBg))}if(!ee)return S.skipped=!0,S.skipReason="No photo available",S;n==null||n("generating",`Generating avatars for ${e.name}...`),_.info(`ðŸŽ¨ Generating avatars for ${e.name} (id: ${e.id})${u!=null&&u.avatarModel?`, model: ${u.avatarModel}`:""}`);const p=await he.generateClothingAvatars(e,u);if(!p.success||!p.avatars)return S.error=p.error||"Avatar generation failed",n==null||n("error",S.error),S;S.avatars=p.avatars,S.extractedTraits=p.extractedTraits,S.extractedClothing=p.extractedClothing,n==null||n("saving",`Fetching updated data for ${e.name}...`);let B=null;const te=30;for(let oe=0;oe<te;oe++){if(oe>0){const de=Math.min(500*Math.pow(1.2,oe),3e3);_.info(`[AVATAR] Retry ${oe+1}/${te}: waiting ${Math.round(de)}ms for avatar data...`),await new Promise(se=>setTimeout(se,de))}if(B=await he.loadFullCharacter(e.id),(U=B==null?void 0:B.avatars)!=null&&U.standard||(re=B==null?void 0:B.avatars)!=null&&re.winter||(Z=B==null?void 0:B.avatars)!=null&&Z.summer){_.info(`[AVATAR] Got fresh data with avatars on attempt ${oe+1}`);break}}return B?(S.character=B,(Y=B.avatars)!=null&&Y.standard||(M=B.avatars)!=null&&M.winter||(T=B.avatars)!=null&&T.summer||_.warn(`âš ï¸ Fresh DB data for ${e.name} missing avatars after ${te} retries - server may not have saved them`),_.info(`ðŸ“‹ Using server-saved data for ${e.name}`)):(_.error(`âŒ Character ${e.name} (id: ${e.id}) not found in DB after avatar job - avatars lost!`),S.character={...e,avatars:{status:"failed"},physical:p.extractedTraits?{...e.physical,apparentAge:p.extractedTraits.apparentAge||((ne=e.physical)==null?void 0:ne.apparentAge),build:p.extractedTraits.build||((le=e.physical)==null?void 0:le.build),eyeColor:p.extractedTraits.eyeColor||((K=e.physical)==null?void 0:K.eyeColor),eyeColorHex:p.extractedTraits.eyeColorHex||((J=e.physical)==null?void 0:J.eyeColorHex),hairColor:p.extractedTraits.hairColor||((ce=e.physical)==null?void 0:ce.hairColor),hairColorHex:p.extractedTraits.hairColorHex||((ge=e.physical)==null?void 0:ge.hairColorHex),hairLength:p.extractedTraits.hairLength||((ie=e.physical)==null?void 0:ie.hairLength),hairStyle:p.extractedTraits.hairStyle||((E=e.physical)==null?void 0:E.hairStyle),skinTone:p.extractedTraits.skinTone||((X=e.physical)==null?void 0:X.skinTone),skinToneHex:p.extractedTraits.skinToneHex||((V=e.physical)==null?void 0:V.skinToneHex)}:e.physical,clothing:p.extractedClothing?{...e.clothing,structured:{upperBody:p.extractedClothing.upperBody||void 0,lowerBody:p.extractedClothing.lowerBody||void 0,shoes:p.extractedClothing.shoes||void 0,fullBody:p.extractedClothing.fullBody||void 0}}:e.clothing}),S.success=!0,n==null||n("complete",`Avatars saved for ${e.name}`),_.success(`âœ… Avatars generated and saved for ${e.name}`),S}catch(ee){return S.error=String(ee),n==null||n("error",S.error),_.error(`Failed to generate/save avatars for ${e.name}:`,ee),S}},async generateAvatarsForCharacters(e,n){const{forceRegenerate:u=!1,maxConcurrent:S=2,onProgress:r}=n||{};_.info("ðŸŽ¨ Starting batch avatar generation...");const G=await he.getCharacterData();let x;if(e&&e.length>0?x=G.characters.filter(M=>e.includes(M.id)):x=G.characters.filter(M=>{var T,ne;return u?!!((T=M.photos)!=null&&T.original||(ne=M.photos)!=null&&ne.face):he.needsAvatars(M)}),x.length===0)return _.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};_.info(`Processing ${x.length} characters for avatar generation`);const D=[],U=new Map;for(let M=0;M<x.length;M+=S){const ne=x.slice(M,M+S).map(async K=>{var ce,ge,ie,E,X;const J={characterId:K.id,characterName:K.name,success:!1};try{if(!u&&((ce=K.avatars)!=null&&ce.winter))return J.skipped=!0,J.skipReason="Avatars already exist",J;const V=await he.loadFullCharacter(K.id);if(!V)return J.error="Failed to load character data",J;if(!!!((ge=V.photos)!=null&&ge.original||(ie=V.photos)!=null&&ie.face||(E=V.photos)!=null&&E.body||(X=V.photos)!=null&&X.bodyNoBg))return J.skipped=!0,J.skipReason="No photo available",J;r==null||r(V.id,"generating",`Generating avatars for ${V.name}...`),_.info(`ðŸŽ¨ Generating avatars for ${V.name}...`);const p=await he.generateClothingAvatars(V);return!p.success||!p.avatars?(J.error=p.error||"Avatar generation failed",r==null||r(V.id,"error",J.error),J):(J.avatars=p.avatars,J.success=!0,U.set(V.id,{...V,avatars:p.avatars}),r==null||r(V.id,"complete",`Avatars generated for ${V.name}`),_.success(`âœ… Avatars generated for ${V.name}`),J)}catch(V){return J.error=String(V),r==null||r(K.id,"error",J.error),_.error(`Failed to generate avatars for ${K.name}:`,V),J}}),le=await Promise.all(ne);D.push(...le)}if(U.size>0){_.info(`ðŸ’¾ Saving ${U.size} character avatar updates...`);const M=await he.getCharacterData(),T=M.characters.map(ne=>U.get(ne.id)||ne);await he.saveCharacterData({...M,characters:T}),_.success(`ðŸ’¾ Saved character data for ${U.size} characters`)}const re=D.filter(M=>M.success).length,Z=D.filter(M=>!M.success&&!M.skipped).length,Y=D.filter(M=>M.skipped).length;return _.info(`Avatar generation complete: ${re} success, ${Z} failed, ${Y} skipped`),{results:D,successCount:re,failCount:Z,skipCount:Y}},async regenerateAvatarsForCharacter(e,n,u){_.info(`ðŸ”„ Regenerating avatars for character ${e}...`);const S=await he.loadFullCharacter(e);if(!S)return{characterId:e,characterName:"Unknown",success:!1,error:"Character not found"};const r={...S,avatars:{status:"pending"}};return he.generateAndSaveAvatarForCharacter(r,n?(G,x)=>n(G,x):void 0,u)}},wn={sm:"h-1",md:"h-2",lg:"h-3"},Mi={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function zi({value:e,max:n=100,label:u,showPercentage:S=!1,size:r="md",variant:G="gradient",className:x=""}){const D=Math.min(Math.max(e/n*100,0),100);return t.jsxs("div",{className:x,children:[(u||S)&&t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[u&&t.jsx("span",{className:"text-sm font-medium text-gray-700",children:u}),S&&t.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(D),"%"]})]}),t.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${wn[r]}`,children:t.jsx("div",{className:`${wn[r]} ${Mi[G]} rounded-full transition-all duration-500 ease-out`,style:{width:`${D}%`}})})]})}function _i({step:e,text:n}){const u=`wizard_helper_dismissed_${e}`,[S,r]=s.useState(()=>localStorage.getItem(u)==="true");s.useEffect(()=>{const x=localStorage.getItem(u)==="true";r(x)},[e,u]);const G=()=>{localStorage.setItem(u,"true"),r(!0)};return S?null:t.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[t.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:n}),t.jsx("button",{onClick:G,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:t.jsx(Rn,{size:16})})]})}function Li({current:e,total:n,message:u,isGenerating:S=!0,coverImages:r,jobId:G,onCancel:x,onMinimize:D,characters:U=[],isStalled:re=!1,onDismissStalled:Z,isImpersonating:Y=!1}){const{language:M}=qt(),{user:T}=jr(),ne=(T==null?void 0:T.role)==="admin"||Y,[le,K]=s.useState(!1),[J,ce]=s.useState(0),ge=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit fÃ¼r das grosse Abenteuer...",fr:"{name} se prÃ©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} Ã¼bt gerade die Heldenpose...",fr:"{name} s'entraÃ®ne Ã  prendre la pose du hÃ©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als NÃ¤chstes passiert!",fr:"{name} a hÃ¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} wÃ¤rmt sich fÃ¼r das bevorstehende Abenteuer auf...",fr:"{name} s'Ã©chauffe pour l'aventure Ã  venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir fÃ¼gen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au rÃ©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} flÃ¼stert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'Å“il au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne fÃ¼r die Geschichte...",fr:"{name} collectionne des Ã©toiles pour le rÃ©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],ie=s.useRef({}),[E,X]=s.useState(null),V=s.useMemo(()=>U.filter(ue=>{var P;const H=ue.avatars;return H&&(((P=H.faceThumbnails)==null?void 0:P.standard)||H.standard||H.summer||H.winter||H.formal||H.hasFullAvatars)}),[U]),ee=ue=>{var ve;const H=ue.avatars;if(!H)return"";if((ve=H.faceThumbnails)!=null&&ve.standard)return H.faceThumbnails.standard;const P=[];return H.standard&&P.push(H.standard),H.summer&&P.push(H.summer),H.winter&&P.push(H.winter),H.formal&&P.push(H.formal),P[Math.floor(Math.random()*P.length)]||""},p=s.useMemo(()=>{const ue=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(V.length===0)return ue;const H=[],P=Math.max(ue.length,V.length);for(let ve=0;ve<P;ve++)H.push(ue[ve%ue.length]),H.push({type:"character",char:V[ve%V.length]});return H},[V]);if(s.useEffect(()=>{if(p.length<=1)return;const ue=setInterval(()=>{ce(H=>(H+1)%p.length)},8e3);return()=>clearInterval(ue)},[p.length]),s.useEffect(()=>{if(p.length===0)return;const ue=p[J];if(ue.type==="character"){const H=ue.char,P=ee(H),$e=((ie.current[H.id]??-1)+1)%ge.length;ie.current[H.id]=$e;const Ce=ge[$e],ze=(M==="de"?Ce.de:M==="fr"?Ce.fr:Ce.en).replace("{name}",H.name);X({avatarUrl:P,message:ze})}else X(null)},[J,p,M]),!S||n===0)return null;const B=n===100?e:Math.round(e/n*100),te=ue=>ue==null?void 0:ue.imageData,oe=te(r==null?void 0:r.frontCover),de=te(r==null?void 0:r.initialPage),se=te(r==null?void 0:r.backCover),ke=!!oe,Me=!!de,Ae=!!se,Ne=ke||Me||Ae,Le={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollstÃ¤ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erhÃ¤ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz persÃ¶nliches Abenteuer gestalten.',tipLocations:'FÃ¼ge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu fÃ¼r eine persÃ¶nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? FÃ¼r BilderbÃ¼cher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint hÃ¤ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"CrÃ©ation de votre histoire!",timeInfo:"Votre rÃ©cit commencera Ã  s'afficher dans environ 1 minute. Le rÃ©cit complet peut prendre jusqu'Ã  10 minutes.",emailInfo:"Vous recevrez un email quand votre rÃ©cit sera prÃªt.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre rÃ©cit continuera Ã  Ãªtre gÃ©nÃ©rÃ©.",tipCharacters:"Mieux vous dÃ©crivez vos personnages, plus le rÃ©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du rÃ©cit" vous permet de crÃ©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits prÃ©fÃ©rÃ©s Ã  "Intrigue / Contexte du rÃ©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique prÃ©fÃ©rÃ© ? Pour les livres d'images, l'aquarelle fonctionne trÃ¨s bien !",coversPreview:"AperÃ§u des couvertures",frontCover:"Avant",initialPage:"IntÃ©rieur",backCover:"ArriÃ¨re",cancelJob:"Annuler la gÃ©nÃ©ration",cancelling:"Annulation...",stalled:"La gÃ©nÃ©ration semble bloquÃ©e",stalledDesc:"Aucun progrÃ¨s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer Ã  attendre",continueInBackground:"Continuer en arriÃ¨re-plan"}},me=Le[M]||Le.en,Re=({imageData:ue,label:H,isReady:P})=>t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${P?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:P&&ue?t.jsx("img",{src:ue,alt:H,className:"w-full h-full object-cover"}):t.jsx(ut,{size:20,className:"animate-spin text-gray-400"})}),t.jsxs("div",{className:"flex items-center gap-1",children:[P&&t.jsx(fn,{size:12,className:"text-green-500"}),t.jsx("span",{className:`text-xs ${P?"text-green-600 font-medium":"text-gray-400"}`,children:H})]})]});return t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${Ne?"max-w-lg":"max-w-md"}`,children:[t.jsxs("div",{className:"text-center mb-6",children:[t.jsxs("div",{className:"relative inline-block mb-3",children:[t.jsx(ut,{size:48,className:"animate-spin text-indigo-600"}),t.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"âœ¨"})]}),t.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:me.title})]}),!Ne&&p.length>0&&t.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const ue=p[J];if(ue.type==="character"&&E)return t.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[t.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:t.jsx("img",{src:E.avatarUrl,alt:ue.char.name,className:"w-full h-full object-contain"})}),t.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:E.message})]},`char-${ue.char.id}-${J}`);if(ue.type==="message"){const H=ue.key,P=me[H]||"",ve=H==="timeInfo"?t.jsx(Ci,{size:20,className:"text-indigo-500 shrink-0"}):H==="emailInfo"?t.jsx(En,{size:20,className:"text-indigo-500 shrink-0"}):t.jsx(fn,{size:20,className:"text-indigo-500 shrink-0"});return t.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[ve,t.jsx("p",{className:"text-sm text-gray-700",children:P})]})}return null})()}),Ne&&t.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[t.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:me.coversPreview}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(Re,{imageData:oe,label:me.frontCover,isReady:ke}),t.jsx(Re,{imageData:de,label:me.initialPage,isReady:Me}),t.jsx(Re,{imageData:se,label:me.backCover,isReady:Ae})]})]}),Ne&&t.jsxs("div",{className:"mb-4 text-center",children:[t.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[t.jsx(ut,{size:14,className:"animate-spin text-indigo-500"}),M==="de"?"Bilder fÃ¼r die Seiten werden jetzt erstellt...":M==="fr"?"CrÃ©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:M==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":M==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),t.jsx("div",{className:"mb-4",children:t.jsx(zi,{value:B,max:100,showPercentage:!0,size:"lg"})}),D&&t.jsx("button",{onClick:D,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:me.continueInBackground}),re&&t.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(fi,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:me.stalled}),t.jsx("p",{className:"text-sm text-amber-700 mb-3",children:me.stalledDesc}),t.jsxs("div",{className:"flex gap-2",children:[Z&&t.jsx("button",{onClick:Z,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:me.continueWaiting}),x&&t.jsx("button",{onClick:()=>{if(!le){K(!0);try{x()}finally{K(!1)}}},disabled:le,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:le?me.cancelling:me.cancelJob})]})]})]})}),ne&&G&&x&&t.jsxs("button",{onClick:async()=>{if(!le){K(!0);try{x()}finally{K(!1)}}},disabled:le,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[le?t.jsx(ut,{size:16,className:"animate-spin"}):t.jsx(wi,{size:16}),le?me.cancelling:me.cancelJob]})]})})}const Ra={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.6 - Best narrative quality",descriptionDe:"Claude Sonnet 4.6 - Beste ErzÃ¤hlqualitÃ¤t",descriptionFr:"Claude Sonnet 4.6 - Meilleure qualitÃ© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 4.5 - Fast and affordable",descriptionDe:"Claude Haiku 4.5 - Schnell und gÃ¼nstig",descriptionFr:"Claude Haiku 4.5 - Rapide et Ã©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe QualitÃ¤t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualitÃ©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - TrÃ¨s rapide"}},Cn={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide de scÃ¨nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra gÃ¼nstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra Ã©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere QualitÃ¤t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualitÃ© ($0.004/image)"}},Hi={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - Ã‰valuation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - GrÃ¼ndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},Vi={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste QualitÃ¤t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualitÃ© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra gÃ¼nstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra Ã©conomique pour tests ($0.0006/image)"}},Wi={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - GÃ¼nstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars Ã©conomiques avec visage cohÃ©rent (~$0.005)"}};function dt({label:e,icon:n,value:u,options:S,onChange:r,language:G}){const x=D=>G==="de"&&D.descriptionDe?D.descriptionDe:G==="fr"&&D.descriptionFr?D.descriptionFr:D.description;return t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[n,e]}),t.jsxs("div",{className:"relative",children:[t.jsxs("select",{value:u||"",onChange:D=>r(D.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[t.jsx("option",{value:"",children:G==="de"?"Server-Standard":G==="fr"?"Par dÃ©faut serveur":"Server Default"}),Object.entries(S).map(([D,U])=>t.jsxs("option",{value:D,children:[D," ",U.provider?`(${U.provider})`:""]},D))]}),t.jsx(Gn,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),u&&S[u]&&t.jsx("p",{className:"text-[10px] text-gray-500 italic",children:x(S[u])})]})}function Oi({selections:e,onChange:n}){const{language:u}=qt(),S=(r,G)=>{n({...e,[r]:G})};return t.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[t.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[t.jsx(Pi,{size:16}),u==="de"?"AI-Modell Auswahl (Dev)":u==="fr"?"SÃ©lection de modÃ¨le IA (Dev)":"AI Model Selection (Dev)"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[t.jsx(dt,{label:u==="de"?"Ideen-Modell":u==="fr"?"ModÃ¨le d'idÃ©es":"Idea Model",icon:t.jsx(Ii,{size:12}),value:e.ideaModel,options:Ra,onChange:r=>S("ideaModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Geschichte (Kombiniert)":u==="fr"?"Histoire (CombinÃ©)":"Story (Combined)",icon:t.jsx(Ot,{size:12}),value:e.outlineModel,options:Ra,onChange:r=>S("outlineModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Text-Modell":u==="fr"?"ModÃ¨le de texte":"Text Model",icon:t.jsx(Ot,{size:12}),value:e.textModel,options:Ra,onChange:r=>S("textModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Szenen-Modell":u==="fr"?"ModÃ¨le de scÃ¨ne":"Scene Description Model",icon:t.jsx(Ai,{size:12}),value:e.sceneDescriptionModel,options:Ra,onChange:r=>S("sceneDescriptionModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Bild-Modell":u==="fr"?"ModÃ¨le d'image":"Image Model",icon:t.jsx(xn,{size:12}),value:e.imageModel,options:Cn,onChange:r=>S("imageModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Cover-Modell":u==="fr"?"ModÃ¨le de couverture":"Cover Image Model",icon:t.jsx(Ei,{size:12}),value:e.coverImageModel,options:Cn,onChange:r=>S("coverImageModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Bewertungs-Modell":u==="fr"?"ModÃ¨le d'Ã©valuation":"Quality Eval Model",icon:t.jsx(pi,{size:12}),value:e.qualityModel,options:Hi,onChange:r=>S("qualityModel",r),language:u}),t.jsx(dt,{label:u==="de"?"Bild-Reparatur":u==="fr"?"RÃ©paration d'image":"Image Repair",icon:t.jsx(Ri,{size:12}),value:e.imageBackend,options:Vi,onChange:r=>S("imageBackend",r),language:u}),t.jsx(dt,{label:u==="de"?"Avatar-Modell":u==="fr"?"ModÃ¨le d'avatar":"Avatar Model",icon:t.jsx(xn,{size:12}),value:e.avatarModel,options:Wi,onChange:r=>S("avatarModel",r),language:u})]}),t.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:u==="de"?'Hinweis: Nur sichtbar fÃ¼r Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':u==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode dÃ©veloppeur. "Par dÃ©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}const jn=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"FranÃ§ais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],Ea={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"SÃ¼ddeutsch"},{code:"de-at",name:"Ã–sterreich"},{code:"de-it",name:"SÃ¼dtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"QuÃ©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"ZÃ¼ritÃ¼Ã¼tsch"},{code:"gsw-be",name:"BÃ¤rndÃ¼tsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"LuzÃ¤rndÃ¼tsch"},{code:"gsw-sg",name:"SanggallerdÃ¼tsch"},{code:"gsw-vs",name:"WalliserdÃ¼tsch"},{code:"gsw-gr",name:"BÃ¼ndnerdÃ¼tsch"}]};function wr(e){return e.startsWith("gsw")?"gsw":e.startsWith("de")?"de":e.startsWith("fr")?"fr":e.startsWith("it")?"it":"en"}const qi=["spring","summer","autumn","winter"];function Fn(){const e=new Date().getMonth();return e>=2&&e<=4?"spring":e>=5&&e<=7?"summer":e>=8&&e<=10?"autumn":"winter"}function Ui({languageLevel:e,onLanguageLevelChange:n,pages:u,onPagesChange:S,storyLanguage:r,onStoryLanguageChange:G,developerMode:x,userLocation:D,onLocationChange:U,season:re,onSeasonChange:Z,userCredits:Y}){const{t:M,language:T}=qt(),[ne,le]=s.useState(!1),[K,J]=s.useState((D==null?void 0:D.city)||""),[ce,ge]=s.useState((D==null?void 0:D.country)||""),[ie,E]=s.useState(!1),X=s.useRef(null);s.useEffect(()=>{const P=ve=>{X.current&&!X.current.contains(ve.target)&&E(!1)};return document.addEventListener("mousedown",P),()=>document.removeEventListener("mousedown",P)},[]);const V=s.useCallback(()=>{const P=wr(r),ve=jn.find(Ce=>Ce.family===P),$e=Ea[P].find(Ce=>Ce.code===r)||Ea[P][0];return ve&&$e?`${ve.name} (${$e.name})`:(ve==null?void 0:ve.name)||r},[r]);s.useEffect(()=>{D&&(J(D.city||""),ge(D.country||""))},[D]);const ee=()=>{U({city:K||null,region:null,country:ce||null}),le(!1)},p={spring:{de:"FrÃ¼hling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"Ã‰tÃ©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},B=x?4:10,te=50,oe=2,de=10,se=Y===-1,ke=se?te:Math.floor(Y/de),Me=Math.floor(ke/2)*2,Ae=B*de,Ne=!se&&Y<Ae,Le=Ae-Y,me=Ne?B:Math.min(te,Math.max(B,Me)),Re=!se&&Me<te;s.useEffect(()=>{let P=u;P%2!==0&&(P=Math.round(P/2)*2),P=Math.max(B,Math.min(me,P)),P!==u&&S(P)},[u,B,me,S]);const ue=[{value:"1st-grade",label:M.firstGrade,desc:M.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:M.standard,desc:M.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:M.advanced,desc:M.advancedDesc,image:"/images/dense text left.jpg"}],H=(P,ve=!1)=>{const $e=ve?" (Test)":"",Ce=P*10,We=T==="de"?"Credits":T==="fr"?"crÃ©dits":"credits";if(e==="1st-grade")return`${P} ${T==="de"?"Seiten":"pages"} = ${Ce} ${We}${$e}`;const ze=Math.floor(P/2),xt=Math.floor(P/2);return T==="de"?`${P} Seiten (${ze} Text + ${xt} Bilder) = ${Ce} ${We}${$e}`:T==="fr"?`${P} pages (${ze} texte + ${xt} images) = ${Ce} ${We}${$e}`:`${P} pages (${ze} text + ${xt} images) = ${Ce} ${We}${$e}`};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[t.jsx(Ni,{size:24}),T==="de"?"Buchformat":T==="fr"?"Format du livre":"Book Format"]}),t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:T==="de"?"Sprache:":T==="fr"?"Langue:":"Language:"}),t.jsxs("div",{className:"relative",ref:X,children:[t.jsxs("button",{type:"button",onClick:()=>E(!ie),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[V(),t.jsx(Gn,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${ie?"rotate-180":""}`})]}),ie&&t.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[jn.map(P=>{const ve=wr(r)===P.family;return t.jsx("button",{type:"button",onClick:()=>{const $e=Ea[P.family][0];G($e.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${ve?"font-semibold text-indigo-600":"text-gray-700"}`,children:P.name},P.family)}),t.jsx("div",{className:"border-t border-gray-300 my-1"}),Ea[wr(r)].map(P=>t.jsx("button",{type:"button",onClick:()=>{G(P.code),E(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${r===P.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:P.name},P.code))]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Di,{className:"text-gray-500",size:16}),t.jsx("span",{className:"text-sm text-gray-600",children:T==="de"?"Ort:":T==="fr"?"Lieu:":"Location:"}),ne?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("input",{type:"text",value:K,onChange:P=>J(P.target.value),placeholder:T==="de"?"Stadt":T==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),t.jsx("input",{type:"text",value:ce,onChange:P=>ge(P.target.value),placeholder:T==="de"?"Land":T==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),t.jsx("button",{onClick:ee,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),t.jsx("button",{onClick:()=>le(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"âœ•"})]}):t.jsx("button",{onClick:()=>le(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:D!=null&&D.city?`${D.city}${D.country?`, ${D.country}`:""}`:T==="de"?"Festlegen":T==="fr"?"DÃ©finir":"Set"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:T==="de"?"Jahreszeit:":T==="fr"?"Saison:":"Season:"}),t.jsxs("div",{className:"relative",children:[t.jsx("select",{value:re,onChange:P=>Z(P.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:qi.map(P=>t.jsx("option",{value:P,children:p[P][T]||p[P].en},P))}),t.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:t.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xl font-semibold mb-3",children:M.readingLevel}),t.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:ue.map(P=>t.jsxs("button",{onClick:()=>n(P.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${e===P.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[t.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:t.jsx("img",{src:P.image,alt:P.label,className:"w-full h-full object-contain"})}),t.jsxs("div",{className:"p-2 md:p-2.5",children:[t.jsx("div",{className:"font-semibold text-sm mb-0.5",children:P.label}),t.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:P.desc})]})]},P.value))})]}),e&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-xl font-semibold mb-3",children:M.numberOfPages}),Ne?t.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[t.jsx("p",{className:"text-red-700 font-semibold mb-2",children:T==="de"?"Nicht genÃ¼gend Credits":T==="fr"?"CrÃ©dits insuffisants":"Not enough credits"}),t.jsx("p",{className:"text-red-600 text-sm",children:T==="de"?`Du benÃ¶tigst mindestens ${Ae} Credits fÃ¼r eine Geschichte mit ${B} Seiten. Dir fehlen noch ${Le} Credits.`:T==="fr"?`Vous avez besoin d'au moins ${Ae} crÃ©dits pour une histoire de ${B} pages. Il vous manque ${Le} crÃ©dits.`:`You need at least ${Ae} credits for a ${B}-page story. You need ${Le} more credits.`}),t.jsx("p",{className:"text-gray-500 text-xs mt-2",children:T==="de"?`Aktuell: ${Y} Credits`:T==="fr"?`Actuel: ${Y} crÃ©dits`:`Current: ${Y} credits`})]}):t.jsxs("div",{className:"space-y-3",children:[t.jsx("input",{type:"range",min:B,max:me,step:oe,value:Math.min(u,me),onChange:P=>S(parseInt(P.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-sm text-gray-400",children:B}),t.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[u," ",T==="de"?"Seiten":"pages"]}),t.jsxs("span",{className:`text-sm ${Re?"text-orange-500 font-medium":"text-gray-400"}`,children:[me,Re&&" âš ï¸"]})]}),Re&&t.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:T==="de"?`Max. ${me} Seiten mit ${Y} Credits mÃ¶glich`:T==="fr"?`Max. ${me} pages possibles avec ${Y} crÃ©dits`:`Max. ${me} pages possible with ${Y} credits`}),t.jsxs("div",{className:"text-center",children:[t.jsx("p",{className:"text-base font-medium text-gray-700",children:H(u,u===4)}),t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:e==="1st-grade"?T==="de"?"Jede Seite enthÃ¤lt ein Bild mit Text darunter":T==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":T==="de"?"Abwechselnd Textseite und Bildseite":T==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const Ki=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:Ui,getCurrentSeason:Fn},Symbol.toStringTag,{value:"Module"})),kn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail prÃ¼fen",description:"Wir haben Ihnen einen BestÃ¤tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail bestÃ¤tigen!",currentEmail:"BestÃ¤tigung gesendet an",sendVerification:"BestÃ¤tigungs-E-Mail senden",resendVerification:"BestÃ¤tigungs-E-Mail erneut senden",emailSent:"BestÃ¤tigungs-E-Mail gesendet! Bitte prÃ¼fen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? Ã„ndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"Ã„ndern & BestÃ¤tigen",cancel:"Abbrechen",emailChanged:"E-Mail geÃ¤ndert! Bitte prÃ¼fen Sie Ihren neuen Posteingang fÃ¼r die BestÃ¤tigung.",checkSpam:"Nicht gefunden? PrÃ¼fen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausfÃ¼llen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function Ji({isOpen:e,onClose:n,onVerified:u}){const{language:S}=qt(),{user:r,refreshUser:G}=jr(),x=kn[S]||kn.en,[D,U]=s.useState("verify"),[re,Z]=s.useState(!1),[Y,M]=s.useState(!1),[T,ne]=s.useState(""),[le,K]=s.useState(""),[J,ce]=s.useState(!1),[ge,ie]=s.useState(0),[E,X]=s.useState(""),[V,ee]=s.useState(""),p=s.useRef(null),B=s.useRef(null),te=s.useRef(!1);if(s.useEffect(()=>(ge>0&&(B.current=setTimeout(()=>{ie(se=>se-1)},1e3)),()=>{B.current&&clearTimeout(B.current)}),[ge]),s.useEffect(()=>{if(e&&!te.current&&!Y){te.current=!0;const se=setTimeout(async()=>{Z(!0);try{const ke=await Pe.post("/api/auth/send-verification",{});M(!0),K(x.emailSent),ke.cooldown&&ie(ke.cooldown)}catch(ke){const Me=ke;Me.retryAfter?(ie(Me.retryAfter),M(!0)):ne(Me.message||"Failed to send verification email")}finally{Z(!1)}},300);return()=>clearTimeout(se)}e||(te.current=!1)},[e,Y,x.emailSent]),s.useEffect(()=>{if(!e){p.current&&(clearInterval(p.current),p.current=null);return}return ce(!0),console.log("[EmailVerificationModal] Starting polling"),p.current=setInterval(async()=>{try{const se=await Pe.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",se.emailVerified),se.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await G(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),p.current&&(clearInterval(p.current),p.current=null),ce(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),u==null||u(),console.log("[EmailVerificationModal] Calling onClose"),n())}catch(se){console.debug("Verification status poll error:",se)}},3e3),()=>{p.current&&(clearInterval(p.current),p.current=null)}},[e,G,u,n]),!e)return null;const oe=async()=>{Z(!0),ne("");try{const se=await Pe.post("/api/auth/send-verification",{});M(!0),K(x.emailSent),se.cooldown&&ie(se.cooldown)}catch(se){const ke=se;ke.retryAfter?(ie(ke.retryAfter),ne(S==="de"?`Bitte warten Sie ${ke.retryAfter} Sekunden`:S==="fr"?`Veuillez patienter ${ke.retryAfter} secondes`:`Please wait ${ke.retryAfter} seconds`)):ne(ke.message||"Failed to send verification email")}finally{Z(!1)}},de=async()=>{if(!E||!V){ne(x.fillAllFields);return}Z(!0),ne("");try{await Pe.post("/api/auth/change-email",{newEmail:E,password:V}),K(x.emailChanged),U("verify"),X(""),ee("")}catch(se){ne(se instanceof Error?se.message:"Failed to change email")}finally{Z(!1)}};return t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[t.jsx("button",{onClick:n,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:t.jsx(Rn,{size:20})}),t.jsxs("div",{className:"text-center mb-6",children:[t.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx(En,{className:"w-8 h-8 text-indigo-600"})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:x.title}),t.jsx("p",{className:"text-gray-500",children:x.description})]}),T&&t.jsx(vn,{variant:"error",className:"mb-4",children:T}),le&&t.jsxs(vn,{variant:"success",className:"mb-4",children:[le,t.jsx("p",{className:"text-sm mt-1 opacity-80",children:x.checkSpam})]}),J&&Y&&t.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[t.jsx(ut,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:S==="de"?"Warte auf BestÃ¤tigung...":S==="fr"?"En attente de verification...":"Waiting for verification..."})]}),D==="verify"?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("p",{className:"text-sm text-gray-500 mb-1",children:x.currentEmail}),t.jsx("p",{className:"font-medium text-gray-800",children:r==null?void 0:r.email})]}),t.jsxs(Ga,{onClick:oe,variant:"primary",loading:re,disabled:ge>0,className:"w-full",children:[t.jsx(ji,{size:16,className:"mr-2"}),ge>0?`${S==="de"?"Warten":S==="fr"?"Patienter":"Wait"} ${ge}s`:Y?x.resendVerification:x.sendVerification]}),t.jsxs("button",{onClick:()=>{U("change"),ne(""),K("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[t.jsx($i,{size:16}),x.changeEmail]})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsx(yn,{type:"email",label:x.newEmail,value:E,onChange:se=>X(se.target.value),placeholder:"your@newemail.com",disabled:re}),t.jsx(yn,{type:"password",label:x.currentPassword,value:V,onChange:se=>ee(se.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:re}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(Ga,{onClick:()=>{U("verify"),ne(""),X(""),ee("")},variant:"secondary",className:"flex-1",disabled:re,children:x.cancel}),t.jsx(Ga,{onClick:de,variant:"primary",loading:re,className:"flex-1",children:x.confirmChange})]})]})]})})}const kr=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "},inverse:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"},inverse:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"},inverse:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function Qi(e){const n=kr.find(u=>u.value.en==="Not Known to");return n?n.value[e]:"Not Known to"}function An(e){const n=kr.find(u=>u.value.en==="Not Known to");return n?e===n.value.en||e===n.value.de||e===n.value.fr:!1}function Zi(e,n,u=[]){for(const S of kr)if(S.value[n]===e)return S.inverse[n];for(const S of u){if(S.forward===e)return S.inverse;if(S.inverse===e)return S.forward}return e}const Yi=1440*60*1e3;function Ba(e){const n=`avatar_regen_${e}`,u=localStorage.getItem(n),S=Date.now();if(!u)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:r,lastAttempt:G}=JSON.parse(u);if(S-G>Yi)return localStorage.removeItem(n),{canRegenerate:!0,waitSeconds:0,attempts:0};let x=0;r>=2&&r<4?x=30*1e3:r>=4&&r<6?x=60*1e3:r>=6&&r<8?x=120*1e3:r>=8&&r<10?x=300*1e3:r>=10&&(x=600*1e3);const D=S-G;return D>=x?{canRegenerate:!0,waitSeconds:0,attempts:r}:{canRegenerate:!1,waitSeconds:Math.ceil((x-D)/1e3),attempts:r}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function Mn(e){const n=`avatar_regen_${e}`,u=localStorage.getItem(n),S=Date.now();let r=1;if(u)try{r=(JSON.parse(u).attempts||0)+1}catch{}localStorage.setItem(n,JSON.stringify({attempts:r,lastAttempt:S}))}function To(e){const[n,u]=s.useState(()=>Ba(e));s.useEffect(()=>{if(n.waitSeconds>0){const r=setInterval(()=>{u(Ba(e))},1e3);return()=>clearInterval(r)}},[n.waitSeconds,e]);const S=s.useCallback(()=>{Mn(e),u(Ba(e))},[e]);return{...n,recordRegeneration:S}}const Nn={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte wÃ¤hlen Sie aus, welches Gesicht zu dem Charakter gehÃ¶rt, den Sie erstellen mÃ¶chten.",selectFace:"Gesicht auswÃ¤hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages dÃ©tectÃ©s",description:"Nous avons dÃ©tectÃ© plusieurs personnes sur votre photo. Veuillez sÃ©lectionner le visage du personnage que vous souhaitez crÃ©er.",selectFace:"SÃ©lectionner le visage",uploadDifferent:"TÃ©lÃ©charger une autre photo",confidence:"Confiance"}};function Xi({isOpen:e,faces:n,onSelect:u,onUploadNew:S,developerMode:r=!1}){const{language:G}=qt(),x=Nn[G]||Nn.en;return t.jsx(ki,{isOpen:e,onClose:S,title:x.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("p",{className:"text-gray-600 text-center",children:x.description}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:n.map((D,U)=>t.jsxs("button",{onClick:()=>u(D.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[t.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:t.jsx("img",{draggable:!1,src:D.thumbnail,alt:`Face ${U+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),t.jsx("div",{className:"text-center",children:t.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[x.selectFace," ",U+1]})}),r&&t.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[x.confidence,": ",Math.round(D.confidence*100),"%"]})]},D.id))}),t.jsx("div",{className:"pt-4 border-t border-gray-100",children:t.jsxs("button",{onClick:S,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[t.jsx(Gi,{size:20}),x.uploadDifferent]})})]})})}const Po=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et quÃªtes hÃ©roÃ¯ques"},emoji:"ðŸ—¡ï¸"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"CompÃ©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei alltÃ¤glichen Herausforderungen",fr:"Aide pour surmonter les dÃ©fis quotidiens"},emoji:"ðŸ’ª"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"ðŸ“š"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais Ã©vÃ©nements historiques"},emoji:"ðŸ›ï¸"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"DÃ©cris ta propre idÃ©e d'histoire"},emoji:"âœ¨"}],eo=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],Io=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"Ã‰poques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"HÃ©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"PersonnalisÃ©"}}],Cr=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"ðŸ´â€â˜ ï¸",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"âš”ï¸",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ðŸ¤ ",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ðŸ¥·",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"âš“",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"ðŸ›ï¸",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes Ã„gypten",fr:"Ã‰gypte Ancienne"},emoji:"ðŸº",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"GrÃ¨ce Antique"},emoji:"ðŸº",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"Ã‚ge de Pierre"},emoji:"ðŸ¦´",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure SamouraÃ¯"},emoji:"ðŸŽŒ",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & SorciÃ¨re"},emoji:"ðŸ§™",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"QuÃªte du Dragon"},emoji:"ðŸ‰",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ðŸ¦„",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de SirÃ¨ne"},emoji:"ðŸ§œâ€â™€ï¸",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ðŸ¦–",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-hÃ©ros"},emoji:"ðŸ¦¸",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"ðŸš€",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des OcÃ©ans"},emoji:"ðŸŒŠ",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"ðŸŒ´",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie Ã  la Ferme"},emoji:"ðŸ„",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la ForÃªt"},emoji:"ðŸ¦Š",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"ðŸš’",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"ðŸ‘¨â€âš•ï¸",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"ðŸ‘®",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"MystÃ¨re DÃ©tective"},emoji:"ðŸ”",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de NoÃ«l"},emoji:"ðŸŽ„",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"ðŸŽ†",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de PÃ¢ques"},emoji:"ðŸ°",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"ðŸŽƒ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},emoji:"âœ¨",group:"custom"}],Do={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"ðŸ "},Tn=[{id:"potty-training",name:{en:"Potty Training",de:"TÃ¶pfchen-Training",fr:"Apprentissage du pot"},emoji:"ðŸš½",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"HÃ¤nde waschen",fr:"Se laver les mains"},emoji:"ðŸ§¼",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"ZÃ¤hne putzen",fr:"Se brosser les dents"},emoji:"ðŸª¥",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"GemÃ¼se essen",fr:"Manger des lÃ©gumes"},emoji:"ðŸ¥¦",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"ðŸ›ï¸",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"ðŸ‘‹",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de tÃ©tine"},emoji:"ðŸ¼",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"AufrÃ¤umen",fr:"Ranger les jouets"},emoji:"ðŸ§¹",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ðŸª‘",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre Ã  partager"},emoji:"ðŸ¤",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten kÃ¶nnen",fr:"Attendre son tour"},emoji:"â³",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"ðŸŽ’",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"ðŸ‘«",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"ÃŠtre courageux"},emoji:"ðŸ’ª",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau bÃ©bÃ© dans la famille"},emoji:"ðŸ‘¶",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'Ã©cole"},emoji:"ðŸ«",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"ðŸ“",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre Ã  lire"},emoji:"ðŸ“–",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren kÃ¶nnen",fr:"Savoir perdre"},emoji:"ðŸŽ¯",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"ÃŠtre diffÃ©rent c'est bien"},emoji:"ðŸŒˆ",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit HÃ¤nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"ðŸ›¡ï¸",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la vÃ©ritÃ©"},emoji:"âœ…",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"ðŸŒŸ",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"DÃ©mÃ©nagement"},emoji:"ðŸ ",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"âœˆï¸",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents sÃ©parÃ©s"},emoji:"ðŸ’”",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le mÃ©decin"},emoji:"ðŸ¥",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"SÃ©jour Ã  l'hÃ´pital"},emoji:"ðŸ©º",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"ðŸŒˆ",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"â¤ï¸",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"Ã‰conomiser de l'argent"},emoji:"ðŸ’°",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"DÃ©penser intelligemment"},emoji:"ðŸ›’",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"Ã‰quilibre du temps d'Ã©cran"},emoji:"ðŸ“±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"ðŸ‘¥",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"KÃ¶rperliche VerÃ¤nderungen",fr:"Changements corporels"},emoji:"ðŸŒ±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung Ã¼bernehmen",fr:"Prendre ses responsabilitÃ©s"},emoji:"ðŸŽ¯",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"â°",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"SÃ©curitÃ© en ligne"},emoji:"ðŸ”’",ageGroup:"preteen"}],to=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],$o=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-VerÃ¤nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"PrÃ©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"Ã‰cole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"VorpubertÃ¤t (9-12)",fr:"PrÃ©adolescent (9-12)"},ageRange:"9-12"}],Pn=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"ðŸ”¤",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"ðŸ…°ï¸",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"ReimwÃ¶rter",fr:"Mots qui riment"},emoji:"ðŸŽµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"ðŸ”¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"ðŸ”¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"ZÃ¤hlen lernen",fr:"Apprendre Ã  compter"},emoji:"âœ‹",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"ðŸ”·",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"âž•",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"ðŸŒˆ",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"MÃ©langer les couleurs"},emoji:"ðŸŽ¨",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"PlanÃ¨tes & Espace"},emoji:"ðŸª",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"ðŸ‚",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"MÃ©tÃ©o"},emoji:"â›…",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"ðŸ’§",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"ðŸŒ±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"ðŸŒ™",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"ðŸ·",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ðŸ¦",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"ðŸ‹",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & KÃ¤fer",fr:"Insectes"},emoji:"ðŸ›",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ðŸ¦•",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"KÃ¶rperteile",fr:"Parties du corps"},emoji:"ðŸ«€",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die fÃ¼nf Sinne",fr:"Les cinq sens"},emoji:"ðŸ‘ï¸",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ðŸ¥—",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"ðŸ“…",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'annÃ©e"},emoji:"ðŸ—“ï¸",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"ðŸ•",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"ðŸŒ",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"LÃ¤nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"ðŸ³ï¸",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"ðŸŽ¸",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"BerÃ¼hmte KÃ¼nstler",fr:"Artistes cÃ©lÃ¨bres"},emoji:"ðŸ–¼ï¸",group:"arts"}],ao=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],Ro=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"KÃ¶rper & Gesundheit",fr:"Corps & SantÃ©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & GÃ©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],ro=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],Eo=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"â­"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"ðŸ‡¨ðŸ‡­"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & DÃ©couverte"},icon:"ðŸ§­"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & MÃ©decine"},icon:"ðŸ”¬"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"ðŸ’¡"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & LibertÃ©"},icon:"âœŠ"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"ðŸ—ï¸"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"ðŸŽ­"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"ArchÃ¤ologische Entdeckungen",fr:"DÃ©couvertes ArchÃ©ologiques"},icon:"ðŸº"}],In=[{id:"swiss-founding",name:{en:"Founding of Switzerland (RÃ¼tlischwur)",de:"GrÃ¼ndung der Schweiz (RÃ¼tlischwur)",fr:"Fondation de la Suisse (Serment du GrÃ¼tli)"},shortName:{en:"RÃ¼tlischwur",de:"RÃ¼tlischwur",fr:"Serment du GrÃ¼tli"},emoji:"ðŸ¤",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"ðŸ¹",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"âš”ï¸",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"ðŸ›¡ï¸",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"RÃ©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"RÃ©forme"},emoji:"ðŸ“œ",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant grÃ¼ndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"â¤ï¸",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"GÃ©nÃ©ral Dufour et l'unitÃ© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"GÃ©nÃ©ral Dufour"},emoji:"ðŸŽ–ï¸",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"ðŸ”ï¸",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution fÃ©dÃ©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"ðŸ“‹",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"ðŸš‚",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer NeutralitÃ¤t im 1. Weltkrieg",fr:"NeutralitÃ© suisse pendant la PremiÃ¨re Guerre"},shortName:{en:"WWI Neutrality",de:"NeutralitÃ¤t 1. WK",fr:"NeutralitÃ© 1GM"},emoji:"ðŸ•Šï¸",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the RÃ¼tli Report",de:"General Guisan und der RÃ¼tlirapport",fr:"GÃ©nÃ©ral Guisan et le Rapport du GrÃ¼tli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"GÃ©nÃ©ral Guisan"},emoji:"ðŸŽ–ï¸",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2Ã¨me GM"},emoji:"ðŸ”ï¸",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"ðŸŒ™",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les AmÃ©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"DÃ©couverte de l'AmÃ©rique"},emoji:"â›µ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motorisÃ©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"âœˆï¸",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"PremiÃ¨re traversÃ©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"ðŸ›©ï¸",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"ðŸ”ï¸",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am SÃ¼dpol",fr:"Premier au PÃ´le Sud"},shortName:{en:"South Pole",de:"SÃ¼dpol",fr:"PÃ´le Sud"},emoji:"â„ï¸",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"ðŸŒ",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"PlongÃ©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"PlongÃ©e profonde"},emoji:"ðŸŒŠ",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"ExpÃ©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"ElektrizitÃ¤t entdeckt",fr:"DÃ©couverte Ã©lectricitÃ©"},emoji:"âš¡",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"DÃ©couverte de la pÃ©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"PÃ©nicilline"},emoji:"ðŸ’Š",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"ðŸ’‰",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN dÃ©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"DÃ©couverte ADN"},emoji:"ðŸ§¬",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nommÃ©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"DÃ©couverte dinosaure"},emoji:"ðŸ¦•",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins RelativitÃ¤tstheorie",fr:"RelativitÃ© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"ThÃ©orie d'Einstein"},emoji:"ðŸ§ ",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits GalÃ¡pagos",de:"Darwin auf GalÃ¡pagos",fr:"Darwin aux GalÃ¡pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"ðŸ¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"PremiÃ¨re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"â¤ï¸",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschlÃ¼sselt",fr:"GÃ©nome humain dÃ©codÃ©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet GÃ©nome"},emoji:"ðŸ§ª",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement tÃ©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"TÃ©lescope Hubble"},emoji:"ðŸ”­",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel tÃ©lÃ©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"TÃ©lÃ©phone"},emoji:"ðŸ“ž",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons GlÃ¼hbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"GlÃ¼hbirne",fr:"Ampoule"},emoji:"ðŸ’¡",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"ðŸ“–",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"ðŸŒ",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"â›“ï¸",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"ðŸšŒ",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"ðŸ§±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela libÃ©rÃ©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"âœŠ",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"ðŸ”º",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm erÃ¶ffnet",fr:"Tour Eiffel inaugurÃ©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"ðŸ—¼",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal erÃ¶ffnet",fr:"Canal de Panama inaugurÃ©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"ðŸš¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"ðŸŒ‰",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel erÃ¶ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"ðŸš‡",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"ðŸ…",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland erÃ¶ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"ðŸ°",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cinÃ©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"ðŸŽ¬",year:1895,category:"culture",mainPerson:"LumiÃ¨re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ðŸ¦",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"MusÃ©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"MusÃ©e Histoire Naturelle"},emoji:"ðŸ›ï¸",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de ToutÃ¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"ToutÃ¢nkhamon"},emoji:"ðŸ‘‘",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"RedÃ©couverte de PompÃ©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"PompÃ©i"},emoji:"ðŸŒ‹",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"ArmÃ©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"ArmÃ©e terre cuite"},emoji:"ðŸ—¿",year:1974,category:"archaeology"}];function Go(e){return e==="popular"?Cr.filter(n=>eo.includes(n.id)):Cr.filter(n=>n.group===e)}function Bo(e){return e==="popular"?Tn.filter(n=>to.includes(n.id)):Tn.filter(n=>n.ageGroup===e)}function Fo(e){return e==="popular"?Pn.filter(n=>ao.includes(n.id)):Pn.filter(n=>n.group===e)}function Mo(e){return e==="popular"?In.filter(n=>ro.includes(n.id)):In.filter(n=>n.category===e)}const no={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},Ye={enableQualityRetry:!1,enableAutoRepair:!1,enableFinalChecks:!1,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null,enableSceneValidation:!1,separatedEvaluation:!1,enableFullRepairAfterGeneration:!1};function so(){const e=localStorage.getItem("developer_mode")==="true",[n,u]=s.useState(e),[S,r]=s.useState(null),[G,x]=s.useState("auto"),[D,U]=s.useState(!1),[re,Z]=s.useState(!1),[Y,M]=s.useState(!1),[T,ne]=s.useState(!1),[le,K]=s.useState(e),[J,ce]=s.useState(Ye.enableQualityRetry),[ge,ie]=s.useState(Ye.enableAutoRepair),[E,X]=s.useState(Ye.enableFinalChecks),[V,ee]=s.useState(Ye.incrementalConsistency),[p,B]=s.useState(Ye.incrementalConsistencyDryRun),[te,oe]=s.useState(Ye.lookbackCount),[de,se]=s.useState(Ye.checkOnlyMode),[ke,Me]=s.useState(Ye.useGridRepair),[Ae,Ne]=s.useState(Ye.forceRepairThreshold),[Le,me]=s.useState(Ye.enableSceneValidation),[Re,ue]=s.useState(Ye.separatedEvaluation),[H,P]=s.useState(Ye.enableFullRepairAfterGeneration),[ve,$e]=s.useState(!1),[Ce,We]=s.useState(!1),[ze,xt]=s.useState({...no}),sa=ia=>{u(ia),K(!!ia)};return s.useEffect(()=>{n?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[n]),{developerMode:n,setDeveloperMode:sa,imageGenMode:S,setImageGenMode:r,generationMode:G,setGenerationMode:x,devSkipOutline:D,setDevSkipOutline:U,devSkipText:re,setDevSkipText:Z,devSkipSceneDescriptions:Y,setDevSkipSceneDescriptions:M,devSkipImages:T,setDevSkipImages:ne,devSkipCovers:le,setDevSkipCovers:K,enableQualityRetry:J,setEnableQualityRetry:ce,enableAutoRepair:ge,setEnableAutoRepair:ie,enableFinalChecks:E,setEnableFinalChecks:X,incrementalConsistency:V,setIncrementalConsistency:ee,incrementalConsistencyDryRun:p,setIncrementalConsistencyDryRun:B,lookbackCount:te,setLookbackCount:oe,checkOnlyMode:de,setCheckOnlyMode:se,useGridRepair:ke,setUseGridRepair:Me,forceRepairThreshold:Ae,setForceRepairThreshold:Ne,enableSceneValidation:Le,setEnableSceneValidation:me,separatedEvaluation:Re,setSeparatedEvaluation:ue,enableFullRepairAfterGeneration:H,setEnableFullRepairAfterGeneration:P,loadAllAvatars:ve,setLoadAllAvatars:$e,useMagicApiRepair:Ce,setUseMagicApiRepair:We,modelSelections:ze,setModelSelections:xt}}const io=s.lazy(()=>It(()=>import("./StoryDisplay-B0F3Y_QC.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27]))),oo=s.lazy(()=>It(()=>import("./RepairWorkflowPanel-_YgDgWK3.js"),__vite__mapDeps([28,1,2,3,4,13,14,23,11,12,29,30,24,5,16]))),lo=s.lazy(()=>It(()=>import("./WizardStep2Characters-Bt5vXZdL.js"),__vite__mapDeps([31,1,2,3,4,5,6,7,8,19,32,33,22,13,14,11,12,27,34,20,35,16,29,24,25,17,26])).then(e=>({default:e.WizardStep2Characters}))),co=s.lazy(()=>It(()=>Promise.resolve().then(()=>Ki),void 0).then(e=>({default:e.WizardStep3BookSettings}))),uo=s.lazy(()=>It(()=>import("./WizardStep4StoryType-C1QUF6vN.js"),__vite__mapDeps([36,1,2,3,4,7,35,15,11,5,6,8,24,25,16,17,26,27])).then(e=>({default:e.WizardStep4StoryType}))),go=s.lazy(()=>It(()=>import("./WizardStep5ArtStyle-BtVS8Ump.js"),__vite__mapDeps([37,1,2,3,4,38,17])).then(e=>({default:e.WizardStep5ArtStyle}))),ho=s.lazy(()=>It(()=>import("./WizardStep6Summary-3Zeg4XUz.js"),__vite__mapDeps([39,1,2,3,4,38,35,19,7,5,6,8,24,25,16,17,11,26,27])).then(e=>({default:e.WizardStep6Summary}))),i=$n("StoryWizard"),Dn={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"FÃ¼ge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die BuchlÃ¤nge und das Leseniveau fÃ¼r dein Publikum fest",3:"WÃ¤hle einen Geschichtstyp und ein Thema",4:"WÃ¤hle einen Illustrationsstil fÃ¼r dein Buch",5:"ÃœberprÃ¼fe deine Auswahl, fÃ¼ge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils apparaÃ®tront de maniÃ¨re cohÃ©rente dans toute votre histoire!",2:"DÃ©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un thÃ¨me",4:"Choisissez un style d'illustration pour votre livre",5:"VÃ©rifiez vos choix, ajoutez des dÃ©tails de l'intrigue, puis gÃ©nÃ©rez votre histoire!"}};function mo(){const e=xi(),[n,u]=bi(),{t:S,language:r}=qt(),{isAuthenticated:G,user:x,updateCredits:D,refreshUser:U,isLoading:re,isImpersonating:Z}=jr(),{showSuccess:Y,showInfo:M,showError:T}=yi(),{startTracking:ne,stopTracking:le,activeJob:K,isComplete:J,completedStoryId:ce,markCompletionViewed:ge,hasUnviewedCompletion:ie}=vi(),[E,X]=s.useState(()=>{const a=new URLSearchParams(window.location.search);if(a.get("storyId"))return 6;if(a.get("new")==="true")return 1;const l=localStorage.getItem("wizard_step");return l?parseInt(l,10):1}),[V,ee]=s.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[p,B]=s.useState(null),{developerMode:te,setDeveloperMode:oe,imageGenMode:de,setImageGenMode:se,generationMode:ke,setGenerationMode:Me,devSkipOutline:Ae,setDevSkipOutline:Ne,devSkipText:Le,setDevSkipText:me,devSkipSceneDescriptions:Re,setDevSkipSceneDescriptions:ue,devSkipImages:H,setDevSkipImages:P,devSkipCovers:ve,setDevSkipCovers:$e,enableQualityRetry:Ce,setEnableQualityRetry:We,enableAutoRepair:ze,setEnableAutoRepair:xt,useGridRepair:sa,setUseGridRepair:ia,forceRepairThreshold:Fa,setForceRepairThreshold:zn,enableFinalChecks:Ar,setEnableFinalChecks:_n,incrementalConsistency:Ut,setIncrementalConsistency:Ln,incrementalConsistencyDryRun:Nr,setIncrementalConsistencyDryRun:Hn,lookbackCount:Dt,setLookbackCount:Vn,checkOnlyMode:Tr,setCheckOnlyMode:Wn,enableSceneValidation:Pr,setEnableSceneValidation:On,separatedEvaluation:Ir,setSeparatedEvaluation:qn,enableFullRepairAfterGeneration:Dr,setEnableFullRepairAfterGeneration:Un,loadAllAvatars:oa,setLoadAllAvatars:Kn,useMagicApiRepair:Jn,setUseMagicApiRepair:Qn,modelSelections:_e,setModelSelections:Zn}=so(),[gt,Kt]=s.useState(()=>localStorage.getItem("story_type")||""),[fe,Ma]=s.useState(()=>localStorage.getItem("story_category")||""),[Ie,za]=s.useState(()=>localStorage.getItem("story_topic")||""),[De,_a]=s.useState(()=>localStorage.getItem("story_theme")||""),[et,La]=s.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[tt,Jt]=s.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[ae,xe]=s.useState([]),[Yn,Ha]=s.useState(null),[g,be]=s.useState(null),$r=s.useRef([]),Rr=s.useRef(null),[Xn,Va]=s.useState(!1),[es,Oe]=s.useState("photo"),[ts,Qt]=s.useState(!1),[Er,st]=s.useState(null),[as,Gr]=s.useState(!1),[rs,la]=s.useState(!1),[ns,Br]=s.useState(void 0),[ss,Fr]=s.useState(void 0),is=s.useRef(null),[os,Wa]=s.useState(!1),[Mr,Oa]=s.useState([]),[ca,qa]=s.useState(null),[Ua,Ka]=s.useState(null),[qe,da]=s.useState({}),[it,Ja]=s.useState({}),[$t,zr]=s.useState([]),Qa=s.useRef(null),ls=s.useRef(!1),Rt=s.useRef(!1),[ua,_r]=s.useState(!1),[ht,mt]=s.useState([]),[He,Zt]=s.useState([]),ga=s.useRef(!1),[at,ha]=s.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[rt,Lr]=s.useState(()=>{try{const a=localStorage.getItem("story_language");if(a){if(a==="de")return"de-ch";if(a==="fr")return"fr-ch";if(a==="it")return"it-ch";if(a==="en")return"en-gb";if(a.startsWith("de")||a.startsWith("fr")||a.startsWith("it")||a.startsWith("en")||a.startsWith("gsw"))return a}return"de-ch"}catch{return"de-ch"}}),[Ue,Za]=s.useState(()=>{try{const a=localStorage.getItem("story_pages");return a?parseInt(a):30}catch{return 30}}),[bt,ma]=s.useState(()=>localStorage.getItem("story_dedication")||""),[St,Et]=s.useState(()=>localStorage.getItem("story_details")||""),[wt,Yt]=s.useState(!1),[fa,Gt]=s.useState(!1),[pa,Bt]=s.useState(!1),[cs,Ya]=s.useState(0),[ds,Xa]=s.useState(0),[ya,er]=s.useState(null),[Hr,tr]=s.useState(""),[ft,Ft]=s.useState([]),[us,Vr]=s.useState(null),[Wr,gs]=s.useState(null),Ct=s.useRef(null),[jt,Or]=s.useState(null),[kt,hs]=s.useState(()=>Fn()),[ot,Mt]=s.useState(!1),[ms,qr]=s.useState(new Set),[fs,Ur]=s.useState(!1),[ps,va]=s.useState(!1),[ys,ar]=s.useState(!1),[vs,rr]=s.useState(!1),[xs,Kr]=s.useState(!1),[bs,xa]=s.useState(!1),[nr,At]=s.useState({current:0,total:0,message:""}),[nt,lt]=s.useState(null),[Ss,zt]=s.useState(!1),[ba,pt]=s.useState(""),[_t,Xt]=s.useState(""),[ws,Jr]=s.useState(""),[Cs,Qr]=s.useState(""),[js,Zr]=s.useState(""),[ks,Yr]=s.useState(),[As,Xr]=s.useState(),[Ns,en]=s.useState([]),[Ts,Lt]=s.useState(null),[Ps,Sa]=s.useState(null),[Is,sr]=s.useState([]),[Ds,ir]=s.useState([]),[$s,or]=s.useState([]),[tn,lr]=s.useState(null),[Rs,Ht]=s.useState([]),[wa,Be]=s.useState([]),[yt,Ke]=s.useState({frontCover:null,initialPage:null,backCover:null}),[q,cr]=s.useState(null),[Es,Gs]=s.useState(0),[dr,Ca]=s.useState(null),[Bs,an]=s.useState(!1),[Fs,rn]=s.useState(),[Ms,nn]=s.useState(),[zs,sn]=s.useState(),[_s,ur]=s.useState(null),gr=s.useRef(!1),[Ls,on]=s.useState(null),vt=s.useRef(!1),hr=s.useRef(!1),Vt=s.useRef({metadataLoaded:!1,fastImagesLoaded:!1,fullImagesLoaded:!1,devMetadataLoaded:!1}),[Je,ja]=s.useState(null),[mr,ka]=s.useState({}),[Hs,Aa]=s.useState(!1),[Ee,Na]=s.useState(null),[ea,ta]=s.useState("");s.useEffect(()=>{$r.current=ae},[ae]),s.useEffect(()=>{Rr.current=g},[g]),s.useEffect(()=>{if(!re&&!G){if(!!localStorage.getItem("auth_token")){i.debug("Token found but not authenticated yet, waiting for state sync...");return}const l=window.location.pathname+window.location.search,c=encodeURIComponent(l);e(`/?login=true&redirect=${c}`)}},[G,re,e]);const Ta=s.useCallback(a=>{var l,c,f,C,o,h,d,v,m,A;if(a){if((l=a.sceneImages)!=null&&l.length&&Be(b=>b.map(y=>{var W;const F=a.sceneImages.find(L=>L.pageNumber===y.pageNumber);return F?{...y,prompt:F.prompt??y.prompt,qualityReasoning:F.qualityReasoning??y.qualityReasoning,retryHistory:F.retryHistory??y.retryHistory,repairHistory:F.repairHistory??y.repairHistory,wasRegenerated:F.wasRegenerated??y.wasRegenerated,originalScore:F.originalScore??y.originalScore,originalReasoning:F.originalReasoning??y.originalReasoning,totalAttempts:F.totalAttempts??y.totalAttempts,faceEvaluation:F.faceEvaluation??y.faceEvaluation,referencePhotos:F.referencePhotos??y.referencePhotos,landmarkPhotos:F.landmarkPhotos??y.landmarkPhotos,hasVisualBibleGrid:F.hasVisualBibleGrid??y.hasVisualBibleGrid,consistencyRegen:F.consistencyRegen??y.consistencyRegen,imageVersions:((W=y.imageVersions)==null?void 0:W.map((L,w)=>{var $,k,j;const Q=($=F.imageVersionsMeta)==null?void 0:$[w];return Q?{...L,qualityScore:Q.qualityScore??L.qualityScore,qualityReasoning:Q.qualityReasoning??L.qualityReasoning,fixTargets:(k=Q.fixTargets)!=null&&k.length?Q.fixTargets:L.fixTargets,totalAttempts:Q.totalAttempts??L.totalAttempts,referencePhotoNames:(j=Q.referencePhotoNames)!=null&&j.length?Q.referencePhotoNames:L.referencePhotoNames,prompt:Q.prompt??L.prompt,description:Q.description??L.description}:L}))??y.imageVersions}:y})),a.coverImages&&Ke(b=>{var W;const y={...b},F=["frontCover","initialPage","backCover"];for(const L of F){const w=(W=a.coverImages)==null?void 0:W[L],Q=b[L];w&&typeof Q=="object"&&Q!==null&&(y[L]={...Q,prompt:w.prompt??Q.prompt,qualityReasoning:w.qualityReasoning??Q.qualityReasoning,retryHistory:w.retryHistory??Q.retryHistory,referencePhotos:w.referencePhotos??Q.referencePhotos,landmarkPhotos:w.landmarkPhotos??Q.landmarkPhotos})}return y}),console.log("[StoryWizard] Dev metadata generationLog:",((c=a.generationLog)==null?void 0:c.length)||0,"entries"),(f=a.generationLog)!=null&&f.length&&or(a.generationLog),(C=a.styledAvatarGeneration)!=null&&C.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",((o=a.styledAvatarGeneration)==null?void 0:o.length)??0,"entries"),sr(a.styledAvatarGeneration)),(h=a.costumedAvatarGeneration)!=null&&h.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",((d=a.costumedAvatarGeneration)==null?void 0:d.length)??0,"entries"),ir(a.costumedAvatarGeneration)),a.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",a.finalChecksReport.totalIssues,"issues"),lr(a.finalChecksReport)),(v=a.sceneDescriptions)!=null&&v.length){const b=a.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",b.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(b[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((m=b[0])!=null&&m.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((A=b[0])!=null&&A.scenePrompt)),Ht(a.sceneDescriptions)}a.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),Lt(a.visualBible))}},[]);s.useEffect(()=>{ye.getUserLocation().then(a=>{Or(a),a!=null&&a.city&&ye.triggerLandmarkDiscovery(a.city,a.country)})},[]),s.useEffect(()=>{G&&ye.getStories({limit:1}).then(({pagination:a})=>{Kr(a.total>0)}).catch(()=>Kr(!1))},[G]);const fr=s.useRef(null);s.useEffect(()=>{const a=n.get("storyId");n.get("new")!=="true"&&(a&&(fr.current=null),K&&!a&&fr.current!==K.jobId&&(i.info("Returning during active generation, restoring progress for job:",K.jobId),fr.current=K.jobId,X(6),Mt(!0),pt(K.storyTitle),Ca(K.jobId),ye.getJobStatus(K.jobId).then(c=>{var f,C;if(i.info("Restored job status:",{progress:c.progress,hasStoryText:!!c.storyText,storyTextKeys:c.storyText?Object.keys(c.storyText):[],pageTextsCount:(f=c.storyText)!=null&&f.pageTexts?Object.keys(c.storyText.pageTexts).length:0,partialPages:((C=c.partialPages)==null?void 0:C.length)||0}),c.progress&&At(o=>c.progress.current>=o.current?c.progress:{...o,message:c.progress.message}),c.storyText){const o=c.storyText.pageTexts||{};i.info("Setting progressiveStoryData with",Object.keys(o).length,"pages"),ja({title:c.storyText.title||K.storyTitle,dedication:c.storyText.dedication,pageTexts:o,sceneDescriptions:c.storyText.sceneDescriptions||[],totalPages:c.storyText.totalPages||Ue})}else i.warn("No storyText in job status response");if(c.partialPages&&c.partialPages.length>0){const o={};c.partialPages.forEach(h=>{h.pageNumber&&h.imageData&&(o[h.pageNumber]=h.imageData)}),i.info("Restored",Object.keys(o).length,"page images"),ka(o)}c.partialCovers&&Ke(o=>{var h,d,v;return{frontCover:((h=c.partialCovers)==null?void 0:h.frontCover)||o.frontCover,initialPage:((d=c.partialCovers)==null?void 0:d.initialPage)||o.initialPage,backCover:((v=c.partialCovers)==null?void 0:v.backCover)||o.backCover}})}).catch(c=>{i.error("Failed to restore job status:",c)})),i.debug("Auto-nav check:",{generationComplete:J,completedStoryId:ce,urlStoryId:a,hasActiveJob:!!K}),J&&ce&&!a&&(i.info("Generation completed, navigating to story:",ce),u({storyId:ce},{replace:!0})))},[K,J,ce,n,u,Ue]),s.useEffect(()=>{if(n.get("new")==="true"){i.info("New story requested - resetting all story settings"),Kt(""),Ma(""),za(""),_a(""),La(""),Jt("watercolor"),ha("standard"),Za(30),ma(""),Et(""),Ha(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const l=new URLSearchParams(n);l.delete("new"),u(l,{replace:!0}),be(null),Oe("photo"),X(1)}},[n,u]),s.useEffect(()=>{const a=n.get("storyId");a&&E!==6&&X(6),(async()=>{if(!(!a||!G)){if(gr.current){gr.current=!1,i.info("Skipping story reload - just finished generating");return}i.info("Loading saved story (two-phase):",a),Vt.current={metadataLoaded:!1,fastImagesLoaded:!1,fullImagesLoaded:!1,devMetadataLoaded:!1},B(null),lt(null);try{const c=await ye.getQuickMetadata(a);if(!c)throw new Error("Story not found");i.info("Quick metadata loaded:",c.title,`(${c.pageCount} pages)`),cr(c.id),pt(c.title),Lr(c.language),ha(c.languageLevel),Be(Array.from({length:c.pageCount},(d,v)=>({pageNumber:v+1,imageData:void 0,hasImage:!0}))),Ke(c.hasFrontCover?{frontCover:{hasImage:!0,imageData:void 0},initialPage:null,backCover:null}:{frontCover:null,initialPage:null,backCover:null}),X(6),ee(!1),Mt(!1),B(null);const f=c.pageCount+(c.hasFrontCover?3:0);f>0&&lt({loaded:0,total:f}),ye.getStoryMetadata(a,te).then(d=>{var v,m,A,b;d&&(i.info("Full metadata loaded:",d.title,`(${d.totalImages} images to load)`),Qr(d.outline||""),Zr(d.outlinePrompt||""),Yr(d.outlineModelId),Xr(d.outlineUsage),en(d.storyTextPrompts||[]),sr(d.styledAvatarGeneration||[]),ir(d.costumedAvatarGeneration||[]),Kt(d.storyType||""),Jt(d.artStyle||"pixar"),ma(d.dedication||""),(v=d.generationLog)!=null&&v.length&&or(d.generationLog),d.visualBible?Lt({mainCharacters:d.visualBible.mainCharacters||[],secondaryCharacters:d.visualBible.secondaryCharacters||[],animals:d.visualBible.animals||[],artifacts:d.visualBible.artifacts||[],locations:d.visualBible.locations||[],vehicles:d.visualBible.vehicles||[],clothing:d.visualBible.clothing||[],changeLog:d.visualBible.changeLog||[]}):Lt(null),d.clothingRequirements?Sa(d.clothingRequirements):Sa(null),Vt.current.metadataLoaded=!0,Be(y=>(d.sceneImages||[]).map(W=>{const L=y.find(w=>w.pageNumber===W.pageNumber);return{...W,imageData:(L==null?void 0:L.imageData)||W.imageData,...L!=null&&L.imageVersions?{imageVersions:L.imageVersions}:{}}})),(m=d.sceneDescriptions)!=null&&m.length&&!Vt.current.devMetadataLoaded&&Ht(d.sceneDescriptions),Ke(y=>{const F=(L,w)=>w?{...w,imageData:(L==null?void 0:L.imageData)||w.imageData}:null,W=d.coverImages||{frontCover:null,initialPage:null,backCover:null};return{frontCover:F(y.frontCover,W.frontCover),initialPage:F(y.initialPage,W.initialPage),backCover:F(y.backCover,W.backCover)}}),an(d.isPartial||!1),rn(d.failureReason),nn(d.generatedPages),sn(d.totalPages),Xt(d.story||""),Jr(d.originalStory||d.story||""),ur({storyCategory:d.storyCategory,storyTopic:d.storyTopic,storyTheme:d.storyTheme,storyTypeName:d.storyTypeName,storyDetails:d.storyDetails,artStyle:d.artStyle,language:d.language,languageLevel:d.languageLevel,pages:d.pages,dedication:d.dedication,characters:(A=d.characters)==null?void 0:A.map(y=>{var F;return{id:y.id,name:y.name,isMain:(F=d.mainCharacters)==null?void 0:F.includes(y.id)}}),mainCharacters:d.mainCharacters,relationships:d.relationships,relationshipTexts:d.relationshipTexts,season:d.season,userLocation:d.userLocation}),(b=d.characters)!=null&&b.length&&Ha(d.characters.map(y=>{var F,W;return{id:y.id,name:y.name,photoData:y.photoData||((F=y.photos)==null?void 0:F.face)||((W=y.photos)==null?void 0:W.original)}})),d.totalImages>0&&lt(y=>y?{...y,total:d.totalImages}:null))}).catch(d=>{i.warn("Failed to load full metadata:",d)}),te&&(vt.current=!0,ye.getStoryDevMetadata(a).then(d=>{Vt.current.devMetadataLoaded=!0,Ta(d),i.debug("Dev metadata merged into story")}).catch(d=>{i.warn("Failed to load dev metadata:",d),vt.current=!1}));const C=3e4,o=ye.getAllImages(a,!0),h=new Promise(d=>setTimeout(()=>{i.warn("Image load timeout - clearing progress indicator"),d(null)},C));Promise.race([o,h]).then(d=>{if(!d){lt(null);return}const v=d.images||[],m=d.covers||{},A=Object.keys(m).filter(y=>{var F;return(F=m[y])==null?void 0:F.imageData}).length,b=v.filter(y=>y.imageData).length;if(i.info(`Fast images loaded: ${b} pages, ${A} covers`),b>0||A>0){let y=0;const F=["frontCover","initialPage","backCover"];for(const W of F){const L=m[W];L!=null&&L.imageData&&(y++,Ke(w=>{const Q=w[W];return typeof Q=="object"&&Q!==null?{...w,[W]:{...Q,imageData:L.imageData}}:{...w,[W]:L.imageData}}),lt(w=>w?{...w,loaded:y}:null))}for(const W of v)W.imageData&&(y++,Be(L=>L.map(w=>w.pageNumber!==W.pageNumber?w:{...w,imageData:W.imageData})),lt(L=>L?{...L,loaded:y}:null));i.info("Fast images displayed")}Vt.current.fastImagesLoaded=!0,lt(null),ye.getAllImages(a,!1).then(y=>{const F=(y==null?void 0:y.images)||[],W=(y==null?void 0:y.covers)||{};i.info(`Full images loaded: ${F.length} pages with versions`);for(const w of F)w.imageVersions&&w.imageVersions.length>0&&Be(Q=>Q.map($=>{var j;if($.pageNumber!==w.pageNumber)return $;const k=(j=w.imageVersions)==null?void 0:j.map((I,N)=>{var z;return{...((z=$.imageVersions)==null?void 0:z[N])||{},...I}});return{...$,imageData:$.imageData||w.imageData,imageVersions:k}}));const L=["frontCover","initialPage","backCover"];for(const w of L){const Q=W[w];Q&&Ke($=>{const k=typeof $[w]=="object"?$[w]:{};return{...$,[w]:{...k,...Q,imageData:(k==null?void 0:k.imageData)||Q.imageData}}})}Vt.current.fullImagesLoaded=!0,i.info("Full image data with versions loaded")}).catch(y=>{i.warn("Failed to load full images (versions may be unavailable):",y)})}).catch(d=>{i.warn("Failed to load images:",d),lt(null)})}catch(c){i.error("Failed to load story:",c),ee(!1),B(null),lt(null)}}})()},[n,G,Es]),s.useEffect(()=>{E===6&&ie&&(i.info("Clearing unviewed completion - user is viewing story"),ge())},[E,ie,ge]),s.useEffect(()=>{(async()=>{const l=n.get("payment"),c=n.get("session_id");if(l==="success"&&c){i.info("Payment successful! Checking order status..."),i.info("Session ID:",c);try{const o=await ye.getOrderStatus(c);if(i.info("Order Status:",o),o.order){const h=`CHF ${(o.order.amount_total/100).toFixed(2)}`,d={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement rÃ©ussi!"},v={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a Ã©tÃ© reÃ§ue et sera bientÃ´t imprimÃ©e."},m=[`${r==="de"?"Kunde":r==="fr"?"Client":"Customer"}: ${o.order.customer_name}`,`Email: ${o.order.customer_email}`,`${r==="de"?"Betrag":r==="fr"?"Montant":"Amount"}: ${h}`,`${r==="de"?"Versand an":r==="fr"?"ExpÃ©diÃ© Ã ":"Shipping to"}: ${o.order.shipping_name}`,`${o.order.shipping_address_line1}`,`${o.order.shipping_postal_code} ${o.order.shipping_city}`,`${o.order.shipping_country}`];Y(v[r]||v.en,d[r]||d.en,m)}}catch(o){i.error("Error checking order status:",o)}const C=new URLSearchParams(n);C.delete("payment"),C.delete("session_id"),u(C,{replace:!0})}else if(l==="cancelled"){i.info("Payment cancelled by user");const C={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie kÃ¶nnen es erneut versuchen.",fr:"Paiement annulÃ©. Vous pouvez rÃ©essayer quand vous Ãªtes prÃªt."};M(C[r]||C.en,r==="de"?"Abgebrochen":r==="fr"?"AnnulÃ©":"Cancelled");const o=new URLSearchParams(n);o.delete("payment"),u(o,{replace:!0})}const f=n.get("credits_payment");if(f==="success"){i.info("Credits payment successful!"),await U();const C={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},o={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};Y(o[r]||o.en,C[r]||C.en);const h=new URLSearchParams(n);h.delete("credits_payment"),h.delete("session_id"),u(h,{replace:!0})}else if(f==="cancelled"){i.info("Credits payment cancelled by user");const C={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};M(C[r]||C.en,r==="de"?"Abgebrochen":r==="fr"?"Annule":"Cancelled");const o=new URLSearchParams(n);o.delete("credits_payment"),u(o,{replace:!0})}})()},[n,u,r,Y,M,U]);const Pa=s.useRef(!1);s.useEffect(()=>{if(n.get("autoGenerate")==="true"&&!Pa.current){Pa.current=!0;const l=localStorage.getItem("pending_story_type"),c=localStorage.getItem("pending_art_style");l&&(Kt(l),localStorage.removeItem("pending_story_type")),c&&(Jt(c),localStorage.removeItem("pending_art_style")),X(6);const f=new URLSearchParams(n);f.delete("autoGenerate"),u(f,{replace:!0})}},[n,u]);const pr=a=>{if(a.length===0)return;const l=a.filter(c=>{const f=parseInt(c.age);return f>=1&&f<=10});if(l.length>0){const c=l.map(f=>f.id);mt(c),i.info(`Auto-selected ${l.length} main character(s) aged 1-10`)}else{const c=a.reduce((f,C)=>{const o=parseInt(C.age)||999,h=parseInt(f.age)||999;return o<h?C:f});mt([c.id]),i.info(`Auto-selected youngest character as main: ${c.name} (age ${c.age})`)}};s.useEffect(()=>{G?(async()=>{try{ee(!0);const l=await he.getCharacterData(oa);if(i.info("Loaded character data from API:",{characters:l.characters.length,relationships:Object.keys(l.relationships).length}),xe(l.characters),Object.keys(l.relationships).length>0&&(da(l.relationships),ls.current=!0),Object.keys(l.relationshipTexts).length>0&&Ja(l.relationshipTexts),l.customRelationships.length>0&&zr(l.customRelationships),l.characters.some(f=>f.storyRole)){const f=[],C=[];for(const o of l.characters)o.storyRole==="main"?f.push(o.id):o.storyRole==="out"&&C.push(o.id);mt(f),Zt(C),i.info(`Loaded character roles from database: ${f.length} main, ${C.length} excluded`)}else l.characters.length>0&&pr(l.characters)}catch(l){i.error("Failed to load character data:",l)}finally{ee(!1),_r(!0)}})():re||_r(!0)},[G,re]),s.useEffect(()=>{te&&q&&!vt.current&&(vt.current=!0,i.info("Developer mode enabled, fetching dev metadata for story:",q),ye.getStoryDevMetadata(q).then(a=>{Ta(a),i.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(a=>{i.warn("Failed to load dev metadata on toggle:",a),vt.current=!1})),(!te||!q)&&(vt.current=!1)},[te,q,Ta]),s.useEffect(()=>{oa&&G&&ua&&(async()=>{try{i.info("Reloading characters with full avatars (dev mode)");const l=await he.getCharacterData(!0);xe(l.characters),i.info(`Loaded ${l.characters.length} characters with full avatars`)}catch(l){i.error("Failed to reload with full avatars:",l)}})()},[oa,G,ua]),s.useEffect(()=>{E===1&&ae.length===0&&!g&&!V&&ua&&vr()},[E,ae.length,g,V,ua]);const yr=s.useRef(He);s.useEffect(()=>{yr.current!==He&&JSON.stringify(yr.current)!==JSON.stringify(He)&&(Ft([]),Et(""),yr.current=He)},[He]),s.useEffect(()=>{localStorage.setItem("story_language_level",at)},[at]),s.useEffect(()=>{localStorage.setItem("story_language",rt)},[rt]),s.useEffect(()=>{localStorage.setItem("story_pages",Ue.toString())},[Ue]),s.useEffect(()=>{localStorage.setItem("story_dedication",bt)},[bt]),s.useEffect(()=>{localStorage.setItem("story_details",St)},[St]),s.useEffect(()=>{localStorage.setItem("story_type",gt)},[gt]),s.useEffect(()=>{fe?localStorage.setItem("story_category",fe):localStorage.removeItem("story_category")},[fe]),s.useEffect(()=>{Ie?localStorage.setItem("story_topic",Ie):localStorage.removeItem("story_topic")},[Ie]),s.useEffect(()=>{De?localStorage.setItem("story_theme",De):localStorage.removeItem("story_theme")},[De]),s.useEffect(()=>{et?localStorage.setItem("story_custom_theme_text",et):localStorage.removeItem("story_custom_theme_text")},[et]);const ln=s.useRef(fe),cn=s.useRef(Ie),dn=s.useRef(De),un=s.useRef(!0);s.useEffect(()=>{if(un.current){un.current=!1;return}const a=ln.current!==fe,l=cn.current!==Ie,c=dn.current!==De;(a||l||c)&&(Et(""),localStorage.removeItem("story_details"),Ft([])),ln.current=fe,cn.current=Ie,dn.current=De},[fe,Ie,De]),s.useEffect(()=>{localStorage.setItem("story_art_style",tt)},[tt]);const aa=s.useRef(!1);s.useEffect(()=>{if(E===4&&!aa.current&&!wt&&ft.length===0){const a=!!fe,l=!!De||!!Ie,c=ae.length>0;a&&l&&c&&(aa.current=!0,i.info("[StoryWizard] Pre-generating story ideas while user selects art style"),mn())}aa.current&&ft.length===0&&(aa.current=!1)},[E,fe,De,Ie,ae.length,wt,ft.length]);const gn=s.useRef({storyCategory:fe,storyTheme:De,storyTopic:Ie});s.useEffect(()=>{const a=gn.current,l=a.storyCategory!==fe||a.storyTheme!==De||a.storyTopic!==Ie;gn.current={storyCategory:fe,storyTheme:De,storyTopic:Ie},l&&(wt||ft.length>0)&&(i.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),Ct.current&&(Ct.current.abort(),Ct.current=null),Yt(!1),Gt(!1),Bt(!1),Ft([]),er(null),tr(""),aa.current=!1)},[fe,De,Ie,wt,ft.length]),s.useEffect(()=>{if(!wt)return;const l=setTimeout(()=>{i.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),Yt(!1),Gt(!1),Bt(!1),T(r==="de"?"ZeitÃ¼berschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":r==="fr"?"DÃ©lai d'attente de gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(l)},[wt,r]),s.useEffect(()=>{if(!fa&&!pa){Ya(0),Xa(0);return}const a=35e3,l=80,c=100,f=Date.now(),C=setInterval(()=>{const o=Date.now()-f,h=Math.min(o/a,1),d=1-Math.pow(1-h,3),v=Math.round(d*l);fa&&Ya(v),pa&&Xa(v),h>=1&&clearInterval(C)},c);return()=>clearInterval(C)},[fa,pa]),s.useEffect(()=>{E>=1&&E<=5&&localStorage.setItem("wizard_step",E.toString())},[E]);const Vs=a=>{Ma(a)},Ws=a=>{_a(a),!(a==="custom"||a==="realistic"||a==="")&&(fe==="adventure"||(fe==="life-challenge"||fe==="educational")&&Ie!=="")&&ct(4)},Os=a=>{za(a),fe==="historical"&&a!==""&&ct(4)},qs=a=>{Jt(a),ct(5)};s.useEffect(()=>{if(E===2&&ae.length>=2&&!V){const a=ae.map(l=>l.id).sort().join("-");if(!Qa.current||Qa.current!==a){const c=Qi(r);i.debug("Initializing relationships for step 2",{charKey:a,existingCount:Object.keys(qe).length}),da(f=>{const C={...f};let o=!1;return ae.forEach((h,d)=>{ae.forEach((v,m)=>{if(d!==m){const A=`${h.id}-${v.id}`;C[A]||(C[A]=c,o=!0,i.debug("Initializing missing relationship:",A))}})}),o?C:f}),Qa.current=a}}},[E,ae,r,V]);const Us=()=>{if(ae.length<2)return!0;for(let a=0;a<ae.length;a++)for(let l=0;l<ae.length;l++)if(a!==l){const c=`${ae[a].id}-${ae[l].id}`,f=qe[c];if(!f||An(f))return!1}return!0},Ks=()=>{if(ae.length<2)return null;let a=0,l=null;for(const c of ae){let f=0;for(const C of ae)if(c.id!==C.id){const o=`${c.id}-${C.id}`,h=qe[o];(!h||An(h))&&f++}f>a&&(a=f,l=c)}return l},vr=()=>{be({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),Oe("photo"),Va(!1)},Js=(a,l=1500)=>new Promise(c=>{const f=new Image;f.onload=()=>{const C=document.createElement("canvas");let{width:o,height:h}=f;(o>l||h>l)&&(o>h?(h=Math.round(h*l/o),o=l):(o=Math.round(o*l/h),h=l)),C.width=o,C.height=h;const d=C.getContext("2d");d==null||d.drawImage(f,0,0,o,h),c(C.toDataURL("image/jpeg",.85))},f.onerror=()=>c(a),f.src=a}),Qs=async(a,l)=>{var C,o,h,d,v;if(i.info(`ðŸ“¸ handlePhotoSelect called: file=${a==null?void 0:a.name}, character=${g==null?void 0:g.name}, developerMode=${te}`),g&&!te){const m=!!((C=g.avatars)!=null&&C.winter||(o=g.avatars)!=null&&o.standard||(h=g.avatars)!=null&&h.summer||(d=g.avatars)!=null&&d.hasFullAvatars);if(i.info(`ðŸ“¸ hasAvatars=${m}`),m){const A=Ba(g.id);if(i.info(`ðŸ“¸ cooldown check: canRegenerate=${A.canRegenerate}, waitSeconds=${A.waitSeconds}`),!A.canRegenerate){const b=r==="de"?`Bitte warten Sie ${A.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${A.waitSeconds} seconds before uploading a new photo.`;T(b);return}Mn(g.id)}}const c=l&&((v=g==null?void 0:g.clothing)!=null&&v.structured)?{...g.clothing.structured}:null,f=new FileReader;f.onload=async m=>{var b,y,F,W,L,w,Q,$,k,j,I,N;const A=(b=m.target)==null?void 0:b.result;g&&(is.current={physical:g.physical,gender:g.gender,age:g.age}),Br(void 0),Qt(!0),!(g!=null&&g.name)||g.name.trim().length<2?Oe("name"):(Oe("traits"),i.info("ðŸ“¸ Character has name, going to traits step to show avatar regeneration"));try{const z=await Js(A),Se=Math.round(A.length/1024),R=Math.round(z.length/1024);i.info(`Starting photo analysis... (${Se}KB -> ${R}KB)`);const pe=g!=null&&g.id&&g.id>0?g.id:void 0,O=await he.analyzePhoto(z,r,void 0,void 0,pe);if(O.success){if(O.multipleFacesDetected&&O.faces&&O.faces.length>1){i.info(`Multiple faces detected (${O.faces.length}), showing selection modal`),qa(z),Ka(c?{structured:c}:null),Oa(O.faces),Wa(!0),Qt(!1);return}i.info("Photo analysis complete:",{hasPhotos:!!O.photos,hasPhysical:!!O.physical,hasClothing:!!O.clothing,age:O.age,gender:O.gender}),O._debug&&(Fr(O._debug),O._debug.rawResponse,O._debug.error&&console.warn("ðŸ“¸ [DEBUG] Gemini error:",O._debug.error));const Te={original:((y=O.photos)==null?void 0:y.face)||A,face:(F=O.photos)==null?void 0:F.face,body:((W=O.photos)==null?void 0:W.body)||A,bodyNoBg:(L=O.photos)==null?void 0:L.bodyNoBg,faceBox:(w=O.photos)==null?void 0:w.faceBox,bodyBox:(Q=O.photos)==null?void 0:Q.bodyBox},Ge=($=O.photos)!=null&&$.bodyNoBg?Math.round(O.photos.bodyNoBg.length/1024):0,Fe=(k=O.photos)!=null&&k.body?Math.round(O.photos.body.length/1024):0,Ia=(j=O.photos)!=null&&j.face?Math.round(O.photos.face.length/1024):0;if(i.info(`ðŸ“¸ [PHOTO CHANGE] Analysis returned: bodyNoBg=${Ge}KB, body=${Fe}KB, face=${Ia}KB`),(I=O.photos)!=null&&I.bodyNoBg){const we=O.photos.bodyNoBg.substring(O.photos.bodyNoBg.indexOf("base64,")+7,O.photos.bodyNoBg.indexOf("base64,")+27);i.info(`ðŸ“¸ [PHOTO CHANGE] bodyNoBg fingerprint: ${we}...`)}let Xe,Da;c?(Xe={structured:c},Da={upperBody:c.upperBody?"user":void 0,lowerBody:c.lowerBody?"user":void 0,shoes:c.shoes?"user":void 0,fullBody:c.fullBody?"user":void 0},i.info(`ðŸ‘• Keeping old clothing (marked as user-edited): ${JSON.stringify(c)}`)):i.info("ðŸ‘• Using new photo's clothing (cleared existing)");const $a=O.characterId,br=(g==null?void 0:g.id)&&g.id>0,Wt=br?g.id:$a;br?i.info(`ðŸ“¸ [PHOTO] Keeping existing character ID: ${g.id} (server created new ID ${$a} but ignoring)`):$a&&i.info(`ðŸ“¸ [PHOTO] Using server-created character ID: ${$a}`);const Qe=g?{...g,id:Wt||g.id,photos:Te,avatars:{status:"generating"},clothing:Xe,clothingSource:Da}:null;if(Qe){const we=(N=Qe.photos)==null?void 0:N.bodyNoBg,Ve=we?Math.round(we.length/1024):0;if(i.info(`ðŸ“¸ [CHAR FOR GEN] bodyNoBg=${Ve}KB, has photos: ${!!Qe.photos}`),we){const je=we.substring(we.indexOf("base64,")+7,we.indexOf("base64,")+27);i.info(`ðŸ“¸ [CHAR FOR GEN] fingerprint: ${je}...`)}}if(be(we=>{var je;if(!we)return null;const Ve=(je=we.avatars)!=null&&je.standard?{...we.avatars,status:"generating",stale:!0}:{status:"generating"};return{...we,id:Wt||we.id,photos:Te,avatars:Ve,clothing:Xe,clothingSource:Da}}),Wt&&!br&&xe(we=>{if(!we.some(je=>je.id===Wt)){const je={...g,id:Wt,photos:Te,avatars:{status:"generating"},clothing:Xe,clothingSource:Da};return i.info(`ðŸ“¸ Adding new character ${Wt} to array to prevent data loss`),[...we,je]}return we}),i.info("ðŸŽ¨ Auto-starting avatar generation in background..."),i.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Te.bodyNoBg}, body=${!!Te.body}, face=${!!Te.face}`),Qe&&Qe.id&&Qe.name&&Qe.name.trim()){const we=Qe.id;st(we),he.generateAndSaveAvatarForCharacter(Qe,void 0,{avatarModel:_e.avatarModel||void 0}).then(Ve=>{Ve.success&&Ve.character?(be(je=>!je||je.id!==we?je:{...je,avatars:Ve.character.avatars,physical:Ve.character.physical,clothing:Ve.character.clothing}),xe(je=>je.map(Ze=>Ze.id===we?{...Ze,...Ve.character,id:Ze.id}:Ze)),i.success(`âœ… Avatar generated and traits extracted for ${Qe.name}`)):(i.error(`âŒ Avatar generation failed: ${Ve.error}`),be(je=>je&&je.id===we?{...je,avatars:{status:"failed"}}:je),xe(je=>je.map(Ze=>Ze.id===we?{...Ze,avatars:{status:"failed"}}:Ze)))}).catch(Ve=>{i.error("âŒ Avatar generation error:",Ve),be(je=>je&&je.id===we?{...je,avatars:{status:"failed"}}:je),xe(je=>je.map(Ze=>Ze.id===we?{...Ze,avatars:{status:"failed"}}:Ze))}).finally(()=>{st(null)})}else Qe&&Qe.id?(i.info("â­ï¸ Skipping auto-generation: character has no name yet"),st(null),be(we=>we&&{...we,avatars:{status:"pending"}})):(i.warn("â­ï¸ Skipping auto-generation: no character data available"),st(null))}else O.error==="no_face_detected"?(i.warn("No face detected in photo"),T(S.noFaceDetected)):(i.warn("Photo analysis returned no data, using original photo"),be(Te=>Te?{...Te,photos:{original:A},avatars:void 0}:null))}catch(z){i.error("Photo analysis error:",z),be(Se=>Se?{...Se,photos:{original:A},avatars:void 0}:null)}finally{Qt(!1)}},f.readAsDataURL(a)},Zs=async a=>{var l,c,f,C,o,h,d,v;if(!ca){i.error("No pending photo data for face selection");return}Wa(!1),Qt(!0);try{i.info(`Re-analyzing photo with selected face ID: ${a}`);const m=Mr.map(y=>({id:y.id,x:y.faceBox.x,y:y.faceBox.y,width:y.faceBox.width,height:y.faceBox.height,confidence:y.confidence})),A=g!=null&&g.id&&g.id>0?g.id:void 0,b=await he.analyzePhoto(ca,r,a,m,A);if(b.success){i.info("Photo analysis complete with selected face:",{hasPhotos:!!b.photos,hasPhysical:!!b.physical,hasClothing:!!b.clothing,age:b.age,gender:b.gender}),b._debug&&Fr(b._debug);const y=Ua==null?void 0:Ua.structured,F={original:((l=b.photos)==null?void 0:l.face)||ca,face:(c=b.photos)==null?void 0:c.face,body:((f=b.photos)==null?void 0:f.body)||ca,bodyNoBg:(C=b.photos)==null?void 0:C.bodyNoBg,faceBox:(o=b.photos)==null?void 0:o.faceBox,bodyBox:(h=b.photos)==null?void 0:h.bodyBox},W=(d=b.photos)!=null&&d.bodyNoBg?Math.round(b.photos.bodyNoBg.length/1024):0;if(i.info(`ðŸ“¸ [FACE SELECT] Analysis returned: bodyNoBg=${W}KB`),(v=b.photos)!=null&&v.bodyNoBg){const I=b.photos.bodyNoBg.substring(b.photos.bodyNoBg.indexOf("base64,")+7,b.photos.bodyNoBg.indexOf("base64,")+27);i.info(`ðŸ“¸ [FACE SELECT] bodyNoBg fingerprint: ${I}...`)}let L,w;y&&(L={structured:y},w={upperBody:y.upperBody?"user":void 0,lowerBody:y.lowerBody?"user":void 0,shoes:y.shoes?"user":void 0,fullBody:y.fullBody?"user":void 0});const Q=b.characterId,$=(g==null?void 0:g.id)&&g.id>0,k=$?g.id:Q;$?i.info(`ðŸ“¸ [FACE SELECT] Keeping existing character ID: ${g.id} (server created new ID ${Q} but ignoring)`):Q&&i.info(`ðŸ“¸ [FACE SELECT] Using server-created character ID: ${Q}`);const j=g?{...g,id:k||g.id,photos:F,avatars:{status:"generating"},clothing:L,clothingSource:w}:null;if(be(I=>{var z;if(!I)return null;const N=(z=I.avatars)!=null&&z.standard?{...I.avatars,status:"generating",stale:!0}:{status:"generating"};return{...I,id:k||I.id,photos:F,avatars:N,clothing:L,clothingSource:w}}),k&&!$&&xe(I=>{if(!I.some(z=>z.id===k)){const z={...g,id:k,photos:F,avatars:{status:"generating"},clothing:L,clothingSource:w};return i.info(`ðŸ“¸ [FACE SELECT] Adding new character ${k} to array to prevent data loss`),[...I,z]}return I}),g!=null&&g.name&&g.name.trim().length>=2?(Oe("traits"),i.info("ðŸ“¸ Face selected, character has name, going to traits step")):Oe("name"),i.info("ðŸŽ¨ Auto-starting avatar generation in background after face selection..."),i.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!F.bodyNoBg}, body=${!!F.body}, face=${!!F.face}`),j&&j.name&&j.name.trim()){const I=j.id;st(I),he.generateAndSaveAvatarForCharacter(j,void 0,{avatarModel:_e.avatarModel||void 0}).then(N=>{N.success&&N.character?(be(z=>!z||z.id!==I?z:{...z,avatars:N.character.avatars,physical:N.character.physical,clothing:N.character.clothing}),xe(z=>z.map(Se=>Se.id===I?{...Se,...N.character,id:Se.id}:Se)),i.success(`âœ… Avatar generated for ${j.name} (face selection)`)):(i.error(`âŒ Avatar generation failed: ${N.error}`),be(z=>z&&z.id===I?{...z,avatars:{status:"failed"}}:z),xe(z=>z.map(Se=>Se.id===I?{...Se,avatars:{status:"failed"}}:Se)))}).catch(N=>{i.error("âŒ Avatar generation error:",N),be(z=>z&&z.id===I?{...z,avatars:{status:"failed"}}:z),xe(z=>z.map(Se=>Se.id===I?{...Se,avatars:{status:"failed"}}:Se))}).finally(()=>{st(null)})}else i.info("â­ï¸ Skipping auto-generation: character has no name yet"),st(null),be(I=>I&&{...I,avatars:{status:"pending"}})}else i.warn("Photo analysis failed after face selection"),T(S.noFaceDetected)}catch(m){i.error("Photo analysis error after face selection:",m),T("Failed to analyze photo. Please try again.")}finally{Qt(!1),qa(null),Ka(null),Oa([])}},Ys=()=>{Wa(!1),qa(null),Ka(null),Oa([]),Oe("photo")},Xs=async()=>{if(g){be(a=>a&&{...a,avatars:void 0}),Gr(!0);try{i.info(`ðŸ”„ Regenerating avatars for ${g.name}...`);const a=await he.regenerateAvatarsForCharacter(g.id,(l,c)=>i.info(`[${l}] ${c}`),{avatarModel:_e.avatarModel||void 0});if(a.success&&a.character){const l={...a.character.avatars,stale:!1};be(c=>c&&{...c,avatars:l,physical:a.character.physical,clothing:a.character.clothing}),xe(c=>c.map(f=>f.id===g.id?{...f,avatars:l,physical:a.character.physical,clothing:a.character.clothing}:f)),i.success(`âœ… Avatars and traits regenerated for ${g.name}`)}else i.error(`âŒ Failed to regenerate avatars: ${a.error}`),T(`Failed to regenerate avatars: ${a.error||"Unknown error"}`)}catch(a){i.error(`âŒ Failed to regenerate avatars for ${g.name}:`,a),T(`Failed to regenerate avatars: ${a instanceof Error?a.message:"Unknown error"}`)}finally{Gr(!1)}}},ei=async()=>{var a,l,c,f,C,o,h,d,v,m,A,b,y,F,W,L;if(g){be(w=>w&&{...w,avatars:void 0}),la(!0);try{i.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${g.name}...`),i.info(`Physical traits: ${JSON.stringify(g.physical)}`);const w=await he.generateClothingAvatarsWithTraits(g);if(w.success&&w.avatars){const Q={...w.avatars,stale:!1,generatedAt:new Date().toISOString()},$=g.physicalTraitsSource||{},k=w.extractedTraits?{height:(a=g.physical)==null?void 0:a.height,eyeColor:$.eyeColor==="user"?(l=g.physical)==null?void 0:l.eyeColor:w.extractedTraits.eyeColor,eyeColorHex:$.eyeColor==="user"?(c=g.physical)==null?void 0:c.eyeColorHex:w.extractedTraits.eyeColorHex,hairColor:$.hairColor==="user"?(f=g.physical)==null?void 0:f.hairColor:w.extractedTraits.hairColor,hairColorHex:$.hairColor==="user"?(C=g.physical)==null?void 0:C.hairColorHex:w.extractedTraits.hairColorHex,hairLength:$.hairLength==="user"?(o=g.physical)==null?void 0:o.hairLength:w.extractedTraits.hairLength,hairStyle:$.hairStyle==="user"?(h=g.physical)==null?void 0:h.hairStyle:w.extractedTraits.hairStyle,build:$.build==="user"?(d=g.physical)==null?void 0:d.build:w.extractedTraits.build,face:$.face==="user"?(v=g.physical)==null?void 0:v.face:w.extractedTraits.face,facialHair:$.facialHair==="user"?(m=g.physical)==null?void 0:m.facialHair:w.extractedTraits.facialHair,other:$.other==="user"?(A=g.physical)==null?void 0:A.other:w.extractedTraits.other,skinTone:$.skinTone==="user"?(b=g.physical)==null?void 0:b.skinTone:w.extractedTraits.skinTone,skinToneHex:$.skinTone==="user"?(y=g.physical)==null?void 0:y.skinToneHex:w.extractedTraits.skinToneHex,detailedHairAnalysis:w.extractedTraits.detailedHairAnalysis||((F=g.physical)==null?void 0:F.detailedHairAnalysis),apparentAge:$.apparentAge==="user"?(W=g.physical)==null?void 0:W.apparentAge:w.extractedTraits.apparentAge||((L=g.physical)==null?void 0:L.apparentAge)}:g.physical,j=w.extractedTraits?{eyeColor:$.eyeColor==="user"?"user":w.extractedTraits.eyeColor?"extracted":void 0,hairColor:$.hairColor==="user"?"user":w.extractedTraits.hairColor?"extracted":void 0,hairLength:$.hairLength==="user"?"user":w.extractedTraits.hairLength?"extracted":void 0,hairStyle:$.hairStyle==="user"?"user":w.extractedTraits.hairStyle?"extracted":void 0,build:$.build==="user"?"user":w.extractedTraits.build?"extracted":void 0,face:$.face==="user"?"user":w.extractedTraits.face?"extracted":void 0,facialHair:$.facialHair==="user"?"user":w.extractedTraits.facialHair?"extracted":void 0,other:$.other==="user"?"user":w.extractedTraits.other?"extracted":void 0,skinTone:$.skinTone==="user"?"user":w.extractedTraits.skinTone?"extracted":void 0,apparentAge:$.apparentAge==="user"?"user":w.extractedTraits.apparentAge?"extracted":void 0}:g.physicalTraitsSource,I=w.extractedClothing?{...g.clothing,structured:{upperBody:w.extractedClothing.upperBody||void 0,lowerBody:w.extractedClothing.lowerBody||void 0,shoes:w.extractedClothing.shoes||void 0,fullBody:w.extractedClothing.fullBody||void 0}}:g.clothing;be(N=>N&&{...N,avatars:Q,physical:k,physicalTraitsSource:j,clothing:I}),xe(N=>N.map(z=>z.id===g.id?{...z,avatars:Q,physical:k,physicalTraitsSource:j,clothing:I}:z)),i.success(`âœ… Avatars WITH TRAITS regenerated for ${g.name}`),w.extractedTraits&&i.info(`ðŸ“‹ Extracted traits saved: ${JSON.stringify(w.extractedTraits)}`),w.extractedClothing&&i.info(`ðŸ‘• Extracted clothing saved: ${JSON.stringify(w.extractedClothing)}`)}else i.error(`âŒ Failed to regenerate avatars with traits: ${w.error}`),T(`Failed to regenerate avatars: ${w.error||"Unknown error"}`)}catch(w){i.error(`âŒ Failed to regenerate avatars with traits for ${g.name}:`,w),T(`Failed to regenerate avatars: ${w instanceof Error?w.message:"Unknown error"}`)}finally{la(!1)}}},ti=async()=>{var c,f,C,o,h,d,v,m,A,b,y,F,W,L,w,Q;if(!g)return;const a={...g},l=g.id;la(!0);try{i.info(`ðŸ’¾ Saving character and regenerating avatars for ${a.name}...`),await xr(),i.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${a.name}...`);const k=(await new Promise(I=>{xe(N=>(I(N),N))})).find(I=>I.id===l);if(!k){i.warn("Character not found in characters array after save");return}const j=await he.generateClothingAvatarsWithTraits(k);if(j.success&&j.avatars){const I={...j.avatars,stale:!1,generatedAt:new Date().toISOString()},N=k.physicalTraitsSource||{},z=j.extractedTraits?{height:(c=k.physical)==null?void 0:c.height,eyeColor:N.eyeColor==="user"?(f=k.physical)==null?void 0:f.eyeColor:j.extractedTraits.eyeColor,eyeColorHex:N.eyeColor==="user"?(C=k.physical)==null?void 0:C.eyeColorHex:j.extractedTraits.eyeColorHex,hairColor:N.hairColor==="user"?(o=k.physical)==null?void 0:o.hairColor:j.extractedTraits.hairColor,hairColorHex:N.hairColor==="user"?(h=k.physical)==null?void 0:h.hairColorHex:j.extractedTraits.hairColorHex,hairLength:N.hairLength==="user"?(d=k.physical)==null?void 0:d.hairLength:j.extractedTraits.hairLength,hairStyle:N.hairStyle==="user"?(v=k.physical)==null?void 0:v.hairStyle:j.extractedTraits.hairStyle,build:N.build==="user"?(m=k.physical)==null?void 0:m.build:j.extractedTraits.build,face:N.face==="user"?(A=k.physical)==null?void 0:A.face:j.extractedTraits.face,facialHair:N.facialHair==="user"?(b=k.physical)==null?void 0:b.facialHair:j.extractedTraits.facialHair,other:N.other==="user"?(y=k.physical)==null?void 0:y.other:j.extractedTraits.other,skinTone:N.skinTone==="user"?(F=k.physical)==null?void 0:F.skinTone:j.extractedTraits.skinTone,skinToneHex:N.skinTone==="user"?(W=k.physical)==null?void 0:W.skinToneHex:j.extractedTraits.skinToneHex,detailedHairAnalysis:j.extractedTraits.detailedHairAnalysis||((L=k.physical)==null?void 0:L.detailedHairAnalysis),apparentAge:N.apparentAge==="user"?(w=k.physical)==null?void 0:w.apparentAge:j.extractedTraits.apparentAge||((Q=k.physical)==null?void 0:Q.apparentAge)}:k.physical,Se=j.extractedTraits?{eyeColor:N.eyeColor==="user"?"user":j.extractedTraits.eyeColor?"extracted":void 0,hairColor:N.hairColor==="user"?"user":j.extractedTraits.hairColor?"extracted":void 0,hairLength:N.hairLength==="user"?"user":j.extractedTraits.hairLength?"extracted":void 0,hairStyle:N.hairStyle==="user"?"user":j.extractedTraits.hairStyle?"extracted":void 0,build:N.build==="user"?"user":j.extractedTraits.build?"extracted":void 0,face:N.face==="user"?"user":j.extractedTraits.face?"extracted":void 0,facialHair:N.facialHair==="user"?"user":j.extractedTraits.facialHair?"extracted":void 0,other:N.other==="user"?"user":j.extractedTraits.other?"extracted":void 0,skinTone:N.skinTone==="user"?"user":j.extractedTraits.skinTone?"extracted":void 0,apparentAge:N.apparentAge==="user"?"user":j.extractedTraits.apparentAge?"extracted":void 0}:k.physicalTraitsSource,R=j.extractedClothing?{...k.clothing,structured:{upperBody:j.extractedClothing.upperBody||void 0,lowerBody:j.extractedClothing.lowerBody||void 0,shoes:j.extractedClothing.shoes||void 0,fullBody:j.extractedClothing.fullBody||void 0}}:k.clothing;be(Ge=>Ge&&Ge.id===l?{...Ge,avatars:I,physical:z,physicalTraitsSource:Se,clothing:R}:Ge),xe(Ge=>Ge.map(Fe=>Fe.id===l?{...Fe,avatars:I,physical:z,physicalTraitsSource:Se,clothing:R}:Fe)),i.success(`âœ… Avatars regenerated for ${k.name}`);const pe={...k,avatars:I,physical:z,physicalTraitsSource:Se,clothing:R},Te=(await new Promise(Ge=>{xe(Fe=>(Ge(Fe),Fe))})).map(Ge=>Ge.id===l?pe:Ge);await he.saveCharacterData({characters:Te,relationships:qe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]}),i.success("ðŸ’¾ Character saved with new avatars, traits, and clothing"),Y(r==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else i.error(`âŒ Failed to regenerate avatars: ${j.error}`),T(`Failed to regenerate avatars: ${j.error||"Unknown error"}`)}catch($){i.error("âŒ Failed to save and regenerate:",$),T(`Failed: ${$ instanceof Error?$.message:"Unknown error"}`)}finally{la(!1)}},ai=async()=>{var f,C,o,h,d,v,m,A,b,y,F,W,L,w,Q,$,k,j;if(!g)return;const a=g.id;Br(void 0),Oe("traits");const l=(f=g.avatars)==null?void 0:f.status,c=!!((C=g.avatars)!=null&&C.standard||(o=g.avatars)!=null&&o.winter||(h=g.avatars)!=null&&h.summer||(d=g.avatars)!=null&&d.hasFullAvatars);if(l==="generating"||l==="complete"&&c){i.info(`â­ï¸ Skipping avatar generation - already ${l}${c?" with avatars":""}`);return}st(a),be(I=>I&&I.id===a?{...I,avatars:{status:"generating"}}:I),i.info(`ðŸŽ¨ Starting avatar generation for ${g.name||"unnamed"} (id: ${a})...`);try{const I=await he.generateClothingAvatarsWithTraits(g);if(I.success&&I.avatars){const N={...I.avatars,stale:!1,generatedAt:new Date().toISOString()},z=I.extractedTraits?{...g.physical,build:I.extractedTraits.build||((v=g.physical)==null?void 0:v.build),eyeColor:I.extractedTraits.eyeColor||((m=g.physical)==null?void 0:m.eyeColor),eyeColorHex:I.extractedTraits.eyeColorHex||((A=g.physical)==null?void 0:A.eyeColorHex),hairColor:I.extractedTraits.hairColor||((b=g.physical)==null?void 0:b.hairColor),hairColorHex:I.extractedTraits.hairColorHex||((y=g.physical)==null?void 0:y.hairColorHex),hairLength:I.extractedTraits.hairLength||((F=g.physical)==null?void 0:F.hairLength),hairStyle:I.extractedTraits.hairStyle||((W=g.physical)==null?void 0:W.hairStyle),facialHair:I.extractedTraits.facialHair||((L=g.physical)==null?void 0:L.facialHair),skinTone:I.extractedTraits.skinTone||((w=g.physical)==null?void 0:w.skinTone),skinToneHex:I.extractedTraits.skinToneHex||((Q=g.physical)==null?void 0:Q.skinToneHex),face:I.extractedTraits.face||(($=g.physical)==null?void 0:$.face),other:I.extractedTraits.other||((k=g.physical)==null?void 0:k.other),detailedHairAnalysis:I.extractedTraits.detailedHairAnalysis||((j=g.physical)==null?void 0:j.detailedHairAnalysis)}:g.physical,Se=I.extractedClothing?{...g.clothing,structured:{upperBody:I.extractedClothing.upperBody||void 0,lowerBody:I.extractedClothing.lowerBody||void 0,shoes:I.extractedClothing.shoes||void 0,fullBody:I.extractedClothing.fullBody||void 0}}:g.clothing;xe(R=>R.map(pe=>pe.id===a?{...pe,avatars:N,physical:z,clothing:Se}:pe)),be(R=>R&&R.id===a?{...R,avatars:N,physical:z,clothing:Se}:R),i.success(`âœ… Avatar generated for ${g.name} (id: ${a})`)}else i.error(`âŒ Failed to generate avatar: ${I.error}`),T(`Failed to generate avatar: ${I.error||"Unknown error"}`),xe(N=>N.map(z=>z.id===a?{...z,avatars:{status:"failed"}}:z)),be(N=>N&&N.id===a?{...N,avatars:{status:"failed"}}:N)}catch(I){i.error("âŒ Avatar generation failed:",I),T(`Avatar generation failed: ${I instanceof Error?I.message:"Unknown error"}`),xe(N=>N.map(z=>z.id===a?{...z,avatars:{status:"failed"}}:z)),be(N=>N&&N.id===a?{...N,avatars:{status:"failed"}}:N)}finally{st(null)}},xr=async()=>{var a;if(g){ee(!0);try{const l=Rr.current,c=$r.current;if(!l){i.warn("No current character to save");return}const f=l.id&&c.find(d=>d.id===l.id),C=f?c.map(d=>d.id===l.id?l:d):[...c,l];i.info("Saving characters with relationships:",C.length);const o=!f&&!!((a=l.photos)!=null&&a.original);await he.saveCharacterData({characters:C,relationships:qe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:o}),Rt.current=!1,i.success("Character data saved successfully"),xe(C),pr(C);const h=C.find(d=>d.id===g.id);h&&he.needsAvatars(h)&&Er!==h.id&&(i.info(`ðŸŽ¨ Starting background avatar generation for ${h.name}...`),he.generateAndSaveAvatarForCharacter(h,void 0,{avatarModel:_e.avatarModel||void 0}).then(d=>{d.success&&d.character?(xe(v=>v.map(m=>m.id===h.id?{...m,avatars:d.character.avatars,physical:d.character.physical,clothing:d.character.clothing}:m)),i.success(`âœ… Avatars and traits saved for ${h.name}`)):d.skipped||(i.warn(`Avatar generation failed for ${h.name}: ${d.error}`),xe(v=>v.map(m=>m.id===h.id?{...m,avatars:{status:"failed"}}:m)))}).catch(d=>{i.error(`âŒ Background avatar generation error for ${h.name}:`,d),xe(v=>v.map(m=>m.id===h.id?{...m,avatars:{status:"failed"}}:m))})),be(null),Va(!0)}catch(l){i.error("Failed to save character:",l),T(r==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":r==="fr"?"Ã‰chec de l'enregistrement du personnage. Veuillez rÃ©essayer.":"Failed to save character. Please try again.")}finally{ee(!1)}}},ri=async a=>{be({...a}),Oe("traits"),Va(!1);const l=await he.loadFullCharacter(a.id);l&&(be(c=>c&&c.id===a.id?{...c,...l}:c),xe(c=>c.map(f=>f.id===a.id?{...f,...l}:f)))},ni=async a=>{try{const l=await he.deleteCharacter(a);l.success?(xe(c=>c.filter(f=>f.id!==a)),da(c=>{const f={...c};return Object.keys(f).forEach(C=>{(C.includes(`${a}-`)||C.includes(`-${a}`))&&delete f[C]}),f}),Ja(c=>{const f={...c};return Object.keys(f).forEach(C=>{(C.includes(`${a}-`)||C.includes(`-${a}`))&&delete f[C]}),f}),mt(c=>c.filter(f=>f!==a)),ga.current=!0,i.success(`Character ${a} deleted`)):(i.error("Failed to delete character:",l.error),T(r==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character"))}catch(l){i.error("Failed to delete character:",l),T(r==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character")}},si=(a,l,c)=>{const C=Zi(c,r),o=`${a}-${l}`,h=`${l}-${a}`;i.debug("Updating relationship:",o,"=",c,", inverse:",h,"=",C),Rt.current=!0,da(d=>({...d,[o]:c,[h]:C}))},ii=(a,l)=>{Rt.current=!0;const[c,f]=a.split("-").map(Number),C=`${f}-${c}`;Ja(o=>({...o,[a]:l,[C]:l}))},oi=(a,l)=>{Rt.current=!0,zr(c=>[...c,{forward:a,inverse:l}])},li=(a,l)=>{l==="out"?(Zt(c=>c.includes(a)?c:[...c,a]),mt(c=>c.filter(f=>f!==a))):l==="in"?(Zt(c=>c.filter(f=>f!==a)),mt(c=>c.filter(f=>f!==a))):l==="main"&&(Zt(c=>c.filter(f=>f!==a)),mt(c=>c.includes(a)?c:[...c,a])),ga.current=!0,xe(c=>c.map(f=>f.id===a?{...f,storyRole:l}:f))},ci=async()=>{const[a,l,c]=await Promise.all([new Promise(C=>{xe(o=>(C(o),o))}),new Promise(C=>{mt(o=>(C(o),o))}),new Promise(C=>{Zt(o=>(C(o),o))})]);if(a.length===0)return;if(!ga.current){i.debug("Roles not modified, skipping save");return}const f={};for(const C of a)l.includes(C.id)?f[C.id]="main":c.includes(C.id)?f[C.id]="out":f[C.id]="in";try{await he.saveCharacterRoles(f),ga.current=!1}catch(C){i.error("Failed to save character roles:",C)}},ra=s.useRef(null),ct=async a=>{a>=0&&a<=7&&(E===1&&g&&a!==1&&await xr(),E===1&&a!==1&&(ra.current=(async()=>{await ui(),await ci()})(),ra.current.catch(l=>i.error("Background save failed:",l))),a===1&&E!==1&&be(null),X(a),window.scrollTo(0,0))},di=a=>a===1?!0:a===2||a===3?ae.length>0:a===4?ae.length>0&&fe!=="":a===5?ae.length>0&&fe!==""&&tt!=="":a===6?_t!=="":!1,Nt=()=>E===1?ae.length>0&&ht.length>0:E===2?!0:E===3?!(!fe||fe==="adventure"&&!De||(fe==="life-challenge"||fe==="educational")&&!Ie||fe==="historical"&&!Ie||fe==="custom"&&!(et!=null&&et.trim())):E===4?tt!=="":E===5?ae.filter(l=>!He.includes(l.id)).length>0&&ht.length>0&&St.trim().length>0:!1,ui=async()=>{const a=await new Promise(l=>{xe(c=>(l(c),c))});if(a.length!==0){if(!Rt.current){i.debug("Relationships not modified, skipping save");return}try{i.debug("Auto-saving character data with latest state..."),await he.saveCharacterData({characters:a,relationships:qe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]}),Rt.current=!1,i.debug("Character data auto-saved")}catch(l){i.error("Failed to auto-save character data:",l)}}},gi=async()=>{if(E<5&&Nt()){if(E===1&&ae.length===1){rr(!0);return}await ct(E+1)}},hn=async()=>{E>0&&await ct(E-1)},hi=(a,l)=>{Et(a),Vr(l??null)},mn=async()=>{Ct.current&&Ct.current.abort(),Yt(!0),Gt(!0),Bt(!0),Ft([]),er(null),tr(""),Vr(null);const a=ae.filter(l=>!He.includes(l.id));gs({storyType:gt,storyCategory:fe||"",storyTopic:Ie||"",storyTheme:De||"",characters:a.map(l=>({id:l.id,name:l.name})),language:rt,languageLevel:at,pages:Ue,userLocation:jt||void 0,season:kt||void 0}),Ct.current=ye.generateStoryIdeasStream({storyType:gt,storyTypeName:na(),storyCategory:fe||void 0,storyTopic:Ie||void 0,storyTheme:De||void 0,customThemeText:De==="custom"?et:void 0,language:rt,languageLevel:at,pages:Ue,characters:a.map(l=>({name:l.name,age:l.age,gender:l.gender,traits:l.traits,isMain:ht.includes(l.id)})),relationships:Object.entries(qe).map(([l,c])=>{const[f,C]=l.split("-").map(Number),o=a.find(d=>d.id===f),h=a.find(d=>d.id===C);return{character1:(o==null?void 0:o.name)||"",character2:(h==null?void 0:h.name)||"",relationship:c}}).filter(l=>l.character1&&l.character2),ideaModel:(x==null?void 0:x.role)==="admin"||Z?_e.ideaModel:void 0,userLocation:jt||void 0,season:kt},{onStatus:(l,c,f)=>{c&&f&&er({prompt:c,model:f})},onStory1:l=>{Ft(c=>{const f=[...c];return f[0]=l,f}),Ya(100),Gt(!1)},onStory2:l=>{Ft(c=>{const f=[...c];return f[1]=l,f}),Xa(100),Bt(!1)},onError:l=>{i.error("Failed to generate story ideas:",l),T(r==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":r==="fr"?"Erreur lors de la gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Failed to generate ideas. Please try again."),Yt(!1),Gt(!1),Bt(!1)},onDone:l=>{Yt(!1),Gt(!1),Bt(!1),l&&tr(l),Ct.current=null,i.info("[IDEAS] onDone complete")}})},na=()=>{const a=Cr.find(l=>l.id===gt);return a?a.name[r]:gt},Tt=async a=>{var c,f,C,o,h,d,v,m,A,b,y,F,W,L,w,Q;if(console.log("[generateStory] Called with overrides:",a),console.log("[generateStory] user:",x==null?void 0:x.email,"emailVerified:",x==null?void 0:x.emailVerified,"isImpersonating:",Z),ra.current&&(await ra.current,ra.current=null),!(a!=null&&a.skipEmailCheck)&&!Z&&x&&x.emailVerified!==!0){await U();const $=localStorage.getItem("currentUser");let k=x.emailVerified;if($)try{k=JSON.parse($).emailVerified}catch{}if(k===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",gt),localStorage.setItem("pending_art_style",tt),xa(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),Mt(!0),va(!1),X(6),ur({storyCategory:fe||void 0,storyTopic:Ie||void 0,storyTheme:De||void 0,storyTypeName:na(),storyDetails:St||void 0,artStyle:tt||void 0,language:rt||void 0,languageLevel:at||void 0,pages:Ue||void 0,dedication:bt||void 0,characters:ae.filter($=>!He.includes($.id)).map($=>({id:$.id,name:$.name})),mainCharacters:ht,relationships:qe,relationshipTexts:it,season:kt||void 0,userLocation:jt||void 0}),Xt(""),pt(""),Be([]),Ht([]),ja(null),hr.current=!1,ka({}),Ke({frontCover:null,initialPage:null,backCover:null});const l=ae.filter($=>!He.includes($.id)).filter($=>!$.avatars||$.avatars.stale||$.avatars.status!=="complete");if(l.length>0){console.log("[generateStory] Characters needing avatar regeneration:",l.map($=>$.name)),At({current:1,total:100,message:r==="de"?`Aktualisiere Avatare fÃ¼r ${l.length} Charakter(e)...`:r==="fr"?`Mise Ã  jour des avatars pour ${l.length} personnage(s)...`:`Updating avatars for ${l.length} character(s)...`});for(let $=0;$<l.length;$++){const k=l[$];try{console.log(`[generateStory] Regenerating avatars for ${k.name} (${$+1}/${l.length})`),At({current:2,total:100,message:r==="de"?`Generiere Avatare fÃ¼r ${k.name}...`:r==="fr"?`GÃ©nÃ©ration des avatars pour ${k.name}...`:`Generating avatars for ${k.name}...`});const j=await he.generateClothingAvatarsWithTraits(k);if(j.success&&j.avatars){const I={...j.avatars,stale:!1,generatedAt:new Date().toISOString()},N=k.physicalTraitsSource||{},z=j.extractedTraits?{...k.physical,height:(c=k.physical)==null?void 0:c.height,build:N.build==="user"?(f=k.physical)==null?void 0:f.build:j.extractedTraits.build,eyeColor:N.eyeColor==="user"?(C=k.physical)==null?void 0:C.eyeColor:j.extractedTraits.eyeColor,eyeColorHex:N.eyeColor==="user"?(o=k.physical)==null?void 0:o.eyeColorHex:j.extractedTraits.eyeColorHex,hairColor:N.hairColor==="user"?(h=k.physical)==null?void 0:h.hairColor:j.extractedTraits.hairColor,hairColorHex:N.hairColor==="user"?(d=k.physical)==null?void 0:d.hairColorHex:j.extractedTraits.hairColorHex,hairLength:N.hairLength==="user"?(v=k.physical)==null?void 0:v.hairLength:j.extractedTraits.hairLength,hairStyle:N.hairStyle==="user"?(m=k.physical)==null?void 0:m.hairStyle:j.extractedTraits.hairStyle,facialHair:N.facialHair==="user"?(A=k.physical)==null?void 0:A.facialHair:j.extractedTraits.facialHair,skinTone:N.skinTone==="user"?(b=k.physical)==null?void 0:b.skinTone:j.extractedTraits.skinTone,skinToneHex:N.skinTone==="user"?(y=k.physical)==null?void 0:y.skinToneHex:j.extractedTraits.skinToneHex,face:N.face==="user"?(F=k.physical)==null?void 0:F.face:j.extractedTraits.face,other:N.other==="user"?(W=k.physical)==null?void 0:W.other:j.extractedTraits.other,detailedHairAnalysis:j.extractedTraits.detailedHairAnalysis||((L=k.physical)==null?void 0:L.detailedHairAnalysis),apparentAge:N.apparentAge==="user"?(w=k.physical)==null?void 0:w.apparentAge:j.extractedTraits.apparentAge||((Q=k.physical)==null?void 0:Q.apparentAge)}:k.physical,Se=j.extractedTraits?{...N,build:N.build==="user"?"user":j.extractedTraits.build?"extracted":void 0,eyeColor:N.eyeColor==="user"?"user":j.extractedTraits.eyeColor?"extracted":void 0,hairColor:N.hairColor==="user"?"user":j.extractedTraits.hairColor?"extracted":void 0,hairLength:N.hairLength==="user"?"user":j.extractedTraits.hairLength?"extracted":void 0,hairStyle:N.hairStyle==="user"?"user":j.extractedTraits.hairStyle?"extracted":void 0,face:N.face==="user"?"user":j.extractedTraits.face?"extracted":void 0,facialHair:N.facialHair==="user"?"user":j.extractedTraits.facialHair?"extracted":void 0,other:N.other==="user"?"user":j.extractedTraits.other?"extracted":void 0,skinTone:N.skinTone==="user"?"user":j.extractedTraits.skinTone?"extracted":void 0,apparentAge:N.apparentAge==="user"?"user":j.extractedTraits.apparentAge?"extracted":void 0}:k.physicalTraitsSource,R=j.extractedClothing?{...k.clothing,structured:{upperBody:j.extractedClothing.upperBody||void 0,lowerBody:j.extractedClothing.lowerBody||void 0,shoes:j.extractedClothing.shoes||void 0,fullBody:j.extractedClothing.fullBody||void 0}}:k.clothing;xe(pe=>pe.map(O=>O.id===k.id?{...O,avatars:I,physical:z,physicalTraitsSource:Se,clothing:R}:O)),be(pe=>pe&&pe.id===k.id?{...pe,avatars:I,physical:z,physicalTraitsSource:Se,clothing:R}:pe),xe(pe=>{const O=pe.map(Te=>Te.id===k.id?{...Te,avatars:I,physical:z,physicalTraitsSource:Se,clothing:R}:Te);return he.saveCharacterData({characters:O,relationships:qe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(Te=>console.error("Failed to save avatar update:",Te)),O}),console.log(`[generateStory] âœ… Avatars regenerated for ${k.name}`)}else console.warn(`[generateStory] âš ï¸ Failed to regenerate avatars for ${k.name}: ${j.error}`)}catch(j){console.error(`[generateStory] âŒ Error regenerating avatars for ${k.name}:`,j)}}}At({current:5,total:100,message:r==="de"?"Starte Generierung...":r==="fr"?"DÃ©marrage de la gÃ©nÃ©ration...":"Starting generation..."});try{const $=ae.filter(R=>!He.includes(R.id)),{jobId:k,creditsRemaining:j}=await ye.createStoryJob({storyType:gt,storyTypeName:na(),storyCategory:fe||void 0,storyTopic:Ie||void 0,storyTheme:De||void 0,customThemeText:De==="custom"?et:void 0,artStyle:tt,language:rt,languageLevel:at,pages:Ue,dedication:bt,storyDetails:St,characters:$,mainCharacters:ht,relationships:qe,relationshipTexts:it,skipImages:(a==null?void 0:a.skipImages)??H,imageGenMode:de,generationMode:ke!=="auto"?ke:void 0,skipOutline:Ae,skipText:Le,skipSceneDescriptions:Re,skipCovers:ve,enableQualityRetry:Ce,enableAutoRepair:ze,useGridRepair:sa,forceRepairThreshold:Fa,enableFinalChecks:Ar,checkOnlyMode:Tr,enableSceneValidation:Pr,separatedEvaluation:Ir,incrementalConsistency:Ut?{enabled:!0,dryRun:Nr,lookbackCount:Dt}:void 0,modelOverrides:(x==null?void 0:x.role)==="admin"||Z?{outlineModel:_e.outlineModel,textModel:_e.textModel,sceneDescriptionModel:_e.sceneDescriptionModel,imageModel:_e.imageModel,coverImageModel:_e.coverImageModel,qualityModel:_e.qualityModel}:void 0,userLocation:jt||void 0,season:kt||void 0,ideaGeneration:Wr&&ya&&ft.length>0?{input:Wr,output:ft,rawResponse:Hr,prompt:ya.prompt,model:ya.model,selectedIndex:us}:void 0});Ca(k),i.info("Story job created:",k),ne(k,na()||"New Story"),j!=null&&D(j);let I=!1,N=0,z=Date.now();const Se=180*1e3;for(zt(!1);!I;){await new Promise(pe=>setTimeout(pe,2e3));const R=await ye.getJobStatus(k);if(R.progress&&(R.progress.current!==N?(i.debug(`Progress: ${R.progress.current}% - ${R.progress.message||""}`),N=R.progress.current,z=Date.now(),zt(!1)):Date.now()-z>=Se&&zt(!0),At(pe=>R.progress.current>=pe.current?R.progress:R.progress.message?{...pe,message:R.progress.message}:pe)),R.partialCovers){let pe=!1;Ke(O=>{var Ge,Fe,Ia;const Te={...O};if((Ge=R.partialCovers)!=null&&Ge.frontCover&&!O.frontCover){Te.frontCover=R.partialCovers.frontCover,i.debug("Front cover received during streaming");const Xe=R.partialCovers.frontCover;typeof Xe=="object"&&(Xe!=null&&Xe.storyTitle)&&(pt(Xe.storyTitle),i.debug(`Story title from front cover: ${Xe.storyTitle}`)),pe=!0}return(Fe=R.partialCovers)!=null&&Fe.initialPage&&!O.initialPage&&(Te.initialPage=R.partialCovers.initialPage,i.debug("Initial page cover received during streaming")),(Ia=R.partialCovers)!=null&&Ia.backCover&&!O.backCover&&(Te.backCover=R.partialCovers.backCover,i.debug("Back cover received during streaming")),Te}),pe&&(i.debug("Transitioning to StoryDisplay - front cover ready"),X(6))}if(R.storyText&&!hr.current&&(hr.current=!0,ja(R.storyText),pt(R.storyText.title),i.info(`Story text loaded: ${R.storyText.totalPages} pages`)),R.partialPages&&R.partialPages.length>0&&ka(pe=>{var Ge;const O={...pe};let Te=0;return(Ge=R.partialPages)==null||Ge.forEach(Fe=>{Fe.imageData&&!pe[Fe.pageNumber]&&(O[Fe.pageNumber]=Fe.imageData,Te++)}),Te>0&&i.debug(`${Te} new page images received (total: ${Object.keys(O).length})`),O}),R.status==="completed"&&R.result)cr(R.result.storyId),pt(R.result.title),Qr(R.result.outline),Zr(R.result.outlinePrompt||""),Yr(R.result.outlineModelId),Xr(R.result.outlineUsage),en(R.result.storyTextPrompts||[]),sr(R.result.styledAvatarGeneration||[]),ir(R.result.costumedAvatarGeneration||[]),or(R.result.generationLog||[]),lr(R.result.finalChecksReport||null),R.result.visualBible?Lt({mainCharacters:R.result.visualBible.mainCharacters||[],secondaryCharacters:R.result.visualBible.secondaryCharacters||[],animals:R.result.visualBible.animals||[],artifacts:R.result.visualBible.artifacts||[],locations:R.result.visualBible.locations||[],vehicles:R.result.visualBible.vehicles||[],clothing:R.result.visualBible.clothing||[],changeLog:R.result.visualBible.changeLog||[]}):Lt(null),R.result.clothingRequirements?Sa(R.result.clothingRequirements):Sa(null),Xt(R.result.story),Jr(R.result.story),Ht(R.result.sceneDescriptions||[]),Be(R.result.sceneImages||[]),Ke(R.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),ja(null),ka({}),I=!0,R.currentCredits!==null&&R.currentCredits!==void 0&&D(R.currentCredits),X(6),i.success("Story generation completed!"),ur({storyCategory:fe||void 0,storyTopic:Ie||void 0,storyTheme:De||void 0,storyTypeName:na(),storyDetails:St||void 0,artStyle:tt||void 0,language:rt||void 0,languageLevel:at||void 0,pages:Ue||void 0,dedication:bt||void 0,characters:ae.map(pe=>({id:pe.id,name:pe.name})),mainCharacters:ht,relationships:qe,relationshipTexts:it,season:kt||void 0,userLocation:jt||void 0}),gr.current=!0,Dr&&on(R.result.storyId),le();else if(R.status==="failed")throw new Error(R.error||"Story generation failed")}At({current:100,total:100,message:r==="de"?"Fertig!":r==="fr"?"TerminÃ©!":"Complete!"})}catch($){i.error("Generation failed:",$);const k=$ instanceof Error?$.message:String($);if(k.includes("already in progress")){const j=k.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),I=j?j[1]:null,N=r==="de"?"Eine Geschichte wird bereits erstellt. MÃ¶chtest du diese abbrechen und eine neue starten?":r==="fr"?"Une histoire est dÃ©jÃ  en cours de crÃ©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(I&&window.confirm(N))try{await ye.cancelJob(I),i.info("Cancelled existing job:",I),await Tt(a);return}catch(z){i.error("Failed to cancel existing job:",z),T(r==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es spÃ¤ter erneut.":r==="fr"?"Ã‰chec de l'annulation. Veuillez rÃ©essayer plus tard.":"Failed to cancel. Please try again later.")}Mt(!1);return}else T(r==="de"?`Generierung fehlgeschlagen: ${k}`:r==="fr"?`Ã‰chec de la gÃ©nÃ©ration: ${k}`:`Generation failed: ${k}`)}finally{zt(!1),le(),setTimeout(()=>Mt(!1),500)}};s.useEffect(()=>{if(Pa.current&&G&&ae.length>0&&E===5&&!ot){Pa.current=!1;const a=localStorage.getItem("verificationGenerationStarted");if(a){const c=parseInt(a,10),f=Date.now()-120*1e3;if(c>f){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await U(),setTimeout(()=>{Tt({skipEmailCheck:!0})},500)})()}},[G,ae,E,ot,U]);const mi=()=>{switch(E){case 1:return t.jsx(lo,{characters:ae,currentCharacter:g,characterStep:es,showCharacterCreated:Xn,isLoading:V,isAnalyzingPhoto:ts,isGeneratingAvatar:Er===(g==null?void 0:g.id),isRegeneratingAvatars:as,isRegeneratingAvatarsWithTraits:rs,developerMode:te,isImpersonating:Z,changedTraits:ns,photoAnalysisDebug:ss,mainCharacters:ht,excludedCharacters:He,onCharacterRoleChange:li,onCharacterChange:be,onCharacterStepChange:Oe,onContinueToAvatar:()=>Oe("avatar"),onPhotoSelect:Qs,onSaveAndGenerateAvatar:ai,onSaveCharacter:xr,onEditCharacter:ri,onDeleteCharacter:ni,onStartNewCharacter:vr,onRegenerateAvatars:Xs,onRegenerateAvatarsWithTraits:ei,onSaveAndRegenerateWithTraits:ti,onSaveAndTryNewPhoto:async()=>{var f;if(i.info(`ðŸ“¸ onSaveAndTryNewPhoto called, currentCharacter: ${g==null?void 0:g.name}`),!g){i.warn("ðŸ“¸ No currentCharacter, returning early");return}ee(!0);try{const C=g.id&&ae.find(d=>d.id===g.id),o=C?ae.map(d=>d.id===g.id?g:d):[...ae,g],h=!C&&!!((f=g.photos)!=null&&f.original);await he.saveCharacterData({characters:o,relationships:qe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:h}),xe(o),pr(o),i.info(`ðŸ“¸ Setting characterStep to 'photo', currentCharacter still: ${g==null?void 0:g.name}`),Oe("photo")}catch(C){i.error("ðŸ“¸ Error saving character:",C)}finally{ee(!1),i.info("ðŸ“¸ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:qe,relationshipTexts:it,onRelationshipChange:si,onRelationshipTextChange:ii,customRelationships:$t,onAddCustomRelationship:oi});case 2:return t.jsx(co,{languageLevel:at,onLanguageLevelChange:ha,pages:Ue,onPagesChange:Za,storyLanguage:rt,onStoryLanguageChange:Lr,developerMode:te,userLocation:jt,onLocationChange:Or,season:kt,onSeasonChange:hs,userCredits:Z?-1:(x==null?void 0:x.credits)??0});case 3:return t.jsx(uo,{storyCategory:fe,storyTopic:Ie,storyTheme:De,customThemeText:et,onCategoryChange:Vs,onTopicChange:Os,onThemeChange:Ws,onCustomThemeTextChange:La,onLegacyStoryTypeChange:Kt});case 4:return t.jsx(go,{artStyle:tt,onArtStyleChange:qs});case 5:return t.jsx(ho,{characters:ae,mainCharacters:ht,excludedCharacters:He,storyCategory:fe,storyTopic:Ie,storyTheme:De,customThemeText:et,onCustomThemeTextChange:La,artStyle:tt,storyLanguage:rt,languageLevel:at,pages:Ue,userLocation:jt,season:kt,storyDetails:St,onStoryDetailsChange:Et,dedication:bt,onDedicationChange:ma,onGenerateIdeas:mn,isGeneratingIdeas:wt,isGeneratingIdea1:fa,isGeneratingIdea2:pa,ideaProgress1:cs,ideaProgress2:ds,ideaPrompt:ya,ideaFullResponse:Hr,generatedIdeas:ft,onSelectIdea:hi,onUseDirectly:()=>Tt(),onEditStep:ct,developerMode:te,imageGenMode:de,onImageGenModeChange:se,generationMode:ke,onGenerationModeChange:Me});case 6:const a=yt.frontCover||yt.initialPage||Object.keys(mr).length>0||wa.some(f=>f.imageData),l=wa.some(f=>f.hasImage)||yt.frontCover&&typeof yt.frontCover=="object"&&yt.frontCover.hasImage;if(_t&&a||Je&&a||ot&&a||ba&&l){const f=_t?wa:Object.entries(mr).map(([o,h])=>{var d;return{pageNumber:parseInt(o),imageData:h,description:((d=Je==null?void 0:Je.sceneDescriptions.find(v=>v.pageNumber===parseInt(o)))==null?void 0:d.description)||""}}),C=_t||Object.entries((Je==null?void 0:Je.pageTexts)||{}).sort(([o],[h])=>parseInt(o)-parseInt(h)).map(([o,h])=>`--- Page ${o} ---
${h}`).join(`

`);return t.jsxs(t.Fragment,{children:[nt&&nt.total>0&&t.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[t.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${nt.loaded/nt.total*100}%`}})}),t.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:r==="de"?`Bilder: ${nt.loaded}/${nt.total}`:r==="fr"?`Images: ${nt.loaded}/${nt.total}`:`Images: ${nt.loaded}/${nt.total}`})]}),te&&q&&!ot&&t.jsx(s.Suspense,{fallback:t.jsx("div",{className:"p-4 text-gray-500",children:"Loading repair panel..."}),children:t.jsx(oo,{storyId:q,sceneImages:f,characters:ae.filter(o=>!He.includes(o.id)),finalChecksReport:tn,imageModel:_e.imageModel||void 0,onImageUpdate:(o,h,d)=>{Be(v=>v.map(m=>m.pageNumber===o?{...m,imageData:h,imageVersions:[...m.imageVersions||[],{imageData:h,createdAt:new Date().toISOString(),isActive:!0,type:"repair"}].map((A,b,y)=>({...A,isActive:b===y.length-1}))}:m))},onRefreshStory:q?async()=>{try{i.info("Refreshing story data after repair...");const o=await ye.getStory(q);o&&(Be(o.sceneImages||[]),lr(o.finalChecksReport||null),i.success("Story data refreshed"))}catch(o){i.error("Failed to refresh story:",o)}}:void 0,autoRunFullWorkflow:Ls===q,onAutoRunComplete:()=>on(null),developerMode:te,useMagicApiRepair:Jn,setUseMagicApiRepair:Qn})}),t.jsx(s.Suspense,{fallback:t.jsx("div",{className:"py-12 flex justify-center",children:t.jsx(ut,{className:"w-8 h-8 text-indigo-600 animate-spin"})}),children:t.jsx(io,{title:ba,dedication:bt||void 0,story:C,originalStory:ws,outline:Cs,outlinePrompt:js,outlineModelId:ks,outlineUsage:As,storyTextPrompts:Ns,visualBible:Ts||void 0,sceneImages:f,sceneDescriptions:(Je==null?void 0:Je.sceneDescriptions)||Rs,characters:Yn||ae.filter(o=>!He.includes(o.id)),progressiveMode:ot,progressiveData:Je||void 0,completedPageImages:mr,coverImages:yt,regeneratingCovers:ms,languageLevel:at,storyLanguage:rt,isGenerating:ot,developerMode:te,styledAvatarGeneration:Is,costumedAvatarGeneration:Ds,generationLog:$s,finalChecksReport:tn,clothingRequirements:Ps||void 0,storyId:q,onVisualBibleChange:q?async o=>{try{i.info("Updating Visual Bible for story:",q),await ye.updateVisualBible(q,o),Lt(o),i.success("Visual Bible updated successfully")}catch(h){i.error("Failed to update Visual Bible:",h),T(r==="de"?"Visual Bible konnte nicht aktualisiert werden":r==="fr"?"Ã‰chec de la mise Ã  jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:q?async(o,h,d)=>{var v;try{i.info("Regenerating image for page:",o,h?"(scene edited)":"",d?`(${d.length} characters)`:"");const m=await ye.regenerateImage(q,o,h,d);if(i.info("Regenerate result:",{hasImageData:!!(m!=null&&m.imageData),length:(v=m==null?void 0:m.imageData)==null?void 0:v.length,versionCount:m==null?void 0:m.versionCount,creditsRemaining:m==null?void 0:m.creditsRemaining}),!(m!=null&&m.imageData))throw i.error("No imageData in response!",m),new Error("No image data returned from server");Be(A=>A.map(b=>b.pageNumber===o?{...b,imageData:m.imageData,description:m.newDescription||b.description,prompt:m.newPrompt,qualityScore:m.qualityScore,qualityReasoning:m.qualityReasoning,totalAttempts:m.totalAttempts,retryHistory:m.retryHistory,wasRegenerated:!0,originalImage:m.originalImage,originalScore:m.originalScore,originalReasoning:m.originalReasoning,imageVersions:m.imageVersions||b.imageVersions,referencePhotos:m.referencePhotos||b.referencePhotos,landmarkPhotos:m.landmarkPhotos||b.landmarkPhotos,visualBibleGrid:m.visualBibleGrid||b.visualBibleGrid}:b)),m.creditsRemaining!==void 0&&D&&D(m.creditsRemaining),i.info("Image regenerated successfully, updated state")}catch(m){i.error("Image regeneration failed:",m);const A=m instanceof Error?m.message:String(m);T(r==="de"?`Bildgenerierung fehlgeschlagen: ${A}`:r==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${A}`:`Image regeneration failed: ${A}`)}}:void 0,onDownloadTxt:()=>{const o=new Blob([_t],{type:"text/plain"}),h=URL.createObjectURL(o),d=document.createElement("a");d.href=h,d.download=`${ba}.txt`,d.click(),URL.revokeObjectURL(h)},onDownloadPdf:q?async o=>{try{const h=await ye.generatePdf(q,o),d=URL.createObjectURL(h),v=document.createElement("a");v.href=d,v.download=`${ba}.pdf`,v.click(),URL.revokeObjectURL(d)}catch(h){i.error("PDF download failed:",h),T(r==="de"?"PDF-Download fehlgeschlagen":r==="fr"?"Ã‰chec du tÃ©lÃ©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:q?()=>{try{const o=sessionStorage.getItem("mystories_selected"),h=o?JSON.parse(o):[];h.includes(q)||(h.push(q),sessionStorage.setItem("mystories_selected",JSON.stringify(h))),i.info("Added story to book selection:",q),Y(r==="de"?"Geschichte zum Buch hinzugefÃ¼gt. Du kannst weitere hinzufÃ¼gen oder das Buch bestellen.":r==="fr"?"Histoire ajoutÃ©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",r==="de"?"Zum Buch hinzugefÃ¼gt":r==="fr"?"AjoutÃ© au livre":"Added to Book"),e("/stories")}catch(o){i.error("Failed to add story to selection:",o)}}:void 0,onPrintBook:q?async()=>{let o=await Bi.getShippingAddress();if(!o){const v=prompt(r==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":r==="fr"?"Aucune adresse enregistrÃ©e. Veuillez entrer (Format: PrÃ©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!v)return;const m=v.split(",").map(A=>A.trim());if(m.length<7){T(r==="de"?"UngÃ¼ltiges Adressformat":r==="fr"?"Format d'adresse invalide":"Invalid address format");return}o={firstName:m[0],lastName:m[1],addressLine1:m[2],postCode:m[3],city:m[4],country:m[5],email:m[6]}}const h=`${o.firstName} ${o.lastName}
${o.addressLine1}
${o.postCode} ${o.city}
${o.country}`,d=r==="de"?`Druckauftrag an folgende Adresse senden?

${h}`:r==="fr"?`Envoyer la commande Ã  cette adresse?

${h}`:`Send print order to this address?

${h}`;if(confirm(d))try{i.info("Creating print order for story:",q);const v=await ye.createPrintOrder(q,{firstName:o.firstName,lastName:o.lastName,addressLine1:o.addressLine1,city:o.city,postCode:o.postCode,country:o.country,email:o.email||""}),m=r==="de"?`âœ… Druckauftrag erfolgreich erstellt!

Order ID: ${v.orderId}
${v.isDraft?"(Entwurf - muss in Gelato bestÃ¤tigt werden)":""}

MÃ¶chten Sie das Gelato Dashboard Ã¶ffnen, um den Auftrag zu verfolgen?`:r==="fr"?`âœ… Commande d'impression crÃ©Ã©e avec succÃ¨s!

ID de commande: ${v.orderId}
${v.isDraft?"(Brouillon - doit Ãªtre confirmÃ© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`âœ… Print order created successfully!

Order ID: ${v.orderId}
${v.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;v.dashboardUrl&&confirm(m)?window.open(v.dashboardUrl,"_blank"):v.dashboardUrl||Y(r==="de"?`Druckauftrag erstellt! Order ID: ${v.orderId}`:r==="fr"?`Commande crÃ©Ã©e! ID: ${v.orderId}`:`Print order created! Order ID: ${v.orderId}`)}catch(v){i.error("Print order failed:",v);const m=v instanceof Error?v.message:String(v);T(r==="de"?`Druckauftrag fehlgeschlagen: ${m}`:r==="fr"?`Ã‰chec de la commande d'impression: ${m}`:`Print order failed: ${m}`)}}:void 0,onCreateAnother:()=>{i.info("Creating new story - resetting settings"),cr(null),Ca(null),Ha(null);const o=new URLSearchParams(n);o.delete("storyId"),u(o,{replace:!0}),Xt(""),pt(""),Ht([]),Be([]),Ke({frontCover:null,initialPage:null,backCover:null}),an(!1),rn(void 0),nn(void 0),sn(void 0),Kt(""),Ma(""),za(""),_a(""),Jt("watercolor"),ha("standard"),Za(30),ma(""),Et(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),be(null),Oe("photo"),X(1)},onRegenerateCover:q?async(o,h,d,v,m)=>{const A=o==="front"?"frontCover":o==="back"?"backCover":"initialPage";try{i.info("Regenerating cover:",o,h?`with scene: "${h.substring(0,50)}..."`:"",d?`with ${d.length} characters`:""),qr(y=>new Set(y).add(A));const b=await ye.regenerateCover(q,o,h,d,v,m);Ke(y=>y&&{...y,[o==="front"?"frontCover":o==="back"?"backCover":"initialPage"]:{imageData:b.imageData,description:b.description,prompt:b.prompt,qualityScore:b.qualityScore,qualityReasoning:b.qualityReasoning,totalAttempts:b.totalAttempts,retryHistory:b.retryHistory,referencePhotos:b.referencePhotos,wasRegenerated:b.wasRegenerated,regenerationCount:b.regenerationCount,previousImage:b.previousImage,previousScore:b.previousScore,originalImage:b.originalImage,originalScore:b.originalScore,modelId:b.modelId,imageVersions:b.imageVersions}}),b.creditsRemaining!==void 0&&D&&D(b.creditsRemaining),i.info("Cover regenerated successfully")}catch(b){i.error("Cover regeneration failed:",b);const y=b instanceof Error?b.message:String(b);T(r==="de"?`Cover-Generierung fehlgeschlagen: ${y}`:r==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${y}`:`Cover regeneration failed: ${y}`)}finally{qr(b=>{const y=new Set(b);return y.delete(A),y})}}:void 0,onEditImage:o=>{Na({type:"image",pageNumber:o}),ta(""),Aa(!0)},onEditCover:o=>{Na({type:"cover",coverType:o}),ta(""),Aa(!0)},onRepairImage:q&&((x==null?void 0:x.role)==="admin"||Z)?async o=>{var h,d,v;try{i.info("Starting auto-repair for page:",o);const m=wa.find(y=>y.pageNumber===o);let A=m==null?void 0:m.fixTargets;if(!A||A.length===0){const y=(d=(h=m==null?void 0:m.retryHistory)==null?void 0:h.filter(F=>F.type==="auto_repair"))==null?void 0:d.slice(-1)[0];(v=y==null?void 0:y.preRepairEval)!=null&&v.fixTargets&&y.preRepairEval.fixTargets.length>0&&(A=y.preRepairEval.fixTargets,i.info(`Using ${A.length} fix targets from retryHistory.preRepairEval`))}A&&A.length>0?i.info(`Using ${A.length} existing fix targets`):i.info("No stored fix targets found, will re-evaluate");const b=await ye.repairImage(q,o,A);b.repaired?(Be(y=>y.map(F=>F.pageNumber===o?{...F,imageData:b.imageData,wasAutoRepaired:!0,repairHistory:b.repairHistory,repairedAt:new Date().toISOString()}:F)),i.info("Auto-repair completed successfully:",{repaired:b.repaired,repairs:b.repairHistory.length})):b.noErrorsFound&&i.info("No physics errors detected in the image")}catch(m){throw i.error("Auto-repair failed:",m),m}}:void 0,onIteratePage:q&&((x==null?void 0:x.role)==="admin"||Z)?async(o,h)=>{var d;try{i.info("Starting iteration for page:",o,"imageModel:",_e.imageModel,"options:",h);const v=await ye.iteratePage(q,o,_e.imageModel||void 0,h);v.success&&(Be(m=>m.map(A=>{var b;if(A.pageNumber===o){const y=A.imageVersions||[],F=(b=v.imageVersions)==null?void 0:b.map((W,L)=>{var w;return{imageData:W.imageData||((w=y[L])==null?void 0:w.imageData)||"",description:W.description,prompt:W.prompt,modelId:W.modelId,createdAt:W.createdAt||new Date().toISOString(),isActive:W.isActive??!1,type:W.type,qualityScore:W.qualityScore}});return{...A,imageData:v.imageData,description:v.sceneDescription,prompt:v.imagePrompt,qualityScore:v.qualityScore,qualityReasoning:v.qualityReasoning,wasIterated:!0,iteratedAt:new Date().toISOString(),iterationFeedback:v.composition,previewMismatches:v.previewMismatches,imageVersions:F||A.imageVersions}}return A})),Ht(m=>m.map(A=>A.pageNumber===o?{...A,description:v.sceneDescription,iteratedAt:new Date().toISOString()}:A)),i.info("Iteration completed successfully:",{mismatches:((d=v.previewMismatches)==null?void 0:d.length)||0,score:v.qualityScore,message:v.message}))}catch(v){throw i.error("Iteration failed:",v),v}}:void 0,onRevertRepair:q&&((x==null?void 0:x.role)==="admin"||Z)?async(o,h)=>{try{i.info("Reverting repair for page:",o),Be(d=>d.map(v=>v.pageNumber===o?{...v,imageData:h,wasAutoRepaired:!1}:v)),await ye.updateSceneImage(q,o,h),i.info("Repair reverted successfully")}catch(d){throw i.error("Failed to revert repair:",d),d}}:void 0,onSaveStoryText:q?async o=>{try{i.info("Saving story text for story:",q),await ye.saveStoryText(q,o),Xt(o),i.info("Story text saved successfully")}catch(h){throw i.error("Failed to save story text:",h),h}}:void 0,onSaveTitleChange:q?async o=>{try{i.info("Saving title for story:",q,o),await ye.saveStoryTitle(q,o),pt(o),i.info("Title saved successfully")}catch(h){throw i.error("Failed to save title:",h),h}}:void 0,userCredits:Z?-1:(x==null?void 0:x.credits)||0,imageRegenerationCost:5,isImpersonating:Z,onSelectImageVersion:q?async(o,h)=>{try{i.info("Selecting image version:",{pageNumber:o,versionIndex:h});const d=await ye.setActiveImage(q,o,h);Be(v=>v.map(m=>{if(m.pageNumber===o&&m.imageVersions){if(h<0||h>=m.imageVersions.length)return i.error(`Invalid versionIndex ${h} for page ${o} (max: ${m.imageVersions.length-1})`),m;const A=m.imageVersions[h];return A!=null&&A.imageData?{...m,imageData:A.imageData,...A.qualityScore!==void 0&&{qualityScore:A.qualityScore},...A.qualityReasoning!==void 0&&{qualityReasoning:A.qualityReasoning},...A.fixTargets!==void 0&&{fixTargets:A.fixTargets},...A.prompt!==void 0&&{prompt:A.prompt},...A.description!==void 0&&{description:A.description},...A.totalAttempts!==void 0&&{totalAttempts:A.totalAttempts},...A.modelId!==void 0&&{modelId:A.modelId},imageVersions:m.imageVersions.map((b,y)=>({...b,isActive:y===h}))}:(i.error(`Version ${h} has no imageData for page ${o}`),m)}return m})),i.info("Image version selected:",d)}catch(d){throw i.error("Failed to select image version:",d),d}}:void 0,onSelectCoverVersion:q?async(o,h)=>{try{i.info("Selecting cover version:",{coverType:o,versionIndex:h});const d=await ye.setActiveCoverImage(q,o,h);Ke(v=>{if(!v)return v;const m=v[o];if(!m)return v;const A=m;if(!A.imageVersions)return v;if(h<0||h>=A.imageVersions.length)return i.error(`Invalid versionIndex ${h} for ${o} (max: ${A.imageVersions.length-1})`),v;const b=A.imageVersions[h];return b!=null&&b.imageData?{...v,[o]:{...A,imageData:b.imageData,imageVersions:A.imageVersions.map((y,F)=>({...y,isActive:F===h}))}}:(i.error(`Version ${h} has no imageData for ${o}`),v)}),i.info("Cover version selected:",d)}catch(d){throw i.error("Failed to select cover version:",d),d}}:void 0,isPartial:Bs,failureReason:Fs,generatedPages:Ms,totalPages:zs,generationSettings:_s||void 0,onRefreshStory:q?async()=>{if(i.info("Refreshing story data:",q),vt.current=!1,Gs(o=>o+1),te)try{const o=await ye.getStoryDevMetadata(q);Ta(o),vt.current=!0,i.info("Dev metadata refreshed after repair")}catch(o){i.warn("Failed to refresh dev metadata:",o)}}:void 0})})]})}return n.get("storyId")?t.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[t.jsx(ut,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),t.jsx("p",{className:"text-gray-600 font-medium",children:r==="de"?"Geschichte wird geladen...":r==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):ot?t.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),t.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:r==="de"?"Geschichte wird erstellt...":r==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),t.jsx("p",{className:"text-indigo-500 mt-2",children:r==="de"?"Einen Moment Geduld bitte":r==="fr"?"Veuillez patienter":"Please wait a moment"})]}):t.jsxs("div",{className:"text-center py-12",children:[t.jsx(Ot,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),t.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:S.generateStory}),t.jsx("p",{className:"text-gray-600 mb-6",children:r==="de"?"Bereit, deine Geschichte zu erstellen!":r==="fr"?"PrÃªt Ã  crÃ©er votre histoire!":"Ready to create your story!"}),t.jsxs(Ga,{onClick:()=>Tt(),size:"lg",icon:Ot,children:[S.generateStory," (",Ue*10," Credits)"]})]});default:return null}};return G?t.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[t.jsx(Si,{currentStep:E,onStepClick:ct,canAccessStep:di,developerMode:te,onDeveloperModeChange:oe,hideSteps:E===6&&!!q,onShowGenerationProgress:()=>{va(!1),X(6)}}),t.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:t.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[V&&!ot&&E!==6?t.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[t.jsx(ut,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),t.jsx("p",{className:"text-gray-600 font-medium mb-2",children:p?r==="de"?"Geschichte wird geladen...":r==="fr"?"Chargement de l'histoire...":"Loading story...":r==="de"?"Wird geladen...":r==="fr"?"Chargement...":"Loading..."}),p&&t.jsxs("div",{className:"w-64 mt-2",children:[t.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:p.total?`${Math.min(100,p.loaded/p.total*100)}%`:"100%"}})}),t.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[(p.loaded/(1024*1024)).toFixed(1)," MB",p.total&&t.jsxs("span",{children:[" (",Math.round(p.loaded/p.total*100),"%)"]})]})]})]}):t.jsxs(t.Fragment,{children:[E>=1&&E<=5&&!g&&t.jsx(_i,{step:E,text:(Dn[r]||Dn.en)[E]}),t.jsx(s.Suspense,{fallback:t.jsx(pn,{}),children:mi()})]}),E<6&&!g&&t.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[E===1&&ae.length>=2&&!Us()&&(()=>{const a=Ks();if(!a)return null;const l=r==="de"?`${a.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:r==="fr"?`${a.name} a des relations non dÃ©finies ("ne connaÃ®t pas")`:`${a.name} has undefined relationships ("not known to")`;return t.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[t.jsx("span",{className:"text-amber-600 text-lg",children:"âš ï¸"}),t.jsx("p",{className:"text-amber-700 text-sm",children:l})]})})(),E!==5&&t.jsxs("div",{className:`flex ${E===1?"justify-end":"justify-between"}`,children:[E>1&&t.jsxs("button",{onClick:hn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[t.jsx(bn,{size:20})," ",S.back]}),t.jsxs("button",{onClick:gi,disabled:!Nt(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${Nt()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[S.next," ",t.jsx(Ti,{size:20})]})]}),E===5&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("button",{onClick:()=>Tt(),disabled:!Nt(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Nt()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[t.jsx(Ot,{size:20})," ",S.generateStory," (",Ue*10," Credits)"]}),te&&t.jsxs("button",{onClick:()=>Tt({skipImages:!0}),disabled:!Nt(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Nt()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[t.jsx(Ot,{size:20}),r==="de"?"Nur Text generieren (ohne Bilder)":r==="fr"?"GÃ©nÃ©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),te&&t.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[t.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["ðŸ› ï¸ ",r==="de"?"Entwickler-Optionen - Schritte Ã¼berspringen":r==="fr"?"Options dÃ©veloppeur - Sauter des Ã©tapes":"Developer Options - Skip Steps"]}),t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Ae,onChange:a=>Ne(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Gliederung Ã¼berspringen":r==="fr"?"Sauter le plan":"Skip outline generation"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Le,onChange:a=>me(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Text Ã¼berspringen":r==="fr"?"Sauter le texte":"Skip text generation"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Re,onChange:a=>ue(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Szenenbeschreibungen Ã¼berspringen":r==="fr"?"Sauter les descriptions de scÃ¨nes":"Skip scene descriptions"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:H,onChange:a=>P(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Bilder Ã¼berspringen":r==="fr"?"Sauter les images":"Skip image generation"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:ve,onChange:a=>$e(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Cover Ã¼berspringen":r==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),t.jsx("p",{className:"text-xs text-orange-600 mt-2",children:r==="de"?"Hinweis: Ãœbersprungene Schritte verwenden Platzhalter/leere Daten":r==="fr"?"Note: Les Ã©tapes sautÃ©es utiliseront des donnÃ©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),t.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["ðŸ”§ ",r==="de"?"Feature-Optionen":r==="fr"?"Options de fonctionnalitÃ©s":"Feature Options"]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Ce,onChange:a=>We(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"QualitÃ¤ts-Retry":r==="fr"?"RÃ©essai qualitÃ©":"Quality retry (regenerate if score < 50%)"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"Regeneriert Bilder automatisch bis zu 3x wenn QualitÃ¤tsscore unter 50%":r==="fr"?"RÃ©gÃ©nÃ¨re automatiquement les images jusqu'Ã  3x si le score qualitÃ© est infÃ©rieur Ã  50%":"Automatically regenerates images up to 3x when quality score is below 50%"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:ze,onChange:a=>xt(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Auto-Reparatur aktivieren":r==="fr"?"Activer la rÃ©paration auto":"Enable auto-repair"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":r==="fr"?"Essaie de corriger automatiquement les erreurs d'image dÃ©tectÃ©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),ze&&t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[t.jsx("input",{type:"checkbox",checked:sa,onChange:a=>ia(a.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Grid-Reparatur verwenden":r==="fr"?"Utiliser la rÃ©paration en grille":"Use grid repair"})]}),ze&&t.jsx("p",{className:"text-xs text-gray-500 ml-12",children:r==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":r==="fr"?"Extrait les rÃ©gions problÃ©matiques dans une grille, rÃ©pare avec Gemini, vÃ©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),ze&&t.jsxs("div",{className:"mt-2 ml-6",children:[t.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[t.jsx("span",{children:r==="de"?"Reparatur-Schwelle:":r==="fr"?"Seuil de rÃ©paration:":"Force repair threshold:"}),t.jsxs("select",{value:Fa===null?"default":Fa,onChange:a=>zn(a.target.value==="default"?null:parseInt(a.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[t.jsx("option",{value:"default",children:r==="de"?"Standard (nur bei Fehler)":r==="fr"?"DÃ©faut (seulement si erreur)":"Default (only on failure)"}),t.jsx("option",{value:"100",children:r==="de"?"100% (immer reparieren)":r==="fr"?"100% (toujours rÃ©parer)":"100% (always repair)"}),t.jsx("option",{value:"90",children:"90%"}),t.jsx("option",{value:"80",children:"80%"}),t.jsx("option",{value:"75",children:"75%"})]})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die QualitÃ¤tsprÃ¼fung bestehen":r==="fr"?"Ã€ 100%, toutes les pages avec des problÃ¨mes sont rÃ©parÃ©es, mÃªme si elles passent le contrÃ´le qualitÃ©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Ar,onChange:a=>_n(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"KonsistenzprÃ¼fung aktivieren":r==="fr"?"Activer la vÃ©rification de cohÃ©rence":"Enable final checks"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"PrÃ¼ft Bilder und Text auf Konsistenz am Ende der Generierung":r==="fr"?"VÃ©rifie la cohÃ©rence des images et du texte Ã  la fin de la gÃ©nÃ©ration":"Checks images and text for consistency at end of generation"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Pr,onChange:a=>On(a.target.checked),className:"rounded border-cyan-300 text-cyan-600 focus:ring-cyan-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Szenen-Validierung":r==="fr"?"Validation de scÃ¨ne":"Scene validation"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"Erzeugt gÃ¼nstige Vorschau, prÃ¼ft Geometrie, repariert Kompositionsprobleme":r==="fr"?"GÃ©nÃ¨re un aperÃ§u Ã©conomique, vÃ©rifie la gÃ©omÃ©trie, rÃ©pare les problÃ¨mes de composition":"Generates cheap preview, checks geometry, repairs composition issues"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Ir,onChange:a=>qn(a.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Getrennte Auswertung":r==="fr"?"Ã‰valuation sÃ©parÃ©e":"Separated evaluation"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"Erzeugt alle Bilder zuerst, dann wertet alle parallel aus und repariert":r==="fr"?"GÃ©nÃ¨re toutes les images d'abord, puis Ã©value et rÃ©pare en parallÃ¨le":"Generates all images first, then evaluates and repairs in batch"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Dr,onChange:a=>Un(a.target.checked),className:"rounded border-purple-300 text-purple-600 focus:ring-purple-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Volle Reparatur nach Generierung":r==="fr"?"RÃ©paration complÃ¨te aprÃ¨s gÃ©nÃ©ration":"Full repair after generation"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"FÃ¼hrt nach der Generierung den kompletten Reparatur-Workflow aus (bis zu 4 Versuche pro Seite)":r==="fr"?"ExÃ©cute le workflow de rÃ©paration complet aprÃ¨s la gÃ©nÃ©ration (jusqu'Ã  4 tentatives par page)":"Runs the full repair workflow after generation (up to 4 retries per page)"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Ut,onChange:a=>Ln(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Inkrementelle Konsistenz":r==="fr"?"CohÃ©rence incrÃ©mentielle":"Incremental consistency"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"PrÃ¼ft jedes Bild gegen vorherige Bilder wÃ¤hrend der Generierung":r==="fr"?"VÃ©rifie chaque image par rapport aux images prÃ©cÃ©dentes pendant la gÃ©nÃ©ration":"Checks each image against previous images during generation"}),Ut&&t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[t.jsx("input",{type:"checkbox",checked:Nr,onChange:a=>Hn(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Nur Protokoll (Dry Run)":r==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),Ut&&t.jsx("p",{className:"text-xs text-gray-500 ml-12",children:r==="de"?"Zeigt nur an, was repariert wÃ¼rde, ohne tatsÃ¤chlich zu reparieren":r==="fr"?"Affiche uniquement ce qui serait rÃ©parÃ© sans effectuer de rÃ©parations":"Shows what would be fixed without actually fixing"}),Ut&&t.jsxs("div",{className:"mt-2 ml-6",children:[t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-gray-700 text-sm",children:r==="de"?"Vergleichsfenster:":r==="fr"?"FenÃªtre de comparaison:":"Lookback window:"}),t.jsx("input",{type:"range",min:"1",max:"5",value:Dt,onChange:a=>Vn(parseInt(a.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),t.jsx("span",{className:"text-gray-600 font-medium w-4",children:Dt})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r==="de"?`Vergleicht jedes Bild mit den ${Dt} vorherigen`:r==="fr"?`Compare chaque image avec les ${Dt} prÃ©cÃ©dentes`:`Compares each image with the previous ${Dt}`})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[t.jsx("input",{type:"checkbox",checked:Tr,onChange:a=>Wn(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Nur PrÃ¼fung (keine Regenerierung)":r==="fr"?"VÃ©rification seule (pas de rÃ©gÃ©nÃ©ration)":"Check only (no regeneration)"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"FÃ¼hrt alle QualitÃ¤tsprÃ¼fungen durch, Ã¼berspringt aber Regenerierung/Reparatur":r==="fr"?"ExÃ©cute toutes les vÃ©rifications de qualitÃ© mais ignore la rÃ©gÃ©nÃ©ration/rÃ©paration":"Runs all quality checks but skips regeneration/repair"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:oa,onChange:a=>Kn(a.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:r==="de"?"Alle Avatare laden":r==="fr"?"Charger tous les avatars":"Load all avatars"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:r==="de"?"LÃ¤dt alle Avatar-Varianten (30MB+). NÃ¼tzlich zum Debuggen.":r==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le dÃ©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),te&&((x==null?void 0:x.role)==="admin"||Z)&&t.jsx(Oi,{selections:_e,onChange:Zn}),t.jsxs("button",{onClick:hn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[t.jsx(bn,{size:20})," ",S.back]})]})]})]})}),ot&&!_t&&!Je&&!yt.frontCover&&!ps&&t.jsx(Li,{current:nr.current,total:nr.total,message:nr.message,coverImages:yt,characters:ae,jobId:dr||void 0,isStalled:Ss,onDismissStalled:()=>zt(!1),isImpersonating:Z,onMinimize:()=>ar(!0),onCancel:dr?async()=>{try{await ye.cancelJob(dr),i.info("Job cancelled by user"),Mt(!1),Ca(null),zt(!1),At({current:0,total:0,message:""}),M(r==="de"?"Generierung abgebrochen":r==="fr"?"GÃ©nÃ©ration annulÃ©e":"Generation cancelled")}catch(a){i.error("Failed to cancel job:",a),T(r==="de"?"Abbruch fehlgeschlagen":r==="fr"?"Ã‰chec de l'annulation":"Failed to cancel")}}:void 0}),ys&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[t.jsx("h3",{className:"text-lg font-semibold mb-2",children:r==="de"?"Geschichte wird im Hintergrund generiert":r==="fr"?"Histoire en cours de gÃ©nÃ©ration":"Story generating in background"}),t.jsx("p",{className:"text-gray-600 mb-6",children:r==="de"?"Was mÃ¶chtest du tun?":r==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:()=>{va(!0),ar(!1),e("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:r==="de"?"Neue Geschichte erstellen":r==="fr"?"CrÃ©er une autre histoire":"Create another story"}),xs&&t.jsx("button",{onClick:()=>{va(!0),ar(!1),e("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:r==="de"?"Meine Geschichten lesen":r==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),vs&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[t.jsx("h3",{className:"text-lg font-semibold mb-2",children:r==="de"?"Nur ein Charakter":r==="fr"?"Un seul personnage":"Only One Character"}),t.jsx("p",{className:"text-gray-600 mb-6",children:r==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":r==="fr"?"Les histoires sont plus intÃ©ressantes avec plusieurs personnages. Vous n'avez crÃ©Ã© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:()=>{rr(!1),vr()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:r==="de"?"Weiteren Charakter erstellen":r==="fr"?"CrÃ©er un autre personnage":"Create another character"}),t.jsx("button",{onClick:async()=>{rr(!1),await ct(E+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:r==="de"?"Trotzdem weiter":r==="fr"?"Continuer quand mÃªme":"Continue anyway"})]})]})}),fs&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[t.jsx("div",{className:"relative inline-block mb-4",children:t.jsx(ut,{size:40,className:"animate-spin text-indigo-600"})}),t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:r==="de"?"Bild wird erstellt...":r==="fr"?"CrÃ©ation de l'image...":"Generating image..."}),t.jsx("p",{className:"text-sm text-gray-500 mt-2",children:r==="de"?"Dies dauert etwa 30 Sekunden":r==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),Hs&&Ee&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:r==="de"?"Bild bearbeiten":r==="fr"?"Modifier l'image":"Edit Image"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4",children:Ee.type==="image"?r==="de"?`Seite ${Ee.pageNumber}`:r==="fr"?`Page ${Ee.pageNumber}`:`Page ${Ee.pageNumber}`:r==="de"?Ee.coverType==="front"?"Titelseite":Ee.coverType==="back"?"RÃ¼ckseite":"Einleitungsseite":r==="fr"?Ee.coverType==="front"?"Couverture":Ee.coverType==="back"?"Dos":"Page de dÃ©dicace":Ee.coverType==="front"?"Front Cover":Ee.coverType==="back"?"Back Cover":"Dedication Page"}),t.jsx("textarea",{value:ea,onChange:a=>ta(a.target.value),placeholder:r==="de"?`Beschreibe die gewÃ¼nschte Ã„nderung...
z.B. "Mach den Himmel blauer" oder "FÃ¼ge einen Schmetterling hinzu"`:r==="fr"?`DÃ©crivez le changement souhaitÃ©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),t.jsxs("div",{className:"flex gap-3 mt-4",children:[t.jsx("button",{onClick:()=>{Aa(!1),Na(null),ta("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:r==="de"?"Abbrechen":r==="fr"?"Annuler":"Cancel"}),t.jsx("button",{onClick:async()=>{if(!(!ea.trim()||!q)){Aa(!1),Ur(!0);try{if(Ee.type==="image"&&Ee.pageNumber){const a=await ye.editImage(q,Ee.pageNumber,ea);if(i.info("Edit result:",{hasImageData:!!(a!=null&&a.imageData),score:a==null?void 0:a.qualityScore}),!(a!=null&&a.imageData))throw i.error("No imageData in edit response!",a),new Error("No image data returned from server");Be(l=>l.map(c=>c.pageNumber===Ee.pageNumber?{...c,imageData:a.imageData,qualityScore:a.qualityScore,qualityReasoning:a.qualityReasoning,wasEdited:!0,originalImage:a.originalImage,originalScore:a.originalScore,originalReasoning:a.originalReasoning}:c)),i.info("Image edited successfully, updated state with quality info")}else if(Ee.type==="cover"&&Ee.coverType){const a=await ye.editCover(q,Ee.coverType,ea);Ke(l=>{if(!l)return l;const c=Ee.coverType==="front"?"frontCover":Ee.coverType==="back"?"backCover":"initialPage",f=l[c],C={...typeof f=="object"?f:{},imageData:a.imageData,qualityScore:a.qualityScore,qualityReasoning:a.qualityReasoning,wasEdited:!0,originalImage:a.originalImage,originalScore:a.originalScore,originalReasoning:a.originalReasoning};return{...l,[c]:C}}),i.info("Cover edited successfully with quality info")}}catch(a){i.error("Edit failed:",a),T(r==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":r==="fr"?"Ã‰chec de la modification. Veuillez rÃ©essayer.":"Edit failed. Please try again.")}finally{Ur(!1),Na(null),ta("")}}},disabled:!ea.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:r==="de"?"Bearbeiten":r==="fr"?"Modifier":"Edit"})]})]})}),t.jsx(Xi,{isOpen:os,faces:Mr,onSelect:Zs,onUploadNew:Ys,developerMode:te}),t.jsx(Ji,{isOpen:bs,onClose:()=>xa(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const a=localStorage.getItem("verificationGenerationStarted");if(a){const l=parseInt(a,10),c=Date.now()-120*1e3;if(l>c){console.log("[EmailVerification] Another window started recently, skipping"),xa(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),Tt({skipEmailCheck:!0}),xa(!1)}})]}):t.jsx(pn,{fullScreen:!0})}const zo=Object.freeze(Object.defineProperty({__proto__:null,default:mo},Symbol.toStringTag,{value:"Module"}));export{$i as P,Ei as S,Gi as U,Bn as a,Io as b,he as c,Go as d,Bo as e,Zi as f,Qi as g,Ro as h,An as i,Fo as j,Eo as k,$o as l,Mo as m,Tn as n,Pn as o,Do as p,In as q,kr as r,Po as s,Cr as t,To as u,zo as v};
