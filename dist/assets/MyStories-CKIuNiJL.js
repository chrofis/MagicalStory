import{c as ce,u as me,a as ue,e as ge,h as he,d as xe,s as D,j as e,g as te,T as re,L as fe,E as pe}from"./index-DaP2Tl0H.js";import{u as be,e as ve,b as i}from"./vendor-react-CqfXSjHo.js";import{N as ye}from"./Textarea-DcBDJMR1.js";import"./Input-DSjmUZrv.js";import{MAX_BOOK_PAGES as je}from"./Pricing-v-bodRZu.js";import{B as K}from"./book-BZDuoS8O.js";import{B as q}from"./book-open-C1IOUBEH.js";import{T as Se}from"./trash-2-D1CFhGZ7.js";import"./vendor-firebase-DTVMaYMy.js";import"./sparkles-CdgXFGBf.js";import"./arrow-left-Cfk7EeaY.js";import"./check-gGx6DPOc.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=ce("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),f=xe("MyStories");let d={data:null,total:0,timestamp:0,userId:null};const Ne=300*1e3,ke=6,se=18,Pe=i.memo(function({storyTitle:r,progress:u,language:t,onView:N}){const y=u.total>0?Math.round(u.current/u.total*100):0;return e.jsxs("div",{onClick:N,className:"bg-white rounded-xl shadow-md overflow-hidden transition-all flex flex-col hover:shadow-lg ring-2 ring-indigo-400 cursor-pointer",children:[e.jsxs("div",{className:"relative w-full h-48 bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 flex items-center justify-center overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"}),e.jsx(fe,{size:48,className:"animate-spin text-indigo-600"})]}),e.jsxs("div",{className:"p-4 flex flex-col flex-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 mb-1 truncate",children:r||(t==="de"?"Wird erstellt...":t==="fr"?"Création en cours...":"Generating...")}),e.jsx("p",{className:"text-sm text-indigo-600 mb-3",children:u.message||(t==="de"?"Starte...":t==="fr"?"Démarrage...":"Starting...")})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-500",style:{width:`${y}%`}})}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1 text-center",children:[y,"%"]})]})]})]})}),Ce=i.memo(function({story:r,language:u,onView:t,onDelete:N,formatDate:y,isSelected:h,onToggleSelect:T,onLoadCover:A,t:M}){const[g,H]=i.useState(!1),[m,j]=i.useState(!1),[w,C]=i.useState(!1),[k,E]=i.useState(!1),P=i.useRef(null);return i.useEffect(()=>{const x=new IntersectionObserver(([_])=>{_.isIntersecting&&(C(!0),x.disconnect())},{rootMargin:"100px"});return P.current&&x.observe(P.current),()=>x.disconnect()},[]),i.useEffect(()=>{w&&r.hasThumbnail&&!r.thumbnail&&!k&&(E(!0),A(r.id))},[w,r.hasThumbnail,r.thumbnail,r.id,k,A]),e.jsxs("div",{ref:P,className:`bg-white rounded-xl shadow-md overflow-hidden transition-all flex flex-col hover:shadow-lg ${r.isPartial?"ring-2 ring-amber-400":""} ${h?"ring-8 ring-green-500":""}`,children:[e.jsxs("div",{className:"relative",children:[w&&r.thumbnail&&!m?e.jsxs("div",{className:"relative w-full h-48 bg-gray-100",children:[!g&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 spinner"})}),e.jsx("img",{src:r.thumbnail,alt:r.title,className:`w-full h-48 object-cover transition-opacity duration-300 ${g?"opacity-100":"opacity-0"}`,onLoad:()=>H(!0),onError:()=>j(!0)})]}):!w||r.hasThumbnail&&!r.thumbnail&&!m?e.jsx("div",{className:"relative w-full h-48 bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 spinner"})}):e.jsx("div",{className:"relative w-full h-48 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center",children:e.jsx(K,{className:"w-12 h-12 text-indigo-300"})}),r.isPartial&&e.jsxs("div",{className:"absolute top-2 left-2 bg-amber-500 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1",children:[e.jsx(re,{size:12}),u==="de"?"Teilweise":u==="fr"?"Partiel":"Partial"]}),e.jsx("button",{onClick:x=>{x.stopPropagation(),N()},className:"absolute top-2 right-2 p-2 bg-white/90 text-red-600 hover:bg-red-100 rounded-lg shadow-sm",children:e.jsx(Se,{size:16})})]}),e.jsxs("div",{className:"p-4 flex flex-col flex-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:r.title}),r.isPartial?e.jsxs("p",{className:"text-sm text-amber-600 mb-3",children:[r.generatedPages||0,"/",r.totalPages||r.pages," ",u==="de"?"Seiten generiert":u==="fr"?"pages générées":"pages generated"," • ",y(r.created_at||r.createdAt)]}):e.jsxs("p",{className:"text-sm text-gray-500 mb-3",children:[r.pageCount||r.pages," ",u==="de"?"Seiten":"pages"," • ",y(r.created_at||r.createdAt)]})]}),e.jsxs("div",{className:"flex gap-2 mt-auto",children:[e.jsxs("button",{onClick:x=>{x.stopPropagation(),t()},className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",children:[e.jsx(pe,{size:18}),u==="de"?"Ansehen":u==="fr"?"Voir":"View"]}),!r.isPartial&&e.jsx("button",{onClick:x=>{x.stopPropagation(),T()},className:`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${h?"bg-red-600 text-white hover:bg-red-700":"bg-green-600 text-white hover:bg-green-700"}`,children:h?M.remove:M.add})]})]})]})});function Oe(){const b=be(),[r,u]=ve(),{language:t}=me(),{isAuthenticated:N,isLoading:y,user:h}=ue(),{showSuccess:T,showInfo:A,showError:M}=ge(),g=he(),H=(g==null?void 0:g.activeJob)&&!(g!=null&&g.isComplete)&&!(g!=null&&g.error),[m,j]=i.useState([]),[w,C]=i.useState(!0),[k,E]=i.useState(!1),[P,x]=i.useState(!1),[_,z]=i.useState(0),[W,U]=i.useState(null),B=i.useRef(!1),[S,V]=i.useState(()=>{try{const s=sessionStorage.getItem("mystories_selected");if(s)return new Set(JSON.parse(s))}catch{}return new Set});i.useEffect(()=>{sessionStorage.setItem("mystories_selected",JSON.stringify([...S]))},[S]),i.useEffect(()=>{if(m.length>0&&S.size>0){const s=new Set(m.map(n=>n.id)),a=[...S].filter(n=>s.has(n));a.length!==S.size&&(f.debug(`Cleaning up stale selection: ${S.size} -> ${a.length}`),V(new Set(a)))}},[m]),i.useEffect(()=>{(async()=>{const a=r.get("payment"),n=r.get("session_id");if(a==="success"&&n){f.info("Payment successful! Checking order status...");try{const l=await D.getOrderStatus(n);if(f.info("Order Status:",l),l.order){V(new Set),sessionStorage.removeItem("mystories_selected");const $=`CHF ${(l.order.amount_total/100).toFixed(2)}`,v=l.order.tokens_credited||0,G={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement réussi!"},O={en:v>0?`Your book order has been received and will be printed soon. You earned ${v} tokens!`:"Your book order has been received and will be printed soon.",de:v>0?`Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt. Sie haben ${v} Tokens erhalten!`:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:v>0?`Votre commande de livre a été reçue et sera bientôt imprimée. Vous avez gagné ${v} jetons!`:"Votre commande de livre a été reçue et sera bientôt imprimée."},R=[`${t==="de"?"Kunde":t==="fr"?"Client":"Customer"}: ${l.order.customer_name}`,`Email: ${l.order.customer_email}`,`${t==="de"?"Betrag":t==="fr"?"Montant":"Amount"}: ${$}`,...v>0?[`${t==="de"?"Tokens erhalten":t==="fr"?"Jetons gagnés":"Tokens earned"}: ${v}`]:[],`${t==="de"?"Versand an":t==="fr"?"Expédié à":"Shipping to"}: ${l.order.shipping_name}`,`${l.order.shipping_address_line1}`,`${l.order.shipping_postal_code} ${l.order.shipping_city}`,`${l.order.shipping_country}`];T(O[t]||O.en,G[t]||G.en,R)}}catch(l){f.error("Error checking order status:",l)}const o=new URLSearchParams(r);o.delete("payment"),o.delete("session_id"),u(o,{replace:!0})}else if(a==="cancelled"){f.info("Payment cancelled by user");const o={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie können es erneut versuchen.",fr:"Paiement annulé. Vous pouvez réessayer quand vous êtes prêt."};A(o[t]||o.en,t==="de"?"Abgebrochen":t==="fr"?"Annulé":"Cancelled");const l=new URLSearchParams(r);l.delete("payment"),u(l,{replace:!0})}})()},[r,u,t,T,A]);const X={en:{myStories:"My Stories",createStory:"Create Story",noStories:"No stories created yet",seePricing:"See Pricing",selectHint:"Select stories to create a book",selected:"selected",pages:"pages",createBook:"Create Book",tooManyPages:"Too many pages (max 100)",add:"Add",remove:"Remove",loadAll:"Load All"},de:{myStories:"Meine Geschichten",createStory:"Geschichte erstellen",noStories:"Noch keine Geschichten erstellt",seePricing:"Preise ansehen",selectHint:"Wähle Geschichten, um ein Buch zu erstellen",selected:"ausgewählt",pages:"Seiten",createBook:"Buch erstellen",tooManyPages:"Zu viele Seiten (max. 100)",add:"Hinzufügen",remove:"Entfernen",loadAll:"Alle laden"},fr:{myStories:"Mes histoires",createStory:"Créer une histoire",noStories:"Aucune histoire créée",seePricing:"Voir les tarifs",selectHint:"Sélectionnez des histoires pour créer un livre",selected:"sélectionné(s)",pages:"pages",createBook:"Créer le livre",tooManyPages:"Trop de pages (max 100)",add:"Ajouter",remove:"Retirer",loadAll:"Tout charger"}},c=X[t]||X.en;i.useEffect(()=>{const s=(h==null?void 0:h.id)||null;d.userId!==null&&d.userId!==s&&(f.debug(`User changed (${d.userId} -> ${s}), clearing stories`),j([]),z(0),B.current=!1,d={data:null,total:0,timestamp:0,userId:null})},[h==null?void 0:h.id]),i.useEffect(()=>{if(!y){if(!N){b("/");return}B.current||(B.current=!0,F())}},[N,y,b]);const F=async(s={})=>{const{loadMore:a=!1,loadAll:n=!1}=s,o=Date.now();f.debug("Loading stories...",{loadMore:a,loadAll:n});try{U(null);const l=Date.now(),$=(h==null?void 0:h.id)||null,v=d.data&&d.userId===$&&l-d.timestamp<Ne;if(!a&&!n&&v){const Z=Math.round((l-d.timestamp)/1e3);f.debug(`Using cached stories (${d.data.length} stories, cache age: ${Z}s, user: ${$})`),j(d.data),z(d.total),x(d.data.length<d.total),C(!1);return}a||n?E(!0):C(!0);const G=a||n?m.length:0,O=n?1e3:ke,{stories:R,pagination:L}=await D.getStories({limit:O,offset:G}),de=Date.now()-o;f.info(`Loaded ${R.length} stories in ${de}ms (total: ${L.total})`);const Y=R;a||n?j(Z=>{const ee=[...Z,...Y];return d={data:ee,total:L.total,timestamp:l,userId:$},ee}):(j(Y),d={data:Y,total:L.total,timestamp:l,userId:$}),z(L.total),x(L.hasMore)}catch(l){f.error("Failed to load stories:",l),U(t==="de"?"Geschichten konnten nicht geladen werden":t==="fr"?"Impossible de charger les histoires":"Failed to load stories"),d={data:null,total:0,timestamp:0,userId:null}}finally{C(!1),E(!1)}};i.useEffect(()=>{!w&&!k&&P&&m.length<se&&m.length>0&&F({loadMore:!0})},[m.length,P,w,k]);const ae=i.useCallback(async s=>{try{const a=await D.getStoryCover(s),n=o=>o.id===s?{...o,thumbnail:a||void 0,hasThumbnail:!!a}:o;j(o=>o.map(n)),d.data&&(d.data=d.data.map(n))}catch(a){f.error("Failed to load cover for story:",s,a);const n=o=>o.id===s?{...o,hasThumbnail:!1}:o;j(o=>o.map(n)),d.data&&(d.data=d.data.map(n))}},[]),ne=async s=>{if(confirm(t==="de"?"Diese Geschichte wirklich löschen?":t==="fr"?"Voulez-vous vraiment supprimer cette histoire?":"Are you sure you want to delete this story?"))try{await D.deleteStory(s);const n=m.filter(o=>o.id!==s);j(n),z(o=>Math.max(0,o-1)),d={data:n,total:Math.max(0,_-1),timestamp:Date.now(),userId:(h==null?void 0:h.id)||null},V(o=>{const l=new Set(o);return l.delete(s),l})}catch(n){f.error("Failed to delete story:",n),M(t==="de"?"Geschichte konnte nicht gelöscht werden. Bitte versuche es erneut.":t==="fr"?"Impossible de supprimer l'histoire. Veuillez réessayer.":"Failed to delete story. Please try again.")}},ie=i.useCallback(s=>{if(!s)return"";try{return new Date(s).toLocaleDateString(t==="de"?"de-DE":t==="fr"?"fr-FR":"en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return""}},[t]),oe=s=>{V(a=>{const n=new Set(a);return n.has(s)?n.delete(s):n.add(s),n})},p=i.useMemo(()=>m.filter(s=>S.has(s.id)),[m,S]),J=i.useMemo(()=>p.reduce((s,a)=>s+(a.pageCount||a.pages),0),[p]),I=J>je,Q=()=>{const s=p.map(a=>({id:a.id,title:a.title,pages:a.pageCount||a.pages,thumbnail:a.thumbnail}));b("/book-builder",{state:{selectedStories:s}})};if(y||!N)return e.jsx(te,{fullScreen:!0});const le=m.filter(s=>!s.isPartial).length>=1;return e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-24",children:[e.jsx(ye,{currentStep:0}),e.jsxs("div",{className:"px-4 md:px-8 py-4 md:py-8 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-bold text-gray-800 flex items-center justify-center md:justify-start gap-2",children:[e.jsx(K,{size:24,className:"md:w-7 md:h-7"}),c.myStories]}),e.jsxs("div",{className:"flex items-center justify-center md:justify-end gap-2",children:[e.jsxs("button",{onClick:()=>b("/pricing"),className:"flex items-center gap-1 px-2 md:px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 font-medium transition-colors",title:c.seePricing,children:[e.jsx(we,{size:18}),e.jsx("span",{className:"hidden md:inline",children:c.seePricing})]}),le&&e.jsxs("button",{onClick:Q,disabled:p.length===0||I,className:"flex items-center gap-1 px-3 md:px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:c.createBook,children:[e.jsx(q,{size:18}),e.jsx("span",{className:"text-sm md:text-base",children:c.createBook}),p.length>0&&e.jsx("span",{className:"bg-white text-indigo-600 text-xs px-1.5 py-0.5 rounded-full",children:p.length})]}),e.jsx("button",{onClick:()=>b("/create?new=true"),className:"flex items-center gap-1 px-3 md:px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors",title:c.createStory,children:e.jsx("span",{className:"text-sm md:text-base",children:c.createStory})})]})]}),m.length>0&&e.jsxs("div",{className:"hidden md:flex bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 items-center gap-3",children:[e.jsx(q,{size:20,className:"text-blue-600 flex-shrink-0"}),e.jsx("p",{className:"text-blue-800 text-sm",children:c.selectHint}),p.length>0&&e.jsxs("span",{className:`ml-auto text-sm font-medium ${I?"text-red-600":"text-blue-600"}`,children:[p.length," ",c.selected," • ",J," ",c.pages,I&&` (${c.tooManyPages})`]})]}),w?e.jsx(te,{message:t==="de"?"Laden...":t==="fr"?"Chargement...":"Loading..."}):W?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(re,{className:"w-16 h-16 text-amber-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700 text-lg mb-4",children:W}),e.jsx("button",{onClick:()=>{B.current=!1,U(null),C(!0),F()},className:"px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:t==="de"?"Erneut versuchen":t==="fr"?"Réessayer":"Try Again"})]}):m.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(K,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg",children:c.noStories}),e.jsx("button",{onClick:()=>b("/create?new=true"),className:"mt-4 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:c.createStory})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[H&&(g==null?void 0:g.activeJob)&&e.jsx(Pe,{storyTitle:g.activeJob.storyTitle,progress:g.progress,language:t,onView:()=>b("/create")}),m.map(s=>e.jsx(Ce,{story:s,language:t,onView:()=>b(`/create?storyId=${s.id}`),onDelete:()=>ne(s.id),formatDate:ie,isSelected:S.has(s.id),onToggleSelect:()=>oe(s.id),onLoadCover:ae,t:{add:c.add,remove:c.remove}},s.id))]}),P&&m.length>=se&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx("button",{onClick:()=>F({loadAll:!0}),disabled:k,className:"flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors disabled:opacity-50",children:k?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 spinner"}),t==="de"?"Laden...":t==="fr"?"Chargement...":"Loading..."]}):e.jsxs(e.Fragment,{children:[c.loadAll," (",_-m.length," ",t==="de"?"weitere":t==="fr"?"autres":"more",")"]})})})]}),p.length>0&&e.jsx("div",{className:"h-24"})]}),p.length>0&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[p.length," ",c.selected," • ",J," ",c.pages]}),I&&e.jsxs("span",{className:"text-red-600 font-medium",children:["(",c.tooManyPages,")"]})]}),e.jsxs("button",{onClick:Q,disabled:I,className:`flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-colors ${I?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:[e.jsx(q,{size:20}),c.createBook]})]})})]})}export{Oe as default};
