const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StoryDisplay-q8nmJbfV.js","assets/index-DjbczckS.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-BNIAgE4U.css","assets/Input-BtH6l-6e.js","assets/Textarea-BPSLXVpg.js","assets/sparkles-CRCnygLq.js","assets/book-open-C0j-RnYh.js","assets/history-1D_X5Z7r.js","assets/download-Cx4yaDpN.js","assets/chevron-down-Bhka-Hpd.js","assets/chevron-right-D8iVKK7v.js","assets/ImageLightbox-D7sbPpcm.js","assets/rotate-ccw-Dw3yzmFx.js","assets/chevron-up-CvSEbXmi.js","assets/Modal-BgG63jXZ.js","assets/palette-D5Vfeh79.js","assets/book-CqgZ2wds.js","assets/check-fakjwO4X.js","assets/shopping-cart-8yBofdnt.js","assets/plus-D2gOel1B.js","assets/wrench-CdlkMaBC.js","assets/circle-x-DPzmNVrC.js","assets/clock-Fm9ityvW.js","assets/arrow-left-s92Slh4r.js","assets/arrow-right-tTLU4NBi.js","assets/RepairWorkflowPanel-COxaKqAJ.js","assets/square-DL_22IEy.js","assets/search-BY7wfQlm.js","assets/WizardStep2Characters-D5QRcIdR.js","assets/pen-CRHGkS_R.js","assets/trash-2-CsyzSlOg.js","assets/camera-CjIWEsmR.js","assets/pencil-BMwfKMBH.js","assets/WizardStep4StoryType-BdNNRk5O.js","assets/WizardStep5ArtStyle-BU_jbBvr.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-DcAF-1TT.js"])))=>i.map(i=>d[i]);
import{c as Pt,b as Ae,d as Pn,j as t,X as Dn,u as Vt,a as Sa,L as ut,T as gi,C as gn,E as hi,e as mi,f as fi,s as he,g as hn,_ as Dt}from"./index-DjbczckS.js";import{b as s,u as pi,e as yi}from"./vendor-react-CqfXSjHo.js";import{B as $r,I as mn}from"./Input-BtH6l-6e.js";import{A as fn,N as vi}from"./Textarea-BPSLXVpg.js";import{C as xi}from"./circle-x-DPzmNVrC.js";import{C as bi}from"./clock-Fm9ityvW.js";import{M as In,I as pn,R as Si,a as wi}from"./Modal-BgG63jXZ.js";import{S as Ot}from"./sparkles-CRCnygLq.js";import{P as Ci}from"./palette-D5Vfeh79.js";import{C as $n}from"./chevron-down-Bhka-Hpd.js";import{B as ki}from"./book-open-C0j-RnYh.js";import{A as yn}from"./arrow-left-s92Slh4r.js";import{A as ji}from"./arrow-right-tTLU4NBi.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ai=Pt("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ni=Pt("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ti=Pt("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pi=Pt("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Di=Pt("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ii=Pt("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $i=Pt("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Ei={async login(e,n){const u=await Ae.post("/api/auth/login",{username:e,password:n},{skipAuth:!0}),S={id:u.user.id,username:u.user.username,email:u.user.email,role:u.user.role,credits:u.user.credits};return{token:u.token,user:S}},async register(e,n,u){return Ae.post("/api/auth/register",{username:e,password:n,email:u},{skipAuth:!0})},async loginWithFirebase(e){const n=await Ae.post("/api/auth/firebase",{idToken:e},{skipAuth:!0}),u={id:n.user.id,username:n.user.username,email:n.user.email,role:n.user.role,credits:n.user.credits};return{token:n.token,user:u}},async getQuota(){const e=await Ae.get("/api/user/quota");return{storyQuota:e.storyQuota,storiesGenerated:e.storiesGenerated,remaining:e.remaining}},async getCredits(){const e=await Ae.get("/api/user/quota");return{credits:e.credits,unlimited:e.unlimited}},async updateEmail(e){await Ae.put("/api/user/update-email",{email:e})},async getShippingAddress(){try{return await Ae.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(e){await Ae.put("/api/user/shipping-address",e)}},_=Pn("CharacterService");function En(e){if(!e)return;const n=parseInt(e,10);if(!(isNaN(n)||n<0))return n<=1?"infant":n<=2?"toddler":n<=4?"preschooler":n<=6?"kindergartner":n<=8?"young-school-age":n<=10?"school-age":n<=12?"preteen":n<=14?"young-teen":n<=17?"teenager":n<=25?"young-adult":n<=39?"adult":n<=59?"middle-aged":n<=75?"senior":"elderly"}function va(e){var a,G,v,T;const n=e.physical,u={height:e.height||(n==null?void 0:n.height),build:e.build||(n==null?void 0:n.build),face:e.other_features||e.otherFeatures||(n==null?void 0:n.face),eyeColor:e.eye_color||e.eyeColor||(n==null?void 0:n.eyeColor),hairColor:e.hair_color||e.hairColor||(n==null?void 0:n.hairColor),hairLength:e.hair_length||e.hairLength||(n==null?void 0:n.hairLength),hairStyle:e.hair_style||e.hairStyle||(n==null?void 0:n.hairStyle),facialHair:e.facial_hair||e.facialHair||(n==null?void 0:n.facialHair),skinTone:e.skin_tone||e.skinTone||(n==null?void 0:n.skinTone),skinUndertone:e.skin_undertone||e.skinUndertone||(n==null?void 0:n.skinUndertone),skinToneHex:e.skin_tone_hex||e.skinToneHex||(n==null?void 0:n.skinToneHex),hair:e.hair_color||e.hairColor||(n==null?void 0:n.hairColor),other:e.other||(n==null?void 0:n.other),detailedHairAnalysis:e.detailed_hair_analysis||e.detailedHairAnalysis||(n==null?void 0:n.detailedHairAnalysis),apparentAge:e.apparent_age||e.apparentAge||(n==null?void 0:n.apparentAge)},S=e.age_category||e.ageCategory||En(e.age);return{id:e.id,name:e.name,gender:e.gender,age:e.age,ageCategory:S,physical:u.height||u.build||u.face||u.eyeColor||u.hairColor||u.hairLength||u.hairStyle||u.facialHair||u.skinTone||u.hair||u.other||u.detailedHairAnalysis||u.apparentAge?u:void 0,physicalTraitsSource:e.physical_traits_source||e.physicalTraitsSource,traits:{strengths:e.strengths||((a=e.traits)==null?void 0:a.strengths)||[],flaws:e.flaws||e.weaknesses||((G=e.traits)==null?void 0:G.flaws)||[],challenges:e.challenges||e.fears||((v=e.traits)==null?void 0:v.challenges)||[],specialDetails:e.special_details||e.specialDetails||((T=e.traits)==null?void 0:T.specialDetails)},photos:{original:e.photo_url||e.photoUrl,face:e.thumbnail_url||e.thumbnailUrl,body:e.body_photo_url||e.bodyPhotoUrl,bodyNoBg:e.body_no_bg_url||e.bodyNoBgUrl,faceBox:e.face_box||e.faceBox,bodyBox:e.body_box||e.bodyBox},avatars:e.avatars||e.clothing_avatars||e.clothingAvatars,clothing:e.clothing||e.structured_clothing||e.structuredClothing?{current:e.clothing,structured:e.structured_clothing||e.structuredClothing}:void 0,generatedOutfits:e.generated_outfits||e.generatedOutfits,storyRole:e.storyRole}}function vn(e){var u,S,a,G,v,T,U,le,K,Z,F,k,re,ae,z,V,de,Y,ne,D,X,Q,L,x;const n=e.ageCategory||En(e.age);return{id:e.id,name:e.name,gender:e.gender,age:e.age,age_category:n,apparent_age:(u=e.physical)==null?void 0:u.apparentAge,height:(S=e.physical)==null?void 0:S.height,build:(a=e.physical)==null?void 0:a.build,eye_color:(G=e.physical)==null?void 0:G.eyeColor,hair_color:(v=e.physical)==null?void 0:v.hairColor,hair_length:(T=e.physical)==null?void 0:T.hairLength,hair_style:(U=e.physical)==null?void 0:U.hairStyle,facial_hair:(le=e.physical)==null?void 0:le.facialHair,skin_tone:(K=e.physical)==null?void 0:K.skinTone,skin_undertone:(Z=e.physical)==null?void 0:Z.skinUndertone,skin_tone_hex:(F=e.physical)==null?void 0:F.skinToneHex,other_features:(k=e.physical)==null?void 0:k.face,other:(re=e.physical)==null?void 0:re.other,detailed_hair_analysis:(ae=e.physical)==null?void 0:ae.detailedHairAnalysis,physical_traits_source:e.physicalTraitsSource,face_box:(z=e.photos)==null?void 0:z.faceBox,body_box:(V=e.photos)==null?void 0:V.bodyBox,strengths:(de=e.traits)==null?void 0:de.strengths,flaws:(Y=e.traits)==null?void 0:Y.flaws,challenges:(ne=e.traits)==null?void 0:ne.challenges,special_details:(D=e.traits)==null?void 0:D.specialDetails,weaknesses:(X=e.traits)==null?void 0:X.flaws,fears:(Q=e.traits)==null?void 0:Q.challenges,clothing:(L=e.clothing)==null?void 0:L.current,structured_clothing:(x=e.clothing)==null?void 0:x.structured,generated_outfits:e.generatedOutfits,storyRole:e.storyRole}}function Ri(e){return!e||e.length===0?[]:typeof e[0]=="string"?e.map(n=>({forward:n,inverse:n})):e}const Se={async getCharacters(e=!1){const n=e?"/api/characters?includeAllAvatars=true":"/api/characters";return((await Ae.get(n)).characters||[]).map(va)},async getCharacterData(e=!1){const n=e?"/api/characters?includeAllAvatars=true":"/api/characters",u=await Ae.get(n);return{characters:(u.characters||[]).map(va),relationships:u.relationships||{},relationshipTexts:u.relationshipTexts||{},customRelationships:Ri(u.customRelationships),customStrengths:u.customStrengths||[],customWeaknesses:u.customWeaknesses||[],customFears:u.customFears||[]}},async saveCharacters(e){await Ae.post("/api/characters",{characters:e.map(vn)})},async saveCharacterData(e,n){const u=a=>{var v,T,U,le;const G=vn(a);return n!=null&&n.includePhotos&&(G.photo_url=(v=a.photos)==null?void 0:v.original,G.thumbnail_url=(T=a.photos)==null?void 0:T.face,G.body_photo_url=(U=a.photos)==null?void 0:U.body,G.body_no_bg_url=(le=a.photos)==null?void 0:le.bodyNoBg),G},S={characters:e.characters.map(u),relationships:e.relationships,relationshipTexts:e.relationshipTexts,customRelationships:e.customRelationships,customStrengths:e.customStrengths,customWeaknesses:e.customWeaknesses,customFears:e.customFears};await Ae.post("/api/characters",S)},async deleteCharacter(e){try{const n=await Ae.delete(`/api/characters/${e}`);return _.success(`Deleted character ${e}: ${n.message}`),{success:!0}}catch(n){return _.error(`Failed to delete character ${e}:`,n),{success:!1,error:String(n)}}},async saveCharacterRoles(e){try{return await Ae.put("/api/characters/roles",{roles:e}),_.success(`Saved character roles: ${Object.keys(e).length} characters`),{success:!0}}catch(n){return _.error("Failed to save character roles:",n),{success:!1,error:String(n)}}},async loadCharacterAvatars(e){try{const n=await Ae.get(`/api/characters/${e}/avatars`);return _.info(`Loaded full avatars for character ${e}`),n.avatars||null}catch(n){return _.error(`Failed to load avatars for character ${e}:`,n),null}},async loadFullCharacter(e){try{const n=await Ae.get(`/api/characters/${e}/full`);return n.character?(_.info(`Loaded full data for character ${e}`),va(n.character)):null}catch(n){return _.error(`Failed to load full data for character ${e}:`,n),null}},async generateAvatarOptions(e,n){try{return await Ae.post("/api/generate-avatar-options",{facePhoto:e,gender:n,category:"standard"})}catch(u){const S=u instanceof Error?u.message:"Unknown error";return{success:!1,options:[],error:S}}},async generateClothingAvatars(e,n){var u,S,a,G,v,T,U,le,K,Z,F;try{const k=parseInt(e.age)||10,re=e.gender||"child";let ae;re==="male"?ae=k>=18?"man":"boy":re==="female"?ae=k>=18?"woman":"girl":ae=k>=18?"person":"child";let V=`${((u=e.name)==null?void 0:u.trim())||`This ${ae}`} is a ${k}-year-old ${ae}`;e.physical&&(e.physical.hair&&(V+=`, ${e.physical.hair}`),e.physical.face&&(V+=`, ${e.physical.face}`),e.physical.build&&(V+=`, ${e.physical.build}`),e.physical.other&&(V+=`, ${e.physical.other}`));const de=((S=e.photos)==null?void 0:S.bodyNoBg)||((a=e.photos)==null?void 0:a.body)||((G=e.photos)==null?void 0:G.face)||((v=e.photos)==null?void 0:v.original);_.info(`üé® Generating clothing avatars for ${e.name||"unnamed"} (id: ${e.id})`);const Y=await Ae.post("/api/generate-clothing-avatars?async=true",{characterId:e.id,facePhoto:de,physicalDescription:V,name:e.name,age:e.age,apparentAge:(T=e.physical)==null?void 0:T.apparentAge,gender:e.gender,build:(U=e.physical)==null?void 0:U.build,clothing:(le=e.clothing)==null?void 0:le.structured,avatarModel:n==null?void 0:n.avatarModel});if(Y.async&&Y.jobId){_.info(`Avatar job started: ${Y.jobId}, polling for completion...`);const D=60,X=2e3;for(let Q=0;Q<D;Q++){await new Promise(x=>setTimeout(x,X));const L=await Ae.get(`/api/avatar-jobs/${Y.jobId}`);if(L.status==="complete"&&L.clothingAvatars){_.success(`Avatar job ${Y.jobId} completed after ${(Q+1)*2}s`);const x=L.clothingAvatars.extractedTraits,H=(K=L.clothingAvatars.structuredClothing)==null?void 0:K.standard;return _.info(`üîç [DEBUG] extractedTraits: ${(Z=JSON.stringify(x))==null?void 0:Z.substring(0,100)}`),_.info(`üîç [DEBUG] extractedClothing: ${JSON.stringify(H)}`),_.info(`üîç [DEBUG] structuredClothing keys: ${Object.keys(L.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:L.clothingAvatars,extractedTraits:x,extractedClothing:H}}if(L.status==="failed")return _.error(`Avatar job failed: ${L.error}`),{success:!1,error:L.error};Q%5===0&&_.info(`Avatar job ${Y.jobId}: ${L.message||L.status} (${L.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const ne=Y;if(ne.success&&ne.clothingAvatars){_.success(`Clothing avatars generated for ${e.name}`);const D=ne.clothingAvatars.extractedTraits,X=(F=ne.clothingAvatars.structuredClothing)==null?void 0:F.standard;return D&&_.info(`Extracted traits: ${JSON.stringify(D)}`),X&&_.info(`Extracted clothing: ${JSON.stringify(X)}`),{success:!0,avatars:ne.clothingAvatars,extractedTraits:D,extractedClothing:X}}else return _.error(`Failed to generate avatars: ${ne.error}`),{success:!1,error:ne.error}}catch(k){return _.error("Clothing avatar generation failed:",k),{success:!1,error:String(k)}}},async generateClothingAvatarsWithTraits(e){var n,u,S,a,G,v,T,U,le,K,Z,F,k,re,ae,z,V,de;try{const Y=parseInt(e.age)||10,ne=e.gender||"child";let D;ne==="male"?D=Y>=18?"man":"boy":ne==="female"?D=Y>=18?"woman":"girl":D=Y>=18?"person":"child";let Q=`${((n=e.name)==null?void 0:n.trim())||`This ${D}`} is a ${Y}-year-old ${D}`;e.physical&&(e.physical.hair&&(Q+=`, ${e.physical.hair}`),e.physical.face&&(Q+=`, ${e.physical.face}`),e.physical.build&&(Q+=`, ${e.physical.build}`),e.physical.other&&(Q+=`, ${e.physical.other}`));const L=((u=e.photos)==null?void 0:u.bodyNoBg)||((S=e.photos)==null?void 0:S.body)||((a=e.photos)==null?void 0:a.face)||((G=e.photos)==null?void 0:G.original),x=(v=e.photos)!=null&&v.bodyNoBg?"bodyNoBg":(T=e.photos)!=null&&T.body?"body":(U=e.photos)!=null&&U.face?"face":"original",H=L?Math.round(L.length/1024):0,se=L==null?void 0:L.startsWith("data:image/png");_.info(`üé® Generating clothing avatars WITH TRAITS for ${e.name} (id: ${e.id})`),_.info(`üì∏ Photo source: ${x}, size: ${H}KB, format: ${se?"PNG":"JPEG"}`),_.info(`üì∏ Available photos: bodyNoBg=${!!((le=e.photos)!=null&&le.bodyNoBg)}, body=${!!((K=e.photos)!=null&&K.body)}, face=${!!((Z=e.photos)!=null&&Z.face)}, original=${!!((F=e.photos)!=null&&F.original)}`),_.info(`Physical traits: ${JSON.stringify(e.physical)}`);const me=e.physicalTraitsSource||{};_.info(`Physical traits source: ${JSON.stringify(me)}`),_.info(`Physical skinTone value: '${(k=e.physical)==null?void 0:k.skinTone}', source: '${me.skinTone}'`),_.info(`Physical hairStyle value: '${(re=e.physical)==null?void 0:re.hairStyle}', source: '${me.hairStyle}'`);const pe={};e.physical&&(me.eyeColor==="user"&&e.physical.eyeColor&&(pe.eyeColor=e.physical.eyeColor),me.hairColor==="user"&&e.physical.hairColor&&(pe.hairColor=e.physical.hairColor),me.hairLength==="user"&&e.physical.hairLength&&(pe.hairLength=e.physical.hairLength),me.hairStyle==="user"&&e.physical.hairStyle&&(pe.hairStyle=e.physical.hairStyle),me.build==="user"&&e.physical.build&&(pe.build=e.physical.build),me.skinTone==="user"&&e.physical.skinTone&&(pe.skinTone=e.physical.skinTone,e.physical.skinToneHex&&(pe.skinToneHex=e.physical.skinToneHex)),me.face==="user"&&e.physical.face&&(pe.face=e.physical.face),me.facialHair==="user"&&e.physical.facialHair&&(pe.facialHair=e.physical.facialHair),me.other==="user"&&e.physical.other&&(pe.other=e.physical.other));const ce=Object.keys(pe).length>0;_.info(`Physical traits to send (user-edited only): ${ce?JSON.stringify(pe):"none"}`);const Ce=e.clothingSource||{},De={};(ae=e.clothing)!=null&&ae.structured&&(Ce.upperBody==="user"&&e.clothing.structured.upperBody&&(De.upperBody=e.clothing.structured.upperBody),Ce.lowerBody==="user"&&e.clothing.structured.lowerBody&&(De.lowerBody=e.clothing.structured.lowerBody),Ce.shoes==="user"&&e.clothing.structured.shoes&&(De.shoes=e.clothing.structured.shoes),Ce.fullBody==="user"&&e.clothing.structured.fullBody&&(De.fullBody=e.clothing.structured.fullBody));const Ge=Object.keys(De).length>0;_.info(`Clothing to send (user-edited only): ${Ge?JSON.stringify(De):"none"}`);const Ne=await Ae.post("/api/generate-clothing-avatars?async=true",{characterId:e.id,facePhoto:L,physicalDescription:Q,name:e.name,age:e.age,apparentAge:(z=e.physical)==null?void 0:z.apparentAge,gender:e.gender,build:pe.build||"average",physicalTraits:ce?pe:void 0,clothing:Ge?De:void 0});if(Ne.async&&Ne.jobId){_.info(`Avatar job started: ${Ne.jobId}, polling for completion...`);const ze=60,fe=2e3;for(let Re=0;Re<ze;Re++){await new Promise(q=>setTimeout(q,fe));const J=await Ae.get(`/api/avatar-jobs/${Ne.jobId}`);if(J.status==="complete"&&J.clothingAvatars){_.success(`Avatar job ${Ne.jobId} completed after ${(Re+1)*2}s`);const q=J.clothingAvatars.extractedTraits,I=(V=J.clothingAvatars.structuredClothing)==null?void 0:V.standard;return{success:!0,avatars:J.clothingAvatars,extractedTraits:q,extractedClothing:I}}if(J.status==="failed")return _.error(`Avatar job failed: ${J.error}`),{success:!1,error:J.error};Re%5===0&&_.info(`Avatar job ${Ne.jobId}: ${J.message||J.status} (${J.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(Ne.success&&Ne.clothingAvatars){_.success(`Clothing avatars WITH TRAITS generated for ${e.name}`);const ze=Ne.clothingAvatars.extractedTraits,fe=(de=Ne.clothingAvatars.structuredClothing)==null?void 0:de.standard;return{success:!0,avatars:Ne.clothingAvatars,extractedTraits:ze,extractedClothing:fe}}else return _.error(`Failed to generate avatars with traits: ${Ne.error}`),{success:!1,error:Ne.error}}catch(Y){return _.error("Clothing avatar generation with traits failed:",Y),{success:!1,error:String(Y)}}},async analyzePhoto(e,n,u,S,a){var G,v,T,U,le,K,Z,F,k,re,ae,z,V,de,Y,ne,D,X,Q,L;try{const x=await Ae.post("/api/analyze-photo",{imageData:e,language:n,selectedFaceId:u,cachedFaces:S,existingCharacterId:a});if(!x.success)return{success:!1,error:x.error};if(x.multipleFacesDetected&&x.faces)return _.info(`Multiple faces detected (${x.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:x.faceCount,faces:x.faces};const H={height:(G=x.attributes)==null?void 0:G.height,build:(v=x.attributes)==null?void 0:v.build,face:(T=x.attributes)==null?void 0:T.face,eyeColor:((U=x.attributes)==null?void 0:U.eye_color)||((le=x.attributes)==null?void 0:le.eyeColor),hairColor:((K=x.attributes)==null?void 0:K.hair_color)||((Z=x.attributes)==null?void 0:Z.hairColor),hairLength:((F=x.attributes)==null?void 0:F.hair_length)||((k=x.attributes)==null?void 0:k.hairLength),hairStyle:((re=x.attributes)==null?void 0:re.hair_style)||((ae=x.attributes)==null?void 0:ae.hairStyle),hair:((z=x.attributes)==null?void 0:z.hair_color)||((V=x.attributes)==null?void 0:V.hairColor),other:(de=x.attributes)==null?void 0:de.other_features};return{success:x.success,characterId:x.characterId,multipleFacesDetected:!1,faceCount:x.faceCount,photos:{face:x.faceThumbnail,body:x.bodyCrop,bodyNoBg:x.bodyNoBg,faceBox:x.faceBox,bodyBox:x.bodyBox},age:(Y=x.attributes)==null?void 0:Y.age,apparentAge:(ne=x.attributes)==null?void 0:ne.apparent_age,gender:(D=x.attributes)==null?void 0:D.gender,physical:H.height||H.build||H.face||H.eyeColor||H.hairColor||H.hairLength||H.hairStyle||H.hair||H.other?H:void 0,clothing:(X=x.attributes)!=null&&X.clothing||(Q=x.attributes)!=null&&Q.clothingStyle||(L=x.attributes)!=null&&L.clothingColors?{current:x.attributes.clothing,style:x.attributes.clothingStyle||x.attributes.clothingColors}:void 0,_debug:x._debug}}catch(x){return _.error("Photo analysis failed:",x),{success:!1,error:"unknown_error"}}},needsAvatars(e){var a,G,v,T;if(!!!((a=e.photos)!=null&&a.original||(G=e.photos)!=null&&G.face||(v=e.photos)!=null&&v.body||(T=e.photos)!=null&&T.bodyNoBg))return!1;const u=e.avatars;return u?u.status==="generating"||u.status==="pending"?!1:u.status==="failed"?!0:!!!(u.winter||u.standard||u.summer||u.formal||u.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(e,n,u){var a,G,v,T,U,le,K,Z,F,k,re,ae,z,V,de,Y,ne,D,X,Q;const S={characterId:e.id,characterName:e.name,success:!1};try{if(!!!((a=e.photos)!=null&&a.original||(G=e.photos)!=null&&G.face||(v=e.photos)!=null&&v.body||(T=e.photos)!=null&&T.bodyNoBg))return S.skipped=!0,S.skipReason="No photo available",S;n==null||n("generating",`Generating avatars for ${e.name}...`),_.info(`üé® Generating avatars for ${e.name} (id: ${e.id})${u!=null&&u.avatarModel?`, model: ${u.avatarModel}`:""}`);const x=await Se.generateClothingAvatars(e,u);if(!x.success||!x.avatars)return S.error=x.error||"Avatar generation failed",n==null||n("error",S.error),S;S.avatars=x.avatars,S.extractedTraits=x.extractedTraits,S.extractedClothing=x.extractedClothing,n==null||n("saving",`Fetching updated data for ${e.name}...`);let H=null;const se=30;for(let me=0;me<se;me++){if(me>0){const pe=Math.min(500*Math.pow(1.2,me),3e3);_.info(`[AVATAR] Retry ${me+1}/${se}: waiting ${Math.round(pe)}ms for avatar data...`),await new Promise(ce=>setTimeout(ce,pe))}if(H=await Se.loadFullCharacter(e.id),(U=H==null?void 0:H.avatars)!=null&&U.standard||(le=H==null?void 0:H.avatars)!=null&&le.winter||(K=H==null?void 0:H.avatars)!=null&&K.summer){_.info(`[AVATAR] Got fresh data with avatars on attempt ${me+1}`);break}}return H?(S.character=H,(Z=H.avatars)!=null&&Z.standard||(F=H.avatars)!=null&&F.winter||(k=H.avatars)!=null&&k.summer||_.warn(`‚ö†Ô∏è Fresh DB data for ${e.name} missing avatars after ${se} retries - server may not have saved them`),_.info(`üìã Using server-saved data for ${e.name}`)):(_.error(`‚ùå Character ${e.name} (id: ${e.id}) not found in DB after avatar job - avatars lost!`),S.character={...e,avatars:{status:"failed"},physical:x.extractedTraits?{...e.physical,apparentAge:x.extractedTraits.apparentAge||((re=e.physical)==null?void 0:re.apparentAge),build:x.extractedTraits.build||((ae=e.physical)==null?void 0:ae.build),eyeColor:x.extractedTraits.eyeColor||((z=e.physical)==null?void 0:z.eyeColor),eyeColorHex:x.extractedTraits.eyeColorHex||((V=e.physical)==null?void 0:V.eyeColorHex),hairColor:x.extractedTraits.hairColor||((de=e.physical)==null?void 0:de.hairColor),hairColorHex:x.extractedTraits.hairColorHex||((Y=e.physical)==null?void 0:Y.hairColorHex),hairLength:x.extractedTraits.hairLength||((ne=e.physical)==null?void 0:ne.hairLength),hairStyle:x.extractedTraits.hairStyle||((D=e.physical)==null?void 0:D.hairStyle),skinTone:x.extractedTraits.skinTone||((X=e.physical)==null?void 0:X.skinTone),skinToneHex:x.extractedTraits.skinToneHex||((Q=e.physical)==null?void 0:Q.skinToneHex)}:e.physical,clothing:x.extractedClothing?{...e.clothing,structured:{upperBody:x.extractedClothing.upperBody||void 0,lowerBody:x.extractedClothing.lowerBody||void 0,shoes:x.extractedClothing.shoes||void 0,fullBody:x.extractedClothing.fullBody||void 0}}:e.clothing}),S.success=!0,n==null||n("complete",`Avatars saved for ${e.name}`),_.success(`‚úÖ Avatars generated and saved for ${e.name}`),S}catch(L){return S.error=String(L),n==null||n("error",S.error),_.error(`Failed to generate/save avatars for ${e.name}:`,L),S}},async generateAvatarsForCharacters(e,n){const{forceRegenerate:u=!1,maxConcurrent:S=2,onProgress:a}=n||{};_.info("üé® Starting batch avatar generation...");const G=await Se.getCharacterData();let v;if(e&&e.length>0?v=G.characters.filter(F=>e.includes(F.id)):v=G.characters.filter(F=>{var k,re;return u?!!((k=F.photos)!=null&&k.original||(re=F.photos)!=null&&re.face):Se.needsAvatars(F)}),v.length===0)return _.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};_.info(`Processing ${v.length} characters for avatar generation`);const T=[],U=new Map;for(let F=0;F<v.length;F+=S){const re=v.slice(F,F+S).map(async z=>{var de,Y,ne,D,X;const V={characterId:z.id,characterName:z.name,success:!1};try{if(!!!((de=z.photos)!=null&&de.original||(Y=z.photos)!=null&&Y.face||(ne=z.photos)!=null&&ne.body||(D=z.photos)!=null&&D.bodyNoBg))return V.skipped=!0,V.skipReason="No photo available",V;if(!u&&((X=z.avatars)!=null&&X.winter))return V.skipped=!0,V.skipReason="Avatars already exist",V;a==null||a(z.id,"generating",`Generating avatars for ${z.name}...`),_.info(`üé® Generating avatars for ${z.name}...`);const L=await Se.generateClothingAvatars(z);return!L.success||!L.avatars?(V.error=L.error||"Avatar generation failed",a==null||a(z.id,"error",V.error),V):(V.avatars=L.avatars,V.success=!0,U.set(z.id,{...z,avatars:L.avatars}),a==null||a(z.id,"complete",`Avatars generated for ${z.name}`),_.success(`‚úÖ Avatars generated for ${z.name}`),V)}catch(Q){return V.error=String(Q),a==null||a(z.id,"error",V.error),_.error(`Failed to generate avatars for ${z.name}:`,Q),V}}),ae=await Promise.all(re);T.push(...ae)}if(U.size>0){_.info(`üíæ Saving ${U.size} character avatar updates...`);const F=await Se.getCharacterData(),k=F.characters.map(re=>U.get(re.id)||re);await Se.saveCharacterData({...F,characters:k}),_.success(`üíæ Saved character data for ${U.size} characters`)}const le=T.filter(F=>F.success).length,K=T.filter(F=>!F.success&&!F.skipped).length,Z=T.filter(F=>F.skipped).length;return _.info(`Avatar generation complete: ${le} success, ${K} failed, ${Z} skipped`),{results:T,successCount:le,failCount:K,skipCount:Z}},async regenerateAvatarsForCharacter(e,n,u){_.info(`üîÑ Regenerating avatars for character ${e}...`);const a=(await Se.getCharacterData()).characters.find(v=>v.id===e);if(!a)return{characterId:e,characterName:"Unknown",success:!1,error:"Character not found"};const G={...a,avatars:{status:"pending"}};return Se.generateAndSaveAvatarForCharacter(G,n?(v,T)=>n(v,T):void 0,u)}},xn={sm:"h-1",md:"h-2",lg:"h-3"},Gi={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function Bi({value:e,max:n=100,label:u,showPercentage:S=!1,size:a="md",variant:G="gradient",className:v=""}){const T=Math.min(Math.max(e/n*100,0),100);return t.jsxs("div",{className:v,children:[(u||S)&&t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[u&&t.jsx("span",{className:"text-sm font-medium text-gray-700",children:u}),S&&t.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(T),"%"]})]}),t.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${xn[a]}`,children:t.jsx("div",{className:`${xn[a]} ${Gi[G]} rounded-full transition-all duration-500 ease-out`,style:{width:`${T}%`}})})]})}function Fi({step:e,text:n}){const u=`wizard_helper_dismissed_${e}`,[S,a]=s.useState(()=>localStorage.getItem(u)==="true");s.useEffect(()=>{const v=localStorage.getItem(u)==="true";a(v)},[e,u]);const G=()=>{localStorage.setItem(u,"true"),a(!0)};return S?null:t.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[t.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:n}),t.jsx("button",{onClick:G,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:t.jsx(Dn,{size:16})})]})}function Mi({current:e,total:n,message:u,isGenerating:S=!0,coverImages:a,jobId:G,onCancel:v,onMinimize:T,characters:U=[],isStalled:le=!1,onDismissStalled:K,isImpersonating:Z=!1}){const{language:F}=Vt(),{user:k}=Sa(),re=(k==null?void 0:k.role)==="admin"||Z,[ae,z]=s.useState(!1),[V,de]=s.useState(0),Y=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit f√ºr das grosse Abenteuer...",fr:"{name} se pr√©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} √ºbt gerade die Heldenpose...",fr:"{name} s'entra√Æne √† prendre la pose du h√©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als N√§chstes passiert!",fr:"{name} a h√¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} w√§rmt sich f√ºr das bevorstehende Abenteuer auf...",fr:"{name} s'√©chauffe pour l'aventure √† venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir f√ºgen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au r√©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} fl√ºstert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'≈ìil au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne f√ºr die Geschichte...",fr:"{name} collectionne des √©toiles pour le r√©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],ne=s.useRef({}),[D,X]=s.useState(null),Q=s.useMemo(()=>U.filter(J=>{var I;const q=J.avatars;return q&&(((I=q.faceThumbnails)==null?void 0:I.standard)||q.standard||q.summer||q.winter||q.formal||q.hasFullAvatars)}),[U]),L=J=>{var ke;const q=J.avatars;if(!q)return"";if((ke=q.faceThumbnails)!=null&&ke.standard)return q.faceThumbnails.standard;const I=[];return q.standard&&I.push(q.standard),q.summer&&I.push(q.summer),q.winter&&I.push(q.winter),q.formal&&I.push(q.formal),I[Math.floor(Math.random()*I.length)]||""},x=s.useMemo(()=>{const J=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(Q.length===0)return J;const q=[],I=Math.max(J.length,Q.length);for(let ke=0;ke<I;ke++)q.push(J[ke%J.length]),q.push({type:"character",char:Q[ke%Q.length]});return q},[Q]);if(s.useEffect(()=>{if(x.length<=1)return;const J=setInterval(()=>{de(q=>(q+1)%x.length)},8e3);return()=>clearInterval(J)},[x.length]),s.useEffect(()=>{if(x.length===0)return;const J=x[V];if(J.type==="character"){const q=J.char,I=L(q),Be=((ne.current[q.id]??-1)+1)%Y.length;ne.current[q.id]=Be;const Ie=Y[Be],Qe=(F==="de"?Ie.de:F==="fr"?Ie.fr:Ie.en).replace("{name}",q.name);X({avatarUrl:I,message:Qe})}else X(null)},[V,x,F]),!S||n===0)return null;const H=n===100?e:Math.round(e/n*100),se=J=>{if(J)return typeof J=="string"?J:J.imageData},me=se(a==null?void 0:a.frontCover),pe=se(a==null?void 0:a.initialPage),ce=se(a==null?void 0:a.backCover),Ce=!!me,De=!!pe,Ge=!!ce,Ne=Ce||De||Ge,ze={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollst√§ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erh√§ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz pers√∂nliches Abenteuer gestalten.',tipLocations:'F√ºge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu f√ºr eine pers√∂nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? F√ºr Bilderb√ºcher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint h√§ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"Cr√©ation de votre histoire!",timeInfo:"Votre r√©cit commencera √† s'afficher dans environ 1 minute. Le r√©cit complet peut prendre jusqu'√† 10 minutes.",emailInfo:"Vous recevrez un email quand votre r√©cit sera pr√™t.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre r√©cit continuera √† √™tre g√©n√©r√©.",tipCharacters:"Mieux vous d√©crivez vos personnages, plus le r√©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du r√©cit" vous permet de cr√©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits pr√©f√©r√©s √† "Intrigue / Contexte du r√©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique pr√©f√©r√© ? Pour les livres d'images, l'aquarelle fonctionne tr√®s bien !",coversPreview:"Aper√ßu des couvertures",frontCover:"Avant",initialPage:"Int√©rieur",backCover:"Arri√®re",cancelJob:"Annuler la g√©n√©ration",cancelling:"Annulation...",stalled:"La g√©n√©ration semble bloqu√©e",stalledDesc:"Aucun progr√®s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer √† attendre",continueInBackground:"Continuer en arri√®re-plan"}},fe=ze[F]||ze.en,Re=({imageData:J,label:q,isReady:I})=>t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${I?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:I&&J?t.jsx("img",{src:J,alt:q,className:"w-full h-full object-cover"}):t.jsx(ut,{size:20,className:"animate-spin text-gray-400"})}),t.jsxs("div",{className:"flex items-center gap-1",children:[I&&t.jsx(gn,{size:12,className:"text-green-500"}),t.jsx("span",{className:`text-xs ${I?"text-green-600 font-medium":"text-gray-400"}`,children:q})]})]});return t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${Ne?"max-w-lg":"max-w-md"}`,children:[t.jsxs("div",{className:"text-center mb-6",children:[t.jsxs("div",{className:"relative inline-block mb-3",children:[t.jsx(ut,{size:48,className:"animate-spin text-indigo-600"}),t.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"‚ú®"})]}),t.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:fe.title})]}),!Ne&&x.length>0&&t.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const J=x[V];if(J.type==="character"&&D)return t.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[t.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:t.jsx("img",{src:D.avatarUrl,alt:J.char.name,className:"w-full h-full object-contain"})}),t.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:D.message})]},`char-${J.char.id}-${V}`);if(J.type==="message"){const q=J.key,I=fe[q]||"",ke=q==="timeInfo"?t.jsx(bi,{size:20,className:"text-indigo-500 shrink-0"}):q==="emailInfo"?t.jsx(In,{size:20,className:"text-indigo-500 shrink-0"}):t.jsx(gn,{size:20,className:"text-indigo-500 shrink-0"});return t.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[ke,t.jsx("p",{className:"text-sm text-gray-700",children:I})]})}return null})()}),Ne&&t.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[t.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:fe.coversPreview}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(Re,{imageData:me,label:fe.frontCover,isReady:Ce}),t.jsx(Re,{imageData:pe,label:fe.initialPage,isReady:De}),t.jsx(Re,{imageData:ce,label:fe.backCover,isReady:Ge})]})]}),Ne&&t.jsxs("div",{className:"mb-4 text-center",children:[t.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[t.jsx(ut,{size:14,className:"animate-spin text-indigo-500"}),F==="de"?"Bilder f√ºr die Seiten werden jetzt erstellt...":F==="fr"?"Cr√©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:F==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":F==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),t.jsx("div",{className:"mb-4",children:t.jsx(Bi,{value:H,max:100,showPercentage:!0,size:"lg"})}),T&&t.jsx("button",{onClick:T,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:fe.continueInBackground}),le&&t.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(gi,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:fe.stalled}),t.jsx("p",{className:"text-sm text-amber-700 mb-3",children:fe.stalledDesc}),t.jsxs("div",{className:"flex gap-2",children:[K&&t.jsx("button",{onClick:K,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:fe.continueWaiting}),v&&t.jsx("button",{onClick:()=>{if(!ae){z(!0);try{v()}finally{z(!1)}}},disabled:ae,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:ae?fe.cancelling:fe.cancelJob})]})]})]})}),re&&G&&v&&t.jsxs("button",{onClick:async()=>{if(!ae){z(!0);try{v()}finally{z(!1)}}},disabled:ae,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[ae?t.jsx(ut,{size:16,className:"animate-spin"}):t.jsx(xi,{size:16}),ae?fe.cancelling:fe.cancelJob]})]})})}const Dr={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.5 - Best narrative quality",descriptionDe:"Claude Sonnet 4.5 - Beste Erz√§hlqualit√§t",descriptionFr:"Claude Sonnet 4.5 - Meilleure qualit√© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 3.5 - Fast and cheap",descriptionDe:"Claude Haiku 3.5 - Schnell und g√ºnstig",descriptionFr:"Claude Haiku 3.5 - Rapide et √©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe Qualit√§t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualit√©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - Tr√®s rapide"}},bn={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - G√©n√©ration rapide de sc√®nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - H√∂here Qualit√§t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - Qualit√© sup√©rieure (aper√ßu)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra g√ºnstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra √©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere Qualit√§t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualit√© ($0.004/image)"}},zi={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - √âvaluation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - Gr√ºndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},_i={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste Qualit√§t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualit√© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra g√ºnstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra √©conomique pour tests ($0.0006/image)"}},Li={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - G√©n√©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - H√∂here Qualit√§t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - Qualit√© sup√©rieure (aper√ßu)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - G√ºnstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars √©conomiques avec visage coh√©rent (~$0.005)"}};function dt({label:e,icon:n,value:u,options:S,onChange:a,language:G}){const v=T=>G==="de"&&T.descriptionDe?T.descriptionDe:G==="fr"&&T.descriptionFr?T.descriptionFr:T.description;return t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[n,e]}),t.jsxs("div",{className:"relative",children:[t.jsxs("select",{value:u||"",onChange:T=>a(T.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[t.jsx("option",{value:"",children:G==="de"?"Server-Standard":G==="fr"?"Par d√©faut serveur":"Server Default"}),Object.entries(S).map(([T,U])=>t.jsxs("option",{value:T,children:[T," ",U.provider?`(${U.provider})`:""]},T))]}),t.jsx($n,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),u&&S[u]&&t.jsx("p",{className:"text-[10px] text-gray-500 italic",children:v(S[u])})]})}function Hi({selections:e,onChange:n}){const{language:u}=Vt(),S=(a,G)=>{n({...e,[a]:G})};return t.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[t.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[t.jsx(Ai,{size:16}),u==="de"?"AI-Modell Auswahl (Dev)":u==="fr"?"S√©lection de mod√®le IA (Dev)":"AI Model Selection (Dev)"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[t.jsx(dt,{label:u==="de"?"Ideen-Modell":u==="fr"?"Mod√®le d'id√©es":"Idea Model",icon:t.jsx(Ni,{size:12}),value:e.ideaModel,options:Dr,onChange:a=>S("ideaModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Geschichte (Kombiniert)":u==="fr"?"Histoire (Combin√©)":"Story (Combined)",icon:t.jsx(Ot,{size:12}),value:e.outlineModel,options:Dr,onChange:a=>S("outlineModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Text-Modell":u==="fr"?"Mod√®le de texte":"Text Model",icon:t.jsx(Ot,{size:12}),value:e.textModel,options:Dr,onChange:a=>S("textModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Szenen-Modell":u==="fr"?"Mod√®le de sc√®ne":"Scene Description Model",icon:t.jsx(Ci,{size:12}),value:e.sceneDescriptionModel,options:Dr,onChange:a=>S("sceneDescriptionModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Bild-Modell":u==="fr"?"Mod√®le d'image":"Image Model",icon:t.jsx(pn,{size:12}),value:e.imageModel,options:bn,onChange:a=>S("imageModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Cover-Modell":u==="fr"?"Mod√®le de couverture":"Cover Image Model",icon:t.jsx(Ii,{size:12}),value:e.coverImageModel,options:bn,onChange:a=>S("coverImageModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Bewertungs-Modell":u==="fr"?"Mod√®le d'√©valuation":"Quality Eval Model",icon:t.jsx(hi,{size:12}),value:e.qualityModel,options:zi,onChange:a=>S("qualityModel",a),language:u}),t.jsx(dt,{label:u==="de"?"Bild-Reparatur":u==="fr"?"R√©paration d'image":"Image Repair",icon:t.jsx(Di,{size:12}),value:e.imageBackend,options:_i,onChange:a=>S("imageBackend",a),language:u}),t.jsx(dt,{label:u==="de"?"Avatar-Modell":u==="fr"?"Mod√®le d'avatar":"Avatar Model",icon:t.jsx(pn,{size:12}),value:e.avatarModel,options:Li,onChange:a=>S("avatarModel",a),language:u})]}),t.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:u==="de"?'Hinweis: Nur sichtbar f√ºr Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':u==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode d√©veloppeur. "Par d√©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}const Sn=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"Fran√ßais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],Ir={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"S√ºddeutsch"},{code:"de-at",name:"√ñsterreich"},{code:"de-it",name:"S√ºdtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"Qu√©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"Z√ºrit√º√ºtsch"},{code:"gsw-be",name:"B√§rnd√ºtsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"Luz√§rnd√ºtsch"},{code:"gsw-sg",name:"Sanggallerd√ºtsch"},{code:"gsw-vs",name:"Walliserd√ºtsch"},{code:"gsw-gr",name:"B√ºndnerd√ºtsch"}]};function xa(e){return e.startsWith("gsw")?"gsw":e.startsWith("de")?"de":e.startsWith("fr")?"fr":e.startsWith("it")?"it":"en"}const Wi=["spring","summer","autumn","winter"];function Rn(){const e=new Date().getMonth();return e>=2&&e<=4?"spring":e>=5&&e<=7?"summer":e>=8&&e<=10?"autumn":"winter"}function Oi({languageLevel:e,onLanguageLevelChange:n,pages:u,onPagesChange:S,storyLanguage:a,onStoryLanguageChange:G,developerMode:v,userLocation:T,onLocationChange:U,season:le,onSeasonChange:K,userCredits:Z}){const{t:F,language:k}=Vt(),[re,ae]=s.useState(!1),[z,V]=s.useState((T==null?void 0:T.city)||""),[de,Y]=s.useState((T==null?void 0:T.country)||""),[ne,D]=s.useState(!1),X=s.useRef(null);s.useEffect(()=>{const I=ke=>{X.current&&!X.current.contains(ke.target)&&D(!1)};return document.addEventListener("mousedown",I),()=>document.removeEventListener("mousedown",I)},[]);const Q=s.useCallback(()=>{const I=xa(a),ke=Sn.find(Ie=>Ie.family===I),Be=Ir[I].find(Ie=>Ie.code===a)||Ir[I][0];return ke&&Be?`${ke.name} (${Be.name})`:(ke==null?void 0:ke.name)||a},[a]);s.useEffect(()=>{T&&(V(T.city||""),Y(T.country||""))},[T]);const L=()=>{U({city:z||null,region:null,country:de||null}),ae(!1)},x={spring:{de:"Fr√ºhling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"√ât√©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},H=v?4:10,se=50,me=2,pe=10,ce=Z===-1,Ce=ce?se:Math.floor(Z/pe),De=Math.floor(Ce/2)*2,Ge=H*pe,Ne=!ce&&Z<Ge,ze=Ge-Z,fe=Ne?H:Math.min(se,Math.max(H,De)),Re=!ce&&De<se;s.useEffect(()=>{let I=u;I%2!==0&&(I=Math.round(I/2)*2),I=Math.max(H,Math.min(fe,I)),I!==u&&S(I)},[u,H,fe,S]);const J=[{value:"1st-grade",label:F.firstGrade,desc:F.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:F.standard,desc:F.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:F.advanced,desc:F.advancedDesc,image:"/images/dense text left.jpg"}],q=(I,ke=!1)=>{const Be=ke?" (Test)":"",Ie=I*10,nt=k==="de"?"Credits":k==="fr"?"cr√©dits":"credits";if(e==="1st-grade")return`${I} ${k==="de"?"Seiten":"pages"} = ${Ie} ${nt}${Be}`;const Qe=Math.floor(I/2),gt=Math.floor(I/2);return k==="de"?`${I} Seiten (${Qe} Text + ${gt} Bilder) = ${Ie} ${nt}${Be}`:k==="fr"?`${I} pages (${Qe} texte + ${gt} images) = ${Ie} ${nt}${Be}`:`${I} pages (${Qe} text + ${gt} images) = ${Ie} ${nt}${Be}`};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[t.jsx(ki,{size:24}),k==="de"?"Buchformat":k==="fr"?"Format du livre":"Book Format"]}),t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:k==="de"?"Sprache:":k==="fr"?"Langue:":"Language:"}),t.jsxs("div",{className:"relative",ref:X,children:[t.jsxs("button",{type:"button",onClick:()=>D(!ne),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[Q(),t.jsx($n,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${ne?"rotate-180":""}`})]}),ne&&t.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[Sn.map(I=>{const ke=xa(a)===I.family;return t.jsx("button",{type:"button",onClick:()=>{const Be=Ir[I.family][0];G(Be.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${ke?"font-semibold text-indigo-600":"text-gray-700"}`,children:I.name},I.family)}),t.jsx("div",{className:"border-t border-gray-300 my-1"}),Ir[xa(a)].map(I=>t.jsx("button",{type:"button",onClick:()=>{G(I.code),D(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${a===I.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:I.name},I.code))]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ti,{className:"text-gray-500",size:16}),t.jsx("span",{className:"text-sm text-gray-600",children:k==="de"?"Ort:":k==="fr"?"Lieu:":"Location:"}),re?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("input",{type:"text",value:z,onChange:I=>V(I.target.value),placeholder:k==="de"?"Stadt":k==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),t.jsx("input",{type:"text",value:de,onChange:I=>Y(I.target.value),placeholder:k==="de"?"Land":k==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),t.jsx("button",{onClick:L,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),t.jsx("button",{onClick:()=>ae(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"‚úï"})]}):t.jsx("button",{onClick:()=>ae(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:T!=null&&T.city?`${T.city}${T.country?`, ${T.country}`:""}`:k==="de"?"Festlegen":k==="fr"?"D√©finir":"Set"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-gray-600",children:k==="de"?"Jahreszeit:":k==="fr"?"Saison:":"Season:"}),t.jsxs("div",{className:"relative",children:[t.jsx("select",{value:le,onChange:I=>K(I.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:Wi.map(I=>t.jsx("option",{value:I,children:x[I][k]||x[I].en},I))}),t.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:t.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xl font-semibold mb-3",children:F.readingLevel}),t.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:J.map(I=>t.jsxs("button",{onClick:()=>n(I.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${e===I.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[t.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:t.jsx("img",{src:I.image,alt:I.label,className:"w-full h-full object-contain"})}),t.jsxs("div",{className:"p-2 md:p-2.5",children:[t.jsx("div",{className:"font-semibold text-sm mb-0.5",children:I.label}),t.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:I.desc})]})]},I.value))})]}),e&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-xl font-semibold mb-3",children:F.numberOfPages}),Ne?t.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[t.jsx("p",{className:"text-red-700 font-semibold mb-2",children:k==="de"?"Nicht gen√ºgend Credits":k==="fr"?"Cr√©dits insuffisants":"Not enough credits"}),t.jsx("p",{className:"text-red-600 text-sm",children:k==="de"?`Du ben√∂tigst mindestens ${Ge} Credits f√ºr eine Geschichte mit ${H} Seiten. Dir fehlen noch ${ze} Credits.`:k==="fr"?`Vous avez besoin d'au moins ${Ge} cr√©dits pour une histoire de ${H} pages. Il vous manque ${ze} cr√©dits.`:`You need at least ${Ge} credits for a ${H}-page story. You need ${ze} more credits.`}),t.jsx("p",{className:"text-gray-500 text-xs mt-2",children:k==="de"?`Aktuell: ${Z} Credits`:k==="fr"?`Actuel: ${Z} cr√©dits`:`Current: ${Z} credits`})]}):t.jsxs("div",{className:"space-y-3",children:[t.jsx("input",{type:"range",min:H,max:fe,step:me,value:Math.min(u,fe),onChange:I=>S(parseInt(I.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-sm text-gray-400",children:H}),t.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[u," ",k==="de"?"Seiten":"pages"]}),t.jsxs("span",{className:`text-sm ${Re?"text-orange-500 font-medium":"text-gray-400"}`,children:[fe,Re&&" ‚ö†Ô∏è"]})]}),Re&&t.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:k==="de"?`Max. ${fe} Seiten mit ${Z} Credits m√∂glich`:k==="fr"?`Max. ${fe} pages possibles avec ${Z} cr√©dits`:`Max. ${fe} pages possible with ${Z} credits`}),t.jsxs("div",{className:"text-center",children:[t.jsx("p",{className:"text-base font-medium text-gray-700",children:q(u,u===4)}),t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:e==="1st-grade"?k==="de"?"Jede Seite enth√§lt ein Bild mit Text darunter":k==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":k==="de"?"Abwechselnd Textseite und Bildseite":k==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const Vi=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:Oi,getCurrentSeason:Rn},Symbol.toStringTag,{value:"Module"})),wn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail pr√ºfen",description:"Wir haben Ihnen einen Best√§tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail best√§tigen!",currentEmail:"Best√§tigung gesendet an",sendVerification:"Best√§tigungs-E-Mail senden",resendVerification:"Best√§tigungs-E-Mail erneut senden",emailSent:"Best√§tigungs-E-Mail gesendet! Bitte pr√ºfen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? √Ñndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"√Ñndern & Best√§tigen",cancel:"Abbrechen",emailChanged:"E-Mail ge√§ndert! Bitte pr√ºfen Sie Ihren neuen Posteingang f√ºr die Best√§tigung.",checkSpam:"Nicht gefunden? Pr√ºfen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausf√ºllen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function qi({isOpen:e,onClose:n,onVerified:u}){const{language:S}=Vt(),{user:a,refreshUser:G}=Sa(),v=wn[S]||wn.en,[T,U]=s.useState("verify"),[le,K]=s.useState(!1),[Z,F]=s.useState(!1),[k,re]=s.useState(""),[ae,z]=s.useState(""),[V,de]=s.useState(!1),[Y,ne]=s.useState(0),[D,X]=s.useState(""),[Q,L]=s.useState(""),x=s.useRef(null),H=s.useRef(null),se=s.useRef(!1);if(s.useEffect(()=>(Y>0&&(H.current=setTimeout(()=>{ne(ce=>ce-1)},1e3)),()=>{H.current&&clearTimeout(H.current)}),[Y]),s.useEffect(()=>{if(e&&!se.current&&!Z){se.current=!0;const ce=setTimeout(async()=>{K(!0);try{const Ce=await Ae.post("/api/auth/send-verification",{});F(!0),z(v.emailSent),Ce.cooldown&&ne(Ce.cooldown)}catch(Ce){const De=Ce;De.retryAfter?(ne(De.retryAfter),F(!0)):re(De.message||"Failed to send verification email")}finally{K(!1)}},300);return()=>clearTimeout(ce)}e||(se.current=!1)},[e,Z,v.emailSent]),s.useEffect(()=>{if(!e){x.current&&(clearInterval(x.current),x.current=null);return}return de(!0),console.log("[EmailVerificationModal] Starting polling"),x.current=setInterval(async()=>{try{const ce=await Ae.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",ce.emailVerified),ce.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await G(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),x.current&&(clearInterval(x.current),x.current=null),de(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),u==null||u(),console.log("[EmailVerificationModal] Calling onClose"),n())}catch(ce){console.debug("Verification status poll error:",ce)}},3e3),()=>{x.current&&(clearInterval(x.current),x.current=null)}},[e,G,u,n]),!e)return null;const me=async()=>{K(!0),re("");try{const ce=await Ae.post("/api/auth/send-verification",{});F(!0),z(v.emailSent),ce.cooldown&&ne(ce.cooldown)}catch(ce){const Ce=ce;Ce.retryAfter?(ne(Ce.retryAfter),re(S==="de"?`Bitte warten Sie ${Ce.retryAfter} Sekunden`:S==="fr"?`Veuillez patienter ${Ce.retryAfter} secondes`:`Please wait ${Ce.retryAfter} seconds`)):re(Ce.message||"Failed to send verification email")}finally{K(!1)}},pe=async()=>{if(!D||!Q){re(v.fillAllFields);return}K(!0),re("");try{await Ae.post("/api/auth/change-email",{newEmail:D,password:Q}),z(v.emailChanged),U("verify"),X(""),L("")}catch(ce){re(ce instanceof Error?ce.message:"Failed to change email")}finally{K(!1)}};return t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[t.jsx("button",{onClick:n,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:t.jsx(Dn,{size:20})}),t.jsxs("div",{className:"text-center mb-6",children:[t.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx(In,{className:"w-8 h-8 text-indigo-600"})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:v.title}),t.jsx("p",{className:"text-gray-500",children:v.description})]}),k&&t.jsx(fn,{variant:"error",className:"mb-4",children:k}),ae&&t.jsxs(fn,{variant:"success",className:"mb-4",children:[ae,t.jsx("p",{className:"text-sm mt-1 opacity-80",children:v.checkSpam})]}),V&&Z&&t.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[t.jsx(ut,{size:16,className:"animate-spin"}),t.jsx("span",{className:"text-sm",children:S==="de"?"Warte auf Best√§tigung...":S==="fr"?"En attente de verification...":"Waiting for verification..."})]}),T==="verify"?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("p",{className:"text-sm text-gray-500 mb-1",children:v.currentEmail}),t.jsx("p",{className:"font-medium text-gray-800",children:a==null?void 0:a.email})]}),t.jsxs($r,{onClick:me,variant:"primary",loading:le,disabled:Y>0,className:"w-full",children:[t.jsx(Si,{size:16,className:"mr-2"}),Y>0?`${S==="de"?"Warten":S==="fr"?"Patienter":"Wait"} ${Y}s`:Z?v.resendVerification:v.sendVerification]}),t.jsxs("button",{onClick:()=>{U("change"),re(""),z("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[t.jsx(Pi,{size:16}),v.changeEmail]})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsx(mn,{type:"email",label:v.newEmail,value:D,onChange:ce=>X(ce.target.value),placeholder:"your@newemail.com",disabled:le}),t.jsx(mn,{type:"password",label:v.currentPassword,value:Q,onChange:ce=>L(ce.target.value),placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",disabled:le}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx($r,{onClick:()=>{U("verify"),re(""),X(""),L("")},variant:"secondary",className:"flex-1",disabled:le,children:v.cancel}),t.jsx($r,{onClick:pe,variant:"primary",loading:le,className:"flex-1",children:v.confirmChange})]})]})]})})}const wa=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"Mari√©(e) √†"},inverse:{en:"Married to",de:"Verheiratet mit",fr:"Mari√©(e) √†"}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"√Ñlteres Geschwister von",fr:"Fr√®re/S≈ìur a√Æn√©(e) de"},inverse:{en:"Younger Sibling of",de:"J√ºngeres Geschwister von",fr:"Fr√®re/S≈ìur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"J√ºngeres Geschwister von",fr:"Fr√®re/S≈ìur cadet(te) de"},inverse:{en:"Older Sibling of",de:"√Ñlteres Geschwister von",fr:"Fr√®re/S≈ìur a√Æn√©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function Ui(e){const n=wa.find(u=>u.value.en==="Not Known to");return n?n.value[e]:"Not Known to"}function Cn(e){const n=wa.find(u=>u.value.en==="Not Known to");return n?e===n.value.en||e===n.value.de||e===n.value.fr:!1}function Ki(e,n,u=[]){for(const S of wa)if(S.value[n]===e)return S.inverse[n];for(const S of u){if(S.forward===e)return S.inverse;if(S.inverse===e)return S.forward}return e}const Ji=1440*60*1e3;function Er(e){const n=`avatar_regen_${e}`,u=localStorage.getItem(n),S=Date.now();if(!u)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:a,lastAttempt:G}=JSON.parse(u);if(S-G>Ji)return localStorage.removeItem(n),{canRegenerate:!0,waitSeconds:0,attempts:0};let v=0;a>=2&&a<4?v=30*1e3:a>=4&&a<6?v=60*1e3:a>=6&&a<8?v=120*1e3:a>=8&&a<10?v=300*1e3:a>=10&&(v=600*1e3);const T=S-G;return T>=v?{canRegenerate:!0,waitSeconds:0,attempts:a}:{canRegenerate:!1,waitSeconds:Math.ceil((v-T)/1e3),attempts:a}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function Gn(e){const n=`avatar_regen_${e}`,u=localStorage.getItem(n),S=Date.now();let a=1;if(u)try{a=(JSON.parse(u).attempts||0)+1}catch{}localStorage.setItem(n,JSON.stringify({attempts:a,lastAttempt:S}))}function jo(e){const[n,u]=s.useState(()=>Er(e));s.useEffect(()=>{if(n.waitSeconds>0){const a=setInterval(()=>{u(Er(e))},1e3);return()=>clearInterval(a)}},[n.waitSeconds,e]);const S=s.useCallback(()=>{Gn(e),u(Er(e))},[e]);return{...n,recordRegeneration:S}}const kn={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte w√§hlen Sie aus, welches Gesicht zu dem Charakter geh√∂rt, den Sie erstellen m√∂chten.",selectFace:"Gesicht ausw√§hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages d√©tect√©s",description:"Nous avons d√©tect√© plusieurs personnes sur votre photo. Veuillez s√©lectionner le visage du personnage que vous souhaitez cr√©er.",selectFace:"S√©lectionner le visage",uploadDifferent:"T√©l√©charger une autre photo",confidence:"Confiance"}};function Zi({isOpen:e,faces:n,onSelect:u,onUploadNew:S,developerMode:a=!1}){const{language:G}=Vt(),v=kn[G]||kn.en;return t.jsx(wi,{isOpen:e,onClose:S,title:v.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("p",{className:"text-gray-600 text-center",children:v.description}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:n.map((T,U)=>t.jsxs("button",{onClick:()=>u(T.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[t.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:t.jsx("img",{draggable:!1,src:T.thumbnail,alt:`Face ${U+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),t.jsx("div",{className:"text-center",children:t.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[v.selectFace," ",U+1]})}),a&&t.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[v.confidence,": ",Math.round(T.confidence*100),"%"]})]},T.id))}),t.jsx("div",{className:"pt-4 border-t border-gray-100",children:t.jsxs("button",{onClick:S,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[t.jsx($i,{size:20}),v.uploadDifferent]})})]})})}const Ao=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et qu√™tes h√©ro√Øques"},emoji:"üó°Ô∏è"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"Comp√©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei allt√§glichen Herausforderungen",fr:"Aide pour surmonter les d√©fis quotidiens"},emoji:"üí™"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"üìö"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais √©v√©nements historiques"},emoji:"üèõÔ∏è"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"Cr√©er le v√¥tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"D√©cris ta propre id√©e d'histoire"},emoji:"‚ú®"}],Yi=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],No=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"√âpoques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"H√©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"Personnalis√©"}}],ba=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"üè¥‚Äç‚ò†Ô∏è",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"‚öîÔ∏è",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ü§†",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ü•∑",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"‚öì",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"üèõÔ∏è",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes √Ñgypten",fr:"√âgypte Ancienne"},emoji:"üè∫",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"Gr√®ce Antique"},emoji:"üè∫",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"√Çge de Pierre"},emoji:"ü¶¥",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure Samoura√Ø"},emoji:"üéå",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & Sorci√®re"},emoji:"üßô",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"Qu√™te du Dragon"},emoji:"üêâ",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ü¶Ñ",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de Sir√®ne"},emoji:"üßú‚Äç‚ôÄÔ∏è",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ü¶ñ",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-h√©ros"},emoji:"ü¶∏",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"üöÄ",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des Oc√©ans"},emoji:"üåä",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"üå¥",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie √† la Ferme"},emoji:"üêÑ",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la For√™t"},emoji:"ü¶ä",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"üöí",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"üë®‚Äç‚öïÔ∏è",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"üëÆ",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"Myst√®re D√©tective"},emoji:"üîç",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de No√´l"},emoji:"üéÑ",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"üéÜ",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de P√¢ques"},emoji:"üê∞",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"üéÉ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"Cr√©er le v√¥tre"},emoji:"‚ú®",group:"custom"}],To={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"üè†"},jn=[{id:"potty-training",name:{en:"Potty Training",de:"T√∂pfchen-Training",fr:"Apprentissage du pot"},emoji:"üöΩ",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"H√§nde waschen",fr:"Se laver les mains"},emoji:"üßº",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"Z√§hne putzen",fr:"Se brosser les dents"},emoji:"ü™•",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"Gem√ºse essen",fr:"Manger des l√©gumes"},emoji:"ü•¶",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"üõèÔ∏è",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"üëã",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de t√©tine"},emoji:"üçº",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"Aufr√§umen",fr:"Ranger les jouets"},emoji:"üßπ",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ü™ë",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre √† partager"},emoji:"ü§ù",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten k√∂nnen",fr:"Attendre son tour"},emoji:"‚è≥",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"üéí",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"üë´",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"√ätre courageux"},emoji:"üí™",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau b√©b√© dans la famille"},emoji:"üë∂",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'√©cole"},emoji:"üè´",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"üìù",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre √† lire"},emoji:"üìñ",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren k√∂nnen",fr:"Savoir perdre"},emoji:"üéØ",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"√ätre diff√©rent c'est bien"},emoji:"üåà",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit H√§nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"üõ°Ô∏è",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la v√©rit√©"},emoji:"‚úÖ",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"üåü",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"D√©m√©nagement"},emoji:"üè†",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"‚úàÔ∏è",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents s√©par√©s"},emoji:"üíî",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le m√©decin"},emoji:"üè•",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"S√©jour √† l'h√¥pital"},emoji:"ü©∫",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"üåà",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"‚ù§Ô∏è",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"√âconomiser de l'argent"},emoji:"üí∞",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"D√©penser intelligemment"},emoji:"üõí",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"√âquilibre du temps d'√©cran"},emoji:"üì±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"üë•",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"K√∂rperliche Ver√§nderungen",fr:"Changements corporels"},emoji:"üå±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung √ºbernehmen",fr:"Prendre ses responsabilit√©s"},emoji:"üéØ",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"‚è∞",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"S√©curit√© en ligne"},emoji:"üîí",ageGroup:"preteen"}],Qi=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],Po=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-Ver√§nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"Pr√©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"√âcole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"Vorpubert√§t (9-12)",fr:"Pr√©adolescent (9-12)"},ageRange:"9-12"}],An=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"üî§",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"üÖ∞Ô∏è",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"Reimw√∂rter",fr:"Mots qui riment"},emoji:"üéµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"üî¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"üî¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"Z√§hlen lernen",fr:"Apprendre √† compter"},emoji:"‚úã",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"üî∑",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"‚ûï",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"üåà",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"M√©langer les couleurs"},emoji:"üé®",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"Plan√®tes & Espace"},emoji:"ü™ê",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"üçÇ",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"M√©t√©o"},emoji:"‚õÖ",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"üíß",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"üå±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"üåô",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"üê∑",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ü¶Å",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"üêã",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & K√§fer",fr:"Insectes"},emoji:"üêõ",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ü¶ï",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"K√∂rperteile",fr:"Parties du corps"},emoji:"ü´Ä",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die f√ºnf Sinne",fr:"Les cinq sens"},emoji:"üëÅÔ∏è",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ü•ó",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"üìÖ",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'ann√©e"},emoji:"üóìÔ∏è",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"üïê",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"üåç",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"L√§nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"üè≥Ô∏è",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"üé∏",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"Ber√ºhmte K√ºnstler",fr:"Artistes c√©l√®bres"},emoji:"üñºÔ∏è",group:"arts"}],Xi=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],Do=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"K√∂rper & Gesundheit",fr:"Corps & Sant√©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & G√©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],eo=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],Io=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"‚≠ê"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"üá®üá≠"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & D√©couverte"},icon:"üß≠"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & M√©decine"},icon:"üî¨"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"üí°"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & Libert√©"},icon:"‚úä"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"üèóÔ∏è"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"üé≠"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"Arch√§ologische Entdeckungen",fr:"D√©couvertes Arch√©ologiques"},icon:"üè∫"}],Nn=[{id:"swiss-founding",name:{en:"Founding of Switzerland (R√ºtlischwur)",de:"Gr√ºndung der Schweiz (R√ºtlischwur)",fr:"Fondation de la Suisse (Serment du Gr√ºtli)"},shortName:{en:"R√ºtlischwur",de:"R√ºtlischwur",fr:"Serment du Gr√ºtli"},emoji:"ü§ù",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"üèπ",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"‚öîÔ∏è",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"üõ°Ô∏è",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"R√©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"R√©forme"},emoji:"üìú",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant gr√ºndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"‚ù§Ô∏è",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"G√©n√©ral Dufour et l'unit√© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"G√©n√©ral Dufour"},emoji:"üéñÔ∏è",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"üèîÔ∏è",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution f√©d√©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"üìã",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"üöÇ",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer Neutralit√§t im 1. Weltkrieg",fr:"Neutralit√© suisse pendant la Premi√®re Guerre"},shortName:{en:"WWI Neutrality",de:"Neutralit√§t 1. WK",fr:"Neutralit√© 1GM"},emoji:"üïäÔ∏è",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the R√ºtli Report",de:"General Guisan und der R√ºtlirapport",fr:"G√©n√©ral Guisan et le Rapport du Gr√ºtli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"G√©n√©ral Guisan"},emoji:"üéñÔ∏è",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2√®me GM"},emoji:"üèîÔ∏è",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"üó≥Ô∏è",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"üåô",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les Am√©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"D√©couverte de l'Am√©rique"},emoji:"‚õµ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motoris√©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"‚úàÔ∏è",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"Premi√®re travers√©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"üõ©Ô∏è",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"üèîÔ∏è",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am S√ºdpol",fr:"Premier au P√¥le Sud"},shortName:{en:"South Pole",de:"S√ºdpol",fr:"P√¥le Sud"},emoji:"‚ùÑÔ∏è",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"üåç",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"Plong√©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"Plong√©e profonde"},emoji:"üåä",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"Exp√©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"Elektrizit√§t entdeckt",fr:"D√©couverte √©lectricit√©"},emoji:"‚ö°",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"D√©couverte de la p√©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"P√©nicilline"},emoji:"üíä",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"üíâ",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN d√©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"D√©couverte ADN"},emoji:"üß¨",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nomm√©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"D√©couverte dinosaure"},emoji:"ü¶ï",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins Relativit√§tstheorie",fr:"Relativit√© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"Th√©orie d'Einstein"},emoji:"üß†",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits Gal√°pagos",de:"Darwin auf Gal√°pagos",fr:"Darwin aux Gal√°pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"üê¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"Premi√®re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"‚ù§Ô∏è",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschl√ºsselt",fr:"G√©nome humain d√©cod√©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet G√©nome"},emoji:"üß™",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement t√©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"T√©lescope Hubble"},emoji:"üî≠",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel t√©l√©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"T√©l√©phone"},emoji:"üìû",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons Gl√ºhbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"Gl√ºhbirne",fr:"Ampoule"},emoji:"üí°",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"üìñ",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"üåê",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"‚õìÔ∏è",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"üó≥Ô∏è",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"üöå",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"üß±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela lib√©r√©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"‚úä",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"üî∫",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm er√∂ffnet",fr:"Tour Eiffel inaugur√©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"üóº",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal er√∂ffnet",fr:"Canal de Panama inaugur√©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"üö¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"üåâ",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel er√∂ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"üöá",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"üèÖ",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland er√∂ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"üè∞",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cin√©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"üé¨",year:1895,category:"culture",mainPerson:"Lumi√®re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ü¶Å",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"Mus√©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"Mus√©e Histoire Naturelle"},emoji:"üèõÔ∏è",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de Tout√¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"Tout√¢nkhamon"},emoji:"üëë",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"Red√©couverte de Pomp√©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"Pomp√©i"},emoji:"üåã",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"Arm√©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"Arm√©e terre cuite"},emoji:"üóø",year:1974,category:"archaeology"}];function $o(e){return e==="popular"?ba.filter(n=>Yi.includes(n.id)):ba.filter(n=>n.group===e)}function Eo(e){return e==="popular"?jn.filter(n=>Qi.includes(n.id)):jn.filter(n=>n.ageGroup===e)}function Ro(e){return e==="popular"?An.filter(n=>Xi.includes(n.id)):An.filter(n=>n.group===e)}function Go(e){return e==="popular"?Nn.filter(n=>eo.includes(n.id)):Nn.filter(n=>n.category===e)}const to={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},Ye={enableAutoRepair:!1,enableFinalChecks:!0,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null,enableSceneValidation:!1,separatedEvaluation:!1,enableFullRepairAfterGeneration:!1};function ro(){const e=localStorage.getItem("developer_mode")==="true",[n,u]=s.useState(e),[S,a]=s.useState(null),[G,v]=s.useState("auto"),[T,U]=s.useState(!1),[le,K]=s.useState(!1),[Z,F]=s.useState(!1),[k,re]=s.useState(!1),[ae,z]=s.useState(e),[V,de]=s.useState(Ye.enableAutoRepair),[Y,ne]=s.useState(Ye.enableFinalChecks),[D,X]=s.useState(Ye.incrementalConsistency),[Q,L]=s.useState(Ye.incrementalConsistencyDryRun),[x,H]=s.useState(Ye.lookbackCount),[se,me]=s.useState(Ye.checkOnlyMode),[pe,ce]=s.useState(Ye.useGridRepair),[Ce,De]=s.useState(Ye.forceRepairThreshold),[Ge,Ne]=s.useState(Ye.enableSceneValidation),[ze,fe]=s.useState(Ye.separatedEvaluation),[Re,J]=s.useState(Ye.enableFullRepairAfterGeneration),[q,I]=s.useState(!1),[ke,Be]=s.useState(!1),[Ie,nt]=s.useState({...to}),Qe=gt=>{u(gt),z(!!gt)};return s.useEffect(()=>{n?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[n]),{developerMode:n,setDeveloperMode:Qe,imageGenMode:S,setImageGenMode:a,generationMode:G,setGenerationMode:v,devSkipOutline:T,setDevSkipOutline:U,devSkipText:le,setDevSkipText:K,devSkipSceneDescriptions:Z,setDevSkipSceneDescriptions:F,devSkipImages:k,setDevSkipImages:re,devSkipCovers:ae,setDevSkipCovers:z,enableAutoRepair:V,setEnableAutoRepair:de,enableFinalChecks:Y,setEnableFinalChecks:ne,incrementalConsistency:D,setIncrementalConsistency:X,incrementalConsistencyDryRun:Q,setIncrementalConsistencyDryRun:L,lookbackCount:x,setLookbackCount:H,checkOnlyMode:se,setCheckOnlyMode:me,useGridRepair:pe,setUseGridRepair:ce,forceRepairThreshold:Ce,setForceRepairThreshold:De,enableSceneValidation:Ge,setEnableSceneValidation:Ne,separatedEvaluation:ze,setSeparatedEvaluation:fe,enableFullRepairAfterGeneration:Re,setEnableFullRepairAfterGeneration:J,loadAllAvatars:q,setLoadAllAvatars:I,useMagicApiRepair:ke,setUseMagicApiRepair:Be,modelSelections:Ie,setModelSelections:nt}}const ao=s.lazy(()=>Dt(()=>import("./StoryDisplay-q8nmJbfV.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]))),no=s.lazy(()=>Dt(()=>import("./RepairWorkflowPanel-COxaKqAJ.js"),__vite__mapDeps([27,1,2,3,4,22,14,11,12,28,29,23,5,16]))),so=s.lazy(()=>Dt(()=>import("./WizardStep2Characters-D5QRcIdR.js"),__vite__mapDeps([30,1,2,3,4,5,6,7,8,19,31,32,21,13,14,11,12,26,33,34,16,28,23,24,17,25])).then(e=>({default:e.WizardStep2Characters}))),io=s.lazy(()=>Dt(()=>Promise.resolve().then(()=>Vi),void 0).then(e=>({default:e.WizardStep3BookSettings}))),oo=s.lazy(()=>Dt(()=>import("./WizardStep4StoryType-BdNNRk5O.js"),__vite__mapDeps([35,1,2,3,4,7,34,15,11,5,6,8,23,24,16,17,25,26])).then(e=>({default:e.WizardStep4StoryType}))),lo=s.lazy(()=>Dt(()=>import("./WizardStep5ArtStyle-BU_jbBvr.js"),__vite__mapDeps([36,1,2,3,4,37,17])).then(e=>({default:e.WizardStep5ArtStyle}))),co=s.lazy(()=>Dt(()=>import("./WizardStep6Summary-DcAF-1TT.js"),__vite__mapDeps([38,1,2,3,4,37,34,19,7,5,6,8,23,24,16,17,11,25,26])).then(e=>({default:e.WizardStep6Summary}))),i=Pn("StoryWizard"),Tn={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"F√ºge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die Buchl√§nge und das Leseniveau f√ºr dein Publikum fest",3:"W√§hle einen Geschichtstyp und ein Thema",4:"W√§hle einen Illustrationsstil f√ºr dein Buch",5:"√úberpr√ºfe deine Auswahl, f√ºge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils appara√Ætront de mani√®re coh√©rente dans toute votre histoire!",2:"D√©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un th√®me",4:"Choisissez un style d'illustration pour votre livre",5:"V√©rifiez vos choix, ajoutez des d√©tails de l'intrigue, puis g√©n√©rez votre histoire!"}};function uo(){const e=pi(),[n,u]=yi(),{t:S,language:a}=Vt(),{isAuthenticated:G,user:v,updateCredits:T,refreshUser:U,isLoading:le,isImpersonating:K}=Sa(),{showSuccess:Z,showInfo:F,showError:k}=mi(),{startTracking:re,stopTracking:ae,activeJob:z,isComplete:V,completedStoryId:de,markCompletionViewed:Y,hasUnviewedCompletion:ne}=fi(),[D,X]=s.useState(()=>{const r=new URLSearchParams(window.location.search);if(r.get("storyId"))return 6;if(r.get("new")==="true")return 1;const c=localStorage.getItem("wizard_step");return c?parseInt(c,10):1}),[Q,L]=s.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[x,H]=s.useState(null),{developerMode:se,setDeveloperMode:me,imageGenMode:pe,setImageGenMode:ce,generationMode:Ce,setGenerationMode:De,devSkipOutline:Ge,setDevSkipOutline:Ne,devSkipText:ze,setDevSkipText:fe,devSkipSceneDescriptions:Re,setDevSkipSceneDescriptions:J,devSkipImages:q,setDevSkipImages:I,devSkipCovers:ke,setDevSkipCovers:Be,enableAutoRepair:Ie,setEnableAutoRepair:nt,useGridRepair:Qe,setUseGridRepair:gt,forceRepairThreshold:Rr,setForceRepairThreshold:Bn,enableFinalChecks:Ca,setEnableFinalChecks:Fn,incrementalConsistency:qt,setIncrementalConsistency:Mn,incrementalConsistencyDryRun:ka,setIncrementalConsistencyDryRun:zn,lookbackCount:It,setLookbackCount:_n,checkOnlyMode:ja,setCheckOnlyMode:Ln,enableSceneValidation:Aa,setEnableSceneValidation:Hn,separatedEvaluation:Na,setSeparatedEvaluation:Wn,enableFullRepairAfterGeneration:Ta,setEnableFullRepairAfterGeneration:On,loadAllAvatars:nr,setLoadAllAvatars:Vn,useMagicApiRepair:qn,setUseMagicApiRepair:Un,modelSelections:_e,setModelSelections:Kn}=ro(),[ht,Ut]=s.useState(()=>localStorage.getItem("story_type")||""),[ue,Gr]=s.useState(()=>localStorage.getItem("story_category")||""),[Te,Br]=s.useState(()=>localStorage.getItem("story_topic")||""),[Pe,Fr]=s.useState(()=>localStorage.getItem("story_theme")||""),[Xe,Mr]=s.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[et,Kt]=s.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[ee,ye]=s.useState([]),[Jn,zr]=s.useState(null),[g,ve]=s.useState(null),Pa=s.useRef([]),Da=s.useRef(null),[Zn,_r]=s.useState(!1),[Yn,We]=s.useState("photo"),[Qn,Jt]=s.useState(!1),[Ia,st]=s.useState(null),[Xn,$a]=s.useState(!1),[es,sr]=s.useState(!1),[ts,Ea]=s.useState(void 0),[rs,Ra]=s.useState(void 0),as=s.useRef(null),[ns,Lr]=s.useState(!1),[Ga,Hr]=s.useState([]),[ir,Wr]=s.useState(null),[Or,Vr]=s.useState(null),[Oe,or]=s.useState({}),[it,qr]=s.useState({}),[$t,Ba]=s.useState([]),Ur=s.useRef(null),ss=s.useRef(!1),Et=s.useRef(!1),[lr,Fa]=s.useState(!1),[mt,ft]=s.useState([]),[Le,Zt]=s.useState([]),cr=s.useRef(!1),[tt,dr]=s.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[rt,Ma]=s.useState(()=>{try{const r=localStorage.getItem("story_language");if(r){if(r==="de")return"de-ch";if(r==="fr")return"fr-ch";if(r==="it")return"it-ch";if(r==="en")return"en-gb";if(r.startsWith("de")||r.startsWith("fr")||r.startsWith("it")||r.startsWith("en")||r.startsWith("gsw"))return r}return"de-ch"}catch{return"de-ch"}}),[Ve,Kr]=s.useState(()=>{try{const r=localStorage.getItem("story_pages");return r?parseInt(r):30}catch{return 30}}),[bt,ur]=s.useState(()=>localStorage.getItem("story_dedication")||""),[St,Rt]=s.useState(()=>localStorage.getItem("story_details")||""),[wt,Yt]=s.useState(!1),[gr,Gt]=s.useState(!1),[hr,Bt]=s.useState(!1),[is,Jr]=s.useState(0),[os,Zr]=s.useState(0),[mr,Yr]=s.useState(null),[za,Qr]=s.useState(""),[pt,Ft]=s.useState([]),[ls,_a]=s.useState(null),[La,cs]=s.useState(null),Ct=s.useRef(null),[kt,Ha]=s.useState(null),[jt,ds]=s.useState(()=>Rn()),[ot,Mt]=s.useState(!1),[us,Wa]=s.useState(new Set),[gs,Oa]=s.useState(!1),[hs,fr]=s.useState(!1),[ms,Xr]=s.useState(!1),[fs,ea]=s.useState(!1),[ps,Va]=s.useState(!1),[ys,pr]=s.useState(!1),[ta,At]=s.useState({current:0,total:0,message:""}),[at,lt]=s.useState(null),[vs,zt]=s.useState(!1),[yr,yt]=s.useState(""),[_t,Qt]=s.useState(""),[xs,qa]=s.useState(""),[bs,Ua]=s.useState(""),[Ss,Ka]=s.useState(""),[ws,Ja]=s.useState(),[Cs,Za]=s.useState(),[ks,Ya]=s.useState([]),[js,Lt]=s.useState(null),[As,vr]=s.useState(null),[Ns,ra]=s.useState([]),[Ts,aa]=s.useState([]),[Ps,na]=s.useState([]),[Qa,sa]=s.useState(null),[Ds,Ht]=s.useState([]),[xr,Fe]=s.useState([]),[vt,qe]=s.useState({frontCover:null,initialPage:null,backCover:null}),[O,ia]=s.useState(null),[Is,$s]=s.useState(0),[oa,br]=s.useState(null),[Es,Xa]=s.useState(!1),[Rs,en]=s.useState(),[Gs,tn]=s.useState(),[Bs,rn]=s.useState(),[Fs,la]=s.useState(null),ca=s.useRef(!1),[Ms,an]=s.useState(null),xt=s.useRef(!1),da=s.useRef(!1),[Ue,Sr]=s.useState(null),[ua,wr]=s.useState({}),[zs,Cr]=s.useState(!1),[$e,kr]=s.useState(null),[Xt,er]=s.useState("");s.useEffect(()=>{Pa.current=ee},[ee]),s.useEffect(()=>{Da.current=g},[g]),s.useEffect(()=>{if(!le&&!G){if(!!localStorage.getItem("auth_token")){i.debug("Token found but not authenticated yet, waiting for state sync...");return}const c=window.location.pathname+window.location.search,d=encodeURIComponent(c);e(`/?login=true&redirect=${d}`)}},[G,le,e]);const jr=s.useCallback(r=>{var c,d,f,b,o,h,l,w,m,E;if(r){if((c=r.sceneImages)!=null&&c.length&&Fe(p=>p.map(y=>{const B=r.sceneImages.find(ie=>ie.pageNumber===y.pageNumber);return B?{...y,prompt:B.prompt??y.prompt,qualityReasoning:B.qualityReasoning??y.qualityReasoning,retryHistory:B.retryHistory??y.retryHistory,repairHistory:B.repairHistory??y.repairHistory,wasRegenerated:B.wasRegenerated??y.wasRegenerated,originalScore:B.originalScore??y.originalScore,originalReasoning:B.originalReasoning??y.originalReasoning,totalAttempts:B.totalAttempts??y.totalAttempts,faceEvaluation:B.faceEvaluation??y.faceEvaluation,referencePhotos:B.referencePhotos??y.referencePhotos,landmarkPhotos:B.landmarkPhotos??y.landmarkPhotos,consistencyRegen:B.consistencyRegen??y.consistencyRegen}:y})),r.coverImages&&qe(p=>{var ie;const y={...p},B=["frontCover","initialPage","backCover"];for(const te of B){const N=(ie=r.coverImages)==null?void 0:ie[te],oe=p[te];N&&typeof oe=="object"&&oe!==null&&(y[te]={...oe,prompt:N.prompt??oe.prompt,qualityReasoning:N.qualityReasoning??oe.qualityReasoning,retryHistory:N.retryHistory??oe.retryHistory,referencePhotos:N.referencePhotos??oe.referencePhotos,landmarkPhotos:N.landmarkPhotos??oe.landmarkPhotos})}return y}),console.log("[StoryWizard] Dev metadata generationLog:",((d=r.generationLog)==null?void 0:d.length)||0,"entries"),(f=r.generationLog)!=null&&f.length&&na(r.generationLog),(b=r.styledAvatarGeneration)!=null&&b.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",((o=r.styledAvatarGeneration)==null?void 0:o.length)??0,"entries"),ra(r.styledAvatarGeneration)),(h=r.costumedAvatarGeneration)!=null&&h.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",((l=r.costumedAvatarGeneration)==null?void 0:l.length)??0,"entries"),aa(r.costumedAvatarGeneration)),r.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",r.finalChecksReport.totalIssues,"issues"),sa(r.finalChecksReport)),(w=r.sceneDescriptions)!=null&&w.length){const p=r.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",p.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(p[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((m=p[0])!=null&&m.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((E=p[0])!=null&&E.scenePrompt)),Ht(r.sceneDescriptions)}r.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),Lt(r.visualBible))}},[]);s.useEffect(()=>{he.getUserLocation().then(r=>{Ha(r),r!=null&&r.city&&he.triggerLandmarkDiscovery(r.city,r.country)})},[]),s.useEffect(()=>{G&&he.getStories({limit:1}).then(({pagination:r})=>{Va(r.total>0)}).catch(()=>Va(!1))},[G]);const ga=s.useRef(null);s.useEffect(()=>{const r=n.get("storyId");n.get("new")!=="true"&&(r&&(ga.current=null),z&&!r&&ga.current!==z.jobId&&(i.info("Returning during active generation, restoring progress for job:",z.jobId),ga.current=z.jobId,X(6),Mt(!0),yt(z.storyTitle),br(z.jobId),he.getJobStatus(z.jobId).then(d=>{var f,b;if(i.info("Restored job status:",{progress:d.progress,hasStoryText:!!d.storyText,storyTextKeys:d.storyText?Object.keys(d.storyText):[],pageTextsCount:(f=d.storyText)!=null&&f.pageTexts?Object.keys(d.storyText.pageTexts).length:0,partialPages:((b=d.partialPages)==null?void 0:b.length)||0}),d.progress&&At(o=>d.progress.current>=o.current?d.progress:{...o,message:d.progress.message}),d.storyText){const o=d.storyText.pageTexts||{};i.info("Setting progressiveStoryData with",Object.keys(o).length,"pages"),Sr({title:d.storyText.title||z.storyTitle,dedication:d.storyText.dedication,pageTexts:o,sceneDescriptions:d.storyText.sceneDescriptions||[],totalPages:d.storyText.totalPages||Ve})}else i.warn("No storyText in job status response");if(d.partialPages&&d.partialPages.length>0){const o={};d.partialPages.forEach(h=>{h.pageNumber&&h.imageData&&(o[h.pageNumber]=h.imageData)}),i.info("Restored",Object.keys(o).length,"page images"),wr(o)}d.partialCovers&&qe(o=>{var h,l,w;return{frontCover:((h=d.partialCovers)==null?void 0:h.frontCover)||o.frontCover,initialPage:((l=d.partialCovers)==null?void 0:l.initialPage)||o.initialPage,backCover:((w=d.partialCovers)==null?void 0:w.backCover)||o.backCover}})}).catch(d=>{i.error("Failed to restore job status:",d)})),i.debug("Auto-nav check:",{generationComplete:V,completedStoryId:de,urlStoryId:r,hasActiveJob:!!z}),V&&de&&!r&&(i.info("Generation completed, navigating to story:",de),u({storyId:de},{replace:!0})))},[z,V,de,n,u,Ve]),s.useEffect(()=>{if(n.get("new")==="true"){i.info("New story requested - resetting all story settings"),Ut(""),Gr(""),Br(""),Fr(""),Mr(""),Kt("watercolor"),dr("standard"),Kr(30),ur(""),Rt(""),zr(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const c=new URLSearchParams(n);c.delete("new"),u(c,{replace:!0}),ve(null),We("photo"),X(1)}},[n,u]),s.useEffect(()=>{const r=n.get("storyId");r&&D!==6&&X(6),(async()=>{if(!(!r||!G)){if(ca.current){ca.current=!1,i.info("Skipping story reload - just finished generating");return}i.info("Loading saved story (two-phase):",r),H(null),lt(null);try{const d=await he.getQuickMetadata(r);if(!d)throw new Error("Story not found");i.info("Quick metadata loaded:",d.title,`(${d.pageCount} pages)`),ia(d.id),yt(d.title),Ma(d.language),dr(d.languageLevel),Fe(Array.from({length:d.pageCount},(l,w)=>({pageNumber:w+1,imageData:void 0,hasImage:!0}))),qe(d.hasFrontCover?{frontCover:{hasImage:!0,imageData:void 0},initialPage:null,backCover:null}:{frontCover:null,initialPage:null,backCover:null}),X(6),L(!1),Mt(!1),H(null);const f=d.pageCount+(d.hasFrontCover?3:0);f>0&&lt({loaded:0,total:f}),he.getStoryMetadata(r).then(l=>{var w,m,E;l&&(i.info("Full metadata loaded:",l.title,`(${l.totalImages} images to load)`),Ua(l.outline||""),Ka(l.outlinePrompt||""),Ja(l.outlineModelId),Za(l.outlineUsage),Ya(l.storyTextPrompts||[]),ra(l.styledAvatarGeneration||[]),aa(l.costumedAvatarGeneration||[]),Ut(l.storyType||""),Kt(l.artStyle||"pixar"),ur(l.dedication||""),(w=l.generationLog)!=null&&w.length&&na(l.generationLog),l.visualBible?Lt({mainCharacters:l.visualBible.mainCharacters||[],secondaryCharacters:l.visualBible.secondaryCharacters||[],animals:l.visualBible.animals||[],artifacts:l.visualBible.artifacts||[],locations:l.visualBible.locations||[],vehicles:l.visualBible.vehicles||[],clothing:l.visualBible.clothing||[],changeLog:l.visualBible.changeLog||[]}):Lt(null),l.clothingRequirements?vr(l.clothingRequirements):vr(null),Fe(p=>(l.sceneImages||[]).map(B=>{const ie=p.find(te=>te.pageNumber===B.pageNumber);return{...B,imageData:(ie==null?void 0:ie.imageData)||B.imageData}})),Ht(l.sceneDescriptions||[]),qe(p=>{const y=l.coverImages||{frontCover:null,initialPage:null,backCover:null};return{frontCover:y.frontCover?{...typeof y.frontCover=="object"?y.frontCover:{imageData:y.frontCover},imageData:(p.frontCover&&typeof p.frontCover=="object"?p.frontCover.imageData:p.frontCover)||(typeof y.frontCover=="object"?y.frontCover.imageData:y.frontCover)}:null,initialPage:y.initialPage?{...typeof y.initialPage=="object"?y.initialPage:{imageData:y.initialPage},imageData:(p.initialPage&&typeof p.initialPage=="object"?p.initialPage.imageData:p.initialPage)||(typeof y.initialPage=="object"?y.initialPage.imageData:y.initialPage)}:null,backCover:y.backCover?{...typeof y.backCover=="object"?y.backCover:{imageData:y.backCover},imageData:(p.backCover&&typeof p.backCover=="object"?p.backCover.imageData:p.backCover)||(typeof y.backCover=="object"?y.backCover.imageData:y.backCover)}:null}}),Xa(l.isPartial||!1),en(l.failureReason),tn(l.generatedPages),rn(l.totalPages),Qt(l.story||""),qa(l.originalStory||l.story||""),la({storyCategory:l.storyCategory,storyTopic:l.storyTopic,storyTheme:l.storyTheme,storyTypeName:l.storyTypeName,storyDetails:l.storyDetails,artStyle:l.artStyle,language:l.language,languageLevel:l.languageLevel,pages:l.pages,dedication:l.dedication,characters:(m=l.characters)==null?void 0:m.map(p=>{var y;return{id:p.id,name:p.name,isMain:(y=l.mainCharacters)==null?void 0:y.includes(p.id)}}),mainCharacters:l.mainCharacters,relationships:l.relationships,relationshipTexts:l.relationshipTexts,season:l.season,userLocation:l.userLocation}),(E=l.characters)!=null&&E.length&&zr(l.characters.map(p=>{var y,B;return{id:p.id,name:p.name,photoData:p.photoData||((y=p.photos)==null?void 0:y.face)||((B=p.photos)==null?void 0:B.original)}})),l.totalImages>0&&lt(p=>p?{...p,total:l.totalImages}:null))}).catch(l=>{i.warn("Failed to load full metadata:",l)}),se&&(xt.current=!0,he.getStoryDevMetadata(r).then(l=>{jr(l),i.debug("Dev metadata merged into story")}).catch(l=>{i.warn("Failed to load dev metadata:",l),xt.current=!1}));const b=3e4,o=he.getAllImages(r,!0),h=new Promise(l=>setTimeout(()=>{i.warn("Image load timeout - clearing progress indicator"),l(null)},b));Promise.race([o,h]).then(l=>{if(!l){lt(null);return}const w=l.images||[],m=l.covers||{},E=Object.keys(m).filter(y=>{var B;return(B=m[y])==null?void 0:B.imageData}).length,p=w.filter(y=>y.imageData).length;if(i.info(`Fast images loaded: ${p} pages, ${E} covers`),p>0||E>0){let y=0;const B=["frontCover","initialPage","backCover"];for(const ie of B){const te=m[ie];te!=null&&te.imageData&&(y++,qe(N=>{const oe=N[ie];return typeof oe=="object"&&oe!==null?{...N,[ie]:{...oe,imageData:te.imageData}}:{...N,[ie]:te.imageData}}),lt(N=>N?{...N,loaded:y}:null))}for(const ie of w)ie.imageData&&(y++,Fe(te=>te.map(N=>N.pageNumber!==ie.pageNumber?N:{...N,imageData:ie.imageData})),lt(te=>te?{...te,loaded:y}:null));i.info("Fast images displayed")}lt(null),he.getAllImages(r,!1).then(y=>{const B=(y==null?void 0:y.images)||[],ie=(y==null?void 0:y.covers)||{};i.info(`Full images loaded: ${B.length} pages with versions`);for(const N of B)N.imageVersions&&N.imageVersions.length>0&&Fe(oe=>oe.map(R=>{var C;if(R.pageNumber!==N.pageNumber)return R;const A=(C=N.imageVersions)==null?void 0:C.map((P,j)=>{var M;return{...((M=R.imageVersions)==null?void 0:M[j])||{},...P}});return{...R,imageData:R.imageData||N.imageData,imageVersions:A}}));const te=["frontCover","initialPage","backCover"];for(const N of te){const oe=ie[N];oe&&qe(R=>{const A=typeof R[N]=="object"?R[N]:{};return{...R,[N]:{...A,...oe,imageData:(A==null?void 0:A.imageData)||oe.imageData}}})}i.info("Full image data with versions loaded")}).catch(y=>{i.warn("Failed to load full images (versions may be unavailable):",y)})}).catch(l=>{i.warn("Failed to load images:",l),lt(null)})}catch(d){i.error("Failed to load story:",d),L(!1),H(null),lt(null)}}})()},[n,G,Is]),s.useEffect(()=>{D===6&&ne&&(i.info("Clearing unviewed completion - user is viewing story"),Y())},[D,ne,Y]),s.useEffect(()=>{(async()=>{const c=n.get("payment"),d=n.get("session_id");if(c==="success"&&d){i.info("Payment successful! Checking order status..."),i.info("Session ID:",d);try{const o=await he.getOrderStatus(d);if(i.info("Order Status:",o),o.order){const h=`CHF ${(o.order.amount_total/100).toFixed(2)}`,l={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement r√©ussi!"},w={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a √©t√© re√ßue et sera bient√¥t imprim√©e."},m=[`${a==="de"?"Kunde":a==="fr"?"Client":"Customer"}: ${o.order.customer_name}`,`Email: ${o.order.customer_email}`,`${a==="de"?"Betrag":a==="fr"?"Montant":"Amount"}: ${h}`,`${a==="de"?"Versand an":a==="fr"?"Exp√©di√© √†":"Shipping to"}: ${o.order.shipping_name}`,`${o.order.shipping_address_line1}`,`${o.order.shipping_postal_code} ${o.order.shipping_city}`,`${o.order.shipping_country}`];Z(w[a]||w.en,l[a]||l.en,m)}}catch(o){i.error("Error checking order status:",o)}const b=new URLSearchParams(n);b.delete("payment"),b.delete("session_id"),u(b,{replace:!0})}else if(c==="cancelled"){i.info("Payment cancelled by user");const b={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie k√∂nnen es erneut versuchen.",fr:"Paiement annul√©. Vous pouvez r√©essayer quand vous √™tes pr√™t."};F(b[a]||b.en,a==="de"?"Abgebrochen":a==="fr"?"Annul√©":"Cancelled");const o=new URLSearchParams(n);o.delete("payment"),u(o,{replace:!0})}const f=n.get("credits_payment");if(f==="success"){i.info("Credits payment successful!"),await U();const b={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},o={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};Z(o[a]||o.en,b[a]||b.en);const h=new URLSearchParams(n);h.delete("credits_payment"),h.delete("session_id"),u(h,{replace:!0})}else if(f==="cancelled"){i.info("Credits payment cancelled by user");const b={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};F(b[a]||b.en,a==="de"?"Abgebrochen":a==="fr"?"Annule":"Cancelled");const o=new URLSearchParams(n);o.delete("credits_payment"),u(o,{replace:!0})}})()},[n,u,a,Z,F,U]);const Ar=s.useRef(!1);s.useEffect(()=>{if(n.get("autoGenerate")==="true"&&!Ar.current){Ar.current=!0;const c=localStorage.getItem("pending_story_type"),d=localStorage.getItem("pending_art_style");c&&(Ut(c),localStorage.removeItem("pending_story_type")),d&&(Kt(d),localStorage.removeItem("pending_art_style")),X(6);const f=new URLSearchParams(n);f.delete("autoGenerate"),u(f,{replace:!0})}},[n,u]);const ha=r=>{if(r.length===0)return;const c=r.filter(d=>{const f=parseInt(d.age);return f>=1&&f<=10});if(c.length>0){const d=c.map(f=>f.id);ft(d),i.info(`Auto-selected ${c.length} main character(s) aged 1-10`)}else{const d=r.reduce((f,b)=>{const o=parseInt(b.age)||999,h=parseInt(f.age)||999;return o<h?b:f});ft([d.id]),i.info(`Auto-selected youngest character as main: ${d.name} (age ${d.age})`)}};s.useEffect(()=>{G?(async()=>{try{L(!0);const c=await Se.getCharacterData(nr);if(i.info("Loaded character data from API:",{characters:c.characters.length,relationships:Object.keys(c.relationships).length}),ye(c.characters),Object.keys(c.relationships).length>0&&(or(c.relationships),ss.current=!0),Object.keys(c.relationshipTexts).length>0&&qr(c.relationshipTexts),c.customRelationships.length>0&&Ba(c.customRelationships),c.characters.some(f=>f.storyRole)){const f=[],b=[];for(const o of c.characters)o.storyRole==="main"?f.push(o.id):o.storyRole==="out"&&b.push(o.id);ft(f),Zt(b),i.info(`Loaded character roles from database: ${f.length} main, ${b.length} excluded`)}else c.characters.length>0&&ha(c.characters)}catch(c){i.error("Failed to load character data:",c)}finally{L(!1),Fa(!0)}})():le||Fa(!0)},[G,le]),s.useEffect(()=>{se&&O&&!xt.current&&(xt.current=!0,i.info("Developer mode enabled, fetching dev metadata for story:",O),he.getStoryDevMetadata(O).then(r=>{jr(r),i.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(r=>{i.warn("Failed to load dev metadata on toggle:",r),xt.current=!1})),(!se||!O)&&(xt.current=!1)},[se,O,jr]),s.useEffect(()=>{nr&&G&&lr&&(async()=>{try{i.info("Reloading characters with full avatars (dev mode)");const c=await Se.getCharacterData(!0);ye(c.characters),i.info(`Loaded ${c.characters.length} characters with full avatars`)}catch(c){i.error("Failed to reload with full avatars:",c)}})()},[nr,G,lr]),s.useEffect(()=>{D===1&&ee.length===0&&!g&&!Q&&lr&&fa()},[D,ee.length,g,Q,lr]);const ma=s.useRef(Le);s.useEffect(()=>{ma.current!==Le&&JSON.stringify(ma.current)!==JSON.stringify(Le)&&(Ft([]),Rt(""),ma.current=Le)},[Le]),s.useEffect(()=>{localStorage.setItem("story_language_level",tt)},[tt]),s.useEffect(()=>{localStorage.setItem("story_language",rt)},[rt]),s.useEffect(()=>{localStorage.setItem("story_pages",Ve.toString())},[Ve]),s.useEffect(()=>{localStorage.setItem("story_dedication",bt)},[bt]),s.useEffect(()=>{localStorage.setItem("story_details",St)},[St]),s.useEffect(()=>{localStorage.setItem("story_type",ht)},[ht]),s.useEffect(()=>{ue?localStorage.setItem("story_category",ue):localStorage.removeItem("story_category")},[ue]),s.useEffect(()=>{Te?localStorage.setItem("story_topic",Te):localStorage.removeItem("story_topic")},[Te]),s.useEffect(()=>{Pe?localStorage.setItem("story_theme",Pe):localStorage.removeItem("story_theme")},[Pe]),s.useEffect(()=>{Xe?localStorage.setItem("story_custom_theme_text",Xe):localStorage.removeItem("story_custom_theme_text")},[Xe]);const nn=s.useRef(ue),sn=s.useRef(Te),on=s.useRef(Pe),ln=s.useRef(!0);s.useEffect(()=>{if(ln.current){ln.current=!1;return}const r=nn.current!==ue,c=sn.current!==Te,d=on.current!==Pe;(r||c||d)&&(Rt(""),localStorage.removeItem("story_details"),Ft([])),nn.current=ue,sn.current=Te,on.current=Pe},[ue,Te,Pe]),s.useEffect(()=>{localStorage.setItem("story_art_style",et)},[et]);const tr=s.useRef(!1);s.useEffect(()=>{if(D===4&&!tr.current&&!wt&&pt.length===0){const r=!!ue,c=!!Pe||!!Te,d=ee.length>0;r&&c&&d&&(tr.current=!0,i.info("[StoryWizard] Pre-generating story ideas while user selects art style"),un())}tr.current&&pt.length===0&&(tr.current=!1)},[D,ue,Pe,Te,ee.length,wt,pt.length]);const cn=s.useRef({storyCategory:ue,storyTheme:Pe,storyTopic:Te});s.useEffect(()=>{const r=cn.current,c=r.storyCategory!==ue||r.storyTheme!==Pe||r.storyTopic!==Te;cn.current={storyCategory:ue,storyTheme:Pe,storyTopic:Te},c&&(wt||pt.length>0)&&(i.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),Ct.current&&(Ct.current.abort(),Ct.current=null),Yt(!1),Gt(!1),Bt(!1),Ft([]),Yr(null),Qr(""),tr.current=!1)},[ue,Pe,Te,wt,pt.length]),s.useEffect(()=>{if(!wt)return;const c=setTimeout(()=>{i.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),Yt(!1),Gt(!1),Bt(!1),k(a==="de"?"Zeit√ºberschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":a==="fr"?"D√©lai d'attente de g√©n√©ration d'id√©es. Veuillez r√©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(c)},[wt,a]),s.useEffect(()=>{if(!gr&&!hr){Jr(0),Zr(0);return}const r=35e3,c=80,d=100,f=Date.now(),b=setInterval(()=>{const o=Date.now()-f,h=Math.min(o/r,1),l=1-Math.pow(1-h,3),w=Math.round(l*c);gr&&Jr(w),hr&&Zr(w),h>=1&&clearInterval(b)},d);return()=>clearInterval(b)},[gr,hr]),s.useEffect(()=>{D>=1&&D<=5&&localStorage.setItem("wizard_step",D.toString())},[D]);const _s=r=>{Gr(r)},Ls=r=>{Fr(r),!(r==="custom"||r==="realistic"||r==="")&&(ue==="adventure"||(ue==="life-challenge"||ue==="educational")&&Te!=="")&&ct(4)},Hs=r=>{Br(r),ue==="historical"&&r!==""&&ct(4)},Ws=r=>{Kt(r),ct(5)};s.useEffect(()=>{if(D===2&&ee.length>=2&&!Q){const r=ee.map(c=>c.id).sort().join("-");if(!Ur.current||Ur.current!==r){const d=Ui(a);i.debug("Initializing relationships for step 2",{charKey:r,existingCount:Object.keys(Oe).length}),or(f=>{const b={...f};let o=!1;return ee.forEach((h,l)=>{ee.forEach((w,m)=>{if(l!==m){const E=`${h.id}-${w.id}`;b[E]||(b[E]=d,o=!0,i.debug("Initializing missing relationship:",E))}})}),o?b:f}),Ur.current=r}}},[D,ee,a,Q]);const Os=()=>{if(ee.length<2)return!0;for(let r=0;r<ee.length;r++)for(let c=0;c<ee.length;c++)if(r!==c){const d=`${ee[r].id}-${ee[c].id}`,f=Oe[d];if(!f||Cn(f))return!1}return!0},Vs=()=>{if(ee.length<2)return null;let r=0,c=null;for(const d of ee){let f=0;for(const b of ee)if(d.id!==b.id){const o=`${d.id}-${b.id}`,h=Oe[o];(!h||Cn(h))&&f++}f>r&&(r=f,c=d)}return c},fa=()=>{ve({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),We("photo"),_r(!1)},qs=(r,c=1500)=>new Promise(d=>{const f=new Image;f.onload=()=>{const b=document.createElement("canvas");let{width:o,height:h}=f;(o>c||h>c)&&(o>h?(h=Math.round(h*c/o),o=c):(o=Math.round(o*c/h),h=c)),b.width=o,b.height=h;const l=b.getContext("2d");l==null||l.drawImage(f,0,0,o,h),d(b.toDataURL("image/jpeg",.85))},f.onerror=()=>d(r),f.src=r}),Us=async(r,c)=>{var b,o,h,l,w;if(i.info(`üì∏ handlePhotoSelect called: file=${r==null?void 0:r.name}, character=${g==null?void 0:g.name}, developerMode=${se}`),g&&!se){const m=!!((b=g.avatars)!=null&&b.winter||(o=g.avatars)!=null&&o.standard||(h=g.avatars)!=null&&h.summer||(l=g.avatars)!=null&&l.hasFullAvatars);if(i.info(`üì∏ hasAvatars=${m}`),m){const E=Er(g.id);if(i.info(`üì∏ cooldown check: canRegenerate=${E.canRegenerate}, waitSeconds=${E.waitSeconds}`),!E.canRegenerate){const p=a==="de"?`Bitte warten Sie ${E.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${E.waitSeconds} seconds before uploading a new photo.`;k(p);return}Gn(g.id)}}const d=c&&((w=g==null?void 0:g.clothing)!=null&&w.structured)?{...g.clothing.structured}:null,f=new FileReader;f.onload=async m=>{var p,y,B,ie,te,N,oe,R,A,C,P,j;const E=(p=m.target)==null?void 0:p.result;g&&(as.current={physical:g.physical,gender:g.gender,age:g.age}),Ea(void 0),Jt(!0),!(g!=null&&g.name)||g.name.trim().length<2?We("name"):(We("traits"),i.info("üì∏ Character has name, going to traits step to show avatar regeneration"));try{const M=await qs(E),xe=Math.round(E.length/1024),$=Math.round(M.length/1024);i.info(`Starting photo analysis... (${xe}KB -> ${$}KB)`);const ge=g!=null&&g.id&&g.id>0?g.id:void 0,W=await Se.analyzePhoto(M,a,void 0,void 0,ge);if(W.success){if(W.multipleFacesDetected&&W.faces&&W.faces.length>1){i.info(`Multiple faces detected (${W.faces.length}), showing selection modal`),Wr(M),Vr(d?{structured:d}:null),Hr(W.faces),Lr(!0),Jt(!1);return}i.info("Photo analysis complete:",{hasPhotos:!!W.photos,hasPhysical:!!W.physical,hasClothing:!!W.clothing,age:W.age,gender:W.gender}),W._debug&&(Ra(W._debug),W._debug.rawResponse,W._debug.error&&console.warn("üì∏ [DEBUG] Gemini error:",W._debug.error));const je={original:((y=W.photos)==null?void 0:y.face)||E,face:(B=W.photos)==null?void 0:B.face,body:((ie=W.photos)==null?void 0:ie.body)||E,bodyNoBg:(te=W.photos)==null?void 0:te.bodyNoBg,faceBox:(N=W.photos)==null?void 0:N.faceBox,bodyBox:(oe=W.photos)==null?void 0:oe.bodyBox},Ee=(R=W.photos)!=null&&R.bodyNoBg?Math.round(W.photos.bodyNoBg.length/1024):0,Me=(A=W.photos)!=null&&A.body?Math.round(W.photos.body.length/1024):0,Nr=(C=W.photos)!=null&&C.face?Math.round(W.photos.face.length/1024):0;if(i.info(`üì∏ [PHOTO CHANGE] Analysis returned: bodyNoBg=${Ee}KB, body=${Me}KB, face=${Nr}KB`),(P=W.photos)!=null&&P.bodyNoBg){const be=W.photos.bodyNoBg.substring(W.photos.bodyNoBg.indexOf("base64,")+7,W.photos.bodyNoBg.indexOf("base64,")+27);i.info(`üì∏ [PHOTO CHANGE] bodyNoBg fingerprint: ${be}...`)}let Ze,Tr;d?(Ze={structured:d},Tr={upperBody:d.upperBody?"user":void 0,lowerBody:d.lowerBody?"user":void 0,shoes:d.shoes?"user":void 0,fullBody:d.fullBody?"user":void 0},i.info(`üëï Keeping old clothing (marked as user-edited): ${JSON.stringify(d)}`)):i.info("üëï Using new photo's clothing (cleared existing)");const Pr=W.characterId,ya=(g==null?void 0:g.id)&&g.id>0,Wt=ya?g.id:Pr;ya?i.info(`üì∏ [PHOTO] Keeping existing character ID: ${g.id} (server created new ID ${Pr} but ignoring)`):Pr&&i.info(`üì∏ [PHOTO] Using server-created character ID: ${Pr}`);const Ke=g?{...g,id:Wt||g.id,photos:je,avatars:{status:"generating"},clothing:Ze,clothingSource:Tr}:null;if(Ke){const be=(j=Ke.photos)==null?void 0:j.bodyNoBg,He=be?Math.round(be.length/1024):0;if(i.info(`üì∏ [CHAR FOR GEN] bodyNoBg=${He}KB, has photos: ${!!Ke.photos}`),be){const we=be.substring(be.indexOf("base64,")+7,be.indexOf("base64,")+27);i.info(`üì∏ [CHAR FOR GEN] fingerprint: ${we}...`)}}if(ve(be=>{var we;if(!be)return null;const He=(we=be.avatars)!=null&&we.standard?{...be.avatars,status:"generating",stale:!0}:{status:"generating"};return{...be,id:Wt||be.id,photos:je,avatars:He,clothing:Ze,clothingSource:Tr}}),Wt&&!ya&&ye(be=>{if(!be.some(we=>we.id===Wt)){const we={...g,id:Wt,photos:je,avatars:{status:"generating"},clothing:Ze,clothingSource:Tr};return i.info(`üì∏ Adding new character ${Wt} to array to prevent data loss`),[...be,we]}return be}),i.info("üé® Auto-starting avatar generation in background..."),i.info(`üì∏ Photo for avatar: bodyNoBg=${!!je.bodyNoBg}, body=${!!je.body}, face=${!!je.face}`),Ke&&Ke.id&&Ke.name&&Ke.name.trim()){const be=Ke.id;st(be),Se.generateAndSaveAvatarForCharacter(Ke,void 0,{avatarModel:_e.avatarModel||void 0}).then(He=>{He.success&&He.character?(ve(we=>!we||we.id!==be?we:{...we,avatars:He.character.avatars,physical:He.character.physical,clothing:He.character.clothing}),ye(we=>we.map(Je=>Je.id===be?{...Je,...He.character,id:Je.id}:Je)),i.success(`‚úÖ Avatar generated and traits extracted for ${Ke.name}`)):(i.error(`‚ùå Avatar generation failed: ${He.error}`),ve(we=>we&&we.id===be?{...we,avatars:{status:"failed"}}:we),ye(we=>we.map(Je=>Je.id===be?{...Je,avatars:{status:"failed"}}:Je)))}).catch(He=>{i.error("‚ùå Avatar generation error:",He),ve(we=>we&&we.id===be?{...we,avatars:{status:"failed"}}:we),ye(we=>we.map(Je=>Je.id===be?{...Je,avatars:{status:"failed"}}:Je))}).finally(()=>{st(null)})}else Ke&&Ke.id?(i.info("‚è≠Ô∏è Skipping auto-generation: character has no name yet"),st(null),ve(be=>be&&{...be,avatars:{status:"pending"}})):(i.warn("‚è≠Ô∏è Skipping auto-generation: no character data available"),st(null))}else W.error==="no_face_detected"?(i.warn("No face detected in photo"),k(S.noFaceDetected)):(i.warn("Photo analysis returned no data, using original photo"),ve(je=>je?{...je,photos:{original:E},avatars:void 0}:null))}catch(M){i.error("Photo analysis error:",M),ve(xe=>xe?{...xe,photos:{original:E},avatars:void 0}:null)}finally{Jt(!1)}},f.readAsDataURL(r)},Ks=async r=>{var c,d,f,b,o,h,l,w;if(!ir){i.error("No pending photo data for face selection");return}Lr(!1),Jt(!0);try{i.info(`Re-analyzing photo with selected face ID: ${r}`);const m=Ga.map(y=>({id:y.id,x:y.faceBox.x,y:y.faceBox.y,width:y.faceBox.width,height:y.faceBox.height,confidence:y.confidence})),E=g!=null&&g.id&&g.id>0?g.id:void 0,p=await Se.analyzePhoto(ir,a,r,m,E);if(p.success){i.info("Photo analysis complete with selected face:",{hasPhotos:!!p.photos,hasPhysical:!!p.physical,hasClothing:!!p.clothing,age:p.age,gender:p.gender}),p._debug&&Ra(p._debug);const y=Or==null?void 0:Or.structured,B={original:((c=p.photos)==null?void 0:c.face)||ir,face:(d=p.photos)==null?void 0:d.face,body:((f=p.photos)==null?void 0:f.body)||ir,bodyNoBg:(b=p.photos)==null?void 0:b.bodyNoBg,faceBox:(o=p.photos)==null?void 0:o.faceBox,bodyBox:(h=p.photos)==null?void 0:h.bodyBox},ie=(l=p.photos)!=null&&l.bodyNoBg?Math.round(p.photos.bodyNoBg.length/1024):0;if(i.info(`üì∏ [FACE SELECT] Analysis returned: bodyNoBg=${ie}KB`),(w=p.photos)!=null&&w.bodyNoBg){const P=p.photos.bodyNoBg.substring(p.photos.bodyNoBg.indexOf("base64,")+7,p.photos.bodyNoBg.indexOf("base64,")+27);i.info(`üì∏ [FACE SELECT] bodyNoBg fingerprint: ${P}...`)}let te,N;y&&(te={structured:y},N={upperBody:y.upperBody?"user":void 0,lowerBody:y.lowerBody?"user":void 0,shoes:y.shoes?"user":void 0,fullBody:y.fullBody?"user":void 0});const oe=p.characterId,R=(g==null?void 0:g.id)&&g.id>0,A=R?g.id:oe;R?i.info(`üì∏ [FACE SELECT] Keeping existing character ID: ${g.id} (server created new ID ${oe} but ignoring)`):oe&&i.info(`üì∏ [FACE SELECT] Using server-created character ID: ${oe}`);const C=g?{...g,id:A||g.id,photos:B,avatars:{status:"generating"},clothing:te,clothingSource:N}:null;if(ve(P=>{var M;if(!P)return null;const j=(M=P.avatars)!=null&&M.standard?{...P.avatars,status:"generating",stale:!0}:{status:"generating"};return{...P,id:A||P.id,photos:B,avatars:j,clothing:te,clothingSource:N}}),A&&!R&&ye(P=>{if(!P.some(M=>M.id===A)){const M={...g,id:A,photos:B,avatars:{status:"generating"},clothing:te,clothingSource:N};return i.info(`üì∏ [FACE SELECT] Adding new character ${A} to array to prevent data loss`),[...P,M]}return P}),g!=null&&g.name&&g.name.trim().length>=2?(We("traits"),i.info("üì∏ Face selected, character has name, going to traits step")):We("name"),i.info("üé® Auto-starting avatar generation in background after face selection..."),i.info(`üì∏ Photo for avatar: bodyNoBg=${!!B.bodyNoBg}, body=${!!B.body}, face=${!!B.face}`),C&&C.name&&C.name.trim()){const P=C.id;st(P),Se.generateAndSaveAvatarForCharacter(C,void 0,{avatarModel:_e.avatarModel||void 0}).then(j=>{j.success&&j.character?(ve(M=>!M||M.id!==P?M:{...M,avatars:j.character.avatars,physical:j.character.physical,clothing:j.character.clothing}),ye(M=>M.map(xe=>xe.id===P?{...xe,...j.character,id:xe.id}:xe)),i.success(`‚úÖ Avatar generated for ${C.name} (face selection)`)):(i.error(`‚ùå Avatar generation failed: ${j.error}`),ve(M=>M&&M.id===P?{...M,avatars:{status:"failed"}}:M),ye(M=>M.map(xe=>xe.id===P?{...xe,avatars:{status:"failed"}}:xe)))}).catch(j=>{i.error("‚ùå Avatar generation error:",j),ve(M=>M&&M.id===P?{...M,avatars:{status:"failed"}}:M),ye(M=>M.map(xe=>xe.id===P?{...xe,avatars:{status:"failed"}}:xe))}).finally(()=>{st(null)})}else i.info("‚è≠Ô∏è Skipping auto-generation: character has no name yet"),st(null),ve(P=>P&&{...P,avatars:{status:"pending"}})}else i.warn("Photo analysis failed after face selection"),k(S.noFaceDetected)}catch(m){i.error("Photo analysis error after face selection:",m),k("Failed to analyze photo. Please try again.")}finally{Jt(!1),Wr(null),Vr(null),Hr([])}},Js=()=>{Lr(!1),Wr(null),Vr(null),Hr([]),We("photo")},Zs=async()=>{if(g){ve(r=>r&&{...r,avatars:void 0}),$a(!0);try{i.info(`üîÑ Regenerating avatars for ${g.name}...`);const r=await Se.regenerateAvatarsForCharacter(g.id,(c,d)=>i.info(`[${c}] ${d}`),{avatarModel:_e.avatarModel||void 0});if(r.success&&r.character){const c={...r.character.avatars,stale:!1};ve(d=>d&&{...d,avatars:c,physical:r.character.physical,clothing:r.character.clothing}),ye(d=>d.map(f=>f.id===g.id?{...f,avatars:c,physical:r.character.physical,clothing:r.character.clothing}:f)),i.success(`‚úÖ Avatars and traits regenerated for ${g.name}`)}else i.error(`‚ùå Failed to regenerate avatars: ${r.error}`),k(`Failed to regenerate avatars: ${r.error||"Unknown error"}`)}catch(r){i.error(`‚ùå Failed to regenerate avatars for ${g.name}:`,r),k(`Failed to regenerate avatars: ${r instanceof Error?r.message:"Unknown error"}`)}finally{$a(!1)}}},Ys=async()=>{var r,c,d,f,b,o,h,l,w,m,E,p,y,B,ie,te;if(g){ve(N=>N&&{...N,avatars:void 0}),sr(!0);try{i.info(`üîÑ Regenerating avatars WITH TRAITS for ${g.name}...`),i.info(`Physical traits: ${JSON.stringify(g.physical)}`);const N=await Se.generateClothingAvatarsWithTraits(g);if(N.success&&N.avatars){const oe={...N.avatars,stale:!1,generatedAt:new Date().toISOString()},R=g.physicalTraitsSource||{},A=N.extractedTraits?{height:(r=g.physical)==null?void 0:r.height,eyeColor:R.eyeColor==="user"?(c=g.physical)==null?void 0:c.eyeColor:N.extractedTraits.eyeColor,eyeColorHex:R.eyeColor==="user"?(d=g.physical)==null?void 0:d.eyeColorHex:N.extractedTraits.eyeColorHex,hairColor:R.hairColor==="user"?(f=g.physical)==null?void 0:f.hairColor:N.extractedTraits.hairColor,hairColorHex:R.hairColor==="user"?(b=g.physical)==null?void 0:b.hairColorHex:N.extractedTraits.hairColorHex,hairLength:R.hairLength==="user"?(o=g.physical)==null?void 0:o.hairLength:N.extractedTraits.hairLength,hairStyle:R.hairStyle==="user"?(h=g.physical)==null?void 0:h.hairStyle:N.extractedTraits.hairStyle,build:R.build==="user"?(l=g.physical)==null?void 0:l.build:N.extractedTraits.build,face:R.face==="user"?(w=g.physical)==null?void 0:w.face:N.extractedTraits.face,facialHair:R.facialHair==="user"?(m=g.physical)==null?void 0:m.facialHair:N.extractedTraits.facialHair,other:R.other==="user"?(E=g.physical)==null?void 0:E.other:N.extractedTraits.other,skinTone:R.skinTone==="user"?(p=g.physical)==null?void 0:p.skinTone:N.extractedTraits.skinTone,skinToneHex:R.skinTone==="user"?(y=g.physical)==null?void 0:y.skinToneHex:N.extractedTraits.skinToneHex,detailedHairAnalysis:N.extractedTraits.detailedHairAnalysis||((B=g.physical)==null?void 0:B.detailedHairAnalysis),apparentAge:R.apparentAge==="user"?(ie=g.physical)==null?void 0:ie.apparentAge:N.extractedTraits.apparentAge||((te=g.physical)==null?void 0:te.apparentAge)}:g.physical,C=N.extractedTraits?{eyeColor:R.eyeColor==="user"?"user":N.extractedTraits.eyeColor?"extracted":void 0,hairColor:R.hairColor==="user"?"user":N.extractedTraits.hairColor?"extracted":void 0,hairLength:R.hairLength==="user"?"user":N.extractedTraits.hairLength?"extracted":void 0,hairStyle:R.hairStyle==="user"?"user":N.extractedTraits.hairStyle?"extracted":void 0,build:R.build==="user"?"user":N.extractedTraits.build?"extracted":void 0,face:R.face==="user"?"user":N.extractedTraits.face?"extracted":void 0,facialHair:R.facialHair==="user"?"user":N.extractedTraits.facialHair?"extracted":void 0,other:R.other==="user"?"user":N.extractedTraits.other?"extracted":void 0,skinTone:R.skinTone==="user"?"user":N.extractedTraits.skinTone?"extracted":void 0,apparentAge:R.apparentAge==="user"?"user":N.extractedTraits.apparentAge?"extracted":void 0}:g.physicalTraitsSource,P=N.extractedClothing?{...g.clothing,structured:{upperBody:N.extractedClothing.upperBody||void 0,lowerBody:N.extractedClothing.lowerBody||void 0,shoes:N.extractedClothing.shoes||void 0,fullBody:N.extractedClothing.fullBody||void 0}}:g.clothing;ve(j=>j&&{...j,avatars:oe,physical:A,physicalTraitsSource:C,clothing:P}),ye(j=>j.map(M=>M.id===g.id?{...M,avatars:oe,physical:A,physicalTraitsSource:C,clothing:P}:M)),i.success(`‚úÖ Avatars WITH TRAITS regenerated for ${g.name}`),N.extractedTraits&&i.info(`üìã Extracted traits saved: ${JSON.stringify(N.extractedTraits)}`),N.extractedClothing&&i.info(`üëï Extracted clothing saved: ${JSON.stringify(N.extractedClothing)}`)}else i.error(`‚ùå Failed to regenerate avatars with traits: ${N.error}`),k(`Failed to regenerate avatars: ${N.error||"Unknown error"}`)}catch(N){i.error(`‚ùå Failed to regenerate avatars with traits for ${g.name}:`,N),k(`Failed to regenerate avatars: ${N instanceof Error?N.message:"Unknown error"}`)}finally{sr(!1)}}},Qs=async()=>{var d,f,b,o,h,l,w,m,E,p,y,B,ie,te,N,oe;if(!g)return;const r={...g},c=g.id;sr(!0);try{i.info(`üíæ Saving character and regenerating avatars for ${r.name}...`),await pa(),i.info(`üîÑ Regenerating avatars WITH TRAITS for ${r.name}...`);const A=(await new Promise(P=>{ye(j=>(P(j),j))})).find(P=>P.id===c);if(!A){i.warn("Character not found in characters array after save");return}const C=await Se.generateClothingAvatarsWithTraits(A);if(C.success&&C.avatars){const P={...C.avatars,stale:!1,generatedAt:new Date().toISOString()},j=A.physicalTraitsSource||{},M=C.extractedTraits?{height:(d=A.physical)==null?void 0:d.height,eyeColor:j.eyeColor==="user"?(f=A.physical)==null?void 0:f.eyeColor:C.extractedTraits.eyeColor,eyeColorHex:j.eyeColor==="user"?(b=A.physical)==null?void 0:b.eyeColorHex:C.extractedTraits.eyeColorHex,hairColor:j.hairColor==="user"?(o=A.physical)==null?void 0:o.hairColor:C.extractedTraits.hairColor,hairColorHex:j.hairColor==="user"?(h=A.physical)==null?void 0:h.hairColorHex:C.extractedTraits.hairColorHex,hairLength:j.hairLength==="user"?(l=A.physical)==null?void 0:l.hairLength:C.extractedTraits.hairLength,hairStyle:j.hairStyle==="user"?(w=A.physical)==null?void 0:w.hairStyle:C.extractedTraits.hairStyle,build:j.build==="user"?(m=A.physical)==null?void 0:m.build:C.extractedTraits.build,face:j.face==="user"?(E=A.physical)==null?void 0:E.face:C.extractedTraits.face,facialHair:j.facialHair==="user"?(p=A.physical)==null?void 0:p.facialHair:C.extractedTraits.facialHair,other:j.other==="user"?(y=A.physical)==null?void 0:y.other:C.extractedTraits.other,skinTone:j.skinTone==="user"?(B=A.physical)==null?void 0:B.skinTone:C.extractedTraits.skinTone,skinToneHex:j.skinTone==="user"?(ie=A.physical)==null?void 0:ie.skinToneHex:C.extractedTraits.skinToneHex,detailedHairAnalysis:C.extractedTraits.detailedHairAnalysis||((te=A.physical)==null?void 0:te.detailedHairAnalysis),apparentAge:j.apparentAge==="user"?(N=A.physical)==null?void 0:N.apparentAge:C.extractedTraits.apparentAge||((oe=A.physical)==null?void 0:oe.apparentAge)}:A.physical,xe=C.extractedTraits?{eyeColor:j.eyeColor==="user"?"user":C.extractedTraits.eyeColor?"extracted":void 0,hairColor:j.hairColor==="user"?"user":C.extractedTraits.hairColor?"extracted":void 0,hairLength:j.hairLength==="user"?"user":C.extractedTraits.hairLength?"extracted":void 0,hairStyle:j.hairStyle==="user"?"user":C.extractedTraits.hairStyle?"extracted":void 0,build:j.build==="user"?"user":C.extractedTraits.build?"extracted":void 0,face:j.face==="user"?"user":C.extractedTraits.face?"extracted":void 0,facialHair:j.facialHair==="user"?"user":C.extractedTraits.facialHair?"extracted":void 0,other:j.other==="user"?"user":C.extractedTraits.other?"extracted":void 0,skinTone:j.skinTone==="user"?"user":C.extractedTraits.skinTone?"extracted":void 0,apparentAge:j.apparentAge==="user"?"user":C.extractedTraits.apparentAge?"extracted":void 0}:A.physicalTraitsSource,$=C.extractedClothing?{...A.clothing,structured:{upperBody:C.extractedClothing.upperBody||void 0,lowerBody:C.extractedClothing.lowerBody||void 0,shoes:C.extractedClothing.shoes||void 0,fullBody:C.extractedClothing.fullBody||void 0}}:A.clothing;ve(Ee=>Ee&&Ee.id===c?{...Ee,avatars:P,physical:M,physicalTraitsSource:xe,clothing:$}:Ee),ye(Ee=>Ee.map(Me=>Me.id===c?{...Me,avatars:P,physical:M,physicalTraitsSource:xe,clothing:$}:Me)),i.success(`‚úÖ Avatars regenerated for ${A.name}`);const ge={...A,avatars:P,physical:M,physicalTraitsSource:xe,clothing:$},je=(await new Promise(Ee=>{ye(Me=>(Ee(Me),Me))})).map(Ee=>Ee.id===c?ge:Ee);await Se.saveCharacterData({characters:je,relationships:Oe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]}),i.success("üíæ Character saved with new avatars, traits, and clothing"),Z(a==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else i.error(`‚ùå Failed to regenerate avatars: ${C.error}`),k(`Failed to regenerate avatars: ${C.error||"Unknown error"}`)}catch(R){i.error("‚ùå Failed to save and regenerate:",R),k(`Failed: ${R instanceof Error?R.message:"Unknown error"}`)}finally{sr(!1)}},Xs=async()=>{var f,b,o,h,l,w,m,E,p,y,B,ie,te,N,oe,R,A,C;if(!g)return;const r=g.id;Ea(void 0),We("traits");const c=(f=g.avatars)==null?void 0:f.status,d=!!((b=g.avatars)!=null&&b.standard||(o=g.avatars)!=null&&o.winter||(h=g.avatars)!=null&&h.summer||(l=g.avatars)!=null&&l.hasFullAvatars);if(c==="generating"||c==="complete"&&d){i.info(`‚è≠Ô∏è Skipping avatar generation - already ${c}${d?" with avatars":""}`);return}st(r),ve(P=>P&&P.id===r?{...P,avatars:{status:"generating"}}:P),i.info(`üé® Starting avatar generation for ${g.name||"unnamed"} (id: ${r})...`);try{const P=await Se.generateClothingAvatarsWithTraits(g);if(P.success&&P.avatars){const j={...P.avatars,stale:!1,generatedAt:new Date().toISOString()},M=P.extractedTraits?{...g.physical,build:P.extractedTraits.build||((w=g.physical)==null?void 0:w.build),eyeColor:P.extractedTraits.eyeColor||((m=g.physical)==null?void 0:m.eyeColor),eyeColorHex:P.extractedTraits.eyeColorHex||((E=g.physical)==null?void 0:E.eyeColorHex),hairColor:P.extractedTraits.hairColor||((p=g.physical)==null?void 0:p.hairColor),hairColorHex:P.extractedTraits.hairColorHex||((y=g.physical)==null?void 0:y.hairColorHex),hairLength:P.extractedTraits.hairLength||((B=g.physical)==null?void 0:B.hairLength),hairStyle:P.extractedTraits.hairStyle||((ie=g.physical)==null?void 0:ie.hairStyle),facialHair:P.extractedTraits.facialHair||((te=g.physical)==null?void 0:te.facialHair),skinTone:P.extractedTraits.skinTone||((N=g.physical)==null?void 0:N.skinTone),skinToneHex:P.extractedTraits.skinToneHex||((oe=g.physical)==null?void 0:oe.skinToneHex),face:P.extractedTraits.face||((R=g.physical)==null?void 0:R.face),other:P.extractedTraits.other||((A=g.physical)==null?void 0:A.other),detailedHairAnalysis:P.extractedTraits.detailedHairAnalysis||((C=g.physical)==null?void 0:C.detailedHairAnalysis)}:g.physical,xe=P.extractedClothing?{...g.clothing,structured:{upperBody:P.extractedClothing.upperBody||void 0,lowerBody:P.extractedClothing.lowerBody||void 0,shoes:P.extractedClothing.shoes||void 0,fullBody:P.extractedClothing.fullBody||void 0}}:g.clothing;ye($=>$.map(ge=>ge.id===r?{...ge,avatars:j,physical:M,clothing:xe}:ge)),ve($=>$&&$.id===r?{...$,avatars:j,physical:M,clothing:xe}:$),i.success(`‚úÖ Avatar generated for ${g.name} (id: ${r})`)}else i.error(`‚ùå Failed to generate avatar: ${P.error}`),k(`Failed to generate avatar: ${P.error||"Unknown error"}`),ye(j=>j.map(M=>M.id===r?{...M,avatars:{status:"failed"}}:M)),ve(j=>j&&j.id===r?{...j,avatars:{status:"failed"}}:j)}catch(P){i.error("‚ùå Avatar generation failed:",P),k(`Avatar generation failed: ${P instanceof Error?P.message:"Unknown error"}`),ye(j=>j.map(M=>M.id===r?{...M,avatars:{status:"failed"}}:M)),ve(j=>j&&j.id===r?{...j,avatars:{status:"failed"}}:j)}finally{st(null)}},pa=async()=>{var r;if(g){L(!0);try{const c=Da.current,d=Pa.current;if(!c){i.warn("No current character to save");return}const f=c.id&&d.find(l=>l.id===c.id),b=f?d.map(l=>l.id===c.id?c:l):[...d,c];i.info("Saving characters with relationships:",b.length);const o=!f&&!!((r=c.photos)!=null&&r.original);await Se.saveCharacterData({characters:b,relationships:Oe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:o}),Et.current=!1,i.success("Character data saved successfully"),ye(b),ha(b);const h=b.find(l=>l.id===g.id);h&&Se.needsAvatars(h)&&Ia!==h.id&&(i.info(`üé® Starting background avatar generation for ${h.name}...`),Se.generateAndSaveAvatarForCharacter(h,void 0,{avatarModel:_e.avatarModel||void 0}).then(l=>{l.success&&l.character?(ye(w=>w.map(m=>m.id===h.id?{...m,avatars:l.character.avatars,physical:l.character.physical,clothing:l.character.clothing}:m)),i.success(`‚úÖ Avatars and traits saved for ${h.name}`)):l.skipped||(i.warn(`Avatar generation failed for ${h.name}: ${l.error}`),ye(w=>w.map(m=>m.id===h.id?{...m,avatars:{status:"failed"}}:m)))}).catch(l=>{i.error(`‚ùå Background avatar generation error for ${h.name}:`,l),ye(w=>w.map(m=>m.id===h.id?{...m,avatars:{status:"failed"}}:m))})),ve(null),_r(!0)}catch(c){i.error("Failed to save character:",c),k(a==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":a==="fr"?"√âchec de l'enregistrement du personnage. Veuillez r√©essayer.":"Failed to save character. Please try again.")}finally{L(!1)}}},ei=async r=>{ve({...r}),We("traits"),_r(!1);const c=await Se.loadFullCharacter(r.id);c&&(ve(d=>d&&d.id===r.id?{...d,...c}:d),ye(d=>d.map(f=>f.id===r.id?{...f,...c}:f)))},ti=async r=>{try{const c=await Se.deleteCharacter(r);c.success?(ye(d=>d.filter(f=>f.id!==r)),or(d=>{const f={...d};return Object.keys(f).forEach(b=>{(b.includes(`${r}-`)||b.includes(`-${r}`))&&delete f[b]}),f}),qr(d=>{const f={...d};return Object.keys(f).forEach(b=>{(b.includes(`${r}-`)||b.includes(`-${r}`))&&delete f[b]}),f}),ft(d=>d.filter(f=>f!==r)),cr.current=!0,i.success(`Character ${r} deleted`)):(i.error("Failed to delete character:",c.error),k(a==="de"?"Charakter konnte nicht gel√∂scht werden":"Failed to delete character"))}catch(c){i.error("Failed to delete character:",c),k(a==="de"?"Charakter konnte nicht gel√∂scht werden":"Failed to delete character")}},ri=(r,c,d)=>{const b=Ki(d,a),o=`${r}-${c}`,h=`${c}-${r}`;i.debug("Updating relationship:",o,"=",d,", inverse:",h,"=",b),Et.current=!0,or(l=>({...l,[o]:d,[h]:b}))},ai=(r,c)=>{Et.current=!0;const[d,f]=r.split("-").map(Number),b=`${f}-${d}`;qr(o=>({...o,[r]:c,[b]:c}))},ni=(r,c)=>{Et.current=!0,Ba(d=>[...d,{forward:r,inverse:c}])},si=(r,c)=>{c==="out"?(Zt(d=>d.includes(r)?d:[...d,r]),ft(d=>d.filter(f=>f!==r))):c==="in"?(Zt(d=>d.filter(f=>f!==r)),ft(d=>d.filter(f=>f!==r))):c==="main"&&(Zt(d=>d.filter(f=>f!==r)),ft(d=>d.includes(r)?d:[...d,r])),cr.current=!0,ye(d=>d.map(f=>f.id===r?{...f,storyRole:c}:f))},ii=async()=>{const[r,c,d]=await Promise.all([new Promise(b=>{ye(o=>(b(o),o))}),new Promise(b=>{ft(o=>(b(o),o))}),new Promise(b=>{Zt(o=>(b(o),o))})]);if(r.length===0)return;if(!cr.current){i.debug("Roles not modified, skipping save");return}const f={};for(const b of r)c.includes(b.id)?f[b.id]="main":d.includes(b.id)?f[b.id]="out":f[b.id]="in";try{await Se.saveCharacterRoles(f),cr.current=!1}catch(b){i.error("Failed to save character roles:",b)}},rr=s.useRef(null),ct=async r=>{r>=0&&r<=7&&(D===1&&g&&r!==1&&await pa(),D===1&&r!==1&&(rr.current=(async()=>{await li(),await ii()})(),rr.current.catch(c=>i.error("Background save failed:",c))),r===1&&D!==1&&ve(null),X(r),window.scrollTo(0,0))},oi=r=>r===1?!0:r===2||r===3?ee.length>0:r===4?ee.length>0&&ue!=="":r===5?ee.length>0&&ue!==""&&et!=="":r===6?_t!=="":!1,Nt=()=>D===1?ee.length>0&&mt.length>0:D===2?!0:D===3?!(!ue||ue==="adventure"&&!Pe||(ue==="life-challenge"||ue==="educational")&&!Te||ue==="historical"&&!Te||ue==="custom"&&!(Xe!=null&&Xe.trim())):D===4?et!=="":D===5?ee.filter(c=>!Le.includes(c.id)).length>0&&mt.length>0&&St.trim().length>0:!1,li=async()=>{const r=await new Promise(c=>{ye(d=>(c(d),d))});if(r.length!==0){if(!Et.current){i.debug("Relationships not modified, skipping save");return}try{i.debug("Auto-saving character data with latest state..."),await Se.saveCharacterData({characters:r,relationships:Oe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]}),Et.current=!1,i.debug("Character data auto-saved")}catch(c){i.error("Failed to auto-save character data:",c)}}},ci=async()=>{if(D<5&&Nt()){if(D===1&&ee.length===1){ea(!0);return}await ct(D+1)}},dn=async()=>{D>0&&await ct(D-1)},di=(r,c)=>{Rt(r),_a(c??null)},un=async()=>{Ct.current&&Ct.current.abort(),Yt(!0),Gt(!0),Bt(!0),Ft([]),Yr(null),Qr(""),_a(null);const r=ee.filter(c=>!Le.includes(c.id));cs({storyType:ht,storyCategory:ue||"",storyTopic:Te||"",storyTheme:Pe||"",characters:r.map(c=>({id:c.id,name:c.name})),language:rt,languageLevel:tt,pages:Ve,userLocation:kt||void 0,season:jt||void 0}),Ct.current=he.generateStoryIdeasStream({storyType:ht,storyTypeName:ar(),storyCategory:ue||void 0,storyTopic:Te||void 0,storyTheme:Pe||void 0,customThemeText:Pe==="custom"?Xe:void 0,language:rt,languageLevel:tt,pages:Ve,characters:r.map(c=>({name:c.name,age:c.age,gender:c.gender,traits:c.traits,isMain:mt.includes(c.id)})),relationships:Object.entries(Oe).map(([c,d])=>{const[f,b]=c.split("-").map(Number),o=r.find(l=>l.id===f),h=r.find(l=>l.id===b);return{character1:(o==null?void 0:o.name)||"",character2:(h==null?void 0:h.name)||"",relationship:d}}).filter(c=>c.character1&&c.character2),ideaModel:(v==null?void 0:v.role)==="admin"||K?_e.ideaModel:void 0,userLocation:kt||void 0,season:jt},{onStatus:(c,d,f)=>{d&&f&&Yr({prompt:d,model:f})},onStory1:c=>{Ft(d=>{const f=[...d];return f[0]=c,f}),Jr(100),Gt(!1)},onStory2:c=>{Ft(d=>{const f=[...d];return f[1]=c,f}),Zr(100),Bt(!1)},onError:c=>{i.error("Failed to generate story ideas:",c),k(a==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":a==="fr"?"Erreur lors de la g√©n√©ration d'id√©es. Veuillez r√©essayer.":"Failed to generate ideas. Please try again."),Yt(!1),Gt(!1),Bt(!1)},onDone:c=>{Yt(!1),Gt(!1),Bt(!1),c&&Qr(c),Ct.current=null,i.info("[IDEAS] onDone complete")}})},ar=()=>{const r=ba.find(c=>c.id===ht);return r?r.name[a]:ht},Tt=async r=>{var d,f,b,o,h,l,w,m,E,p,y,B,ie,te,N,oe;if(console.log("[generateStory] Called with overrides:",r),console.log("[generateStory] user:",v==null?void 0:v.email,"emailVerified:",v==null?void 0:v.emailVerified,"isImpersonating:",K),rr.current&&(await rr.current,rr.current=null),!(r!=null&&r.skipEmailCheck)&&!K&&v&&v.emailVerified!==!0){await U();const R=localStorage.getItem("currentUser");let A=v.emailVerified;if(R)try{A=JSON.parse(R).emailVerified}catch{}if(A===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",ht),localStorage.setItem("pending_art_style",et),pr(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),Mt(!0),fr(!1),X(6),la({storyCategory:ue||void 0,storyTopic:Te||void 0,storyTheme:Pe||void 0,storyTypeName:ar(),storyDetails:St||void 0,artStyle:et||void 0,language:rt||void 0,languageLevel:tt||void 0,pages:Ve||void 0,dedication:bt||void 0,characters:ee.filter(R=>!Le.includes(R.id)).map(R=>({id:R.id,name:R.name})),mainCharacters:mt,relationships:Oe,relationshipTexts:it,season:jt||void 0,userLocation:kt||void 0}),Qt(""),yt(""),Fe([]),Ht([]),Sr(null),da.current=!1,wr({}),qe({frontCover:null,initialPage:null,backCover:null});const c=ee.filter(R=>!Le.includes(R.id)).filter(R=>!R.avatars||R.avatars.stale||R.avatars.status!=="complete");if(c.length>0){console.log("[generateStory] Characters needing avatar regeneration:",c.map(R=>R.name)),At({current:1,total:100,message:a==="de"?`Aktualisiere Avatare f√ºr ${c.length} Charakter(e)...`:a==="fr"?`Mise √† jour des avatars pour ${c.length} personnage(s)...`:`Updating avatars for ${c.length} character(s)...`});for(let R=0;R<c.length;R++){const A=c[R];try{console.log(`[generateStory] Regenerating avatars for ${A.name} (${R+1}/${c.length})`),At({current:2,total:100,message:a==="de"?`Generiere Avatare f√ºr ${A.name}...`:a==="fr"?`G√©n√©ration des avatars pour ${A.name}...`:`Generating avatars for ${A.name}...`});const C=await Se.generateClothingAvatarsWithTraits(A);if(C.success&&C.avatars){const P={...C.avatars,stale:!1,generatedAt:new Date().toISOString()},j=A.physicalTraitsSource||{},M=C.extractedTraits?{...A.physical,height:(d=A.physical)==null?void 0:d.height,build:j.build==="user"?(f=A.physical)==null?void 0:f.build:C.extractedTraits.build,eyeColor:j.eyeColor==="user"?(b=A.physical)==null?void 0:b.eyeColor:C.extractedTraits.eyeColor,eyeColorHex:j.eyeColor==="user"?(o=A.physical)==null?void 0:o.eyeColorHex:C.extractedTraits.eyeColorHex,hairColor:j.hairColor==="user"?(h=A.physical)==null?void 0:h.hairColor:C.extractedTraits.hairColor,hairColorHex:j.hairColor==="user"?(l=A.physical)==null?void 0:l.hairColorHex:C.extractedTraits.hairColorHex,hairLength:j.hairLength==="user"?(w=A.physical)==null?void 0:w.hairLength:C.extractedTraits.hairLength,hairStyle:j.hairStyle==="user"?(m=A.physical)==null?void 0:m.hairStyle:C.extractedTraits.hairStyle,facialHair:j.facialHair==="user"?(E=A.physical)==null?void 0:E.facialHair:C.extractedTraits.facialHair,skinTone:j.skinTone==="user"?(p=A.physical)==null?void 0:p.skinTone:C.extractedTraits.skinTone,skinToneHex:j.skinTone==="user"?(y=A.physical)==null?void 0:y.skinToneHex:C.extractedTraits.skinToneHex,face:j.face==="user"?(B=A.physical)==null?void 0:B.face:C.extractedTraits.face,other:j.other==="user"?(ie=A.physical)==null?void 0:ie.other:C.extractedTraits.other,detailedHairAnalysis:C.extractedTraits.detailedHairAnalysis||((te=A.physical)==null?void 0:te.detailedHairAnalysis),apparentAge:j.apparentAge==="user"?(N=A.physical)==null?void 0:N.apparentAge:C.extractedTraits.apparentAge||((oe=A.physical)==null?void 0:oe.apparentAge)}:A.physical,xe=C.extractedTraits?{...j,build:j.build==="user"?"user":C.extractedTraits.build?"extracted":void 0,eyeColor:j.eyeColor==="user"?"user":C.extractedTraits.eyeColor?"extracted":void 0,hairColor:j.hairColor==="user"?"user":C.extractedTraits.hairColor?"extracted":void 0,hairLength:j.hairLength==="user"?"user":C.extractedTraits.hairLength?"extracted":void 0,hairStyle:j.hairStyle==="user"?"user":C.extractedTraits.hairStyle?"extracted":void 0,face:j.face==="user"?"user":C.extractedTraits.face?"extracted":void 0,facialHair:j.facialHair==="user"?"user":C.extractedTraits.facialHair?"extracted":void 0,other:j.other==="user"?"user":C.extractedTraits.other?"extracted":void 0,skinTone:j.skinTone==="user"?"user":C.extractedTraits.skinTone?"extracted":void 0,apparentAge:j.apparentAge==="user"?"user":C.extractedTraits.apparentAge?"extracted":void 0}:A.physicalTraitsSource,$=C.extractedClothing?{...A.clothing,structured:{upperBody:C.extractedClothing.upperBody||void 0,lowerBody:C.extractedClothing.lowerBody||void 0,shoes:C.extractedClothing.shoes||void 0,fullBody:C.extractedClothing.fullBody||void 0}}:A.clothing;ye(ge=>ge.map(W=>W.id===A.id?{...W,avatars:P,physical:M,physicalTraitsSource:xe,clothing:$}:W)),ve(ge=>ge&&ge.id===A.id?{...ge,avatars:P,physical:M,physicalTraitsSource:xe,clothing:$}:ge),ye(ge=>{const W=ge.map(je=>je.id===A.id?{...je,avatars:P,physical:M,physicalTraitsSource:xe,clothing:$}:je);return Se.saveCharacterData({characters:W,relationships:Oe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(je=>console.error("Failed to save avatar update:",je)),W}),console.log(`[generateStory] ‚úÖ Avatars regenerated for ${A.name}`)}else console.warn(`[generateStory] ‚ö†Ô∏è Failed to regenerate avatars for ${A.name}: ${C.error}`)}catch(C){console.error(`[generateStory] ‚ùå Error regenerating avatars for ${A.name}:`,C)}}}At({current:5,total:100,message:a==="de"?"Starte Generierung...":a==="fr"?"D√©marrage de la g√©n√©ration...":"Starting generation..."});try{const R=ee.filter($=>!Le.includes($.id)),{jobId:A,creditsRemaining:C}=await he.createStoryJob({storyType:ht,storyTypeName:ar(),storyCategory:ue||void 0,storyTopic:Te||void 0,storyTheme:Pe||void 0,customThemeText:Pe==="custom"?Xe:void 0,artStyle:et,language:rt,languageLevel:tt,pages:Ve,dedication:bt,storyDetails:St,characters:R,mainCharacters:mt,relationships:Oe,relationshipTexts:it,skipImages:(r==null?void 0:r.skipImages)??q,imageGenMode:pe,generationMode:Ce!=="auto"?Ce:void 0,skipOutline:Ge,skipText:ze,skipSceneDescriptions:Re,skipCovers:ke,enableAutoRepair:Ie,useGridRepair:Qe,forceRepairThreshold:Rr,enableFinalChecks:Ca,checkOnlyMode:ja,enableSceneValidation:Aa,separatedEvaluation:Na,incrementalConsistency:qt?{enabled:!0,dryRun:ka,lookbackCount:It}:void 0,modelOverrides:(v==null?void 0:v.role)==="admin"||K?{outlineModel:_e.outlineModel,textModel:_e.textModel,sceneDescriptionModel:_e.sceneDescriptionModel,imageModel:_e.imageModel,coverImageModel:_e.coverImageModel,qualityModel:_e.qualityModel}:void 0,userLocation:kt||void 0,season:jt||void 0,ideaGeneration:La&&mr&&pt.length>0?{input:La,output:pt,rawResponse:za,prompt:mr.prompt,model:mr.model,selectedIndex:ls}:void 0});br(A),i.info("Story job created:",A),re(A,ar()||"New Story"),C!=null&&T(C);let P=!1,j=0,M=Date.now();const xe=180*1e3;for(zt(!1);!P;){await new Promise(ge=>setTimeout(ge,2e3));const $=await he.getJobStatus(A);if($.progress&&($.progress.current!==j?(i.debug(`Progress: ${$.progress.current}% - ${$.progress.message||""}`),j=$.progress.current,M=Date.now(),zt(!1)):Date.now()-M>=xe&&zt(!0),At(ge=>$.progress.current>=ge.current?$.progress:$.progress.message?{...ge,message:$.progress.message}:ge)),$.partialCovers){let ge=!1;qe(W=>{var Ee,Me,Nr;const je={...W};if((Ee=$.partialCovers)!=null&&Ee.frontCover&&!W.frontCover){je.frontCover=$.partialCovers.frontCover,i.debug("Front cover received during streaming");const Ze=$.partialCovers.frontCover;typeof Ze=="object"&&(Ze!=null&&Ze.storyTitle)&&(yt(Ze.storyTitle),i.debug(`Story title from front cover: ${Ze.storyTitle}`)),ge=!0}return(Me=$.partialCovers)!=null&&Me.initialPage&&!W.initialPage&&(je.initialPage=$.partialCovers.initialPage,i.debug("Initial page cover received during streaming")),(Nr=$.partialCovers)!=null&&Nr.backCover&&!W.backCover&&(je.backCover=$.partialCovers.backCover,i.debug("Back cover received during streaming")),je}),ge&&(i.debug("Transitioning to StoryDisplay - front cover ready"),X(6))}if($.storyText&&!da.current&&(da.current=!0,Sr($.storyText),yt($.storyText.title),i.info(`Story text loaded: ${$.storyText.totalPages} pages`)),$.partialPages&&$.partialPages.length>0&&wr(ge=>{var Ee;const W={...ge};let je=0;return(Ee=$.partialPages)==null||Ee.forEach(Me=>{Me.imageData&&!ge[Me.pageNumber]&&(W[Me.pageNumber]=Me.imageData,je++)}),je>0&&i.debug(`${je} new page images received (total: ${Object.keys(W).length})`),W}),$.status==="completed"&&$.result)ia($.result.storyId),yt($.result.title),Ua($.result.outline),Ka($.result.outlinePrompt||""),Ja($.result.outlineModelId),Za($.result.outlineUsage),Ya($.result.storyTextPrompts||[]),ra($.result.styledAvatarGeneration||[]),aa($.result.costumedAvatarGeneration||[]),na($.result.generationLog||[]),sa($.result.finalChecksReport||null),$.result.visualBible?Lt({mainCharacters:$.result.visualBible.mainCharacters||[],secondaryCharacters:$.result.visualBible.secondaryCharacters||[],animals:$.result.visualBible.animals||[],artifacts:$.result.visualBible.artifacts||[],locations:$.result.visualBible.locations||[],vehicles:$.result.visualBible.vehicles||[],clothing:$.result.visualBible.clothing||[],changeLog:$.result.visualBible.changeLog||[]}):Lt(null),$.result.clothingRequirements?vr($.result.clothingRequirements):vr(null),Qt($.result.story),qa($.result.story),Ht($.result.sceneDescriptions||[]),Fe($.result.sceneImages||[]),qe($.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),Sr(null),wr({}),P=!0,$.currentCredits!==null&&$.currentCredits!==void 0&&T($.currentCredits),X(6),i.success("Story generation completed!"),la({storyCategory:ue||void 0,storyTopic:Te||void 0,storyTheme:Pe||void 0,storyTypeName:ar(),storyDetails:St||void 0,artStyle:et||void 0,language:rt||void 0,languageLevel:tt||void 0,pages:Ve||void 0,dedication:bt||void 0,characters:ee.map(ge=>({id:ge.id,name:ge.name})),mainCharacters:mt,relationships:Oe,relationshipTexts:it,season:jt||void 0,userLocation:kt||void 0}),ca.current=!0,Ta&&an($.result.storyId),ae();else if($.status==="failed")throw new Error($.error||"Story generation failed")}At({current:100,total:100,message:a==="de"?"Fertig!":a==="fr"?"Termin√©!":"Complete!"})}catch(R){i.error("Generation failed:",R);const A=R instanceof Error?R.message:String(R);if(A.includes("already in progress")){const C=A.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),P=C?C[1]:null,j=a==="de"?"Eine Geschichte wird bereits erstellt. M√∂chtest du diese abbrechen und eine neue starten?":a==="fr"?"Une histoire est d√©j√† en cours de cr√©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(P&&window.confirm(j))try{await he.cancelJob(P),i.info("Cancelled existing job:",P),await Tt(r);return}catch(M){i.error("Failed to cancel existing job:",M),k(a==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es sp√§ter erneut.":a==="fr"?"√âchec de l'annulation. Veuillez r√©essayer plus tard.":"Failed to cancel. Please try again later.")}Mt(!1);return}else k(a==="de"?`Generierung fehlgeschlagen: ${A}`:a==="fr"?`√âchec de la g√©n√©ration: ${A}`:`Generation failed: ${A}`)}finally{zt(!1),ae(),setTimeout(()=>Mt(!1),500)}};s.useEffect(()=>{if(Ar.current&&G&&ee.length>0&&D===5&&!ot){Ar.current=!1;const r=localStorage.getItem("verificationGenerationStarted");if(r){const d=parseInt(r,10),f=Date.now()-120*1e3;if(d>f){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await U(),setTimeout(()=>{Tt({skipEmailCheck:!0})},500)})()}},[G,ee,D,ot,U]);const ui=()=>{switch(D){case 1:return t.jsx(so,{characters:ee,currentCharacter:g,characterStep:Yn,showCharacterCreated:Zn,isLoading:Q,isAnalyzingPhoto:Qn,isGeneratingAvatar:Ia===(g==null?void 0:g.id),isRegeneratingAvatars:Xn,isRegeneratingAvatarsWithTraits:es,developerMode:se,isImpersonating:K,changedTraits:ts,photoAnalysisDebug:rs,mainCharacters:mt,excludedCharacters:Le,onCharacterRoleChange:si,onCharacterChange:ve,onCharacterStepChange:We,onContinueToAvatar:()=>We("avatar"),onPhotoSelect:Us,onSaveAndGenerateAvatar:Xs,onSaveCharacter:pa,onEditCharacter:ei,onDeleteCharacter:ti,onStartNewCharacter:fa,onRegenerateAvatars:Zs,onRegenerateAvatarsWithTraits:Ys,onSaveAndRegenerateWithTraits:Qs,onSaveAndTryNewPhoto:async()=>{var f;if(i.info(`üì∏ onSaveAndTryNewPhoto called, currentCharacter: ${g==null?void 0:g.name}`),!g){i.warn("üì∏ No currentCharacter, returning early");return}L(!0);try{const b=g.id&&ee.find(l=>l.id===g.id),o=b?ee.map(l=>l.id===g.id?g:l):[...ee,g],h=!b&&!!((f=g.photos)!=null&&f.original);await Se.saveCharacterData({characters:o,relationships:Oe,relationshipTexts:it,customRelationships:$t,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:h}),ye(o),ha(o),i.info(`üì∏ Setting characterStep to 'photo', currentCharacter still: ${g==null?void 0:g.name}`),We("photo")}catch(b){i.error("üì∏ Error saving character:",b)}finally{L(!1),i.info("üì∏ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:Oe,relationshipTexts:it,onRelationshipChange:ri,onRelationshipTextChange:ai,customRelationships:$t,onAddCustomRelationship:ni});case 2:return t.jsx(io,{languageLevel:tt,onLanguageLevelChange:dr,pages:Ve,onPagesChange:Kr,storyLanguage:rt,onStoryLanguageChange:Ma,developerMode:se,userLocation:kt,onLocationChange:Ha,season:jt,onSeasonChange:ds,userCredits:K?-1:(v==null?void 0:v.credits)??0});case 3:return t.jsx(oo,{storyCategory:ue,storyTopic:Te,storyTheme:Pe,customThemeText:Xe,onCategoryChange:_s,onTopicChange:Hs,onThemeChange:Ls,onCustomThemeTextChange:Mr,onLegacyStoryTypeChange:Ut});case 4:return t.jsx(lo,{artStyle:et,onArtStyleChange:Ws});case 5:return t.jsx(co,{characters:ee,mainCharacters:mt,excludedCharacters:Le,storyCategory:ue,storyTopic:Te,storyTheme:Pe,customThemeText:Xe,onCustomThemeTextChange:Mr,artStyle:et,storyLanguage:rt,languageLevel:tt,pages:Ve,userLocation:kt,season:jt,storyDetails:St,onStoryDetailsChange:Rt,dedication:bt,onDedicationChange:ur,onGenerateIdeas:un,isGeneratingIdeas:wt,isGeneratingIdea1:gr,isGeneratingIdea2:hr,ideaProgress1:is,ideaProgress2:os,ideaPrompt:mr,ideaFullResponse:za,generatedIdeas:pt,onSelectIdea:di,onUseDirectly:()=>Tt(),onEditStep:ct,developerMode:se,imageGenMode:pe,onImageGenModeChange:ce,generationMode:Ce,onGenerationModeChange:De});case 6:const r=vt.frontCover||vt.initialPage||Object.keys(ua).length>0||xr.some(f=>f.imageData),c=xr.some(f=>f.hasImage)||vt.frontCover&&typeof vt.frontCover=="object"&&vt.frontCover.hasImage;if(_t&&r||Ue&&r||ot&&r||yr&&c){const f=_t?xr:Object.entries(ua).map(([o,h])=>{var l;return{pageNumber:parseInt(o),imageData:h,description:((l=Ue==null?void 0:Ue.sceneDescriptions.find(w=>w.pageNumber===parseInt(o)))==null?void 0:l.description)||""}}),b=_t||Object.entries((Ue==null?void 0:Ue.pageTexts)||{}).sort(([o],[h])=>parseInt(o)-parseInt(h)).map(([o,h])=>`--- Page ${o} ---
${h}`).join(`

`);return t.jsxs(t.Fragment,{children:[at&&at.total>0&&t.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[t.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${at.loaded/at.total*100}%`}})}),t.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:a==="de"?`Bilder: ${at.loaded}/${at.total}`:a==="fr"?`Images: ${at.loaded}/${at.total}`:`Images: ${at.loaded}/${at.total}`})]}),se&&O&&!ot&&t.jsx(s.Suspense,{fallback:t.jsx("div",{className:"p-4 text-gray-500",children:"Loading repair panel..."}),children:t.jsx(no,{storyId:O,sceneImages:f,characters:ee.filter(o=>!Le.includes(o.id)),finalChecksReport:Qa,imageModel:_e.imageModel||void 0,onImageUpdate:(o,h,l)=>{Fe(w=>w.map(m=>m.pageNumber===o?{...m,imageData:h,imageVersions:[...m.imageVersions||[],{imageData:h,createdAt:new Date().toISOString(),isActive:!0,type:"repair"}].map((E,p,y)=>({...E,isActive:p===y.length-1}))}:m))},onRefreshStory:O?async()=>{try{i.info("Refreshing story data after repair...");const o=await he.getStory(O);o&&(Fe(o.sceneImages||[]),sa(o.finalChecksReport||null),i.success("Story data refreshed"))}catch(o){i.error("Failed to refresh story:",o)}}:void 0,autoRunFullWorkflow:Ms===O,onAutoRunComplete:()=>an(null),developerMode:se,useMagicApiRepair:qn,setUseMagicApiRepair:Un})}),t.jsx(s.Suspense,{fallback:t.jsx("div",{className:"py-12 flex justify-center",children:t.jsx(ut,{className:"w-8 h-8 text-indigo-600 animate-spin"})}),children:t.jsx(ao,{title:yr,dedication:bt||void 0,story:b,originalStory:xs,outline:bs,outlinePrompt:Ss,outlineModelId:ws,outlineUsage:Cs,storyTextPrompts:ks,visualBible:js||void 0,sceneImages:f,sceneDescriptions:(Ue==null?void 0:Ue.sceneDescriptions)||Ds,characters:Jn||ee.filter(o=>!Le.includes(o.id)),progressiveMode:ot,progressiveData:Ue||void 0,completedPageImages:ua,coverImages:vt,regeneratingCovers:us,languageLevel:tt,storyLanguage:rt,isGenerating:ot,developerMode:se,styledAvatarGeneration:Ns,costumedAvatarGeneration:Ts,generationLog:Ps,finalChecksReport:Qa,clothingRequirements:As||void 0,storyId:O,onVisualBibleChange:O?async o=>{try{i.info("Updating Visual Bible for story:",O),await he.updateVisualBible(O,o),Lt(o),i.success("Visual Bible updated successfully")}catch(h){i.error("Failed to update Visual Bible:",h),k(a==="de"?"Visual Bible konnte nicht aktualisiert werden":a==="fr"?"√âchec de la mise √† jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:O?async(o,h,l)=>{var w;try{i.info("Regenerating image for page:",o,h?"(scene edited)":"",l?`(${l.length} characters)`:"");const m=await he.regenerateImage(O,o,h,l);if(i.info("Regenerate result:",{hasImageData:!!(m!=null&&m.imageData),length:(w=m==null?void 0:m.imageData)==null?void 0:w.length,versionCount:m==null?void 0:m.versionCount,creditsRemaining:m==null?void 0:m.creditsRemaining}),!(m!=null&&m.imageData))throw i.error("No imageData in response!",m),new Error("No image data returned from server");Fe(E=>E.map(p=>p.pageNumber===o?{...p,imageData:m.imageData,description:m.newDescription||p.description,prompt:m.newPrompt,qualityScore:m.qualityScore,qualityReasoning:m.qualityReasoning,totalAttempts:m.totalAttempts,retryHistory:m.retryHistory,wasRegenerated:!0,originalImage:m.originalImage,originalScore:m.originalScore,originalReasoning:m.originalReasoning,imageVersions:m.imageVersions,referencePhotos:m.referencePhotos||p.referencePhotos,landmarkPhotos:m.landmarkPhotos||p.landmarkPhotos,visualBibleGrid:m.visualBibleGrid||p.visualBibleGrid}:p)),m.creditsRemaining!==void 0&&T&&T(m.creditsRemaining),i.info("Image regenerated successfully, updated state")}catch(m){i.error("Image regeneration failed:",m);const E=m instanceof Error?m.message:String(m);k(a==="de"?`Bildgenerierung fehlgeschlagen: ${E}`:a==="fr"?`√âchec de la r√©g√©n√©ration: ${E}`:`Image regeneration failed: ${E}`)}}:void 0,onDownloadTxt:()=>{const o=new Blob([_t],{type:"text/plain"}),h=URL.createObjectURL(o),l=document.createElement("a");l.href=h,l.download=`${yr}.txt`,l.click(),URL.revokeObjectURL(h)},onDownloadPdf:O?async o=>{try{const h=await he.generatePdf(O,o),l=URL.createObjectURL(h),w=document.createElement("a");w.href=l,w.download=`${yr}.pdf`,w.click(),URL.revokeObjectURL(l)}catch(h){i.error("PDF download failed:",h),k(a==="de"?"PDF-Download fehlgeschlagen":a==="fr"?"√âchec du t√©l√©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:O?()=>{try{const o=sessionStorage.getItem("mystories_selected"),h=o?JSON.parse(o):[];h.includes(O)||(h.push(O),sessionStorage.setItem("mystories_selected",JSON.stringify(h))),i.info("Added story to book selection:",O),Z(a==="de"?"Geschichte zum Buch hinzugef√ºgt. Du kannst weitere hinzuf√ºgen oder das Buch bestellen.":a==="fr"?"Histoire ajout√©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",a==="de"?"Zum Buch hinzugef√ºgt":a==="fr"?"Ajout√© au livre":"Added to Book"),e("/stories")}catch(o){i.error("Failed to add story to selection:",o)}}:void 0,onPrintBook:O?async()=>{let o=await Ei.getShippingAddress();if(!o){const w=prompt(a==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":a==="fr"?"Aucune adresse enregistr√©e. Veuillez entrer (Format: Pr√©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!w)return;const m=w.split(",").map(E=>E.trim());if(m.length<7){k(a==="de"?"Ung√ºltiges Adressformat":a==="fr"?"Format d'adresse invalide":"Invalid address format");return}o={firstName:m[0],lastName:m[1],addressLine1:m[2],postCode:m[3],city:m[4],country:m[5],email:m[6]}}const h=`${o.firstName} ${o.lastName}
${o.addressLine1}
${o.postCode} ${o.city}
${o.country}`,l=a==="de"?`Druckauftrag an folgende Adresse senden?

${h}`:a==="fr"?`Envoyer la commande √† cette adresse?

${h}`:`Send print order to this address?

${h}`;if(confirm(l))try{i.info("Creating print order for story:",O);const w=await he.createPrintOrder(O,{firstName:o.firstName,lastName:o.lastName,addressLine1:o.addressLine1,city:o.city,postCode:o.postCode,country:o.country,email:o.email||""}),m=a==="de"?`‚úÖ Druckauftrag erfolgreich erstellt!

Order ID: ${w.orderId}
${w.isDraft?"(Entwurf - muss in Gelato best√§tigt werden)":""}

M√∂chten Sie das Gelato Dashboard √∂ffnen, um den Auftrag zu verfolgen?`:a==="fr"?`‚úÖ Commande d'impression cr√©√©e avec succ√®s!

ID de commande: ${w.orderId}
${w.isDraft?"(Brouillon - doit √™tre confirm√© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`‚úÖ Print order created successfully!

Order ID: ${w.orderId}
${w.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;w.dashboardUrl&&confirm(m)?window.open(w.dashboardUrl,"_blank"):w.dashboardUrl||Z(a==="de"?`Druckauftrag erstellt! Order ID: ${w.orderId}`:a==="fr"?`Commande cr√©√©e! ID: ${w.orderId}`:`Print order created! Order ID: ${w.orderId}`)}catch(w){i.error("Print order failed:",w);const m=w instanceof Error?w.message:String(w);k(a==="de"?`Druckauftrag fehlgeschlagen: ${m}`:a==="fr"?`√âchec de la commande d'impression: ${m}`:`Print order failed: ${m}`)}}:void 0,onCreateAnother:()=>{i.info("Creating new story - resetting settings"),ia(null),br(null),zr(null);const o=new URLSearchParams(n);o.delete("storyId"),u(o,{replace:!0}),Qt(""),yt(""),Ht([]),Fe([]),qe({frontCover:null,initialPage:null,backCover:null}),Xa(!1),en(void 0),tn(void 0),rn(void 0),Ut(""),Gr(""),Br(""),Fr(""),Kt("watercolor"),dr("standard"),Kr(30),ur(""),Rt(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),ve(null),We("photo"),X(1)},onRegenerateCover:O?async(o,h,l,w,m)=>{const E=o==="front"?"frontCover":o==="back"?"backCover":"initialPage";try{i.info("Regenerating cover:",o,h?`with scene: "${h.substring(0,50)}..."`:"",l?`with ${l.length} characters`:""),Wa(y=>new Set(y).add(E));const p=await he.regenerateCover(O,o,h,l,w,m);qe(y=>y&&{...y,[o==="front"?"frontCover":o==="back"?"backCover":"initialPage"]:{imageData:p.imageData,description:p.description,prompt:p.prompt,qualityScore:p.qualityScore,qualityReasoning:p.qualityReasoning,totalAttempts:p.totalAttempts,retryHistory:p.retryHistory,referencePhotos:p.referencePhotos,wasRegenerated:p.wasRegenerated,regenerationCount:p.regenerationCount,previousImage:p.previousImage,previousScore:p.previousScore,originalImage:p.originalImage,originalScore:p.originalScore,modelId:p.modelId,imageVersions:p.imageVersions}}),p.creditsRemaining!==void 0&&T&&T(p.creditsRemaining),i.info("Cover regenerated successfully")}catch(p){i.error("Cover regeneration failed:",p);const y=p instanceof Error?p.message:String(p);k(a==="de"?`Cover-Generierung fehlgeschlagen: ${y}`:a==="fr"?`√âchec de la r√©g√©n√©ration: ${y}`:`Cover regeneration failed: ${y}`)}finally{Wa(p=>{const y=new Set(p);return y.delete(E),y})}}:void 0,onEditImage:o=>{kr({type:"image",pageNumber:o}),er(""),Cr(!0)},onEditCover:o=>{kr({type:"cover",coverType:o}),er(""),Cr(!0)},onRepairImage:O&&((v==null?void 0:v.role)==="admin"||K)?async o=>{var h,l,w;try{i.info("Starting auto-repair for page:",o);const m=xr.find(y=>y.pageNumber===o);let E=m==null?void 0:m.fixTargets;if(!E||E.length===0){const y=(l=(h=m==null?void 0:m.retryHistory)==null?void 0:h.filter(B=>B.type==="auto_repair"))==null?void 0:l.slice(-1)[0];(w=y==null?void 0:y.preRepairEval)!=null&&w.fixTargets&&y.preRepairEval.fixTargets.length>0&&(E=y.preRepairEval.fixTargets,i.info(`Using ${E.length} fix targets from retryHistory.preRepairEval`))}E&&E.length>0?i.info(`Using ${E.length} existing fix targets`):i.info("No stored fix targets found, will re-evaluate");const p=await he.repairImage(O,o,E);p.repaired?(Fe(y=>y.map(B=>B.pageNumber===o?{...B,imageData:p.imageData,wasAutoRepaired:!0,repairHistory:p.repairHistory,repairedAt:new Date().toISOString()}:B)),i.info("Auto-repair completed successfully:",{repaired:p.repaired,repairs:p.repairHistory.length})):p.noErrorsFound&&i.info("No physics errors detected in the image")}catch(m){throw i.error("Auto-repair failed:",m),m}}:void 0,onIteratePage:O&&((v==null?void 0:v.role)==="admin"||K)?async o=>{var h;try{i.info("Starting iteration for page:",o,"imageModel:",_e.imageModel);const l=await he.iteratePage(O,o,_e.imageModel||void 0);l.success&&(Fe(w=>w.map(m=>{var E;if(m.pageNumber===o){const p=m.imageVersions||[],y=(E=l.imageVersions)==null?void 0:E.map((B,ie)=>{var te;return{imageData:B.imageData||((te=p[ie])==null?void 0:te.imageData)||"",description:B.description,prompt:B.prompt,modelId:B.modelId,createdAt:B.createdAt||new Date().toISOString(),isActive:B.isActive??!1,type:B.type,qualityScore:B.qualityScore}});return{...m,imageData:l.imageData,description:l.sceneDescription,prompt:l.imagePrompt,qualityScore:l.qualityScore,qualityReasoning:l.qualityReasoning,wasIterated:!0,iteratedAt:new Date().toISOString(),iterationFeedback:l.composition,previewMismatches:l.previewMismatches,imageVersions:y||m.imageVersions}}return m})),Ht(w=>w.map(m=>m.pageNumber===o?{...m,description:l.sceneDescription,iteratedAt:new Date().toISOString()}:m)),i.info("Iteration completed successfully:",{mismatches:((h=l.previewMismatches)==null?void 0:h.length)||0,score:l.qualityScore,message:l.message}))}catch(l){throw i.error("Iteration failed:",l),l}}:void 0,onRevertRepair:O&&((v==null?void 0:v.role)==="admin"||K)?async(o,h)=>{try{i.info("Reverting repair for page:",o),Fe(l=>l.map(w=>w.pageNumber===o?{...w,imageData:h,wasAutoRepaired:!1}:w)),await he.updateSceneImage(O,o,h),i.info("Repair reverted successfully")}catch(l){throw i.error("Failed to revert repair:",l),l}}:void 0,onSaveStoryText:O?async o=>{try{i.info("Saving story text for story:",O),await he.saveStoryText(O,o),Qt(o),i.info("Story text saved successfully")}catch(h){throw i.error("Failed to save story text:",h),h}}:void 0,onSaveTitleChange:O?async o=>{try{i.info("Saving title for story:",O,o),await he.saveStoryTitle(O,o),yt(o),i.info("Title saved successfully")}catch(h){throw i.error("Failed to save title:",h),h}}:void 0,userCredits:K?-1:(v==null?void 0:v.credits)||0,imageRegenerationCost:5,isImpersonating:K,onSelectImageVersion:O?async(o,h)=>{try{i.info("Selecting image version:",{pageNumber:o,versionIndex:h});const l=await he.setActiveImage(O,o,h);Fe(w=>w.map(m=>{if(m.pageNumber===o&&m.imageVersions){if(h<0||h>=m.imageVersions.length)return i.error(`Invalid versionIndex ${h} for page ${o} (max: ${m.imageVersions.length-1})`),m;const E=m.imageVersions[h];return E!=null&&E.imageData?{...m,imageData:E.imageData,imageVersions:m.imageVersions.map((p,y)=>({...p,isActive:y===h}))}:(i.error(`Version ${h} has no imageData for page ${o}`),m)}return m})),i.info("Image version selected:",l)}catch(l){throw i.error("Failed to select image version:",l),l}}:void 0,onSelectCoverVersion:O?async(o,h)=>{try{i.info("Selecting cover version:",{coverType:o,versionIndex:h});const l=await he.setActiveCoverImage(O,o,h);qe(w=>{if(!w)return w;const m=w[o];if(!m||typeof m=="string")return w;const E=m;if(!E.imageVersions)return w;if(h<0||h>=E.imageVersions.length)return i.error(`Invalid versionIndex ${h} for ${o} (max: ${E.imageVersions.length-1})`),w;const p=E.imageVersions[h];return p!=null&&p.imageData?{...w,[o]:{...E,imageData:p.imageData,imageVersions:E.imageVersions.map((y,B)=>({...y,isActive:B===h}))}}:(i.error(`Version ${h} has no imageData for ${o}`),w)}),i.info("Cover version selected:",l)}catch(l){throw i.error("Failed to select cover version:",l),l}}:void 0,isPartial:Es,failureReason:Rs,generatedPages:Gs,totalPages:Bs,generationSettings:Fs||void 0,onRefreshStory:O?async()=>{if(i.info("Refreshing story data:",O),xt.current=!1,$s(o=>o+1),se)try{const o=await he.getStoryDevMetadata(O);jr(o),xt.current=!0,i.info("Dev metadata refreshed after repair")}catch(o){i.warn("Failed to refresh dev metadata:",o)}}:void 0})})]})}return n.get("storyId")?t.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[t.jsx(ut,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),t.jsx("p",{className:"text-gray-600 font-medium",children:a==="de"?"Geschichte wird geladen...":a==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):ot?t.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),t.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:a==="de"?"Geschichte wird erstellt...":a==="fr"?"Cr√©ation de l'histoire...":"Creating your story..."}),t.jsx("p",{className:"text-indigo-500 mt-2",children:a==="de"?"Einen Moment Geduld bitte":a==="fr"?"Veuillez patienter":"Please wait a moment"})]}):t.jsxs("div",{className:"text-center py-12",children:[t.jsx(Ot,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),t.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:S.generateStory}),t.jsx("p",{className:"text-gray-600 mb-6",children:a==="de"?"Bereit, deine Geschichte zu erstellen!":a==="fr"?"Pr√™t √† cr√©er votre histoire!":"Ready to create your story!"}),t.jsxs($r,{onClick:()=>Tt(),size:"lg",icon:Ot,children:[S.generateStory," (",Ve*10," Credits)"]})]});default:return null}};return G?t.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[t.jsx(vi,{currentStep:D,onStepClick:ct,canAccessStep:oi,developerMode:se,onDeveloperModeChange:me,hideSteps:D===6&&!!O,onShowGenerationProgress:()=>{fr(!1),X(6)}}),t.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:t.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[Q&&!ot&&D!==6?t.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[t.jsx(ut,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),t.jsx("p",{className:"text-gray-600 font-medium mb-2",children:x?a==="de"?"Geschichte wird geladen...":a==="fr"?"Chargement de l'histoire...":"Loading story...":a==="de"?"Wird geladen...":a==="fr"?"Chargement...":"Loading..."}),x&&t.jsxs("div",{className:"w-64 mt-2",children:[t.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:x.total?`${Math.min(100,x.loaded/x.total*100)}%`:"100%"}})}),t.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[(x.loaded/(1024*1024)).toFixed(1)," MB",x.total&&t.jsxs("span",{children:[" (",Math.round(x.loaded/x.total*100),"%)"]})]})]})]}):t.jsxs(t.Fragment,{children:[D>=1&&D<=5&&!g&&t.jsx(Fi,{step:D,text:(Tn[a]||Tn.en)[D]}),t.jsx(s.Suspense,{fallback:t.jsx(hn,{}),children:ui()})]}),D<6&&!g&&t.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[D===1&&ee.length>=2&&!Os()&&(()=>{const r=Vs();if(!r)return null;const c=a==="de"?`${r.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:a==="fr"?`${r.name} a des relations non d√©finies ("ne conna√Æt pas")`:`${r.name} has undefined relationships ("not known to")`;return t.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[t.jsx("span",{className:"text-amber-600 text-lg",children:"‚ö†Ô∏è"}),t.jsx("p",{className:"text-amber-700 text-sm",children:c})]})})(),D!==5&&t.jsxs("div",{className:`flex ${D===1?"justify-end":"justify-between"}`,children:[D>1&&t.jsxs("button",{onClick:dn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[t.jsx(yn,{size:20})," ",S.back]}),t.jsxs("button",{onClick:ci,disabled:!Nt(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${Nt()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[S.next," ",t.jsx(ji,{size:20})]})]}),D===5&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("button",{onClick:()=>Tt(),disabled:!Nt(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Nt()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[t.jsx(Ot,{size:20})," ",S.generateStory," (",Ve*10," Credits)"]}),se&&t.jsxs("button",{onClick:()=>Tt({skipImages:!0}),disabled:!Nt(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Nt()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[t.jsx(Ot,{size:20}),a==="de"?"Nur Text generieren (ohne Bilder)":a==="fr"?"G√©n√©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),se&&t.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[t.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["üõ†Ô∏è ",a==="de"?"Entwickler-Optionen - Schritte √ºberspringen":a==="fr"?"Options d√©veloppeur - Sauter des √©tapes":"Developer Options - Skip Steps"]}),t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Ge,onChange:r=>Ne(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Gliederung √ºberspringen":a==="fr"?"Sauter le plan":"Skip outline generation"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:ze,onChange:r=>fe(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Text √ºberspringen":a==="fr"?"Sauter le texte":"Skip text generation"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Re,onChange:r=>J(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Szenenbeschreibungen √ºberspringen":a==="fr"?"Sauter les descriptions de sc√®nes":"Skip scene descriptions"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:q,onChange:r=>I(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Bilder √ºberspringen":a==="fr"?"Sauter les images":"Skip image generation"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:ke,onChange:r=>Be(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Cover √ºberspringen":a==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),t.jsx("p",{className:"text-xs text-orange-600 mt-2",children:a==="de"?"Hinweis: √úbersprungene Schritte verwenden Platzhalter/leere Daten":a==="fr"?"Note: Les √©tapes saut√©es utiliseront des donn√©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),t.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["üîß ",a==="de"?"Feature-Optionen":a==="fr"?"Options de fonctionnalit√©s":"Feature Options"]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:Ie,onChange:r=>nt(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Auto-Reparatur aktivieren":a==="fr"?"Activer la r√©paration auto":"Enable auto-repair"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":a==="fr"?"Essaie de corriger automatiquement les erreurs d'image d√©tect√©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),Ie&&t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[t.jsx("input",{type:"checkbox",checked:Qe,onChange:r=>gt(r.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Grid-Reparatur verwenden":a==="fr"?"Utiliser la r√©paration en grille":"Use grid repair"})]}),Ie&&t.jsx("p",{className:"text-xs text-gray-500 ml-12",children:a==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":a==="fr"?"Extrait les r√©gions probl√©matiques dans une grille, r√©pare avec Gemini, v√©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),Ie&&t.jsxs("div",{className:"mt-2 ml-6",children:[t.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[t.jsx("span",{children:a==="de"?"Reparatur-Schwelle:":a==="fr"?"Seuil de r√©paration:":"Force repair threshold:"}),t.jsxs("select",{value:Rr===null?"default":Rr,onChange:r=>Bn(r.target.value==="default"?null:parseInt(r.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[t.jsx("option",{value:"default",children:a==="de"?"Standard (nur bei Fehler)":a==="fr"?"D√©faut (seulement si erreur)":"Default (only on failure)"}),t.jsx("option",{value:"100",children:a==="de"?"100% (immer reparieren)":a==="fr"?"100% (toujours r√©parer)":"100% (always repair)"}),t.jsx("option",{value:"90",children:"90%"}),t.jsx("option",{value:"80",children:"80%"}),t.jsx("option",{value:"75",children:"75%"})]})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:a==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die Qualit√§tspr√ºfung bestehen":a==="fr"?"√Ä 100%, toutes les pages avec des probl√®mes sont r√©par√©es, m√™me si elles passent le contr√¥le qualit√©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Ca,onChange:r=>Fn(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Konsistenzpr√ºfung aktivieren":a==="fr"?"Activer la v√©rification de coh√©rence":"Enable final checks"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"Pr√ºft Bilder und Text auf Konsistenz am Ende der Generierung":a==="fr"?"V√©rifie la coh√©rence des images et du texte √† la fin de la g√©n√©ration":"Checks images and text for consistency at end of generation"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Aa,onChange:r=>Hn(r.target.checked),className:"rounded border-cyan-300 text-cyan-600 focus:ring-cyan-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Szenen-Validierung":a==="fr"?"Validation de sc√®ne":"Scene validation"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"Erzeugt g√ºnstige Vorschau, pr√ºft Geometrie, repariert Kompositionsprobleme":a==="fr"?"G√©n√®re un aper√ßu √©conomique, v√©rifie la g√©om√©trie, r√©pare les probl√®mes de composition":"Generates cheap preview, checks geometry, repairs composition issues"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Na,onChange:r=>Wn(r.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Getrennte Auswertung":a==="fr"?"√âvaluation s√©par√©e":"Separated evaluation"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"Erzeugt alle Bilder zuerst, dann wertet alle parallel aus und repariert":a==="fr"?"G√©n√®re toutes les images d'abord, puis √©value et r√©pare en parall√®le":"Generates all images first, then evaluates and repairs in batch"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:Ta,onChange:r=>On(r.target.checked),className:"rounded border-purple-300 text-purple-600 focus:ring-purple-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Volle Reparatur nach Generierung":a==="fr"?"R√©paration compl√®te apr√®s g√©n√©ration":"Full repair after generation"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"F√ºhrt nach der Generierung den kompletten Reparatur-Workflow aus (bis zu 4 Versuche pro Seite)":a==="fr"?"Ex√©cute le workflow de r√©paration complet apr√®s la g√©n√©ration (jusqu'√† 4 tentatives par page)":"Runs the full repair workflow after generation (up to 4 retries per page)"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:qt,onChange:r=>Mn(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Inkrementelle Konsistenz":a==="fr"?"Coh√©rence incr√©mentielle":"Incremental consistency"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"Pr√ºft jedes Bild gegen vorherige Bilder w√§hrend der Generierung":a==="fr"?"V√©rifie chaque image par rapport aux images pr√©c√©dentes pendant la g√©n√©ration":"Checks each image against previous images during generation"}),qt&&t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[t.jsx("input",{type:"checkbox",checked:ka,onChange:r=>zn(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Nur Protokoll (Dry Run)":a==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),qt&&t.jsx("p",{className:"text-xs text-gray-500 ml-12",children:a==="de"?"Zeigt nur an, was repariert w√ºrde, ohne tats√§chlich zu reparieren":a==="fr"?"Affiche uniquement ce qui serait r√©par√© sans effectuer de r√©parations":"Shows what would be fixed without actually fixing"}),qt&&t.jsxs("div",{className:"mt-2 ml-6",children:[t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-gray-700 text-sm",children:a==="de"?"Vergleichsfenster:":a==="fr"?"Fen√™tre de comparaison:":"Lookback window:"}),t.jsx("input",{type:"range",min:"1",max:"5",value:It,onChange:r=>_n(parseInt(r.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),t.jsx("span",{className:"text-gray-600 font-medium w-4",children:It})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:a==="de"?`Vergleicht jedes Bild mit den ${It} vorherigen`:a==="fr"?`Compare chaque image avec les ${It} pr√©c√©dentes`:`Compares each image with the previous ${It}`})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[t.jsx("input",{type:"checkbox",checked:ja,onChange:r=>Ln(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Nur Pr√ºfung (keine Regenerierung)":a==="fr"?"V√©rification seule (pas de r√©g√©n√©ration)":"Check only (no regeneration)"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"F√ºhrt alle Qualit√§tspr√ºfungen durch, √ºberspringt aber Regenerierung/Reparatur":a==="fr"?"Ex√©cute toutes les v√©rifications de qualit√© mais ignore la r√©g√©n√©ration/r√©paration":"Runs all quality checks but skips regeneration/repair"}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[t.jsx("input",{type:"checkbox",checked:nr,onChange:r=>Vn(r.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),t.jsx("span",{className:"text-gray-700",children:a==="de"?"Alle Avatare laden":a==="fr"?"Charger tous les avatars":"Load all avatars"})]}),t.jsx("p",{className:"text-xs text-gray-500 ml-6",children:a==="de"?"L√§dt alle Avatar-Varianten (30MB+). N√ºtzlich zum Debuggen.":a==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le d√©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),se&&((v==null?void 0:v.role)==="admin"||K)&&t.jsx(Hi,{selections:_e,onChange:Kn}),t.jsxs("button",{onClick:dn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[t.jsx(yn,{size:20})," ",S.back]})]})]})]})}),ot&&!_t&&!Ue&&!vt.frontCover&&!hs&&t.jsx(Mi,{current:ta.current,total:ta.total,message:ta.message,coverImages:vt,characters:ee,jobId:oa||void 0,isStalled:vs,onDismissStalled:()=>zt(!1),isImpersonating:K,onMinimize:()=>Xr(!0),onCancel:oa?async()=>{try{await he.cancelJob(oa),i.info("Job cancelled by user"),Mt(!1),br(null),zt(!1),At({current:0,total:0,message:""}),F(a==="de"?"Generierung abgebrochen":a==="fr"?"G√©n√©ration annul√©e":"Generation cancelled")}catch(r){i.error("Failed to cancel job:",r),k(a==="de"?"Abbruch fehlgeschlagen":a==="fr"?"√âchec de l'annulation":"Failed to cancel")}}:void 0}),ms&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[t.jsx("h3",{className:"text-lg font-semibold mb-2",children:a==="de"?"Geschichte wird im Hintergrund generiert":a==="fr"?"Histoire en cours de g√©n√©ration":"Story generating in background"}),t.jsx("p",{className:"text-gray-600 mb-6",children:a==="de"?"Was m√∂chtest du tun?":a==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:()=>{fr(!0),Xr(!1),e("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:a==="de"?"Neue Geschichte erstellen":a==="fr"?"Cr√©er une autre histoire":"Create another story"}),ps&&t.jsx("button",{onClick:()=>{fr(!0),Xr(!1),e("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:a==="de"?"Meine Geschichten lesen":a==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),fs&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[t.jsx("h3",{className:"text-lg font-semibold mb-2",children:a==="de"?"Nur ein Charakter":a==="fr"?"Un seul personnage":"Only One Character"}),t.jsx("p",{className:"text-gray-600 mb-6",children:a==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":a==="fr"?"Les histoires sont plus int√©ressantes avec plusieurs personnages. Vous n'avez cr√©√© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:()=>{ea(!1),fa()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:a==="de"?"Weiteren Charakter erstellen":a==="fr"?"Cr√©er un autre personnage":"Create another character"}),t.jsx("button",{onClick:async()=>{ea(!1),await ct(D+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:a==="de"?"Trotzdem weiter":a==="fr"?"Continuer quand m√™me":"Continue anyway"})]})]})}),gs&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[t.jsx("div",{className:"relative inline-block mb-4",children:t.jsx(ut,{size:40,className:"animate-spin text-indigo-600"})}),t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:a==="de"?"Bild wird erstellt...":a==="fr"?"Cr√©ation de l'image...":"Generating image..."}),t.jsx("p",{className:"text-sm text-gray-500 mt-2",children:a==="de"?"Dies dauert etwa 30 Sekunden":a==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),zs&&$e&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[t.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:a==="de"?"Bild bearbeiten":a==="fr"?"Modifier l'image":"Edit Image"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4",children:$e.type==="image"?a==="de"?`Seite ${$e.pageNumber}`:a==="fr"?`Page ${$e.pageNumber}`:`Page ${$e.pageNumber}`:a==="de"?$e.coverType==="front"?"Titelseite":$e.coverType==="back"?"R√ºckseite":"Einleitungsseite":a==="fr"?$e.coverType==="front"?"Couverture":$e.coverType==="back"?"Dos":"Page de d√©dicace":$e.coverType==="front"?"Front Cover":$e.coverType==="back"?"Back Cover":"Dedication Page"}),t.jsx("textarea",{value:Xt,onChange:r=>er(r.target.value),placeholder:a==="de"?`Beschreibe die gew√ºnschte √Ñnderung...
z.B. "Mach den Himmel blauer" oder "F√ºge einen Schmetterling hinzu"`:a==="fr"?`D√©crivez le changement souhait√©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),t.jsxs("div",{className:"flex gap-3 mt-4",children:[t.jsx("button",{onClick:()=>{Cr(!1),kr(null),er("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"}),t.jsx("button",{onClick:async()=>{if(!(!Xt.trim()||!O)){Cr(!1),Oa(!0);try{if($e.type==="image"&&$e.pageNumber){const r=await he.editImage(O,$e.pageNumber,Xt);if(i.info("Edit result:",{hasImageData:!!(r!=null&&r.imageData),score:r==null?void 0:r.qualityScore}),!(r!=null&&r.imageData))throw i.error("No imageData in edit response!",r),new Error("No image data returned from server");Fe(c=>c.map(d=>d.pageNumber===$e.pageNumber?{...d,imageData:r.imageData,qualityScore:r.qualityScore,qualityReasoning:r.qualityReasoning,wasEdited:!0,originalImage:r.originalImage,originalScore:r.originalScore,originalReasoning:r.originalReasoning}:d)),i.info("Image edited successfully, updated state with quality info")}else if($e.type==="cover"&&$e.coverType){const r=await he.editCover(O,$e.coverType,Xt);qe(c=>{if(!c)return c;const d=$e.coverType==="front"?"frontCover":$e.coverType==="back"?"backCover":"initialPage",f=c[d],b={...typeof f=="object"?f:{},imageData:r.imageData,qualityScore:r.qualityScore,qualityReasoning:r.qualityReasoning,wasEdited:!0,originalImage:r.originalImage,originalScore:r.originalScore,originalReasoning:r.originalReasoning};return{...c,[d]:b}}),i.info("Cover edited successfully with quality info")}}catch(r){i.error("Edit failed:",r),k(a==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":a==="fr"?"√âchec de la modification. Veuillez r√©essayer.":"Edit failed. Please try again.")}finally{Oa(!1),kr(null),er("")}}},disabled:!Xt.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:a==="de"?"Bearbeiten":a==="fr"?"Modifier":"Edit"})]})]})}),t.jsx(Zi,{isOpen:ns,faces:Ga,onSelect:Ks,onUploadNew:Js,developerMode:se}),t.jsx(qi,{isOpen:ys,onClose:()=>pr(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const r=localStorage.getItem("verificationGenerationStarted");if(r){const c=parseInt(r,10),d=Date.now()-120*1e3;if(c>d){console.log("[EmailVerification] Another window started recently, skipping"),pr(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),Tt({skipEmailCheck:!0}),pr(!1)}})]}):t.jsx(hn,{fullScreen:!0})}const Bo=Object.freeze(Object.defineProperty({__proto__:null,default:uo},Symbol.toStringTag,{value:"Module"}));export{Pi as P,Ii as S,$i as U,En as a,No as b,Se as c,$o as d,Eo as e,Ki as f,Ui as g,Do as h,Cn as i,Ro as j,Io as k,Po as l,Go as m,jn as n,An as o,To as p,Nn as q,wa as r,Ao as s,ba as t,jo as u,Bo as v};
