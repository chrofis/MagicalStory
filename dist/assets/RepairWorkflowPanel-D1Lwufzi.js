import{c as pe,s as Y,j as e,L as he,C as be,T as Le}from"./index-C3uMI6QL.js";import{b as x}from"./vendor-react-CqfXSjHo.js";import{I as _e}from"./ImageLightbox-BypBh19s.js";import{W as Ee}from"./wrench-Swfl6jdK.js";import{b as Be,I as We,R as Ge}from"./Modal-C079ErNU.js";import{C as Pe}from"./chevron-down-B9xDiT37.js";import{C as Fe}from"./chevron-right-BggSWfZN.js";import{S as Ae}from"./square-BNBqM53m.js";import{S as Te}from"./search-DQ7EBw_e.js";import{C as qe}from"./circle-x-Bs_QdcBI.js";import{U as $e}from"./Input-Y22R6JyI.js";import"./vendor-firebase-DTVMaYMy.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=pe("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=pe("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=pe("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=pe("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=pe("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function Oe(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending","cover-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{},pageDetails:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{},pagesFailed:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const xe=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair","cover-repair"];function Je({storyId:a,sceneImages:I,characters:re,finalChecksReport:W,imageModel:V,onImageUpdate:L}){const[b,F]=x.useState(Oe),[se,Q]=x.useState({current:0,total:0,currentPage:void 0}),_=x.useRef(null),[te,X]=x.useState(!1),ae=x.useMemo(()=>Object.values(b.stepStatus).some(r=>r==="in-progress"),[b.stepStatus]),B=x.useMemo(()=>xe.indexOf(b.currentStep),[b.currentStep]),o=x.useCallback(r=>{F(n=>({...n,currentStep:r,stepStatus:{...n.stepStatus,[r]:"in-progress"}}))},[]),$=x.useCallback((r,n)=>{F(l=>({...l,stepStatus:{...l.stepStatus,[r]:"completed"},...r==="collect-feedback"&&n?{collectedFeedback:n}:{},...r==="re-evaluate"&&n?{reEvaluationResults:n}:{},...r==="consistency-check"&&n?{consistencyResults:n}:{}}))},[]),w=x.useCallback((r,n)=>{F(l=>({...l,stepStatus:{...l.stepStatus,[r]:"failed"}}))},[]),g=x.useCallback(r=>{F(n=>({...n,stepStatus:{...n.stepStatus,[r]:"skipped"}}))},[]),C=x.useCallback(()=>{F(Oe()),Q({current:0,total:0,currentPage:void 0}),X(!1),_.current=null},[]),fe=x.useCallback(()=>{var r;console.log("[useRepairWorkflow] Aborting workflow"),(r=_.current)==null||r.abort(),X(!0)},[]),ie=x.useCallback(async()=>{var r,n,l,h,R,y,m,d,S,k,q,G,f,M;if(a){o("collect-feedback");try{const P={};let D=0;for(const j of I){const H={pageNumber:j.pageNumber,qualityScore:j.qualityScore,semanticScore:j.semanticScore??null,verdict:j.verdict,issuesSummary:j.issuesSummary,semanticResult:j.semanticResult??null,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},z=new Set,A=(i,t)=>{const s=i.description||i.issue||"";s&&z.has(s)||(s&&z.add(s),H.fixableIssues.push({...i,source:t}))};if((r=j.fixableIssues)!=null&&r.length)for(const i of j.fixableIssues)A(i,i.source||"quality eval");const N=(n=j.imageVersions)==null?void 0:n.find(i=>i.isActive);if((l=N==null?void 0:N.fixableIssues)!=null&&l.length)for(const i of N.fixableIssues)A(i,i.source||"active version eval");for(const i of j.retryHistory||[]){if((R=(h=i.postRepairEval)==null?void 0:h.fixableIssues)!=null&&R.length)for(const t of i.postRepairEval.fixableIssues)A(t,"post-repair eval");if((m=(y=i.preRepairEval)==null?void 0:y.fixableIssues)!=null&&m.length)for(const t of i.preRepairEval.fixableIssues)A(t,"pre-repair eval")}if((d=j.fixTargets)!=null&&d.length)for(const i of j.fixTargets)A({description:i.issue||"Quality issue detected",severity:"medium",type:"visual",fix:i.fixPrompt||""},"fix targets");if(j.semanticResult){for(const i of j.semanticResult.semanticIssues||[])A({description:i.problem||`${i.type||"semantic"}: ${i.item||""}`,severity:((S=i.severity)==null?void 0:S.toLowerCase())||"medium",type:i.type||"semantic",fix:i.expected?`Expected: ${i.expected}`:""},"semantic eval");for(const i of j.semanticResult.issues||[])A({description:i.problem||`${i.type}: ${i.item||""}`,severity:((k=i.severity)==null?void 0:k.toLowerCase())||"medium",type:i.type||"semantic",fix:""},"semantic eval")}if((G=(q=j.consistencyRegen)==null?void 0:q.issues)!=null&&G.length)for(const i of j.consistencyRegen.issues)A({description:i.description,severity:i.severity,type:i.type||"consistency",fix:i.recommendation||"",character:i.characterInvolved},"consistency regen");if(W!=null&&W.entity){for(const[i,t]of Object.entries(W.entity.characters||{})){const s=[];if(t.byClothing&&Object.keys(t.byClothing).length>0)for(const p of Object.values(t.byClothing))p.issues&&s.push(...p.issues);else t.issues&&s.push(...t.issues);const c=s.filter(p=>{var u;return((u=p.pagesToFix)==null?void 0:u.includes(j.pageNumber))||p.pageNumber===j.pageNumber});for(const p of c)H.entityIssues.push({character:i,issue:p.description,severity:p.severity,source:"entity check"})}for(const[i,t]of Object.entries(W.entity.objects||{})){const s=[];if(t.byClothing&&Object.keys(t.byClothing).length>0)for(const p of Object.values(t.byClothing))p.issues&&s.push(...p.issues);else t.issues&&s.push(...t.issues);const c=s.filter(p=>{var u;return((u=p.pagesToFix)==null?void 0:u.includes(j.pageNumber))||p.pageNumber===j.pageNumber});for(const p of c)H.objectIssues.push({object:i,issue:p.description,severity:p.severity,source:"entity check"})}}if(W!=null&&W.imageChecks)for(const i of W.imageChecks)for(const t of i.issues||[])(((f=t.pagesToFix)==null?void 0:f.includes(j.pageNumber))||((M=t.images)==null?void 0:M.includes(j.pageNumber)))&&H.semanticIssues.push({type:t.type,description:t.description,severity:t.severity,characterInvolved:t.characterInvolved,recommendation:t.recommendation,source:"image checks"});D+=H.fixableIssues.length+H.entityIssues.length+H.objectIssues.length+H.semanticIssues.length,P[j.pageNumber]=H}$("collect-feedback",{pages:P,totalIssues:D})}catch(P){console.error("Failed to collect feedback:",P),w("collect-feedback",P instanceof Error?P.message:"Unknown error")}}},[a,I,W,o,$,w]),ye=x.useCallback((r,n)=>{F(l=>({...l,collectedFeedback:{...l.collectedFeedback,pages:{...l.collectedFeedback.pages,[r]:{...l.collectedFeedback.pages[r],...n}}}}))},[]),me=x.useCallback((r,n)=>{F(l=>{const h=l.redoPages.pageNumbers.includes(r),R=h?l.redoPages.pageNumbers.filter(m=>m!==r):[...l.redoPages.pageNumbers,r].sort((m,d)=>m-d),y={...l.redoPages.reasons};return h?delete y[r]:n&&(y[r]=n),{...l,redoPages:{pageNumbers:R,reasons:y}}})},[]),je=x.useCallback((r=60,n=3)=>{o("identify-redo-pages");const l=[],h={};for(const[R,y]of Object.entries(b.collectedFeedback.pages)){const m=parseInt(R),d=y.fixableIssues.length+y.entityIssues.length,S=y.qualityScore??100;S<r?(l.push(m),h[m]=`Low quality score: ${S}`):d>=n?(l.push(m),h[m]=`Too many issues: ${d}`):y.needsFullRedo&&(l.push(m),h[m]="Manually marked for redo")}F(R=>({...R,redoPages:{pageNumbers:l.sort((y,m)=>y-m),reasons:h},stepStatus:{...R.stepStatus,"identify-redo-pages":"completed"}}))},[b.collectedFeedback.pages,o]),Ne=x.useCallback(async r=>{var y;if(!a||b.redoPages.pageNumbers.length===0)return;o("redo-pages");const n=b.redoPages.pageNumbers;Q({current:0,total:n.length,currentPage:void 0});const l=[],h={},R={};try{for(let m=0;m<n.length;m++){const d=n[m];Q({current:m,total:n.length,currentPage:d});try{const S=await Y.iteratePage(a,d,V,{useOriginalAsReference:r==null?void 0:r.useOriginalAsReference,blackoutIssues:r==null?void 0:r.blackoutIssues});if(S.success){l.push(d);const k=I.find(G=>G.pageNumber===d),q=((y=k==null?void 0:k.imageVersions)==null?void 0:y.length)??0;h[d]=q,R[d]={previousScore:S.previousScore??null,newScore:S.qualityScore??null,previousImage:S.previousImage??null,newImage:S.imageData??null,blackoutImage:S.blackoutImage??null},L&&L(d,S.imageData,q)}}catch(S){console.error(`Failed to redo page ${d}:`,S)}}F(m=>({...m,redoResults:{pagesCompleted:l,newVersions:h,pageDetails:R},stepStatus:{...m.stepStatus,"redo-pages":"completed"}})),Q({current:n.length,total:n.length,currentPage:void 0})}catch(m){console.error("Redo pages failed:",m),w("redo-pages",m instanceof Error?m.message:"Unknown error")}},[a,b.redoPages.pageNumbers,V,I,L,o,w]),U=x.useCallback(async r=>{if(!a)return;o("re-evaluate");const n=r??b.redoResults.pagesCompleted;if(n.length===0){g("re-evaluate");return}try{const l=await Y.reEvaluatePages(a,n),h={};for(const[R,y]of Object.entries(l.pages||{})){const m=y;h[parseInt(R)]={qualityScore:m.qualityScore,rawScore:m.rawScore,verdict:m.verdict,issuesSummary:m.issuesSummary,reasoning:m.reasoning,fixableIssues:m.fixableIssues}}$("re-evaluate",{pages:h})}catch(l){console.error("Re-evaluation failed:",l),w("re-evaluate",l instanceof Error?l.message:"Unknown error")}},[a,b.redoResults.pagesCompleted,o,$,w,g]),ne=x.useCallback(async()=>{if(a){o("consistency-check");try{const r=await Y.runEntityConsistency(a);$("consistency-check",{report:r.report})}catch(r){console.error("Consistency check failed:",r),w("consistency-check",r instanceof Error?r.message:"Unknown error")}}},[a,o,$,w]),le=x.useCallback(async(r,n,l)=>{var h,R,y,m;if(!(!a||n.length===0)){o("character-repair");try{const d=await Y.repairCharacters(a,[{character:r,pages:n}],l),S=((R=(h=d.results)==null?void 0:h[0])==null?void 0:R.pagesRepaired)||[],k=((m=(y=d.results)==null?void 0:y[0])==null?void 0:m.pagesFailed)||[];for(const f of S)if(f.imageData&&L)try{L(f.pageNumber,f.imageData,f.versionIndex)}catch(M){console.error(`[RepairWorkflow] Failed to notify parent of image update for page ${f.pageNumber}:`,M)}k.length>0&&console.warn(`[RepairWorkflow] ${k.length} pages failed repair for ${r}:`,k.map(f=>`page ${f.pageNumber}: ${f.reason}`).join(", "));const q=S.map(f=>({pageNumber:typeof f=="number"?f:f.pageNumber,comparison:f.comparison||null,verification:f.verification||null,method:f.method||"gemini"})),G=k.map(f=>({pageNumber:f.pageNumber,reason:f.reason,rejected:f.rejected,comparison:f.comparison||null}));F(f=>({...f,characterRepairResults:{charactersProcessed:[...f.characterRepairResults.charactersProcessed,r],pagesRepaired:{...f.characterRepairResults.pagesRepaired,[r]:q},pagesFailed:{...f.characterRepairResults.pagesFailed,[r]:G}},stepStatus:{...f.stepStatus,"character-repair":k.length>0&&S.length===0?"failed":"completed"}}))}catch(d){console.error("Character repair failed:",d),w("character-repair",d instanceof Error?d.message:"Unknown error")}}},[a,o,w,L]),oe=x.useCallback(async r=>{if(!(!a||r.length===0)){o("artifact-repair");try{const n=await Y.repairArtifacts(a,r);F(l=>({...l,artifactRepairResults:{pagesProcessed:n.pagesProcessed||r,issuesFixed:n.issuesFixed||0},stepStatus:{...l.stepStatus,"artifact-repair":"completed"}}))}catch(n){console.error("Artifact repair failed:",n),w("artifact-repair",n instanceof Error?n.message:"Unknown error")}}},[a,o,w]),[ve,de]=x.useState({current:0,total:0,currentCover:void 0}),K=x.useCallback(async r=>{if(!a||r.length===0)return;o("cover-repair"),de({current:0,total:r.length,currentCover:void 0});const n=[];try{for(let l=0;l<r.length;l++){const h=r[l];de({current:l,total:r.length,currentCover:h});try{await Y.regenerateCover(a,h),n.push(h)}catch(R){console.error(`Failed to regenerate ${h} cover:`,R)}}F(l=>({...l,stepStatus:{...l.stepStatus,"cover-repair":n.length>0?"completed":"failed"}})),de({current:r.length,total:r.length,currentCover:void 0})}catch(l){console.error("Cover repair failed:",l),w("cover-repair",l instanceof Error?l.message:"Unknown error")}},[a,o,w]),we=x.useCallback(r=>{const n=xe.indexOf(r);if(r==="idle")return!0;if(ae)return!1;switch(r){case"collect-feedback":return!0;case"identify-redo-pages":return b.stepStatus["collect-feedback"]==="completed";case"redo-pages":return b.redoPages.pageNumbers.length>0;case"re-evaluate":return b.stepStatus["redo-pages"]==="completed"||b.stepStatus["redo-pages"]==="skipped";case"consistency-check":return n>xe.indexOf("collect-feedback");case"character-repair":return b.stepStatus["consistency-check"]==="completed";case"artifact-repair":return b.stepStatus["collect-feedback"]==="completed";case"cover-repair":return!0;default:return!1}},[b,ae]),Re=x.useCallback(r=>{const n=xe.indexOf(r);return n>0?n:0},[]),Se=x.useCallback(()=>Object.entries(b.collectedFeedback.pages).filter(([r,n])=>{const l=n.qualityScore??100,h=n.fixableIssues.length+n.entityIssues.length;return l<70||h>0||n.needsFullRedo}).map(([r])=>parseInt(r)).sort((r,n)=>r-n),[b.collectedFeedback.pages]),Ce=x.useCallback(()=>{const r=b.consistencyResults.report;return r!=null&&r.characters?Object.entries(r.characters).filter(([n,l])=>{var h;return"overallConsistent"in l?!l.overallConsistent||(l.totalIssues??0)>0:!l.consistent||(((h=l.issues)==null?void 0:h.length)??0)>0}).map(([n])=>n):[]},[b.consistencyResults.report]),ue=x.useCallback(r=>{var R;const n=b.consistencyResults.report;if(!((R=n==null?void 0:n.characters)!=null&&R[r]))return[];const l=n.characters[r],h=new Set;if(l.byClothing){for(const y of Object.values(l.byClothing))for(const m of y.issues||[])if(m.severity==="major"||m.severity==="critical"){for(const d of m.pagesToFix||[])h.add(d);m.pageNumber&&h.add(m.pageNumber)}}if(l.issues){for(const y of l.issues)if(y.severity==="major"||y.severity==="critical"){for(const m of y.pagesToFix||[])h.add(m);y.pageNumber&&h.add(y.pageNumber)}}return Array.from(h).sort((y,m)=>y-m)},[b.consistencyResults.report]),ke=x.useCallback(async(r={})=>{var q,G,f;if(!a)return;const n=6,l=3,h=4,{scoreThreshold:R=n,issueThreshold:y=l,maxRetries:m=h,onProgress:d}=r;_.current=new AbortController,X(!1);const S=_.current.signal,k=()=>{if(S.aborted)throw console.log("[useRepairWorkflow] Workflow aborted"),new Error("Workflow aborted")};try{k(),d==null||d("collect-feedback","Collecting existing issues..."),await ie(),k(),d==null||d("re-evaluate","Evaluating all pages...");const M=await Y.reEvaluatePages(a,I.map(N=>N.pageNumber)),P={};for(const[N,i]of Object.entries(M.pages||{})){const t=i;P[parseInt(N)]=t}k(),d==null||d("identify-redo-pages","Identifying pages needing redo...");const D=[];for(const[N,i]of Object.entries(P)){const t=parseInt(N),s=i.rawScore??Math.round(i.qualityScore/10);s>10&&console.error(`[RepairWorkflow] Invalid rawScore scale for page ${t}: ${s} (expected 0-10)`);const c=((q=i.fixableIssues)==null?void 0:q.length)??0;(s<R||c>=y)&&D.push(t)}D.sort((N,i)=>N-i),F(N=>({...N,redoPages:{pageNumbers:D,reasons:{}},stepStatus:{...N.stepStatus,"identify-redo-pages":"completed"}})),k();const j=[];if(D.length>0){d==null||d("redo-pages",`Redoing ${D.length} pages...`),o("redo-pages");const N={};for(let i=0;i<D.length;i++){k();const t=D[i];let s=0,c="",p=0;for(let u=1;u<=m;u++){k(),d==null||d("redo-pages",`Page ${t}: attempt ${u}/${m}`),Q({current:i,total:D.length,currentPage:t});try{const v=await Y.iteratePage(a,t,V);if(v.success){const T=v.qualityScore??0;if(T>s){s=T,c=v.imageData;const J=I.find(ce=>ce.pageNumber===t);p=(((G=J==null?void 0:J.imageVersions)==null?void 0:G.length)??0)+u-1}if(T>=R*10)break}}catch(v){console.error(`Failed to redo page ${t} attempt ${u}:`,v)}}c&&(N[t]={score:s,imageData:c,versionIndex:p},j.push(t),L==null||L(t,c,p))}F(i=>({...i,redoResults:{pagesCompleted:j,newVersions:Object.fromEntries(Object.entries(N).map(([t,s])=>[t,s.versionIndex])),pageDetails:{}},stepStatus:{...i.stepStatus,"redo-pages":"completed"}}))}j.length>0&&(k(),d==null||d("re-evaluate","Re-evaluating redone pages..."),await U(j)),k(),d==null||d("consistency-check","Running consistency check...");const z=(await Y.runEntityConsistency(a)).report;if(F(N=>({...N,consistencyResults:{report:z},stepStatus:{...N.stepStatus,"consistency-check":"completed"}})),k(),z!=null&&z.characters){const N=Object.entries(z.characters).filter(([i,t])=>{var s;return"overallConsistent"in t?!t.overallConsistent||(t.totalIssues??0)>0:!t.consistent||(((s=t.issues)==null?void 0:s.length)??0)>0}).map(([i])=>i);if(N.length>0){d==null||d("character-repair",`Repairing ${N.length} characters...`);for(const i of N){k();const t=z.characters[i],s=new Set;if(t.byClothing){for(const p of Object.values(t.byClothing))for(const u of p.issues||[])if(u.severity==="major"||u.severity==="critical"){for(const v of u.pagesToFix||[])s.add(v);u.pageNumber&&s.add(u.pageNumber)}}if(t.issues){for(const p of t.issues)if(p.severity==="major"||p.severity==="critical"){for(const u of p.pagesToFix||[])s.add(u);p.pageNumber&&s.add(p.pageNumber)}}const c=Array.from(s).sort((p,u)=>p-u);c.length>0&&(d==null||d("character-repair",`Repairing ${i} on ${c.length} pages...`),await le(i,c))}}}k();const A=[];for(const[N,i]of Object.entries(P))(f=i.fixableIssues)!=null&&f.some(t=>t.type==="artifact"||t.type==="distortion")&&A.push(parseInt(N));A.length>0&&(d==null||d("artifact-repair",`Repairing artifacts on ${A.length} pages...`),await oe(A)),d==null||d("complete","Workflow complete!")}catch(M){if(M instanceof Error&&M.message==="Workflow aborted"){console.log("[useRepairWorkflow] Workflow was aborted by user");return}throw console.error("Full workflow failed:",M),M}finally{_.current=null}},[a,I,V,L,ie,U,o,Q,ne,le,oe]);return{workflowState:b,isRunning:ae,currentStepIndex:B,startStep:o,completeStep:$,failStep:w,skipStep:g,resetWorkflow:C,collectFeedback:ie,updatePageFeedback:ye,toggleRedoPage:me,autoIdentifyRedoPages:je,redoMarkedPages:Ne,redoProgress:se,reEvaluatePages:U,runConsistencyCheck:ne,repairCharacter:le,repairArtifacts:oe,regenerateCovers:K,coverRepairProgress:ve,runFullWorkflow:ke,abortWorkflow:fe,isAborted:te,canProceedToStep:we,getStepNumber:Re,getPagesNeedingAttention:Se,getCharactersWithIssues:Ce,getPagesWithSevereIssuesForCharacter:ue}}const ee={idle:{label:"Ready",icon:Me,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:Te,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:Le,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:Ge,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:be,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:$e,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:$e,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:De,description:"Fix remaining artifacts via grid repair"},"cover-repair":{label:"8. Cover Repair",icon:We,description:"Regenerate front, back, or dedication covers"}};function Qe({status:a}){const I={pending:{color:"bg-gray-100 text-gray-600",icon:Me},"in-progress":{color:"bg-blue-100 text-blue-600",icon:he},completed:{color:"bg-green-100 text-green-600",icon:be},skipped:{color:"bg-yellow-100 text-yellow-600",icon:He},failed:{color:"bg-red-100 text-red-600",icon:qe}},{color:re,icon:W}=I[a],V=a==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${re}`,children:[e.jsx(W,{className:`w-3 h-3 ${V?"animate-spin":""}`}),a]})}function Ue({feedback:a,isMarkedForRedo:I,onToggleRedo:re,onUpdateNotes:W}){var se,Q,_,te,X,ae,B;const[V,L]=x.useState(!1),b=a.fixableIssues.length+a.entityIssues.length+(((se=a.objectIssues)==null?void 0:se.length)||0)+(((Q=a.semanticIssues)==null?void 0:Q.length)||0),F=b>0||a.qualityScore!==void 0&&a.qualityScore<70;return e.jsxs("div",{className:`border rounded-lg p-3 ${I?"border-red-300 bg-red-50":F?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>L(!V),className:"p-1 hover:bg-gray-100 rounded",children:V?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",a.pageNumber]}),a.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${a.qualityScore>=80?"bg-green-100 text-green-700":a.qualityScore>=60?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[a.semanticScore!=null?"Quality":"Score",": ",Math.max(0,a.qualityScore)]}),a.semanticScore!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",a.semanticScore,"%"]}),a.qualityScore!==void 0&&a.semanticScore!=null&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${a.qualityScore>=70?"bg-green-100 text-green-700":a.qualityScore>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",a.qualityScore,"%"]}),a.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${a.verdict==="PASS"?"bg-green-100 text-green-700":a.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:a.verdict}),b>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[b," issues"]})]}),e.jsx("button",{onClick:re,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${I?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:I?"Marked for Redo":"Mark for Redo"})]}),V&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[a.issuesSummary&&a.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${a.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:a.issuesSummary}),a.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["Semantic Analysis (Score: ",a.semanticResult.score??"N/A","):"]}),a.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"Visible:"}),a.semanticResult.visible.characters&&a.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",a.semanticResult.visible.characters.join(", ")]}),a.semanticResult.visible.objects&&a.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",a.semanticResult.visible.objects.join(", ")]}),a.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",a.semanticResult.visible.setting]}),a.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",a.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"Expected:"}),((_=a.semanticResult.expected)==null?void 0:_.characters)&&a.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",a.semanticResult.expected.characters.join(", ")]}),((te=a.semanticResult.expected)==null?void 0:te.objects)&&a.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",a.semanticResult.expected.objects.join(", ")]}),((X=a.semanticResult.expected)==null?void 0:X.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",a.semanticResult.expected.setting]}),((ae=a.semanticResult.expected)==null?void 0:ae.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",a.semanticResult.expected.action]})]})]}),a.semanticResult.semanticIssues&&a.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:a.semanticResult.semanticIssues.map((o,$)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${o.severity==="CRITICAL"?"text-red-600":o.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",o.severity,"]"]})," ",o.problem]},$))}),((B=a.semanticResult.semanticIssues)==null?void 0:B.length)===0&&!a.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"No issues"})]}),a.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",a.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:a.fixableIssues.map((o,$)=>e.jsxs("li",{className:"flex items-start gap-1",children:[o.source&&e.jsx("span",{className:"text-[10px] px-1 rounded bg-gray-100 text-gray-500",children:o.source}),e.jsx("span",{className:`px-1 rounded ${o.severity==="critical"?"bg-red-100 text-red-700":o.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:o.severity}),e.jsxs("span",{children:["[",o.type,"] ",o.description]})]},$))})]}),a.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",a.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:a.entityIssues.map((o,$)=>e.jsxs("li",{className:"flex items-start gap-1",children:[o.source&&e.jsx("span",{className:"text-[10px] px-1 rounded bg-gray-100 text-gray-500",children:o.source}),e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:o.character}),e.jsx("span",{className:`px-1 rounded ${o.severity==="critical"?"bg-red-100 text-red-700":o.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:o.severity}),e.jsx("span",{children:o.issue})]},$))})]}),a.objectIssues&&a.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",a.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:a.objectIssues.map((o,$)=>e.jsxs("li",{className:"flex items-start gap-1",children:[o.source&&e.jsx("span",{className:"text-[10px] px-1 rounded bg-gray-100 text-gray-500",children:o.source}),e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:o.object}),e.jsx("span",{className:`px-1 rounded ${o.severity==="critical"?"bg-red-100 text-red-700":o.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:o.severity}),e.jsx("span",{children:o.issue})]},$))})]}),a.semanticIssues&&a.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",a.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:a.semanticIssues.map((o,$)=>e.jsxs("li",{className:"flex items-start gap-1",children:[o.source&&e.jsx("span",{className:"text-[10px] px-1 rounded bg-gray-100 text-gray-500",children:o.source}),e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:o.type.replace(/_/g," ")}),o.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:o.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${o.severity==="high"?"bg-red-100 text-red-700":o.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:o.severity}),e.jsx("span",{children:o.description})]},$))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:a.manualNotes,onChange:o=>W(o.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}const Ie="repair-workflow-autorun-completed";function ns({storyId:a,sceneImages:I,characters:re,finalChecksReport:W,imageModel:V,onImageUpdate:L,onRefreshStory:b,autoRunFullWorkflow:F=!1,onAutoRunComplete:se,developerMode:Q=!1,useMagicApiRepair:_=!1,setUseMagicApiRepair:te}){const[X,ae]=x.useState(!0),[B,o]=x.useState(new Set(["collect-feedback"])),[$,w]=x.useState(null),{workflowState:g,isRunning:C,resetWorkflow:fe,collectFeedback:ie,updatePageFeedback:ye,toggleRedoPage:me,autoIdentifyRedoPages:je,redoMarkedPages:Ne,redoProgress:U,reEvaluatePages:ne,runConsistencyCheck:le,repairCharacter:oe,repairArtifacts:ve,regenerateCovers:de,coverRepairProgress:K,runFullWorkflow:we,abortWorkflow:Re,isAborted:Se,getStepNumber:Ce,getCharactersWithIssues:ue,getPagesWithSevereIssuesForCharacter:ke}=Je({storyId:a,sceneImages:I,characters:re,finalChecksReport:W,imageModel:V,onImageUpdate:L}),[r,n]=x.useState(null),[l,h]=x.useState(!1),R=x.useRef(null),y=t=>{try{return JSON.parse(localStorage.getItem(Ie)||"[]").includes(t)}catch{return!1}},m=t=>{try{const s=JSON.parse(localStorage.getItem(Ie)||"[]");if(!s.includes(t)){s.push(t);const c=s.slice(-10);localStorage.setItem(Ie,JSON.stringify(c))}}catch(s){console.error("[RepairWorkflowPanel] Failed to save auto-run completion:",s)}};x.useEffect(()=>{if(F&&a&&I.length>0&&!C&&!l){const t=R.current===a,s=y(a);!t&&!s?(R.current=a,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",a),setTimeout(async()=>{await d(),m(a),se==null||se()},500)):console.log("[RepairWorkflowPanel] Skipping auto-run - already completed for story:",a,{alreadyRunThisSession:t,alreadyCompletedPreviously:s})}},[F,a,I.length,C,l]);const d=async()=>{h(!0);try{await we({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(t,s)=>{n({step:t,detail:s})}}),b&&await b()}catch(t){console.error("Full workflow failed:",t)}finally{h(!1),n(null)}},[S,k]=x.useState(""),[q,G]=x.useState([]),[f,M]=x.useState([]),[P,D]=x.useState("fresh"),[j,H]=x.useState([]),z=t=>{o(s=>{const c=new Set(s);return c.has(t)?c.delete(t):c.add(t),c})},A=x.useMemo(()=>ue(),[ue]),N=x.useMemo(()=>{var s;const t=new Set;for(const[c,p]of Object.entries(g.collectedFeedback.pages))p.fixableIssues.some(u=>u.type==="artifact"||u.type==="distortion")&&t.add(parseInt(c));for(const[c,p]of Object.entries(g.reEvaluationResults.pages))(s=p.fixableIssues)!=null&&s.some(u=>u.type==="artifact"||u.type==="distortion")&&t.add(parseInt(c));return Array.from(t).sort((c,p)=>c-p)},[g.collectedFeedback.pages,g.reEvaluationResults.pages]),i=t=>{const s=ee[t],c=s.icon,p=g.stepStatus[t],u=B.has(t),v=Ce(t);return e.jsxs("button",{onClick:()=>z(t),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${p==="in-progress"?"bg-blue-50":p==="completed"?"bg-green-50":p==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:v}),e.jsx(c,{className:`w-4 h-4 ${p==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:s.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{status:p}),u?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})]})]})};return a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>ae(!X),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ee,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),g.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[g.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(he,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:t=>{t.stopPropagation(),fe()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(Be,{className:"w-4 h-4 text-amber-700"})}),X?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})]})]}),X&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsxs("button",{onClick:()=>{Re(),h(!1),n(null)},className:"flex items-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium",title:"Stop the workflow",children:[e.jsx(Ae,{className:"w-5 h-5"}),"Stop"]}),e.jsx("button",{onClick:d,disabled:C||l,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:l?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-5 h-5"}),"Run Full Workflow"]})})]})]}),r&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(he,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[r.step,":"]}),e.jsx("span",{className:"text-purple-600",children:r.detail})]})}),Se&&!l&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(Ae,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Workflow stopped"})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("collect-feedback"),B.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["collect-feedback"].description}),e.jsxs("button",{onClick:ie,disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Te,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(g.collectedFeedback.pages).length>0&&(()=>{const t=Object.values(g.collectedFeedback.pages),s=t.reduce((E,O)=>E+O.fixableIssues.length,0),c=t.reduce((E,O)=>E+O.entityIssues.length,0),p=t.reduce((E,O)=>{var Z;return E+(((Z=O.objectIssues)==null?void 0:Z.length)||0)},0),u=t.reduce((E,O)=>{var Z;return E+(((Z=O.semanticIssues)==null?void 0:Z.length)||0)},0),v=s+c+p+u,T=Object.values(g.reEvaluationResults.pages),J=T.reduce((E,O)=>{var Z;return E+(((Z=O.fixableIssues)==null?void 0:Z.length)||0)},0),ce=T.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",v," issue",v!==1?"s":"",ce?` + ${J} from re-evaluation`:""]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[s>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",s]}),c>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",c]}),p>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",p]}),u>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",u]}),ce&&J>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",J]}),v===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:t.sort((E,O)=>E.pageNumber-O.pageNumber).map(E=>e.jsx(Ue,{feedback:E,isMarkedForRedo:g.redoPages.pageNumbers.includes(E.pageNumber),onToggleRedo:()=>me(E.pageNumber),onUpdateNotes:O=>ye(E.pageNumber,{manualNotes:O})},E.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("identify-redo-pages"),B.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>je(6,3),disabled:C||g.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ge,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),g.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",g.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.redoPages.pageNumbers.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:g.redoPages.reasons[t],children:["Page ",t,e.jsx("button",{onClick:()=>me(t),className:"hover:text-red-900",children:e.jsx(qe,{className:"w-3 h-3"})})]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("redo-pages"),B.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["redo-pages"].description}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded-lg cursor-pointer transition-colors ${P==="fresh"?"bg-amber-50 border border-amber-300":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"radio",name:"redoMode",checked:P==="fresh",onChange:()=>D("fresh"),disabled:C,className:"mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:"Fresh generation"}),e.jsx("p",{className:"text-xs text-gray-500",children:"New generation from AI-corrected scene description"})]})]}),e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded-lg cursor-pointer transition-colors ${P==="reference"?"bg-blue-50 border border-blue-300":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"radio",name:"redoMode",checked:P==="reference",onChange:()=>D("reference"),disabled:C,className:"mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:"Use original as reference"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Passes current image to Gemini â€” preserves composition, fixes details"})]})]}),e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded-lg cursor-pointer transition-colors ${P==="blackout"?"bg-purple-50 border border-purple-300":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"radio",name:"redoMode",checked:P==="blackout",onChange:()=>D("blackout"),disabled:C,className:"mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:"Blackout issues"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Blacks out broken areas in the image, forces AI to regenerate those regions"})]})]})]}),e.jsxs("button",{onClick:()=>Ne({useOriginalAsReference:P==="reference",blackoutIssues:P==="blackout"}),disabled:C||g.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ve,{className:"w-4 h-4"}),"Redo ",g.redoPages.pageNumbers.length," Pages",P!=="fresh"&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",P==="reference"?"with reference":"blackout issues",")"]})]}),U.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",U.current," / ",U.total]}),U.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",U.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${U.current/U.total*100}%`}})})]}),g.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",g.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-3",children:g.redoResults.pagesCompleted.map(t=>{var c;const s=(c=g.redoResults.pageDetails)==null?void 0:c[t];return e.jsxs("div",{className:"p-2 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"text-xs font-medium text-green-800 mb-1",children:["Page ",t," (v",g.redoResults.newVersions[t]??"?",")"]}),s&&(s.previousImage||s.newImage)?e.jsxs("div",{className:"flex gap-2 items-end",children:[s.previousImage&&e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:s.previousImage.startsWith("data:")?s.previousImage:`data:image/jpeg;base64,${s.previousImage}`,className:"w-16 h-16 object-cover rounded cursor-pointer hover:ring-2 hover:ring-gray-400",onClick:()=>w(s.previousImage.startsWith("data:")?s.previousImage:`data:image/jpeg;base64,${s.previousImage}`)}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["Before",s.previousScore!=null?` (${s.previousScore})`:""]})]}),s.blackoutImage&&e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:s.blackoutImage.startsWith("data:")?s.blackoutImage:`data:image/jpeg;base64,${s.blackoutImage}`,className:"w-16 h-16 object-cover rounded cursor-pointer border-2 border-purple-300 hover:ring-2 hover:ring-purple-400",onClick:()=>w(s.blackoutImage.startsWith("data:")?s.blackoutImage:`data:image/jpeg;base64,${s.blackoutImage}`)}),e.jsx("span",{className:"text-[10px] text-purple-500",children:"Blackout"})]}),e.jsx("span",{className:"text-gray-400 self-center",children:"â†’"}),s.newImage&&e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:s.newImage.startsWith("data:")?s.newImage:`data:image/jpeg;base64,${s.newImage}`,className:"w-16 h-16 object-cover rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>w(s.newImage.startsWith("data:")?s.newImage:`data:image/jpeg;base64,${s.newImage}`)}),e.jsxs("span",{className:"text-[10px] text-green-600",children:["After",s.newScore!=null?` (${s.newScore})`:""]})]})]}):null]},t)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("re-evaluate"),B.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[g.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>ne(),disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(be,{className:"w-4 h-4"}),"Re-evaluate ",g.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>ne(I.map(t=>t.pageNumber)),disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(be,{className:"w-4 h-4"}),"Re-evaluate All ",I.length," Pages"]})]}),Object.keys(g.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(g.reEvaluationResults.pages).map(([t,s])=>{var v,T,J,ce,E;const c=s.score??s.qualityScore,p=s.qualityScore,u=s.semanticScore;return s.score===null&&s.qualityScore!==null&&console.warn(`[RepairWorkflow] Page ${t}: Missing combined score, using qualityScore fallback`),e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-medium",children:["Page ",t,":"]}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:["Quality: ",p,"%"]}),u!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",u,"%"]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${c>=70?"bg-green-100 text-green-700":c>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",c,"%"]}),s.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${s.verdict==="PASS"?"bg-green-100 text-green-700":s.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:s.verdict}),s.fixableIssues&&s.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",s.fixableIssues.length," fixable issues)"]})]}),s.issuesSummary&&s.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${s.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:s.issuesSummary}),s.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["ðŸ” Semantic Analysis (Score: ",s.semanticResult.score??"N/A","):"]}),s.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸ‘ï¸ Visible:"}),s.semanticResult.visible.characters&&s.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.visible.characters.join(", ")]}),s.semanticResult.visible.objects&&s.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.visible.objects.join(", ")]}),s.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.visible.setting]}),s.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸŽ¯ Expected:"}),((v=s.semanticResult.expected)==null?void 0:v.characters)&&s.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.expected.characters.join(", ")]}),((T=s.semanticResult.expected)==null?void 0:T.objects)&&s.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.expected.objects.join(", ")]}),((J=s.semanticResult.expected)==null?void 0:J.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.expected.setting]}),((ce=s.semanticResult.expected)==null?void 0:ce.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.expected.action]})]})]}),s.semanticResult.semanticIssues&&s.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:s.semanticResult.semanticIssues.map((O,Z)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${O.severity==="CRITICAL"?"text-red-600":O.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",O.severity,"]"]})," ",O.problem]},Z))}),((E=s.semanticResult.semanticIssues)==null?void 0:E.length)===0&&!s.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"âœ“ No issues"})]})]},t)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("consistency-check"),B.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["consistency-check"].description}),e.jsxs("button",{onClick:()=>le(),disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx($e,{className:"w-4 h-4"}),"Run Consistency Check"]}),g.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${g.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:g.consistencyResults.report.overallConsistent?"All characters consistent!":`${g.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:g.consistencyResults.report.summary})]}),Object.entries(g.consistencyResults.report.characters||{}).map(([t,s])=>{var c,p;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${s.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:t}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${s.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",s.overallScore??s.score??"?","/10",(s.totalIssues??((c=s.issues)==null?void 0:c.length)??0)>0&&` â€¢ ${s.totalIssues??((p=s.issues)==null?void 0:p.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[s.byClothing&&Object.entries(s.byClothing).map(([u,v])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:u}),e.jsxs("span",{className:`text-xs ${v.score>=7?"text-green-600":"text-amber-600"}`,children:[v.score,"/10"]})]}),v.gridImage&&e.jsx("div",{className:"mt-2 mb-2",children:e.jsx("img",{src:v.gridImage,alt:`${t} - ${u} consistency grid`,className:"w-full max-h-48 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(v.gridImage),title:"Click to enlarge"})}),v.issues&&v.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:v.issues.map((T,J)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${T.severity==="critical"?"bg-red-400":T.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[T.description,T.pagesToFix&&T.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",T.pagesToFix.join(", "),")"]})]})]},J))})]},u)),!s.byClothing&&e.jsxs(e.Fragment,{children:[s.gridImage&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:s.gridImage,alt:`${t} consistency grid`,className:"w-full max-h-48 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(s.gridImage),title:"Click to enlarge"})}),s.issues&&s.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:s.issues.map((u,v)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${u.severity==="critical"?"bg-red-400":u.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:u.description})]},v))})]}),(!s.byClothing||Object.values(s.byClothing).every(u=>{var v;return!((v=u.issues)!=null&&v.length)}))&&(!s.issues||s.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},t)}),A.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:A.map(t=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:t},t))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("character-repair"),B.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:S,onChange:t=>{k(t.target.value),G([])},className:"w-full p-2 border rounded text-sm",disabled:C,children:[e.jsx("option",{value:"",children:"Choose a character..."}),A.map(t=>e.jsxs("option",{value:t,children:[t," (has issues)"]},t)),re.filter(t=>!A.includes(t.name)).map(t=>e.jsx("option",{value:t.name,children:t.name},t.name))]})]}),S&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const t=ke(S);G(t)},disabled:C||g.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(ge,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:I.map(t=>e.jsxs("button",{onClick:()=>{G(s=>s.includes(t.pageNumber)?s.filter(c=>c!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${q.includes(t.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:C,children:["Page ",t.pageNumber]},t.pageNumber))})]}),Q&&te&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("label",{className:"text-sm font-medium text-blue-800 mb-2 block",children:"Repair Method:"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:!_,onChange:()=>te(!1),className:"text-blue-600",disabled:C}),e.jsx("span",{className:"text-sm",children:"Gemini (default)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:_,onChange:()=>te(!0),className:"text-blue-600",disabled:C}),e.jsx("span",{className:"text-sm",children:"MagicAPI Face+Hair"}),e.jsx("span",{className:"text-xs text-blue-600",children:"(~$0.006/repair)"})]})]}),_&&e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Uses face swap + hair fix pipeline with iterative crop checking"})]}),e.jsxs("button",{onClick:async()=>{await oe(S,q,{useMagicApiRepair:_}),b&&await b()},disabled:C||!S||q.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Repair ",S||"Character"," on ",q.length," pages",_&&e.jsx("span",{className:"text-xs opacity-75",children:"(MagicAPI)"})]}),Object.keys(g.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800",children:"Repair Results:"}),Object.entries(g.characterRepairResults.pagesRepaired).map(([t,s])=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-sm font-medium",children:t}),s.map(c=>{var p;return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-green-800",children:["Page ",c.pageNumber]}),c.method&&e.jsx("span",{className:`px-1.5 py-0.5 text-xs rounded font-medium ${c.method==="magicapi"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700"}`,children:c.method==="magicapi"?"MagicAPI":"Gemini"}),c.verification&&e.jsxs("span",{className:`px-1.5 py-0.5 text-xs rounded ${c.verification.confidence==="high"?"bg-green-100 text-green-700":c.verification.confidence==="medium"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:[c.verification.confidence," confidence"]})]}),c.comparison&&e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:c.comparison.reference,alt:"Reference avatar",className:"w-full h-24 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(c.comparison.reference)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Reference"})]}),e.jsxs("div",{className:"text-center",children:[c.comparison.before?e.jsx("img",{src:c.comparison.before,alt:"Before repair",className:"w-full h-24 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(c.comparison.before)}):e.jsx("div",{className:"w-full h-24 flex items-center justify-center rounded border border-gray-200 bg-gray-50 text-xs text-gray-400",children:"N/A"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Before"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:c.comparison.after,alt:"After repair",className:"w-full h-24 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(c.comparison.after)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"After"})]})]}),((p=c.verification)==null?void 0:p.explanation)&&e.jsx("p",{className:"text-xs text-gray-600 italic",children:c.verification.explanation})]},c.pageNumber)})]},t))]}),Object.keys(g.characterRepairResults.pagesFailed).length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h5",{className:"text-sm font-medium text-red-800",children:"Failed/Rejected:"}),Object.entries(g.characterRepairResults.pagesFailed).map(([t,s])=>s.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-sm font-medium",children:t}),s.map(c=>e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-red-800",children:["Page ",c.pageNumber]}),c.rejected&&e.jsx("span",{className:"px-1.5 py-0.5 text-xs rounded bg-red-100 text-red-700 font-medium",children:"Rejected"})]}),e.jsx("p",{className:"text-xs text-red-700 mb-2",children:c.reason}),c.comparison&&e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:c.comparison.reference,alt:"Reference avatar",className:"w-full h-24 object-contain rounded border border-red-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(c.comparison.reference)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Reference"})]}),e.jsxs("div",{className:"text-center",children:[c.comparison.before?e.jsx("img",{src:c.comparison.before,alt:"Before repair",className:"w-full h-24 object-contain rounded border border-red-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(c.comparison.before)}):e.jsx("div",{className:"w-full h-24 flex items-center justify-center rounded border border-red-200 bg-gray-50 text-xs text-gray-400",children:"N/A"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Before"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:c.comparison.after,alt:"After (rejected)",className:"w-full h-24 object-contain rounded border border-red-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>w(c.comparison.after)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"After (rejected)"})]})]})]},c.pageNumber))]},t))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("artifact-repair"),B.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>M(N),disabled:C||N.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(ge,{className:"w-3 h-3"}),"Auto-Identify (",N.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:N.length>0?N.map(t=>e.jsxs("button",{onClick:()=>{M(s=>s.includes(t)?s.filter(c=>c!==t):[...s,t])},className:`px-2 py-1 text-xs rounded border transition-colors ${f.includes(t)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:C,children:["Page ",t]},t)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),N.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),I.map(t=>e.jsxs("button",{onClick:()=>{M(s=>s.includes(t.pageNumber)?s.filter(c=>c!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${f.includes(t.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:C,children:["Page ",t.pageNumber]},t.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await ve(f),b&&await b()},disabled:C||f.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(De,{className:"w-4 h-4"}),"Run Grid Repair on ",f.length," pages"]}),g.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",g.artifactRepairResults.pagesProcessed.length," pages, fixed ",g.artifactRepairResults.issuesFixed," issues"]})})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[i("cover-repair"),B.has("cover-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:ee["cover-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Covers to Regenerate:"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:["front","initial","back"].map(t=>{const s={front:"Front Cover",initial:"Dedication Page",back:"Back Cover"};return e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:j.includes(t),onChange:c=>{H(p=>c.target.checked?[...p,t]:p.filter(u=>u!==t))},disabled:C,className:"rounded text-amber-600"}),e.jsx("span",{className:"text-sm",children:s[t]})]},t)})})]}),e.jsxs("button",{onClick:async()=>{await de(j),b&&await b()},disabled:C||j.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(We,{className:"w-4 h-4"}),"Regenerate ",j.length," Cover",j.length!==1?"s":""]}),K.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",K.current," / ",K.total]}),K.currentCover&&e.jsxs("span",{className:"text-gray-500",children:["Currently: ",K.currentCover," cover"]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${K.current/K.total*100}%`}})})]}),g.stepStatus["cover-repair"]==="completed"&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("h5",{className:"text-sm font-medium text-green-800",children:"Covers regenerated successfully"})})]})]})]})]}),$&&e.jsx(_e,{src:$,alt:"Consistency Grid",onClose:()=>w(null)})]}):null}export{ns as RepairWorkflowPanel,ns as default};
