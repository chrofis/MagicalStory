import{c as E,u as Y,a as Z,d as J,j as e,e as I,I as R,T as X,b as Q}from"./index-JCEpcYjQ.js";import{u as ee,e as se,b as c}from"./vendor-react-CHhk3aw2.js";import{N as w,s as $}from"./Textarea-CQW1Blgg.js";import{a as te}from"./api-CayhoXoh.js";import{g as N,B as P,M as re}from"./Pricing-BnzI581S.js";import{A as oe}from"./arrow-left-DuMio4wt.js";import{S as ie}from"./shopping-cart-2FSfaxlZ.js";import{P as ae}from"./printer-CdI-pbI3.js";import"./vendor-firebase-DTVMaYMy.js";import"./check-N-dGhtrf.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=E("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=E("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),x=Q("BookBuilder");function ye(){const p=ee(),S=se(),{language:d}=Y(),{isAuthenticated:b,user:v,isLoading:y}=Z(),{showToast:k}=J(),U=(v==null?void 0:v.role)==="admin",[i,D]=c.useState([]),[H,F]=c.useState(!0),[m,z]=c.useState("softcover"),[C,T]=c.useState(!1),[B,M]=c.useState(!1),[f,V]=c.useState(void 0);c.useEffect(()=>{async function s(){try{const r=await $.getPricing();V(r.tiers)}catch(r){console.error("Failed to fetch pricing:",r)}}s()},[]);const O={en:{title:"Create Your Book",subtitle:"Arrange your stories and choose your cover type",noStories:"No stories selected",noStoriesDesc:"Please go back and select stories to combine.",backToStories:"Back to My Stories",storyOrder:"Story Order",storyOrderHint:"Drag stories to reorder. The first story's cover will be used as the book cover.",coverNote:"The cover from the first story will be used as your book cover.",moveUp:"Move up",moveDown:"Move down",pages:"pages",totalPages:"Total Pages",chooseFormat:"Choose Format",softcover:"Softcover",hardcover:"Hardcover",softcoverSize:"20 × 20 cm",hardcoverSize:"20 × 20 cm",price:"Price",includesShipping:"Includes shipping & taxes (Switzerland)",shippingTime:"Delivery in approx. 2 weeks",creditsRefund:"All credits used to generate the stories will be refunded",orderBook:"Order Book",tooManyPages:"Too many pages",tooManyPagesDesc:"Maximum is 100 pages. Please remove some stories.",tooFewPages:"Few pages selected",tooFewPagesDesc:s=>`You have selected stories with only ${s} pages. The minimum book length is 30 pages, so there will be empty pages. Consider adding another story to your book.`,processing:"Processing...",printPdf:"Print PDF (Test)",generatingPdf:"Generating PDF..."},de:{title:"Erstelle dein Buch",subtitle:"Wähle die Reihenfolge der Geschichten und das Buchformat",noStories:"Keine Geschichten ausgewählt",noStoriesDesc:"Bitte geh zurück und wähle Geschichten zum Kombinieren aus.",backToStories:"Zurück zu meinen Geschichten",storyOrder:"Reihenfolge der Geschichten",storyOrderHint:"Verschiebe Geschichten, um die Reihenfolge zu ändern. Das Titelbild der ersten Geschichte wird als Titelbild vom Buch verwendet.",coverNote:"Das Titelbild der ersten Geschichte wird als Titelbild vom Buch verwendet.",moveUp:"Nach oben",moveDown:"Nach unten",pages:"Seiten",totalPages:"Seiten insgesamt",chooseFormat:"Format wählen",softcover:"Softcover",hardcover:"Hardcover",softcoverSize:"20 × 20 cm",hardcoverSize:"20 × 20 cm",price:"Preis",includesShipping:"Inkl. Versand & Steuern (Schweiz)",shippingTime:"Lieferung in ca. 2 Wochen",creditsRefund:"Alle Credits für die Geschichten werden zurückerstattet",orderBook:"Buch bestellen",tooManyPages:"Zu viele Seiten",tooManyPagesDesc:"Maximal 100 Seiten erlaubt. Bitte entferne einige Geschichten.",tooFewPages:"Wenige Seiten ausgewählt",tooFewPagesDesc:s=>`Du hast Geschichten mit nur ${s} Seiten ausgewählt. Die Mindestbuchlänge beträgt 30 Seiten, es wird also leere Seiten geben. Erwäge, eine weitere Geschichte hinzuzufügen.`,processing:"Wird verarbeitet...",printPdf:"Druck-PDF (Test)",generatingPdf:"PDF wird erstellt..."},fr:{title:"Créer votre livre",subtitle:"Arrangez vos histoires et choisissez votre type de couverture",noStories:"Aucune histoire sélectionnée",noStoriesDesc:"Veuillez retourner et sélectionner des histoires à combiner.",backToStories:"Retour à Mes histoires",storyOrder:"Ordre des histoires",storyOrderHint:"Déplacez les histoires pour les réorganiser. La couverture de la première histoire sera utilisée comme couverture du livre.",coverNote:"La couverture de la première histoire sera utilisée comme couverture du livre.",moveUp:"Monter",moveDown:"Descendre",pages:"pages",totalPages:"Pages totales",chooseFormat:"Choisir le format",softcover:"Couverture souple",hardcover:"Couverture rigide",softcoverSize:"20 × 20 cm",hardcoverSize:"20 × 20 cm",price:"Prix",includesShipping:"Livraison & taxes incluses (Suisse)",shippingTime:"Livraison en env. 2 semaines",creditsRefund:"Tous les crédits utilisés pour les histoires seront remboursés",orderBook:"Commander le livre",tooManyPages:"Trop de pages",tooManyPagesDesc:"Maximum 100 pages. Veuillez retirer quelques histoires.",tooFewPages:"Peu de pages sélectionnées",tooFewPagesDesc:s=>`Vous avez sélectionné des histoires avec seulement ${s} pages. La longueur minimale du livre est de 30 pages, il y aura donc des pages vides. Pensez à ajouter une autre histoire.`,processing:"Traitement en cours...",printPdf:"PDF impression (Test)",generatingPdf:"Génération du PDF..."}},t=O[d]||O.en;c.useEffect(()=>{if(y)return;if(!b){p("/");return}const s=S.state;s!=null&&s.selectedStories&&s.selectedStories.length>0&&D(s.selectedStories),F(!1)},[b,y,p,S.state]);const a=c.useMemo(()=>i.reduce((s,r)=>s+r.pages,0),[i]),j=c.useMemo(()=>N(a,m==="hardcover",f),[a,m,f]),n=a>re,_=a>0&&a<30,L=(s,r)=>{const o=[...i],l=r==="up"?s-1:s+1;l<0||l>=i.length||([o[s],o[l]]=[o[l],o[s]],D(o))},K=async()=>{if(!(n||!j)){T(!0);try{const s=i.map(o=>o.id);x.info("Creating combined book checkout:",{storyIds:s,coverType:m,totalPages:a});const{url:r}=await $.createCheckoutSession(s,m);window.location.href=r}catch(s){x.error("Checkout failed:",s),k({message:d==="de"?"Checkout fehlgeschlagen. Bitte versuche es erneut.":d==="fr"?"Échec du paiement. Veuillez réessayer.":"Checkout failed. Please try again.",variant:"error"})}finally{T(!1)}}},q=async()=>{var s,r;if(i.length!==0){M(!0);try{const o=i.map(u=>u.id);x.info("Downloading print PDF for stories:",o);const l=localStorage.getItem("auth_token"),g=await fetch("/api/generate-book-pdf",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({storyIds:o})});if(!g.ok){let u=`HTTP ${g.status}`;try{const G=await g.json();u=G.details||G.error||u}catch{}throw new Error(u)}const W=await g.blob(),A=window.URL.createObjectURL(W),h=document.createElement("a");h.href=A,h.download=((r=(s=g.headers.get("Content-Disposition"))==null?void 0:s.split("filename=")[1])==null?void 0:r.replace(/"/g,""))||"story-print.pdf",document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(A),x.info("Print PDF downloaded successfully")}catch(o){x.error("Failed to download print PDF:",o);const l=o instanceof Error?o.message:"Unknown error";k({message:d==="de"?`PDF konnte nicht heruntergeladen werden: ${l}`:d==="fr"?`Impossible de télécharger le PDF: ${l}`:`Failed to download PDF: ${l}`,variant:"error"})}finally{M(!1)}}};return y||!b?e.jsx(I,{fullScreen:!0}):H?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(w,{currentStep:0}),e.jsx(I,{message:d==="de"?"Laden...":d==="fr"?"Chargement...":"Loading..."})]}):i.length===0?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(w,{currentStep:0}),e.jsx("div",{className:"px-4 md:px-8 py-8 max-w-4xl mx-auto",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(P,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:t.noStories}),e.jsx("p",{className:"text-gray-500 mb-6",children:t.noStoriesDesc}),e.jsx("button",{onClick:()=>p("/stories"),className:"px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:t.backToStories})]})})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(w,{currentStep:0}),e.jsxs("div",{className:"px-4 md:px-8 py-8 max-w-4xl mx-auto",children:[e.jsxs("button",{onClick:()=>p("/stories"),className:"flex items-center gap-2 text-gray-600 hover:text-indigo-600 mb-6 transition-colors",children:[e.jsx(oe,{size:20}),t.backToStories]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 mb-2",children:t.title}),e.jsx("p",{className:"text-gray-600",children:t.subtitle})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-3",children:t.storyOrder}),e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 flex items-start gap-2",children:[e.jsx(R,{size:18,className:"text-amber-600 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-amber-800",children:t.coverNote})]}),e.jsx("div",{className:"space-y-3",children:i.map((s,r)=>e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 flex items-center gap-4",children:[s.thumbnail?e.jsx("img",{src:s.thumbnail,alt:s.title,className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center",children:e.jsx(P,{size:24,className:"text-indigo-300"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-gray-800 truncate",children:s.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:[s.pages," ",t.pages]}),r===0&&e.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full font-medium",children:d==="de"?"Titelbild":d==="fr"?"Couverture":"Cover"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("button",{onClick:()=>L(r,"up"),disabled:r===0,className:"p-1.5 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed",title:t.moveUp,children:e.jsx(le,{size:18,className:"text-gray-600"})}),e.jsx("button",{onClick:()=>L(r,"down"),disabled:r===i.length-1,className:"p-1.5 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed",title:t.moveDown,children:e.jsx(ne,{size:18,className:"text-gray-600"})})]})]},s.id))}),e.jsxs("div",{className:`mt-4 p-4 rounded-xl ${n?"bg-red-50 border-2 border-red-300":"bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`font-semibold ${n?"text-red-700":"text-gray-700"}`,children:t.totalPages}),e.jsx("span",{className:`text-2xl font-bold ${n?"text-red-700":"text-gray-800"}`,children:a})]}),n&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-red-700",children:[e.jsx(X,{size:16}),e.jsx("span",{className:"text-sm",children:t.tooManyPagesDesc})]}),_&&!n&&e.jsx("div",{className:"mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2 text-amber-700",children:[e.jsx(R,{size:18,className:"flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-sm",children:t.tooFewPages}),e.jsx("span",{className:"text-sm",children:t.tooFewPagesDesc(a)})]})]})})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-3",children:t.chooseFormat}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx("button",{onClick:()=>z("softcover"),className:`w-full p-4 rounded-xl border-2 text-left transition-all ${m==="softcover"?"border-indigo-600 bg-indigo-50":"border-gray-200 hover:border-indigo-300"}`,children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(P,{size:32,className:m==="softcover"?"text-indigo-600":"text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-gray-800",children:t.softcover}),e.jsx("div",{className:"text-sm text-gray-500",children:t.softcoverSize})]}),!n&&e.jsxs("div",{className:"text-xl font-bold text-gray-800",children:["CHF ",N(a,!1,f),".-"]})]})}),e.jsx("button",{onClick:()=>z("hardcover"),className:`w-full p-4 rounded-xl border-2 text-left transition-all ${m==="hardcover"?"border-indigo-600 bg-indigo-50":"border-gray-200 hover:border-indigo-300"}`,children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(te,{size:32,className:m==="hardcover"?"text-indigo-600":"text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-gray-800",children:t.hardcover}),e.jsx("div",{className:"text-sm text-gray-500",children:t.hardcoverSize})]}),!n&&e.jsxs("div",{className:"text-xl font-bold text-indigo-700",children:["CHF ",N(a,!0,f),".-"]})]})})]}),!n&&j&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-gray-700",children:t.price}),e.jsxs("span",{className:"text-3xl font-bold text-indigo-700",children:["CHF ",j,".-"]})]}),e.jsx("p",{className:"text-sm text-gray-500",children:t.includesShipping}),e.jsx("p",{className:"text-sm text-gray-500",children:t.shippingTime}),e.jsx("p",{className:"text-sm text-green-600 mt-2 font-medium",children:t.creditsRefund})]}),e.jsx("button",{onClick:K,disabled:n||C,className:"w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"}),t.processing]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:22}),t.orderBook]})}),U&&e.jsx("button",{onClick:q,disabled:B||i.length===0,className:"w-full mt-3 py-3 bg-purple-100 text-purple-700 border-2 border-purple-300 rounded-xl font-semibold hover:bg-purple-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-purple-700 border-t-transparent"}),t.generatingPdf]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{size:20}),t.printPdf]})})]})]})]})]})}export{ye as default};
