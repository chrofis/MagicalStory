import{c as se,u as re,a as ae,d as ie,b as ne,j as e,e as q,T as K,E as oe}from"./index-DMhOpvgv.js";import{u as le,d as ce,b as n}from"./vendor-react-CHhk3aw2.js";import{s as $,N as de}from"./Textarea-DABqE2ws.js";import{a as D}from"./api-DH6woWwe.js";import{B as G,M as me}from"./Pricing-B5dOIgyi.js";import{T as ge}from"./trash-2-C6wJtW-l.js";import"./vendor-firebase-DTVMaYMy.js";import"./arrow-left-DxnRjAQy.js";import"./check-CtVazsFe.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=se("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),x=ne("MyStories");let u={data:null,total:0,timestamp:0};const he=300*1e3,xe=6,J=18;function fe({story:s,language:m,onView:P,onDelete:r,formatDate:j,isSelected:b,onToggleSelect:T,onLoadCover:k,t:d}){const[f,C]=n.useState(!1),[S,w]=n.useState(!1),[y,A]=n.useState(!1),[L,_]=n.useState(!1),v=n.useRef(null);return n.useEffect(()=>{const h=new IntersectionObserver(([M])=>{M.isIntersecting&&(A(!0),h.disconnect())},{rootMargin:"100px"});return v.current&&h.observe(v.current),()=>h.disconnect()},[]),n.useEffect(()=>{y&&s.hasThumbnail&&!s.thumbnail&&!L&&(_(!0),k(s.id))},[y,s.hasThumbnail,s.thumbnail,s.id,L,k]),e.jsxs("div",{ref:v,className:`bg-white rounded-xl shadow-md overflow-hidden transition-all flex flex-col hover:shadow-lg ${s.isPartial?"ring-2 ring-amber-400":""} ${b?"ring-8 ring-green-500":""}`,children:[e.jsxs("div",{className:"relative",children:[y&&s.thumbnail&&!S?e.jsxs("div",{className:"relative w-full h-48 bg-gray-100",children:[!f&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 spinner"})}),e.jsx("img",{src:s.thumbnail,alt:s.title,className:`w-full h-48 object-cover transition-opacity duration-300 ${f?"opacity-100":"opacity-0"}`,onLoad:()=>C(!0),onError:()=>w(!0)})]}):!y||s.hasThumbnail&&!s.thumbnail&&!S?e.jsx("div",{className:"relative w-full h-48 bg-gray-100 flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 spinner"})}):e.jsx("div",{className:"relative w-full h-48 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center",children:e.jsx(G,{className:"w-12 h-12 text-indigo-300"})}),s.isPartial&&e.jsxs("div",{className:"absolute top-2 left-2 bg-amber-500 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1",children:[e.jsx(K,{size:12}),m==="de"?"Teilweise":m==="fr"?"Partiel":"Partial"]}),e.jsx("button",{onClick:h=>{h.stopPropagation(),r()},className:"absolute top-2 right-2 p-2 bg-white/90 text-red-600 hover:bg-red-100 rounded-lg shadow-sm",children:e.jsx(ge,{size:16})})]}),e.jsxs("div",{className:"p-4 flex flex-col flex-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:s.title}),s.isPartial?e.jsxs("p",{className:"text-sm text-amber-600 mb-3",children:[s.generatedPages||0,"/",s.totalPages||s.pages," ",m==="de"?"Seiten generiert":m==="fr"?"pages générées":"pages generated"," • ",j(s.created_at||s.createdAt)]}):e.jsxs("p",{className:"text-sm text-gray-500 mb-3",children:[s.pageCount||s.pages," ",m==="de"?"Seiten":"pages"," • ",j(s.created_at||s.createdAt)]})]}),e.jsxs("div",{className:"flex gap-2 mt-auto",children:[e.jsxs("button",{onClick:h=>{h.stopPropagation(),P()},className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",children:[e.jsx(oe,{size:18}),m==="de"?"Ansehen":m==="fr"?"Voir":"View"]}),!s.isPartial&&e.jsx("button",{onClick:h=>{h.stopPropagation(),T()},className:`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${b?"bg-red-600 text-white hover:bg-red-700":"bg-green-600 text-white hover:bg-green-700"}`,children:b?d.remove:d.add})]})]})]})}function Ce(){const s=le(),[m,P]=ce(),{language:r}=re(),{isAuthenticated:j,isLoading:b}=ae(),{showSuccess:T,showInfo:k}=ie(),[d,f]=n.useState([]),[C,S]=n.useState(!0),[w,y]=n.useState(!1),[A,L]=n.useState(!1),[_,v]=n.useState(0),[h,M]=n.useState(null),B=n.useRef(!1),[g,R]=n.useState(()=>{try{const t=sessionStorage.getItem("mystories_selected");if(t)return new Set(JSON.parse(t))}catch{}return new Set});n.useEffect(()=>{sessionStorage.setItem("mystories_selected",JSON.stringify([...g]))},[g]),n.useEffect(()=>{(async()=>{const a=m.get("payment"),i=m.get("session_id");if(a==="success"&&i){x.info("Payment successful! Checking order status...");try{const l=await $.getOrderStatus(i);if(x.info("Order Status:",l),l.order){R(new Set),sessionStorage.removeItem("mystories_selected");const V=`CHF ${(l.order.amount_total/100).toFixed(2)}`,E={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement réussi!"},p={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a été reçue et sera bientôt imprimée."},z=[`${r==="de"?"Kunde":r==="fr"?"Client":"Customer"}: ${l.order.customer_name}`,`Email: ${l.order.customer_email}`,`${r==="de"?"Betrag":r==="fr"?"Montant":"Amount"}: ${V}`,`${r==="de"?"Versand an":r==="fr"?"Expédié à":"Shipping to"}: ${l.order.shipping_name}`,`${l.order.shipping_address_line1}`,`${l.order.shipping_postal_code} ${l.order.shipping_city}`,`${l.order.shipping_country}`];T(p[r]||p.en,E[r]||E.en,z)}}catch(l){x.error("Error checking order status:",l)}const o=new URLSearchParams(m);o.delete("payment"),o.delete("session_id"),P(o,{replace:!0})}else if(a==="cancelled"){x.info("Payment cancelled by user");const o={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie können es erneut versuchen.",fr:"Paiement annulé. Vous pouvez réessayer quand vous êtes prêt."};k(o[r]||o.en,r==="de"?"Abgebrochen":r==="fr"?"Annulé":"Cancelled");const l=new URLSearchParams(m);l.delete("payment"),P(l,{replace:!0})}})()},[m,P,r,T,k]);const H={en:{myStories:"My Stories",createStory:"Create Story",noStories:"No stories created yet",seePricing:"See Pricing",selectHint:"Select stories to create a book",selected:"selected",pages:"pages",createBook:"Create Book",tooManyPages:"Too many pages (max 100)",add:"Add",remove:"Remove",loadAll:"Load All"},de:{myStories:"Meine Geschichten",createStory:"Geschichte erstellen",noStories:"Noch keine Geschichten erstellt",seePricing:"Preise ansehen",selectHint:"Wähle Geschichten, um ein Buch zu erstellen",selected:"ausgewählt",pages:"Seiten",createBook:"Buch erstellen",tooManyPages:"Zu viele Seiten (max. 100)",add:"Hinzufügen",remove:"Entfernen",loadAll:"Alle laden"},fr:{myStories:"Mes histoires",createStory:"Créer une histoire",noStories:"Aucune histoire créée",seePricing:"Voir les tarifs",selectHint:"Sélectionnez des histoires pour créer un livre",selected:"sélectionné(s)",pages:"pages",createBook:"Créer le livre",tooManyPages:"Trop de pages (max 100)",add:"Ajouter",remove:"Retirer",loadAll:"Tout charger"}},c=H[r]||H.en;n.useEffect(()=>{if(b)return;if(!j){s("/");return}if(B.current)return;B.current=!0;const t=setTimeout(()=>{I()},50);return()=>clearTimeout(t)},[j,b,s]);const I=async(t={})=>{const{loadMore:a=!1,loadAll:i=!1}=t;x.debug("Loading stories...",{loadMore:a,loadAll:i});try{M(null);const o=Date.now();if(!a&&!i&&u.data&&o-u.timestamp<he){x.debug("Using cached stories"),f(u.data),v(u.total),L(u.data.length<u.total),S(!1);return}a||i?y(!0):S(!0);const l=a||i?d.length:0,V=i?1e3:xe,{stories:E,pagination:p}=await $.getStories({limit:V,offset:l});x.info("Loaded stories:",E.length,"total:",p.total);const z=E;a||i?f(te=>{const Z=[...te,...z];return u={data:Z,total:p.total,timestamp:o},Z}):(f(z),u={data:z,total:p.total,timestamp:o}),v(p.total),L(p.hasMore)}catch(o){x.error("Failed to load stories:",o),M(r==="de"?"Geschichten konnten nicht geladen werden":r==="fr"?"Impossible de charger les histoires":"Failed to load stories"),u={data:null,total:0,timestamp:0}}finally{S(!1),y(!1)}};n.useEffect(()=>{!C&&!w&&A&&d.length<J&&d.length>0&&I({loadMore:!0})},[d.length,A,C,w]);const Y=n.useCallback(async t=>{try{const a=await $.getStoryCover(t);a&&(f(i=>i.map(o=>o.id===t?{...o,thumbnail:a}:o)),u.data&&(u.data=u.data.map(i=>i.id===t?{...i,thumbnail:a}:i)))}catch(a){x.error("Failed to load cover for story:",t,a)}},[]),W=async t=>{if(confirm(r==="de"?"Diese Geschichte wirklich löschen?":r==="fr"?"Voulez-vous vraiment supprimer cette histoire?":"Are you sure you want to delete this story?"))try{await $.deleteStory(t);const i=d.filter(o=>o.id!==t);f(i),v(o=>Math.max(0,o-1)),u={data:i,total:Math.max(0,_-1),timestamp:Date.now()},R(o=>{const l=new Set(o);return l.delete(t),l})}catch(i){x.error("Failed to delete story:",i),alert(r==="de"?"Geschichte konnte nicht gelöscht werden. Bitte versuche es erneut.":r==="fr"?"Impossible de supprimer l'histoire. Veuillez réessayer.":"Failed to delete story. Please try again.")}},X=n.useCallback(t=>{if(!t)return"";try{return new Date(t).toLocaleDateString(r==="de"?"de-DE":r==="fr"?"fr-FR":"en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return""}},[r]),Q=t=>{R(a=>{const i=new Set(a);return i.has(t)?i.delete(t):i.add(t),i})},O=n.useMemo(()=>d.filter(t=>g.has(t.id)),[d,g]),F=n.useMemo(()=>O.reduce((t,a)=>t+(a.pageCount||a.pages),0),[O]),N=F>me,U=()=>{const t=O.map(a=>({id:a.id,title:a.title,pages:a.pageCount||a.pages,thumbnail:a.thumbnail}));s("/book-builder",{state:{selectedStories:t}})};if(b||!j)return e.jsx(q,{fullScreen:!0});const ee=d.filter(t=>!t.isPartial).length>=1;return e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-24",children:[e.jsx(de,{currentStep:0}),e.jsxs("div",{className:"px-4 md:px-8 py-8 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(G,{size:28}),c.myStories]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("button",{onClick:()=>s("/pricing"),className:"flex items-center gap-2 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 font-medium transition-colors",children:[e.jsx(ue,{size:18}),c.seePricing]}),ee&&e.jsxs("button",{onClick:U,disabled:g.size===0||N,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(D,{size:18}),c.createBook,g.size>0&&e.jsx("span",{className:"bg-white text-indigo-600 text-xs px-2 py-0.5 rounded-full",children:g.size})]}),e.jsx("button",{onClick:()=>s("/create"),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors",children:c.createStory})]})]}),d.length>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6 flex items-center gap-3",children:[e.jsx(D,{size:20,className:"text-blue-600 flex-shrink-0"}),e.jsx("p",{className:"text-blue-800 text-sm",children:c.selectHint}),g.size>0&&e.jsxs("span",{className:`ml-auto text-sm font-medium ${N?"text-red-600":"text-blue-600"}`,children:[g.size," ",c.selected," • ",F," ",c.pages,N&&` (${c.tooManyPages})`]})]}),C?e.jsx(q,{message:r==="de"?"Laden...":r==="fr"?"Chargement...":"Loading..."}):h?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(K,{className:"w-16 h-16 text-amber-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700 text-lg mb-4",children:h}),e.jsx("button",{onClick:()=>{B.current=!1,M(null),S(!0),I()},className:"px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:r==="de"?"Erneut versuchen":r==="fr"?"Réessayer":"Try Again"})]}):d.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(G,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg",children:c.noStories}),e.jsx("button",{onClick:()=>s("/create"),className:"mt-4 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700",children:c.createStory})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:d.map(t=>e.jsx(fe,{story:t,language:r,onView:()=>s(`/create?storyId=${t.id}`),onDelete:()=>W(t.id),formatDate:X,isSelected:g.has(t.id),onToggleSelect:()=>Q(t.id),onLoadCover:Y,t:{add:c.add,remove:c.remove}},t.id))}),A&&d.length>=J&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx("button",{onClick:()=>I({loadAll:!0}),disabled:w,className:"flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors disabled:opacity-50",children:w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 spinner"}),r==="de"?"Laden...":r==="fr"?"Chargement...":"Loading..."]}):e.jsxs(e.Fragment,{children:[c.loadAll," (",_-d.length," ",r==="de"?"weitere":r==="fr"?"autres":"more",")"]})})})]}),g.size>0&&e.jsx("div",{className:"h-24"})]}),g.size>0&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[g.size," ",c.selected," • ",F," ",c.pages]}),N&&e.jsxs("span",{className:"text-red-600 font-medium",children:["(",c.tooManyPages,")"]})]}),e.jsxs("button",{onClick:U,disabled:N,className:`flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-colors ${N?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:[e.jsx(D,{size:20}),c.createBook]})]})})]})}export{Ce as default};
