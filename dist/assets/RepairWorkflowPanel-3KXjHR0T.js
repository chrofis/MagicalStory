import{c as re,s as U,j as e,L as de,C as pe,T as $e}from"./index-BVCRtpP5.js";import{b as x}from"./vendor-react-CqfXSjHo.js";import{W as ke}from"./wrench-kTmOhcZ1.js";import{R as Ae}from"./rotate-ccw-C3wsX7aO.js";import{C as ve}from"./chevron-down-BKJe_d-J.js";import{C as we}from"./chevron-right-DEj4Mx7q.js";import{S as Re}from"./square-D2N4erT5.js";import{S as Pe}from"./search-BcvdoEeu.js";import{C as Ie}from"./circle-x-aGpN1vg-.js";import{U as Se}from"./Input-imdCnLtY.js";import{R as Te}from"./Modal-CRsjutmr.js";import"./vendor-firebase-DTVMaYMy.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=re("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=re("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=re("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=re("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=re("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function Ce(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const oe=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair"];function Me({storyId:l,sceneImages:P,characters:B,finalChecksReport:A,imageModel:_,onImageUpdate:W}){const[h,O]=x.useState(Ce),[Q,G]=x.useState({current:0,total:0,currentPage:void 0}),m=x.useRef(null),[M,X]=x.useState(!1),K=x.useMemo(()=>Object.values(h.stepStatus).some(a=>a==="in-progress"),[h.stepStatus]),H=x.useMemo(()=>oe.indexOf(h.currentStep),[h.currentStep]),$=x.useCallback(a=>{O(r=>({...r,currentStep:a,stepStatus:{...r.stepStatus,[a]:"in-progress"}}))},[]),d=x.useCallback((a,r)=>{O(n=>({...n,stepStatus:{...n.stepStatus,[a]:"completed"},...a==="collect-feedback"&&r?{collectedFeedback:r}:{},...a==="re-evaluate"&&r?{reEvaluationResults:r}:{},...a==="consistency-check"&&r?{consistencyResults:r}:{}}))},[]),N=x.useCallback((a,r)=>{O(n=>({...n,stepStatus:{...n.stepStatus,[a]:"failed"}}))},[]),Y=x.useCallback(a=>{O(r=>({...r,stepStatus:{...r.stepStatus,[a]:"skipped"}}))},[]),ue=x.useCallback(()=>{O(Ce()),G({current:0,total:0,currentPage:void 0}),X(!1),m.current=null},[]),ge=x.useCallback(()=>{var a;console.log("[useRepairWorkflow] Aborting workflow"),(a=m.current)==null||a.abort(),X(!0)},[]),Z=x.useCallback(async()=>{var a,r,n,y,v;if(l){$("collect-feedback");try{const p={};let u=0;for(const c of P){const j={pageNumber:c.pageNumber,qualityScore:c.qualityScore,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},S=(a=c.retryHistory)==null?void 0:a.slice(-1)[0];if((r=S==null?void 0:S.postRepairEval)!=null&&r.fixableIssues?j.fixableIssues=S.postRepairEval.fixableIssues:(n=S==null?void 0:S.preRepairEval)!=null&&n.fixableIssues&&(j.fixableIssues=S.preRepairEval.fixableIssues),A!=null&&A.entity){for(const[D,k]of Object.entries(A.entity.characters||{})){const T=[];if(k.byClothing)for(const R of Object.values(k.byClothing))R.issues&&T.push(...R.issues);k.issues&&T.push(...k.issues);const L=T.filter(R=>{var I;return((I=R.pagesToFix)==null?void 0:I.includes(c.pageNumber))||R.pageNumber===c.pageNumber});for(const R of L)j.entityIssues.push({character:D,issue:R.description,severity:R.severity})}for(const[D,k]of Object.entries(A.entity.objects||{})){const T=[];if(k.byClothing)for(const R of Object.values(k.byClothing))R.issues&&T.push(...R.issues);k.issues&&T.push(...k.issues);const L=T.filter(R=>{var I;return((I=R.pagesToFix)==null?void 0:I.includes(c.pageNumber))||R.pageNumber===c.pageNumber});for(const R of L)j.objectIssues.push({object:D,issue:R.description,severity:R.severity})}}if(A!=null&&A.imageChecks)for(const D of A.imageChecks)for(const k of D.issues||[])(((y=k.pagesToFix)==null?void 0:y.includes(c.pageNumber))||((v=k.images)==null?void 0:v.includes(c.pageNumber)))&&j.semanticIssues.push({type:k.type,description:k.description,severity:k.severity,characterInvolved:k.characterInvolved,recommendation:k.recommendation});u+=j.fixableIssues.length+j.entityIssues.length+j.objectIssues.length+j.semanticIssues.length,p[c.pageNumber]=j}d("collect-feedback",{pages:p,totalIssues:u})}catch(p){console.error("Failed to collect feedback:",p),N("collect-feedback",p instanceof Error?p.message:"Unknown error")}}},[l,P,A,$,d,N]),me=x.useCallback((a,r)=>{O(n=>({...n,collectedFeedback:{...n.collectedFeedback,pages:{...n.collectedFeedback.pages,[a]:{...n.collectedFeedback.pages[a],...r}}}}))},[]),xe=x.useCallback((a,r)=>{O(n=>{const y=n.redoPages.pageNumbers.includes(a),v=y?n.redoPages.pageNumbers.filter(u=>u!==a):[...n.redoPages.pageNumbers,a].sort((u,c)=>u-c),p={...n.redoPages.reasons};return y?delete p[a]:r&&(p[a]=r),{...n,redoPages:{pageNumbers:v,reasons:p}}})},[]),J=x.useCallback((a=6,r=3)=>{$("identify-redo-pages");const n=[],y={};for(const[v,p]of Object.entries(h.collectedFeedback.pages)){const u=parseInt(v),c=p.fixableIssues.length+p.entityIssues.length,j=p.qualityScore??10;j<a?(n.push(u),y[u]=`Low quality score: ${j}`):c>=r?(n.push(u),y[u]=`Too many issues: ${c}`):p.needsFullRedo&&(n.push(u),y[u]="Manually marked for redo")}O(v=>({...v,redoPages:{pageNumbers:n.sort((p,u)=>p-u),reasons:y},stepStatus:{...v.stepStatus,"identify-redo-pages":"completed"}}))},[h.collectedFeedback.pages,$]),le=x.useCallback(async()=>{var y;if(!l||h.redoPages.pageNumbers.length===0)return;$("redo-pages");const a=h.redoPages.pageNumbers;G({current:0,total:a.length,currentPage:void 0});const r=[],n={};try{for(let v=0;v<a.length;v++){const p=a[v];G({current:v,total:a.length,currentPage:p});try{const u=await U.iteratePage(l,p,_);if(u.success){r.push(p);const c=P.find(S=>S.pageNumber===p),j=((y=c==null?void 0:c.imageVersions)==null?void 0:y.length)??0;n[p]=j,W&&W(p,u.imageData,j)}}catch(u){console.error(`Failed to redo page ${p}:`,u)}}O(v=>({...v,redoResults:{pagesCompleted:r,newVersions:n},stepStatus:{...v.stepStatus,"redo-pages":"completed"}})),G({current:a.length,total:a.length,currentPage:void 0})}catch(v){console.error("Redo pages failed:",v),N("redo-pages",v instanceof Error?v.message:"Unknown error")}},[l,h.redoPages.pageNumbers,_,P,W,$,N]),ee=x.useCallback(async a=>{if(!l)return;$("re-evaluate");const r=a??h.redoResults.pagesCompleted;if(r.length===0){Y("re-evaluate");return}try{const n=await U.reEvaluatePages(l,r),y={};for(const[v,p]of Object.entries(n.pages||{})){const u=p;y[parseInt(v)]={qualityScore:u.qualityScore,rawScore:u.rawScore,verdict:u.verdict,issuesSummary:u.issuesSummary,reasoning:u.reasoning,fixableIssues:u.fixableIssues}}d("re-evaluate",{pages:y})}catch(n){console.error("Re-evaluation failed:",n),N("re-evaluate",n instanceof Error?n.message:"Unknown error")}},[l,h.redoResults.pagesCompleted,$,d,N,Y]),ce=x.useCallback(async()=>{if(l){$("consistency-check");try{const a=await U.runEntityConsistency(l);d("consistency-check",{report:a.report})}catch(a){console.error("Consistency check failed:",a),N("consistency-check",a instanceof Error?a.message:"Unknown error")}}},[l,$,d,N]),se=x.useCallback(async(a,r,n)=>{var y,v;if(!(!l||r.length===0)){$("character-repair");try{const u=((v=(y=(await U.repairCharacters(l,[{character:a,pages:r}],n)).results)==null?void 0:y[0])==null?void 0:v.pagesRepaired)||[];for(const j of u)if(j.imageData&&W)try{W(j.pageNumber,j.imageData,j.versionIndex)}catch(S){console.error(`[RepairWorkflow] Failed to notify parent of image update for page ${j.pageNumber}:`,S)}const c=u.map(j=>typeof j=="number"?j:j.pageNumber);O(j=>({...j,characterRepairResults:{charactersProcessed:[...j.characterRepairResults.charactersProcessed,a],pagesRepaired:{...j.characterRepairResults.pagesRepaired,[a]:c}},stepStatus:{...j.stepStatus,"character-repair":"completed"}}))}catch(p){console.error("Character repair failed:",p),N("character-repair",p instanceof Error?p.message:"Unknown error")}}},[l,$,N,W]),te=x.useCallback(async a=>{if(!(!l||a.length===0)){$("artifact-repair");try{const r=await U.repairArtifacts(l,a);O(n=>({...n,artifactRepairResults:{pagesProcessed:r.pagesProcessed||a,issuesFixed:r.issuesFixed||0},stepStatus:{...n.stepStatus,"artifact-repair":"completed"}}))}catch(r){console.error("Artifact repair failed:",r),N("artifact-repair",r instanceof Error?r.message:"Unknown error")}}},[l,$,N]),he=x.useCallback(a=>{const r=oe.indexOf(a);if(a==="idle")return!0;if(K)return!1;switch(a){case"collect-feedback":return!0;case"identify-redo-pages":return h.stepStatus["collect-feedback"]==="completed";case"redo-pages":return h.redoPages.pageNumbers.length>0;case"re-evaluate":return h.stepStatus["redo-pages"]==="completed"||h.stepStatus["redo-pages"]==="skipped";case"consistency-check":return r>oe.indexOf("collect-feedback");case"character-repair":return h.stepStatus["consistency-check"]==="completed";case"artifact-repair":return h.stepStatus["collect-feedback"]==="completed";default:return!1}},[h,K]),be=x.useCallback(a=>{const r=oe.indexOf(a);return r>0?r:0},[]),fe=x.useCallback(()=>Object.entries(h.collectedFeedback.pages).filter(([a,r])=>{const n=r.qualityScore??10,y=r.fixableIssues.length+r.entityIssues.length;return n<7||y>0||r.needsFullRedo}).map(([a])=>parseInt(a)).sort((a,r)=>a-r),[h.collectedFeedback.pages]),ne=x.useCallback(()=>{const a=h.consistencyResults.report;return a!=null&&a.characters?Object.entries(a.characters).filter(([r,n])=>{var y;return"overallConsistent"in n?!n.overallConsistent||(n.totalIssues??0)>0:!n.consistent||(((y=n.issues)==null?void 0:y.length)??0)>0}).map(([r])=>r):[]},[h.consistencyResults.report]),ye=x.useCallback(a=>{var v;const r=h.consistencyResults.report;if(!((v=r==null?void 0:r.characters)!=null&&v[a]))return[];const n=r.characters[a],y=new Set;if(n.byClothing){for(const p of Object.values(n.byClothing))for(const u of p.issues||[])if(u.severity==="major"||u.severity==="critical"){for(const c of u.pagesToFix||[])y.add(c);u.pageNumber&&y.add(u.pageNumber)}}if(n.issues){for(const p of n.issues)if(p.severity==="major"||p.severity==="critical"){for(const u of p.pagesToFix||[])y.add(u);p.pageNumber&&y.add(p.pageNumber)}}return Array.from(y).sort((p,u)=>p-u)},[h.consistencyResults.report]),ae=x.useCallback(async(a={})=>{var D,k,T;if(!l)return;const r=6,n=3,y=4,{scoreThreshold:v=r,issueThreshold:p=n,maxRetries:u=y,onProgress:c}=a;m.current=new AbortController,X(!1);const j=m.current.signal,S=()=>{if(j.aborted)throw console.log("[useRepairWorkflow] Workflow aborted"),new Error("Workflow aborted")};try{S(),c==null||c("collect-feedback","Collecting existing issues..."),await Z(),S(),c==null||c("re-evaluate","Evaluating all pages...");const L=await U.reEvaluatePages(l,P.map(g=>g.pageNumber)),R={};for(const[g,i]of Object.entries(L.pages||{})){const o=i;R[parseInt(g)]=o}S(),c==null||c("identify-redo-pages","Identifying pages needing redo...");const I=[];for(const[g,i]of Object.entries(R)){const o=parseInt(g),w=i.rawScore??Math.round(i.qualityScore/10);w>10&&console.error(`[RepairWorkflow] Invalid rawScore scale for page ${o}: ${w} (expected 0-10)`);const E=((D=i.fixableIssues)==null?void 0:D.length)??0;(w<v||E>=p)&&I.push(o)}I.sort((g,i)=>g-i),O(g=>({...g,redoPages:{pageNumbers:I,reasons:{}},stepStatus:{...g.stepStatus,"identify-redo-pages":"completed"}})),S();const V=[];if(I.length>0){c==null||c("redo-pages",`Redoing ${I.length} pages...`),$("redo-pages");const g={};for(let i=0;i<I.length;i++){S();const o=I[i];let w=0,E="",F=0;for(let f=1;f<=u;f++){S(),c==null||c("redo-pages",`Page ${o}: attempt ${f}/${u}`),G({current:i,total:I.length,currentPage:o});try{const C=await U.iteratePage(l,o,_);if(C.success){const q=C.qualityScore??0;if(q>w){w=q,E=C.imageData;const je=P.find(Oe=>Oe.pageNumber===o);F=(((k=je==null?void 0:je.imageVersions)==null?void 0:k.length)??0)+f-1}if(q>=v*10)break}}catch(C){console.error(`Failed to redo page ${o} attempt ${f}:`,C)}}E&&(g[o]={score:w,imageData:E,versionIndex:F},V.push(o),W==null||W(o,E,F))}O(i=>({...i,redoResults:{pagesCompleted:V,newVersions:Object.fromEntries(Object.entries(g).map(([o,w])=>[o,w.versionIndex]))},stepStatus:{...i.stepStatus,"redo-pages":"completed"}}))}V.length>0&&(S(),c==null||c("re-evaluate","Re-evaluating redone pages..."),await ee(V)),S(),c==null||c("consistency-check","Running consistency check...");const s=(await U.runEntityConsistency(l)).report;if(O(g=>({...g,consistencyResults:{report:s},stepStatus:{...g.stepStatus,"consistency-check":"completed"}})),S(),s!=null&&s.characters){const g=Object.entries(s.characters).filter(([i,o])=>{var w;return"overallConsistent"in o?!o.overallConsistent||(o.totalIssues??0)>0:!o.consistent||(((w=o.issues)==null?void 0:w.length)??0)>0}).map(([i])=>i);if(g.length>0){c==null||c("character-repair",`Repairing ${g.length} characters...`);for(const i of g){S();const o=s.characters[i],w=new Set;if(o.byClothing){for(const F of Object.values(o.byClothing))for(const f of F.issues||[])if(f.severity==="major"||f.severity==="critical"){for(const C of f.pagesToFix||[])w.add(C);f.pageNumber&&w.add(f.pageNumber)}}if(o.issues){for(const F of o.issues)if(F.severity==="major"||F.severity==="critical"){for(const f of F.pagesToFix||[])w.add(f);F.pageNumber&&w.add(F.pageNumber)}}const E=Array.from(w).sort((F,f)=>F-f);E.length>0&&(c==null||c("character-repair",`Repairing ${i} on ${E.length} pages...`),await se(i,E))}}}S();const b=[];for(const[g,i]of Object.entries(R))(T=i.fixableIssues)!=null&&T.some(o=>o.type==="artifact"||o.type==="distortion")&&b.push(parseInt(g));b.length>0&&(c==null||c("artifact-repair",`Repairing artifacts on ${b.length} pages...`),await te(b)),c==null||c("complete","Workflow complete!")}catch(L){if(L instanceof Error&&L.message==="Workflow aborted"){console.log("[useRepairWorkflow] Workflow was aborted by user");return}throw console.error("Full workflow failed:",L),L}finally{m.current=null}},[l,P,_,W,Z,ee,$,G,ce,se,te]);return{workflowState:h,isRunning:K,currentStepIndex:H,startStep:$,completeStep:d,failStep:N,skipStep:Y,resetWorkflow:ue,collectFeedback:Z,updatePageFeedback:me,toggleRedoPage:xe,autoIdentifyRedoPages:J,redoMarkedPages:le,redoProgress:Q,reEvaluatePages:ee,runConsistencyCheck:ce,repairCharacter:se,repairArtifacts:te,runFullWorkflow:ae,abortWorkflow:ge,isAborted:M,canProceedToStep:he,getStepNumber:be,getPagesNeedingAttention:fe,getCharactersWithIssues:ne,getPagesWithSevereIssuesForCharacter:ye}}const z={idle:{label:"Ready",icon:Fe,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:Pe,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:$e,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:Te,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:pe,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:Se,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:Se,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:Ee,description:"Fix remaining artifacts via grid repair"}};function _e({status:l}){const P={pending:{color:"bg-gray-100 text-gray-600",icon:Fe},"in-progress":{color:"bg-blue-100 text-blue-600",icon:de},completed:{color:"bg-green-100 text-green-600",icon:pe},skipped:{color:"bg-yellow-100 text-yellow-600",icon:qe},failed:{color:"bg-red-100 text-red-600",icon:Ie}},{color:B,icon:A}=P[l],_=l==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${B}`,children:[e.jsx(A,{className:`w-3 h-3 ${_?"animate-spin":""}`}),l]})}function De({feedback:l,isMarkedForRedo:P,onToggleRedo:B,onUpdateNotes:A}){var Q,G;const[_,W]=x.useState(!1),h=l.fixableIssues.length+l.entityIssues.length+(((Q=l.objectIssues)==null?void 0:Q.length)||0)+(((G=l.semanticIssues)==null?void 0:G.length)||0),O=h>0||l.qualityScore!==void 0&&l.qualityScore<7;return e.jsxs("div",{className:`border rounded-lg p-3 ${P?"border-red-300 bg-red-50":O?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>W(!_),className:"p-1 hover:bg-gray-100 rounded",children:_?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",l.pageNumber]}),l.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${l.qualityScore>=8?"bg-green-100 text-green-700":l.qualityScore>=6?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",l.qualityScore]}),h>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[h," issues"]})]}),e.jsx("button",{onClick:B,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${P?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:P?"Marked for Redo":"Mark for Redo"})]}),_&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[l.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",l.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:l.fixableIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsxs("span",{children:["[",m.type,"] ",m.description]})]},M))})]}),l.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",l.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:l.entityIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:m.character}),e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.issue})]},M))})]}),l.objectIssues&&l.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",l.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:l.objectIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:m.object}),e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.issue})]},M))})]}),l.semanticIssues&&l.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",l.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:l.semanticIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:m.type.replace(/_/g," ")}),m.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:m.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${m.severity==="high"?"bg-red-100 text-red-700":m.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.description})]},M))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:l.manualNotes,onChange:m=>A(m.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}const Ne="repair-workflow-autorun-completed";function Ye({storyId:l,sceneImages:P,characters:B,finalChecksReport:A,imageModel:_,onImageUpdate:W,onRefreshStory:h,autoRunFullWorkflow:O=!1,onAutoRunComplete:Q,developerMode:G=!1,useMagicApiRepair:m=!1,setUseMagicApiRepair:M}){const[X,K]=x.useState(!0),[H,$]=x.useState(new Set(["collect-feedback"])),{workflowState:d,isRunning:N,resetWorkflow:Y,collectFeedback:ue,updatePageFeedback:ge,toggleRedoPage:Z,autoIdentifyRedoPages:me,redoMarkedPages:xe,redoProgress:J,reEvaluatePages:le,runConsistencyCheck:ee,repairCharacter:ce,repairArtifacts:se,runFullWorkflow:te,abortWorkflow:he,isAborted:be,getStepNumber:fe,getCharactersWithIssues:ne,getPagesWithSevereIssuesForCharacter:ye}=Me({storyId:l,sceneImages:P,characters:B,finalChecksReport:A,imageModel:_,onImageUpdate:W}),[ae,a]=x.useState(null),[r,n]=x.useState(!1),y=x.useRef(null),v=t=>{try{return JSON.parse(localStorage.getItem(Ne)||"[]").includes(t)}catch{return!1}},p=t=>{try{const s=JSON.parse(localStorage.getItem(Ne)||"[]");if(!s.includes(t)){s.push(t);const b=s.slice(-10);localStorage.setItem(Ne,JSON.stringify(b))}}catch(s){console.error("[RepairWorkflowPanel] Failed to save auto-run completion:",s)}};x.useEffect(()=>{if(O&&l&&P.length>0&&!N&&!r){const t=y.current===l,s=v(l);!t&&!s?(y.current=l,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",l),setTimeout(async()=>{await u(),p(l),Q==null||Q()},500)):console.log("[RepairWorkflowPanel] Skipping auto-run - already completed for story:",l,{alreadyRunThisSession:t,alreadyCompletedPreviously:s})}},[O,l,P.length,N,r]);const u=async()=>{n(!0);try{await te({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(t,s)=>{a({step:t,detail:s})}}),h&&await h()}catch(t){console.error("Full workflow failed:",t)}finally{n(!1),a(null)}},[c,j]=x.useState(""),[S,D]=x.useState([]),[k,T]=x.useState([]),L=t=>{$(s=>{const b=new Set(s);return b.has(t)?b.delete(t):b.add(t),b})},R=x.useMemo(()=>ne(),[ne]),I=x.useMemo(()=>{var s;const t=new Set;for(const[b,g]of Object.entries(d.collectedFeedback.pages))g.fixableIssues.some(i=>i.type==="artifact"||i.type==="distortion")&&t.add(parseInt(b));for(const[b,g]of Object.entries(d.reEvaluationResults.pages))(s=g.fixableIssues)!=null&&s.some(i=>i.type==="artifact"||i.type==="distortion")&&t.add(parseInt(b));return Array.from(t).sort((b,g)=>b-g)},[d.collectedFeedback.pages,d.reEvaluationResults.pages]),V=t=>{const s=z[t],b=s.icon,g=d.stepStatus[t],i=H.has(t),o=fe(t);return e.jsxs("button",{onClick:()=>L(t),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${g==="in-progress"?"bg-blue-50":g==="completed"?"bg-green-50":g==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:o}),e.jsx(b,{className:`w-4 h-4 ${g==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:s.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{status:g}),i?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})]})]})};return l?e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>K(!X),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),d.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[d.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[N&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(de,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:t=>{t.stopPropagation(),Y()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(Ae,{className:"w-4 h-4 text-amber-700"})}),X?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})]})]}),X&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsxs("button",{onClick:()=>{he(),n(!1),a(null)},className:"flex items-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium",title:"Stop the workflow",children:[e.jsx(Re,{className:"w-5 h-5"}),"Stop"]}),e.jsx("button",{onClick:u,disabled:N||r,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:r?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-5 h-5"}),"Run Full Workflow"]})})]})]}),ae&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(de,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[ae.step,":"]}),e.jsx("span",{className:"text-purple-600",children:ae.detail})]})}),be&&!r&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(Re,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Workflow stopped"})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("collect-feedback"),H.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["collect-feedback"].description}),e.jsxs("button",{onClick:ue,disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Pe,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(d.collectedFeedback.pages).length>0&&(()=>{const t=Object.values(d.collectedFeedback.pages),s=t.reduce((f,C)=>f+C.fixableIssues.length,0),b=t.reduce((f,C)=>f+C.entityIssues.length,0),g=t.reduce((f,C)=>{var q;return f+(((q=C.objectIssues)==null?void 0:q.length)||0)},0),i=t.reduce((f,C)=>{var q;return f+(((q=C.semanticIssues)==null?void 0:q.length)||0)},0),o=s+b+g+i,w=Object.values(d.reEvaluationResults.pages),E=w.reduce((f,C)=>{var q;return f+(((q=C.fixableIssues)==null?void 0:q.length)||0)},0),F=w.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",o," issues from generation + ",F?`${E} from re-evaluation`:"re-evaluate for fresh data"]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[s>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",s]}),b>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",b]}),g>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",g]}),i>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",i]}),F&&E>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",E]}),o===0&&!F&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"No issues detected (run re-evaluate for fresh assessment)"}),o===0&&F&&E===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:t.sort((f,C)=>f.pageNumber-C.pageNumber).map(f=>e.jsx(De,{feedback:f,isMarkedForRedo:d.redoPages.pageNumbers.includes(f.pageNumber),onToggleRedo:()=>Z(f.pageNumber),onUpdateNotes:C=>ge(f.pageNumber,{manualNotes:C})},f.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("identify-redo-pages"),H.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>me(6,3),disabled:N||d.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ie,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),d.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",d.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.redoPages.pageNumbers.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:d.redoPages.reasons[t],children:["Page ",t,e.jsx("button",{onClick:()=>Z(t),className:"hover:text-red-900",children:e.jsx(Ie,{className:"w-3 h-3"})})]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("redo-pages"),H.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["redo-pages"].description}),e.jsxs("button",{onClick:xe,disabled:N||d.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(We,{className:"w-4 h-4"}),"Redo ",d.redoPages.pageNumbers.length," Pages"]}),J.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",J.current," / ",J.total]}),J.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",J.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${J.current/J.total*100}%`}})})]}),d.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",d.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.redoResults.pagesCompleted.map(t=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",t," (v",d.redoResults.newVersions[t]??"?",")"]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("re-evaluate"),H.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[d.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>le(),disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(pe,{className:"w-4 h-4"}),"Re-evaluate ",d.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>le(P.map(t=>t.pageNumber)),disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(pe,{className:"w-4 h-4"}),"Re-evaluate All ",P.length," Pages"]})]}),Object.keys(d.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(d.reEvaluationResults.pages).map(([t,s])=>{var o,w,E,F,f;const b=s.score??s.qualityScore,g=s.qualityScore,i=s.semanticScore;return s.score===null&&s.qualityScore!==null&&console.warn(`[RepairWorkflow] Page ${t}: Missing combined score, using qualityScore fallback`),e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-medium",children:["Page ",t,":"]}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:["Quality: ",g,"%"]}),i!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",i,"%"]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${b>=70?"bg-green-100 text-green-700":b>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",b,"%"]}),s.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${s.verdict==="PASS"?"bg-green-100 text-green-700":s.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:s.verdict}),s.fixableIssues&&s.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",s.fixableIssues.length," fixable issues)"]})]}),s.issuesSummary&&s.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${s.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:s.issuesSummary}),s.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["ðŸ” Semantic Analysis (Score: ",s.semanticResult.score??"N/A","):"]}),s.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸ‘ï¸ Visible:"}),s.semanticResult.visible.characters&&s.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.visible.characters.join(", ")]}),s.semanticResult.visible.objects&&s.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.visible.objects.join(", ")]}),s.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.visible.setting]}),s.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸŽ¯ Expected:"}),((o=s.semanticResult.expected)==null?void 0:o.characters)&&s.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.expected.characters.join(", ")]}),((w=s.semanticResult.expected)==null?void 0:w.objects)&&s.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.expected.objects.join(", ")]}),((E=s.semanticResult.expected)==null?void 0:E.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.expected.setting]}),((F=s.semanticResult.expected)==null?void 0:F.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.expected.action]})]})]}),s.semanticResult.semanticIssues&&s.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:s.semanticResult.semanticIssues.map((C,q)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${C.severity==="CRITICAL"?"text-red-600":C.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",C.severity,"]"]})," ",C.problem]},q))}),((f=s.semanticResult.semanticIssues)==null?void 0:f.length)===0&&!s.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"âœ“ No issues"})]})]},t)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("consistency-check"),H.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["consistency-check"].description}),e.jsxs("button",{onClick:()=>ee(),disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Se,{className:"w-4 h-4"}),"Run Consistency Check"]}),d.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${d.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:d.consistencyResults.report.overallConsistent?"All characters consistent!":`${d.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:d.consistencyResults.report.summary})]}),Object.entries(d.consistencyResults.report.characters||{}).map(([t,s])=>{var b,g;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${s.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:t}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${s.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",s.overallScore??s.score??"?","/10",(s.totalIssues??((b=s.issues)==null?void 0:b.length)??0)>0&&` â€¢ ${s.totalIssues??((g=s.issues)==null?void 0:g.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[s.byClothing&&Object.entries(s.byClothing).map(([i,o])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:i}),e.jsxs("span",{className:`text-xs ${o.score>=7?"text-green-600":"text-amber-600"}`,children:[o.score,"/10"]})]}),o.issues&&o.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:o.issues.map((w,E)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${w.severity==="critical"?"bg-red-400":w.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[w.description,w.pagesToFix&&w.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",w.pagesToFix.join(", "),")"]})]})]},E))})]},i)),!s.byClothing&&s.issues&&s.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:s.issues.map((i,o)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${i.severity==="critical"?"bg-red-400":i.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:i.description})]},o))}),(!s.byClothing||Object.values(s.byClothing).every(i=>{var o;return!((o=i.issues)!=null&&o.length)}))&&(!s.issues||s.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},t)}),R.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:R.map(t=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:t},t))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("character-repair"),H.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:c,onChange:t=>{j(t.target.value),D([])},className:"w-full p-2 border rounded text-sm",disabled:N,children:[e.jsx("option",{value:"",children:"Choose a character..."}),R.map(t=>e.jsxs("option",{value:t,children:[t," (has issues)"]},t)),B.filter(t=>!R.includes(t.name)).map(t=>e.jsx("option",{value:t.name,children:t.name},t.name))]})]}),c&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const t=ye(c);D(t)},disabled:N||d.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(ie,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:P.map(t=>e.jsxs("button",{onClick:()=>{D(s=>s.includes(t.pageNumber)?s.filter(b=>b!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${S.includes(t.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:N,children:["Page ",t.pageNumber]},t.pageNumber))})]}),G&&M&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("label",{className:"text-sm font-medium text-blue-800 mb-2 block",children:"Repair Method:"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:!m,onChange:()=>M(!1),className:"text-blue-600",disabled:N}),e.jsx("span",{className:"text-sm",children:"Gemini (default)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:m,onChange:()=>M(!0),className:"text-blue-600",disabled:N}),e.jsx("span",{className:"text-sm",children:"MagicAPI Face+Hair"}),e.jsx("span",{className:"text-xs text-blue-600",children:"(~$0.006/repair)"})]})]}),m&&e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Uses face swap + hair fix pipeline with iterative crop checking"})]}),e.jsxs("button",{onClick:async()=>{await ce(c,S,{useMagicApiRepair:m}),h&&await h()},disabled:N||!c||S.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(ke,{className:"w-4 h-4"}),"Repair ",c||"Character"," on ",S.length," pages",m&&e.jsx("span",{className:"text-xs opacity-75",children:"(MagicAPI)"})]}),Object.keys(d.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800 mb-2",children:"Repair Results:"}),Object.entries(d.characterRepairResults.pagesRepaired).map(([t,s])=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[t,":"]})," ",e.jsxs("span",{className:"text-gray-600",children:["Pages ",s.join(", ")]})]},t))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[V("artifact-repair"),H.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>T(I),disabled:N||I.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(ie,{className:"w-3 h-3"}),"Auto-Identify (",I.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:I.length>0?I.map(t=>e.jsxs("button",{onClick:()=>{T(s=>s.includes(t)?s.filter(b=>b!==t):[...s,t])},className:`px-2 py-1 text-xs rounded border transition-colors ${k.includes(t)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:N,children:["Page ",t]},t)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),I.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),P.map(t=>e.jsxs("button",{onClick:()=>{T(s=>s.includes(t.pageNumber)?s.filter(b=>b!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${k.includes(t.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:N,children:["Page ",t.pageNumber]},t.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await se(k),h&&await h()},disabled:N||k.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Run Grid Repair on ",k.length," pages"]}),d.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",d.artifactRepairResults.pagesProcessed.length," pages, fixed ",d.artifactRepairResults.issuesFixed," issues"]})})]})]})]})]}):null}export{Ye as RepairWorkflowPanel,Ye as default};
