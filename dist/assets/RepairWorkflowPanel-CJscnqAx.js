import{c as pe,s as K,j as e,L as he,C as be,T as _e}from"./index-BGs8WQuS.js";import{b as u}from"./vendor-react-CqfXSjHo.js";import{I as Le}from"./ImageLightbox-wZ_kFLlB.js";import{W as $e}from"./wrench-CKf7WCO_.js";import{R as Ge}from"./rotate-ccw-C4P2hLl8.js";import{C as Ie}from"./chevron-down-CZ5jBY7w.js";import{C as Fe}from"./chevron-right-CI1xhf82.js";import{S as Oe}from"./square-XmwuLvb-.js";import{S as We}from"./search-D8jQkWkg.js";import{C as Te}from"./circle-x-D7dJ3cIC.js";import{U as Ee}from"./Input-BStFYEPB.js";import{I as qe,R as Be}from"./Modal-8ifkNUOW.js";import"./vendor-firebase-DTVMaYMy.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=pe("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=pe("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=pe("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=pe("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=pe("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function Ae(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending","cover-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{},pagesFailed:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const xe=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair","cover-repair"];function Ue({storyId:n,sceneImages:E,characters:ae,finalChecksReport:q,imageModel:B,onImageUpdate:_}){const[f,O]=u.useState(Ae),[ee,V]=u.useState({current:0,total:0,currentPage:void 0}),b=u.useRef(null),[L,re]=u.useState(!1),ce=u.useMemo(()=>Object.values(f.stepStatus).some(a=>a==="in-progress"),[f.stepStatus]),H=u.useMemo(()=>xe.indexOf(f.currentStep),[f.currentStep]),$=u.useCallback(a=>{O(c=>({...c,currentStep:a,stepStatus:{...c.stepStatus,[a]:"in-progress"}}))},[]),J=u.useCallback((a,c)=>{O(l=>({...l,stepStatus:{...l.stepStatus,[a]:"completed"},...a==="collect-feedback"&&c?{collectedFeedback:c}:{},...a==="re-evaluate"&&c?{reEvaluationResults:c}:{},...a==="consistency-check"&&c?{consistencyResults:c}:{}}))},[]),S=u.useCallback((a,c)=>{O(l=>({...l,stepStatus:{...l.stepStatus,[a]:"failed"}}))},[]),d=u.useCallback(a=>{O(c=>({...c,stepStatus:{...c.stepStatus,[a]:"skipped"}}))},[]),R=u.useCallback(()=>{O(Ae()),V({current:0,total:0,currentPage:void 0}),re(!1),b.current=null},[]),fe=u.useCallback(()=>{var a;console.log("[useRepairWorkflow] Aborting workflow"),(a=b.current)==null||a.abort(),re(!0)},[]),le=u.useCallback(async()=>{var a,c,l,x,k,p,o;if(n){$("collect-feedback");try{const i={};let F=0;for(const y of E){const P={pageNumber:y.pageNumber,qualityScore:y.qualityScore,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},T=(a=y.retryHistory)==null?void 0:a.slice(-1)[0];if((c=T==null?void 0:T.postRepairEval)!=null&&c.fixableIssues?P.fixableIssues=T.postRepairEval.fixableIssues:(l=T==null?void 0:T.preRepairEval)!=null&&l.fixableIssues?P.fixableIssues=T.preRepairEval.fixableIssues:(x=y.fixableIssues)!=null&&x.length?P.fixableIssues=y.fixableIssues:(k=y.fixTargets)!=null&&k.length&&(P.fixableIssues=y.fixTargets.map(m=>({description:m.issue||"Quality issue detected",severity:"medium",type:"visual",fix:m.fixPrompt||""}))),q!=null&&q.entity){for(const[m,N]of Object.entries(q.entity.characters||{})){const I=[];if(N.byClothing)for(const C of Object.values(N.byClothing))C.issues&&I.push(...C.issues);N.issues&&I.push(...N.issues);const M=I.filter(C=>{var se;return((se=C.pagesToFix)==null?void 0:se.includes(y.pageNumber))||C.pageNumber===y.pageNumber});for(const C of M)P.entityIssues.push({character:m,issue:C.description,severity:C.severity})}for(const[m,N]of Object.entries(q.entity.objects||{})){const I=[];if(N.byClothing)for(const C of Object.values(N.byClothing))C.issues&&I.push(...C.issues);N.issues&&I.push(...N.issues);const M=I.filter(C=>{var se;return((se=C.pagesToFix)==null?void 0:se.includes(y.pageNumber))||C.pageNumber===y.pageNumber});for(const C of M)P.objectIssues.push({object:m,issue:C.description,severity:C.severity})}}if(q!=null&&q.imageChecks)for(const m of q.imageChecks)for(const N of m.issues||[])(((p=N.pagesToFix)==null?void 0:p.includes(y.pageNumber))||((o=N.images)==null?void 0:o.includes(y.pageNumber)))&&P.semanticIssues.push({type:N.type,description:N.description,severity:N.severity,characterInvolved:N.characterInvolved,recommendation:N.recommendation});F+=P.fixableIssues.length+P.entityIssues.length+P.objectIssues.length+P.semanticIssues.length,i[y.pageNumber]=P}J("collect-feedback",{pages:i,totalIssues:F})}catch(i){console.error("Failed to collect feedback:",i),S("collect-feedback",i instanceof Error?i.message:"Unknown error")}}},[n,E,q,$,J,S]),ye=u.useCallback((a,c)=>{O(l=>({...l,collectedFeedback:{...l.collectedFeedback,pages:{...l.collectedFeedback.pages,[a]:{...l.collectedFeedback.pages[a],...c}}}}))},[]),me=u.useCallback((a,c)=>{O(l=>{const x=l.redoPages.pageNumbers.includes(a),k=x?l.redoPages.pageNumbers.filter(o=>o!==a):[...l.redoPages.pageNumbers,a].sort((o,i)=>o-i),p={...l.redoPages.reasons};return x?delete p[a]:c&&(p[a]=c),{...l,redoPages:{pageNumbers:k,reasons:p}}})},[]),je=u.useCallback((a=60,c=3)=>{$("identify-redo-pages");const l=[],x={};for(const[k,p]of Object.entries(f.collectedFeedback.pages)){const o=parseInt(k),i=p.fixableIssues.length+p.entityIssues.length,F=p.qualityScore??100;F<a?(l.push(o),x[o]=`Low quality score: ${F}`):i>=c?(l.push(o),x[o]=`Too many issues: ${i}`):p.needsFullRedo&&(l.push(o),x[o]="Manually marked for redo")}O(k=>({...k,redoPages:{pageNumbers:l.sort((p,o)=>p-o),reasons:x},stepStatus:{...k.stepStatus,"identify-redo-pages":"completed"}}))},[f.collectedFeedback.pages,$]),Ne=u.useCallback(async a=>{var k;if(!n||f.redoPages.pageNumbers.length===0)return;$("redo-pages");const c=f.redoPages.pageNumbers;V({current:0,total:c.length,currentPage:void 0});const l=[],x={};try{for(let p=0;p<c.length;p++){const o=c[p];V({current:p,total:c.length,currentPage:o});try{const i=await K.iteratePage(n,o,B,{useOriginalAsReference:a==null?void 0:a.useOriginalAsReference,blackoutIssues:a==null?void 0:a.blackoutIssues});if(i.success){l.push(o);const F=E.find(P=>P.pageNumber===o),y=((k=F==null?void 0:F.imageVersions)==null?void 0:k.length)??0;x[o]=y,_&&_(o,i.imageData,y)}}catch(i){console.error(`Failed to redo page ${o}:`,i)}}O(p=>({...p,redoResults:{pagesCompleted:l,newVersions:x},stepStatus:{...p.stepStatus,"redo-pages":"completed"}})),V({current:c.length,total:c.length,currentPage:void 0})}catch(p){console.error("Redo pages failed:",p),S("redo-pages",p instanceof Error?p.message:"Unknown error")}},[n,f.redoPages.pageNumbers,B,E,_,$,S]),U=u.useCallback(async a=>{if(!n)return;$("re-evaluate");const c=a??f.redoResults.pagesCompleted;if(c.length===0){d("re-evaluate");return}try{const l=await K.reEvaluatePages(n,c),x={};for(const[k,p]of Object.entries(l.pages||{})){const o=p;x[parseInt(k)]={qualityScore:o.qualityScore,rawScore:o.rawScore,verdict:o.verdict,issuesSummary:o.issuesSummary,reasoning:o.reasoning,fixableIssues:o.fixableIssues}}J("re-evaluate",{pages:x})}catch(l){console.error("Re-evaluation failed:",l),S("re-evaluate",l instanceof Error?l.message:"Unknown error")}},[n,f.redoResults.pagesCompleted,$,J,S,d]),ne=u.useCallback(async()=>{if(n){$("consistency-check");try{const a=await K.runEntityConsistency(n);J("consistency-check",{report:a.report})}catch(a){console.error("Consistency check failed:",a),S("consistency-check",a instanceof Error?a.message:"Unknown error")}}},[n,$,J,S]),ie=u.useCallback(async(a,c,l)=>{var x,k,p,o;if(!(!n||c.length===0)){$("character-repair");try{const i=await K.repairCharacters(n,[{character:a,pages:c}],l),F=((k=(x=i.results)==null?void 0:x[0])==null?void 0:k.pagesRepaired)||[],y=((o=(p=i.results)==null?void 0:p[0])==null?void 0:o.pagesFailed)||[];for(const m of F)if(m.imageData&&_)try{_(m.pageNumber,m.imageData,m.versionIndex)}catch(N){console.error(`[RepairWorkflow] Failed to notify parent of image update for page ${m.pageNumber}:`,N)}y.length>0&&console.warn(`[RepairWorkflow] ${y.length} pages failed repair for ${a}:`,y.map(m=>`page ${m.pageNumber}: ${m.reason}`).join(", "));const P=F.map(m=>({pageNumber:typeof m=="number"?m:m.pageNumber,comparison:m.comparison||null,verification:m.verification||null,method:m.method||"gemini"})),T=y.map(m=>({pageNumber:m.pageNumber,reason:m.reason,rejected:m.rejected,comparison:m.comparison||null}));O(m=>({...m,characterRepairResults:{charactersProcessed:[...m.characterRepairResults.charactersProcessed,a],pagesRepaired:{...m.characterRepairResults.pagesRepaired,[a]:P},pagesFailed:{...m.characterRepairResults.pagesFailed,[a]:T}},stepStatus:{...m.stepStatus,"character-repair":y.length>0&&F.length===0?"failed":"completed"}}))}catch(i){console.error("Character repair failed:",i),S("character-repair",i instanceof Error?i.message:"Unknown error")}}},[n,$,S,_]),oe=u.useCallback(async a=>{if(!(!n||a.length===0)){$("artifact-repair");try{const c=await K.repairArtifacts(n,a);O(l=>({...l,artifactRepairResults:{pagesProcessed:c.pagesProcessed||a,issuesFixed:c.issuesFixed||0},stepStatus:{...l.stepStatus,"artifact-repair":"completed"}}))}catch(c){console.error("Artifact repair failed:",c),S("artifact-repair",c instanceof Error?c.message:"Unknown error")}}},[n,$,S]),[ve,de]=u.useState({current:0,total:0,currentCover:void 0}),z=u.useCallback(async a=>{if(!n||a.length===0)return;$("cover-repair"),de({current:0,total:a.length,currentCover:void 0});const c=[];try{for(let l=0;l<a.length;l++){const x=a[l];de({current:l,total:a.length,currentCover:x});try{await K.regenerateCover(n,x),c.push(x)}catch(k){console.error(`Failed to regenerate ${x} cover:`,k)}}O(l=>({...l,stepStatus:{...l.stepStatus,"cover-repair":c.length>0?"completed":"failed"}})),de({current:a.length,total:a.length,currentCover:void 0})}catch(l){console.error("Cover repair failed:",l),S("cover-repair",l instanceof Error?l.message:"Unknown error")}},[n,$,S]),we=u.useCallback(a=>{const c=xe.indexOf(a);if(a==="idle")return!0;if(ce)return!1;switch(a){case"collect-feedback":return!0;case"identify-redo-pages":return f.stepStatus["collect-feedback"]==="completed";case"redo-pages":return f.redoPages.pageNumbers.length>0;case"re-evaluate":return f.stepStatus["redo-pages"]==="completed"||f.stepStatus["redo-pages"]==="skipped";case"consistency-check":return c>xe.indexOf("collect-feedback");case"character-repair":return f.stepStatus["consistency-check"]==="completed";case"artifact-repair":return f.stepStatus["collect-feedback"]==="completed";case"cover-repair":return!0;default:return!1}},[f,ce]),ke=u.useCallback(a=>{const c=xe.indexOf(a);return c>0?c:0},[]),Ce=u.useCallback(()=>Object.entries(f.collectedFeedback.pages).filter(([a,c])=>{const l=c.qualityScore??100,x=c.fixableIssues.length+c.entityIssues.length;return l<70||x>0||c.needsFullRedo}).map(([a])=>parseInt(a)).sort((a,c)=>a-c),[f.collectedFeedback.pages]),Re=u.useCallback(()=>{const a=f.consistencyResults.report;return a!=null&&a.characters?Object.entries(a.characters).filter(([c,l])=>{var x;return"overallConsistent"in l?!l.overallConsistent||(l.totalIssues??0)>0:!l.consistent||(((x=l.issues)==null?void 0:x.length)??0)>0}).map(([c])=>c):[]},[f.consistencyResults.report]),ue=u.useCallback(a=>{var k;const c=f.consistencyResults.report;if(!((k=c==null?void 0:c.characters)!=null&&k[a]))return[];const l=c.characters[a],x=new Set;if(l.byClothing){for(const p of Object.values(l.byClothing))for(const o of p.issues||[])if(o.severity==="major"||o.severity==="critical"){for(const i of o.pagesToFix||[])x.add(i);o.pageNumber&&x.add(o.pageNumber)}}if(l.issues){for(const p of l.issues)if(p.severity==="major"||p.severity==="critical"){for(const o of p.pagesToFix||[])x.add(o);p.pageNumber&&x.add(p.pageNumber)}}return Array.from(x).sort((p,o)=>p-o)},[f.consistencyResults.report]),Se=u.useCallback(async(a={})=>{var P,T,m;if(!n)return;const c=6,l=3,x=4,{scoreThreshold:k=c,issueThreshold:p=l,maxRetries:o=x,onProgress:i}=a;b.current=new AbortController,re(!1);const F=b.current.signal,y=()=>{if(F.aborted)throw console.log("[useRepairWorkflow] Workflow aborted"),new Error("Workflow aborted")};try{y(),i==null||i("collect-feedback","Collecting existing issues..."),await le(),y(),i==null||i("re-evaluate","Evaluating all pages...");const N=await K.reEvaluatePages(n,E.map(w=>w.pageNumber)),I={};for(const[w,j]of Object.entries(N.pages||{})){const s=j;I[parseInt(w)]=s}y(),i==null||i("identify-redo-pages","Identifying pages needing redo...");const M=[];for(const[w,j]of Object.entries(I)){const s=parseInt(w),t=j.rawScore??Math.round(j.qualityScore/10);t>10&&console.error(`[RepairWorkflow] Invalid rawScore scale for page ${s}: ${t} (expected 0-10)`);const r=((P=j.fixableIssues)==null?void 0:P.length)??0;(t<k||r>=p)&&M.push(s)}M.sort((w,j)=>w-j),O(w=>({...w,redoPages:{pageNumbers:M,reasons:{}},stepStatus:{...w.stepStatus,"identify-redo-pages":"completed"}})),y();const C=[];if(M.length>0){i==null||i("redo-pages",`Redoing ${M.length} pages...`),$("redo-pages");const w={};for(let j=0;j<M.length;j++){y();const s=M[j];let t=0,r="",h=0;for(let g=1;g<=o;g++){y(),i==null||i("redo-pages",`Page ${s}: attempt ${g}/${o}`),V({current:j,total:M.length,currentPage:s});try{const v=await K.iteratePage(n,s,B);if(v.success){const D=v.qualityScore??0;if(D>t){t=D,r=v.imageData;const G=E.find(Z=>Z.pageNumber===s);h=(((T=G==null?void 0:G.imageVersions)==null?void 0:T.length)??0)+g-1}if(D>=k*10)break}}catch(v){console.error(`Failed to redo page ${s} attempt ${g}:`,v)}}r&&(w[s]={score:t,imageData:r,versionIndex:h},C.push(s),_==null||_(s,r,h))}O(j=>({...j,redoResults:{pagesCompleted:C,newVersions:Object.fromEntries(Object.entries(w).map(([s,t])=>[s,t.versionIndex]))},stepStatus:{...j.stepStatus,"redo-pages":"completed"}}))}C.length>0&&(y(),i==null||i("re-evaluate","Re-evaluating redone pages..."),await U(C)),y(),i==null||i("consistency-check","Running consistency check...");const te=(await K.runEntityConsistency(n)).report;if(O(w=>({...w,consistencyResults:{report:te},stepStatus:{...w.stepStatus,"consistency-check":"completed"}})),y(),te!=null&&te.characters){const w=Object.entries(te.characters).filter(([j,s])=>{var t;return"overallConsistent"in s?!s.overallConsistent||(s.totalIssues??0)>0:!s.consistent||(((t=s.issues)==null?void 0:t.length)??0)>0}).map(([j])=>j);if(w.length>0){i==null||i("character-repair",`Repairing ${w.length} characters...`);for(const j of w){y();const s=te.characters[j],t=new Set;if(s.byClothing){for(const h of Object.values(s.byClothing))for(const g of h.issues||[])if(g.severity==="major"||g.severity==="critical"){for(const v of g.pagesToFix||[])t.add(v);g.pageNumber&&t.add(g.pageNumber)}}if(s.issues){for(const h of s.issues)if(h.severity==="major"||h.severity==="critical"){for(const g of h.pagesToFix||[])t.add(g);h.pageNumber&&t.add(h.pageNumber)}}const r=Array.from(t).sort((h,g)=>h-g);r.length>0&&(i==null||i("character-repair",`Repairing ${j} on ${r.length} pages...`),await ie(j,r))}}}y();const X=[];for(const[w,j]of Object.entries(I))(m=j.fixableIssues)!=null&&m.some(s=>s.type==="artifact"||s.type==="distortion")&&X.push(parseInt(w));X.length>0&&(i==null||i("artifact-repair",`Repairing artifacts on ${X.length} pages...`),await oe(X)),i==null||i("complete","Workflow complete!")}catch(N){if(N instanceof Error&&N.message==="Workflow aborted"){console.log("[useRepairWorkflow] Workflow was aborted by user");return}throw console.error("Full workflow failed:",N),N}finally{b.current=null}},[n,E,B,_,le,U,$,V,ne,ie,oe]);return{workflowState:f,isRunning:ce,currentStepIndex:H,startStep:$,completeStep:J,failStep:S,skipStep:d,resetWorkflow:R,collectFeedback:le,updatePageFeedback:ye,toggleRedoPage:me,autoIdentifyRedoPages:je,redoMarkedPages:Ne,redoProgress:ee,reEvaluatePages:U,runConsistencyCheck:ne,repairCharacter:ie,repairArtifacts:oe,regenerateCovers:z,coverRepairProgress:ve,runFullWorkflow:Se,abortWorkflow:fe,isAborted:L,canProceedToStep:we,getStepNumber:ke,getPagesNeedingAttention:Ce,getCharactersWithIssues:Re,getPagesWithSevereIssuesForCharacter:ue}}const Y={idle:{label:"Ready",icon:Me,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:We,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:_e,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:Be,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:be,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:Ee,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:Ee,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:De,description:"Fix remaining artifacts via grid repair"},"cover-repair":{label:"8. Cover Repair",icon:qe,description:"Regenerate front, back, or dedication covers"}};function Je({status:n}){const E={pending:{color:"bg-gray-100 text-gray-600",icon:Me},"in-progress":{color:"bg-blue-100 text-blue-600",icon:he},completed:{color:"bg-green-100 text-green-600",icon:be},skipped:{color:"bg-yellow-100 text-yellow-600",icon:He},failed:{color:"bg-red-100 text-red-600",icon:Te}},{color:ae,icon:q}=E[n],B=n==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${ae}`,children:[e.jsx(q,{className:`w-3 h-3 ${B?"animate-spin":""}`}),n]})}function Qe({feedback:n,isMarkedForRedo:E,onToggleRedo:ae,onUpdateNotes:q}){var ee,V;const[B,_]=u.useState(!1),f=n.fixableIssues.length+n.entityIssues.length+(((ee=n.objectIssues)==null?void 0:ee.length)||0)+(((V=n.semanticIssues)==null?void 0:V.length)||0),O=f>0||n.qualityScore!==void 0&&n.qualityScore<70;return e.jsxs("div",{className:`border rounded-lg p-3 ${E?"border-red-300 bg-red-50":O?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>_(!B),className:"p-1 hover:bg-gray-100 rounded",children:B?e.jsx(Ie,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",n.pageNumber]}),n.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${n.qualityScore>=80?"bg-green-100 text-green-700":n.qualityScore>=60?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",Math.max(0,n.qualityScore)]}),f>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[f," issues"]})]}),e.jsx("button",{onClick:ae,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${E?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:E?"Marked for Redo":"Mark for Redo"})]}),B&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[n.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",n.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:n.fixableIssues.map((b,L)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${b.severity==="critical"?"bg-red-100 text-red-700":b.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:b.severity}),e.jsxs("span",{children:["[",b.type,"] ",b.description]})]},L))})]}),n.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",n.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:n.entityIssues.map((b,L)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:b.character}),e.jsx("span",{className:`px-1 rounded ${b.severity==="critical"?"bg-red-100 text-red-700":b.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:b.severity}),e.jsx("span",{children:b.issue})]},L))})]}),n.objectIssues&&n.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",n.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:n.objectIssues.map((b,L)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:b.object}),e.jsx("span",{className:`px-1 rounded ${b.severity==="critical"?"bg-red-100 text-red-700":b.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:b.severity}),e.jsx("span",{children:b.issue})]},L))})]}),n.semanticIssues&&n.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",n.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:n.semanticIssues.map((b,L)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:b.type.replace(/_/g," ")}),b.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:b.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${b.severity==="high"?"bg-red-100 text-red-700":b.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:b.severity}),e.jsx("span",{children:b.description})]},L))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:n.manualNotes,onChange:b=>q(b.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}const Pe="repair-workflow-autorun-completed";function is({storyId:n,sceneImages:E,characters:ae,finalChecksReport:q,imageModel:B,onImageUpdate:_,onRefreshStory:f,autoRunFullWorkflow:O=!1,onAutoRunComplete:ee,developerMode:V=!1,useMagicApiRepair:b=!1,setUseMagicApiRepair:L}){const[re,ce]=u.useState(!0),[H,$]=u.useState(new Set(["collect-feedback"])),[J,S]=u.useState(null),{workflowState:d,isRunning:R,resetWorkflow:fe,collectFeedback:le,updatePageFeedback:ye,toggleRedoPage:me,autoIdentifyRedoPages:je,redoMarkedPages:Ne,redoProgress:U,reEvaluatePages:ne,runConsistencyCheck:ie,repairCharacter:oe,repairArtifacts:ve,regenerateCovers:de,coverRepairProgress:z,runFullWorkflow:we,abortWorkflow:ke,isAborted:Ce,getStepNumber:Re,getCharactersWithIssues:ue,getPagesWithSevereIssuesForCharacter:Se}=Ue({storyId:n,sceneImages:E,characters:ae,finalChecksReport:q,imageModel:B,onImageUpdate:_}),[a,c]=u.useState(null),[l,x]=u.useState(!1),k=u.useRef(null),p=s=>{try{return JSON.parse(localStorage.getItem(Pe)||"[]").includes(s)}catch{return!1}},o=s=>{try{const t=JSON.parse(localStorage.getItem(Pe)||"[]");if(!t.includes(s)){t.push(s);const r=t.slice(-10);localStorage.setItem(Pe,JSON.stringify(r))}}catch(t){console.error("[RepairWorkflowPanel] Failed to save auto-run completion:",t)}};u.useEffect(()=>{if(O&&n&&E.length>0&&!R&&!l){const s=k.current===n,t=p(n);!s&&!t?(k.current=n,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",n),setTimeout(async()=>{await i(),o(n),ee==null||ee()},500)):console.log("[RepairWorkflowPanel] Skipping auto-run - already completed for story:",n,{alreadyRunThisSession:s,alreadyCompletedPreviously:t})}},[O,n,E.length,R,l]);const i=async()=>{x(!0);try{await we({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(s,t)=>{c({step:s,detail:t})}}),f&&await f()}catch(s){console.error("Full workflow failed:",s)}finally{x(!1),c(null)}},[F,y]=u.useState(""),[P,T]=u.useState([]),[m,N]=u.useState([]),[I,M]=u.useState("fresh"),[C,se]=u.useState([]),te=s=>{$(t=>{const r=new Set(t);return r.has(s)?r.delete(s):r.add(s),r})},X=u.useMemo(()=>ue(),[ue]),w=u.useMemo(()=>{var t;const s=new Set;for(const[r,h]of Object.entries(d.collectedFeedback.pages))h.fixableIssues.some(g=>g.type==="artifact"||g.type==="distortion")&&s.add(parseInt(r));for(const[r,h]of Object.entries(d.reEvaluationResults.pages))(t=h.fixableIssues)!=null&&t.some(g=>g.type==="artifact"||g.type==="distortion")&&s.add(parseInt(r));return Array.from(s).sort((r,h)=>r-h)},[d.collectedFeedback.pages,d.reEvaluationResults.pages]),j=s=>{const t=Y[s],r=t.icon,h=d.stepStatus[s],g=H.has(s),v=Re(s);return e.jsxs("button",{onClick:()=>te(s),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${h==="in-progress"?"bg-blue-50":h==="completed"?"bg-green-50":h==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:v}),e.jsx(r,{className:`w-4 h-4 ${h==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:t.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Je,{status:h}),g?e.jsx(Ie,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})]})]})};return n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>ce(!re),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($e,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),d.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[d.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[R&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(he,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:s=>{s.stopPropagation(),fe()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(Ge,{className:"w-4 h-4 text-amber-700"})}),re?e.jsx(Ie,{className:"w-4 h-4"}):e.jsx(Fe,{className:"w-4 h-4"})]})]}),re&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsxs("button",{onClick:()=>{ke(),x(!1),c(null)},className:"flex items-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium",title:"Stop the workflow",children:[e.jsx(Oe,{className:"w-5 h-5"}),"Stop"]}),e.jsx("button",{onClick:i,disabled:R||l,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:l?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-5 h-5"}),"Run Full Workflow"]})})]})]}),a&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(he,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[a.step,":"]}),e.jsx("span",{className:"text-purple-600",children:a.detail})]})}),Ce&&!l&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Workflow stopped"})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("collect-feedback"),H.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["collect-feedback"].description}),e.jsxs("button",{onClick:le,disabled:R,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(We,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(d.collectedFeedback.pages).length>0&&(()=>{const s=Object.values(d.collectedFeedback.pages),t=s.reduce((A,W)=>A+W.fixableIssues.length,0),r=s.reduce((A,W)=>A+W.entityIssues.length,0),h=s.reduce((A,W)=>{var Q;return A+(((Q=W.objectIssues)==null?void 0:Q.length)||0)},0),g=s.reduce((A,W)=>{var Q;return A+(((Q=W.semanticIssues)==null?void 0:Q.length)||0)},0),v=t+r+h+g,D=Object.values(d.reEvaluationResults.pages),G=D.reduce((A,W)=>{var Q;return A+(((Q=W.fixableIssues)==null?void 0:Q.length)||0)},0),Z=D.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",v," issues from generation + ",Z?`${G} from re-evaluation`:"re-evaluate for fresh data"]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[t>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",t]}),r>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",r]}),h>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",h]}),g>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",g]}),Z&&G>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",G]}),v===0&&!Z&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"No issues detected (run re-evaluate for fresh assessment)"}),v===0&&Z&&G===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:s.sort((A,W)=>A.pageNumber-W.pageNumber).map(A=>e.jsx(Qe,{feedback:A,isMarkedForRedo:d.redoPages.pageNumbers.includes(A.pageNumber),onToggleRedo:()=>me(A.pageNumber),onUpdateNotes:W=>ye(A.pageNumber,{manualNotes:W})},A.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("identify-redo-pages"),H.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>je(6,3),disabled:R||d.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ge,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),d.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",d.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.redoPages.pageNumbers.map(s=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:d.redoPages.reasons[s],children:["Page ",s,e.jsx("button",{onClick:()=>me(s),className:"hover:text-red-900",children:e.jsx(Te,{className:"w-3 h-3"})})]},s))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("redo-pages"),H.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["redo-pages"].description}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded-lg cursor-pointer transition-colors ${I==="fresh"?"bg-amber-50 border border-amber-300":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"radio",name:"redoMode",checked:I==="fresh",onChange:()=>M("fresh"),disabled:R,className:"mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:"Fresh generation"}),e.jsx("p",{className:"text-xs text-gray-500",children:"New generation from AI-corrected scene description"})]})]}),e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded-lg cursor-pointer transition-colors ${I==="reference"?"bg-blue-50 border border-blue-300":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"radio",name:"redoMode",checked:I==="reference",onChange:()=>M("reference"),disabled:R,className:"mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:"Use original as reference"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Passes current image to Gemini â€” preserves composition, fixes details"})]})]}),e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded-lg cursor-pointer transition-colors ${I==="blackout"?"bg-purple-50 border border-purple-300":"bg-gray-50 border border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"radio",name:"redoMode",checked:I==="blackout",onChange:()=>M("blackout"),disabled:R,className:"mt-0.5"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:"Blackout issues"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Blacks out broken areas in the image, forces AI to regenerate those regions"})]})]})]}),e.jsxs("button",{onClick:()=>Ne({useOriginalAsReference:I==="reference",blackoutIssues:I==="blackout"}),disabled:R||d.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ve,{className:"w-4 h-4"}),"Redo ",d.redoPages.pageNumbers.length," Pages",I!=="fresh"&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",I==="reference"?"with reference":"blackout issues",")"]})]}),U.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",U.current," / ",U.total]}),U.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",U.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${U.current/U.total*100}%`}})})]}),d.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",d.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.redoResults.pagesCompleted.map(s=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",s," (v",d.redoResults.newVersions[s]??"?",")"]},s))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("re-evaluate"),H.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[d.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>ne(),disabled:R,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(be,{className:"w-4 h-4"}),"Re-evaluate ",d.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>ne(E.map(s=>s.pageNumber)),disabled:R,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(be,{className:"w-4 h-4"}),"Re-evaluate All ",E.length," Pages"]})]}),Object.keys(d.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(d.reEvaluationResults.pages).map(([s,t])=>{var v,D,G,Z,A;const r=t.score??t.qualityScore,h=t.qualityScore,g=t.semanticScore;return t.score===null&&t.qualityScore!==null&&console.warn(`[RepairWorkflow] Page ${s}: Missing combined score, using qualityScore fallback`),e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-medium",children:["Page ",s,":"]}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:["Quality: ",h,"%"]}),g!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",g,"%"]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${r>=70?"bg-green-100 text-green-700":r>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",r,"%"]}),t.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${t.verdict==="PASS"?"bg-green-100 text-green-700":t.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:t.verdict}),t.fixableIssues&&t.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",t.fixableIssues.length," fixable issues)"]})]}),t.issuesSummary&&t.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${t.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:t.issuesSummary}),t.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["ðŸ” Semantic Analysis (Score: ",t.semanticResult.score??"N/A","):"]}),t.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸ‘ï¸ Visible:"}),t.semanticResult.visible.characters&&t.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",t.semanticResult.visible.characters.join(", ")]}),t.semanticResult.visible.objects&&t.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",t.semanticResult.visible.objects.join(", ")]}),t.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",t.semanticResult.visible.setting]}),t.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",t.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸŽ¯ Expected:"}),((v=t.semanticResult.expected)==null?void 0:v.characters)&&t.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",t.semanticResult.expected.characters.join(", ")]}),((D=t.semanticResult.expected)==null?void 0:D.objects)&&t.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",t.semanticResult.expected.objects.join(", ")]}),((G=t.semanticResult.expected)==null?void 0:G.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",t.semanticResult.expected.setting]}),((Z=t.semanticResult.expected)==null?void 0:Z.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",t.semanticResult.expected.action]})]})]}),t.semanticResult.semanticIssues&&t.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:t.semanticResult.semanticIssues.map((W,Q)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${W.severity==="CRITICAL"?"text-red-600":W.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",W.severity,"]"]})," ",W.problem]},Q))}),((A=t.semanticResult.semanticIssues)==null?void 0:A.length)===0&&!t.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"âœ“ No issues"})]})]},s)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("consistency-check"),H.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["consistency-check"].description}),e.jsxs("button",{onClick:()=>ie(),disabled:R,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Run Consistency Check"]}),d.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${d.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:d.consistencyResults.report.overallConsistent?"All characters consistent!":`${d.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:d.consistencyResults.report.summary})]}),Object.entries(d.consistencyResults.report.characters||{}).map(([s,t])=>{var r,h;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${t.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:s}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${t.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",t.overallScore??t.score??"?","/10",(t.totalIssues??((r=t.issues)==null?void 0:r.length)??0)>0&&` â€¢ ${t.totalIssues??((h=t.issues)==null?void 0:h.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[t.byClothing&&Object.entries(t.byClothing).map(([g,v])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:g}),e.jsxs("span",{className:`text-xs ${v.score>=7?"text-green-600":"text-amber-600"}`,children:[v.score,"/10"]})]}),v.gridImage&&e.jsx("div",{className:"mt-2 mb-2",children:e.jsx("img",{src:v.gridImage,alt:`${s} - ${g} consistency grid`,className:"w-full max-h-48 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(v.gridImage),title:"Click to enlarge"})}),v.issues&&v.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:v.issues.map((D,G)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${D.severity==="critical"?"bg-red-400":D.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[D.description,D.pagesToFix&&D.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",D.pagesToFix.join(", "),")"]})]})]},G))})]},g)),!t.byClothing&&e.jsxs(e.Fragment,{children:[t.gridImage&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.gridImage,alt:`${s} consistency grid`,className:"w-full max-h-48 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(t.gridImage),title:"Click to enlarge"})}),t.issues&&t.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:t.issues.map((g,v)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${g.severity==="critical"?"bg-red-400":g.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:g.description})]},v))})]}),(!t.byClothing||Object.values(t.byClothing).every(g=>{var v;return!((v=g.issues)!=null&&v.length)}))&&(!t.issues||t.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},s)}),X.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:X.map(s=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:s},s))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("character-repair"),H.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:F,onChange:s=>{y(s.target.value),T([])},className:"w-full p-2 border rounded text-sm",disabled:R,children:[e.jsx("option",{value:"",children:"Choose a character..."}),X.map(s=>e.jsxs("option",{value:s,children:[s," (has issues)"]},s)),ae.filter(s=>!X.includes(s.name)).map(s=>e.jsx("option",{value:s.name,children:s.name},s.name))]})]}),F&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const s=Se(F);T(s)},disabled:R||d.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(ge,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:E.map(s=>e.jsxs("button",{onClick:()=>{T(t=>t.includes(s.pageNumber)?t.filter(r=>r!==s.pageNumber):[...t,s.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${P.includes(s.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:R,children:["Page ",s.pageNumber]},s.pageNumber))})]}),V&&L&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("label",{className:"text-sm font-medium text-blue-800 mb-2 block",children:"Repair Method:"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:!b,onChange:()=>L(!1),className:"text-blue-600",disabled:R}),e.jsx("span",{className:"text-sm",children:"Gemini (default)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:b,onChange:()=>L(!0),className:"text-blue-600",disabled:R}),e.jsx("span",{className:"text-sm",children:"MagicAPI Face+Hair"}),e.jsx("span",{className:"text-xs text-blue-600",children:"(~$0.006/repair)"})]})]}),b&&e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Uses face swap + hair fix pipeline with iterative crop checking"})]}),e.jsxs("button",{onClick:async()=>{await oe(F,P,{useMagicApiRepair:b}),f&&await f()},disabled:R||!F||P.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx($e,{className:"w-4 h-4"}),"Repair ",F||"Character"," on ",P.length," pages",b&&e.jsx("span",{className:"text-xs opacity-75",children:"(MagicAPI)"})]}),Object.keys(d.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800",children:"Repair Results:"}),Object.entries(d.characterRepairResults.pagesRepaired).map(([s,t])=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-sm font-medium",children:s}),t.map(r=>{var h;return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-green-800",children:["Page ",r.pageNumber]}),r.method&&e.jsx("span",{className:`px-1.5 py-0.5 text-xs rounded font-medium ${r.method==="magicapi"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700"}`,children:r.method==="magicapi"?"MagicAPI":"Gemini"}),r.verification&&e.jsxs("span",{className:`px-1.5 py-0.5 text-xs rounded ${r.verification.confidence==="high"?"bg-green-100 text-green-700":r.verification.confidence==="medium"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:[r.verification.confidence," confidence"]})]}),r.comparison&&e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:r.comparison.reference,alt:"Reference avatar",className:"w-full h-24 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(r.comparison.reference)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Reference"})]}),e.jsxs("div",{className:"text-center",children:[r.comparison.before?e.jsx("img",{src:r.comparison.before,alt:"Before repair",className:"w-full h-24 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(r.comparison.before)}):e.jsx("div",{className:"w-full h-24 flex items-center justify-center rounded border border-gray-200 bg-gray-50 text-xs text-gray-400",children:"N/A"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Before"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:r.comparison.after,alt:"After repair",className:"w-full h-24 object-contain rounded border border-gray-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(r.comparison.after)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"After"})]})]}),((h=r.verification)==null?void 0:h.explanation)&&e.jsx("p",{className:"text-xs text-gray-600 italic",children:r.verification.explanation})]},r.pageNumber)})]},s))]}),Object.keys(d.characterRepairResults.pagesFailed).length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h5",{className:"text-sm font-medium text-red-800",children:"Failed/Rejected:"}),Object.entries(d.characterRepairResults.pagesFailed).map(([s,t])=>t.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-sm font-medium",children:s}),t.map(r=>e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-red-800",children:["Page ",r.pageNumber]}),r.rejected&&e.jsx("span",{className:"px-1.5 py-0.5 text-xs rounded bg-red-100 text-red-700 font-medium",children:"Rejected"})]}),e.jsx("p",{className:"text-xs text-red-700 mb-2",children:r.reason}),r.comparison&&e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:r.comparison.reference,alt:"Reference avatar",className:"w-full h-24 object-contain rounded border border-red-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(r.comparison.reference)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Reference"})]}),e.jsxs("div",{className:"text-center",children:[r.comparison.before?e.jsx("img",{src:r.comparison.before,alt:"Before repair",className:"w-full h-24 object-contain rounded border border-red-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(r.comparison.before)}):e.jsx("div",{className:"w-full h-24 flex items-center justify-center rounded border border-red-200 bg-gray-50 text-xs text-gray-400",children:"N/A"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"Before"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:r.comparison.after,alt:"After (rejected)",className:"w-full h-24 object-contain rounded border border-red-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(r.comparison.after)}),e.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:"After (rejected)"})]})]})]},r.pageNumber))]},s))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("artifact-repair"),H.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>N(w),disabled:R||w.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(ge,{className:"w-3 h-3"}),"Auto-Identify (",w.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:w.length>0?w.map(s=>e.jsxs("button",{onClick:()=>{N(t=>t.includes(s)?t.filter(r=>r!==s):[...t,s])},className:`px-2 py-1 text-xs rounded border transition-colors ${m.includes(s)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:R,children:["Page ",s]},s)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),w.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),E.map(s=>e.jsxs("button",{onClick:()=>{N(t=>t.includes(s.pageNumber)?t.filter(r=>r!==s.pageNumber):[...t,s.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${m.includes(s.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:R,children:["Page ",s.pageNumber]},s.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await ve(m),f&&await f()},disabled:R||m.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(De,{className:"w-4 h-4"}),"Run Grid Repair on ",m.length," pages"]}),d.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",d.artifactRepairResults.pagesProcessed.length," pages, fixed ",d.artifactRepairResults.issuesFixed," issues"]})})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[j("cover-repair"),H.has("cover-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Y["cover-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Covers to Regenerate:"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:["front","initial","back"].map(s=>{const t={front:"Front Cover",initial:"Dedication Page",back:"Back Cover"};return e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:C.includes(s),onChange:r=>{se(h=>r.target.checked?[...h,s]:h.filter(g=>g!==s))},disabled:R,className:"rounded text-amber-600"}),e.jsx("span",{className:"text-sm",children:t[s]})]},s)})})]}),e.jsxs("button",{onClick:async()=>{await de(C),f&&await f()},disabled:R||C.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(qe,{className:"w-4 h-4"}),"Regenerate ",C.length," Cover",C.length!==1?"s":""]}),z.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",z.current," / ",z.total]}),z.currentCover&&e.jsxs("span",{className:"text-gray-500",children:["Currently: ",z.currentCover," cover"]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${z.current/z.total*100}%`}})})]}),d.stepStatus["cover-repair"]==="completed"&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("h5",{className:"text-sm font-medium text-green-800",children:"Covers regenerated successfully"})})]})]})]})]}),J&&e.jsx(Le,{src:J,alt:"Consistency Grid",onClose:()=>S(null)})]}):null}export{is as RepairWorkflowPanel,is as default};
