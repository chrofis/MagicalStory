import{c as de,s as Q,j as e,L as he,C as be,T as Me}from"./index-DUjTeMBw.js";import{b as u}from"./vendor-react-CqfXSjHo.js";import{W as Fe}from"./wrench-BvdN8Gg2.js";import{R as De}from"./rotate-ccw-Byv0ULLb.js";import{C as Ce}from"./chevron-down-4A4VK9Ul.js";import{C as Pe}from"./chevron-right-zvLcEvBk.js";import{S as Ee}from"./square-C89idaQL.js";import{S as $e}from"./search-CFCIdREC.js";import{C as Ae}from"./circle-x-CVCAWYhF.js";import{U as Ie}from"./Input-DmJwb30b.js";import{I as We,R as _e}from"./Modal-DzkBtz5q.js";import"./vendor-firebase-DTVMaYMy.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=de("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=de("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=de("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=de("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=de("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function Oe(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending","cover-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{},pagesFailed:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const xe=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair","cover-repair"];function Ve({storyId:c,sceneImages:P,characters:Z,finalChecksReport:A,imageModel:L,onImageUpdate:T}){const[b,F]=u.useState(Oe),[X,G]=u.useState({current:0,total:0,currentPage:void 0}),m=u.useRef(null),[M,K]=u.useState(!1),se=u.useMemo(()=>Object.values(b.stepStatus).some(a=>a==="in-progress"),[b.stepStatus]),V=u.useMemo(()=>xe.indexOf(b.currentStep),[b.currentStep]),I=u.useCallback(a=>{F(r=>({...r,currentStep:a,stepStatus:{...r.stepStatus,[a]:"in-progress"}}))},[]),p=u.useCallback((a,r)=>{F(l=>({...l,stepStatus:{...l.stepStatus,[a]:"completed"},...a==="collect-feedback"&&r?{collectedFeedback:r}:{},...a==="re-evaluate"&&r?{reEvaluationResults:r}:{},...a==="consistency-check"&&r?{consistencyResults:r}:{}}))},[]),x=u.useCallback((a,r)=>{F(l=>({...l,stepStatus:{...l.stepStatus,[a]:"failed"}}))},[]),te=u.useCallback(a=>{F(r=>({...r,stepStatus:{...r.stepStatus,[a]:"skipped"}}))},[]),fe=u.useCallback(()=>{F(Oe()),G({current:0,total:0,currentPage:void 0}),K(!1),m.current=null},[]),ye=u.useCallback(()=>{var a;console.log("[useRepairWorkflow] Aborting workflow"),(a=m.current)==null||a.abort(),K(!0)},[]),Y=u.useCallback(async()=>{var a,r,l,h,k;if(c){I("collect-feedback");try{const d={};let o=0;for(const n of P){const v={pageNumber:n.pageNumber,qualityScore:n.qualityScore,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},j=(a=n.retryHistory)==null?void 0:a.slice(-1)[0];if((r=j==null?void 0:j.postRepairEval)!=null&&r.fixableIssues?v.fixableIssues=j.postRepairEval.fixableIssues:(l=j==null?void 0:j.preRepairEval)!=null&&l.fixableIssues&&(v.fixableIssues=j.preRepairEval.fixableIssues),A!=null&&A.entity){for(const[O,R]of Object.entries(A.entity.characters||{})){const f=[];if(R.byClothing)for(const S of Object.values(R.byClothing))S.issues&&f.push(...S.issues);R.issues&&f.push(...R.issues);const q=f.filter(S=>{var W;return((W=S.pagesToFix)==null?void 0:W.includes(n.pageNumber))||S.pageNumber===n.pageNumber});for(const S of q)v.entityIssues.push({character:O,issue:S.description,severity:S.severity})}for(const[O,R]of Object.entries(A.entity.objects||{})){const f=[];if(R.byClothing)for(const S of Object.values(R.byClothing))S.issues&&f.push(...S.issues);R.issues&&f.push(...R.issues);const q=f.filter(S=>{var W;return((W=S.pagesToFix)==null?void 0:W.includes(n.pageNumber))||S.pageNumber===n.pageNumber});for(const S of q)v.objectIssues.push({object:O,issue:S.description,severity:S.severity})}}if(A!=null&&A.imageChecks)for(const O of A.imageChecks)for(const R of O.issues||[])(((h=R.pagesToFix)==null?void 0:h.includes(n.pageNumber))||((k=R.images)==null?void 0:k.includes(n.pageNumber)))&&v.semanticIssues.push({type:R.type,description:R.description,severity:R.severity,characterInvolved:R.characterInvolved,recommendation:R.recommendation});o+=v.fixableIssues.length+v.entityIssues.length+v.objectIssues.length+v.semanticIssues.length,d[n.pageNumber]=v}p("collect-feedback",{pages:d,totalIssues:o})}catch(d){console.error("Failed to collect feedback:",d),x("collect-feedback",d instanceof Error?d.message:"Unknown error")}}},[c,P,A,I,p,x]),je=u.useCallback((a,r)=>{F(l=>({...l,collectedFeedback:{...l.collectedFeedback,pages:{...l.collectedFeedback.pages,[a]:{...l.collectedFeedback.pages[a],...r}}}}))},[]),Ne=u.useCallback((a,r)=>{F(l=>{const h=l.redoPages.pageNumbers.includes(a),k=h?l.redoPages.pageNumbers.filter(o=>o!==a):[...l.redoPages.pageNumbers,a].sort((o,n)=>o-n),d={...l.redoPages.reasons};return h?delete d[a]:r&&(d[a]=r),{...l,redoPages:{pageNumbers:k,reasons:d}}})},[]),J=u.useCallback((a=6,r=3)=>{I("identify-redo-pages");const l=[],h={};for(const[k,d]of Object.entries(b.collectedFeedback.pages)){const o=parseInt(k),n=d.fixableIssues.length+d.entityIssues.length,v=d.qualityScore??10;v<a?(l.push(o),h[o]=`Low quality score: ${v}`):n>=r?(l.push(o),h[o]=`Too many issues: ${n}`):d.needsFullRedo&&(l.push(o),h[o]="Manually marked for redo")}F(k=>({...k,redoPages:{pageNumbers:l.sort((d,o)=>d-o),reasons:h},stepStatus:{...k.stepStatus,"identify-redo-pages":"completed"}}))},[b.collectedFeedback.pages,I]),pe=u.useCallback(async a=>{var k;if(!c||b.redoPages.pageNumbers.length===0)return;I("redo-pages");const r=b.redoPages.pageNumbers;G({current:0,total:r.length,currentPage:void 0});const l=[],h={};try{for(let d=0;d<r.length;d++){const o=r[d];G({current:d,total:r.length,currentPage:o});try{const n=await Q.iteratePage(c,o,L,{useOriginalAsReference:a==null?void 0:a.useOriginalAsReference});if(n.success){l.push(o);const v=P.find(O=>O.pageNumber===o),j=((k=v==null?void 0:v.imageVersions)==null?void 0:k.length)??0;h[o]=j,T&&T(o,n.imageData,j)}}catch(n){console.error(`Failed to redo page ${o}:`,n)}}F(d=>({...d,redoResults:{pagesCompleted:l,newVersions:h},stepStatus:{...d.stepStatus,"redo-pages":"completed"}})),G({current:r.length,total:r.length,currentPage:void 0})}catch(d){console.error("Redo pages failed:",d),x("redo-pages",d instanceof Error?d.message:"Unknown error")}},[c,b.redoPages.pageNumbers,L,P,T,I,x]),ae=u.useCallback(async a=>{if(!c)return;I("re-evaluate");const r=a??b.redoResults.pagesCompleted;if(r.length===0){te("re-evaluate");return}try{const l=await Q.reEvaluatePages(c,r),h={};for(const[k,d]of Object.entries(l.pages||{})){const o=d;h[parseInt(k)]={qualityScore:o.qualityScore,rawScore:o.rawScore,verdict:o.verdict,issuesSummary:o.issuesSummary,reasoning:o.reasoning,fixableIssues:o.fixableIssues}}p("re-evaluate",{pages:h})}catch(l){console.error("Re-evaluation failed:",l),x("re-evaluate",l instanceof Error?l.message:"Unknown error")}},[c,b.redoResults.pagesCompleted,I,p,x,te]),ue=u.useCallback(async()=>{if(c){I("consistency-check");try{const a=await Q.runEntityConsistency(c);p("consistency-check",{report:a.report})}catch(a){console.error("Consistency check failed:",a),x("consistency-check",a instanceof Error?a.message:"Unknown error")}}},[c,I,p,x]),re=u.useCallback(async(a,r,l)=>{var h,k,d,o;if(!(!c||r.length===0)){I("character-repair");try{const n=await Q.repairCharacters(c,[{character:a,pages:r}],l),v=((k=(h=n.results)==null?void 0:h[0])==null?void 0:k.pagesRepaired)||[],j=((o=(d=n.results)==null?void 0:d[0])==null?void 0:o.pagesFailed)||[];for(const f of v)if(f.imageData&&T)try{T(f.pageNumber,f.imageData,f.versionIndex)}catch(q){console.error(`[RepairWorkflow] Failed to notify parent of image update for page ${f.pageNumber}:`,q)}j.length>0&&console.warn(`[RepairWorkflow] ${j.length} pages failed repair for ${a}:`,j.map(f=>`page ${f.pageNumber}: ${f.reason}`).join(", "));const O=v.map(f=>typeof f=="number"?f:f.pageNumber),R=j.map(f=>({pageNumber:f.pageNumber,reason:f.reason,rejected:f.rejected}));F(f=>({...f,characterRepairResults:{charactersProcessed:[...f.characterRepairResults.charactersProcessed,a],pagesRepaired:{...f.characterRepairResults.pagesRepaired,[a]:O},pagesFailed:{...f.characterRepairResults.pagesFailed,[a]:R}},stepStatus:{...f.stepStatus,"character-repair":j.length>0&&v.length===0?"failed":"completed"}}))}catch(n){console.error("Character repair failed:",n),x("character-repair",n instanceof Error?n.message:"Unknown error")}}},[c,I,x,T]),le=u.useCallback(async a=>{if(!(!c||a.length===0)){I("artifact-repair");try{const r=await Q.repairArtifacts(c,a);F(l=>({...l,artifactRepairResults:{pagesProcessed:r.pagesProcessed||a,issuesFixed:r.issuesFixed||0},stepStatus:{...l.stepStatus,"artifact-repair":"completed"}}))}catch(r){console.error("Artifact repair failed:",r),x("artifact-repair",r instanceof Error?r.message:"Unknown error")}}},[c,I,x]),[B,ce]=u.useState({current:0,total:0,currentCover:void 0}),ve=u.useCallback(async a=>{if(!c||a.length===0)return;I("cover-repair"),ce({current:0,total:a.length,currentCover:void 0});const r=[];try{for(let l=0;l<a.length;l++){const h=a[l];ce({current:l,total:a.length,currentCover:h});try{await Q.regenerateCover(c,h),r.push(h)}catch(k){console.error(`Failed to regenerate ${h} cover:`,k)}}F(l=>({...l,stepStatus:{...l.stepStatus,"cover-repair":r.length>0?"completed":"failed"}})),ce({current:a.length,total:a.length,currentCover:void 0})}catch(l){console.error("Cover repair failed:",l),x("cover-repair",l instanceof Error?l.message:"Unknown error")}},[c,I,x]),we=u.useCallback(a=>{const r=xe.indexOf(a);if(a==="idle")return!0;if(se)return!1;switch(a){case"collect-feedback":return!0;case"identify-redo-pages":return b.stepStatus["collect-feedback"]==="completed";case"redo-pages":return b.redoPages.pageNumbers.length>0;case"re-evaluate":return b.stepStatus["redo-pages"]==="completed"||b.stepStatus["redo-pages"]==="skipped";case"consistency-check":return r>xe.indexOf("collect-feedback");case"character-repair":return b.stepStatus["consistency-check"]==="completed";case"artifact-repair":return b.stepStatus["collect-feedback"]==="completed";case"cover-repair":return!0;default:return!1}},[b,se]),ke=u.useCallback(a=>{const r=xe.indexOf(a);return r>0?r:0},[]),ge=u.useCallback(()=>Object.entries(b.collectedFeedback.pages).filter(([a,r])=>{const l=r.qualityScore??10,h=r.fixableIssues.length+r.entityIssues.length;return l<7||h>0||r.needsFullRedo}).map(([a])=>parseInt(a)).sort((a,r)=>a-r),[b.collectedFeedback.pages]),Se=u.useCallback(()=>{const a=b.consistencyResults.report;return a!=null&&a.characters?Object.entries(a.characters).filter(([r,l])=>{var h;return"overallConsistent"in l?!l.overallConsistent||(l.totalIssues??0)>0:!l.consistent||(((h=l.issues)==null?void 0:h.length)??0)>0}).map(([r])=>r):[]},[b.consistencyResults.report]),ne=u.useCallback(a=>{var k;const r=b.consistencyResults.report;if(!((k=r==null?void 0:r.characters)!=null&&k[a]))return[];const l=r.characters[a],h=new Set;if(l.byClothing){for(const d of Object.values(l.byClothing))for(const o of d.issues||[])if(o.severity==="major"||o.severity==="critical"){for(const n of o.pagesToFix||[])h.add(n);o.pageNumber&&h.add(o.pageNumber)}}if(l.issues){for(const d of l.issues)if(d.severity==="major"||d.severity==="critical"){for(const o of d.pagesToFix||[])h.add(o);d.pageNumber&&h.add(d.pageNumber)}}return Array.from(h).sort((d,o)=>d-o)},[b.consistencyResults.report]),ie=u.useCallback(async(a={})=>{var O,R,f;if(!c)return;const r=6,l=3,h=4,{scoreThreshold:k=r,issueThreshold:d=l,maxRetries:o=h,onProgress:n}=a;m.current=new AbortController,K(!1);const v=m.current.signal,j=()=>{if(v.aborted)throw console.log("[useRepairWorkflow] Workflow aborted"),new Error("Workflow aborted")};try{j(),n==null||n("collect-feedback","Collecting existing issues..."),await Y(),j(),n==null||n("re-evaluate","Evaluating all pages...");const q=await Q.reEvaluatePages(c,P.map(t=>t.pageNumber)),S={};for(const[t,s]of Object.entries(q.pages||{})){const i=s;S[parseInt(t)]=i}j(),n==null||n("identify-redo-pages","Identifying pages needing redo...");const W=[];for(const[t,s]of Object.entries(S)){const i=parseInt(t),g=s.rawScore??Math.round(s.qualityScore/10);g>10&&console.error(`[RepairWorkflow] Invalid rawScore scale for page ${i}: ${g} (expected 0-10)`);const y=((O=s.fixableIssues)==null?void 0:O.length)??0;(g<k||y>=d)&&W.push(i)}W.sort((t,s)=>t-s),F(t=>({...t,redoPages:{pageNumbers:W,reasons:{}},stepStatus:{...t.stepStatus,"identify-redo-pages":"completed"}})),j();const ee=[];if(W.length>0){n==null||n("redo-pages",`Redoing ${W.length} pages...`),I("redo-pages");const t={};for(let s=0;s<W.length;s++){j();const i=W[s];let g=0,y="",N=0;for(let w=1;w<=o;w++){j(),n==null||n("redo-pages",`Page ${i}: attempt ${w}/${o}`),G({current:s,total:W.length,currentPage:i});try{const $=await Q.iteratePage(c,i,L);if($.success){const H=$.qualityScore??0;if(H>g){g=H,y=$.imageData;const C=P.find(E=>E.pageNumber===i);N=(((R=C==null?void 0:C.imageVersions)==null?void 0:R.length)??0)+w-1}if(H>=k*10)break}}catch($){console.error(`Failed to redo page ${i} attempt ${w}:`,$)}}y&&(t[i]={score:g,imageData:y,versionIndex:N},ee.push(i),T==null||T(i,y,N))}F(s=>({...s,redoResults:{pagesCompleted:ee,newVersions:Object.fromEntries(Object.entries(t).map(([i,g])=>[i,g.versionIndex]))},stepStatus:{...s.stepStatus,"redo-pages":"completed"}}))}ee.length>0&&(j(),n==null||n("re-evaluate","Re-evaluating redone pages..."),await ae(ee)),j(),n==null||n("consistency-check","Running consistency check...");const D=(await Q.runEntityConsistency(c)).report;if(F(t=>({...t,consistencyResults:{report:D},stepStatus:{...t.stepStatus,"consistency-check":"completed"}})),j(),D!=null&&D.characters){const t=Object.entries(D.characters).filter(([s,i])=>{var g;return"overallConsistent"in i?!i.overallConsistent||(i.totalIssues??0)>0:!i.consistent||(((g=i.issues)==null?void 0:g.length)??0)>0}).map(([s])=>s);if(t.length>0){n==null||n("character-repair",`Repairing ${t.length} characters...`);for(const s of t){j();const i=D.characters[s],g=new Set;if(i.byClothing){for(const N of Object.values(i.byClothing))for(const w of N.issues||[])if(w.severity==="major"||w.severity==="critical"){for(const $ of w.pagesToFix||[])g.add($);w.pageNumber&&g.add(w.pageNumber)}}if(i.issues){for(const N of i.issues)if(N.severity==="major"||N.severity==="critical"){for(const w of N.pagesToFix||[])g.add(w);N.pageNumber&&g.add(N.pageNumber)}}const y=Array.from(g).sort((N,w)=>N-w);y.length>0&&(n==null||n("character-repair",`Repairing ${s} on ${y.length} pages...`),await re(s,y))}}}j();const _=[];for(const[t,s]of Object.entries(S))(f=s.fixableIssues)!=null&&f.some(i=>i.type==="artifact"||i.type==="distortion")&&_.push(parseInt(t));_.length>0&&(n==null||n("artifact-repair",`Repairing artifacts on ${_.length} pages...`),await le(_)),n==null||n("complete","Workflow complete!")}catch(q){if(q instanceof Error&&q.message==="Workflow aborted"){console.log("[useRepairWorkflow] Workflow was aborted by user");return}throw console.error("Full workflow failed:",q),q}finally{m.current=null}},[c,P,L,T,Y,ae,I,G,ue,re,le]);return{workflowState:b,isRunning:se,currentStepIndex:V,startStep:I,completeStep:p,failStep:x,skipStep:te,resetWorkflow:fe,collectFeedback:Y,updatePageFeedback:je,toggleRedoPage:Ne,autoIdentifyRedoPages:J,redoMarkedPages:pe,redoProgress:X,reEvaluatePages:ae,runConsistencyCheck:ue,repairCharacter:re,repairArtifacts:le,regenerateCovers:ve,coverRepairProgress:B,runFullWorkflow:ie,abortWorkflow:ye,isAborted:M,canProceedToStep:we,getStepNumber:ke,getPagesNeedingAttention:ge,getCharactersWithIssues:Se,getPagesWithSevereIssuesForCharacter:ne}}const z={idle:{label:"Ready",icon:Te,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:$e,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:Me,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:_e,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:be,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:Ie,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:Ie,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:qe,description:"Fix remaining artifacts via grid repair"},"cover-repair":{label:"8. Cover Repair",icon:We,description:"Regenerate front, back, or dedication covers"}};function He({status:c}){const P={pending:{color:"bg-gray-100 text-gray-600",icon:Te},"in-progress":{color:"bg-blue-100 text-blue-600",icon:he},completed:{color:"bg-green-100 text-green-600",icon:be},skipped:{color:"bg-yellow-100 text-yellow-600",icon:Ge},failed:{color:"bg-red-100 text-red-600",icon:Ae}},{color:Z,icon:A}=P[c],L=c==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${Z}`,children:[e.jsx(A,{className:`w-3 h-3 ${L?"animate-spin":""}`}),c]})}function Ue({feedback:c,isMarkedForRedo:P,onToggleRedo:Z,onUpdateNotes:A}){var X,G;const[L,T]=u.useState(!1),b=c.fixableIssues.length+c.entityIssues.length+(((X=c.objectIssues)==null?void 0:X.length)||0)+(((G=c.semanticIssues)==null?void 0:G.length)||0),F=b>0||c.qualityScore!==void 0&&c.qualityScore<7;return e.jsxs("div",{className:`border rounded-lg p-3 ${P?"border-red-300 bg-red-50":F?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>T(!L),className:"p-1 hover:bg-gray-100 rounded",children:L?e.jsx(Ce,{className:"w-4 h-4"}):e.jsx(Pe,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",c.pageNumber]}),c.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${c.qualityScore>=8?"bg-green-100 text-green-700":c.qualityScore>=6?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",c.qualityScore]}),b>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[b," issues"]})]}),e.jsx("button",{onClick:Z,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${P?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:P?"Marked for Redo":"Mark for Redo"})]}),L&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[c.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",c.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.fixableIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsxs("span",{children:["[",m.type,"] ",m.description]})]},M))})]}),c.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",c.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.entityIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:m.character}),e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.issue})]},M))})]}),c.objectIssues&&c.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",c.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.objectIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:m.object}),e.jsx("span",{className:`px-1 rounded ${m.severity==="critical"?"bg-red-100 text-red-700":m.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.issue})]},M))})]}),c.semanticIssues&&c.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",c.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:c.semanticIssues.map((m,M)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:m.type.replace(/_/g," ")}),m.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:m.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${m.severity==="high"?"bg-red-100 text-red-700":m.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:m.severity}),e.jsx("span",{children:m.description})]},M))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:c.manualNotes,onChange:m=>A(m.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}const Re="repair-workflow-autorun-completed";function rs({storyId:c,sceneImages:P,characters:Z,finalChecksReport:A,imageModel:L,onImageUpdate:T,onRefreshStory:b,autoRunFullWorkflow:F=!1,onAutoRunComplete:X,developerMode:G=!1,useMagicApiRepair:m=!1,setUseMagicApiRepair:M}){const[K,se]=u.useState(!0),[V,I]=u.useState(new Set(["collect-feedback"])),{workflowState:p,isRunning:x,resetWorkflow:te,collectFeedback:fe,updatePageFeedback:ye,toggleRedoPage:Y,autoIdentifyRedoPages:je,redoMarkedPages:Ne,redoProgress:J,reEvaluatePages:pe,runConsistencyCheck:ae,repairCharacter:ue,repairArtifacts:re,regenerateCovers:le,coverRepairProgress:B,runFullWorkflow:ce,abortWorkflow:ve,isAborted:we,getStepNumber:ke,getCharactersWithIssues:ge,getPagesWithSevereIssuesForCharacter:Se}=Ve({storyId:c,sceneImages:P,characters:Z,finalChecksReport:A,imageModel:L,onImageUpdate:T}),[ne,ie]=u.useState(null),[a,r]=u.useState(!1),l=u.useRef(null),h=t=>{try{return JSON.parse(localStorage.getItem(Re)||"[]").includes(t)}catch{return!1}},k=t=>{try{const s=JSON.parse(localStorage.getItem(Re)||"[]");if(!s.includes(t)){s.push(t);const i=s.slice(-10);localStorage.setItem(Re,JSON.stringify(i))}}catch(s){console.error("[RepairWorkflowPanel] Failed to save auto-run completion:",s)}};u.useEffect(()=>{if(F&&c&&P.length>0&&!x&&!a){const t=l.current===c,s=h(c);!t&&!s?(l.current=c,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",c),setTimeout(async()=>{await d(),k(c),X==null||X()},500)):console.log("[RepairWorkflowPanel] Skipping auto-run - already completed for story:",c,{alreadyRunThisSession:t,alreadyCompletedPreviously:s})}},[F,c,P.length,x,a]);const d=async()=>{r(!0);try{await ce({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(t,s)=>{ie({step:t,detail:s})}}),b&&await b()}catch(t){console.error("Full workflow failed:",t)}finally{r(!1),ie(null)}},[o,n]=u.useState(""),[v,j]=u.useState([]),[O,R]=u.useState([]),[f,q]=u.useState(!1),[S,W]=u.useState([]),ee=t=>{I(s=>{const i=new Set(s);return i.has(t)?i.delete(t):i.add(t),i})},oe=u.useMemo(()=>ge(),[ge]),D=u.useMemo(()=>{var s;const t=new Set;for(const[i,g]of Object.entries(p.collectedFeedback.pages))g.fixableIssues.some(y=>y.type==="artifact"||y.type==="distortion")&&t.add(parseInt(i));for(const[i,g]of Object.entries(p.reEvaluationResults.pages))(s=g.fixableIssues)!=null&&s.some(y=>y.type==="artifact"||y.type==="distortion")&&t.add(parseInt(i));return Array.from(t).sort((i,g)=>i-g)},[p.collectedFeedback.pages,p.reEvaluationResults.pages]),_=t=>{const s=z[t],i=s.icon,g=p.stepStatus[t],y=V.has(t),N=ke(t);return e.jsxs("button",{onClick:()=>ee(t),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${g==="in-progress"?"bg-blue-50":g==="completed"?"bg-green-50":g==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:N}),e.jsx(i,{className:`w-4 h-4 ${g==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:s.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{status:g}),y?e.jsx(Ce,{className:"w-4 h-4"}):e.jsx(Pe,{className:"w-4 h-4"})]})]})};return c?e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>se(!K),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Fe,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),p.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[p.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[x&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(he,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:t=>{t.stopPropagation(),te()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(De,{className:"w-4 h-4 text-amber-700"})}),K?e.jsx(Ce,{className:"w-4 h-4"}):e.jsx(Pe,{className:"w-4 h-4"})]})]}),K&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsxs("button",{onClick:()=>{ve(),r(!1),ie(null)},className:"flex items-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium",title:"Stop the workflow",children:[e.jsx(Ee,{className:"w-5 h-5"}),"Stop"]}),e.jsx("button",{onClick:d,disabled:x||a,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:a?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-5 h-5"}),"Run Full Workflow"]})})]})]}),ne&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(he,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[ne.step,":"]}),e.jsx("span",{className:"text-purple-600",children:ne.detail})]})}),we&&!a&&e.jsx("div",{className:"mt-3 p-2 bg-red-50 rounded border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-700",children:[e.jsx(Ee,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Workflow stopped"})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("collect-feedback"),V.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["collect-feedback"].description}),e.jsxs("button",{onClick:fe,disabled:x,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx($e,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(p.collectedFeedback.pages).length>0&&(()=>{const t=Object.values(p.collectedFeedback.pages),s=t.reduce((C,E)=>C+E.fixableIssues.length,0),i=t.reduce((C,E)=>C+E.entityIssues.length,0),g=t.reduce((C,E)=>{var U;return C+(((U=E.objectIssues)==null?void 0:U.length)||0)},0),y=t.reduce((C,E)=>{var U;return C+(((U=E.semanticIssues)==null?void 0:U.length)||0)},0),N=s+i+g+y,w=Object.values(p.reEvaluationResults.pages),$=w.reduce((C,E)=>{var U;return C+(((U=E.fixableIssues)==null?void 0:U.length)||0)},0),H=w.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",N," issues from generation + ",H?`${$} from re-evaluation`:"re-evaluate for fresh data"]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[s>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",s]}),i>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",i]}),g>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",g]}),y>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",y]}),H&&$>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",$]}),N===0&&!H&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"No issues detected (run re-evaluate for fresh assessment)"}),N===0&&H&&$===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:t.sort((C,E)=>C.pageNumber-E.pageNumber).map(C=>e.jsx(Ue,{feedback:C,isMarkedForRedo:p.redoPages.pageNumbers.includes(C.pageNumber),onToggleRedo:()=>Y(C.pageNumber),onUpdateNotes:E=>ye(C.pageNumber,{manualNotes:E})},C.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("identify-redo-pages"),V.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>je(6,3),disabled:x||p.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(me,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),p.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",p.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:p.redoPages.pageNumbers.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:p.redoPages.reasons[t],children:["Page ",t,e.jsx("button",{onClick:()=>Y(t),className:"hover:text-red-900",children:e.jsx(Ae,{className:"w-3 h-3"})})]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("redo-pages"),V.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["redo-pages"].description}),e.jsxs("label",{className:"flex items-start gap-2 p-2 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:t=>q(t.target.checked),className:"mt-0.5",disabled:x}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Use original as reference"}),e.jsx("p",{className:"text-xs text-blue-600",children:"Passes the current image to Gemini as reference â€” preserves composition, fixes details"})]})]}),e.jsxs("button",{onClick:()=>Ne({useOriginalAsReference:f}),disabled:x||p.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Le,{className:"w-4 h-4"}),"Redo ",p.redoPages.pageNumbers.length," Pages",f&&e.jsx("span",{className:"text-xs opacity-75",children:"(with reference)"})]}),J.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",J.current," / ",J.total]}),J.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",J.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${J.current/J.total*100}%`}})})]}),p.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",p.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:p.redoResults.pagesCompleted.map(t=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",t," (v",p.redoResults.newVersions[t]??"?",")"]},t))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("re-evaluate"),V.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[p.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>pe(),disabled:x,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(be,{className:"w-4 h-4"}),"Re-evaluate ",p.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>pe(P.map(t=>t.pageNumber)),disabled:x,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(be,{className:"w-4 h-4"}),"Re-evaluate All ",P.length," Pages"]})]}),Object.keys(p.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(p.reEvaluationResults.pages).map(([t,s])=>{var N,w,$,H,C;const i=s.score??s.qualityScore,g=s.qualityScore,y=s.semanticScore;return s.score===null&&s.qualityScore!==null&&console.warn(`[RepairWorkflow] Page ${t}: Missing combined score, using qualityScore fallback`),e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-medium",children:["Page ",t,":"]}),e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:["Quality: ",g,"%"]}),y!=null&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded",children:["Semantic: ",y,"%"]}),e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${i>=70?"bg-green-100 text-green-700":i>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Final: ",i,"%"]}),s.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${s.verdict==="PASS"?"bg-green-100 text-green-700":s.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:s.verdict}),s.fixableIssues&&s.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",s.fixableIssues.length," fixable issues)"]})]}),s.issuesSummary&&s.issuesSummary!=="none"&&e.jsx("p",{className:`text-xs pl-2 border-l-2 ${s.issuesSummary.includes("SEMANTIC:")?"text-purple-700 border-purple-400 bg-purple-50 p-1 rounded-r":"text-gray-600 border-gray-300"}`,children:s.issuesSummary}),s.semanticResult&&e.jsxs("div",{className:"text-xs text-purple-700 pl-2 border-l-2 border-purple-400 bg-purple-50 p-1 rounded-r mt-1",children:[e.jsxs("span",{className:"font-medium",children:["ðŸ” Semantic Analysis (Score: ",s.semanticResult.score??"N/A","):"]}),s.semanticResult.visible&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸ‘ï¸ Visible:"}),s.semanticResult.visible.characters&&s.semanticResult.visible.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.visible.characters.join(", ")]}),s.semanticResult.visible.objects&&s.semanticResult.visible.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.visible.objects.join(", ")]}),s.semanticResult.visible.setting&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.visible.setting]}),s.semanticResult.visible.action&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.visible.action]})]}),e.jsxs("div",{className:"bg-white p-2 rounded border border-purple-200",children:[e.jsx("div",{className:"font-medium text-purple-800 mb-1",children:"ðŸŽ¯ Expected:"}),((N=s.semanticResult.expected)==null?void 0:N.characters)&&s.semanticResult.expected.characters.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Characters:"})," ",s.semanticResult.expected.characters.join(", ")]}),((w=s.semanticResult.expected)==null?void 0:w.objects)&&s.semanticResult.expected.objects.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Objects:"})," ",s.semanticResult.expected.objects.join(", ")]}),(($=s.semanticResult.expected)==null?void 0:$.setting)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Setting:"})," ",s.semanticResult.expected.setting]}),((H=s.semanticResult.expected)==null?void 0:H.action)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Action:"})," ",s.semanticResult.expected.action]})]})]}),s.semanticResult.semanticIssues&&s.semanticResult.semanticIssues.length>0&&e.jsx("ul",{className:"list-disc list-inside mt-2",children:s.semanticResult.semanticIssues.map((E,U)=>e.jsxs("li",{children:[e.jsxs("span",{className:`font-medium ${E.severity==="CRITICAL"?"text-red-600":E.severity==="MAJOR"?"text-orange-600":"text-yellow-600"}`,children:["[",E.severity,"]"]})," ",E.problem]},U))}),((C=s.semanticResult.semanticIssues)==null?void 0:C.length)===0&&!s.semanticResult.visible&&e.jsx("span",{className:"text-green-600 ml-2",children:"âœ“ No issues"})]})]},t)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("consistency-check"),V.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["consistency-check"].description}),e.jsxs("button",{onClick:()=>ae(),disabled:x,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ie,{className:"w-4 h-4"}),"Run Consistency Check"]}),p.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${p.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:p.consistencyResults.report.overallConsistent?"All characters consistent!":`${p.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:p.consistencyResults.report.summary})]}),Object.entries(p.consistencyResults.report.characters||{}).map(([t,s])=>{var i,g;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${s.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:t}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${s.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",s.overallScore??s.score??"?","/10",(s.totalIssues??((i=s.issues)==null?void 0:i.length)??0)>0&&` â€¢ ${s.totalIssues??((g=s.issues)==null?void 0:g.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[s.byClothing&&Object.entries(s.byClothing).map(([y,N])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:y}),e.jsxs("span",{className:`text-xs ${N.score>=7?"text-green-600":"text-amber-600"}`,children:[N.score,"/10"]})]}),N.issues&&N.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:N.issues.map((w,$)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${w.severity==="critical"?"bg-red-400":w.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[w.description,w.pagesToFix&&w.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",w.pagesToFix.join(", "),")"]})]})]},$))})]},y)),!s.byClothing&&s.issues&&s.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:s.issues.map((y,N)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${y.severity==="critical"?"bg-red-400":y.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:y.description})]},N))}),(!s.byClothing||Object.values(s.byClothing).every(y=>{var N;return!((N=y.issues)!=null&&N.length)}))&&(!s.issues||s.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},t)}),oe.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:oe.map(t=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:t},t))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("character-repair"),V.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:o,onChange:t=>{n(t.target.value),j([])},className:"w-full p-2 border rounded text-sm",disabled:x,children:[e.jsx("option",{value:"",children:"Choose a character..."}),oe.map(t=>e.jsxs("option",{value:t,children:[t," (has issues)"]},t)),Z.filter(t=>!oe.includes(t.name)).map(t=>e.jsx("option",{value:t.name,children:t.name},t.name))]})]}),o&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const t=Se(o);j(t)},disabled:x||p.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(me,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:P.map(t=>e.jsxs("button",{onClick:()=>{j(s=>s.includes(t.pageNumber)?s.filter(i=>i!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${v.includes(t.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:x,children:["Page ",t.pageNumber]},t.pageNumber))})]}),G&&M&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("label",{className:"text-sm font-medium text-blue-800 mb-2 block",children:"Repair Method:"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:!m,onChange:()=>M(!1),className:"text-blue-600",disabled:x}),e.jsx("span",{className:"text-sm",children:"Gemini (default)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"repairMethod",checked:m,onChange:()=>M(!0),className:"text-blue-600",disabled:x}),e.jsx("span",{className:"text-sm",children:"MagicAPI Face+Hair"}),e.jsx("span",{className:"text-xs text-blue-600",children:"(~$0.006/repair)"})]})]}),m&&e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"Uses face swap + hair fix pipeline with iterative crop checking"})]}),e.jsxs("button",{onClick:async()=>{await ue(o,v,{useMagicApiRepair:m}),b&&await b()},disabled:x||!o||v.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Repair ",o||"Character"," on ",v.length," pages",m&&e.jsx("span",{className:"text-xs opacity-75",children:"(MagicAPI)"})]}),Object.keys(p.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800 mb-2",children:"Repair Results:"}),Object.entries(p.characterRepairResults.pagesRepaired).map(([t,s])=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[t,":"]})," ",e.jsxs("span",{className:"text-gray-600",children:["Pages ",s.join(", ")]})]},t))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("artifact-repair"),V.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>R(D),disabled:x||D.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(me,{className:"w-3 h-3"}),"Auto-Identify (",D.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:D.length>0?D.map(t=>e.jsxs("button",{onClick:()=>{R(s=>s.includes(t)?s.filter(i=>i!==t):[...s,t])},className:`px-2 py-1 text-xs rounded border transition-colors ${O.includes(t)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:x,children:["Page ",t]},t)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),D.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),P.map(t=>e.jsxs("button",{onClick:()=>{R(s=>s.includes(t.pageNumber)?s.filter(i=>i!==t.pageNumber):[...s,t.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${O.includes(t.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:x,children:["Page ",t.pageNumber]},t.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await re(O),b&&await b()},disabled:x||O.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(qe,{className:"w-4 h-4"}),"Run Grid Repair on ",O.length," pages"]}),p.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",p.artifactRepairResults.pagesProcessed.length," pages, fixed ",p.artifactRepairResults.issuesFixed," issues"]})})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[_("cover-repair"),V.has("cover-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:z["cover-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Covers to Regenerate:"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:["front","initial","back"].map(t=>{const s={front:"Front Cover",initial:"Dedication Page",back:"Back Cover"};return e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:S.includes(t),onChange:i=>{W(g=>i.target.checked?[...g,t]:g.filter(y=>y!==t))},disabled:x,className:"rounded text-amber-600"}),e.jsx("span",{className:"text-sm",children:s[t]})]},t)})})]}),e.jsxs("button",{onClick:async()=>{await le(S),b&&await b()},disabled:x||S.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(We,{className:"w-4 h-4"}),"Regenerate ",S.length," Cover",S.length!==1?"s":""]}),B.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",B.current," / ",B.total]}),B.currentCover&&e.jsxs("span",{className:"text-gray-500",children:["Currently: ",B.currentCover," cover"]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${B.current/B.total*100}%`}})})]}),p.stepStatus["cover-repair"]==="completed"&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("h5",{className:"text-sm font-medium text-green-800",children:"Covers regenerated successfully"})})]})]})]})]}):null}export{rs as RepairWorkflowPanel,rs as default};
