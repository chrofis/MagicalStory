const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WizardStep2Characters-BCtuihpX.js","assets/index-Dorw3hr1.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-arfpjWXx.css","assets/Input-BL7bdfbL.js","assets/Textarea-DchLJchm.js","assets/sparkles-BqrbPcey.js","assets/book-open-yp-aGUOr.js","assets/check-MygnNAMw.js","assets/pen-d-ffLHRb.js","assets/trash-2-TpQr4nFp.js","assets/Modal-DN5zZZSP.js","assets/download-DHedciY6.js","assets/chevron-right-DQU67tGw.js","assets/arrow-right-CByIyYJx.js","assets/camera-Bw4zwn7k.js","assets/pencil-BMK8Q839.js","assets/circle-x-CFnQo7VV.js","assets/clock-BHfWrX0N.js","assets/palette-BJNWRMjR.js","assets/book-CHYZ9kdV.js","assets/shopping-cart-CwUO1yM3.js","assets/arrow-left-DTfhJk-k.js","assets/WizardStep4StoryType-Dfmucexx.js","assets/WizardStep5ArtStyle-C5HEY1aZ.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-xR-Bvm6w.js"])))=>i.map(i=>d[i]);
import{c as dt,b as it,d as vn,j as e,X as qt,u as br,a as jn,L as lt,T as Nn,C as Fs,s as Le,E as qi,e as Ui,f as Ki,g as zn,_ as ga}from"./index-Dorw3hr1.js";import{b as n,u as Ji,e as Zi}from"./vendor-react-CqfXSjHo.js";import{U as Es,B as en,I as Bn}from"./Input-BL7bdfbL.js";import{S as Qi,A as Mn,N as Yi}from"./Textarea-DchLJchm.js";import{C as wn}from"./circle-x-CFnQo7VV.js";import{C as Xi}from"./clock-BHfWrX0N.js";import{M as ni,H as eo,R as ma,C as On,a as ar,F as Ts,P as Ln,I as Gn,S as ii,b as to}from"./Modal-DN5zZZSP.js";import{D as ds,C as Ut}from"./download-DHedciY6.js";import{C as zs}from"./chevron-right-DQU67tGw.js";import{P as oi}from"./palette-BJNWRMjR.js";import{B as ro}from"./book-CHYZ9kdV.js";import{C as so}from"./check-MygnNAMw.js";import{S as _n}from"./shopping-cart-CwUO1yM3.js";import{B as tn}from"./book-open-yp-aGUOr.js";import{S as Ds}from"./sparkles-BqrbPcey.js";import{A as Hn}from"./arrow-left-DTfhJk-k.js";import{A as ao}from"./arrow-right-CByIyYJx.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const li=dt("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const no=dt("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const io=dt("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oo=dt("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const di=dt("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=dt("Images",[["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"m22 13-1.296-1.296a2.41 2.41 0 0 0-3.408 0L11 18",key:"nf6bnh"}],["circle",{cx:"12",cy:"8",r:"2",key:"1822b1"}],["rect",{width:"16",height:"16",x:"6",y:"2",rx:"2",key:"12espp"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lo=dt("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const co=dt("Link2Off",[["path",{d:"M9 17H7A5 5 0 0 1 7 7",key:"10o201"}],["path",{d:"M15 7h2a5 5 0 0 1 4 8",key:"1d3206"}],["line",{x1:"8",x2:"12",y1:"12",y2:"12",key:"rvw6j4"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mo=dt("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=dt("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uo=dt("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const go=dt("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=dt("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ho=dt("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=dt("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xo=dt("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wn=dt("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const po=dt("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fo=dt("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bo=dt("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xn=dt("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kr=dt("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ka=dt("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yo=dt("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vo=dt("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]),jo={async login(r,d){const o=await it.post("/api/auth/login",{username:r,password:d},{skipAuth:!0}),m={id:o.user.id,username:o.user.username,email:o.user.email,role:o.user.role,credits:o.user.credits};return{token:o.token,user:m}},async register(r,d,o){return it.post("/api/auth/register",{username:r,password:d,email:o},{skipAuth:!0})},async loginWithFirebase(r){const d=await it.post("/api/auth/firebase",{idToken:r},{skipAuth:!0}),o={id:d.user.id,username:d.user.username,email:d.user.email,role:d.user.role,credits:d.user.credits};return{token:d.token,user:o}},async getQuota(){const r=await it.get("/api/user/quota");return{storyQuota:r.storyQuota,storiesGenerated:r.storiesGenerated,remaining:r.remaining}},async getCredits(){const r=await it.get("/api/user/quota");return{credits:r.credits,unlimited:r.unlimited}},async updateEmail(r){await it.put("/api/user/update-email",{email:r})},async getShippingAddress(){try{return await it.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(r){await it.put("/api/user/shipping-address",r)}},Ce=vn("CharacterService");function ci(r){if(!r)return;const d=parseInt(r,10);if(!(isNaN(d)||d<0))return d<=1?"infant":d<=2?"toddler":d<=4?"preschooler":d<=6?"kindergartner":d<=8?"young-school-age":d<=10?"school-age":d<=12?"preteen":d<=14?"young-teen":d<=17?"teenager":d<=25?"young-adult":d<=39?"adult":d<=59?"middle-aged":d<=75?"senior":"elderly"}function pn(r){const d={height:r.height,build:r.build,face:r.other_features||r.otherFeatures,eyeColor:r.eye_color||r.eyeColor,hairColor:r.hair_color||r.hairColor,hairLength:r.hair_length||r.hairLength,hairStyle:r.hair_style||r.hairStyle,facialHair:r.facial_hair||r.facialHair,skinTone:r.skin_tone||r.skinTone,skinUndertone:r.skin_undertone||r.skinUndertone,skinToneHex:r.skin_tone_hex||r.skinToneHex,hair:r.hair_color||r.hairColor,other:r.other,detailedHairAnalysis:r.detailed_hair_analysis||r.detailedHairAnalysis,apparentAge:r.apparent_age||r.apparentAge},o=r.age_category||r.ageCategory||ci(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,ageCategory:o,physical:d.height||d.build||d.face||d.eyeColor||d.hairColor||d.hairLength||d.hairStyle||d.facialHair||d.skinTone||d.hair||d.other||d.detailedHairAnalysis||d.apparentAge?d:void 0,physicalTraitsSource:r.physical_traits_source||r.physicalTraitsSource,traits:{strengths:r.strengths||[],flaws:r.flaws||r.weaknesses||[],challenges:r.challenges||r.fears||[],specialDetails:r.special_details||r.specialDetails},photos:{original:r.photo_url||r.photoUrl,face:r.thumbnail_url||r.thumbnailUrl,body:r.body_photo_url||r.bodyPhotoUrl,bodyNoBg:r.body_no_bg_url||r.bodyNoBgUrl,faceBox:r.face_box||r.faceBox,bodyBox:r.body_box||r.bodyBox},avatars:r.avatars||r.clothing_avatars||r.clothingAvatars,clothing:r.clothing||r.structured_clothing||r.structuredClothing?{current:r.clothing,structured:r.structured_clothing||r.structuredClothing}:void 0,generatedOutfits:r.generated_outfits||r.generatedOutfits,storyRole:r.storyRole}}function Vn(r){var o,m,s,D,h,N,$,K,S,T,v,k,C,y,x,O,be,he,A,L,de,w,_,j;const d=r.ageCategory||ci(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,age_category:d,apparent_age:(o=r.physical)==null?void 0:o.apparentAge,height:(m=r.physical)==null?void 0:m.height,build:(s=r.physical)==null?void 0:s.build,eye_color:(D=r.physical)==null?void 0:D.eyeColor,hair_color:(h=r.physical)==null?void 0:h.hairColor,hair_length:(N=r.physical)==null?void 0:N.hairLength,hair_style:($=r.physical)==null?void 0:$.hairStyle,facial_hair:(K=r.physical)==null?void 0:K.facialHair,skin_tone:(S=r.physical)==null?void 0:S.skinTone,skin_undertone:(T=r.physical)==null?void 0:T.skinUndertone,skin_tone_hex:(v=r.physical)==null?void 0:v.skinToneHex,other_features:(k=r.physical)==null?void 0:k.face,other:(C=r.physical)==null?void 0:C.other,detailed_hair_analysis:(y=r.physical)==null?void 0:y.detailedHairAnalysis,physical_traits_source:r.physicalTraitsSource,face_box:(x=r.photos)==null?void 0:x.faceBox,body_box:(O=r.photos)==null?void 0:O.bodyBox,strengths:(be=r.traits)==null?void 0:be.strengths,flaws:(he=r.traits)==null?void 0:he.flaws,challenges:(A=r.traits)==null?void 0:A.challenges,special_details:(L=r.traits)==null?void 0:L.specialDetails,weaknesses:(de=r.traits)==null?void 0:de.flaws,fears:(w=r.traits)==null?void 0:w.challenges,clothing:(_=r.clothing)==null?void 0:_.current,structured_clothing:(j=r.clothing)==null?void 0:j.structured,generated_outfits:r.generatedOutfits,storyRole:r.storyRole}}function No(r){return!r||r.length===0?[]:typeof r[0]=="string"?r.map(d=>({forward:d,inverse:d})):r}const Ye={async getCharacters(r=!1){const d=r?"/api/characters?includeAllAvatars=true":"/api/characters";return((await it.get(d)).characters||[]).map(pn)},async getCharacterData(r=!1){const d=r?"/api/characters?includeAllAvatars=true":"/api/characters",o=await it.get(d);return{characters:(o.characters||[]).map(pn),relationships:o.relationships||{},relationshipTexts:o.relationshipTexts||{},customRelationships:No(o.customRelationships),customStrengths:o.customStrengths||[],customWeaknesses:o.customWeaknesses||[],customFears:o.customFears||[]}},async saveCharacters(r){await it.post("/api/characters",{characters:r.map(Vn)})},async saveCharacterData(r,d){const o=s=>{var h,N,$,K;const D=Vn(s);return d!=null&&d.includePhotos&&(D.photo_url=(h=s.photos)==null?void 0:h.original,D.thumbnail_url=(N=s.photos)==null?void 0:N.face,D.body_photo_url=($=s.photos)==null?void 0:$.body,D.body_no_bg_url=(K=s.photos)==null?void 0:K.bodyNoBg),D},m={characters:r.characters.map(o),relationships:r.relationships,relationshipTexts:r.relationshipTexts,customRelationships:r.customRelationships,customStrengths:r.customStrengths,customWeaknesses:r.customWeaknesses,customFears:r.customFears};await it.post("/api/characters",m)},async deleteCharacter(r){try{const d=await it.delete(`/api/characters/${r}`);return Ce.success(`Deleted character ${r}: ${d.message}`),{success:!0}}catch(d){return Ce.error(`Failed to delete character ${r}:`,d),{success:!1,error:String(d)}}},async saveCharacterRoles(r){try{return await it.put("/api/characters/roles",{roles:r}),Ce.success(`Saved character roles: ${Object.keys(r).length} characters`),{success:!0}}catch(d){return Ce.error("Failed to save character roles:",d),{success:!1,error:String(d)}}},async loadCharacterAvatars(r){try{const d=await it.get(`/api/characters/${r}/avatars`);return Ce.info(`Loaded full avatars for character ${r}`),d.avatars||null}catch(d){return Ce.error(`Failed to load avatars for character ${r}:`,d),null}},async loadFullCharacter(r){try{const d=await it.get(`/api/characters/${r}/full`);return d.character?(Ce.info(`Loaded full data for character ${r}`),pn(d.character)):null}catch(d){return Ce.error(`Failed to load full data for character ${r}:`,d),null}},async generateAvatarOptions(r,d){try{return await it.post("/api/generate-avatar-options",{facePhoto:r,gender:d,category:"standard"})}catch(o){const m=o instanceof Error?o.message:"Unknown error";return{success:!1,options:[],error:m}}},async generateClothingAvatars(r,d){var o,m,s,D,h,N,$,K,S,T,v;try{const k=parseInt(r.age)||10,C=r.gender||"child";let y;C==="male"?y=k>=18?"man":"boy":C==="female"?y=k>=18?"woman":"girl":y=k>=18?"person":"child";let O=`${((o=r.name)==null?void 0:o.trim())||`This ${y}`} is a ${k}-year-old ${y}`;r.physical&&(r.physical.hair&&(O+=`, ${r.physical.hair}`),r.physical.face&&(O+=`, ${r.physical.face}`),r.physical.build&&(O+=`, ${r.physical.build}`),r.physical.other&&(O+=`, ${r.physical.other}`));const be=((m=r.photos)==null?void 0:m.bodyNoBg)||((s=r.photos)==null?void 0:s.body)||((D=r.photos)==null?void 0:D.face)||((h=r.photos)==null?void 0:h.original);Ce.info(`ðŸŽ¨ Generating clothing avatars for ${r.name||"unnamed"} (id: ${r.id})`);const he=await it.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:be,physicalDescription:O,name:r.name,age:r.age,apparentAge:(N=r.physical)==null?void 0:N.apparentAge,gender:r.gender,build:($=r.physical)==null?void 0:$.build,clothing:(K=r.clothing)==null?void 0:K.structured,avatarModel:d==null?void 0:d.avatarModel});if(he.async&&he.jobId){Ce.info(`Avatar job started: ${he.jobId}, polling for completion...`);const L=60,de=2e3;for(let w=0;w<L;w++){await new Promise(j=>setTimeout(j,de));const _=await it.get(`/api/avatar-jobs/${he.jobId}`);if(_.status==="complete"&&_.clothingAvatars){Ce.success(`Avatar job ${he.jobId} completed after ${(w+1)*2}s`);const j=_.clothingAvatars.extractedTraits,ae=(S=_.clothingAvatars.structuredClothing)==null?void 0:S.standard;return Ce.info(`ðŸ” [DEBUG] extractedTraits: ${(T=JSON.stringify(j))==null?void 0:T.substring(0,100)}`),Ce.info(`ðŸ” [DEBUG] extractedClothing: ${JSON.stringify(ae)}`),Ce.info(`ðŸ” [DEBUG] structuredClothing keys: ${Object.keys(_.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:_.clothingAvatars,extractedTraits:j,extractedClothing:ae}}if(_.status==="failed")return Ce.error(`Avatar job failed: ${_.error}`),{success:!1,error:_.error};w%5===0&&Ce.info(`Avatar job ${he.jobId}: ${_.message||_.status} (${_.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const A=he;if(A.success&&A.clothingAvatars){Ce.success(`Clothing avatars generated for ${r.name}`);const L=A.clothingAvatars.extractedTraits,de=(v=A.clothingAvatars.structuredClothing)==null?void 0:v.standard;return L&&Ce.info(`Extracted traits: ${JSON.stringify(L)}`),de&&Ce.info(`Extracted clothing: ${JSON.stringify(de)}`),{success:!0,avatars:A.clothingAvatars,extractedTraits:L,extractedClothing:de}}else return Ce.error(`Failed to generate avatars: ${A.error}`),{success:!1,error:A.error}}catch(k){return Ce.error("Clothing avatar generation failed:",k),{success:!1,error:String(k)}}},async generateClothingAvatarsWithTraits(r){var d,o,m,s,D,h,N,$,K,S,T,v,k,C,y,x,O,be;try{const he=parseInt(r.age)||10,A=r.gender||"child";let L;A==="male"?L=he>=18?"man":"boy":A==="female"?L=he>=18?"woman":"girl":L=he>=18?"person":"child";let w=`${((d=r.name)==null?void 0:d.trim())||`This ${L}`} is a ${he}-year-old ${L}`;r.physical&&(r.physical.hair&&(w+=`, ${r.physical.hair}`),r.physical.face&&(w+=`, ${r.physical.face}`),r.physical.build&&(w+=`, ${r.physical.build}`),r.physical.other&&(w+=`, ${r.physical.other}`));const _=((o=r.photos)==null?void 0:o.bodyNoBg)||((m=r.photos)==null?void 0:m.body)||((s=r.photos)==null?void 0:s.face)||((D=r.photos)==null?void 0:D.original),j=(h=r.photos)!=null&&h.bodyNoBg?"bodyNoBg":(N=r.photos)!=null&&N.body?"body":($=r.photos)!=null&&$.face?"face":"original",ae=_?Math.round(_.length/1024):0,Z=_==null?void 0:_.startsWith("data:image/png");Ce.info(`ðŸŽ¨ Generating clothing avatars WITH TRAITS for ${r.name} (id: ${r.id})`),Ce.info(`ðŸ“¸ Photo source: ${j}, size: ${ae}KB, format: ${Z?"PNG":"JPEG"}`),Ce.info(`ðŸ“¸ Available photos: bodyNoBg=${!!((K=r.photos)!=null&&K.bodyNoBg)}, body=${!!((S=r.photos)!=null&&S.body)}, face=${!!((T=r.photos)!=null&&T.face)}, original=${!!((v=r.photos)!=null&&v.original)}`),Ce.info(`Physical traits: ${JSON.stringify(r.physical)}`);const $e=r.physicalTraitsSource||{};Ce.info(`Physical traits source: ${JSON.stringify($e)}`),Ce.info(`Physical skinTone value: '${(k=r.physical)==null?void 0:k.skinTone}', source: '${$e.skinTone}'`),Ce.info(`Physical hairStyle value: '${(C=r.physical)==null?void 0:C.hairStyle}', source: '${$e.hairStyle}'`);const Te={};r.physical&&($e.eyeColor==="user"&&r.physical.eyeColor&&(Te.eyeColor=r.physical.eyeColor),$e.hairColor==="user"&&r.physical.hairColor&&(Te.hairColor=r.physical.hairColor),$e.hairLength==="user"&&r.physical.hairLength&&(Te.hairLength=r.physical.hairLength),$e.hairStyle==="user"&&r.physical.hairStyle&&(Te.hairStyle=r.physical.hairStyle),$e.build==="user"&&r.physical.build&&(Te.build=r.physical.build),$e.skinTone==="user"&&r.physical.skinTone&&(Te.skinTone=r.physical.skinTone,r.physical.skinToneHex&&(Te.skinToneHex=r.physical.skinToneHex)),$e.face==="user"&&r.physical.face&&(Te.face=r.physical.face),$e.facialHair==="user"&&r.physical.facialHair&&(Te.facialHair=r.physical.facialHair),$e.other==="user"&&r.physical.other&&(Te.other=r.physical.other));const B=Object.keys(Te).length>0;Ce.info(`Physical traits to send (user-edited only): ${B?JSON.stringify(Te):"none"}`);const Se=r.clothingSource||{},W={};(y=r.clothing)!=null&&y.structured&&(Se.upperBody==="user"&&r.clothing.structured.upperBody&&(W.upperBody=r.clothing.structured.upperBody),Se.lowerBody==="user"&&r.clothing.structured.lowerBody&&(W.lowerBody=r.clothing.structured.lowerBody),Se.shoes==="user"&&r.clothing.structured.shoes&&(W.shoes=r.clothing.structured.shoes),Se.fullBody==="user"&&r.clothing.structured.fullBody&&(W.fullBody=r.clothing.structured.fullBody));const X=Object.keys(W).length>0;Ce.info(`Clothing to send (user-edited only): ${X?JSON.stringify(W):"none"}`);const Q=await it.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:_,physicalDescription:w,name:r.name,age:r.age,apparentAge:(x=r.physical)==null?void 0:x.apparentAge,gender:r.gender,build:Te.build||"average",physicalTraits:B?Te:void 0,clothing:X?W:void 0});if(Q.async&&Q.jobId){Ce.info(`Avatar job started: ${Q.jobId}, polling for completion...`);const E=60,V=2e3;for(let pe=0;pe<E;pe++){await new Promise(oe=>setTimeout(oe,V));const J=await it.get(`/api/avatar-jobs/${Q.jobId}`);if(J.status==="complete"&&J.clothingAvatars){Ce.success(`Avatar job ${Q.jobId} completed after ${(pe+1)*2}s`);const oe=J.clothingAvatars.extractedTraits,H=(O=J.clothingAvatars.structuredClothing)==null?void 0:O.standard;return{success:!0,avatars:J.clothingAvatars,extractedTraits:oe,extractedClothing:H}}if(J.status==="failed")return Ce.error(`Avatar job failed: ${J.error}`),{success:!1,error:J.error};pe%5===0&&Ce.info(`Avatar job ${Q.jobId}: ${J.message||J.status} (${J.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(Q.success&&Q.clothingAvatars){Ce.success(`Clothing avatars WITH TRAITS generated for ${r.name}`);const E=Q.clothingAvatars.extractedTraits,V=(be=Q.clothingAvatars.structuredClothing)==null?void 0:be.standard;return{success:!0,avatars:Q.clothingAvatars,extractedTraits:E,extractedClothing:V}}else return Ce.error(`Failed to generate avatars with traits: ${Q.error}`),{success:!1,error:Q.error}}catch(he){return Ce.error("Clothing avatar generation with traits failed:",he),{success:!1,error:String(he)}}},async analyzePhoto(r,d,o,m,s){var D,h,N,$,K,S,T,v,k,C,y,x,O,be,he,A,L,de,w,_;try{const j=await it.post("/api/analyze-photo",{imageData:r,language:d,selectedFaceId:o,cachedFaces:m,existingCharacterId:s});if(!j.success)return{success:!1,error:j.error};if(j.multipleFacesDetected&&j.faces)return Ce.info(`Multiple faces detected (${j.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:j.faceCount,faces:j.faces};const ae={height:(D=j.attributes)==null?void 0:D.height,build:(h=j.attributes)==null?void 0:h.build,face:(N=j.attributes)==null?void 0:N.face,eyeColor:(($=j.attributes)==null?void 0:$.eye_color)||((K=j.attributes)==null?void 0:K.eyeColor),hairColor:((S=j.attributes)==null?void 0:S.hair_color)||((T=j.attributes)==null?void 0:T.hairColor),hairLength:((v=j.attributes)==null?void 0:v.hair_length)||((k=j.attributes)==null?void 0:k.hairLength),hairStyle:((C=j.attributes)==null?void 0:C.hair_style)||((y=j.attributes)==null?void 0:y.hairStyle),hair:((x=j.attributes)==null?void 0:x.hair_color)||((O=j.attributes)==null?void 0:O.hairColor),other:(be=j.attributes)==null?void 0:be.other_features};return{success:j.success,characterId:j.characterId,multipleFacesDetected:!1,faceCount:j.faceCount,photos:{face:j.faceThumbnail,body:j.bodyCrop,bodyNoBg:j.bodyNoBg,faceBox:j.faceBox,bodyBox:j.bodyBox},age:(he=j.attributes)==null?void 0:he.age,apparentAge:(A=j.attributes)==null?void 0:A.apparent_age,gender:(L=j.attributes)==null?void 0:L.gender,physical:ae.height||ae.build||ae.face||ae.eyeColor||ae.hairColor||ae.hairLength||ae.hairStyle||ae.hair||ae.other?ae:void 0,clothing:(de=j.attributes)!=null&&de.clothing||(w=j.attributes)!=null&&w.clothingStyle||(_=j.attributes)!=null&&_.clothingColors?{current:j.attributes.clothing,style:j.attributes.clothingStyle||j.attributes.clothingColors}:void 0,_debug:j._debug}}catch(j){return Ce.error("Photo analysis failed:",j),{success:!1,error:"unknown_error"}}},needsAvatars(r){var s,D,h,N;if(!!!((s=r.photos)!=null&&s.original||(D=r.photos)!=null&&D.face||(h=r.photos)!=null&&h.body||(N=r.photos)!=null&&N.bodyNoBg))return!1;const o=r.avatars;return o?o.status==="generating"||o.status==="pending"?!1:o.status==="failed"?!0:!!!(o.winter||o.standard||o.summer||o.formal||o.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(r,d,o){var s,D,h,N,$,K,S,T,v,k,C,y,x,O,be,he,A,L,de,w;const m={characterId:r.id,characterName:r.name,success:!1};try{if(!!!((s=r.photos)!=null&&s.original||(D=r.photos)!=null&&D.face||(h=r.photos)!=null&&h.body||(N=r.photos)!=null&&N.bodyNoBg))return m.skipped=!0,m.skipReason="No photo available",m;d==null||d("generating",`Generating avatars for ${r.name}...`),Ce.info(`ðŸŽ¨ Generating avatars for ${r.name} (id: ${r.id})${o!=null&&o.avatarModel?`, model: ${o.avatarModel}`:""}`);const j=await Ye.generateClothingAvatars(r,o);if(!j.success||!j.avatars)return m.error=j.error||"Avatar generation failed",d==null||d("error",m.error),m;m.avatars=j.avatars,m.extractedTraits=j.extractedTraits,m.extractedClothing=j.extractedClothing,d==null||d("saving",`Fetching updated data for ${r.name}...`);let ae=null;const Z=30;for(let $e=0;$e<Z;$e++){if($e>0){const Te=Math.min(500*Math.pow(1.2,$e),3e3);Ce.info(`[AVATAR] Retry ${$e+1}/${Z}: waiting ${Math.round(Te)}ms for avatar data...`),await new Promise(B=>setTimeout(B,Te))}if(ae=await Ye.loadFullCharacter(r.id),($=ae==null?void 0:ae.avatars)!=null&&$.standard||(K=ae==null?void 0:ae.avatars)!=null&&K.winter||(S=ae==null?void 0:ae.avatars)!=null&&S.summer){Ce.info(`[AVATAR] Got fresh data with avatars on attempt ${$e+1}`);break}}return ae?(m.character=ae,(T=ae.avatars)!=null&&T.standard||(v=ae.avatars)!=null&&v.winter||(k=ae.avatars)!=null&&k.summer||Ce.warn(`âš ï¸ Fresh DB data for ${r.name} missing avatars after ${Z} retries - server may not have saved them`),Ce.info(`ðŸ“‹ Using server-saved data for ${r.name}`)):(Ce.error(`âŒ Character ${r.name} (id: ${r.id}) not found in DB after avatar job - avatars lost!`),m.character={...r,avatars:{status:"failed"},physical:j.extractedTraits?{...r.physical,apparentAge:j.extractedTraits.apparentAge||((C=r.physical)==null?void 0:C.apparentAge),build:j.extractedTraits.build||((y=r.physical)==null?void 0:y.build),eyeColor:j.extractedTraits.eyeColor||((x=r.physical)==null?void 0:x.eyeColor),eyeColorHex:j.extractedTraits.eyeColorHex||((O=r.physical)==null?void 0:O.eyeColorHex),hairColor:j.extractedTraits.hairColor||((be=r.physical)==null?void 0:be.hairColor),hairColorHex:j.extractedTraits.hairColorHex||((he=r.physical)==null?void 0:he.hairColorHex),hairLength:j.extractedTraits.hairLength||((A=r.physical)==null?void 0:A.hairLength),hairStyle:j.extractedTraits.hairStyle||((L=r.physical)==null?void 0:L.hairStyle),skinTone:j.extractedTraits.skinTone||((de=r.physical)==null?void 0:de.skinTone),skinToneHex:j.extractedTraits.skinToneHex||((w=r.physical)==null?void 0:w.skinToneHex)}:r.physical,clothing:j.extractedClothing?{...r.clothing,structured:{upperBody:j.extractedClothing.upperBody||void 0,lowerBody:j.extractedClothing.lowerBody||void 0,shoes:j.extractedClothing.shoes||void 0,fullBody:j.extractedClothing.fullBody||void 0}}:r.clothing}),m.success=!0,d==null||d("complete",`Avatars saved for ${r.name}`),Ce.success(`âœ… Avatars generated and saved for ${r.name}`),m}catch(_){return m.error=String(_),d==null||d("error",m.error),Ce.error(`Failed to generate/save avatars for ${r.name}:`,_),m}},async generateAvatarsForCharacters(r,d){const{forceRegenerate:o=!1,maxConcurrent:m=2,onProgress:s}=d||{};Ce.info("ðŸŽ¨ Starting batch avatar generation...");const D=await Ye.getCharacterData();let h;if(r&&r.length>0?h=D.characters.filter(v=>r.includes(v.id)):h=D.characters.filter(v=>{var k,C;return o?!!((k=v.photos)!=null&&k.original||(C=v.photos)!=null&&C.face):Ye.needsAvatars(v)}),h.length===0)return Ce.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};Ce.info(`Processing ${h.length} characters for avatar generation`);const N=[],$=new Map;for(let v=0;v<h.length;v+=m){const C=h.slice(v,v+m).map(async x=>{var be,he,A,L,de;const O={characterId:x.id,characterName:x.name,success:!1};try{if(!!!((be=x.photos)!=null&&be.original||(he=x.photos)!=null&&he.face||(A=x.photos)!=null&&A.body||(L=x.photos)!=null&&L.bodyNoBg))return O.skipped=!0,O.skipReason="No photo available",O;if(!o&&((de=x.avatars)!=null&&de.winter))return O.skipped=!0,O.skipReason="Avatars already exist",O;s==null||s(x.id,"generating",`Generating avatars for ${x.name}...`),Ce.info(`ðŸŽ¨ Generating avatars for ${x.name}...`);const _=await Ye.generateClothingAvatars(x);return!_.success||!_.avatars?(O.error=_.error||"Avatar generation failed",s==null||s(x.id,"error",O.error),O):(O.avatars=_.avatars,O.success=!0,$.set(x.id,{...x,avatars:_.avatars}),s==null||s(x.id,"complete",`Avatars generated for ${x.name}`),Ce.success(`âœ… Avatars generated for ${x.name}`),O)}catch(w){return O.error=String(w),s==null||s(x.id,"error",O.error),Ce.error(`Failed to generate avatars for ${x.name}:`,w),O}}),y=await Promise.all(C);N.push(...y)}if($.size>0){Ce.info(`ðŸ’¾ Saving ${$.size} character avatar updates...`);const v=await Ye.getCharacterData(),k=v.characters.map(C=>$.get(C.id)||C);await Ye.saveCharacterData({...v,characters:k}),Ce.success(`ðŸ’¾ Saved character data for ${$.size} characters`)}const K=N.filter(v=>v.success).length,S=N.filter(v=>!v.success&&!v.skipped).length,T=N.filter(v=>v.skipped).length;return Ce.info(`Avatar generation complete: ${K} success, ${S} failed, ${T} skipped`),{results:N,successCount:K,failCount:S,skipCount:T}},async regenerateAvatarsForCharacter(r,d,o){Ce.info(`ðŸ”„ Regenerating avatars for character ${r}...`);const s=(await Ye.getCharacterData()).characters.find(h=>h.id===r);if(!s)return{characterId:r,characterName:"Unknown",success:!1,error:"Character not found"};const D={...s,avatars:{status:"pending"}};return Ye.generateAndSaveAvatarForCharacter(D,d?(h,N)=>d(h,N):void 0,o)}},qn={sm:"h-1",md:"h-2",lg:"h-3"},wo={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function So({value:r,max:d=100,label:o,showPercentage:m=!1,size:s="md",variant:D="gradient",className:h=""}){const N=Math.min(Math.max(r/d*100,0),100);return e.jsxs("div",{className:h,children:[(o||m)&&e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[o&&e.jsx("span",{className:"text-sm font-medium text-gray-700",children:o}),m&&e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(N),"%"]})]}),e.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${qn[s]}`,children:e.jsx("div",{className:`${qn[s]} ${wo[D]} rounded-full transition-all duration-500 ease-out`,style:{width:`${N}%`}})})]})}const qr=vn("ImageLoad");function Ja({src:r,alt:d,className:o,label:m}){const[s,D]=n.useState(!0),[h,N]=n.useState(null),$=n.useRef(0),K=n.useRef(null);n.useEffect(()=>{r&&r.length>100?($.current=Date.now(),qr.info(`â³ Loading ${m||d}`,{isBase64:r==null?void 0:r.startsWith("data:"),sizeKB:Math.round(r.length*3/4/1024)})):$.current=0,D(!0),N(null)},[r,d,m]);const S=()=>{if(D(!1),$.current===0){qr.info(`âœ… Loaded ${m||d} (placeholder/empty)`);return}const v=Date.now()-$.current;N(v);const C=(r==null?void 0:r.startsWith("data:"))?Math.round(r.length*3/4/1024):null,y=K.current?`${K.current.naturalWidth}x${K.current.naturalHeight}`:"unknown";v<100?qr.success(`âœ… Loaded ${m||d} in ${v}ms`,{sizeKB:C,naturalSize:y}):v<500?qr.info(`âœ… Loaded ${m||d} in ${v}ms`,{sizeKB:C,naturalSize:y}):v<2e3?qr.warn(`âš ï¸ Slow load: ${m||d} took ${v}ms`,{sizeKB:C,naturalSize:y}):qr.error(`ðŸ¢ Very slow: ${m||d} took ${v}ms`,{sizeKB:C,naturalSize:y}),v>1e3&&Co({type:"slow_image_load",label:m||d,loadTimeMs:v,sizeKB:C,naturalSize:y,userAgent:navigator.userAgent,timestamp:new Date().toISOString()})},T=()=>{if(D(!1),$.current===0){qr.error(`âŒ Failed to load ${m||d} (no data received)`);return}const v=Date.now()-$.current;qr.error(`âŒ Failed to load ${m||d} after ${v}ms`)};return e.jsx("img",{ref:K,src:r,alt:d,className:o,onLoad:S,onError:T,draggable:!1})}async function Co(r){try{await fetch("/api/log-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errorType:"Performance",message:`Slow image load: ${r.label} took ${r.loadTimeMs}ms`,userAgent:r.userAgent,timestamp:r.timestamp,url:window.location.href})})}catch{}}function ko({step:r,text:d}){const o=`wizard_helper_dismissed_${r}`,[m,s]=n.useState(()=>localStorage.getItem(o)==="true");n.useEffect(()=>{const h=localStorage.getItem(o)==="true";s(h)},[r,o]);const D=()=>{localStorage.setItem(o,"true"),s(!0)};return m?null:e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[e.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:d}),e.jsx("button",{onClick:D,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:e.jsx(qt,{size:16})})]})}function Po({current:r,total:d,message:o,isGenerating:m=!0,coverImages:s,jobId:D,onCancel:h,onMinimize:N,characters:$=[],isStalled:K=!1,onDismissStalled:S,isImpersonating:T=!1}){const{language:v}=br(),{user:k}=jn(),C=(k==null?void 0:k.role)==="admin"||T,[y,x]=n.useState(!1),[O,be]=n.useState(0),he=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit fÃ¼r das grosse Abenteuer...",fr:"{name} se prÃ©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} Ã¼bt gerade die Heldenpose...",fr:"{name} s'entraÃ®ne Ã  prendre la pose du hÃ©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als NÃ¤chstes passiert!",fr:"{name} a hÃ¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} wÃ¤rmt sich fÃ¼r das bevorstehende Abenteuer auf...",fr:"{name} s'Ã©chauffe pour l'aventure Ã  venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir fÃ¼gen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au rÃ©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} flÃ¼stert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'Å“il au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne fÃ¼r die Geschichte...",fr:"{name} collectionne des Ã©toiles pour le rÃ©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],A=n.useRef({}),[L,de]=n.useState(null),w=n.useMemo(()=>$.filter(J=>{var H;const oe=J.avatars;return oe&&(((H=oe.faceThumbnails)==null?void 0:H.standard)||oe.standard||oe.summer||oe.winter||oe.formal||oe.hasFullAvatars)}),[$]),_=J=>{var De;const oe=J.avatars;if(!oe)return"";if((De=oe.faceThumbnails)!=null&&De.standard)return oe.faceThumbnails.standard;const H=[];return oe.standard&&H.push(oe.standard),oe.summer&&H.push(oe.summer),oe.winter&&H.push(oe.winter),oe.formal&&H.push(oe.formal),H[Math.floor(Math.random()*H.length)]||""},j=n.useMemo(()=>{const J=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(w.length===0)return J;const oe=[],H=Math.max(J.length,w.length);for(let De=0;De<H;De++)oe.push(J[De%J.length]),oe.push({type:"character",char:w[De%w.length]});return oe},[w]);if(n.useEffect(()=>{if(j.length<=1)return;const J=setInterval(()=>{be(oe=>(oe+1)%j.length)},8e3);return()=>clearInterval(J)},[j.length]),n.useEffect(()=>{if(j.length===0)return;const J=j[O];if(J.type==="character"){const oe=J.char,H=_(oe),Be=((A.current[oe.id]??-1)+1)%he.length;A.current[oe.id]=Be;const Ie=he[Be],q=(v==="de"?Ie.de:v==="fr"?Ie.fr:Ie.en).replace("{name}",oe.name);de({avatarUrl:H,message:q})}else de(null)},[O,j,v]),!m||d===0)return null;const ae=d===100?r:Math.round(r/d*100),Z=J=>{if(J)return typeof J=="string"?J:J.imageData},$e=Z(s==null?void 0:s.frontCover),Te=Z(s==null?void 0:s.initialPage),B=Z(s==null?void 0:s.backCover),Se=!!$e,W=!!Te,X=!!B,Q=Se||W||X,E={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollstÃ¤ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erhÃ¤ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz persÃ¶nliches Abenteuer gestalten.',tipLocations:'FÃ¼ge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu fÃ¼r eine persÃ¶nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? FÃ¼r BilderbÃ¼cher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint hÃ¤ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"CrÃ©ation de votre histoire!",timeInfo:"Votre rÃ©cit commencera Ã  s'afficher dans environ 1 minute. Le rÃ©cit complet peut prendre jusqu'Ã  10 minutes.",emailInfo:"Vous recevrez un email quand votre rÃ©cit sera prÃªt.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre rÃ©cit continuera Ã  Ãªtre gÃ©nÃ©rÃ©.",tipCharacters:"Mieux vous dÃ©crivez vos personnages, plus le rÃ©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du rÃ©cit" vous permet de crÃ©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits prÃ©fÃ©rÃ©s Ã  "Intrigue / Contexte du rÃ©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique prÃ©fÃ©rÃ© ? Pour les livres d'images, l'aquarelle fonctionne trÃ¨s bien !",coversPreview:"AperÃ§u des couvertures",frontCover:"Avant",initialPage:"IntÃ©rieur",backCover:"ArriÃ¨re",cancelJob:"Annuler la gÃ©nÃ©ration",cancelling:"Annulation...",stalled:"La gÃ©nÃ©ration semble bloquÃ©e",stalledDesc:"Aucun progrÃ¨s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer Ã  attendre",continueInBackground:"Continuer en arriÃ¨re-plan"}},V=E[v]||E.en,pe=({imageData:J,label:oe,isReady:H})=>e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${H?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:H&&J?e.jsx("img",{src:J,alt:oe,className:"w-full h-full object-cover"}):e.jsx(lt,{size:20,className:"animate-spin text-gray-400"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[H&&e.jsx(Fs,{size:12,className:"text-green-500"}),e.jsx("span",{className:`text-xs ${H?"text-green-600 font-medium":"text-gray-400"}`,children:oe})]})]});return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${Q?"max-w-lg":"max-w-md"}`,children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("div",{className:"relative inline-block mb-3",children:[e.jsx(lt,{size:48,className:"animate-spin text-indigo-600"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"âœ¨"})]}),e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:V.title})]}),!Q&&j.length>0&&e.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const J=j[O];if(J.type==="character"&&L)return e.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[e.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:e.jsx("img",{src:L.avatarUrl,alt:J.char.name,className:"w-full h-full object-contain"})}),e.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:L.message})]},`char-${J.char.id}-${O}`);if(J.type==="message"){const oe=J.key,H=V[oe]||"",De=oe==="timeInfo"?e.jsx(Xi,{size:20,className:"text-indigo-500 shrink-0"}):oe==="emailInfo"?e.jsx(ni,{size:20,className:"text-indigo-500 shrink-0"}):e.jsx(Fs,{size:20,className:"text-indigo-500 shrink-0"});return e.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[De,e.jsx("p",{className:"text-sm text-gray-700",children:H})]})}return null})()}),Q&&e.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:V.coversPreview}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(pe,{imageData:$e,label:V.frontCover,isReady:Se}),e.jsx(pe,{imageData:Te,label:V.initialPage,isReady:W}),e.jsx(pe,{imageData:B,label:V.backCover,isReady:X})]})]}),Q&&e.jsxs("div",{className:"mb-4 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[e.jsx(lt,{size:14,className:"animate-spin text-indigo-500"}),v==="de"?"Bilder fÃ¼r die Seiten werden jetzt erstellt...":v==="fr"?"CrÃ©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:v==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":v==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),e.jsx("div",{className:"mb-4",children:e.jsx(So,{value:ae,max:100,showPercentage:!0,size:"lg"})}),N&&e.jsx("button",{onClick:N,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:V.continueInBackground}),K&&e.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Nn,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:V.stalled}),e.jsx("p",{className:"text-sm text-amber-700 mb-3",children:V.stalledDesc}),e.jsxs("div",{className:"flex gap-2",children:[S&&e.jsx("button",{onClick:S,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:V.continueWaiting}),h&&e.jsx("button",{onClick:()=>{if(!y){x(!0);try{h()}finally{x(!1)}}},disabled:y,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:y?V.cancelling:V.cancelJob})]})]})]})}),C&&D&&h&&e.jsxs("button",{onClick:async()=>{if(!y){x(!0);try{h()}finally{x(!1)}}},disabled:y,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[y?e.jsx(lt,{size:16,className:"animate-spin"}):e.jsx(wn,{size:16}),y?V.cancelling:V.cancelJob]})]})})}function ua(r,d){const o=new Blob([r],{type:"text/plain;charset=utf-8"}),m=URL.createObjectURL(o),s=document.createElement("a");s.href=m,s.download=d,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(m)}function bn(r,d=0){const o="  ".repeat(d);if(r==null)return`${o}null`;if(typeof r=="boolean")return`${o}${r?"YES":"NO"}`;if(typeof r=="number")return`${o}${r}`;if(typeof r=="string")return`${o}${r}`;if(Array.isArray(r))return r.length===0?`${o}[]`:r.map((m,s)=>`${o}[${s}]: ${bn(m,0)}`).join(`
`);if(typeof r=="object"){const m=Object.entries(r);return m.length===0?`${o}{}`:m.map(([s,D])=>{const h=bn(D,d+1);return typeof D=="object"&&D!==null?`${o}${s}:
${h}`:`${o}${s}: ${h.trim()}`}).join(`
`)}return`${o}${String(r)}`}function Za({data:r,language:d,title:o}){const[m,s]=n.useState(new Set);if(!r)return e.jsx("div",{className:"text-gray-400 italic text-sm",children:d==="de"?"Keine Daten":"No data"});let D=r;if(typeof r=="string")try{D=JSON.parse(r)}catch{return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-end mb-1",children:e.jsxs("button",{onClick:()=>ua(r,`${o||"evaluation"}.txt`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Download as text file",children:[e.jsx(ds,{size:12})," Download"]})}),e.jsx("pre",{className:"text-sm whitespace-pre-wrap bg-gray-50 p-3 rounded max-h-80 overflow-auto font-mono",children:r})]})}const h=K=>{const S=new Set(m);S.has(K)?S.delete(K):S.add(K),s(S)},N=()=>{const K=bn(D);ua(K,`${o||"evaluation"}.txt`)},$=(K,S,T=0)=>{const v=m.has(K);if(S==null)return e.jsx("span",{className:"text-gray-400",children:"null"});if(typeof S=="boolean")return e.jsx("span",{className:S?"text-green-600 font-medium":"text-red-600 font-medium",children:S?"âœ“":"âœ—"});if(typeof S=="number"){const k=S>=70?"text-green-600":S>=50?"text-yellow-600":"text-red-600";return e.jsx("span",{className:`font-bold ${k}`,children:S})}if(typeof S=="string")return S.length>100?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>h(K),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[v?e.jsx(Ut,{size:14}):e.jsx(zs,{size:14}),v?"Collapse":`Show (${S.length} chars)`]}),v&&e.jsx("div",{className:"mt-1 p-2 bg-gray-100 rounded text-sm whitespace-pre-wrap font-mono",children:S})]}):e.jsx("span",{className:"text-gray-700",children:S});if(Array.isArray(S))return S.length===0?e.jsx("span",{className:"text-gray-400",children:"[]"}):e.jsx("div",{className:"ml-2 border-l-2 border-gray-200 pl-2",children:S.map((k,C)=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"text-gray-400 text-xs",children:["[",C,"]"]})," ",$(`${K}.${C}`,k,T+1)]},C))});if(typeof S=="object"){const k=Object.entries(S);return k.length===0?e.jsx("span",{className:"text-gray-400",children:"{}"}):T>0?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>h(K),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[v?e.jsx(Ut,{size:14}):e.jsx(zs,{size:14}),v?"Collapse":`{${k.length} fields}`]}),v&&e.jsx("div",{className:"ml-2 mt-1 border-l-2 border-gray-200 pl-2",children:k.map(([C,y])=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium text-gray-600",children:[C,":"]})," ",$(`${K}.${C}`,y,T+1)]},C))})]}):e.jsx("div",{className:"space-y-1",children:k.map(([C,y])=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-medium text-gray-600 min-w-[100px]",children:[C,":"]}),e.jsx("div",{className:"flex-1",children:$(`${K}.${C}`,y,T+1)})]},C))})}return e.jsx("span",{children:String(S)})};return e.jsxs("div",{className:"text-sm space-y-1 max-h-[500px] overflow-auto",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:N,className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",title:"Download as text file",children:[e.jsx(ds,{size:12})," Download"]})}),$("root",D)]})}function Ao({beforeImage:r,maskImage:d,onEnlarge:o}){return e.jsxs("div",{className:"relative w-40 h-40 cursor-pointer hover:ring-2 hover:ring-amber-400 rounded overflow-hidden border",onClick:()=>o(r,"Before with Mask"),children:[e.jsx("img",{src:r,alt:"Before",className:"w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 w-full h-full",style:{backgroundImage:`url(${d})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",mixBlendMode:"multiply",opacity:.5}}),e.jsx("img",{src:d,alt:"Mask overlay",className:"absolute inset-0 w-full h-full object-contain pointer-events-none",style:{mixBlendMode:"screen",opacity:.7,filter:"sepia(1) saturate(5) hue-rotate(-50deg)"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-[10px] text-center py-1 font-medium",children:"ðŸŽ¯ Edit Area"})]})}function Rs({retryHistory:r,totalAttempts:d,language:o,onRevertRepair:m,storyId:s,pageNumber:D}){const[h,N]=n.useState(null),[$,K]=n.useState({}),[S,T]=n.useState(new Set),v=async x=>{if(!(!s||D===void 0||S.has(x))){T(O=>new Set(O).add(x));try{const O=localStorage.getItem("auth_token"),be=new URLSearchParams({page:String(D),type:"retry",index:String(x)}),he=await fetch(`/api/stories/${s}/dev-image?${be}`,{headers:O?{Authorization:`Bearer ${O}`}:{}});if(he.ok){const A=await he.json();K(L=>({...L,[x]:{imageData:A.imageData,annotatedOriginal:A.annotatedOriginal,grids:A.grids,bboxOverlayImage:A.bboxOverlayImage}}))}}catch(O){console.error(`Failed to load retry images for retry ${x}:`,O)}finally{T(O=>{const be=new Set(O);return be.delete(x),be})}}};if(!r||r.length===0)return null;const k=r.filter(x=>x.type==="auto_repair"||x.type==="grid_repair"||x.type==="grid_repair_failed").length,C=r.filter(x=>x.type==="grid_repair"||x.type==="grid_repair_failed").length,y=r.filter(x=>x.type==="grid_repair_failed").length;return e.jsxs(e.Fragment,{children:[h&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>N(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:h.title}),e.jsx("img",{src:h.src,alt:h.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>N(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-purple-700 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(eo,{size:14}),o==="de"?"Generierungshistorie":o==="fr"?"Historique de gÃ©nÃ©ration":"Generation History",k>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["ðŸ”§ ",k," ",o==="de"?"Reparatur":"repair",k>1?o==="de"?"en":"s":"",C>0&&e.jsxs("span",{className:"ml-1",children:["(",C," grid",y>0?`, ${y} failed`:"",")"]})]})]}),e.jsxs("span",{className:"text-purple-600",children:[d," ",o==="de"?"Versuche":o==="fr"?"tentatives":"attempts"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:r.map((x,O)=>{var be,he;return e.jsxs("div",{className:`border rounded-lg p-3 ${x.type==="grid_repair_failed"?"bg-red-50 border-red-300":x.type==="grid_repair"?"bg-violet-50 border-violet-300":x.type==="auto_repair"?"bg-amber-50 border-amber-300":O===r.length-1?"bg-green-50 border-green-300":"bg-white border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[x.type==="grid_repair_failed"?e.jsx("span",{className:"text-red-700",children:"ðŸ”² Grid Repair Failed"}):x.type==="grid_repair"?e.jsx("span",{className:"text-violet-700",children:"ðŸ”² Grid Repair"}):x.type==="auto_repair"?e.jsx("span",{className:"text-amber-700",children:"ðŸ”§ Auto-Repair"}):e.jsx(e.Fragment,{children:o==="de"?`Versuch ${x.attempt}`:o==="fr"?`Tentative ${x.attempt}`:`Attempt ${x.attempt}`}),x.type==="text_edit"&&e.jsx("span",{className:"text-xs ml-2 text-blue-600",children:"(text edit)"}),x.type==="text_edit_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(text edit failed)"}),x.type==="auto_repair_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(auto-repair failed)"}),O===r.length-1&&x.type!=="auto_repair"&&e.jsx("span",{className:"text-xs ml-2 text-green-600 font-bold",children:"âœ“ USED"})]}),x.type==="auto_repair"&&x.preRepairScore!==void 0&&x.postRepairScore!==void 0?e.jsxs("span",{className:"font-bold text-sm",children:[e.jsxs("span",{className:x.preRepairScore>=70?"text-green-600":x.preRepairScore>=50?"text-yellow-600":"text-red-600",children:[x.preRepairScore,"%"]}),e.jsx("span",{className:"text-gray-400 mx-1",children:"â†’"}),e.jsxs("span",{className:x.postRepairScore>=70?"text-green-600":x.postRepairScore>=50?"text-yellow-600":"text-red-600",children:[x.postRepairScore,"%"]})]}):x.score!==void 0&&e.jsxs("span",{className:`font-bold ${x.score>=70?"text-green-600":x.score>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(x.score),"%"]})]}),x.error&&e.jsxs("div",{className:"text-xs text-red-600 mb-2",children:["Error: ",x.error]}),x.textIssue&&x.textIssue!=="NONE"&&e.jsxs("div",{className:"text-xs text-orange-600 mb-2",children:["Text issue: ",x.textIssue,x.expectedText&&e.jsxs("span",{className:"block",children:['Expected: "',x.expectedText,'"']}),x.actualText&&e.jsxs("span",{className:"block",children:['Actual: "',x.actualText,'"']})]}),x.type==="auto_repair"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[x.fixTargetsCount&&e.jsxs("div",{className:"text-xs text-amber-700",children:["Fixed ",x.fixTargetsCount," target",x.fixTargetsCount>1?"s":""]}),m&&((he=(be=x.repairDetails)==null?void 0:be[0])==null?void 0:he.beforeImage)&&x.postRepairScore!==void 0&&x.preRepairScore!==void 0&&x.postRepairScore<=x.preRepairScore&&e.jsxs("button",{onClick:()=>m(O,x.repairDetails[0].beforeImage),className:"text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded border border-red-300 transition-colors",children:["â†©ï¸ ",o==="de"?"ZurÃ¼cksetzen":"Revert to Original"]})]}),x.postRepairScore!==void 0&&x.preRepairScore!==void 0&&x.postRepairScore<x.preRepairScore&&e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200",children:["âš ï¸ ",o==="de"?`Bewertung verschlechtert: ${x.preRepairScore}% â†’ ${x.postRepairScore}%`:`Score decreased: ${x.preRepairScore}% â†’ ${x.postRepairScore}%`]}),x.bboxDetection&&Array.isArray(x.bboxDetection)&&x.bboxDetection.length>0&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900",children:["ðŸ“¦ ",o==="de"?"Bounding Box Erkennung":"Bounding Box Detection"," (",x.bboxDetection.length,")"]}),e.jsx("div",{className:"mt-3 space-y-2",children:x.bboxDetection.map((A,L)=>e.jsxs("div",{className:`p-3 rounded-lg border ${A.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:`font-medium text-sm ${A.success?"text-green-800":"text-red-800"}`,children:[A.success?"âœ“":"âœ—"," ",A.issue.substring(0,60),A.issue.length>60?"...":""]}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${A.severity==="CRITICAL"?"bg-red-200 text-red-800":A.severity==="MAJOR"?"bg-orange-200 text-orange-800":A.severity==="MODERATE"?"bg-yellow-200 text-yellow-800":"bg-gray-200 text-gray-800"}`,children:[A.severity," â€¢ ",A.type]})]}),A.success&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${A.faceBox?"bg-purple-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-purple-800",children:"Face Box:"}),A.faceBox?e.jsxs("span",{className:"ml-1 font-mono text-purple-600",children:["[",A.faceBox.map(de=>(de*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]}),e.jsxs("div",{className:`p-2 rounded ${A.bodyBox?"bg-blue-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Body Box:"}),A.bodyBox?e.jsxs("span",{className:"ml-1 font-mono text-blue-600",children:["[",A.bodyBox.map(de=>(de*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]})]}),A.label&&A.label!==A.issue&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Detected as:"})," ",A.label]}),A.usage&&e.jsxs("div",{className:"mt-1 text-xs text-gray-400",children:["Tokens: ",A.usage.input_tokens," in / ",A.usage.output_tokens," out"]})]},L))})]}),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ“Š ",o==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[x.preRepairScore,"%"]})]}),e.jsx(Za,{data:x.preRepairEval||x.reasoning,language:o,title:`evaluation-before-attempt-${O}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[x.postRepairScore,"%"]})]}),e.jsx(Za,{data:x.postRepairEval,language:o,title:`evaluation-after-attempt-${O}`})]})]})]}),x.repairDetails&&x.repairDetails.length>0&&e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ–¼ï¸ ",o==="de"?"Reparatur-Details":"Repair Details"," (",x.repairDetails.length,")"]}),e.jsx("div",{className:"mt-3 space-y-3",children:x.repairDetails.map((A,L)=>{var de,w;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("div",{className:"font-medium text-amber-800 text-base",children:A.description}),A.modelId&&e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded",children:A.modelId})]}),e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:["Show fix prompt",e.jsxs("button",{onClick:_=>{_.stopPropagation(),ua(A.fullPrompt||A.fixPrompt||"",`fix-prompt-${L}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(ds,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:A.fullPrompt||A.fixPrompt})]}),e.jsxs("div",{className:"flex gap-4 items-start",children:[A.beforeImage&&A.maskImage?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before + Mask"}),e.jsx(Ao,{beforeImage:A.beforeImage,maskImage:A.maskImage,onEnlarge:(_,j)=>N({src:_,title:j})})]}):A.beforeImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before"}),e.jsx("img",{src:A.beforeImage,alt:"Before",className:"w-32 h-32 object-contain border rounded cursor-pointer hover:ring-2 hover:ring-amber-400",onClick:()=>N({src:A.beforeImage,title:"Before Repair"})})]}),e.jsx("div",{className:"flex items-center h-32 text-gray-400 text-2xl",children:"â†’"}),A.afterImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"After"}),e.jsx("img",{src:A.afterImage,alt:"After",className:"w-32 h-32 object-contain border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>N({src:A.afterImage,title:"After Repair"})})]})]}),A.verification&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded border text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"ðŸ” Verification:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[A.verification.lpips&&e.jsxs("div",{className:`p-2 rounded ${A.verification.lpips.changed?"bg-green-100":"bg-yellow-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LPIPS: "}),e.jsx("span",{className:A.verification.lpips.changed?"text-green-700":"text-yellow-700",children:(de=A.verification.lpips.lpipsScore)==null?void 0:de.toFixed(4)}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",A.verification.lpips.changed?"âœ“ changed":"âš  unchanged",")"]})]}),A.verification.llm&&e.jsxs("div",{className:`p-2 rounded ${A.verification.llm.fixed?"bg-green-100":"bg-red-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LLM: "}),e.jsx("span",{className:A.verification.llm.fixed?"text-green-700":"text-red-700",children:A.verification.llm.fixed?"âœ“ Fixed":"âœ— Not fixed"}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",Math.round(A.verification.llm.confidence*100),"%)"]})]})]}),((w=A.verification.llm)==null?void 0:w.explanation)&&e.jsx("div",{className:"mt-2 text-gray-600 text-sm italic",children:A.verification.llm.explanation})]})]},L)})})]})]}),(x.type==="grid_repair"||x.type==="grid_repair_failed")&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[x.gridTotalIssues!==void 0&&e.jsxs("span",{className:"text-violet-700",children:[o==="de"?"Probleme:":"Issues:"," ",x.gridTotalIssues]}),x.gridFixedCount!==void 0&&e.jsxs("span",{className:"text-green-600",children:["âœ“ ",o==="de"?"Behoben:":"Fixed:"," ",x.gridFixedCount]}),x.gridFailedCount!==void 0&&x.gridFailedCount>0&&e.jsxs("span",{className:"text-red-600",children:["âœ— ",o==="de"?"Fehlgeschlagen:":"Failed:"," ",x.gridFailedCount]})]}),x.type==="grid_repair_failed"&&x.failReason&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-100 p-2 rounded border border-red-200",children:["âš ï¸ ",o==="de"?"Fehlergrund:":"Failure reason:"," ",x.failReason==="no_repairs_made"?o==="de"?"Keine Reparaturen durchgefÃ¼hrt":"No repairs were made":x.failReason==="no_image_data"?o==="de"?"Keine Bilddaten zurÃ¼ckgegeben":"No image data returned":x.failReason==="image_too_small"?o==="de"?"ZurÃ¼ckgegebenes Bild zu klein/ungÃ¼ltig":"Returned image too small/invalid":x.failReason==="image_unchanged"?o==="de"?"Bild wurde nicht verÃ¤ndert":"Image was not changed":x.failReason]}),(()=>{var L;const A=x.annotatedOriginal||((L=$[O])==null?void 0:L.annotatedOriginal);return A?e.jsxs("details",{className:"text-sm",open:!0,children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“ ",o==="de"?"Schritt 1: Erkannte Probleme":"Step 1: Detected Issues"]}),e.jsxs("div",{className:"mt-3 bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-2 font-medium",children:[o==="de"?"Originalbild mit markierten Problembereichen":"Original image with marked issue regions",e.jsxs("span",{className:"ml-2 text-gray-400",children:["(ðŸ”´ ",o==="de"?"kritisch":"critical",", ðŸŸ  ",o==="de"?"wichtig":"major",", ðŸŸ¡ ",o==="de"?"gering":"minor",")"]})]}),e.jsx("img",{src:`data:image/jpeg;base64,${A}`,alt:"Annotated original",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>N({src:`data:image/jpeg;base64,${A}`,title:o==="de"?"Erkannte Probleme":"Detected Issues"})})]})]}):x.hasAnnotatedOriginal&&s&&D!==void 0?e.jsx("button",{onClick:()=>v(O),disabled:S.has(O),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:S.has(O)?e.jsxs(e.Fragment,{children:[e.jsx(lt,{size:14,className:"animate-spin"})," Loading..."]}):e.jsx(e.Fragment,{children:"ðŸ“ Load Detected Issues"})}):null})(),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“Š ",o==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[x.preRepairScore,"%"]})]}),e.jsx(Za,{data:x.preRepairEval||x.reasoning,language:o,title:`evaluation-before-grid-${O}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[x.postRepairScore,"%"]})]}),e.jsx(Za,{data:x.postRepairEval,language:o,title:`evaluation-after-grid-${O}`})]})]})]}),(()=>{var L,de;const A=x.grids||((L=$[O])==null?void 0:L.grids);return A&&A.length>0?e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ”² ",o==="de"?"Grid-Details":"Grid Details"," (",A.length," ",A.length===1?"grid":"grids",")"]}),e.jsx("div",{className:"mt-3 space-y-4",children:A.map((w,_)=>{var j,ae;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("span",{className:"font-medium text-violet-800",children:["Grid"," ",w.batchNum||_+1]}),((j=w.manifest)==null?void 0:j.issues)&&e.jsxs("span",{className:"text-xs text-gray-500",children:[w.manifest.issues.length," ",o==="de"?"Regionen":"regions"]})]}),((ae=w.manifest)==null?void 0:ae.issues)&&w.manifest.issues.length>0&&e.jsxs("div",{className:"mb-3 p-2 bg-violet-50 rounded text-sm",children:[e.jsx("div",{className:"font-medium text-violet-800 mb-1",children:o==="de"?"Zu reparierende Probleme:":"Issues to repair:"}),e.jsx("div",{className:"space-y-1",children:w.manifest.issues.map((Z,$e)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-mono font-bold text-violet-600 min-w-[20px]",children:[Z.letter,":"]}),e.jsx("span",{className:"text-gray-700",children:Z.fixInstruction||Z.description||"Unknown issue"})]},$e))})]}),w.prompt&&e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:[o==="de"?"Reparatur-Prompt anzeigen":"Show repair prompt",e.jsxs("button",{onClick:Z=>{Z.stopPropagation(),ua(w.prompt||"",`grid-repair-prompt-${_}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(ds,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:w.prompt})]}),e.jsxs("div",{className:"flex gap-4 items-start flex-wrap",children:[w.original&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Original-Grid":"Input Grid"}),e.jsx("img",{src:w.original.startsWith("data:")?w.original:`data:image/png;base64,${w.original}`,alt:"Input grid",className:"max-w-xs border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>N({src:w.original.startsWith("data:")?w.original:`data:image/png;base64,${w.original}`,title:o==="de"?"Original-Grid":"Input Grid"})})]}),w.original&&w.repaired&&e.jsx("div",{className:"flex items-center self-center text-gray-400 text-2xl",children:"â†’"}),w.repaired&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Repariertes Grid":"Repaired Grid"}),e.jsx("img",{src:w.repaired.startsWith("data:")?w.repaired:`data:image/png;base64,${w.repaired}`,alt:"Repaired grid",className:"max-w-xs border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>N({src:w.repaired.startsWith("data:")?w.repaired:`data:image/png;base64,${w.repaired}`,title:o==="de"?"Repariertes Grid":"Repaired Grid"})})]})]}),w.repairs&&w.repairs.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"font-medium text-violet-800 mb-2",children:["âœ… ",o==="de"?"Verifizierungsergebnisse":"Verification Results"]}),e.jsx("div",{className:"space-y-2",children:w.repairs.map((Z,$e)=>{var Te,B,Se,W,X,Q,E,V,pe,J,oe,H;return e.jsxs("div",{className:`mb-3 p-3 rounded-lg border ${(Te=Z.verification)!=null&&Te.accepted?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:"font-mono font-bold text-xl text-violet-600 w-8",children:Z.letter}),e.jsxs("div",{className:"flex items-center gap-2",children:[Z.originalThumbnail&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:o==="de"?"Vorher":"Before"}),e.jsx("img",{src:`data:image/jpeg;base64,${Z.originalThumbnail}`,alt:"Before",className:"w-16 h-16 object-contain cursor-pointer hover:ring-2 hover:ring-violet-400 rounded border",onClick:()=>N({src:`data:image/jpeg;base64,${Z.originalThumbnail}`,title:`${Z.letter}: Before`})})]}),Z.repairedThumbnail&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:o==="de"?"Nachher":"After"}),e.jsx("img",{src:`data:image/jpeg;base64,${Z.repairedThumbnail}`,alt:"After",className:`w-16 h-16 object-contain cursor-pointer hover:ring-2 rounded border ${(B=Z.verification)!=null&&B.accepted?"border-green-300":"border-red-300"}`,onClick:()=>N({src:`data:image/jpeg;base64,${Z.repairedThumbnail}`,title:`${Z.letter}: After`})})]}),Z.diffImage&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Diff"}),e.jsx("img",{src:`data:image/jpeg;base64,${Z.diffImage}`,alt:"Diff",className:"w-16 h-16 object-contain cursor-pointer hover:ring-2 hover:ring-purple-400 rounded border",onClick:()=>N({src:`data:image/jpeg;base64,${Z.diffImage}`,title:`${Z.letter}: Diff`})})]})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-3",children:[e.jsx("span",{className:`text-2xl ${(Se=Z.verification)!=null&&Se.accepted?"text-green-600":"text-red-600"}`,children:(W=Z.verification)!=null&&W.accepted?"âœ“":"âœ—"}),e.jsxs("span",{className:`text-lg font-medium ${(((X=Z.verification)==null?void 0:X.confidence)??0)>=.7?"text-green-600":(((Q=Z.verification)==null?void 0:Q.confidence)??0)>=.5?"text-yellow-600":"text-red-600"}`,children:[Math.round((((E=Z.verification)==null?void 0:E.confidence)??0)*100),"%"]})]})]}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsx("span",{className:`inline-block px-2 py-0.5 rounded text-xs mr-2 ${Z.severity==="critical"?"bg-red-200 text-red-800":Z.severity==="major"?"bg-orange-200 text-orange-800":"bg-yellow-200 text-yellow-800"}`,children:Z.type||"unknown"}),e.jsx("span",{className:"text-gray-700",children:Z.description})]}),Z.fixInstruction&&e.jsxs("div",{className:"mt-1 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Fix:"})," ",Z.fixInstruction]}),(((V=Z.verification)==null?void 0:V.explanation)||((pe=Z.verification)==null?void 0:pe.reason))&&e.jsxs("div",{className:`mt-2 text-sm p-2 rounded ${(J=Z.verification)!=null&&J.accepted?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:[e.jsx("span",{className:"font-medium",children:o==="de"?"Ergebnis:":"Result:"})," ",((oe=Z.verification)==null?void 0:oe.explanation)||((H=Z.verification)==null?void 0:H.reason)]})]},$e)})})]})]},_)})})]}):x.hasGrids&&s&&D!==void 0&&!((de=$[O])!=null&&de.grids)?e.jsx("button",{onClick:()=>v(O),disabled:S.has(O),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:S.has(O)?e.jsxs(e.Fragment,{children:[e.jsx(lt,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ”² Load Grid Details (",x.gridsCount||"?"," grids)"]})}):null})()]}),x.type!=="auto_repair"&&x.type!=="grid_repair"&&x.type!=="grid_repair_failed"&&x.prompt&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¤ ",o==="de"?"Eingabe-Prompt":"Input Prompt",e.jsxs("button",{onClick:A=>{A.stopPropagation(),ua(x.prompt||"",`prompt-attempt-${x.attempt}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(ds,{size:10})," Download"]})]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-blue-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono border border-blue-200",children:x.prompt})]}),x.type!=="auto_repair"&&x.type!=="grid_repair"&&x.type!=="grid_repair_failed"&&x.reasoning?e.jsxs("details",{className:"text-sm text-gray-600 mb-2",children:[e.jsxs("summary",{className:"cursor-pointer font-medium",children:["ðŸ“¥ ",o==="de"?"Bewertungs-Feedback":"Evaluation Feedback"]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-gray-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono",children:x.reasoning})]}):x.type!=="auto_repair"&&x.type!=="grid_repair"&&x.type!=="grid_repair_failed"&&x.score===0&&e.jsx("div",{className:"text-sm text-gray-500 italic mb-2",children:o==="de"?"QualitÃ¤tsbewertung fehlgeschlagen":o==="fr"?"Ã‰valuation de qualitÃ© Ã©chouÃ©e":"Quality evaluation failed"}),(()=>{var L;if(x.type==="auto_repair"||x.type==="grid_repair"||x.type==="grid_repair_failed"||x.type==="bbox_detection_only")return null;const A=x.imageData||((L=$[O])==null?void 0:L.imageData);return A?e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Generiertes Bild":"Generated Image"}),e.jsx("img",{src:A,alt:`Attempt ${x.attempt}`,className:`w-48 h-48 object-contain rounded border cursor-pointer hover:ring-2 ${O===r.length-1?"border-green-300 hover:ring-green-400":"border-gray-200 opacity-75 hover:ring-gray-400"}`,onClick:()=>N({src:A,title:`${o==="de"?"Versuch":"Attempt"} ${x.attempt}`})})]}):x.type==="generation"&&s&&D!==void 0&&!$[O]?e.jsx("button",{onClick:()=>v(O),disabled:S.has(O),className:"mt-2 text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:S.has(O)?e.jsxs(e.Fragment,{children:[e.jsx(lt,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ–¼ï¸ ",o==="de"?"Bild laden":"Load Image"]})}):null})(),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(x.timestamp).toLocaleTimeString()})]},O)})})]})]})}function $o(r){if(!r||r.length===0)return{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1};const d=r.find(m=>m.type==="bbox_detection_only"&&m.bboxDetection)||r.find(m=>m.bboxDetection);if(!d)return{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1};const o=d.bboxDetection;return o&&typeof o=="object"&&"figures"in o?{bboxDetection:o,bboxOverlayImage:d.bboxOverlayImage||null,hasBboxOverlay:!!d.hasBboxOverlay||!!d.bboxOverlayImage}:{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1}}function Io(r,d){const o=new Blob([r],{type:"text/plain;charset=utf-8"}),m=URL.createObjectURL(o),s=document.createElement("a");s.href=m,s.download=d,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(m)}function da({retryHistory:r,bboxDetection:d,bboxOverlayImage:o,language:m,storyId:s,pageNumber:D,coverType:h}){var L,de;const[N,$]=n.useState(null),[K,S]=n.useState(null),[T,v]=n.useState(!1),k=$o(r),C=d||k.bboxDetection,y=o||k.bboxOverlayImage,x=!!o||k.hasBboxOverlay;if(!C)return null;const O=((L=C.figures)==null?void 0:L.length)||0,be=((de=C.objects)==null?void 0:de.length)||0,he=async()=>{if(!(!s||T)&&!(!h&&D===void 0)){v(!0);try{const w=localStorage.getItem("auth_token"),_=new URLSearchParams({field:"bboxOverlay"});if(h)_.set("cover",h);else{_.set("page",String(D)),_.set("type","retry");const ae=(r==null?void 0:r.findIndex(Z=>Z.type==="bbox_detection_only"&&Z.bboxDetection||Z.bboxDetection))??0;_.set("index",String(ae))}const j=await fetch(`/api/stories/${s}/dev-image?${_}`,{headers:w?{Authorization:`Bearer ${w}`}:{}});if(j.ok){const ae=await j.json();ae.bboxOverlayImage&&S(ae.bboxOverlayImage)}}catch(w){console.error("Failed to load bbox overlay:",w)}finally{v(!1)}}},A=y||K;return e.jsxs(e.Fragment,{children:[N&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>$(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:N.title}),e.jsx("img",{src:N.src,alt:N.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>$(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-blue-700 flex items-center justify-between",children:e.jsxs("span",{className:"flex items-center gap-2",children:["ðŸ“¦ ",m==="de"?"Objekterkennung":"Object Detection",e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:[O," ",m==="de"?"Figuren":"figures",","," ",be," ",m==="de"?"Objekte":"objects"]}),C.positionMismatches&&C.positionMismatches.length>0&&e.jsxs("span",{className:"text-xs bg-yellow-200 text-yellow-800 px-1.5 py-0.5 rounded",children:["âš ï¸ ",C.positionMismatches.length," ",m==="de"?"Abweichungen":"mismatches"]}),C.missingCharacters&&C.missingCharacters.length>0&&e.jsxs("span",{className:"text-xs bg-red-200 text-red-800 px-1.5 py-0.5 rounded",children:["âŒ ",C.missingCharacters.length," ",m==="de"?"Char fehlt":"char missing"]}),C.missingObjects&&C.missingObjects.length>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["âš ï¸ ",C.missingObjects.length," ",m==="de"?"Obj fehlt":"obj missing"]}),C.matchedObjects&&C.matchedObjects.length>0&&e.jsxs("span",{className:"text-xs bg-green-200 text-green-800 px-1.5 py-0.5 rounded",children:["âœ“ ",C.matchedObjects.length," ",m==="de"?"Obj gefunden":"obj matched"]})]})}),e.jsxs("div",{className:"mt-3 space-y-3",children:[A?e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:[m==="de"?"Erkannte Regionen":"Detected Regions",e.jsx("span",{className:"ml-2 text-gray-400",children:"(ðŸŸ¢ Body, ðŸ”µ Face, ðŸŸ  Object, ðŸŸ£ Matched)"})]}),e.jsx("img",{src:A,alt:"Bbox overlay",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-blue-400",onClick:()=>$({src:A,title:m==="de"?"Erkannte Regionen":"Detected Regions"})})]}):x&&s&&D!==void 0?e.jsx("button",{onClick:he,disabled:T,className:"text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:T?e.jsxs(e.Fragment,{children:[e.jsx(lt,{size:14,className:"animate-spin"})," ",m==="de"?"LÃ¤dt...":"Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ“¦ ",m==="de"?"Erkannte Regionen laden":"Load Detected Regions"]})}):null,C.expectedCharacters&&C.expectedCharacters.length>0&&e.jsxs("details",{className:"bg-violet-50 p-3 rounded border border-violet-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-violet-800",children:["ðŸ‘¥ ",m==="de"?"Erwartete Charaktere":"Expected Characters"," (",C.expectedCharacters.length,")"]}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2 text-sm",children:C.expectedCharacters.map((w,_)=>e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-violet-700",children:w.name}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:[w.description,w.position&&e.jsxs("span",{className:"ml-2 text-violet-500",children:["@ ",w.position]})]})]},_))})]}),C.expectedPositions&&Object.keys(C.expectedPositions).length>0&&e.jsxs("div",{className:"bg-purple-50 p-3 rounded border border-purple-200",children:[e.jsxs("div",{className:"font-medium text-purple-800 mb-2",children:["ðŸ“ ",m==="de"?"Erwartete Positionen":"Expected Positions"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:Object.entries(C.expectedPositions).map(([w,_])=>e.jsxs("div",{className:"bg-white p-2 rounded border flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-purple-700",children:w}),e.jsx("span",{className:"text-gray-600 text-xs",children:_})]},w))})]}),C.positionMismatches&&C.positionMismatches.length>0&&e.jsxs("div",{className:"bg-yellow-50 p-3 rounded border border-yellow-300",children:[e.jsxs("div",{className:"font-medium text-yellow-800 mb-2",children:["âš ï¸ ",m==="de"?"Positionsabweichungen":"Position Mismatches"," (",C.positionMismatches.length,")"]}),e.jsx("div",{className:"space-y-2",children:C.positionMismatches.map((w,_)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border border-yellow-200",children:[e.jsx("div",{className:"font-medium text-yellow-700",children:w.character}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1 flex gap-3",children:[e.jsxs("span",{children:[m==="de"?"Erwartet":"Expected",": ",e.jsx("span",{className:"font-medium text-purple-600",children:w.expected}),e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",w.expectedLCR,")"]})]}),e.jsx("span",{className:"text-gray-400",children:"â†’"}),e.jsxs("span",{children:[m==="de"?"Erkannt":"Actual",": ",e.jsx("span",{className:"font-medium text-orange-600",children:w.actual})]})]})]},_))})]}),C.missingCharacters&&C.missingCharacters.length>0&&e.jsxs("div",{className:"bg-red-50 p-3 rounded border border-red-300",children:[e.jsxs("div",{className:"font-medium text-red-800 mb-2",children:["âŒ ",m==="de"?"Fehlende Charaktere":"Missing Characters"," (",C.missingCharacters.length,")"]}),e.jsx("div",{className:"text-sm text-red-700",children:m==="de"?"Diese Charaktere wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These characters were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:C.missingCharacters.map((w,_)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-red-200 text-sm font-medium text-red-700",children:w},_))})]}),C.expectedObjects&&C.expectedObjects.length>0&&e.jsxs("div",{className:"bg-indigo-50 p-3 rounded border border-indigo-200",children:[e.jsxs("div",{className:"font-medium text-indigo-800 mb-2",children:["ðŸŽ¯ ",m==="de"?"Erwartete Objekte":"Expected Objects"," (",C.expectedObjects.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:C.expectedObjects.map((w,_)=>{var Z,$e;const j=(Z=C.matchedObjects)==null?void 0:Z.find(Te=>Te.expected===w),ae=($e=C.missingObjects)==null?void 0:$e.includes(w);return e.jsxs("div",{className:`bg-white p-2 rounded border flex justify-between items-center ${ae?"border-red-300":j?"border-green-300":""}`,children:[e.jsxs("span",{className:`font-medium ${ae?"text-red-600":j?"text-green-600":"text-indigo-700"}`,children:[ae?"âŒ":j?"âœ“":"â€¢"," ",w]}),j&&e.jsxs("span",{className:"text-xs text-gray-500 truncate ml-2",children:["â†’ ",j.matched]})]},_)})})]}),C.missingObjects&&C.missingObjects.length>0&&!C.expectedObjects&&e.jsxs("div",{className:"bg-amber-50 p-3 rounded border border-amber-300",children:[e.jsxs("div",{className:"font-medium text-amber-800 mb-2",children:["âš ï¸ ",m==="de"?"Fehlende Objekte":"Missing Objects"," (",C.missingObjects.length,")"]}),e.jsx("div",{className:"text-sm text-amber-700",children:m==="de"?"Diese Objekte wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These objects were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:C.missingObjects.map((w,_)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-amber-200 text-sm font-medium text-amber-700",children:w},_))})]}),C.figures&&C.figures.length>0&&e.jsxs("div",{className:"bg-green-50 p-3 rounded border border-green-200",children:[e.jsxs("div",{className:"font-medium text-green-800 mb-2",children:[m==="de"?"Figuren":"Figures"," (",C.figures.length,")",C.unknownFigures!==void 0&&C.unknownFigures>0&&e.jsxs("span",{className:"ml-2 text-xs bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded",children:[C.unknownFigures," ",m==="de"?"unbekannt":"unknown"]})]}),e.jsx("div",{className:"space-y-2",children:C.figures.map((w,_)=>{const j=w.name&&w.name!=="UNKNOWN",ae=w.confidence==="high"?"text-green-600":w.confidence==="medium"?"text-yellow-600":"text-orange-600",Z=w.confidence==="high"?"â˜…":w.confidence==="medium"?"â—†":"â—‹";return e.jsxs("div",{className:`text-sm bg-white p-2 rounded border ${j?"border-green-300":"border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:`font-medium ${j?"text-green-700":"text-gray-600"}`,children:j?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:ae,children:Z})," ",w.name]}):e.jsxs(e.Fragment,{children:["? ",w.label||`Figure ${_+1}`]})}),j&&w.confidence&&e.jsx("span",{className:`text-xs ${ae}`,children:w.confidence})]}),j&&w.label&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:w.label}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1 grid grid-cols-2 gap-2",children:[w.bodyBox&&e.jsxs("span",{children:["Body: [",w.bodyBox.map($e=>($e*100).toFixed(0)+"%").join(", "),"]"]}),w.faceBox&&e.jsxs("span",{children:["Face: [",w.faceBox.map($e=>($e*100).toFixed(0)+"%").join(", "),"]"]}),w.position&&e.jsxs("span",{children:["Pos: ",w.position]})]})]},_)})})]}),C.objects&&C.objects.length>0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsxs("div",{className:"font-medium text-orange-800 mb-2",children:[m==="de"?"Objekte":"Objects"," (",C.objects.length,")"]}),e.jsx("div",{className:"space-y-2",children:C.objects.map((w,_)=>{const j=!!w.name,ae=w.found!==!1;return e.jsxs("div",{className:`text-sm bg-white p-2 rounded border ${j&&ae?"border-green-300":j&&!ae?"border-red-300":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:`font-medium ${j&&ae?"text-green-700":j&&!ae?"text-red-600":"text-orange-700"}`,children:j?e.jsxs(e.Fragment,{children:[ae?"âœ“":"âœ—"," ",w.name]}):w.label||`Object ${_+1}`}),j&&e.jsx("span",{className:`text-xs ${ae?"text-green-600":"text-red-600"}`,children:ae?m==="de"?"gefunden":"found":m==="de"?"fehlt":"missing"})]}),j&&w.label&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:w.label}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[w.bodyBox&&e.jsxs("span",{children:["Box: [",w.bodyBox.map(Z=>(Z*100).toFixed(0)+"%").join(", "),"]"]}),w.position&&e.jsxs("span",{className:"ml-2",children:["Pos: ",w.position]})]})]},_)})})]}),C.characterDescriptions&&Object.keys(C.characterDescriptions).length>0&&e.jsxs("details",{className:"bg-cyan-50 p-3 rounded border border-cyan-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-cyan-800",children:["ðŸ‘¤ ",m==="de"?"Charakter-Beschreibungen":"Character Descriptions"," (",Object.keys(C.characterDescriptions).length,")"]}),e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2 text-sm",children:Object.entries(C.characterDescriptions).map(([w,_])=>e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("span",{className:"font-medium text-cyan-700",children:w}),e.jsxs("span",{className:"text-gray-600 ml-2",children:[_.genderTerm||_.gender||"?",", ",_.age?`${_.age}y`:"?",_.isChild?" (child)":_.isChild===!1?" (adult)":""]})]},w))})]}),C.rawPrompt&&e.jsxs("details",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-gray-700",children:["ðŸ“ ",m==="de"?"Bbox-Prompt":"Bbox Prompt"]}),e.jsx("pre",{className:"mt-2 text-xs bg-white p-2 rounded border overflow-x-auto whitespace-pre-wrap max-h-48 overflow-y-auto",children:C.rawPrompt})]}),C.rawResponse&&e.jsxs("details",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-gray-700",children:["ðŸ“¤ ",m==="de"?"Bbox-Antwort":"Bbox Response"]}),e.jsx("pre",{className:"mt-2 text-xs bg-white p-2 rounded border overflow-x-auto whitespace-pre-wrap max-h-64 overflow-y-auto",children:C.rawResponse})]}),e.jsxs("button",{onClick:()=>Io(JSON.stringify(C,null,2),`object-detection-page-${D}.json`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",children:[e.jsx(ds,{size:12})," ",m==="de"?"JSON herunterladen":"Download JSON"]})]})]})]})}function To({src:r,alt:d,onClose:o}){const[m,s]=n.useState(1),[D,h]=n.useState({x:0,y:0}),[N,$]=n.useState(!1),[K,S]=n.useState({x:0,y:0}),T=n.useRef(null),v=.5,k=5,C=.2,y=n.useCallback(()=>{s(1),h({x:0,y:0})},[]),x=n.useCallback(j=>{j.key==="Escape"&&o()},[o]);n.useEffect(()=>(r&&(y(),document.addEventListener("keydown",x),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",x),document.body.style.overflow="unset"}),[r,x,y]);const O=n.useCallback(j=>{j.preventDefault();const ae=j.deltaY>0?-C:C;s(Z=>Math.min(k,Math.max(v,Z+ae)))},[]),be=n.useCallback(j=>{m>1&&(j.preventDefault(),$(!0),S({x:j.clientX-D.x,y:j.clientY-D.y}))},[m,D]),he=n.useCallback(j=>{N&&m>1&&h({x:j.clientX-K.x,y:j.clientY-K.y})},[N,K,m]),A=n.useCallback(()=>{$(!1)},[]),L=n.useCallback(j=>{j.stopPropagation(),y()},[y]),de=n.useCallback(j=>{j.target===T.current&&m===1&&o()},[o,m]),w=n.useCallback(()=>{s(j=>Math.min(k,j+C*2))},[]),_=n.useCallback(()=>{s(j=>Math.max(v,j-C*2))},[]);return r?e.jsxs("div",{ref:T,className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm",onClick:de,onMouseMove:he,onMouseUp:A,onMouseLeave:A,children:[e.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-2 z-10",children:[e.jsx("button",{onClick:_,className:"p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors","aria-label":"Zoom out",title:"Zoom out",children:e.jsx(vo,{size:20})}),e.jsxs("span",{className:"px-2 py-1 rounded bg-black/50 text-white text-sm min-w-[60px] text-center",children:[Math.round(m*100),"%"]}),e.jsx("button",{onClick:w,className:"p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors","aria-label":"Zoom in",title:"Zoom in",children:e.jsx(yo,{size:20})}),e.jsx("button",{onClick:y,className:"p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors","aria-label":"Reset zoom",title:"Reset zoom (or double-click)",children:e.jsx(ma,{size:20})}),e.jsx("button",{onClick:o,className:"p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors ml-2","aria-label":"Close",title:"Close (Esc)",children:e.jsx(qt,{size:24})})]}),e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-full bg-black/50 text-white/70 text-xs z-10",children:"Scroll to zoom â€¢ Drag to pan â€¢ Double-click to reset"}),e.jsx("div",{className:"w-full h-full flex items-center justify-center overflow-hidden",onWheel:O,children:e.jsx("img",{src:r,alt:d||"Enlarged image",className:"max-w-[98vw] max-h-[96vh] object-contain rounded-lg shadow-2xl select-none",style:{transform:`translate(${D.x}px, ${D.y}px) scale(${m})`,cursor:m>1?N?"grabbing":"grab":"default",transition:N?"none":"transform 0.1s ease-out"},onMouseDown:be,onDoubleClick:L,draggable:!1})})]}):null}function ca({referencePhotos:r,landmarkPhotos:d,visualBibleGrid:o,language:m,storyId:s,pageNumber:D}){var Te;const[h,N]=n.useState(null),[$,K]=n.useState(null),[S,T]=n.useState(null),[v,k]=n.useState(!1),[C,y]=n.useState(null),x=r==null?void 0:r.some(B=>B.hasPhoto&&!B.photoUrl),O=d==null?void 0:d.some(B=>B.hasPhoto&&!B.photoData),be=n.useCallback(async()=>{if(!(!s||!D||v)&&!(!x&&!O)){k(!0),y(null);try{if(x){const B=await Le.getDevImage(s,D,"reference");B!=null&&B.referencePhotos&&K(B.referencePhotos)}if(O){const B=await Le.getDevImage(s,D,"landmark");B!=null&&B.landmarkPhotos&&T(B.landmarkPhotos)}}catch(B){y(B instanceof Error?B.message:"Failed to load images")}finally{k(!1)}}},[s,D,v,x,O]),he=$||r,A=S||d,L=he&&he.length>0,de=A&&A.length>0,w=!!o;if(!L&&!de&&!w)return null;const _=((r==null?void 0:r.length)||0)+((d==null?void 0:d.length)||0)+(w?1:0),j=B=>{switch(B){case"bodyNoBg":case"body-no-bg":return m==="de"?"GanzkÃ¶rper (freigestellt)":m==="fr"?"Corps entier (dÃ©tourÃ©)":"Full body (no bg)";case"body":return m==="de"?"GanzkÃ¶rper":m==="fr"?"Corps entier":"Full body";case"face":return m==="de"?"Gesicht":m==="fr"?"Visage":"Face only";case"clothing-winter":return m==="de"?"Winter-Avatar":m==="fr"?"Avatar hiver":"Winter avatar";case"clothing-summer":return m==="de"?"Sommer-Avatar":m==="fr"?"Avatar Ã©tÃ©":"Summer avatar";case"clothing-formal":return m==="de"?"Formell-Avatar":m==="fr"?"Avatar formel":"Formal avatar";case"clothing-standard":return m==="de"?"Standard-Avatar":m==="fr"?"Avatar standard":"Standard avatar";case"none":return m==="de"?"Kein Foto":m==="fr"?"Pas de photo":"No photo";default:return B}},ae=B=>{switch(B){case"bodyNoBg":case"body-no-bg":return"bg-green-100 text-green-700 border-green-300";case"body":return"bg-blue-100 text-blue-700 border-blue-300";case"face":return"bg-yellow-100 text-yellow-700 border-yellow-300";case"clothing-winter":return"bg-cyan-100 text-cyan-700 border-cyan-300";case"clothing-summer":return"bg-orange-100 text-orange-700 border-orange-300";case"clothing-formal":return"bg-purple-100 text-purple-700 border-purple-300";case"clothing-standard":return"bg-teal-100 text-teal-700 border-teal-300";case"none":return"bg-red-100 text-red-700 border-red-300";default:return"bg-gray-100 text-gray-700 border-gray-300"}},Z=(Te=he==null?void 0:he.find(B=>B.clothingCategory))==null?void 0:Te.clothingCategory,$e=B=>{if(!B)return"";switch(B){case"winter":return m==="de"?"Winter":m==="fr"?"Hiver":"Winter";case"summer":return m==="de"?"Sommer":m==="fr"?"Ã‰tÃ©":"Summer";case"formal":return m==="de"?"Formell":m==="fr"?"Formel":"Formal";case"standard":return"Standard";default:return B}};return e.jsxs("details",{className:"bg-pink-50 border border-pink-300 rounded-lg p-3",onToggle:B=>{B.target.open&&(x||O)&&be()},children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-900 flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ“¸"}),m==="de"?"Referenzfotos":m==="fr"?"Photos de rÃ©fÃ©rence":"Reference Photos",e.jsxs("span",{className:"text-xs text-pink-600",children:["(",_,")"]}),Z&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-pink-200 text-pink-800 text-xs rounded",children:["ðŸ‘• ",$e(Z)]}),de&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded",children:["ðŸ“ ",A.length," ",m==="de"?"Wahrzeichen":"Landmark"]}),w&&e.jsx("span",{className:"ml-2 px-2 py-0.5 bg-indigo-200 text-indigo-800 text-xs rounded",children:"ðŸ”² VB Grid"}),v&&e.jsx("span",{className:"ml-2 text-xs text-gray-500 animate-pulse",children:"Loading..."})]}),C&&e.jsx("div",{className:"mt-3 text-sm text-red-600 bg-red-50 p-2 rounded",children:C}),L&&e.jsx("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2",children:he.map((B,Se)=>e.jsxs("div",{className:"bg-white rounded-lg p-2 border border-pink-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:B.name}),B.photoType&&e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap ${ae(B.photoType)}`,children:j(B.photoType)})]}),B.photoUrl?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:B.photoUrl,alt:`${B.name} - ${j(B.photoType||"unknown")}`,className:`w-full max-h-32 object-contain rounded border bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity ${B.isStyled?"border-purple-400 ring-2 ring-purple-200":"border-gray-200"}`,onClick:()=>N(B.photoUrl),title:"Click to enlarge"}),B.isStyled&&e.jsx("span",{className:"absolute top-1 right-1 px-1 py-0.5 text-[9px] font-bold bg-purple-500 text-white rounded",children:"ðŸŽ¨ STYLED"})]}),B.photoHash&&e.jsxs("div",{className:"mt-1 text-[9px] font-mono text-gray-500 bg-gray-100 px-1 py-0.5 rounded text-center",children:["ðŸ” ",B.photoHash]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:m==="de"?"Foto nicht geladen":"Photo not loaded"})]},Se))}),de&&e.jsxs("div",{className:L?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-amber-700 mb-2 flex items-center gap-1",children:["ðŸ“ ",m==="de"?"Wahrzeichen-Referenzfotos":m==="fr"?"Photos de monuments":"Landmark Reference Photos"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:A.map((B,Se)=>e.jsxs("div",{className:"bg-amber-50 rounded-lg p-2 border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:B.name}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-amber-100 text-amber-700 border-amber-300",children:"ðŸ“ LANDMARK"})]}),B.photoData?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:B.photoData,alt:`${B.name} landmark`,className:"w-full max-h-32 object-contain rounded border border-amber-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>N(B.photoData),title:"Click to enlarge"})}),B.attribution&&e.jsxs("div",{className:"mt-1 text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 rounded truncate",title:B.attribution,children:["ðŸ“· ",B.attribution]}),B.source&&e.jsxs("div",{className:"mt-0.5 text-[9px] text-gray-400",children:["Source: ",B.source]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:m==="de"?"Foto nicht geladen":"Photo not loaded"})]},Se))})]}),w&&e.jsxs("div",{className:L||de?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-indigo-700 mb-2 flex items-center gap-1",children:["ðŸ”² ",m==="de"?"Visual Bible Referenzgitter":m==="fr"?"Grille Visual Bible":"Visual Bible Reference Grid"]}),e.jsxs("div",{className:"bg-indigo-50 rounded-lg p-2 border border-indigo-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800",children:m==="de"?"Kombinierte Referenzen":m==="fr"?"RÃ©fÃ©rences combinÃ©es":"Combined References"}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-indigo-100 text-indigo-700 border-indigo-300",children:"ðŸ”² VB GRID"})]}),e.jsx("div",{className:"text-[10px] text-gray-500 mb-2",children:m==="de"?"SekundÃ¤re Charaktere, Tiere, Artefakte, Fahrzeuge und zusÃ¤tzliche Wahrzeichen":m==="fr"?"Personnages secondaires, animaux, artefacts, vÃ©hicules et monuments supplÃ©mentaires":"Secondary characters, animals, artifacts, vehicles, and additional landmarks"}),e.jsx("img",{src:o,alt:"Visual Bible Reference Grid",className:"w-full max-h-64 object-contain rounded border border-indigo-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>N(o),title:"Click to enlarge"})]})]}),e.jsx(To,{src:h,onClose:()=>N(null)})]})}function Ro({pageNumber:r,scene:d,onSceneChange:o,onClose:m,onRegenerate:s,isRegenerating:D,imageRegenerationCost:h,characters:N=[],selectedCharacterIds:$=[],onCharacterSelectionChange:K,consistencyRegen:S}){const{language:T}=br(),[v,k]=n.useState(!1),[C,y]=n.useState(!1),x=O=>{K&&($.includes(O)?K($.filter(be=>be!==O)):K([...$,O]))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(kt,{size:20}),T==="de"?`Szene bearbeiten - Seite ${r}`:T==="fr"?`Modifier la scÃ¨ne - Page ${r}`:`Edit Scene - Page ${r}`]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:T==="de"?"Bearbeiten Sie die Szenenbeschreibung und wÃ¤hlen Sie die Charaktere aus.":T==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages.":"Edit the scene description and select the characters."})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[N.length>0&&K&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(Es,{size:16}),T==="de"?"Charaktere in dieser Szene:":T==="fr"?"Personnages dans cette scÃ¨ne:":"Characters in this scene:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:N.map(O=>{const be=$.includes(O.id);return e.jsxs("button",{type:"button",onClick:()=>x(O.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${be?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:O.name}),be&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},O.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:T==="de"?"WÃ¤hlen Sie die Charaktere aus, die im Bild erscheinen sollen.":T==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre dans l'image.":"Select the characters that should appear in the image."})]}),S&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Nn,{className:"text-amber-600",size:20}),e.jsx("h4",{className:"font-semibold text-amber-800",children:T==="de"?"Konsistenz-Korrektur angewendet":T==="fr"?"Correction de cohÃ©rence appliquÃ©e":"Consistency Fix Applied"}),e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded",children:["Score: ",S.score,"%"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-amber-700 mb-2",children:T==="de"?"Behobene Probleme:":T==="fr"?"ProblÃ¨mes corrigÃ©s:":"Issues Fixed:"}),e.jsx("ul",{className:"text-sm text-amber-900 space-y-1",children:S.issues.map((O,be)=>e.jsxs("li",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium",children:[O.type.toUpperCase(),O.characterInvolved&&` (${O.characterInvolved})`,":"]}),e.jsx("span",{className:"text-amber-700 ml-2",children:O.description}),e.jsxs("span",{className:"text-amber-600 ml-2 text-xs",children:["â†’ ",O.recommendation]})]},be))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-1 text-center",children:"Original"}),e.jsx("img",{src:S.originalImage,alt:"Original",className:"w-full rounded-lg border border-gray-300",draggable:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-green-600 mb-1 text-center",children:T==="de"?"Korrigiert":T==="fr"?"CorrigÃ©":"Fixed"}),e.jsx("img",{src:S.fixedImage,alt:"Fixed",className:"w-full rounded-lg border-2 border-green-500",draggable:!1})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>k(!v),className:"flex items-center gap-1 text-xs text-gray-600 hover:text-gray-800",children:[v?e.jsx(On,{size:14}):e.jsx(Ut,{size:14}),T==="de"?"Original-Prompt":T==="fr"?"Prompt original":"Original Prompt"]}),v&&e.jsx("pre",{className:"text-xs bg-gray-100 p-2 rounded overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:S.originalPrompt}),e.jsxs("button",{onClick:()=>y(!C),className:"flex items-center gap-1 text-xs text-green-600 hover:text-green-800",children:[C?e.jsx(On,{size:14}):e.jsx(Ut,{size:14}),T==="de"?"Korrigierter Prompt (mit Korrekturen)":T==="fr"?"Prompt corrigÃ© (avec corrections)":"Fixed Prompt (with corrections)"]}),C&&e.jsx("pre",{className:"text-xs bg-green-50 p-2 rounded border border-green-200 overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:S.fixedPrompt})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:T==="de"?`Korrigiert am ${new Date(S.timestamp).toLocaleString()}`:T==="fr"?`CorrigÃ© le ${new Date(S.timestamp).toLocaleString()}`:`Fixed at ${new Date(S.timestamp).toLocaleString()}`}),S.clothing&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded",children:["ðŸŽ¨ ",S.clothing]})]}),S.avatarsUsed&&S.avatarsUsed.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-blue-50 rounded border border-blue-200",children:[e.jsx("p",{className:"text-xs font-medium text-blue-700 mb-1",children:T==="de"?"Verwendete Avatare:":T==="fr"?"Avatars utilisÃ©s:":"Avatars used:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:S.avatarsUsed.map((O,be)=>e.jsxs("span",{className:`text-xs px-2 py-1 rounded ${O.hasPhoto?"bg-green-100 text-green-700":"bg-gray-100 text-gray-500"}`,children:[O.name,O.category&&O.category!=="standard"&&e.jsxs("span",{className:"ml-1 opacity-75",children:["(",O.category,")"]}),!O.hasPhoto&&" âš ï¸"]},be))})]}),S.retryHistory&&S.retryHistory.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx(Rs,{retryHistory:S.retryHistory,totalAttempts:S.totalAttempts||1,language:T})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:T==="de"?"Szenenbeschreibung:":T==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:d,onChange:O=>o(O.target.value),className:"w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y",placeholder:T==="de"?"Beschreiben Sie die Szene...":T==="fr"?"DÃ©crivez la scÃ¨ne...":"Describe the scene..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:T==="de"?"Tipp: Beschreiben Sie die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":T==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:$.length>0&&e.jsx("span",{children:T==="de"?`${$.length} Charakter(e) ausgewÃ¤hlt`:T==="fr"?`${$.length} personnage(s) sÃ©lectionnÃ©(s)`:`${$.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:m,disabled:D,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium disabled:opacity-50 order-2 sm:order-1",children:T==="de"?"Abbrechen":T==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:s,disabled:D||!d.trim(),className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${D||!d.trim()?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:D?e.jsxs(e.Fragment,{children:[e.jsx(ar,{size:16,className:"animate-spin"}),T==="de"?"Generiere...":T==="fr"?"GÃ©nÃ©ration...":"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ar,{size:16}),T==="de"?"Neu generieren":T==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",h,")"]})]})})]})]})]})})}function Do({pageNumber:r,versions:d,onClose:o,onSelectVersion:m,developerMode:s=!1}){const{language:D}=br();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(ls,{size:20}),D==="de"?`Bildversionen - Seite ${r}`:D==="fr"?`Versions d'image - Page ${r}`:`Image Versions - Page ${r}`]}),e.jsx("button",{onClick:o,className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(qt,{size:20})})]}),e.jsxs("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:d.map((h,N)=>e.jsxs("div",{className:`relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${h.isActive?"border-green-500 ring-2 ring-green-200":"border-gray-200 hover:border-indigo-300"}`,onClick:()=>m(r,N),children:[e.jsx("img",{src:h.imageData,alt:`Version ${N+1}`,className:"w-full aspect-square object-cover"}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:N===0?"Original":`V${N+1}`}),h.isActive&&e.jsx("span",{className:"bg-green-500 px-2 py-0.5 rounded text-[10px] font-bold",children:D==="de"?"Aktiv":D==="fr"?"Actif":"Active"})]}),e.jsx("div",{className:"text-[10px] text-gray-300 mt-1",children:new Date(h.createdAt).toLocaleDateString()})]})]},N))}),s&&d.length>1&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold text-gray-700",children:D==="de"?"Szenen- und Prompt-Vergleich":D==="fr"?"Comparaison de scÃ¨nes et prompts":"Scene & Prompt Comparison"}),d.map((h,N)=>e.jsxs("details",{className:`rounded-lg p-3 ${h.isActive?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-medium text-gray-700",children:[N===0?"Original":`V${N+1}`,h.isActive&&e.jsx("span",{className:"ml-2 text-green-600 text-xs",children:"(Active)"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[h.userInput&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-purple-700",children:D==="de"?"Benutzer-Eingabe:":D==="fr"?"EntrÃ©e utilisateur:":"User Input:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-purple-50 p-2 rounded border border-purple-200 max-h-24 overflow-y-auto",children:h.userInput})]}),h.description&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700",children:D==="de"?"Erweiterte Szene:":D==="fr"?"ScÃ¨ne Ã©tendue:":"Expanded Scene:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-24 overflow-y-auto",children:h.description})]}),h.prompt&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-700",children:D==="de"?"API-Prompt:":D==="fr"?"Prompt API:":"API Prompt:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-32 overflow-y-auto",children:h.prompt})]}),h.modelId&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Model: ",h.modelId]})]})]},N))]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-sm text-gray-500",children:D==="de"?"Klicken Sie auf ein Bild, um es auszuwÃ¤hlen":D==="fr"?"Cliquez sur une image pour la sÃ©lectionner":"Click an image to select it"})]})})}function Fo({src:r,title:d,onClose:o}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:o,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-2 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:d}),e.jsx("button",{onClick:o,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(qt,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50",children:e.jsx("img",{src:r,alt:d,className:"max-w-full max-h-[80vh] object-contain mx-auto"})})]})})}function Eo({beforeImage:r,afterImage:d,diffImage:o,title:m,onClose:s}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:s,children:e.jsxs("div",{className:"relative bg-white rounded-lg overflow-hidden max-w-[95vw] max-h-[95vh]",onClick:D=>D.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:m}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(qt,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50 overflow-auto max-h-[calc(95vh-60px)]",children:e.jsxs("div",{className:`grid gap-4 ${o?"grid-cols-1 lg:grid-cols-3":"grid-cols-1 lg:grid-cols-2"}`,children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-red-100 px-3 py-1 rounded-full",children:"Before"}),e.jsx("img",{src:r,alt:"Before repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-green-100 px-3 py-1 rounded-full",children:"After"}),e.jsx("img",{src:d,alt:"After repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),o&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-purple-100 px-3 py-1 rounded-full",children:"Diff (changes in magenta)"}),e.jsx("img",{src:o,alt:"Difference",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]})]})})]})})}const Un={en:{adventure:"Adventure","life-challenge":"Life Challenge",educational:"Educational",historical:"Historical"},de:{adventure:"Abenteuer","life-challenge":"Lebensherausforderung",educational:"Bildung",historical:"Historisch"},fr:{adventure:"Aventure","life-challenge":"DÃ©fi de vie",educational:"Ã‰ducatif",historical:"Historique"}},Kn={en:{"1st-grade":"Picture Book (1st Grade)",standard:"Standard",advanced:"Advanced"},de:{"1st-grade":"Bilderbuch (1. Klasse)",standard:"Standard",advanced:"Fortgeschritten"},fr:{"1st-grade":"Livre illustrÃ© (1Ã¨re annÃ©e)",standard:"Standard",advanced:"AvancÃ©"}},zo={"de-CH":"Schweizerdeutsch","de-DE":"Deutsch (Deutschland)",en:"English",fr:"FranÃ§ais"};function Bo({settings:r,language:d}){var k,C;const[o,m]=n.useState(!1),s=y=>{const x={en:{title:"Story Info",category:"Category",topic:"Topic",theme:"Theme",storyType:"Story Type",storyDetails:"Story Idea",artStyle:"Art Style",language:"Language",readingLevel:"Reading Level",pages:"Length",dedication:"Dedication",mainCharacters:"Main Characters",otherCharacters:"Other Characters",relationships:"Relationships",season:"Season",location:"Location",noData:"Not specified",spring:"Spring",summer:"Summer",autumn:"Autumn",winter:"Winter"},de:{title:"Story-Info",category:"Kategorie",topic:"Thema",theme:"Thema",storyType:"Story-Typ",storyDetails:"Story-Idee",artStyle:"Kunststil",language:"Sprache",readingLevel:"Lesestufe",pages:"LÃ¤nge",dedication:"Widmung",mainCharacters:"Hauptfiguren",otherCharacters:"Andere Figuren",relationships:"Beziehungen",season:"Jahreszeit",location:"Ort",noData:"Nicht angegeben",spring:"FrÃ¼hling",summer:"Sommer",autumn:"Herbst",winter:"Winter"},fr:{title:"Info histoire",category:"CatÃ©gorie",topic:"Sujet",theme:"ThÃ¨me",storyType:"Type d'histoire",storyDetails:"IdÃ©e d'histoire",artStyle:"Style artistique",language:"Langue",readingLevel:"Niveau de lecture",pages:"Longueur",dedication:"DÃ©dicace",mainCharacters:"Personnages principaux",otherCharacters:"Autres personnages",relationships:"Relations",season:"Saison",location:"Lieu",noData:"Non spÃ©cifiÃ©",spring:"Printemps",summer:"Ã‰tÃ©",autumn:"Automne",winter:"Hiver"}};return(x[d]||x.en)[y]||y},D=y=>(Un[d]||Un.en)[y]||y,h=y=>(Kn[d]||Kn.en)[y]||y,N=(y,x)=>y==null||y===""?e.jsx("span",{className:"text-gray-400 italic",children:s("noData")}):e.jsx("span",{className:"text-gray-800",children:y}),$=r.mainCharacters||[],K=((k=r.characters)==null?void 0:k.filter(y=>$.includes(y.id)))||[],S=((C=r.characters)==null?void 0:C.filter(y=>!$.includes(y.id)))||[],T=y=>s(y)||y,v=()=>{if(!r.userLocation)return null;const y=[r.userLocation.city,r.userLocation.region,r.userLocation.country].filter(Boolean);return y.length>0?y.join(", "):null};return e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>m(!o),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-amber-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qi,{size:16,className:"text-amber-600"}),e.jsx("span",{className:"font-medium text-amber-800",children:s("title")}),e.jsx("span",{className:"text-xs bg-amber-200 text-amber-700 px-2 py-0.5 rounded",children:"DEV"})]}),o?e.jsx(Ut,{size:18,className:"text-amber-600"}):e.jsx(zs,{size:18,className:"text-amber-600"})]}),o&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[K.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(xn,{size:12}),s("mainCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:K.map(y=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800 border border-indigo-200",children:[e.jsx(xn,{size:10}),e.jsx("span",{children:y.name})]},y.id))})]}),S.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(Es,{size:12}),s("otherCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(y=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-200",children:[e.jsx(xn,{size:10}),e.jsx("span",{children:y.name})]},y.id))})]}),r.relationships&&Object.keys(r.relationships).length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-2",children:s("relationships")}),e.jsx("div",{className:"text-xs bg-white/50 p-2 rounded border border-amber-100 space-y-1",children:Object.entries(r.relationships).map(([y,x])=>{var L,de;const[O,be]=y.split("-").map(w=>parseInt(w,10)),he=(L=r.characters)==null?void 0:L.find(w=>w.id===O),A=(de=r.characters)==null?void 0:de.find(w=>w.id===be);return!he||!A?null:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-amber-600 font-medium whitespace-nowrap",children:[he.name," â†’ ",A.name,":"]}),e.jsx("span",{className:"text-gray-700",children:x})]},y)})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(oo,{size:12}),s("language")]}),e.jsx("div",{className:"text-sm",children:r.language?zo[r.language]||r.language:N(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("readingLevel")}),e.jsx("div",{className:"text-sm",children:r.languageLevel?h(r.languageLevel):N(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("pages")}),e.jsx("div",{className:"text-sm",children:r.pages?`${r.pages} ${d==="de"?"Seiten":"pages"}`:N(void 0)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("season")}),e.jsx("div",{className:"text-sm",children:r.season?T(r.season):N(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("location")}),e.jsx("div",{className:"text-sm",children:v()||N(void 0)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(oi,{size:12}),s("artStyle")]}),e.jsx("div",{className:"text-sm capitalize",children:N(r.artStyle)})]})]}),r.storyDetails&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Ts,{size:12}),s("storyDetails")]}),e.jsx("div",{className:"text-sm bg-white/50 p-2 rounded border border-amber-100 whitespace-pre-wrap",children:r.storyDetails})]}),(r.storyCategory||r.storyTheme||r.storyTopic)&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-amber-100",children:[r.storyCategory&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(ro,{size:12}),s("category")]}),e.jsx("div",{className:"text-sm",children:D(r.storyCategory)})]}),(r.storyTheme||r.storyTopic)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:r.storyCategory==="adventure"?s("theme"):s("topic")}),e.jsx("div",{className:"text-sm",children:r.storyCategory==="adventure"?r.storyTheme:r.storyTopic})]})]})]})]})}function Mo({storyId:r,onShareStatusChange:d,variant:o="compact"}){const{language:m}=br(),[s,D]=n.useState(!1),[h,N]=n.useState(null),[$,K]=n.useState(!1),[S,T]=n.useState(!1),[v,k]=n.useState(null),C=o==="full",y={share:m==="de"?"Teilen":m==="fr"?"Partager":"Share",shareStory:m==="de"?"Geschichte teilen":m==="fr"?"Partager l'histoire":"Share Story",enableSharing:m==="de"?"Link aktivieren":m==="fr"?"Activer le lien":"Enable sharing",disableSharing:m==="de"?"Link deaktivieren":m==="fr"?"DÃ©sactiver le lien":"Disable sharing",copyLink:m==="de"?"Link kopieren":m==="fr"?"Copier le lien":"Copy link",copied:m==="de"?"Kopiert!":m==="fr"?"CopiÃ©!":"Copied!",shareWhatsApp:m==="de"?"Per WhatsApp teilen":m==="fr"?"Partager sur WhatsApp":"Share on WhatsApp",sharingEnabled:m==="de"?"Teilen aktiv":m==="fr"?"Partage actif":"Sharing enabled",sharingDisabled:m==="de"?"Teilen inaktiv":m==="fr"?"Partage inactif":"Sharing disabled",anyoneWithLink:m==="de"?"Jeder mit dem Link kann die Geschichte lesen":m==="fr"?"Toute personne avec le lien peut lire l'histoire":"Anyone with the link can read the story",errorLoading:m==="de"?"Fehler beim Laden":m==="fr"?"Erreur de chargement":"Error loading"};n.useEffect(()=>{s&&!h&&x()},[s]);const x=async()=>{K(!0),k(null);try{const A=localStorage.getItem("auth_token"),L=await fetch(`/api/stories/${r}/share-status`,{headers:A?{Authorization:`Bearer ${A}`}:{}});if(!L.ok)throw new Error("Failed to fetch status");const de=await L.json();N(de)}catch{k(y.errorLoading)}finally{K(!1)}},O=async()=>{K(!0),k(null);try{const L=(h==null?void 0:h.isShared)?"DELETE":"POST",de=localStorage.getItem("auth_token"),w=await fetch(`/api/stories/${r}/share`,{method:L,headers:de?{Authorization:`Bearer ${de}`}:{}});if(!w.ok)throw new Error("Failed to toggle sharing");const _=await w.json();N({isShared:_.isShared,shareToken:_.shareToken,shareUrl:_.shareUrl}),d==null||d(_.isShared)}catch{k("Failed to update sharing")}finally{K(!1)}},be=async()=>{if(h!=null&&h.shareUrl)try{await navigator.clipboard.writeText(h.shareUrl),T(!0),setTimeout(()=>T(!1),2e3)}catch{const L=document.createElement("textarea");L.value=h.shareUrl,document.body.appendChild(L),L.select(),document.execCommand("copy"),document.body.removeChild(L),T(!0),setTimeout(()=>T(!1),2e3)}},he=()=>{if(!(h!=null&&h.shareUrl))return;const A=encodeURIComponent(h.shareUrl);window.open(`https://wa.me/?text=${A}`,"_blank")};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>D(!s),className:C?"bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full hover:bg-indigo-600":"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg",title:y.share,children:[e.jsx(Wn,{className:"w-4 h-4"}),e.jsx("span",{className:C?"":"hidden sm:inline",children:y.share}),(h==null?void 0:h.isShared)&&e.jsx("span",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>D(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Wn,{className:"w-5 h-5 text-blue-600"}),y.shareStory]})}),e.jsx("div",{className:"p-4 space-y-4",children:$&&!h?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(lt,{className:"w-6 h-6 animate-spin text-blue-500"})}):v?e.jsx("div",{className:"text-red-500 text-sm py-2",children:v}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[h!=null&&h.isShared?e.jsx(mo,{className:"w-5 h-5 text-green-500"}):e.jsx(co,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:h!=null&&h.isShared?"text-green-700":"text-gray-600",children:h!=null&&h.isShared?y.sharingEnabled:y.sharingDisabled})]}),e.jsx("button",{onClick:O,disabled:$,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${h!=null&&h.isShared?"bg-red-100 text-red-700 hover:bg-red-200":"bg-green-100 text-green-700 hover:bg-green-200"} disabled:opacity-50`,children:$?e.jsx(lt,{className:"w-4 h-4 animate-spin"}):h!=null&&h.isShared?y.disableSharing:y.enableSharing})]}),(h==null?void 0:h.isShared)&&h.shareUrl&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xs text-gray-500",children:y.anyoneWithLink}),e.jsx("button",{onClick:be,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-colors",children:S?e.jsxs(e.Fragment,{children:[e.jsx(so,{className:"w-4 h-4 text-green-500"}),y.copied]}):e.jsxs(e.Fragment,{children:[e.jsx(no,{className:"w-4 h-4"}),y.copyLink]})}),e.jsxs("button",{onClick:he,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors",children:[e.jsx(go,{className:"w-4 h-4"}),y.shareWhatsApp]})]})]})})]})]})]})}function Oo({title:r,dedication:d,story:o,outline:m,outlinePrompt:s,outlineModelId:D,outlineUsage:h,storyTextPrompts:N=[],visualBible:$,sceneImages:K,sceneDescriptions:S=[],coverImages:T,regeneratingCovers:v=new Set,languageLevel:k="standard",storyLanguage:C,isGenerating:y=!1,onDownloadPdf:x,onAddToBook:O,onPrintBook:be,onCreateAnother:he,onDownloadTxt:A,onRegenerateImage:L,onRegenerateCover:de,characters:w=[],onEditImage:_,onEditCover:j,onRepairImage:ae,onIteratePage:Z,onRevertRepair:$e,onVisualBibleChange:Te,storyId:B,developerMode:Se=!1,styledAvatarGeneration:W=[],costumedAvatarGeneration:X=[],generationLog:Q=[],finalChecksReport:E,clothingRequirements:V,isPartial:pe=!1,failureReason:J,generatedPages:oe,totalPages:H,progressiveMode:De=!1,progressiveData:Be,completedPageImages:Ie={},originalStory:qe,onSaveStoryText:q,onSaveTitleChange:se,userCredits:ve=0,imageRegenerationCost:ke=5,isImpersonating:Ae=!1,onSelectImageVersion:_e,generationSettings:Xe,onRefreshStory:et}){var Ks,Na,gr,hr,Js,xr,wa,_t,Rr,Sa,Zs,Ca;const{t:ot,language:a}=br(),Pe=C?C.startsWith("de")?"de":C:a,Je=Ae||ve===-1||ve>=ke,[Me,Bs]=n.useState(null),[$t,yr]=n.useState(""),[nr,Jr]=n.useState(!1),[Zr,cs]=n.useState(o),[ir,ha]=n.useState(!1),[xt,ms]=n.useState(!1),[Rt,or]=n.useState(r||""),[He,us]=n.useState(!1),[st,Mr]=n.useState(null),[We,vr]=n.useState(null),[,Dt]=n.useState(!1),[Ft,It]=n.useState(new Set),[Ue,Fe]=n.useState(null),[Oe,xa]=n.useState(null),[lr,R]=n.useState(null),[Ve,Ms]=n.useState(null),[yt,pa]=n.useState(null),[Kt,fa]=n.useState(null),[jt,ut]=n.useState(null),[Jt,Qr]=n.useState(null),[St,gs]=n.useState("square"),[jr,hs]=n.useState(!1),[Nr,sn]=n.useState({}),[wr,ba]=n.useState(new Set),Os=async t=>{if(!(!B||Nr[t]||wr.has(t))){ba(u=>new Set(u).add(t));try{const u=localStorage.getItem("auth_token"),c=await fetch(`/api/stories/${B}/visual-bible-image/${t}`,{headers:u?{Authorization:`Bearer ${u}`}:{}});if(c.ok){const I=await c.json();sn(l=>({...l,[t]:I.imageData}))}}catch(u){console.error(`Failed to load reference image for ${t}:`,u)}finally{ba(u=>{const c=new Set(u);return c.delete(t),c})}}},Yr=(t,u)=>{if(!u||!Se)return null;const c=Nr[t],I=wr.has(t);return c?e.jsx("img",{src:c,alt:"Reference",className:"w-16 h-16 object-cover rounded border border-rose-300 cursor-pointer hover:opacity-80",onClick:()=>ut({src:c,title:"Reference Image"})}):e.jsx("button",{onClick:()=>Os(t),disabled:I,className:"w-16 h-16 flex items-center justify-center bg-rose-100 border border-rose-300 rounded text-rose-500 hover:bg-rose-200 disabled:opacity-50",title:"Load reference image",children:I?e.jsx(lt,{size:16,className:"animate-spin"}):e.jsx(ls,{size:16})})},[Sr,Ls]=n.useState({}),[Zt,xs]=n.useState(new Set),Or=async(t,u)=>{const c=`${t}-${u}`;if(!(!B||Sr[c]||Zt.has(c))){xs(I=>new Set(I).add(c));try{const I=await Le.getAvatarGenerationImage(B,t,u);I&&Ls(l=>({...l,[c]:I}))}catch(I){console.error(`Failed to load avatar generation images for ${c}:`,I)}finally{xs(I=>{const l=new Set(I);return l.delete(c),l})}}},Gs=async()=>{if(!B||!W)return;const t=W.map((u,c)=>c).filter(u=>!Sr[`styled-${u}`]&&!Zt.has(`styled-${u}`));await Promise.all(t.map(u=>Or("styled",u)))},_s=async()=>{if(!B||!X)return;const t=X.map((u,c)=>c).filter(u=>!Sr[`costumed-${u}`]&&!Zt.has(`costumed-${u}`));await Promise.all(t.map(u=>Or("costumed",u)))},Hs=async()=>{if(!B||!$)return;const u=[...$.secondaryCharacters||[],...$.animals||[],...$.artifacts||[],...$.locations||[],...$.vehicles||[]].filter(c=>c.hasReferenceImage&&!Nr[c.id]&&!wr.has(c.id)).map(c=>c.id);await Promise.all(u.map(c=>Os(c)))},[pt,ps]=n.useState({}),[Pt,fs]=n.useState(new Set),Cr=async t=>{if(!(!B||pt[t]!==void 0||Pt.has(t))){fs(u=>new Set(u).add(t));try{const u=await Le.getEntityGridImageByIndex(B,t);u!=null&&u.gridImage&&ps(c=>({...c,[t]:u.gridImage}))}catch(u){console.error(`Failed to load entity grid image for index ${t}:`,u)}finally{fs(u=>{const c=new Set(u);return c.delete(t),c})}}},ya=async()=>{var c;if(!B)return;const u=(((c=E==null?void 0:E.entity)==null?void 0:c.grids)||[]).map((I,l)=>({grid:I,idx:l})).filter(({grid:I,idx:l})=>!I.gridImage&&pt[l]===void 0).map(({idx:I})=>I);await Promise.all(u.map(I=>Cr(I)))},Ws=async(t,u,c)=>new Promise((I,l)=>{const ne=new Image;ne.onload=()=>{const ee=document.createElement("canvas"),Ee=ee.getContext("2d");if(!Ee){l(new Error("Could not get canvas context"));return}const{cellSize:we,cols:gt}=c,vt=Math.floor(u/gt),fe=u%gt*we,at=vt*we;ee.width=we,ee.height=we,Ee.drawImage(ne,fe,at,we,we,0,0,we,we),I(ee.toDataURL("image/png"))},ne.onerror=()=>l(new Error("Failed to load grid image")),ne.src=t}),an=async(t,u)=>{try{const c=t.manifest.cells[u],I=await Ws(t.gridImage,u,t.manifest),l=c.isReference?"Reference":`Page ${c.pageNumber}`,ne=c.clothing&&c.clothing!=="standard"?` (${c.clothing})`:"";ut({src:I,title:`${t.entityName} - ${l}${ne}`})}catch(c){console.error("Failed to crop cell:",c)}},Lr=(t,u,c,I)=>{var ee,Ee,we,gt,vt;const l=`${t}-${u}`,ne=Sr[l];return ne&&ne[I]?ne[I]:I==="output"&&((ee=c.output)!=null&&ee.imageData)?c.output.imageData:I==="facePhoto"&&((Ee=c.inputs.facePhoto)!=null&&Ee.imageData)?c.inputs.facePhoto.imageData:I==="originalAvatar"&&"originalAvatar"in c.inputs&&((we=c.inputs.originalAvatar)!=null&&we.imageData)?c.inputs.originalAvatar.imageData:I==="styleSample"&&"styleSample"in c.inputs&&((gt=c.inputs.styleSample)!=null&&gt.imageData)?c.inputs.styleSample.imageData:I==="standardAvatar"&&"standardAvatar"in c.inputs&&((vt=c.inputs.standardAvatar)!=null&&vt.imageData)&&c.inputs.standardAvatar.imageData||null},Lt=(t,u,c,I,l,ne)=>{const ee=Lr(t,u,c,I),Ee=`${t}-${u}`,we=Zt.has(Ee),gt=!!Sr[Ee];return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:l}),ee?e.jsx("img",{src:ee,alt:l,className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>ut({src:ee,title:l}),title:ne?`${ne} KB - Click to enlarge`:"Click to enlarge"}):ne?e.jsx("button",{onClick:()=>Or(t,u),disabled:we||gt,className:"w-16 h-16 flex flex-col items-center justify-center bg-blue-50 border border-blue-300 rounded text-blue-500 hover:bg-blue-100 disabled:opacity-50 text-[10px]",title:"Click to load images",children:we?e.jsx(lt,{size:16,className:"animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(ls,{size:14}),e.jsxs("span",{className:"mt-0.5",children:[ne," KB"]})]})}):e.jsx("span",{className:"text-gray-400 italic text-[10px]",children:"N/A"})]})};n.useEffect(()=>{nr||cs(o)},[o,nr]),n.useEffect(()=>{xt||or(r||"")},[r,xt]);const va=async()=>{if(q){ha(!0);try{await q(Zr),Jr(!1)}catch(t){console.error("Failed to save story text:",t)}finally{ha(!1)}}},Qt=async()=>{if(!(!se||!Rt.trim())){us(!0);try{await se(Rt.trim()),ms(!1)}catch(t){console.error("Failed to save title:",t)}finally{us(!1)}}},dr=()=>{cs(o),Jr(!1)},Nt=async t=>{if(!(!ae||Oe!==null)){xa(t);try{await ae(t)}catch(u){console.error("Failed to repair image:",u)}finally{xa(null)}}},Gr=async t=>{if(!(!Z||Kt!==null)){fa(t);try{await Z(t)}catch(u){console.error("Failed to iterate page:",u)}finally{fa(null)}}},bs=async t=>{if(!(!B||lr!==null)){R(t);try{const u=await fetch(`/api/stories/${B}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({entityName:t,entityType:"character"})});if(!u.ok){const I=await u.json();throw new Error(I.error||"Repair failed")}const c=await u.json();console.log("Entity repair result:",c),c.success&&!c.noChanges&&(et?await et():window.location.reload())}catch(u){console.error("Failed to repair entity consistency:",u),alert(`Failed to repair: ${u instanceof Error?u.message:"Unknown error"}`)}finally{R(null)}}},Gt=async(t,u)=>{if(!(!B||yt!==null)){pa({entity:t,page:u});try{const c=await fetch(`/api/stories/${B}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({entityName:t,entityType:"character",pageNumber:u})});if(!c.ok){const l=await c.json();throw new Error(l.error||"Repair failed")}const I=await c.json();if(console.log("Single-page entity repair result:",I),I.rejected&&I.comparison){Qr({beforeImage:I.comparison.before,afterImage:I.comparison.after,title:`Repair rejected for ${t} on page ${u}: ${I.reason||"Did not improve consistency"}`});return}I.success?et?await et():window.location.reload():I.rejected||alert(`Repair failed: ${I.error||"Unknown error"}`)}catch(c){console.error("Failed to repair single page:",c),alert(`Failed to repair page ${u}: ${c instanceof Error?c.message:"Unknown error"}`)}finally{pa(null)}}},ys=async(t,u)=>{if(!(!B||Ve!==null)){Ms(t);try{const c=await fetch(`/api/stories/${B}/repair/image/${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({correctionNotes:`${u.type||""}: ${u.description||""}
Target: ${u.canonicalVersion||""}
Fix: ${u.recommendation||""}`})});if(!c.ok){const l=await c.json();throw new Error(l.error||"Repair failed")}const I=await c.json();console.log("Image issue repair result:",I),I.success&&(et?await et():window.location.reload())}catch(c){console.error("Failed to repair image issue:",c),alert(`Failed to repair: ${c instanceof Error?c.message:"Unknown error"}`)}finally{Ms(null)}}},Et=(t,u)=>{const c=Zr.split(/(?=---\s*(?:Page|Seite)\s+\d+\s*---|(?=##\s*(?:Page|Seite)\s+\d+))/i);let I=0;for(let ne=0;ne<c.length;ne++)if(/^(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i.test(c[ne].trim())){I=ne;break}const l=I+t;if(l<c.length){const ne=c[l].match(/^(---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i),ee=ne?ne[0]:"";c[l]=ee+`
`+u.trim()+`
`}cs(c.join(""))},kr=t=>{const u=K.find(c=>c.pageNumber===t);return(u==null?void 0:u.imageVersions)||[]},At=async(t,u)=>{if(_e)try{await _e(t,u),Mr(null)}catch(c){console.error("Failed to select image version:",c)}},Vs=t=>{if(!t)return"";let u;if(typeof t!="string"){const ne=t;if(ne.output)if(typeof ne.output=="string")u=ne.output;else if(typeof ne.output=="object"){const ee=ne.output.translatedSummary||ne.output.imageSummary||"";if(ee)return ee;u=JSON.stringify(t)}else u=JSON.stringify(t);else u=JSON.stringify(t)}else u=t;if(u.trim().startsWith("{"))try{const ne=JSON.parse(u);if(ne.output){if(typeof ne.output=="string")u=ne.output;else if(typeof ne.output=="object"){const ee=ne.output.translatedSummary||ne.output.imageSummary;if(ee)return ee}}}catch{}const c=u.match(/(?:#{1,3}\s*)?(?:\*\*)?6\.?\s*(?:\*\*)?\s*\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*\*?\*?\s*:?\s*\n?([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n---|\n```|$)/i);if(c&&c[2]&&c[2].trim())return c[2].trim();const I=u.match(/(?:#{1,3}\s*)?\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*:?\s*\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n\*\*|\n#{1,3}\s|$)/i);if(I&&I[2]&&I[2].trim())return I[2].trim();if(!u.includes("**")&&u.length<1e3)return u.trim();const l=u.match(/\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:\*\*)?\d+\.\s*\*\*|\n\s*\*\*\d+\.|$)/i);return l&&l[2]&&l[2].trim()?l[2].trim():u.substring(0,500).trim()+"..."},Pr=t=>{if(!t||!w.length)return w.map(I=>I.id);let u;if(typeof t!="string"){const I=t;u=I.output&&typeof I.output=="string"?I.output:JSON.stringify(t)}else u=t;if(u.trim().startsWith("{"))try{const I=JSON.parse(u);I.output&&typeof I.output=="string"&&(u=I.output)}catch{}const c=u.toLowerCase();return w.filter(I=>c.includes(I.name.toLowerCase())).map(I=>I.id)},vs=t=>{const u=K.find(ee=>ee.pageNumber===t),c=S.find(ee=>ee.pageNumber===t),I=(u==null?void 0:u.description)||(c==null?void 0:c.description)||"",l=(c==null?void 0:c.translatedSummary)||Vs(I)||(c==null?void 0:c.imageSummary)||"",ne=Pr(I);vr({pageNumber:t,scene:l,selectedCharacterIds:ne})},Ar=async()=>{if(!We||!L)return;const t=We.pageNumber,u=We.scene,c=We.selectedCharacterIds;vr(null),It(I=>new Set(I).add(t)),Dt(!0);try{await L(t,u,c)}catch(I){console.error("Failed to regenerate image:",I)}finally{It(I=>{const l=new Set(I);return l.delete(t),l}),It(I=>(I.size===0&&Dt(!1),I))}},cr=t=>{let u="",c=[];if(t==="front"&&(T!=null&&T.frontCover)){const ee=T.frontCover;typeof ee=="object"&&(u=ee.description||"",c=ee.referencePhotos||[])}else if(t==="initial"&&(T!=null&&T.initialPage)){const ee=T.initialPage;typeof ee=="object"&&(u=ee.description||"",c=ee.referencePhotos||[])}else if(t==="back"&&(T!=null&&T.backCover)){const ee=T.backCover;typeof ee=="object"&&(u=ee.description||"",c=ee.referencePhotos||[])}let I=[];c.length>0&&w.length>0&&(I=w.filter(ee=>c.some(Ee=>Ee.name===ee.name)).map(ee=>ee.id)),I.length===0&&(I=w.map(ee=>ee.id)),Fe({coverType:t,scene:u,selectedCharacterIds:I,title:t==="front"?r:void 0,dedication:t==="initial"?d:void 0})},$r=async()=>{if(!Ue||!de)return;const{coverType:t,scene:u,selectedCharacterIds:c,title:I,dedication:l}=Ue;Fe(null);try{await de(t,u,c,I,l)}catch(ne){console.error("Failed to regenerate cover:",ne)}},mr=(t,u,c,I)=>{Bs({type:t,id:u,field:c}),yr(I||"")},Ir=()=>{if(!Me||!$||!Te)return;const{type:t,id:u,field:c}=Me,I={...$};if(t==="secondaryCharacter")I.secondaryCharacters=(I.secondaryCharacters||[]).map(l=>l.id===u?{...l,[c]:$t}:l);else if(t==="animal")I.animals=(I.animals||[]).map(l=>l.id===u?{...l,[c]:$t}:l);else if(t==="artifact")I.artifacts=(I.artifacts||[]).map(l=>l.id===u?{...l,[c]:$t}:l);else if(t==="location")I.locations=(I.locations||[]).map(l=>l.id===u?{...l,[c]:$t}:l);else if(t==="mainCharacter"){const l=parseInt(u);I.mainCharacters=(I.mainCharacters||[]).map(ne=>ne.id!==l?ne:c==="physical.face"?{...ne,physical:{...ne.physical,face:$t}}:c==="physical.hair"?{...ne,physical:{...ne.physical,hair:$t}}:c==="physical.build"?{...ne,physical:{...ne.physical,build:$t}}:ne)}Te(I),Bs(null),yr("")},Yt=()=>{Bs(null),yr("")},_r=(t=>t?t.split(/(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i).slice(1).filter(c=>c.trim().length>0):[])(nr?Zr:o),ur=K.length>0,js=k==="1st-grade",es=(()=>{if(!De)return _r.length;if(_r.length===0)return 0;let t=1;for(let u=2;u<=_r.length;u++){const c=u-1;if(K.some(l=>l.pageNumber===c&&l.imageData)||!!Ie[c])t=u;else break}return t})(),Us=(Be==null?void 0:Be.totalPages)||_r.length;Be!=null&&Be.totalScenes||K.length||Math.ceil(Us/(js?1:2));const Tr=t=>t?typeof t=="string"?t:t.imageData||null:null,ts=t=>t?typeof t=="string"?{imageData:t}:t:null,zt=t=>{var ne,ee;const c=((ne=S.find(Ee=>Ee.pageNumber===t))==null?void 0:ne.description)||((ee=K.find(Ee=>Ee.pageNumber===t))==null?void 0:ee.description);if(!c)return;const I=Ee=>{if(typeof Ee!="string")return Ee;try{const we=JSON.parse(Ee);return typeof we=="string"&&(we.startsWith("{")||we.startsWith("["))?I(we):we}catch{return Ee}},l=I(c);return typeof l=="object"&&l!==null?JSON.stringify(l,null,2):String(l)},Xt=t=>{const u=S.find(c=>c.pageNumber===t);return t===1&&u&&(console.log("[StoryDisplay] Page 1 scene keys:",Object.keys(u)),console.log("[StoryDisplay] Page 1 has outlineExtract:",!!u.outlineExtract),console.log("[StoryDisplay] Page 1 has scenePrompt:",!!u.scenePrompt)),u==null?void 0:u.outlineExtract},Ns=t=>{var u;return(u=S.find(c=>c.pageNumber===t))==null?void 0:u.scenePrompt},rs=t=>{var u;return(u=S.find(c=>c.pageNumber===t))==null?void 0:u.textModelId};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center gap-2",children:xt?e.jsxs("div",{className:"flex items-center gap-2 w-full max-w-2xl",children:[e.jsx("input",{type:"text",value:Rt,onChange:t=>or(t.target.value),className:"flex-1 text-2xl md:text-3xl font-bold text-gray-800 text-center border-2 border-indigo-300 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500",autoFocus:!0,onKeyDown:t=>{t.key==="Enter"&&Qt(),t.key==="Escape"&&(or(r||""),ms(!1))}}),e.jsx("button",{onClick:Qt,disabled:He||!Rt.trim(),className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",title:a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save",children:He?e.jsx(os,{className:"animate-spin",size:20}):e.jsx(Is,{size:20})}),e.jsx("button",{onClick:()=>{or(r||""),ms(!1)},disabled:He,className:"p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",title:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel",children:e.jsx(qt,{size:20})})]}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 text-center",children:r||ot.yourStory}),se&&!y&&e.jsx("button",{onClick:()=>ms(!0),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors",title:a==="de"?"Titel bearbeiten":a==="fr"?"Modifier le titre":"Edit title",children:e.jsx(kt,{size:18})})]})}),pe&&e.jsx("div",{className:"bg-amber-50 border-2 border-amber-400 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-amber-500 text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-amber-800",children:a==="de"?"UnvollstÃ¤ndige Geschichte":a==="fr"?"Histoire incomplÃ¨te":"Incomplete Story"}),e.jsx("p",{className:"text-amber-700 text-sm mt-1",children:a==="de"?`Diese Geschichte konnte nicht vollstÃ¤ndig generiert werden. ${oe||K.length} von ${H||"unbekannt"} Seiten wurden erstellt.`:a==="fr"?`Cette histoire n'a pas pu Ãªtre gÃ©nÃ©rÃ©e complÃ¨tement. ${oe||K.length} sur ${H||"inconnu"} pages ont Ã©tÃ© crÃ©Ã©es.`:`This story could not be fully generated. ${oe||K.length} of ${H||"unknown"} pages were created.`}),J&&Se&&e.jsxs("details",{className:"mt-2 text-sm",children:[e.jsx("summary",{className:"cursor-pointer text-amber-600 hover:text-amber-700",children:a==="de"?"Fehlerdetails":a==="fr"?"DÃ©tails de l'erreur":"Error details"}),e.jsx("p",{className:"mt-1 bg-amber-100 p-2 rounded text-amber-800 font-mono text-xs",children:J})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[ur&&B&&O&&e.jsxs("button",{onClick:O,disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(_n,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),ur&&x&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>hs(!jr),disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Ts,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Ut,{size:14,className:`transition-transform ${jr?"rotate-180":""}`})]}),jr&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:St==="square",onChange:()=>gs("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:St==="A4",onChange:()=>gs("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{x(St),hs(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),ur&&B&&!y&&e.jsx(Mo,{storyId:B,variant:"full"}),he&&e.jsxs("button",{onClick:he,disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Ln,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]}),Se&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[A&&e.jsxs("button",{onClick:A,className:"bg-gray-500 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 hover:bg-gray-600",children:[e.jsx(ds,{size:14})," TXT"]}),ur&&B&&be&&e.jsxs("button",{onClick:be,disabled:y,className:`bg-yellow-500 text-black px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 ${y?"opacity-50 cursor-not-allowed":"hover:bg-yellow-600"}`,children:[e.jsx(tn,{size:14})," Print (DEV)"]})]}),Se&&Xe&&e.jsx("div",{className:"mt-4",children:e.jsx(Bo,{settings:Xe,language:a})}),Se&&e.jsxs("div",{className:"space-y-4 mt-6",children:[m&&e.jsxs("details",{className:"bg-purple-50 border-2 border-purple-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-purple-800 hover:text-purple-900 flex items-center gap-2",children:[e.jsx(Ts,{size:20}),js?a==="de"?"VollstÃ¤ndige API-Ausgabe (Kombiniert)":a==="fr"?"Sortie API complÃ¨te (CombinÃ©e)":"Full API Output (Combined)":a==="de"?"VollstÃ¤ndige API-Ausgabe (Outline)":a==="fr"?"Sortie API complÃ¨te (Plan)":"Full API Output (Outline)",D&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-purple-600",children:["(",D,")"]}),h&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-purple-500",children:["[",h.input_tokens.toLocaleString()," in / ",h.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[s&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:s})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:js?a==="de"?"ðŸ“¥ API-Antwort (Kombiniert)":a==="fr"?"ðŸ“¥ RÃ©ponse API (CombinÃ©e)":"ðŸ“¥ API Response (Combined)":a==="de"?"ðŸ“¥ API-Antwort (Outline)":a==="fr"?"ðŸ“¥ RÃ©ponse API (Plan)":"ðŸ“¥ API Response (Outline)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:m})]})]})]}),o&&N.length>0&&e.jsxs("details",{className:"bg-amber-50 border-2 border-amber-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(tn,{size:20}),a==="de"?"VollstÃ¤ndige API-Ausgabe (Story-Text)":a==="fr"?"Sortie API complÃ¨te (Texte)":"Full API Output (Story Text)",((Ks=N[0])==null?void 0:Ks.modelId)&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-amber-600",children:["(",N[0].modelId,")"]}),((Na=N[0])==null?void 0:Na.usage)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-500",children:["[",N[0].usage.input_tokens.toLocaleString()," in / ",N[0].usage.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((gr=N[0])==null?void 0:gr.prompt)||"No prompt available"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¥ Rohe API-Antwort (ungefiltert)":a==="fr"?"ðŸ“¥ RÃ©ponse API brute (non filtrÃ©e)":"ðŸ“¥ Raw API Response (unfiltered)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((hr=N[0])==null?void 0:hr.rawResponse)||o})]})]})]}),$&&e.jsxs("details",{className:"bg-rose-50 border-2 border-rose-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-rose-800 hover:text-rose-900 flex items-center gap-2",children:[e.jsx(tn,{size:20}),a==="de"?"Visual Bible (Wiederkehrende Elemente)":a==="fr"?"Bible Visuelle (Ã‰lÃ©ments RÃ©currents)":"Visual Bible (Recurring Elements)",$.changeLog&&$.changeLog.length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-rose-200 text-rose-800 rounded-full text-xs font-medium",children:[$.changeLog.length," ",a==="de"?"Ã„nderungen":a==="fr"?"changements":"changes"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[(()=>{const u=[...$.secondaryCharacters||[],...$.animals||[],...$.artifacts||[],...$.locations||[],...$.vehicles||[]].filter(c=>c.hasReferenceImage&&!Nr[c.id]).length;return u===0?null:e.jsx("button",{onClick:Hs,disabled:wr.size>0,className:"text-xs px-3 py-1.5 bg-rose-500 text-white rounded hover:bg-rose-600 disabled:bg-rose-300",children:wr.size>0?`Loading ${wr.size} images...`:`Load All Reference Images (${u})`})})(),$.mainCharacters&&$.mainCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-purple-300 rounded-lg p-3",children:[e.jsxs("h4",{className:"text-sm font-bold text-purple-700 mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘—"}),a==="de"?"Hauptcharaktere (Style Profile)":a==="fr"?"Personnages Principaux (Profil Style)":"Main Characters (Style Profile)"]}),e.jsx("div",{className:"space-y-3",children:$.mainCharacters.map(t=>{var u,c,I,l;return e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-sm",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-800 hover:text-purple-900",children:[t.name,Object.keys(t.generatedOutfits||{}).length>0&&e.jsxs("span",{className:"ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs",children:[Object.keys(t.generatedOutfits).length," ",a==="de"?"Outfits":a==="fr"?"tenues":"outfits"]})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"font-medium text-gray-600",children:"Physical:"}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[((u=t.physical)==null?void 0:u.skinTone)||"N/A"," | ",((c=t.physical)==null?void 0:c.hair)||"N/A"," | ",((I=t.physical)==null?void 0:I.build)||"N/A",((l=t.physical)==null?void 0:l.other)&&` | ${t.physical.other}`]})]}),t.generatedOutfits&&Object.keys(t.generatedOutfits).length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-purple-200",children:[e.jsx("span",{className:"font-medium text-gray-600 text-xs",children:"Generated Outfits:"}),e.jsx("div",{className:"mt-1 space-y-1",children:Object.entries(t.generatedOutfits).map(([ne,ee])=>{var Ee;return e.jsxs("div",{className:"bg-white p-1.5 rounded text-xs",children:[e.jsxs("span",{className:"font-medium text-purple-600",children:["Page ",ne,":"]}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[(Ee=ee.outfit)==null?void 0:Ee.substring(0,80),"..."]}),e.jsx("span",{className:`ml-1 px-1 py-0.5 rounded text-[10px] ${ee.setting==="outdoor-cold"?"bg-blue-100 text-blue-700":ee.setting==="outdoor-warm"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:ee.setting})]},ne)})})]})]})]},t.id)})})]}),$.secondaryCharacters&&$.secondaryCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Nebencharaktere":a==="fr"?"Personnages Secondaires":"Secondary Characters"}),e.jsx("div",{className:"space-y-2",children:$.secondaryCharacters.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[Yr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(Me==null?void 0:Me.type)==="secondaryCharacter"&&(Me==null?void 0:Me.id)===t.id&&(Me==null?void 0:Me.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:$t,onChange:c=>yr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ir,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Is,{size:12})," Save"]}),e.jsxs("button",{onClick:Yt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(qt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),Se&&Te&&e.jsx("button",{onClick:()=>mr("secondaryCharacter",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(kt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Js=$.animals)==null?void 0:Js.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Tiere & Wesen":a==="fr"?"Animaux & CrÃ©atures":"Animals & Creatures"}),e.jsx("div",{className:"space-y-2",children:$.animals.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[Yr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(Me==null?void 0:Me.type)==="animal"&&(Me==null?void 0:Me.id)===t.id&&(Me==null?void 0:Me.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:$t,onChange:c=>yr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ir,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Is,{size:12})," Save"]}),e.jsxs("button",{onClick:Yt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(qt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),Se&&Te&&e.jsx("button",{onClick:()=>mr("animal",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(kt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((xr=$.artifacts)==null?void 0:xr.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Artefakte & Objekte":a==="fr"?"Artefacts & Objets":"Artifacts & Objects"}),e.jsx("div",{className:"space-y-2",children:$.artifacts.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[Yr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),(Me==null?void 0:Me.type)==="artifact"&&(Me==null?void 0:Me.id)===t.id&&(Me==null?void 0:Me.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:$t,onChange:c=>yr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ir,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Is,{size:12})," Save"]}),e.jsxs("button",{onClick:Yt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(qt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),Se&&Te&&e.jsx("button",{onClick:()=>mr("artifact",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(kt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((wa=$.locations)==null?void 0:wa.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Wiederkehrende Orte":a==="fr"?"Lieux RÃ©currents":"Recurring Locations"}),e.jsx("div",{className:"space-y-2",children:$.locations.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[!t.isRealLandmark&&Yr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.isRealLandmark&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 font-semibold",children:"ðŸ“ LANDMARK"}),t.photoFetchStatus==="success"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700",children:"ðŸ“· Photo"}),!t.isRealLandmark&&t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),t.isRealLandmark&&t.landmarkQuery&&e.jsxs("div",{className:"text-amber-700 text-xs mt-1",children:["Landmark: ",e.jsx("span",{className:"font-mono bg-amber-50 px-1 rounded",children:t.landmarkQuery})]}),(Me==null?void 0:Me.type)==="location"&&(Me==null?void 0:Me.id)===t.id&&(Me==null?void 0:Me.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:$t,onChange:c=>yr(c.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ir,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(Is,{size:12})," Save"]}),e.jsxs("button",{onClick:Yt,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(qt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),Se&&Te&&e.jsx("button",{onClick:()=>mr("location",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(kt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]}),t.referencePhotoData&&e.jsxs("div",{className:"mt-2 border border-amber-200 rounded overflow-hidden",children:[e.jsx("img",{src:t.referencePhotoData,alt:`${t.name} reference`,className:"w-full max-h-32 object-contain bg-gray-50"}),t.photoAttribution&&e.jsxs("div",{className:"text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 truncate",children:["ðŸ“· ",t.photoAttribution]})]})]})]},t.id)})})]}),$.vehicles&&$.vehicles.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Fahrzeuge":a==="fr"?"VÃ©hicules":"Vehicles"}),e.jsx("div",{className:"space-y-2",children:$.vehicles.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[Yr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),$.clothing&&$.clothing.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Kleidung & KostÃ¼me":a==="fr"?"VÃªtements & Costumes":"Clothing & Costumes"}),e.jsx("div",{className:"space-y-2",children:$.clothing.map(t=>{var u;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.wornBy&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:["worn by ",t.wornBy]}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),((u=t.appearsInPages)==null?void 0:u.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]},t.id)})})]}),$.changeLog&&$.changeLog.length>0&&e.jsxs("details",{className:"bg-white border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-bold text-amber-700 hover:text-amber-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“"}),a==="de"?"Ã„nderungsprotokoll":a==="fr"?"Journal des Modifications":"Change Log",e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-xs",children:$.changeLog.length})]}),e.jsx("div",{className:"mt-2 space-y-1 max-h-[500px] overflow-y-auto",children:$.changeLog.slice().reverse().map((t,u)=>{var c;return e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs border-l-2 border-amber-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.type==="mainCharacter"?"bg-purple-100 text-purple-700":t.type==="secondaryCharacter"?"bg-rose-100 text-rose-700":t.type==="generatedOutfit"?"bg-green-100 text-green-700":t.type==="animal"?"bg-orange-100 text-orange-700":t.type==="artifact"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:t.type}),e.jsx("span",{className:"font-semibold text-amber-800",children:t.element}),e.jsxs("span",{className:"text-gray-500",children:[Pe==="de"?"Seite":"Page"," ",t.page]})]}),e.jsxs("div",{className:"mt-1 text-gray-600",children:[e.jsxs("span",{className:"font-medium",children:[t.change,":"]}),e.jsxs("span",{className:"ml-1 text-gray-700",children:[(c=t.after)==null?void 0:c.substring(0,100),t.after&&t.after.length>100?"...":""]})]}),t.before&&e.jsxs("div",{className:"text-gray-400 line-through text-[10px] mt-0.5",children:[a==="de"?"Vorher":a==="fr"?"Avant":"Before",": ",t.before.substring(0,50),"..."]}),e.jsx("div",{className:"text-gray-400 text-[10px] mt-0.5",children:new Date(t.timestamp).toLocaleTimeString()})]},u)})})]}),(!$.mainCharacters||$.mainCharacters.length===0)&&(!$.secondaryCharacters||$.secondaryCharacters.length===0)&&(!$.animals||$.animals.length===0)&&(!$.artifacts||$.artifacts.length===0)&&(!$.locations||$.locations.length===0)&&(!$.vehicles||$.vehicles.length===0)&&(!$.clothing||$.clothing.length===0)&&e.jsx("div",{className:"text-gray-500 text-sm italic",children:a==="de"?"Keine wiederkehrenden Elemente gefunden":a==="fr"?"Aucun Ã©lÃ©ment rÃ©current trouvÃ©":"No recurring elements found in this story"})]})]}),V&&Object.keys(V).length>0&&e.jsxs("details",{className:"bg-teal-50 border-2 border-teal-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-teal-800 hover:text-teal-900 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸ‘”"}),a==="de"?`Kleidungsanforderungen (${Object.keys(V).length} Charaktere)`:a==="fr"?`Exigences vestimentaires (${Object.keys(V).length} personnages)`:`Clothing Requirements (${Object.keys(V).length} characters)`]}),e.jsx("div",{className:"mt-4 space-y-3",children:Object.entries(V).map(([t,u])=>{var c,I,l,ne,ee,Ee,we,gt,vt,Bt,fe,at,er,ss,Ht;return e.jsxs("div",{className:"bg-white border border-teal-200 rounded-lg p-3",children:[e.jsx("h4",{className:"font-bold text-teal-700 mb-2",children:t}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${(c=u.standard)!=null&&c.used?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(I=u.standard)!=null&&I.used?"âœ…":"â¬œ"," Standard"]}),((l=u.standard)==null?void 0:l.used)&&((ne=u.standard)==null?void 0:ne.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:u.standard.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(ee=u.winter)!=null&&ee.used?"bg-blue-50 border border-blue-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Ee=u.winter)!=null&&Ee.used?"â„ï¸":"â¬œ"," Winter"]}),((we=u.winter)==null?void 0:we.used)&&((gt=u.winter)==null?void 0:gt.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:u.winter.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(vt=u.summer)!=null&&vt.used?"bg-yellow-50 border border-yellow-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Bt=u.summer)!=null&&Bt.used?"â˜€ï¸":"â¬œ"," Summer"]}),((fe=u.summer)==null?void 0:fe.used)&&((at=u.summer)==null?void 0:at.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:u.summer.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(er=u.costumed)!=null&&er.used?"bg-purple-50 border border-purple-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(ss=u.costumed)!=null&&ss.used?"ðŸŽ­":"â¬œ"," Costumed"]}),((Ht=u.costumed)==null?void 0:Ht.used)&&e.jsxs("div",{className:"text-gray-600 mt-1",children:[u.costumed.costume&&e.jsxs("span",{className:"font-medium",children:[u.costumed.costume,": "]}),u.costumed.description]})]})]})]},t)})})]}),W&&W.length>0&&e.jsxs("details",{className:"bg-pink-50 border-2 border-pink-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-pink-800 hover:text-pink-900 flex items-center gap-2",children:[e.jsx(ls,{size:20}),a==="de"?`Stilisierte Avatare (${W.length})`:a==="fr"?`Avatars stylisÃ©s (${W.length})`:`Styled Avatars (${W.length})`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[(()=>{const t=W.filter((u,c)=>!Sr[`styled-${c}`]).length;return t===0?null:e.jsx("button",{onClick:Gs,disabled:Zt.size>0,className:"text-xs px-3 py-1.5 bg-pink-500 text-white rounded hover:bg-pink-600 disabled:bg-pink-300",children:Zt.size>0?"Loading...":`Load All Images (${t})`})})(),W.map((t,u)=>{var c,I;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-pink-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.artStyle," (",t.clothingCategory||"standard",")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[Lt("styled",u,t,"facePhoto","Face Photo",(c=t.inputs.facePhoto)==null?void 0:c.sizeKB),Lt("styled",u,t,"originalAvatar","Original Avatar",(I=t.inputs.originalAvatar)==null?void 0:I.sizeKB),t.inputs.styleSample&&Lt("styled",u,t,"styleSample","Style Sample",t.inputs.styleSample.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:Lt("styled",u,t,"output","Styled Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},u)})]})]}),X&&X.length>0&&e.jsxs("details",{className:"bg-orange-50 border-2 border-orange-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-orange-800 hover:text-orange-900 flex items-center gap-2",children:[e.jsx(ls,{size:20}),a==="de"?`KostÃ¼m-Avatare (${X.length})`:a==="fr"?`Avatars costumÃ©s (${X.length})`:`Costumed Avatars (${X.length})`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[(()=>{const t=X.filter((u,c)=>!Sr[`costumed-${c}`]).length;return t===0?null:e.jsx("button",{onClick:_s,disabled:Zt.size>0,className:"text-xs px-3 py-1.5 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:bg-orange-300",children:Zt.size>0?"Loading...":`Load All Images (${t})`})})(),X.map((t,u)=>{var c,I;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-orange-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 hover:text-orange-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.costumeType," (",t.artStyle,")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[t.costumeDescription&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-yellow-700",children:"Costume:"}),e.jsx("p",{className:"mt-1 text-gray-700",children:t.costumeDescription})]}),e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[Lt("costumed",u,t,"facePhoto","Face Photo",(c=t.inputs.facePhoto)==null?void 0:c.sizeKB),Lt("costumed",u,t,"standardAvatar","Standard Avatar",(I=t.inputs.standardAvatar)==null?void 0:I.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:Lt("costumed",u,t,"output","Costumed Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},u)})]})]}),Q&&Q.length>0&&e.jsxs("details",{className:"bg-slate-50 border-2 border-slate-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-slate-800 hover:text-slate-900 flex items-center gap-2",children:[e.jsx(Ts,{size:20}),a==="de"?`Generierungslog (${Q.length})`:a==="fr"?`Journal de gÃ©nÃ©ration (${Q.length})`:`Generation Log (${Q.length})`,Q.filter(t=>t.level==="warn").length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded-full",children:[Q.filter(t=>t.level==="warn").length," warnings"]}),Q.filter(t=>t.level==="error").length>0&&e.jsxs("span",{className:"ml-1 px-2 py-0.5 bg-red-200 text-red-800 text-xs rounded-full",children:[Q.filter(t=>t.level==="error").length," errors"]})]}),e.jsx("div",{className:"mt-4 space-y-1 max-h-96 overflow-y-auto",children:Q.map((t,u)=>e.jsxs("div",{className:`text-xs p-2 rounded flex items-start gap-2 ${t.level==="error"?"bg-red-50 text-red-800":t.level==="warn"?"bg-yellow-50 text-yellow-800":t.level==="debug"?"bg-gray-50 text-gray-600":"bg-white text-slate-700"}`,children:[e.jsx("span",{className:"text-gray-400 font-mono text-[10px] whitespace-nowrap",children:new Date(t.timestamp).toLocaleTimeString()}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium whitespace-nowrap ${t.stage==="outline"?"bg-blue-100 text-blue-700":t.stage==="avatars"?"bg-purple-100 text-purple-700":t.stage==="scenes"?"bg-green-100 text-green-700":t.stage==="images"?"bg-orange-100 text-orange-700":t.stage==="covers"?"bg-pink-100 text-pink-700":"bg-gray-100 text-gray-700"}`,children:t.stage}),t.character&&e.jsxs("span",{className:"font-medium text-slate-600",children:["[",t.character,"]"]}),e.jsx("span",{className:"flex-1",children:t.message}),e.jsx("span",{className:"text-gray-400 text-[10px]",children:t.event})]},u))})]}),((_t=E==null?void 0:E.entity)==null?void 0:_t.grids)&&E.entity.grids.length>0&&e.jsxs("details",{className:`border-2 rounded-xl p-4 ${E.entity.overallConsistent!==!1?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsxs("summary",{className:`cursor-pointer text-lg font-bold flex items-center gap-2 ${E.entity.overallConsistent!==!1?"text-green-800 hover:text-green-900":"text-amber-800 hover:text-amber-900"}`,children:[E.entity.overallConsistent!==!1?"âœ“":"âš ï¸",a==="de"?`Charakterkonsistenz (${E.entity.totalIssues||0} Probleme)`:a==="fr"?`CohÃ©rence des personnages (${E.entity.totalIssues||0} problÃ¨mes)`:`Character Consistency (${E.entity.totalIssues||0} issues)`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-700",children:E.entity.summary}),(()=>{var c;const u=(((c=E.entity)==null?void 0:c.grids)||[]).filter((I,l)=>!I.gridImage&&pt[l]===void 0).length;return u===0?null:e.jsx("button",{onClick:ya,disabled:Pt.size>0,className:"text-xs px-3 py-1.5 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-blue-300",children:Pt.size>0?`Loading ${Pt.size} grids...`:`Load All Grids (${u})`})})(),e.jsx("div",{className:"space-y-2",children:E.entity.grids.map((t,u)=>{var Ee,we,gt,vt,Bt,fe,at,er,ss,Ht,ws,tr,Dr,Hr,ka,Qs,Pa,Ys,Aa,Xs,$a,ea,Ia,ta,Ta,ra,Ra,Fr,Da,as,Fa,Ss,Ea,Cs,za,ks,sa,Ps,Ba,Er,As,wt;const c=(we=(Ee=E.entity)==null?void 0:Ee.characters)==null?void 0:we[t.entityName],I=(c==null?void 0:c.overallConsistent)??(c==null?void 0:c.consistent)??!0,l=(c==null?void 0:c.overallScore)??(c==null?void 0:c.score)??0,ne=(c==null?void 0:c.issues)??[],ee=t.clothingCategory;return e.jsxs("details",{className:`bg-white border rounded-lg overflow-hidden ${I?"border-green-200":"border-amber-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer p-3 flex items-center gap-2 hover:bg-gray-50",children:[e.jsx("span",{className:`text-sm ${I?"text-green-600":"text-amber-600"}`,children:I?"âœ“":"âš ï¸"}),e.jsxs("span",{className:"font-medium text-sm text-gray-800",children:[t.entityName,ee&&e.jsx("span",{className:`ml-1.5 text-xs font-normal px-1.5 py-0.5 rounded ${ee.startsWith("costumed:")?"bg-purple-100 text-purple-700":ee==="winter"?"bg-blue-100 text-blue-700":ee==="summer"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:ee})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",t.cellCount," appearance",t.cellCount!==1?"s":"",")"]}),e.jsxs("span",{className:`ml-auto text-xs px-2 py-0.5 rounded ${l>=8?"bg-green-100 text-green-700":l>=5?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:["Score: ",l,"/10"]})]}),e.jsxs("div",{className:"p-3 border-t border-gray-100 space-y-3",children:[(()=>{const U=t.gridImage||pt[u],ze=Pt.has(u),re=t.gridImageSizeKB;return U?e.jsx("div",{className:"flex justify-center bg-gray-50 rounded p-2",children:e.jsx("img",{src:U,alt:`${t.entityName} consistency grid`,className:"max-w-full h-auto rounded shadow-sm cursor-pointer hover:opacity-90 transition-opacity",style:{maxHeight:"400px"},onClick:()=>ut({src:U,title:`${t.entityName}${ee?` (${ee})`:""} - Entity Consistency Grid`}),title:"Click to enlarge"})}):ze?e.jsx("div",{className:"flex justify-center items-center bg-gray-100 rounded p-4 h-32",children:e.jsx("span",{className:"text-sm text-gray-500",children:"Loading grid image..."})}):e.jsxs("div",{className:"flex flex-col items-center bg-gray-100 rounded p-4",children:[e.jsxs("span",{className:"text-xs text-gray-500 mb-2",children:["Grid image not loaded ",re?`(${re} KB)`:""]}),e.jsx("button",{onClick:()=>Cr(u),className:"text-xs px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Load Grid"})]})})(),((gt=t.manifest)==null?void 0:gt.cells)&&e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Cells: "}),t.manifest.cells.map((U,ze)=>{const re=t.gridImage||pt[u];return e.jsxs("span",{className:"inline-flex items-center bg-gray-100 rounded px-1.5 py-0.5 mr-1 mb-1 gap-1",children:[e.jsxs("button",{onClick:()=>re&&an({...t,gridImage:re},ze),className:`${re?"hover:text-blue-600 hover:underline cursor-pointer":"text-gray-400 cursor-not-allowed"}`,title:re?"Click to enlarge this cell":"Load grid image first",disabled:!re,children:[U.letter,": ",U.isReference?"Ref":`P${U.pageNumber}`,U.clothing&&U.clothing!=="standard"&&` (${U.clothing})`]}),!U.isReference&&B&&typeof U.pageNumber=="number"&&e.jsx("button",{onClick:Mt=>{Mt.stopPropagation(),Gt(t.entityName,U.pageNumber)},disabled:y||yt!==null||lr!==null,className:`ml-0.5 px-1 py-0 text-[9px] rounded transition-colors ${(yt==null?void 0:yt.entity)===t.entityName&&(yt==null?void 0:yt.page)===U.pageNumber?"bg-amber-300 text-amber-800":y||yt!==null||lr!==null?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,title:`Repair page ${U.pageNumber} for ${t.entityName}`,children:(yt==null?void 0:yt.entity)===t.entityName&&(yt==null?void 0:yt.page)===U.pageNumber?"...":"âš¡"})]},ze)})]}),ne.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-xs font-medium text-gray-700",children:"Issues:"}),ne.map((U,ze)=>{var re;return e.jsxs("div",{className:`text-xs p-2 rounded ${U.severity==="critical"?"bg-red-50 border-l-4 border-red-400":U.severity==="major"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${U.severity==="critical"?"bg-red-200 text-red-800":U.severity==="major"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:U.severity}),U.cells&&e.jsxs("span",{className:"text-gray-500",children:["Cells: ",U.cells.map((Mt,pr)=>{var fr;const Wr=(((fr=t.manifest)==null?void 0:fr.cells)||[]).some(Ma=>Ma.letter===Mt&&!Ma.isReference);return e.jsxs("span",{className:Wr?"font-semibold text-gray-800":"text-gray-400",children:[pr>0?", ":"",Mt]},pr)})]}),U.pagesToFix&&U.pagesToFix.length>0&&(()=>{var pr;const Mt=new Set((((pr=t.manifest)==null?void 0:pr.cells)||[]).filter(ft=>!ft.isReference&&ft.pageNumber!=null).map(ft=>ft.pageNumber));return e.jsxs("span",{className:"text-[10px]",children:["Fix: Page"," ",U.pagesToFix.map((ft,Wr)=>{const fr=Mt.has(ft);return e.jsxs("span",{className:`px-1 py-0.5 rounded ${fr?"bg-orange-200 text-orange-800 font-semibold":"bg-gray-200 text-gray-500"}`,title:fr?"Visible in grid above":"Not in this grid",children:[Wr>0?" ":"",ft]},Wr)})]})})(),U.clothingCategory&&e.jsx("span",{className:"px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px]",children:U.clothingCategory}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:U.subType||((re=U.type)==null?void 0:re.replace(/_/g," "))})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:U.description}),U.fixInstruction&&e.jsxs("p",{className:"text-green-700 mt-1 text-[10px]",children:["â†’ ",U.fixInstruction]})]},ze)})]}),B&&(!I||l<8)&&t.entityType==="character"&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[e.jsx("button",{onClick:()=>bs(t.entityName),disabled:y||lr!==null,className:`flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded transition-colors ${y||lr!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:lr===t.entityName?e.jsxs(e.Fragment,{children:[e.jsx(lt,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Repairing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Kr,{className:"w-3 h-3"}),e.jsx("span",{children:"Repair All"})]})}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:"Regenerate all appearances to match reference"})]}),((vt=E.entityRepairs)==null?void 0:vt[t.entityName])&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-medium text-green-700",children:"âœ“ Repaired"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(fe=(Bt=E.entityRepairs)==null?void 0:Bt[t.entityName])!=null&&fe.cellsRepaired?`${(at=E.entityRepairs[t.entityName])==null?void 0:at.cellsRepaired} pages updated`:(ss=(er=E.entityRepairs)==null?void 0:er[t.entityName])!=null&&ss.pages?`${Object.keys(((Ht=E.entityRepairs[t.entityName])==null?void 0:Ht.pages)||{}).length} page(s) repaired individually`:"",(((tr=(ws=E.entityRepairs)==null?void 0:ws[t.entityName])==null?void 0:tr.clothingGroupCount)??0)>1&&` (${(Hr=(Dr=E.entityRepairs)==null?void 0:Dr[t.entityName])==null?void 0:Hr.clothingGroupCount} clothing groups)`]})]}),(Pa=(Qs=(ka=E.entityRepairs)==null?void 0:ka[t.entityName])==null?void 0:Qs.gridsByClothing)!=null&&Pa.length?e.jsx("div",{className:"space-y-3",children:(Xs=(Aa=(Ys=E.entityRepairs)==null?void 0:Ys[t.entityName])==null?void 0:Aa.gridsByClothing)==null?void 0:Xs.map(U=>{var ze;return e.jsxs("div",{className:"border border-gray-200 rounded p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-xs font-medium text-gray-700",children:U.clothingCategory}),e.jsxs("span",{className:"text-[10px] text-gray-400",children:["(",U.cropCount," crops, ref: ",U.referenceUsed,")"]})]}),(ze=U.cellComparisons)!=null&&ze.length?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[9px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Cell"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),U.cellComparisons.map(re=>e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-xs font-bold text-gray-700",children:re.letter}),e.jsxs("div",{className:"text-[9px] text-gray-400",children:["P",re.pageNumber]})]}),e.jsx("img",{src:re.before,alt:`${re.letter} before`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>re.before&&ut({src:re.before,title:`${t.entityName} - Cell ${re.letter} Page ${re.pageNumber} Before (${U.clothingCategory})`})}),e.jsx("img",{src:re.after,alt:`${re.letter} after`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>re.after&&ut({src:re.after,title:`${t.entityName} - Cell ${re.letter} Page ${re.pageNumber} After (${U.clothingCategory})`})}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:re.diff,alt:`${re.letter} diff`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>re.diff&&ut({src:re.diff,title:`${t.entityName} - Cell ${re.letter} Page ${re.pageNumber} Diff (${U.clothingCategory})`})})})]},`${U.clothingCategory}-${re.letter}`))]}):e.jsxs("div",{className:`grid gap-2 ${U.gridDiff?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"Before"}),e.jsx("div",{className:"bg-gray-50 rounded p-0.5",children:e.jsx("img",{src:U.gridBefore,alt:"Before repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>U.gridBefore&&ut({src:U.gridBefore,title:`${t.entityName} - ${U.clothingCategory} Grid Before`})})})]}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"After"}),e.jsx("div",{className:"bg-gray-50 rounded p-0.5",children:e.jsx("img",{src:U.gridAfter,alt:"After repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>U.gridAfter&&ut({src:U.gridAfter,title:`${t.entityName} - ${U.clothingCategory} Grid After`})})})]}),U.gridDiff&&e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"Diff"}),e.jsx("div",{className:"bg-gray-900 rounded p-0.5",children:e.jsx("img",{src:U.gridDiff,alt:"Difference",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>ut({src:U.gridDiff,title:`${t.entityName} - ${U.clothingCategory} Grid Diff`})})})]})]})]},U.clothingCategory)})}):(Ia=(ea=($a=E.entityRepairs)==null?void 0:$a[t.entityName])==null?void 0:ea.cellComparisons)!=null&&Ia.length?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[10px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Cell"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),(ra=(Ta=(ta=E.entityRepairs)==null?void 0:ta[t.entityName])==null?void 0:Ta.cellComparisons)==null?void 0:ra.map(U=>e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-xs font-bold text-gray-700",children:U.letter}),e.jsxs("div",{className:"text-[9px] text-gray-400",children:["P",U.pageNumber]})]}),e.jsx("img",{src:U.before,alt:`${U.letter} before`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>U.before&&ut({src:U.before,title:`${t.entityName} - Cell ${U.letter} Page ${U.pageNumber} Before`})}),e.jsx("img",{src:U.after,alt:`${U.letter} after`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>U.after&&ut({src:U.after,title:`${t.entityName} - Cell ${U.letter} Page ${U.pageNumber} After`})}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:U.diff,alt:`${U.letter} diff`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>U.diff&&ut({src:U.diff,title:`${t.entityName} - Cell ${U.letter} Page ${U.pageNumber} Diff`})})})]},U.letter))]}):(Fr=(Ra=E.entityRepairs)==null?void 0:Ra[t.entityName])!=null&&Fr.pages&&Object.keys(((Da=E.entityRepairs[t.entityName])==null?void 0:Da.pages)||{}).length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[10px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Page"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),Object.entries(((as=E.entityRepairs[t.entityName])==null?void 0:as.pages)||{}).map(([U,ze])=>{var re,Mt,pr;return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("span",{className:"text-xs font-bold text-gray-700",children:["P",U]}),ze.clothingCategory&&ze.clothingCategory!=="standard"&&e.jsx("div",{className:"text-[8px] text-gray-400",children:ze.clothingCategory})]}),e.jsx("img",{src:(re=ze.comparison)==null?void 0:re.before,alt:`P${U} before`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var ft;return((ft=ze.comparison)==null?void 0:ft.before)&&ut({src:ze.comparison.before,title:`${t.entityName} - Page ${U} Before${ze.clothingCategory?` (${ze.clothingCategory})`:""}`})}}),e.jsx("img",{src:(Mt=ze.comparison)==null?void 0:Mt.after,alt:`P${U} after`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var ft;return((ft=ze.comparison)==null?void 0:ft.after)&&ut({src:ze.comparison.after,title:`${t.entityName} - Page ${U} After${ze.clothingCategory?` (${ze.clothingCategory})`:""}`})}}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:(pr=ze.comparison)==null?void 0:pr.diff,alt:`P${U} diff`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var ft;return((ft=ze.comparison)==null?void 0:ft.diff)&&ut({src:ze.comparison.diff,title:`${t.entityName} - Page ${U} Diff${ze.clothingCategory?` (${ze.clothingCategory})`:""}`})}})})]}),ze.promptUsed&&e.jsxs("details",{className:"text-[10px]",children:[e.jsx("summary",{className:"cursor-pointer text-blue-600 hover:text-blue-800",children:"Show Prompt"}),e.jsx("pre",{className:"mt-1 p-2 bg-gray-100 rounded text-gray-700 whitespace-pre-wrap overflow-x-auto max-h-48 text-[9px]",children:ze.promptUsed})]})]},U)})]}):(Ss=(Fa=E.entityRepairs)==null?void 0:Fa[t.entityName])!=null&&Ss.gridBeforeRepair?e.jsxs("div",{className:`grid gap-3 ${(Cs=(Ea=E.entityRepairs)==null?void 0:Ea[t.entityName])!=null&&Cs.gridDiff?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"Before Repair"}),e.jsx("div",{className:"bg-gray-50 rounded p-1",children:e.jsx("img",{src:(ks=(za=E.entityRepairs)==null?void 0:za[t.entityName])==null?void 0:ks.gridBeforeRepair,alt:"Before repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var ze,re;const U=(re=(ze=E.entityRepairs)==null?void 0:ze[t.entityName])==null?void 0:re.gridBeforeRepair;U&&ut({src:U,title:`${t.entityName} - Grid Before Repair`})}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"After Repair"}),e.jsx("div",{className:"bg-gray-50 rounded p-1",children:e.jsx("img",{src:(Ps=(sa=E.entityRepairs)==null?void 0:sa[t.entityName])==null?void 0:Ps.gridAfterRepair,alt:"After repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var ze,re;const U=(re=(ze=E.entityRepairs)==null?void 0:ze[t.entityName])==null?void 0:re.gridAfterRepair;U&&ut({src:U,title:`${t.entityName} - Grid After Repair`})}})})]}),((Er=(Ba=E.entityRepairs)==null?void 0:Ba[t.entityName])==null?void 0:Er.gridDiff)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"Difference"}),e.jsx("div",{className:"bg-gray-900 rounded p-1",children:e.jsx("img",{src:((wt=(As=E.entityRepairs)==null?void 0:As[t.entityName])==null?void 0:wt.gridDiff)??void 0,alt:"Difference",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var ze,re;const U=(re=(ze=E.entityRepairs)==null?void 0:ze[t.entityName])==null?void 0:re.gridDiff;U&&ut({src:U,title:`${t.entityName} - Grid Diff`})}})})]})]}):null]})]})]},u)})})]})]}),E&&e.jsxs("details",{className:`border-2 rounded-xl p-4 ${E.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsxs("summary",{className:`cursor-pointer text-lg font-bold flex items-center gap-2 ${E.overallConsistent?"text-green-800 hover:text-green-900":"text-amber-800 hover:text-amber-900"}`,children:[E.overallConsistent?"âœ“":"âš ï¸",a==="de"?`KonsistenzprÃ¼fung (${(E.totalIssues||0)-(((Rr=E.entity)==null?void 0:Rr.totalIssues)||0)} Probleme)`:a==="fr"?`VÃ©rification de cohÃ©rence (${(E.totalIssues||0)-(((Sa=E.entity)==null?void 0:Sa.totalIssues)||0)} problÃ¨mes)`:`Final Checks (${(E.totalIssues||0)-(((Zs=E.entity)==null?void 0:Zs.totalIssues)||0)} issues)`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-700",children:E.summary}),E.imageChecks&&E.imageChecks.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"Bildkonsistenz":a==="fr"?"CohÃ©rence des images":"Image Consistency"}),E.imageChecks.map((t,u)=>{var c,I;return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${t.consistent?"text-green-600":"text-amber-600"}`,children:t.consistent?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:t.type==="full"?"Full Check":t.type==="character"?`Character: ${t.characterName}`:t.type==="sequence"?"Sequence Check":t.type}),t.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",t.overallScore,"/10"]})]}),t.issues&&t.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:t.issues.map((l,ne)=>{var ee,Ee;return e.jsxs("div",{className:`text-xs p-2 rounded ${l.severity==="high"?"bg-red-50 border-l-4 border-red-400":l.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${l.severity==="high"?"bg-red-200 text-red-800":l.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:l.severity}),e.jsxs("span",{className:"text-gray-500",children:["Pages ",(ee=l.images)==null?void 0:ee.join(", ")]}),l.pagesToFix&&l.pagesToFix.length>0&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px]",children:["Fix: ",l.pagesToFix.join(", ")]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:(Ee=l.type)==null?void 0:Ee.replace(/_/g," ")}),l.characterInvolved&&e.jsx("span",{className:"px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px]",children:l.characterInvolved})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:l.description}),l.details&&Object.keys(l.details).length>0&&e.jsx("div",{className:"mt-1 pl-2 border-l-2 border-gray-200",children:Object.entries(l.details).map(([we,gt])=>e.jsxs("p",{className:"text-gray-500 text-[10px]",children:[e.jsxs("span",{className:"font-medium",children:[we,":"]})," ",gt]},we))}),l.canonicalVersion&&e.jsxs("p",{className:"text-blue-700 mt-1",children:["ðŸŽ¯ Target: ",l.canonicalVersion]}),l.recommendation&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:["ðŸ’¡ ",l.recommendation]}),B&&l.pagesToFix&&l.pagesToFix.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:l.pagesToFix.map(we=>e.jsx("button",{onClick:()=>ys(we,l),disabled:y||Ve!==null,className:`flex items-center gap-1 px-2 py-1 text-[10px] font-medium rounded transition-colors ${Ve===we?"bg-amber-300 text-amber-800":y||Ve!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:Ve===we?e.jsxs(e.Fragment,{children:[e.jsx(lt,{className:"w-3 h-3 animate-spin"}),e.jsxs("span",{children:["Repairing P",we,"..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Kr,{className:"w-3 h-3"}),e.jsxs("span",{children:["Repair P",we]})]})},we))})]},ne)})}),t.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:t.summary}),(t.evaluationPrompts||t.evaluationPrompt)&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:["ðŸ” View Evaluation Prompt",(((c=t.evaluationPrompts)==null?void 0:c.length)??0)>1?`s (${(I=t.evaluationPrompts)==null?void 0:I.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:(t.evaluationPrompts??(t.evaluationPrompt?[t.evaluationPrompt]:[])).map((l,ne)=>{var ee;return e.jsxs("div",{children:[(((ee=t.evaluationPrompts)==null?void 0:ee.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-blue-700 mb-1",children:["Batch ",ne+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:l})]},ne)})})]}),e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result (Full JSON)"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-96 overflow-y-auto bg-white p-2 rounded border",children:JSON.stringify({type:t.type,characterName:t.characterName,consistent:t.consistent,overallScore:t.overallScore,issues:t.issues,summary:t.summary},null,2)})]}),t.rawResponses&&t.rawResponses.length>0&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:["ðŸ“ View Raw Response",t.rawResponses.length>1?`s (${t.rawResponses.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:t.rawResponses.map((l,ne)=>{var ee;return e.jsxs("div",{children:[(((ee=t.rawResponses)==null?void 0:ee.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-purple-700 mb-1",children:["Batch ",ne+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:l})]},ne)})})]})]},u)})]}),E.textCheck&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"TextqualitÃ¤t":a==="fr"?"QualitÃ© du texte":"Text Quality"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${E.textCheck.quality==="good"?"text-green-600":E.textCheck.quality==="needs_review"?"text-amber-600":"text-red-600"}`,children:E.textCheck.quality==="good"?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:E.textCheck.quality==="good"?"Good":E.textCheck.quality==="needs_review"?"Needs Review":"Has Issues"}),E.textCheck.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",E.textCheck.overallScore,"/10"]})]}),E.textCheck.issues&&E.textCheck.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:E.textCheck.issues.map((t,u)=>e.jsxs("div",{className:`text-xs p-2 rounded ${t.severity==="high"?"bg-red-50 border-l-4 border-red-400":t.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.severity==="high"?"bg-red-200 text-red-800":t.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:t.severity}),t.page&&e.jsxs("span",{className:"text-gray-500",children:["Page ",t.page]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:t.type})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:t.issue}),(t.originalText||t.text)&&e.jsxs("p",{className:"text-red-600 mt-1 line-through",children:['"',t.originalText||t.text,'"']}),t.correctedText&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:['âœ“ "',t.correctedText,'"']}),!t.correctedText&&t.suggestion&&e.jsxs("p",{className:"text-green-700 mt-1",children:["â†’ ",t.suggestion]})]},u))}),E.textCheck.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:E.textCheck.summary}),E.textCheck.fullOriginalText&&e.jsxs("details",{className:"mt-3 bg-gray-50 border border-gray-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-gray-700",children:"ðŸ“„ View Original Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-600 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:E.textCheck.fullOriginalText})]}),E.textCheck.fullCorrectedText&&e.jsxs("details",{className:"mt-3 bg-green-50 border border-green-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-green-800",children:"ðŸ“‹ View Full Corrected Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:E.textCheck.fullCorrectedText})]}),E.textCheck.rawResponse&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:"ðŸ“ View Raw Response"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:E.textCheck.rawResponse})]}),E.textCheck&&e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:JSON.stringify({quality:E.textCheck.quality,overallScore:E.textCheck.overallScore,issues:E.textCheck.issues,summary:E.textCheck.summary,parseError:E.textCheck.parseError},null,2)})]}),E.textCheck.evaluationPrompt&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:"ðŸ” View Evaluation Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:E.textCheck.evaluationPrompt})]})]})]}),E.error&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-2 text-xs text-red-700",children:["Error: ",E.error]})]})]}),S.length>0&&e.jsxs("details",{className:"bg-green-50 border-2 border-green-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-green-800 hover:text-green-900 flex items-center gap-2",children:[e.jsx(Ts,{size:20}),a==="de"?`Alle Szenenbeschreibungen (${S.length})`:a==="fr"?`Toutes les descriptions de scÃ¨nes (${S.length})`:`All Scene Descriptions (${S.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:S.map(t=>e.jsxs("details",{className:"bg-white border border-green-200 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-700 hover:text-green-800",children:Pe==="de"?`Seite ${t.pageNumber}`:Pe==="fr"?`Page ${t.pageNumber}`:`Page ${t.pageNumber}`}),e.jsxs("div",{className:"mt-2 space-y-2",children:[t.outlineExtract&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-amber-700",children:"Outline Extract:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.outlineExtract})]}),t.scenePrompt&&e.jsxs("div",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-purple-700",children:"Scene Prompt:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.scenePrompt})]}),e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Scene Description:"}),t.textModelId&&e.jsxs("span",{className:"ml-2 text-green-600",children:["(",t.textModelId,")"]}),e.jsx("pre",{className:"text-gray-700 mt-1 whitespace-pre-wrap font-mono text-xs overflow-x-auto",children:(()=>{var l;const u=ne=>{if(typeof ne!="string")return ne;try{const ee=JSON.parse(ne);return typeof ee=="string"&&(ee.startsWith("{")||ee.startsWith("["))?u(ee):ee}catch{return ne}},c=typeof t.description=="object"&&((l=t.description)!=null&&l.text)?t.description.text:t.description,I=u(c);return typeof I=="object"&&I!==null?JSON.stringify(I,null,2):String(I)})()})]})]})]},t.pageNumber))})]})]}),T&&Tr(T.frontCover)&&(()=>{var u,c;const t=ts(T.frontCover);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Pe==="de"?"Titelseite":Pe==="fr"?"Couverture":"Front Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ja,{src:Tr(T.frontCover),alt:"Front Cover",className:"w-full rounded-lg shadow-lg",label:"Front Cover"}),v.has("frontCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(lt,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),de&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>cr("front"),disabled:y||!Je||v.has("frontCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||!Je||v.has("frontCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:Je?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(ar,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",ke," ",a==="de"?"Credits":"credits",")"]})]})}),Se&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[j&&e.jsxs("button",{onClick:()=>j("front"),disabled:y,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const I=Ee=>{if(typeof Ee!="string")return Ee;try{const we=JSON.parse(Ee);return typeof we=="string"&&(we.startsWith("{")||we.startsWith("["))?I(we):we}catch{return Ee}},l=t.description,ne=typeof l=="object"&&(l!=null&&l.text)?l.text:l,ee=I(ne);return typeof ee=="object"&&ee!==null?JSON.stringify(ee,null,2):String(ee)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((u=t.referencePhotos)==null?void 0:u.length)??0)>0||(((c=t.landmarkPhotos)==null?void 0:c.length)??0)>0||t.visualBibleGrid)&&e.jsx(ca,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),e.jsx(da,{retryHistory:t.retryHistory,bboxDetection:t.bboxDetection,bboxOverlayImage:t.bboxOverlayImage,language:a,storyId:B,coverType:"front"}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(Rs,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),T&&Tr(T.initialPage)&&(()=>{var u,c;const t=ts(T.initialPage);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Pe==="de"?"Widmungsseite":Pe==="fr"?"Page de dÃ©dicace":"Dedication Page"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ja,{src:Tr(T.initialPage),alt:"Dedication Page",className:"w-full rounded-lg shadow-lg",label:"Dedication Page"}),v.has("initialPage")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(lt,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),de&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>cr("initial"),disabled:y||!Je||v.has("initialPage"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||!Je||v.has("initialPage")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:Je?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(ar,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",ke," ",a==="de"?"Credits":"credits",")"]})]})}),Se&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[j&&e.jsxs("button",{onClick:()=>j("initial"),disabled:y,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const I=Ee=>{if(typeof Ee!="string")return Ee;try{const we=JSON.parse(Ee);return typeof we=="string"&&(we.startsWith("{")||we.startsWith("["))?I(we):we}catch{return Ee}},l=t.description,ne=typeof l=="object"&&(l!=null&&l.text)?l.text:l,ee=I(ne);return typeof ee=="object"&&ee!==null?JSON.stringify(ee,null,2):String(ee)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((u=t.referencePhotos)==null?void 0:u.length)??0)>0||(((c=t.landmarkPhotos)==null?void 0:c.length)??0)>0||t.visualBibleGrid)&&e.jsx(ca,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),e.jsx(da,{retryHistory:t.retryHistory,bboxDetection:t.bboxDetection,bboxOverlayImage:t.bboxOverlayImage,language:a,storyId:B,coverType:"initial"}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(Rs,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),De&&!o&&(T==null?void 0:T.frontCover)&&e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-8 mt-6",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-indigo-700",children:Pe==="de"?"Geschichte wird erstellt...":Pe==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:Pe==="de"?"Die Seiten werden gleich angezeigt":Pe==="fr"?"Les pages seront bientÃ´t affichÃ©es":"Pages will appear shortly"})]})}),ur&&o&&e.jsxs("div",{className:"space-y-8 mt-8",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 text-center mb-6",children:r||(Pe==="de"?"Ihre Geschichte":Pe==="fr"?"Votre histoire":"Your Story")}),_r.slice(0,De?es:_r.length).map((t,u)=>{var we,gt,vt,Bt;const c=u+1,I=c,l=K.find(fe=>fe.pageNumber===I),ne=De?Ie[I]:void 0,ee=!!(l!=null&&l.imageData||ne),Ee=De&&c===es&&!ee;return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:Pe==="de"?`Seite ${c}`:Pe==="fr"?`Page ${c}`:`Page ${c}`}),js?e.jsxs("div",{className:"flex flex-col items-center max-w-2xl mx-auto",children:[Ee?e.jsxs("div",{className:"w-full mb-4 aspect-[4/3] bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg shadow-md flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-indigo-600 font-medium",children:Pe==="de"?"Bild wird erstellt...":Pe==="fr"?"CrÃ©ation de l'image...":"Creating image..."}),e.jsx("p",{className:"text-indigo-400 text-sm mt-1",children:Pe==="de"?"Die nÃ¤chste Seite erscheint bald":Pe==="fr"?"La page suivante arrive bientÃ´t":"Next page coming soon"})]}):l!=null&&l.imageData||ne?e.jsxs("div",{className:"w-full mb-4 relative",children:[e.jsx(Ja,{src:((l==null?void 0:l.imageData)||ne)??"",alt:`Scene for page ${c}`,className:`w-full rounded-lg shadow-md object-cover ${Ft.has(c)?"opacity-50":""}`,label:`Page ${c}`}),Ft.has(c)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(os,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]}),L&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>vs(c),disabled:y||Ft.has(c)||!Je,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||Ft.has(c)||!Je?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:Je?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(ar,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",ke," ",a==="de"?"Credits":"credits",")"]})]}),q&&e.jsxs("button",{onClick:()=>Jr(!0),disabled:y,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),kr(c).length>1&&e.jsxs("button",{onClick:()=>Mr({pageNumber:c,versions:kr(c)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(ls,{size:14}),kr(c).length]})]})}),Se&&e.jsxs("div",{className:"mt-3 space-y-2",children:[_&&e.jsxs("button",{onClick:()=>_(c),disabled:y,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),ae&&e.jsx("button",{onClick:()=>Nt(c),disabled:y||Oe!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||Oe!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:Oe===c?e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Kr,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),Z&&e.jsx("button",{onClick:()=>Gr(c),disabled:y||Kt!==null||Oe!==null,className:`w-full bg-purple-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||Kt!==null||Oe!==null?"opacity-50 cursor-not-allowed":"hover:bg-purple-600"}`,title:a==="de"?"Bild analysieren, 17 Checks durchfÃ¼hren, mit korrigierter Szene neu generieren":a==="fr"?"Analyser l'image, exÃ©cuter 17 vÃ©rifications, rÃ©gÃ©nÃ©rer avec scÃ¨ne corrigÃ©e":"Analyze image, run 17 checks, regenerate with corrected scene",children:Kt===c?e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"animate-spin"}),a==="de"?"Iteriere...":a==="fr"?"ItÃ©ration...":"Iterating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ma,{size:14}),a==="de"?"NÃ¤chste Iteration":a==="fr"?"Prochaine ItÃ©ration":"Next Iteration"]})}),(l==null?void 0:l.repairHistory)&&l.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Kr,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",l.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:l.repairHistory.map((fe,at)=>e.jsxs("div",{className:`border rounded-lg p-3 ${fe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${fe.attempt}`:`Repair ${fe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${fe.success?"text-green-600":"text-red-600"}`,children:["(",fe.success?"âœ“":"âœ—"," ",fe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:fe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",fe.fixPrompt]}),fe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:fe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),fe.beforeImage&&fe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>Qr({beforeImage:fe.beforeImage,afterImage:fe.afterImage,diffImage:fe.diffImage,title:a==="de"?`Reparatur ${fe.attempt}`:`Repair ${fe.attempt}`}),title:a==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:fe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:fe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),fe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:fe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(fe.timestamp).toLocaleTimeString()})]},at))})]}),Xt(c)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Xt(c)})]}),Ns(c)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:Ns(c)})]}),zt(c)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",rs(c)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",rs(c),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:zt(c)})]}),(l==null?void 0:l.prompt)&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",(l==null?void 0:l.modelId)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",l.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:l==null?void 0:l.prompt})]}),((((we=l==null?void 0:l.referencePhotos)==null?void 0:we.length)??0)>0||(((gt=l==null?void 0:l.landmarkPhotos)==null?void 0:gt.length)??0)>0||(l==null?void 0:l.visualBibleGrid))&&l&&e.jsx(ca,{referencePhotos:l.referencePhotos||[],landmarkPhotos:l.landmarkPhotos,visualBibleGrid:l.visualBibleGrid,language:a,storyId:B||void 0,pageNumber:c}),(l==null?void 0:l.qualityScore)!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",(l==null?void 0:l.qualityModelId)&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",l.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${((l==null?void 0:l.qualityScore)??0)>=70?"text-green-600":((l==null?void 0:l.qualityScore)??0)>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round((l==null?void 0:l.qualityScore)??0),"%"]})]}),(l==null?void 0:l.qualityReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:l.qualityReasoning})]})]}),e.jsx(da,{retryHistory:l==null?void 0:l.retryHistory,language:a,storyId:B,pageNumber:l==null?void 0:l.pageNumber}),(l==null?void 0:l.retryHistory)&&l.retryHistory.length>0&&e.jsx(Rs,{retryHistory:l.retryHistory,totalAttempts:(l==null?void 0:l.totalAttempts)||l.retryHistory.length,language:a,onRevertRepair:$e?(fe,at)=>$e(l.pageNumber,at):void 0,storyId:B,pageNumber:l.pageNumber}),(l==null?void 0:l.wasRegenerated)&&(!(l!=null&&l.retryHistory)||l.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),(l==null?void 0:l.originalScore)!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(l.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),(l==null?void 0:l.originalImage)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:l.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),(l==null?void 0:l.originalReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:l.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`w-full flex flex-col items-center justify-center rounded-lg p-8 mb-4 ${y?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Pe==="de"?"Bild wird noch erstellt...":Pe==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Pe==="de"?"Kein Bild fÃ¼r diese Seite":Pe==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"w-full bg-indigo-50 rounded-lg p-6 border-2 border-indigo-200",children:nr?e.jsx("textarea",{value:t.trim(),onChange:fe=>Et(u,fe.target.value),className:"w-full min-h-[400px] p-3 text-gray-800 leading-snug font-serif text-xl text-center bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl text-center",children:t.trim()})})]}):e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-stretch",children:[l&&l.imageData?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:l.imageData,alt:`Scene for page ${c}`,className:`w-full rounded-lg shadow-md object-cover ${Ft.has(c)?"opacity-50":""}`}),Ft.has(c)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(os,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]})]}),L&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>vs(c),disabled:y||Ft.has(c)||!Je,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||Ft.has(c)||!Je?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:Je?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(ar,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",ke," ",a==="de"?"Credits":"credits",")"]})]}),q&&e.jsxs("button",{onClick:()=>Jr(!0),disabled:y,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),kr(c).length>1&&e.jsxs("button",{onClick:()=>Mr({pageNumber:c,versions:kr(c)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(ls,{size:14}),kr(c).length]})]})}),Se&&e.jsxs("div",{className:"mt-3 space-y-2",children:[_&&e.jsxs("button",{onClick:()=>_(c),disabled:y,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),ae&&e.jsx("button",{onClick:()=>Nt(c),disabled:y||Oe!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||Oe!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:Oe===c?e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Kr,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),Z&&e.jsx("button",{onClick:()=>Gr(c),disabled:y||Kt!==null||Oe!==null,className:`w-full bg-purple-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||Kt!==null||Oe!==null?"opacity-50 cursor-not-allowed":"hover:bg-purple-600"}`,title:a==="de"?"Bild analysieren, 17 Checks durchfÃ¼hren, mit korrigierter Szene neu generieren":a==="fr"?"Analyser l'image, exÃ©cuter 17 vÃ©rifications, rÃ©gÃ©nÃ©rer avec scÃ¨ne corrigÃ©e":"Analyze image, run 17 checks, regenerate with corrected scene",children:Kt===c?e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"animate-spin"}),a==="de"?"Iteriere...":a==="fr"?"ItÃ©ration...":"Iterating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ma,{size:14}),a==="de"?"NÃ¤chste Iteration":a==="fr"?"Prochaine ItÃ©ration":"Next Iteration"]})}),(l==null?void 0:l.repairHistory)&&l.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Kr,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",l.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:l.repairHistory.map((fe,at)=>e.jsxs("div",{className:`border rounded-lg p-3 ${fe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${fe.attempt}`:`Repair ${fe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${fe.success?"text-green-600":"text-red-600"}`,children:["(",fe.success?"âœ“":"âœ—"," ",fe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:fe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",fe.fixPrompt]}),fe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:fe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),fe.beforeImage&&fe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>Qr({beforeImage:fe.beforeImage,afterImage:fe.afterImage,diffImage:fe.diffImage,title:a==="de"?`Reparatur ${fe.attempt}`:`Repair ${fe.attempt}`}),title:a==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:fe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:fe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),fe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:fe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(fe.timestamp).toLocaleTimeString()})]},at))})]}),Xt(c)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Xt(c)})]}),Ns(c)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:Ns(c)})]}),zt(c)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",rs(c)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",rs(c),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:zt(c)})]}),l.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",l.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",l.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:l.prompt})]}),((((vt=l.referencePhotos)==null?void 0:vt.length)??0)>0||(((Bt=l.landmarkPhotos)==null?void 0:Bt.length)??0)>0||l.visualBibleGrid)&&e.jsx(ca,{referencePhotos:l.referencePhotos||[],landmarkPhotos:l.landmarkPhotos,visualBibleGrid:l.visualBibleGrid,language:a,storyId:B||void 0,pageNumber:c}),l.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",l.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",l.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${l.qualityScore>=70?"text-green-600":l.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(l.qualityScore),"%"]})]}),l.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:l.qualityReasoning})]})]}),e.jsx(da,{retryHistory:l.retryHistory,language:a,storyId:B,pageNumber:l.pageNumber}),l.retryHistory&&l.retryHistory.length>0&&e.jsx(Rs,{retryHistory:l.retryHistory,totalAttempts:l.totalAttempts||l.retryHistory.length,language:a,onRevertRepair:$e?(fe,at)=>$e(l.pageNumber,at):void 0,storyId:B,pageNumber:l.pageNumber}),l.wasRegenerated&&(!l.retryHistory||l.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),l.originalScore!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(l.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),l.originalImage&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:l.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),l.originalReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:l.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`flex flex-col items-center justify-center rounded-lg p-8 ${y?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Pe==="de"?"Bild wird noch erstellt...":Pe==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Pe==="de"?"Kein Bild fÃ¼r diese Seite":Pe==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"flex flex-col w-full h-full",children:nr?e.jsx("textarea",{value:t.trim(),onChange:fe=>Et(u,fe.target.value),className:"w-full flex-1 min-h-[300px] p-4 text-gray-800 leading-snug font-serif text-xl bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("div",{className:"prose max-w-none",children:e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl",children:t.trim()})})})]})]},c)})]}),T&&Tr(T.backCover)&&(()=>{var u,c;const t=ts(T.backCover);return e.jsxs("div",{className:"mt-8 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Pe==="de"?"RÃ¼ckseite":Pe==="fr"?"QuatriÃ¨me de couverture":"Back Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ja,{src:Tr(T.backCover),alt:"Back Cover",className:"w-full rounded-lg shadow-lg",label:"Back Cover"}),v.has("backCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(lt,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),de&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>cr("back"),disabled:y||!Je||v.has("backCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y||!Je||v.has("backCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:Je?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(ar,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",ke," ",a==="de"?"Credits":"credits",")"]})]})}),Se&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[j&&e.jsxs("button",{onClick:()=>j("back"),disabled:y,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const I=Ee=>{if(typeof Ee!="string")return Ee;try{const we=JSON.parse(Ee);return typeof we=="string"&&(we.startsWith("{")||we.startsWith("["))?I(we):we}catch{return Ee}},l=t.description,ne=typeof l=="object"&&(l!=null&&l.text)?l.text:l,ee=I(ne);return typeof ee=="object"&&ee!==null?JSON.stringify(ee,null,2):String(ee)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((u=t.referencePhotos)==null?void 0:u.length)??0)>0||(((c=t.landmarkPhotos)==null?void 0:c.length)??0)>0||t.visualBibleGrid)&&e.jsx(ca,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),e.jsx(da,{retryHistory:t.retryHistory,bboxDetection:t.bboxDetection,bboxOverlayImage:t.bboxOverlayImage,language:a,storyId:B,coverType:"back"}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(Rs,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),ur&&o&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-4 mt-6",children:[e.jsx("h3",{className:"text-base font-bold text-gray-800 mb-3 text-center",children:a==="de"?"Was mÃ¶chten Sie als NÃ¤chstes tun?":a==="fr"?"Que souhaitez-vous faire ensuite ?":"What would you like to do next?"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[B&&O&&e.jsxs("button",{onClick:O,disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(_n,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),x&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>hs(!jr),disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Ts,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Ut,{size:14,className:`transition-transform ${jr?"rotate-180":""}`})]}),jr&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:St==="square",onChange:()=>gs("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:St==="A4",onChange:()=>gs("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{x(St),hs(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),q&&!nr&&e.jsxs("button",{onClick:()=>Jr(!0),disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(kt,{size:16})," ",a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),he&&e.jsxs("button",{onClick:he,disabled:y,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${y?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Ln,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]})]}),nr&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-lg p-3 md:p-4 z-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-2 md:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-600",children:[e.jsx(kt,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"font-semibold text-sm md:text-base",children:a==="de"?"Bearbeitungsmodus":a==="fr"?"Mode Ã©dition":"Edit Mode"}),qe&&e.jsxs("span",{className:"text-xs text-gray-500 hidden sm:inline",children:["(",a==="de"?"Original gespeichert":a==="fr"?"Original sauvegardÃ©":"Original saved",")"]})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto justify-center md:justify-end",children:[e.jsxs("button",{onClick:dr,disabled:ir,className:"px-3 md:px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(qt,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"})]}),qe&&Zr!==qe&&e.jsxs("button",{onClick:()=>cs(qe),disabled:ir,className:"px-3 md:px-4 py-2 border border-amber-400 text-amber-700 rounded-lg hover:bg-amber-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(ma,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"ZurÃ¼cksetzen":a==="fr"?"Restaurer":"Restore"})]}),e.jsxs("button",{onClick:va,disabled:ir,className:`px-3 md:px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold flex items-center gap-1.5 ${ir?"opacity-50 cursor-not-allowed":"hover:bg-green-600"}`,children:[e.jsx(Is,{size:16}),ir?a==="de"?"Speichern...":a==="fr"?"Sauvegarde...":"Saving...":a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save"]})]})]})}),We&&e.jsx(Ro,{pageNumber:We.pageNumber,scene:We.scene,onSceneChange:t=>vr({...We,scene:t}),onClose:()=>vr(null),onRegenerate:Ar,isRegenerating:Ft.has(We.pageNumber),imageRegenerationCost:ke,characters:w.map(t=>({id:t.id,name:t.name})),selectedCharacterIds:We.selectedCharacterIds,onCharacterSelectionChange:t=>vr({...We,selectedCharacterIds:t}),consistencyRegen:Se?(Ca=K.find(t=>t.pageNumber===We.pageNumber))==null?void 0:Ca.consistencyRegen:void 0}),Ue&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(ar,{size:20}),a==="de"?"Cover bearbeiten":a==="fr"?"Modifier la couverture":"Edit Cover"," - ",Ue.coverType==="front"?a==="de"?"Titelseite":a==="fr"?"Couverture":"Front Cover":Ue.coverType==="initial"?a==="de"?"Einleitungsseite":a==="fr"?"Page de dÃ©dicace":"Dedication Page":a==="de"?"RÃ¼ckseite":a==="fr"?"Dos":"Back Cover"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a==="de"?"Bearbeite die Szenenbeschreibung und wÃ¤hle die Charaktere aus":a==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages":"Edit the scene description and select the characters"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[w.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(Es,{size:16}),a==="de"?"Charaktere auf dem Cover:":a==="fr"?"Personnages sur la couverture:":"Characters on the cover:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:w.map(t=>{const u=Ue.selectedCharacterIds.includes(t.id);return e.jsxs("button",{type:"button",onClick:()=>{const c=u?Ue.selectedCharacterIds.filter(I=>I!==t.id):[...Ue.selectedCharacterIds,t.id];Fe({...Ue,selectedCharacterIds:c})},className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${u?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:t.name}),u&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},t.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"WÃ¤hle die Charaktere aus, die auf dem Cover erscheinen sollen.":a==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre sur la couverture.":"Select the characters that should appear on the cover."})]}),Ue.coverType==="front"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Titel:":a==="fr"?"Titre:":"Title:"}),e.jsx("input",{type:"text",value:Ue.title||"",onChange:t=>Fe({...Ue,title:t.target.value}),placeholder:a==="de"?"Der Titel des Buches":a==="fr"?"Le titre du livre":"The book title",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),Ue.coverType==="initial"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Widmung:":a==="fr"?"DÃ©dicace:":"Dedication:"}),e.jsx("input",{type:"text",value:Ue.dedication||"",onChange:t=>Fe({...Ue,dedication:t.target.value}),placeholder:a==="de"?'z.B. "FÃ¼r meine liebste Tochter Emma"':a==="fr"?'par ex. "Pour ma chÃ¨re fille Emma"':'e.g. "For my dear daughter Emma"',className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:a==="de"?"Leer lassen fÃ¼r keine Widmung":a==="fr"?"Laisser vide pour aucune dÃ©dicace":"Leave empty for no dedication"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Szenenbeschreibung:":a==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:Ue.scene,onChange:t=>Fe({...Ue,scene:t.target.value}),placeholder:a==="de"?'z.B. "Die Hauptfigur steht vor einem magischen Schloss bei Sonnenuntergang"':a==="fr"?'par ex. "Le personnage principal devant un chÃ¢teau magique au coucher du soleil"':'e.g. "The main character standing in front of a magical castle at sunset"',className:"w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"Tipp: Beschreibe die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":a==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:Ue.selectedCharacterIds.length>0&&e.jsx("span",{children:a==="de"?`${Ue.selectedCharacterIds.length} Charakter(e) ausgewÃ¤hlt`:a==="fr"?`${Ue.selectedCharacterIds.length} personnage(s) sÃ©lectionnÃ©(s)`:`${Ue.selectedCharacterIds.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:()=>Fe(null),className:"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium order-2 sm:order-1",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"}),e.jsxs("button",{onClick:$r,disabled:v.has(Ue.coverType==="front"?"frontCover":Ue.coverType==="initial"?"initialPage":"backCover")||Ue.selectedCharacterIds.length===0,className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${v.has(Ue.coverType==="front"?"frontCover":Ue.coverType==="initial"?"initialPage":"backCover")||Ue.selectedCharacterIds.length===0?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:[e.jsx(ar,{size:16}),a==="de"?"Neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",ke," ",a==="de"?"Credits":"credits",")"]})]})]})]})]})}),st&&e.jsx(Do,{pageNumber:st.pageNumber,versions:st.versions,onClose:()=>Mr(null),onSelectVersion:At,developerMode:Se}),jt&&e.jsx(Fo,{src:jt.src,title:jt.title,onClose:()=>ut(null)}),Jt&&e.jsx(Eo,{beforeImage:Jt.beforeImage,afterImage:Jt.afterImage,diffImage:Jt.diffImage,title:Jt.title,onClose:()=>Qr(null)})]})}const Qa={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.5 - Best narrative quality",descriptionDe:"Claude Sonnet 4.5 - Beste ErzÃ¤hlqualitÃ¤t",descriptionFr:"Claude Sonnet 4.5 - Meilleure qualitÃ© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 3.5 - Fast and cheap",descriptionDe:"Claude Haiku 3.5 - Schnell und gÃ¼nstig",descriptionFr:"Claude Haiku 3.5 - Rapide et Ã©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe QualitÃ¤t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualitÃ©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - TrÃ¨s rapide"}},Jn={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide de scÃ¨nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra gÃ¼nstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra Ã©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere QualitÃ¤t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualitÃ© ($0.004/image)"}},Lo={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - Ã‰valuation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - GrÃ¼ndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},Go={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste QualitÃ¤t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualitÃ© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra gÃ¼nstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra Ã©conomique pour tests ($0.0006/image)"}},_o={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - GÃ¼nstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars Ã©conomiques avec visage cohÃ©rent (~$0.005)"}};function Br({label:r,icon:d,value:o,options:m,onChange:s,language:D}){const h=N=>D==="de"&&N.descriptionDe?N.descriptionDe:D==="fr"&&N.descriptionFr?N.descriptionFr:N.description;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[d,r]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:o||"",onChange:N=>s(N.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:D==="de"?"Server-Standard":D==="fr"?"Par dÃ©faut serveur":"Server Default"}),Object.entries(m).map(([N,$])=>e.jsxs("option",{value:N,children:[N," ",$.provider?`(${$.provider})`:""]},N))]}),e.jsx(Ut,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),o&&m[o]&&e.jsx("p",{className:"text-[10px] text-gray-500 italic",children:h(m[o])})]})}function Ho({selections:r,onChange:d}){const{language:o}=br(),m=(s,D)=>{d({...r,[s]:D})};return e.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[e.jsx(io,{size:16}),o==="de"?"AI-Modell Auswahl (Dev)":o==="fr"?"SÃ©lection de modÃ¨le IA (Dev)":"AI Model Selection (Dev)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(Br,{label:o==="de"?"Ideen-Modell":o==="fr"?"ModÃ¨le d'idÃ©es":"Idea Model",icon:e.jsx(lo,{size:12}),value:r.ideaModel,options:Qa,onChange:s=>m("ideaModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Geschichte (Kombiniert)":o==="fr"?"Histoire (CombinÃ©)":"Story (Combined)",icon:e.jsx(Ds,{size:12}),value:r.outlineModel,options:Qa,onChange:s=>m("outlineModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Text-Modell":o==="fr"?"ModÃ¨le de texte":"Text Model",icon:e.jsx(Ds,{size:12}),value:r.textModel,options:Qa,onChange:s=>m("textModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Szenen-Modell":o==="fr"?"ModÃ¨le de scÃ¨ne":"Scene Description Model",icon:e.jsx(oi,{size:12}),value:r.sceneDescriptionModel,options:Qa,onChange:s=>m("sceneDescriptionModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Bild-Modell":o==="fr"?"ModÃ¨le d'image":"Image Model",icon:e.jsx(Gn,{size:12}),value:r.imageModel,options:Jn,onChange:s=>m("imageModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Cover-Modell":o==="fr"?"ModÃ¨le de couverture":"Cover Image Model",icon:e.jsx(fo,{size:12}),value:r.coverImageModel,options:Jn,onChange:s=>m("coverImageModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Bewertungs-Modell":o==="fr"?"ModÃ¨le d'Ã©valuation":"Quality Eval Model",icon:e.jsx(qi,{size:12}),value:r.qualityModel,options:Lo,onChange:s=>m("qualityModel",s),language:o}),e.jsx(Br,{label:o==="de"?"Bild-Reparatur":o==="fr"?"RÃ©paration d'image":"Image Repair",icon:e.jsx(xo,{size:12}),value:r.imageBackend,options:Go,onChange:s=>m("imageBackend",s),language:o}),e.jsx(Br,{label:o==="de"?"Avatar-Modell":o==="fr"?"ModÃ¨le d'avatar":"Avatar Model",icon:e.jsx(Gn,{size:12}),value:r.avatarModel,options:_o,onChange:s=>m("avatarModel",s),language:o})]}),e.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:o==="de"?'Hinweis: Nur sichtbar fÃ¼r Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':o==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode dÃ©veloppeur. "Par dÃ©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}function Zn(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const Ya=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair"];function Wo({storyId:r,sceneImages:d,characters:o,finalChecksReport:m,imageModel:s,onImageUpdate:D}){const[h,N]=n.useState(Zn),[$,K]=n.useState({current:0,total:0,currentPage:void 0}),S=n.useMemo(()=>Object.values(h.stepStatus).some(W=>W==="in-progress"),[h.stepStatus]),T=n.useMemo(()=>Ya.indexOf(h.currentStep),[h.currentStep]),v=n.useCallback(W=>{N(X=>({...X,currentStep:W,stepStatus:{...X.stepStatus,[W]:"in-progress"}}))},[]),k=n.useCallback((W,X)=>{N(Q=>({...Q,stepStatus:{...Q.stepStatus,[W]:"completed"},...W==="collect-feedback"&&X?{collectedFeedback:X}:{},...W==="re-evaluate"&&X?{reEvaluationResults:X}:{},...W==="consistency-check"&&X?{consistencyResults:X}:{}}))},[]),C=n.useCallback((W,X)=>{N(Q=>({...Q,stepStatus:{...Q.stepStatus,[W]:"failed"}}))},[]),y=n.useCallback(W=>{N(X=>({...X,stepStatus:{...X.stepStatus,[W]:"skipped"}}))},[]),x=n.useCallback(()=>{N(Zn()),K({current:0,total:0,currentPage:void 0})},[]),O=n.useCallback(async()=>{var W,X,Q,E,V;if(r){v("collect-feedback");try{const pe={};let J=0;for(const oe of d){const H={pageNumber:oe.pageNumber,qualityScore:oe.qualityScore,fixableIssues:[],entityIssues:[],objectIssues:[],semanticIssues:[],manualNotes:"",needsFullRedo:!1},De=(W=oe.retryHistory)==null?void 0:W.slice(-1)[0];if((X=De==null?void 0:De.postRepairEval)!=null&&X.fixableIssues?H.fixableIssues=De.postRepairEval.fixableIssues:(Q=De==null?void 0:De.preRepairEval)!=null&&Q.fixableIssues&&(H.fixableIssues=De.preRepairEval.fixableIssues),m!=null&&m.entity){for(const[Be,Ie]of Object.entries(m.entity.characters||{})){const qe=[];if(Ie.byClothing)for(const se of Object.values(Ie.byClothing))se.issues&&qe.push(...se.issues);Ie.issues&&qe.push(...Ie.issues);const q=qe.filter(se=>{var ve;return((ve=se.pagesToFix)==null?void 0:ve.includes(oe.pageNumber))||se.pageNumber===oe.pageNumber});for(const se of q)H.entityIssues.push({character:Be,issue:se.description,severity:se.severity})}for(const[Be,Ie]of Object.entries(m.entity.objects||{})){const qe=[];if(Ie.byClothing)for(const se of Object.values(Ie.byClothing))se.issues&&qe.push(...se.issues);Ie.issues&&qe.push(...Ie.issues);const q=qe.filter(se=>{var ve;return((ve=se.pagesToFix)==null?void 0:ve.includes(oe.pageNumber))||se.pageNumber===oe.pageNumber});for(const se of q)H.objectIssues.push({object:Be,issue:se.description,severity:se.severity})}}if(m!=null&&m.imageChecks)for(const Be of m.imageChecks)for(const Ie of Be.issues||[])(((E=Ie.pagesToFix)==null?void 0:E.includes(oe.pageNumber))||((V=Ie.images)==null?void 0:V.includes(oe.pageNumber)))&&H.semanticIssues.push({type:Ie.type,description:Ie.description,severity:Ie.severity,characterInvolved:Ie.characterInvolved,recommendation:Ie.recommendation});J+=H.fixableIssues.length+H.entityIssues.length+H.objectIssues.length+H.semanticIssues.length,pe[oe.pageNumber]=H}k("collect-feedback",{pages:pe,totalIssues:J})}catch(pe){console.error("Failed to collect feedback:",pe),C("collect-feedback",pe instanceof Error?pe.message:"Unknown error")}}},[r,d,m,v,k,C]),be=n.useCallback((W,X)=>{N(Q=>({...Q,collectedFeedback:{...Q.collectedFeedback,pages:{...Q.collectedFeedback.pages,[W]:{...Q.collectedFeedback.pages[W],...X}}}}))},[]),he=n.useCallback((W,X)=>{N(Q=>{const E=Q.redoPages.pageNumbers.includes(W),V=E?Q.redoPages.pageNumbers.filter(J=>J!==W):[...Q.redoPages.pageNumbers,W].sort((J,oe)=>J-oe),pe={...Q.redoPages.reasons};return E?delete pe[W]:X&&(pe[W]=X),{...Q,redoPages:{pageNumbers:V,reasons:pe}}})},[]),A=n.useCallback((W=6,X=3)=>{v("identify-redo-pages");const Q=[],E={};for(const[V,pe]of Object.entries(h.collectedFeedback.pages)){const J=parseInt(V),oe=pe.fixableIssues.length+pe.entityIssues.length,H=pe.qualityScore??10;H<W?(Q.push(J),E[J]=`Low quality score: ${H}`):oe>=X?(Q.push(J),E[J]=`Too many issues: ${oe}`):pe.needsFullRedo&&(Q.push(J),E[J]="Manually marked for redo")}N(V=>({...V,redoPages:{pageNumbers:Q.sort((pe,J)=>pe-J),reasons:E},stepStatus:{...V.stepStatus,"identify-redo-pages":"completed"}}))},[h.collectedFeedback.pages,v]),L=n.useCallback(async()=>{var E;if(!r||h.redoPages.pageNumbers.length===0)return;v("redo-pages");const W=h.redoPages.pageNumbers;K({current:0,total:W.length,currentPage:void 0});const X=[],Q={};try{for(let V=0;V<W.length;V++){const pe=W[V];K({current:V,total:W.length,currentPage:pe});try{const J=await Le.iteratePage(r,pe,s);if(J.success){X.push(pe);const oe=d.find(De=>De.pageNumber===pe),H=((E=oe==null?void 0:oe.imageVersions)==null?void 0:E.length)??0;Q[pe]=H,D&&D(pe,J.imageData,H)}}catch(J){console.error(`Failed to redo page ${pe}:`,J)}}N(V=>({...V,redoResults:{pagesCompleted:X,newVersions:Q},stepStatus:{...V.stepStatus,"redo-pages":"completed"}})),K({current:W.length,total:W.length,currentPage:void 0})}catch(V){console.error("Redo pages failed:",V),C("redo-pages",V instanceof Error?V.message:"Unknown error")}},[r,h.redoPages.pageNumbers,s,d,D,v,C]),de=n.useCallback(async W=>{if(!r)return;v("re-evaluate");const X=W??h.redoResults.pagesCompleted;if(X.length===0){y("re-evaluate");return}try{const Q=await Le.reEvaluatePages(r,X),E={};for(const[V,pe]of Object.entries(Q.pages||{})){const J=pe;E[parseInt(V)]={qualityScore:J.qualityScore,rawScore:J.rawScore,verdict:J.verdict,issuesSummary:J.issuesSummary,reasoning:J.reasoning,fixableIssues:J.fixableIssues}}k("re-evaluate",{pages:E})}catch(Q){console.error("Re-evaluation failed:",Q),C("re-evaluate",Q instanceof Error?Q.message:"Unknown error")}},[r,h.redoResults.pagesCompleted,v,k,C,y]),w=n.useCallback(async()=>{if(r){v("consistency-check");try{const W=await Le.runEntityConsistency(r);k("consistency-check",{report:W.report})}catch(W){console.error("Consistency check failed:",W),C("consistency-check",W instanceof Error?W.message:"Unknown error")}}},[r,v,k,C]),_=n.useCallback(async(W,X)=>{var Q,E;if(!(!r||X.length===0)){v("character-repair");try{const pe=((E=(Q=(await Le.repairCharacters(r,[{character:W,pages:X}])).results)==null?void 0:Q[0])==null?void 0:E.pagesRepaired)||X;N(J=>({...J,characterRepairResults:{charactersProcessed:[...J.characterRepairResults.charactersProcessed,W],pagesRepaired:{...J.characterRepairResults.pagesRepaired,[W]:pe}},stepStatus:{...J.stepStatus,"character-repair":"completed"}}))}catch(V){console.error("Character repair failed:",V),C("character-repair",V instanceof Error?V.message:"Unknown error")}}},[r,v,C]),j=n.useCallback(async W=>{if(!(!r||W.length===0)){v("artifact-repair");try{const X=await Le.repairArtifacts(r,W);N(Q=>({...Q,artifactRepairResults:{pagesProcessed:X.pagesProcessed||W,issuesFixed:X.issuesFixed||0},stepStatus:{...Q.stepStatus,"artifact-repair":"completed"}}))}catch(X){console.error("Artifact repair failed:",X),C("artifact-repair",X instanceof Error?X.message:"Unknown error")}}},[r,v,C]),ae=n.useCallback(W=>{const X=Ya.indexOf(W);if(W==="idle")return!0;if(S)return!1;switch(W){case"collect-feedback":return!0;case"identify-redo-pages":return h.stepStatus["collect-feedback"]==="completed";case"redo-pages":return h.redoPages.pageNumbers.length>0;case"re-evaluate":return h.stepStatus["redo-pages"]==="completed"||h.stepStatus["redo-pages"]==="skipped";case"consistency-check":return X>Ya.indexOf("collect-feedback");case"character-repair":return h.stepStatus["consistency-check"]==="completed";case"artifact-repair":return h.stepStatus["collect-feedback"]==="completed";default:return!1}},[h,S]),Z=n.useCallback(W=>{const X=Ya.indexOf(W);return X>0?X:0},[]),$e=n.useCallback(()=>Object.entries(h.collectedFeedback.pages).filter(([W,X])=>{const Q=X.qualityScore??10,E=X.fixableIssues.length+X.entityIssues.length;return Q<7||E>0||X.needsFullRedo}).map(([W])=>parseInt(W)).sort((W,X)=>W-X),[h.collectedFeedback.pages]),Te=n.useCallback(()=>{const W=h.consistencyResults.report;return W!=null&&W.characters?Object.entries(W.characters).filter(([X,Q])=>{var E;return"overallConsistent"in Q?!Q.overallConsistent||(Q.totalIssues??0)>0:!Q.consistent||(((E=Q.issues)==null?void 0:E.length)??0)>0}).map(([X])=>X):[]},[h.consistencyResults.report]),B=n.useCallback(W=>{var V;const X=h.consistencyResults.report;if(!((V=X==null?void 0:X.characters)!=null&&V[W]))return[];const Q=X.characters[W],E=new Set;if(Q.byClothing){for(const pe of Object.values(Q.byClothing))for(const J of pe.issues||[])if(J.severity==="major"||J.severity==="critical"){for(const oe of J.pagesToFix||[])E.add(oe);J.pageNumber&&E.add(J.pageNumber)}}if(Q.issues){for(const pe of Q.issues)if(pe.severity==="major"||pe.severity==="critical"){for(const J of pe.pagesToFix||[])E.add(J);pe.pageNumber&&E.add(pe.pageNumber)}}return Array.from(E).sort((pe,J)=>pe-J)},[h.consistencyResults.report]),Se=n.useCallback(async(W={})=>{var pe,J,oe;if(!r)return;const{scoreThreshold:X=6,issueThreshold:Q=3,maxRetries:E=4,onProgress:V}=W;try{V==null||V("collect-feedback","Collecting existing issues..."),await O(),V==null||V("re-evaluate","Evaluating all pages...");const H=await Le.reEvaluatePages(r,d.map(ve=>ve.pageNumber)),De={};for(const[ve,ke]of Object.entries(H.pages||{})){const Ae=ke;De[parseInt(ve)]=Ae}V==null||V("identify-redo-pages","Identifying pages needing redo...");const Be=[];for(const[ve,ke]of Object.entries(De)){const Ae=parseInt(ve),_e=ke.rawScore??Math.round(ke.qualityScore/10),Xe=((pe=ke.fixableIssues)==null?void 0:pe.length)??0;(_e<X||Xe>=Q)&&Be.push(Ae)}Be.sort((ve,ke)=>ve-ke),N(ve=>({...ve,redoPages:{pageNumbers:Be,reasons:{}},stepStatus:{...ve.stepStatus,"identify-redo-pages":"completed"}}));const Ie=[];if(Be.length>0){V==null||V("redo-pages",`Redoing ${Be.length} pages...`),v("redo-pages");const ve={};for(let ke=0;ke<Be.length;ke++){const Ae=Be[ke];let _e=0,Xe="",et=0;for(let ot=1;ot<=E;ot++){V==null||V("redo-pages",`Page ${Ae}: attempt ${ot}/${E}`),K({current:ke,total:Be.length,currentPage:Ae});try{const a=await Le.iteratePage(r,Ae,s);if(a.success){const Pe=a.qualityScore??0;if(Pe>_e){_e=Pe,Xe=a.imageData;const Je=d.find(Me=>Me.pageNumber===Ae);et=(((J=Je==null?void 0:Je.imageVersions)==null?void 0:J.length)??0)+ot-1}if(Pe>=X*10)break}}catch(a){console.error(`Failed to redo page ${Ae} attempt ${ot}:`,a)}}Xe&&(ve[Ae]={score:_e,imageData:Xe,versionIndex:et},Ie.push(Ae),D==null||D(Ae,Xe,et))}N(ke=>({...ke,redoResults:{pagesCompleted:Ie,newVersions:Object.fromEntries(Object.entries(ve).map(([Ae,_e])=>[Ae,_e.versionIndex]))},stepStatus:{...ke.stepStatus,"redo-pages":"completed"}}))}Ie.length>0&&(V==null||V("re-evaluate","Re-evaluating redone pages..."),await de(Ie)),V==null||V("consistency-check","Running consistency check...");const q=(await Le.runEntityConsistency(r)).report;if(N(ve=>({...ve,consistencyResults:{report:q},stepStatus:{...ve.stepStatus,"consistency-check":"completed"}})),q!=null&&q.characters){const ve=Object.entries(q.characters).filter(([ke,Ae])=>{var _e;return"overallConsistent"in Ae?!Ae.overallConsistent||(Ae.totalIssues??0)>0:!Ae.consistent||(((_e=Ae.issues)==null?void 0:_e.length)??0)>0}).map(([ke])=>ke);if(ve.length>0){V==null||V("character-repair",`Repairing ${ve.length} characters...`);for(const ke of ve){const Ae=q.characters[ke],_e=new Set;if(Ae.byClothing){for(const et of Object.values(Ae.byClothing))for(const ot of et.issues||[])if(ot.severity==="major"||ot.severity==="critical"){for(const a of ot.pagesToFix||[])_e.add(a);ot.pageNumber&&_e.add(ot.pageNumber)}}if(Ae.issues){for(const et of Ae.issues)if(et.severity==="major"||et.severity==="critical"){for(const ot of et.pagesToFix||[])_e.add(ot);et.pageNumber&&_e.add(et.pageNumber)}}const Xe=Array.from(_e).sort((et,ot)=>et-ot);Xe.length>0&&(V==null||V("character-repair",`Repairing ${ke} on ${Xe.length} pages...`),await _(ke,Xe))}}}const se=[];for(const[ve,ke]of Object.entries(De))(oe=ke.fixableIssues)!=null&&oe.some(Ae=>Ae.type==="artifact"||Ae.type==="distortion")&&se.push(parseInt(ve));se.length>0&&(V==null||V("artifact-repair",`Repairing artifacts on ${se.length} pages...`),await j(se)),V==null||V("complete","Workflow complete!")}catch(H){throw console.error("Full workflow failed:",H),H}},[r,d,s,D,O,de,v,K,w,_,j]);return{workflowState:h,isRunning:S,currentStepIndex:T,startStep:v,completeStep:k,failStep:C,skipStep:y,resetWorkflow:x,collectFeedback:O,updatePageFeedback:be,toggleRedoPage:he,autoIdentifyRedoPages:A,redoMarkedPages:L,redoProgress:$,reEvaluatePages:de,runConsistencyCheck:w,repairCharacter:_,repairArtifacts:j,runFullWorkflow:Se,canProceedToStep:ae,getStepNumber:Z,getPagesNeedingAttention:$e,getCharactersWithIssues:Te,getPagesWithSevereIssuesForCharacter:B}}const Ur={idle:{label:"Ready",icon:li,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:ii,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:Nn,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:ar,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:Fs,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:Es,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:Es,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:di,description:"Fix remaining artifacts via grid repair"}};function Vo({status:r}){const d={pending:{color:"bg-gray-100 text-gray-600",icon:li},"in-progress":{color:"bg-blue-100 text-blue-600",icon:lt},completed:{color:"bg-green-100 text-green-600",icon:Fs},skipped:{color:"bg-yellow-100 text-yellow-600",icon:po},failed:{color:"bg-red-100 text-red-600",icon:wn}},{color:o,icon:m}=d[r],s=r==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${o}`,children:[e.jsx(m,{className:`w-3 h-3 ${s?"animate-spin":""}`}),r]})}function qo({feedback:r,isMarkedForRedo:d,onToggleRedo:o,onUpdateNotes:m}){var $,K;const[s,D]=n.useState(!1),h=r.fixableIssues.length+r.entityIssues.length+((($=r.objectIssues)==null?void 0:$.length)||0)+(((K=r.semanticIssues)==null?void 0:K.length)||0),N=h>0||r.qualityScore!==void 0&&r.qualityScore<7;return e.jsxs("div",{className:`border rounded-lg p-3 ${d?"border-red-300 bg-red-50":N?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>D(!s),className:"p-1 hover:bg-gray-100 rounded",children:s?e.jsx(Ut,{className:"w-4 h-4"}):e.jsx(zs,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",r.pageNumber]}),r.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${r.qualityScore>=8?"bg-green-100 text-green-700":r.qualityScore>=6?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",r.qualityScore]}),h>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[h," issues"]})]}),e.jsx("button",{onClick:o,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${d?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:d?"Marked for Redo":"Mark for Redo"})]}),s&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[r.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Quality Issues (",r.fixableIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:r.fixableIssues.map((S,T)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${S.severity==="critical"?"bg-red-100 text-red-700":S.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:S.severity}),e.jsxs("span",{children:["[",S.type,"] ",S.description]})]},T))})]}),r.entityIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Character Consistency (",r.entityIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:r.entityIssues.map((S,T)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:S.character}),e.jsx("span",{className:`px-1 rounded ${S.severity==="critical"?"bg-red-100 text-red-700":S.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:S.severity}),e.jsx("span",{children:S.issue})]},T))})]}),r.objectIssues&&r.objectIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Object Consistency (",r.objectIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:r.objectIssues.map((S,T)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-blue-100 text-blue-700",children:S.object}),e.jsx("span",{className:`px-1 rounded ${S.severity==="critical"?"bg-red-100 text-red-700":S.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:S.severity}),e.jsx("span",{children:S.issue})]},T))})]}),r.semanticIssues&&r.semanticIssues.length>0&&e.jsxs("div",{children:[e.jsxs("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:["Semantic Issues (",r.semanticIssues.length,"):"]}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:r.semanticIssues.map((S,T)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-indigo-100 text-indigo-700",children:S.type.replace(/_/g," ")}),S.characterInvolved&&e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:S.characterInvolved}),e.jsx("span",{className:`px-1 rounded ${S.severity==="high"?"bg-red-100 text-red-700":S.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:S.severity}),e.jsx("span",{children:S.description})]},T))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:r.manualNotes,onChange:S=>m(S.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}function Uo({storyId:r,sceneImages:d,characters:o,finalChecksReport:m,imageModel:s,onImageUpdate:D,onRefreshStory:h,autoRunFullWorkflow:N=!1}){const[$,K]=n.useState(!0),[S,T]=n.useState(new Set(["collect-feedback"])),{workflowState:v,isRunning:k,resetWorkflow:C,collectFeedback:y,updatePageFeedback:x,toggleRedoPage:O,autoIdentifyRedoPages:be,redoMarkedPages:he,redoProgress:A,reEvaluatePages:L,runConsistencyCheck:de,repairCharacter:w,repairArtifacts:_,runFullWorkflow:j,getStepNumber:ae,getCharactersWithIssues:Z,getPagesWithSevereIssuesForCharacter:$e}=Wo({storyId:r,sceneImages:d,characters:o,finalChecksReport:m,imageModel:s,onImageUpdate:D}),[Te,B]=n.useState(null),[Se,W]=n.useState(!1),X=n.useRef(null);n.useEffect(()=>{N&&r&&d.length>0&&!k&&!Se&&X.current!==r&&(X.current=r,console.log("[RepairWorkflowPanel] Auto-triggering full repair workflow for story:",r),setTimeout(()=>{Q()},500))},[N,r,d.length,k,Se]);const Q=async()=>{W(!0);try{await j({scoreThreshold:6,issueThreshold:3,maxRetries:4,onProgress:(q,se)=>{B({step:q,detail:se})}}),h&&await h()}catch(q){console.error("Full workflow failed:",q)}finally{W(!1),B(null)}},[E,V]=n.useState(""),[pe,J]=n.useState([]),[oe,H]=n.useState([]),De=q=>{T(se=>{const ve=new Set(se);return ve.has(q)?ve.delete(q):ve.add(q),ve})},Be=n.useMemo(()=>Z(),[Z]),Ie=n.useMemo(()=>{var se;const q=new Set;for(const[ve,ke]of Object.entries(v.collectedFeedback.pages))ke.fixableIssues.some(Ae=>Ae.type==="artifact"||Ae.type==="distortion")&&q.add(parseInt(ve));for(const[ve,ke]of Object.entries(v.reEvaluationResults.pages))(se=ke.fixableIssues)!=null&&se.some(Ae=>Ae.type==="artifact"||Ae.type==="distortion")&&q.add(parseInt(ve));return Array.from(q).sort((ve,ke)=>ve-ke)},[v.collectedFeedback.pages,v.reEvaluationResults.pages]),qe=q=>{const se=Ur[q],ve=se.icon,ke=v.stepStatus[q],Ae=S.has(q),_e=ae(q);return e.jsxs("button",{onClick:()=>De(q),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${ke==="in-progress"?"bg-blue-50":ke==="completed"?"bg-green-50":ke==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:_e}),e.jsx(ve,{className:`w-4 h-4 ${ke==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:se.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Vo,{status:ke}),Ae?e.jsx(Ut,{className:"w-4 h-4"}):e.jsx(zs,{className:"w-4 h-4"})]})]})};return r?e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>K(!$),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Kr,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),v.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[v.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(lt,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:q=>{q.stopPropagation(),C()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(ma,{className:"w-4 h-4 text-amber-700"})}),$?e.jsx(Ut,{className:"w-4 h-4"}):e.jsx(zs,{className:"w-4 h-4"})]})]}),$&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-amber-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-purple-800",children:"Automated Full Repair"}),e.jsx("p",{className:"text-sm text-purple-600",children:"Runs all steps automatically. Pages retry up to 4 times, keeping the best result."})]}),e.jsx("button",{onClick:Q,disabled:k||Se,className:"flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium",children:Se?e.jsxs(e.Fragment,{children:[e.jsx(lt,{className:"w-5 h-5 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ka,{className:"w-5 h-5"}),"Run Full Workflow"]})})]}),Te&&e.jsx("div",{className:"mt-3 p-2 bg-white/50 rounded border border-purple-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(lt,{className:"w-4 h-4 animate-spin text-purple-600"}),e.jsxs("span",{className:"font-medium text-purple-700",children:[Te.step,":"]}),e.jsx("span",{className:"text-purple-600",children:Te.detail})]})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3",children:e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-3",children:"Or run steps manually:"})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("collect-feedback"),S.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["collect-feedback"].description}),e.jsxs("button",{onClick:y,disabled:k,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ii,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(v.collectedFeedback.pages).length>0&&(()=>{const q=Object.values(v.collectedFeedback.pages),se=q.reduce((a,Pe)=>a+Pe.fixableIssues.length,0),ve=q.reduce((a,Pe)=>a+Pe.entityIssues.length,0),ke=q.reduce((a,Pe)=>{var Je;return a+(((Je=Pe.objectIssues)==null?void 0:Je.length)||0)},0),Ae=q.reduce((a,Pe)=>{var Je;return a+(((Je=Pe.semanticIssues)==null?void 0:Je.length)||0)},0),_e=se+ve+ke+Ae,Xe=Object.values(v.reEvaluationResults.pages),et=Xe.reduce((a,Pe)=>{var Je;return a+(((Je=Pe.fixableIssues)==null?void 0:Je.length)||0)},0),ot=Xe.length>0;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-800 mb-2",children:["Feedback Summary: ",_e," issues from generation + ",ot?`${et} from re-evaluation`:"re-evaluate for fresh data"]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[se>0&&e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-700 rounded",children:["Quality: ",se]}),ve>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded",children:["Character Consistency: ",ve]}),ke>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:["Object Consistency: ",ke]}),Ae>0&&e.jsxs("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-700 rounded",children:["Semantic: ",Ae]}),ot&&et>0&&e.jsxs("span",{className:"px-2 py-1 bg-cyan-100 text-cyan-700 rounded",children:["Re-eval Issues: ",et]}),_e===0&&!ot&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"No issues detected (run re-evaluate for fresh assessment)"}),_e===0&&ot&&et===0&&e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 rounded",children:"All pages pass quality checks"})]})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:q.sort((a,Pe)=>a.pageNumber-Pe.pageNumber).map(a=>e.jsx(qo,{feedback:a,isMarkedForRedo:v.redoPages.pageNumbers.includes(a.pageNumber),onToggleRedo:()=>O(a.pageNumber),onUpdateNotes:Pe=>x(a.pageNumber,{manualNotes:Pe})},a.pageNumber))})]})})()]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("identify-redo-pages"),S.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>be(6,3),disabled:k||v.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Ka,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),v.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",v.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.redoPages.pageNumbers.map(q=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:v.redoPages.reasons[q],children:["Page ",q,e.jsx("button",{onClick:()=>O(q),className:"hover:text-red-900",children:e.jsx(wn,{className:"w-3 h-3"})})]},q))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("redo-pages"),S.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["redo-pages"].description}),e.jsxs("button",{onClick:he,disabled:k||v.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ho,{className:"w-4 h-4"}),"Redo ",v.redoPages.pageNumbers.length," Pages"]}),A.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",A.current," / ",A.total]}),A.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",A.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${A.current/A.total*100}%`}})})]}),v.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",v.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.redoResults.pagesCompleted.map(q=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",q," (v",v.redoResults.newVersions[q]??"?",")"]},q))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("re-evaluate"),S.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["re-evaluate"].description}),e.jsxs("div",{className:"flex gap-2",children:[v.redoResults.pagesCompleted.length>0?e.jsxs("button",{onClick:()=>L(),disabled:k,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Fs,{className:"w-4 h-4"}),"Re-evaluate ",v.redoResults.pagesCompleted.length," Redone Pages"]}):null,e.jsxs("button",{onClick:()=>L(d.map(q=>q.pageNumber)),disabled:k,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50",children:[e.jsx(Fs,{className:"w-4 h-4"}),"Re-evaluate All ",d.length," Pages"]})]}),Object.keys(v.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(v.reEvaluationResults.pages).map(([q,se])=>{const ve=se.rawScore??Math.round(se.qualityScore/10),ke=ve>=7?"text-green-600":ve>=5?"text-amber-600":"text-red-600";return e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:["Page ",q,":"]}),e.jsxs("span",{className:ke,children:[ve,"/10"]}),se.verdict&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${se.verdict==="PASS"?"bg-green-100 text-green-700":se.verdict==="SOFT_FAIL"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:se.verdict}),se.fixableIssues&&se.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",se.fixableIssues.length," fixable issues)"]})]}),se.issuesSummary&&se.issuesSummary!=="none"&&e.jsx("p",{className:"text-xs text-gray-600 pl-2 border-l-2 border-gray-300",children:se.issuesSummary})]},q)})})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("consistency-check"),S.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["consistency-check"].description}),e.jsxs("button",{onClick:()=>de(),disabled:k,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(Es,{className:"w-4 h-4"}),"Run Consistency Check"]}),v.consistencyResults.report&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${v.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:v.consistencyResults.report.overallConsistent?"All characters consistent!":`${v.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:v.consistencyResults.report.summary})]}),Object.entries(v.consistencyResults.report.characters||{}).map(([q,se])=>{var ve,ke;return e.jsxs("details",{className:"border rounded-lg overflow-hidden",children:[e.jsxs("summary",{className:`px-3 py-2 cursor-pointer text-sm font-medium flex items-center justify-between ${se.overallConsistent?"bg-green-50":"bg-amber-50"}`,children:[e.jsx("span",{children:q}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${se.overallConsistent?"bg-green-200 text-green-800":"bg-amber-200 text-amber-800"}`,children:["Score: ",se.overallScore??se.score??"?","/10",(se.totalIssues??((ve=se.issues)==null?void 0:ve.length)??0)>0&&` â€¢ ${se.totalIssues??((ke=se.issues)==null?void 0:ke.length)} issues`]})]}),e.jsxs("div",{className:"p-3 bg-white space-y-2 text-sm",children:[se.byClothing&&Object.entries(se.byClothing).map(([Ae,_e])=>e.jsxs("div",{className:"border-l-2 border-gray-200 pl-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-700",children:Ae}),e.jsxs("span",{className:`text-xs ${_e.score>=7?"text-green-600":"text-amber-600"}`,children:[_e.score,"/10"]})]}),_e.issues&&_e.issues.length>0&&e.jsx("ul",{className:"mt-1 space-y-1",children:_e.issues.map((Xe,et)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${Xe.severity==="critical"?"bg-red-400":Xe.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsxs("span",{children:[Xe.description,Xe.pagesToFix&&Xe.pagesToFix.length>0&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(pages ",Xe.pagesToFix.join(", "),")"]})]})]},et))})]},Ae)),!se.byClothing&&se.issues&&se.issues.length>0&&e.jsx("ul",{className:"space-y-1",children:se.issues.map((Ae,_e)=>e.jsxs("li",{className:"text-xs text-gray-600 flex items-start gap-1",children:[e.jsx("span",{className:`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${Ae.severity==="critical"?"bg-red-400":Ae.severity==="major"?"bg-amber-400":"bg-gray-400"}`}),e.jsx("span",{children:Ae.description})]},_e))}),(!se.byClothing||Object.values(se.byClothing).every(Ae=>{var _e;return!((_e=Ae.issues)!=null&&_e.length)}))&&(!se.issues||se.issues.length===0)&&e.jsx("p",{className:"text-xs text-green-600",children:"No issues found"})]})]},q)}),Be.length>0&&e.jsxs("div",{className:"text-sm pt-2 border-t",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:Be.map(q=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:q},q))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("character-repair"),S.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:E,onChange:q=>{V(q.target.value),J([])},className:"w-full p-2 border rounded text-sm",disabled:k,children:[e.jsx("option",{value:"",children:"Choose a character..."}),Be.map(q=>e.jsxs("option",{value:q,children:[q," (has issues)"]},q)),o.filter(q=>!Be.includes(q.name)).map(q=>e.jsx("option",{value:q.name,children:q.name},q.name))]})]}),E&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsxs("button",{onClick:()=>{const q=$e(E);J(q)},disabled:k||v.stepStatus["consistency-check"]!=="completed",className:"flex items-center gap-1 px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50",title:"Auto-select pages with major/critical issues",children:[e.jsx(Ka,{className:"w-3 h-3"}),"Auto-Identify Severe"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.map(q=>e.jsxs("button",{onClick:()=>{J(se=>se.includes(q.pageNumber)?se.filter(ve=>ve!==q.pageNumber):[...se,q.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${pe.includes(q.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:k,children:["Page ",q.pageNumber]},q.pageNumber))})]}),e.jsxs("button",{onClick:async()=>{await w(E,pe),h&&await h()},disabled:k||!E||pe.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(Kr,{className:"w-4 h-4"}),"Repair ",E||"Character"," on ",pe.length," pages"]}),Object.keys(v.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800 mb-2",children:"Repair Results:"}),Object.entries(v.characterRepairResults.pagesRepaired).map(([q,se])=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[q,":"]})," ",e.jsxs("span",{className:"text-gray-600",children:["Pages ",se.join(", ")]})]},q))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[qe("artifact-repair"),S.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Ur["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsxs("button",{onClick:()=>H(Ie),disabled:k||Ie.length===0,className:"flex items-center gap-1 px-2 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-50",title:"Auto-select all pages with artifact issues",children:[e.jsx(Ka,{className:"w-3 h-3"}),"Auto-Identify (",Ie.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ie.length>0?Ie.map(q=>e.jsxs("button",{onClick:()=>{H(se=>se.includes(q)?se.filter(ve=>ve!==q):[...se,q])},className:`px-2 py-1 text-xs rounded border transition-colors ${oe.includes(q)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:k,children:["Page ",q]},q)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),Ie.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),d.map(q=>e.jsxs("button",{onClick:()=>{H(se=>se.includes(q.pageNumber)?se.filter(ve=>ve!==q.pageNumber):[...se,q.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${oe.includes(q.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:k,children:["Page ",q.pageNumber]},q.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await _(oe),h&&await h()},disabled:k||oe.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(di,{className:"w-4 h-4"}),"Run Grid Repair on ",oe.length," pages"]}),v.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",v.artifactRepairResults.pagesProcessed.length," pages, fixed ",v.artifactRepairResults.issuesFixed," issues"]})})]})]})]})]}):null}const Qn=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"FranÃ§ais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],Xa={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"SÃ¼ddeutsch"},{code:"de-at",name:"Ã–sterreich"},{code:"de-it",name:"SÃ¼dtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"QuÃ©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"ZÃ¼ritÃ¼Ã¼tsch"},{code:"gsw-be",name:"BÃ¤rndÃ¼tsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"LuzÃ¤rndÃ¼tsch"},{code:"gsw-sg",name:"SanggallerdÃ¼tsch"},{code:"gsw-vs",name:"WalliserdÃ¼tsch"},{code:"gsw-gr",name:"BÃ¼ndnerdÃ¼tsch"}]};function fn(r){return r.startsWith("gsw")?"gsw":r.startsWith("de")?"de":r.startsWith("fr")?"fr":r.startsWith("it")?"it":"en"}const Ko=["spring","summer","autumn","winter"];function mi(){const r=new Date().getMonth();return r>=2&&r<=4?"spring":r>=5&&r<=7?"summer":r>=8&&r<=10?"autumn":"winter"}function Jo({languageLevel:r,onLanguageLevelChange:d,pages:o,onPagesChange:m,storyLanguage:s,onStoryLanguageChange:D,developerMode:h,userLocation:N,onLocationChange:$,season:K,onSeasonChange:S,userCredits:T}){const{t:v,language:k}=br(),[C,y]=n.useState(!1),[x,O]=n.useState((N==null?void 0:N.city)||""),[be,he]=n.useState((N==null?void 0:N.country)||""),[A,L]=n.useState(!1),de=n.useRef(null);n.useEffect(()=>{const H=De=>{de.current&&!de.current.contains(De.target)&&L(!1)};return document.addEventListener("mousedown",H),()=>document.removeEventListener("mousedown",H)},[]);const w=n.useCallback(()=>{const H=fn(s),De=Qn.find(Ie=>Ie.family===H),Be=Xa[H].find(Ie=>Ie.code===s)||Xa[H][0];return De&&Be?`${De.name} (${Be.name})`:(De==null?void 0:De.name)||s},[s]);n.useEffect(()=>{N&&(O(N.city||""),he(N.country||""))},[N]);const _=()=>{$({city:x||null,region:null,country:be||null}),y(!1)},j={spring:{de:"FrÃ¼hling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"Ã‰tÃ©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},ae=h?4:10,Z=50,$e=2,Te=10,B=T===-1,Se=B?Z:Math.floor(T/Te),W=Math.floor(Se/2)*2,X=ae*Te,Q=!B&&T<X,E=X-T,V=Q?ae:Math.min(Z,Math.max(ae,W)),pe=!B&&W<Z;n.useEffect(()=>{let H=o;H%2!==0&&(H=Math.round(H/2)*2),H=Math.max(ae,Math.min(V,H)),H!==o&&m(H)},[o,ae,V,m]);const J=[{value:"1st-grade",label:v.firstGrade,desc:v.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:v.standard,desc:v.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:v.advanced,desc:v.advancedDesc,image:"/images/dense text left.jpg"}],oe=(H,De=!1)=>{const Be=De?" (Test)":"",Ie=H*10,qe=k==="de"?"Credits":k==="fr"?"crÃ©dits":"credits";if(r==="1st-grade")return`${H} ${k==="de"?"Seiten":"pages"} = ${Ie} ${qe}${Be}`;const q=Math.floor(H/2),se=Math.floor(H/2);return k==="de"?`${H} Seiten (${q} Text + ${se} Bilder) = ${Ie} ${qe}${Be}`:k==="fr"?`${H} pages (${q} texte + ${se} images) = ${Ie} ${qe}${Be}`:`${H} pages (${q} text + ${se} images) = ${Ie} ${qe}${Be}`};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(tn,{size:24}),k==="de"?"Buchformat":k==="fr"?"Format du livre":"Book Format"]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:k==="de"?"Sprache:":k==="fr"?"Langue:":"Language:"}),e.jsxs("div",{className:"relative",ref:de,children:[e.jsxs("button",{type:"button",onClick:()=>L(!A),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[w(),e.jsx(Ut,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${A?"rotate-180":""}`})]}),A&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[Qn.map(H=>{const De=fn(s)===H.family;return e.jsx("button",{type:"button",onClick:()=>{const Be=Xa[H.family][0];D(Be.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${De?"font-semibold text-indigo-600":"text-gray-700"}`,children:H.name},H.family)}),e.jsx("div",{className:"border-t border-gray-300 my-1"}),Xa[fn(s)].map(H=>e.jsx("button",{type:"button",onClick:()=>{D(H.code),L(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${s===H.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:H.name},H.code))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(uo,{className:"text-gray-500",size:16}),e.jsx("span",{className:"text-sm text-gray-600",children:k==="de"?"Ort:":k==="fr"?"Lieu:":"Location:"}),C?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"text",value:x,onChange:H=>O(H.target.value),placeholder:k==="de"?"Stadt":k==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("input",{type:"text",value:be,onChange:H=>he(H.target.value),placeholder:k==="de"?"Land":k==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("button",{onClick:_,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),e.jsx("button",{onClick:()=>y(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"âœ•"})]}):e.jsx("button",{onClick:()=>y(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:N!=null&&N.city?`${N.city}${N.country?`, ${N.country}`:""}`:k==="de"?"Festlegen":k==="fr"?"DÃ©finir":"Set"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:k==="de"?"Jahreszeit:":k==="fr"?"Saison:":"Season:"}),e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:K,onChange:H=>S(H.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:Ko.map(H=>e.jsx("option",{value:H,children:j[H][k]||j[H].en},H))}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:v.readingLevel}),e.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:J.map(H=>e.jsxs("button",{onClick:()=>d(H.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${r===H.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[e.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:e.jsx("img",{src:H.image,alt:H.label,className:"w-full h-full object-contain"})}),e.jsxs("div",{className:"p-2 md:p-2.5",children:[e.jsx("div",{className:"font-semibold text-sm mb-0.5",children:H.label}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:H.desc})]})]},H.value))})]}),r&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:v.numberOfPages}),Q?e.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-red-700 font-semibold mb-2",children:k==="de"?"Nicht genÃ¼gend Credits":k==="fr"?"CrÃ©dits insuffisants":"Not enough credits"}),e.jsx("p",{className:"text-red-600 text-sm",children:k==="de"?`Du benÃ¶tigst mindestens ${X} Credits fÃ¼r eine Geschichte mit ${ae} Seiten. Dir fehlen noch ${E} Credits.`:k==="fr"?`Vous avez besoin d'au moins ${X} crÃ©dits pour une histoire de ${ae} pages. Il vous manque ${E} crÃ©dits.`:`You need at least ${X} credits for a ${ae}-page story. You need ${E} more credits.`}),e.jsx("p",{className:"text-gray-500 text-xs mt-2",children:k==="de"?`Aktuell: ${T} Credits`:k==="fr"?`Actuel: ${T} crÃ©dits`:`Current: ${T} credits`})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"range",min:ae,max:V,step:$e,value:Math.min(o,V),onChange:H=>m(parseInt(H.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-400",children:ae}),e.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[o," ",k==="de"?"Seiten":"pages"]}),e.jsxs("span",{className:`text-sm ${pe?"text-orange-500 font-medium":"text-gray-400"}`,children:[V,pe&&" âš ï¸"]})]}),pe&&e.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:k==="de"?`Max. ${V} Seiten mit ${T} Credits mÃ¶glich`:k==="fr"?`Max. ${V} pages possibles avec ${T} crÃ©dits`:`Max. ${V} pages possible with ${T} credits`}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-base font-medium text-gray-700",children:oe(o,o===4)}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r==="1st-grade"?k==="de"?"Jede Seite enthÃ¤lt ein Bild mit Text darunter":k==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":k==="de"?"Abwechselnd Textseite und Bildseite":k==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const Zo=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:Jo,getCurrentSeason:mi},Symbol.toStringTag,{value:"Module"})),Yn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail prÃ¼fen",description:"Wir haben Ihnen einen BestÃ¤tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail bestÃ¤tigen!",currentEmail:"BestÃ¤tigung gesendet an",sendVerification:"BestÃ¤tigungs-E-Mail senden",resendVerification:"BestÃ¤tigungs-E-Mail erneut senden",emailSent:"BestÃ¤tigungs-E-Mail gesendet! Bitte prÃ¼fen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? Ã„ndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"Ã„ndern & BestÃ¤tigen",cancel:"Abbrechen",emailChanged:"E-Mail geÃ¤ndert! Bitte prÃ¼fen Sie Ihren neuen Posteingang fÃ¼r die BestÃ¤tigung.",checkSpam:"Nicht gefunden? PrÃ¼fen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausfÃ¼llen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function Qo({isOpen:r,onClose:d,onVerified:o}){const{language:m}=br(),{user:s,refreshUser:D}=jn(),h=Yn[m]||Yn.en,[N,$]=n.useState("verify"),[K,S]=n.useState(!1),[T,v]=n.useState(!1),[k,C]=n.useState(""),[y,x]=n.useState(""),[O,be]=n.useState(!1),[he,A]=n.useState(0),[L,de]=n.useState(""),[w,_]=n.useState(""),j=n.useRef(null),ae=n.useRef(null),Z=n.useRef(!1);if(n.useEffect(()=>(he>0&&(ae.current=setTimeout(()=>{A(B=>B-1)},1e3)),()=>{ae.current&&clearTimeout(ae.current)}),[he]),n.useEffect(()=>{if(r&&!Z.current&&!T){Z.current=!0;const B=setTimeout(async()=>{S(!0);try{const Se=await it.post("/api/auth/send-verification",{});v(!0),x(h.emailSent),Se.cooldown&&A(Se.cooldown)}catch(Se){const W=Se;W.retryAfter?(A(W.retryAfter),v(!0)):C(W.message||"Failed to send verification email")}finally{S(!1)}},300);return()=>clearTimeout(B)}r||(Z.current=!1)},[r,T,h.emailSent]),n.useEffect(()=>{if(!r){j.current&&(clearInterval(j.current),j.current=null);return}return be(!0),console.log("[EmailVerificationModal] Starting polling"),j.current=setInterval(async()=>{try{const B=await it.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",B.emailVerified),B.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await D(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),j.current&&(clearInterval(j.current),j.current=null),be(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),o==null||o(),console.log("[EmailVerificationModal] Calling onClose"),d())}catch(B){console.debug("Verification status poll error:",B)}},3e3),()=>{j.current&&(clearInterval(j.current),j.current=null)}},[r,D,o,d]),!r)return null;const $e=async()=>{S(!0),C("");try{const B=await it.post("/api/auth/send-verification",{});v(!0),x(h.emailSent),B.cooldown&&A(B.cooldown)}catch(B){const Se=B;Se.retryAfter?(A(Se.retryAfter),C(m==="de"?`Bitte warten Sie ${Se.retryAfter} Sekunden`:m==="fr"?`Veuillez patienter ${Se.retryAfter} secondes`:`Please wait ${Se.retryAfter} seconds`)):C(Se.message||"Failed to send verification email")}finally{S(!1)}},Te=async()=>{if(!L||!w){C(h.fillAllFields);return}S(!0),C("");try{await it.post("/api/auth/change-email",{newEmail:L,password:w}),x(h.emailChanged),$("verify"),de(""),_("")}catch(B){C(B instanceof Error?B.message:"Failed to change email")}finally{S(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[e.jsx("button",{onClick:d,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:e.jsx(qt,{size:20})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ni,{className:"w-8 h-8 text-indigo-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:h.title}),e.jsx("p",{className:"text-gray-500",children:h.description})]}),k&&e.jsx(Mn,{variant:"error",className:"mb-4",children:k}),y&&e.jsxs(Mn,{variant:"success",className:"mb-4",children:[y,e.jsx("p",{className:"text-sm mt-1 opacity-80",children:h.checkSpam})]}),O&&T&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[e.jsx(lt,{size:16,className:"animate-spin"}),e.jsx("span",{className:"text-sm",children:m==="de"?"Warte auf BestÃ¤tigung...":m==="fr"?"En attente de verification...":"Waiting for verification..."})]}),N==="verify"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:h.currentEmail}),e.jsx("p",{className:"font-medium text-gray-800",children:s==null?void 0:s.email})]}),e.jsxs(en,{onClick:$e,variant:"primary",loading:K,disabled:he>0,className:"w-full",children:[e.jsx(ar,{size:16,className:"mr-2"}),he>0?`${m==="de"?"Warten":m==="fr"?"Patienter":"Wait"} ${he}s`:T?h.resendVerification:h.sendVerification]}),e.jsxs("button",{onClick:()=>{$("change"),C(""),x("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[e.jsx(kt,{size:16}),h.changeEmail]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(Bn,{type:"email",label:h.newEmail,value:L,onChange:B=>de(B.target.value),placeholder:"your@newemail.com",disabled:K}),e.jsx(Bn,{type:"password",label:h.currentPassword,value:w,onChange:B=>_(B.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:K}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(en,{onClick:()=>{$("verify"),C(""),de(""),_("")},variant:"secondary",className:"flex-1",disabled:K,children:h.cancel}),e.jsx(en,{onClick:Te,variant:"primary",loading:K,className:"flex-1",children:h.confirmChange})]})]})]})})}const Sn=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "},inverse:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"},inverse:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"},inverse:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function Yo(r){const d=Sn.find(o=>o.value.en==="Not Known to");return d?d.value[r]:"Not Known to"}function Xn(r){const d=Sn.find(o=>o.value.en==="Not Known to");return d?r===d.value.en||r===d.value.de||r===d.value.fr:!1}function Xo(r,d,o=[]){for(const m of Sn)if(m.value[d]===r)return m.inverse[d];for(const m of o){if(m.forward===r)return m.inverse;if(m.inverse===r)return m.forward}return r}const el=1440*60*1e3;function rn(r){const d=`avatar_regen_${r}`,o=localStorage.getItem(d),m=Date.now();if(!o)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:s,lastAttempt:D}=JSON.parse(o);if(m-D>el)return localStorage.removeItem(d),{canRegenerate:!0,waitSeconds:0,attempts:0};let h=0;s>=2&&s<4?h=30*1e3:s>=4&&s<6?h=60*1e3:s>=6&&s<8?h=120*1e3:s>=8&&s<10?h=300*1e3:s>=10&&(h=600*1e3);const N=m-D;return N>=h?{canRegenerate:!0,waitSeconds:0,attempts:s}:{canRegenerate:!1,waitSeconds:Math.ceil((h-N)/1e3),attempts:s}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function ui(r){const d=`avatar_regen_${r}`,o=localStorage.getItem(d),m=Date.now();let s=1;if(o)try{s=(JSON.parse(o).attempts||0)+1}catch{}localStorage.setItem(d,JSON.stringify({attempts:s,lastAttempt:m}))}function Tl(r){const[d,o]=n.useState(()=>rn(r));n.useEffect(()=>{if(d.waitSeconds>0){const s=setInterval(()=>{o(rn(r))},1e3);return()=>clearInterval(s)}},[d.waitSeconds,r]);const m=n.useCallback(()=>{ui(r),o(rn(r))},[r]);return{...d,recordRegeneration:m}}const ei={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte wÃ¤hlen Sie aus, welches Gesicht zu dem Charakter gehÃ¶rt, den Sie erstellen mÃ¶chten.",selectFace:"Gesicht auswÃ¤hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages dÃ©tectÃ©s",description:"Nous avons dÃ©tectÃ© plusieurs personnes sur votre photo. Veuillez sÃ©lectionner le visage du personnage que vous souhaitez crÃ©er.",selectFace:"SÃ©lectionner le visage",uploadDifferent:"TÃ©lÃ©charger une autre photo",confidence:"Confiance"}};function tl({isOpen:r,faces:d,onSelect:o,onUploadNew:m,developerMode:s=!1}){const{language:D}=br(),h=ei[D]||ei.en;return e.jsx(to,{isOpen:r,onClose:m,title:h.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-600 text-center",children:h.description}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:d.map((N,$)=>e.jsxs("button",{onClick:()=>o(N.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:e.jsx("img",{draggable:!1,src:N.thumbnail,alt:`Face ${$+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[h.selectFace," ",$+1]})}),s&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[h.confidence,": ",Math.round(N.confidence*100),"%"]})]},N.id))}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("button",{onClick:m,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[e.jsx(bo,{size:20}),h.uploadDifferent]})})]})})}const Rl=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et quÃªtes hÃ©roÃ¯ques"},emoji:"ðŸ—¡ï¸"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"CompÃ©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei alltÃ¤glichen Herausforderungen",fr:"Aide pour surmonter les dÃ©fis quotidiens"},emoji:"ðŸ’ª"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"ðŸ“š"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais Ã©vÃ©nements historiques"},emoji:"ðŸ›ï¸"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"DÃ©cris ta propre idÃ©e d'histoire"},emoji:"âœ¨"}],rl=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],Dl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"Ã‰poques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"HÃ©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"PersonnalisÃ©"}}],yn=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"ðŸ´â€â˜ ï¸",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"âš”ï¸",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ðŸ¤ ",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ðŸ¥·",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"âš“",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"ðŸ›ï¸",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes Ã„gypten",fr:"Ã‰gypte Ancienne"},emoji:"ðŸº",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"GrÃ¨ce Antique"},emoji:"ðŸº",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"Ã‚ge de Pierre"},emoji:"ðŸ¦´",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure SamouraÃ¯"},emoji:"ðŸŽŒ",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & SorciÃ¨re"},emoji:"ðŸ§™",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"QuÃªte du Dragon"},emoji:"ðŸ‰",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ðŸ¦„",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de SirÃ¨ne"},emoji:"ðŸ§œâ€â™€ï¸",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ðŸ¦–",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-hÃ©ros"},emoji:"ðŸ¦¸",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"ðŸš€",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des OcÃ©ans"},emoji:"ðŸŒŠ",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"ðŸŒ´",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie Ã  la Ferme"},emoji:"ðŸ„",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la ForÃªt"},emoji:"ðŸ¦Š",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"ðŸš’",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"ðŸ‘¨â€âš•ï¸",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"ðŸ‘®",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"MystÃ¨re DÃ©tective"},emoji:"ðŸ”",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de NoÃ«l"},emoji:"ðŸŽ„",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"ðŸŽ†",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de PÃ¢ques"},emoji:"ðŸ°",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"ðŸŽƒ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},emoji:"âœ¨",group:"custom"}],Fl={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"ðŸ "},ti=[{id:"potty-training",name:{en:"Potty Training",de:"TÃ¶pfchen-Training",fr:"Apprentissage du pot"},emoji:"ðŸš½",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"HÃ¤nde waschen",fr:"Se laver les mains"},emoji:"ðŸ§¼",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"ZÃ¤hne putzen",fr:"Se brosser les dents"},emoji:"ðŸª¥",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"GemÃ¼se essen",fr:"Manger des lÃ©gumes"},emoji:"ðŸ¥¦",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"ðŸ›ï¸",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"ðŸ‘‹",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de tÃ©tine"},emoji:"ðŸ¼",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"AufrÃ¤umen",fr:"Ranger les jouets"},emoji:"ðŸ§¹",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ðŸª‘",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre Ã  partager"},emoji:"ðŸ¤",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten kÃ¶nnen",fr:"Attendre son tour"},emoji:"â³",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"ðŸŽ’",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"ðŸ‘«",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"ÃŠtre courageux"},emoji:"ðŸ’ª",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau bÃ©bÃ© dans la famille"},emoji:"ðŸ‘¶",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'Ã©cole"},emoji:"ðŸ«",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"ðŸ“",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre Ã  lire"},emoji:"ðŸ“–",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren kÃ¶nnen",fr:"Savoir perdre"},emoji:"ðŸŽ¯",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"ÃŠtre diffÃ©rent c'est bien"},emoji:"ðŸŒˆ",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit HÃ¤nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"ðŸ›¡ï¸",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la vÃ©ritÃ©"},emoji:"âœ…",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"ðŸŒŸ",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"DÃ©mÃ©nagement"},emoji:"ðŸ ",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"âœˆï¸",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents sÃ©parÃ©s"},emoji:"ðŸ’”",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le mÃ©decin"},emoji:"ðŸ¥",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"SÃ©jour Ã  l'hÃ´pital"},emoji:"ðŸ©º",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"ðŸŒˆ",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"â¤ï¸",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"Ã‰conomiser de l'argent"},emoji:"ðŸ’°",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"DÃ©penser intelligemment"},emoji:"ðŸ›’",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"Ã‰quilibre du temps d'Ã©cran"},emoji:"ðŸ“±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"ðŸ‘¥",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"KÃ¶rperliche VerÃ¤nderungen",fr:"Changements corporels"},emoji:"ðŸŒ±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung Ã¼bernehmen",fr:"Prendre ses responsabilitÃ©s"},emoji:"ðŸŽ¯",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"â°",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"SÃ©curitÃ© en ligne"},emoji:"ðŸ”’",ageGroup:"preteen"}],sl=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],El=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-VerÃ¤nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"PrÃ©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"Ã‰cole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"VorpubertÃ¤t (9-12)",fr:"PrÃ©adolescent (9-12)"},ageRange:"9-12"}],ri=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"ðŸ”¤",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"ðŸ…°ï¸",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"ReimwÃ¶rter",fr:"Mots qui riment"},emoji:"ðŸŽµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"ðŸ”¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"ðŸ”¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"ZÃ¤hlen lernen",fr:"Apprendre Ã  compter"},emoji:"âœ‹",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"ðŸ”·",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"âž•",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"ðŸŒˆ",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"MÃ©langer les couleurs"},emoji:"ðŸŽ¨",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"PlanÃ¨tes & Espace"},emoji:"ðŸª",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"ðŸ‚",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"MÃ©tÃ©o"},emoji:"â›…",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"ðŸ’§",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"ðŸŒ±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"ðŸŒ™",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"ðŸ·",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ðŸ¦",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"ðŸ‹",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & KÃ¤fer",fr:"Insectes"},emoji:"ðŸ›",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ðŸ¦•",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"KÃ¶rperteile",fr:"Parties du corps"},emoji:"ðŸ«€",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die fÃ¼nf Sinne",fr:"Les cinq sens"},emoji:"ðŸ‘ï¸",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ðŸ¥—",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"ðŸ“…",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'annÃ©e"},emoji:"ðŸ—“ï¸",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"ðŸ•",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"ðŸŒ",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"LÃ¤nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"ðŸ³ï¸",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"ðŸŽ¸",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"BerÃ¼hmte KÃ¼nstler",fr:"Artistes cÃ©lÃ¨bres"},emoji:"ðŸ–¼ï¸",group:"arts"}],al=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],zl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"KÃ¶rper & Gesundheit",fr:"Corps & SantÃ©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & GÃ©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],nl=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],Bl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"â­"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"ðŸ‡¨ðŸ‡­"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & DÃ©couverte"},icon:"ðŸ§­"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & MÃ©decine"},icon:"ðŸ”¬"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"ðŸ’¡"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & LibertÃ©"},icon:"âœŠ"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"ðŸ—ï¸"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"ðŸŽ­"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"ArchÃ¤ologische Entdeckungen",fr:"DÃ©couvertes ArchÃ©ologiques"},icon:"ðŸº"}],si=[{id:"swiss-founding",name:{en:"Founding of Switzerland (RÃ¼tlischwur)",de:"GrÃ¼ndung der Schweiz (RÃ¼tlischwur)",fr:"Fondation de la Suisse (Serment du GrÃ¼tli)"},shortName:{en:"RÃ¼tlischwur",de:"RÃ¼tlischwur",fr:"Serment du GrÃ¼tli"},emoji:"ðŸ¤",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"ðŸ¹",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"âš”ï¸",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"ðŸ›¡ï¸",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"RÃ©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"RÃ©forme"},emoji:"ðŸ“œ",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant grÃ¼ndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"â¤ï¸",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"GÃ©nÃ©ral Dufour et l'unitÃ© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"GÃ©nÃ©ral Dufour"},emoji:"ðŸŽ–ï¸",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"ðŸ”ï¸",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution fÃ©dÃ©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"ðŸ“‹",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"ðŸš‚",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer NeutralitÃ¤t im 1. Weltkrieg",fr:"NeutralitÃ© suisse pendant la PremiÃ¨re Guerre"},shortName:{en:"WWI Neutrality",de:"NeutralitÃ¤t 1. WK",fr:"NeutralitÃ© 1GM"},emoji:"ðŸ•Šï¸",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the RÃ¼tli Report",de:"General Guisan und der RÃ¼tlirapport",fr:"GÃ©nÃ©ral Guisan et le Rapport du GrÃ¼tli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"GÃ©nÃ©ral Guisan"},emoji:"ðŸŽ–ï¸",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2Ã¨me GM"},emoji:"ðŸ”ï¸",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"ðŸŒ™",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les AmÃ©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"DÃ©couverte de l'AmÃ©rique"},emoji:"â›µ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motorisÃ©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"âœˆï¸",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"PremiÃ¨re traversÃ©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"ðŸ›©ï¸",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"ðŸ”ï¸",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am SÃ¼dpol",fr:"Premier au PÃ´le Sud"},shortName:{en:"South Pole",de:"SÃ¼dpol",fr:"PÃ´le Sud"},emoji:"â„ï¸",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"ðŸŒ",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"PlongÃ©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"PlongÃ©e profonde"},emoji:"ðŸŒŠ",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"ExpÃ©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"ElektrizitÃ¤t entdeckt",fr:"DÃ©couverte Ã©lectricitÃ©"},emoji:"âš¡",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"DÃ©couverte de la pÃ©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"PÃ©nicilline"},emoji:"ðŸ’Š",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"ðŸ’‰",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN dÃ©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"DÃ©couverte ADN"},emoji:"ðŸ§¬",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nommÃ©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"DÃ©couverte dinosaure"},emoji:"ðŸ¦•",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins RelativitÃ¤tstheorie",fr:"RelativitÃ© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"ThÃ©orie d'Einstein"},emoji:"ðŸ§ ",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits GalÃ¡pagos",de:"Darwin auf GalÃ¡pagos",fr:"Darwin aux GalÃ¡pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"ðŸ¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"PremiÃ¨re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"â¤ï¸",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschlÃ¼sselt",fr:"GÃ©nome humain dÃ©codÃ©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet GÃ©nome"},emoji:"ðŸ§ª",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement tÃ©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"TÃ©lescope Hubble"},emoji:"ðŸ”­",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel tÃ©lÃ©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"TÃ©lÃ©phone"},emoji:"ðŸ“ž",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons GlÃ¼hbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"GlÃ¼hbirne",fr:"Ampoule"},emoji:"ðŸ’¡",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"ðŸ“–",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"ðŸŒ",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"â›“ï¸",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"ðŸšŒ",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"ðŸ§±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela libÃ©rÃ©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"âœŠ",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"ðŸ”º",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm erÃ¶ffnet",fr:"Tour Eiffel inaugurÃ©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"ðŸ—¼",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal erÃ¶ffnet",fr:"Canal de Panama inaugurÃ©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"ðŸš¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"ðŸŒ‰",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel erÃ¶ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"ðŸš‡",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"ðŸ…",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland erÃ¶ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"ðŸ°",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cinÃ©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"ðŸŽ¬",year:1895,category:"culture",mainPerson:"LumiÃ¨re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ðŸ¦",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"MusÃ©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"MusÃ©e Histoire Naturelle"},emoji:"ðŸ›ï¸",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de ToutÃ¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"ToutÃ¢nkhamon"},emoji:"ðŸ‘‘",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"RedÃ©couverte de PompÃ©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"PompÃ©i"},emoji:"ðŸŒ‹",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"ArmÃ©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"ArmÃ©e terre cuite"},emoji:"ðŸ—¿",year:1974,category:"archaeology"}];function Ml(r){return r==="popular"?yn.filter(d=>rl.includes(d.id)):yn.filter(d=>d.group===r)}function Ol(r){return r==="popular"?ti.filter(d=>sl.includes(d.id)):ti.filter(d=>d.ageGroup===r)}function Ll(r){return r==="popular"?ri.filter(d=>al.includes(d.id)):ri.filter(d=>d.group===r)}function Gl(r){return r==="popular"?si.filter(d=>nl.includes(d.id)):si.filter(d=>d.category===r)}const il={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},sr={enableAutoRepair:!1,enableFinalChecks:!0,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null,enableSceneValidation:!1,separatedEvaluation:!1,enableFullRepairAfterGeneration:!1};function ol(){const r=localStorage.getItem("developer_mode")==="true",[d,o]=n.useState(r),[m,s]=n.useState(null),[D,h]=n.useState("auto"),[N,$]=n.useState(!1),[K,S]=n.useState(!1),[T,v]=n.useState(!1),[k,C]=n.useState(!1),[y,x]=n.useState(r),[O,be]=n.useState(sr.enableAutoRepair),[he,A]=n.useState(sr.enableFinalChecks),[L,de]=n.useState(sr.incrementalConsistency),[w,_]=n.useState(sr.incrementalConsistencyDryRun),[j,ae]=n.useState(sr.lookbackCount),[Z,$e]=n.useState(sr.checkOnlyMode),[Te,B]=n.useState(sr.useGridRepair),[Se,W]=n.useState(sr.forceRepairThreshold),[X,Q]=n.useState(sr.enableSceneValidation),[E,V]=n.useState(sr.separatedEvaluation),[pe,J]=n.useState(sr.enableFullRepairAfterGeneration),[oe,H]=n.useState(!1),[De,Be]=n.useState({...il}),Ie=qe=>{o(qe),x(!!qe)};return n.useEffect(()=>{d?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[d]),{developerMode:d,setDeveloperMode:Ie,imageGenMode:m,setImageGenMode:s,generationMode:D,setGenerationMode:h,devSkipOutline:N,setDevSkipOutline:$,devSkipText:K,setDevSkipText:S,devSkipSceneDescriptions:T,setDevSkipSceneDescriptions:v,devSkipImages:k,setDevSkipImages:C,devSkipCovers:y,setDevSkipCovers:x,enableAutoRepair:O,setEnableAutoRepair:be,enableFinalChecks:he,setEnableFinalChecks:A,incrementalConsistency:L,setIncrementalConsistency:de,incrementalConsistencyDryRun:w,setIncrementalConsistencyDryRun:_,lookbackCount:j,setLookbackCount:ae,checkOnlyMode:Z,setCheckOnlyMode:$e,useGridRepair:Te,setUseGridRepair:B,forceRepairThreshold:Se,setForceRepairThreshold:W,enableSceneValidation:X,setEnableSceneValidation:Q,separatedEvaluation:E,setSeparatedEvaluation:V,enableFullRepairAfterGeneration:pe,setEnableFullRepairAfterGeneration:J,loadAllAvatars:oe,setLoadAllAvatars:H,modelSelections:De,setModelSelections:Be}}const ll=n.lazy(()=>ga(()=>import("./WizardStep2Characters-BCtuihpX.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])).then(r=>({default:r.WizardStep2Characters}))),dl=n.lazy(()=>ga(()=>Promise.resolve().then(()=>Zo),void 0).then(r=>({default:r.WizardStep3BookSettings}))),cl=n.lazy(()=>ga(()=>import("./WizardStep4StoryType-Dfmucexx.js"),__vite__mapDeps([24,1,2,3,4,7,17,12,13,5,6,8,18,19,14,20,21,9,22,23,15])).then(r=>({default:r.WizardStep4StoryType}))),ml=n.lazy(()=>ga(()=>import("./WizardStep5ArtStyle-C5HEY1aZ.js"),__vite__mapDeps([25,1,2,3,4,26,20])).then(r=>({default:r.WizardStep5ArtStyle}))),ul=n.lazy(()=>ga(()=>import("./WizardStep6Summary-xR-Bvm6w.js"),__vite__mapDeps([27,1,2,3,4,26,17,9,7,5,6,8,18,19,12,13,14,20,21,22,23,15])).then(r=>({default:r.WizardStep6Summary}))),f=vn("StoryWizard"),ai={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"FÃ¼ge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die BuchlÃ¤nge und das Leseniveau fÃ¼r dein Publikum fest",3:"WÃ¤hle einen Geschichtstyp und ein Thema",4:"WÃ¤hle einen Illustrationsstil fÃ¼r dein Buch",5:"ÃœberprÃ¼fe deine Auswahl, fÃ¼ge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils apparaÃ®tront de maniÃ¨re cohÃ©rente dans toute votre histoire!",2:"DÃ©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un thÃ¨me",4:"Choisissez un style d'illustration pour votre livre",5:"VÃ©rifiez vos choix, ajoutez des dÃ©tails de l'intrigue, puis gÃ©nÃ©rez votre histoire!"}};function gl(){const r=Ji(),[d,o]=Zi(),{t:m,language:s}=br(),{isAuthenticated:D,user:h,updateCredits:N,refreshUser:$,isLoading:K,isImpersonating:S}=jn(),{showSuccess:T,showInfo:v,showError:k}=Ui(),{startTracking:C,stopTracking:y,activeJob:x,isComplete:O,completedStoryId:be,markCompletionViewed:he,hasUnviewedCompletion:A}=Ki(),[L,de]=n.useState(()=>{const i=new URLSearchParams(window.location.search);if(i.get("storyId"))return 6;if(i.get("new")==="true")return 1;const b=localStorage.getItem("wizard_step");return b?parseInt(b,10):1}),[w,_]=n.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[j,ae]=n.useState(null),{developerMode:Z,setDeveloperMode:$e,imageGenMode:Te,setImageGenMode:B,generationMode:Se,setGenerationMode:W,devSkipOutline:X,setDevSkipOutline:Q,devSkipText:E,setDevSkipText:V,devSkipSceneDescriptions:pe,setDevSkipSceneDescriptions:J,devSkipImages:oe,setDevSkipImages:H,devSkipCovers:De,setDevSkipCovers:Be,enableAutoRepair:Ie,setEnableAutoRepair:qe,useGridRepair:q,setUseGridRepair:se,forceRepairThreshold:ve,setForceRepairThreshold:ke,enableFinalChecks:Ae,setEnableFinalChecks:_e,incrementalConsistency:Xe,setIncrementalConsistency:et,incrementalConsistencyDryRun:ot,setIncrementalConsistencyDryRun:a,lookbackCount:Pe,setLookbackCount:Je,checkOnlyMode:Me,setCheckOnlyMode:Bs,enableSceneValidation:$t,setEnableSceneValidation:yr,separatedEvaluation:nr,setSeparatedEvaluation:Jr,enableFullRepairAfterGeneration:Zr,setEnableFullRepairAfterGeneration:cs,loadAllAvatars:ir,setLoadAllAvatars:ha,modelSelections:xt,setModelSelections:ms}=ol(),[Rt,or]=n.useState(()=>localStorage.getItem("story_type")||""),[He,us]=n.useState(()=>localStorage.getItem("story_category")||""),[st,Mr]=n.useState(()=>localStorage.getItem("story_topic")||""),[We,vr]=n.useState(()=>localStorage.getItem("story_theme")||""),[Dt,Ft]=n.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[It,Ue]=n.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[Fe,Oe]=n.useState([]),[xa,lr]=n.useState(null),[R,Ve]=n.useState(null),Ms=n.useRef([]),yt=n.useRef(null),[pa,Kt]=n.useState(!1),[fa,jt]=n.useState("photo"),[ut,Jt]=n.useState(!1),[Qr,St]=n.useState(null),[gs,jr]=n.useState(!1),[hs,Nr]=n.useState(!1),[sn,wr]=n.useState(void 0),[ba,Os]=n.useState(void 0),Yr=n.useRef(null),[Sr,Ls]=n.useState(!1),[Zt,xs]=n.useState([]),[Or,Gs]=n.useState(null),[_s,Hs]=n.useState(null),[pt,ps]=n.useState({}),[Pt,fs]=n.useState({}),[Cr,ya]=n.useState([]),Ws=n.useRef(null),an=n.useRef(!1),Lr=n.useRef(!1),[Lt,va]=n.useState(!1),[Qt,dr]=n.useState([]),[Nt,Gr]=n.useState([]),bs=n.useRef(!1),[Gt,ys]=n.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[Et,kr]=n.useState(()=>{try{const i=localStorage.getItem("story_language");if(i){if(i==="de")return"de-ch";if(i==="fr")return"fr-ch";if(i==="it")return"it-ch";if(i==="en")return"en-gb";if(i.startsWith("de")||i.startsWith("fr")||i.startsWith("it")||i.startsWith("en")||i.startsWith("gsw"))return i}return"de-ch"}catch{return"de-ch"}}),[At,Vs]=n.useState(()=>{try{const i=localStorage.getItem("story_pages");return i?parseInt(i):30}catch{return 30}}),[Pr,vs]=n.useState(()=>localStorage.getItem("story_dedication")||""),[Ar,cr]=n.useState(()=>localStorage.getItem("story_details")||""),[$r,mr]=n.useState(!1),[Ir,Yt]=n.useState(!1),[qs,Xr]=n.useState(!1),[_r,ur]=n.useState(0),[js,ja]=n.useState(0),[es,Us]=n.useState(null),[Tr,ts]=n.useState(""),[zt,Xt]=n.useState([]),[Ns,rs]=n.useState(null),[Ks,Na]=n.useState(null),gr=n.useRef(null),[hr,Js]=n.useState(null),[xr,wa]=n.useState(()=>mi()),[_t,Rr]=n.useState(!1),[Sa,Zs]=n.useState(new Set),[Ca,t]=n.useState(!1),[u,c]=n.useState(!1),[I,l]=n.useState(!1),[ne,ee]=n.useState(!1),[Ee,we]=n.useState(!1),[gt,vt]=n.useState(!1),[Bt,fe]=n.useState({current:0,total:0,message:""}),[at,er]=n.useState(null),[ss,Ht]=n.useState(!1),[ws,tr]=n.useState(""),[Dr,Hr]=n.useState(""),[ka,Qs]=n.useState(""),[Pa,Ys]=n.useState(""),[Aa,Xs]=n.useState(""),[$a,ea]=n.useState(),[Ia,ta]=n.useState(),[Ta,ra]=n.useState([]),[Ra,Fr]=n.useState(null),[Da,as]=n.useState(null),[Fa,Ss]=n.useState([]),[Ea,Cs]=n.useState([]),[za,ks]=n.useState([]),[sa,Ps]=n.useState(null),[Ba,Er]=n.useState([]),[As,wt]=n.useState([]),[U,ze]=n.useState({frontCover:null,initialPage:null,backCover:null}),[re,Mt]=n.useState(null),[pr,ft]=n.useState(0),[Wr,fr]=n.useState(null),[Ma,Cn]=n.useState(!1),[gi,kn]=n.useState(),[hi,Pn]=n.useState(),[xi,An]=n.useState(),[pi,nn]=n.useState(null),on=n.useRef(!1),[fi,bi]=n.useState(null),Vr=n.useRef(!1),[Ot,Oa]=n.useState(null),[ln,La]=n.useState({}),[yi,Ga]=n.useState(!1),[ht,_a]=n.useState(null),[aa,na]=n.useState("");n.useEffect(()=>{Ms.current=Fe},[Fe]),n.useEffect(()=>{yt.current=R},[R]),n.useEffect(()=>{if(!K&&!D){if(!!localStorage.getItem("auth_token")){f.debug("Token found but not authenticated yet, waiting for state sync...");return}const b=window.location.pathname+window.location.search,g=encodeURIComponent(b);r(`/?login=true&redirect=${g}`)}},[D,K,r]);const Ha=n.useCallback(i=>{var b,g,M,p,P,z,G,F,ge,le;if(i){if((b=i.sceneImages)!=null&&b.length&&wt(ue=>ue.map(je=>{const Ge=i.sceneImages.find(ct=>ct.pageNumber===je.pageNumber);return Ge?{...je,prompt:Ge.prompt??je.prompt,qualityReasoning:Ge.qualityReasoning??je.qualityReasoning,retryHistory:Ge.retryHistory??je.retryHistory,repairHistory:Ge.repairHistory??je.repairHistory,wasRegenerated:Ge.wasRegenerated??je.wasRegenerated,originalScore:Ge.originalScore??je.originalScore,originalReasoning:Ge.originalReasoning??je.originalReasoning,totalAttempts:Ge.totalAttempts??je.totalAttempts,faceEvaluation:Ge.faceEvaluation??je.faceEvaluation,referencePhotos:Ge.referencePhotos??je.referencePhotos,landmarkPhotos:Ge.landmarkPhotos??je.landmarkPhotos,consistencyRegen:Ge.consistencyRegen??je.consistencyRegen}:je})),i.coverImages&&ze(ue=>{var ct;const je={...ue},Ge=["frontCover","initialPage","backCover"];for(const mt of Ge){const xe=(ct=i.coverImages)==null?void 0:ct[mt],rt=ue[mt];xe&&typeof rt=="object"&&rt!==null&&(je[mt]={...rt,prompt:xe.prompt??rt.prompt,qualityReasoning:xe.qualityReasoning??rt.qualityReasoning,retryHistory:xe.retryHistory??rt.retryHistory,referencePhotos:xe.referencePhotos??rt.referencePhotos,landmarkPhotos:xe.landmarkPhotos??rt.landmarkPhotos})}return je}),console.log("[StoryWizard] Dev metadata generationLog:",((g=i.generationLog)==null?void 0:g.length)||0,"entries"),(M=i.generationLog)!=null&&M.length&&ks(i.generationLog),(p=i.styledAvatarGeneration)!=null&&p.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",((P=i.styledAvatarGeneration)==null?void 0:P.length)??0,"entries"),Ss(i.styledAvatarGeneration)),(z=i.costumedAvatarGeneration)!=null&&z.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",((G=i.costumedAvatarGeneration)==null?void 0:G.length)??0,"entries"),Cs(i.costumedAvatarGeneration)),i.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",i.finalChecksReport.totalIssues,"issues"),Ps(i.finalChecksReport)),(F=i.sceneDescriptions)!=null&&F.length){const ue=i.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",ue.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(ue[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((ge=ue[0])!=null&&ge.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((le=ue[0])!=null&&le.scenePrompt)),Er(i.sceneDescriptions)}i.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),Fr(i.visualBible))}},[]);n.useEffect(()=>{Le.getUserLocation().then(i=>{Js(i),i!=null&&i.city&&Le.triggerLandmarkDiscovery(i.city,i.country)})},[]),n.useEffect(()=>{D&&Le.getStories({limit:1}).then(({pagination:i})=>{we(i.total>0)}).catch(()=>we(!1))},[D]);const dn=n.useRef(null);n.useEffect(()=>{const i=d.get("storyId");d.get("new")!=="true"&&(i&&(dn.current=null),x&&!i&&dn.current!==x.jobId&&(f.info("Returning during active generation, restoring progress for job:",x.jobId),dn.current=x.jobId,de(6),Rr(!0),tr(x.storyTitle),fr(x.jobId),Le.getJobStatus(x.jobId).then(g=>{var M,p;if(f.info("Restored job status:",{progress:g.progress,hasStoryText:!!g.storyText,storyTextKeys:g.storyText?Object.keys(g.storyText):[],pageTextsCount:(M=g.storyText)!=null&&M.pageTexts?Object.keys(g.storyText.pageTexts).length:0,partialPages:((p=g.partialPages)==null?void 0:p.length)||0}),g.progress&&fe(P=>g.progress.current>=P.current?g.progress:{...P,message:g.progress.message}),g.storyText){const P=g.storyText.pageTexts||{};f.info("Setting progressiveStoryData with",Object.keys(P).length,"pages"),Oa({title:g.storyText.title||x.storyTitle,dedication:g.storyText.dedication,pageTexts:P,sceneDescriptions:g.storyText.sceneDescriptions||[],totalPages:g.storyText.totalPages||At})}else f.warn("No storyText in job status response");if(g.partialPages&&g.partialPages.length>0){const P={};g.partialPages.forEach(z=>{z.pageNumber&&z.imageData&&(P[z.pageNumber]=z.imageData)}),f.info("Restored",Object.keys(P).length,"page images"),La(P)}g.partialCovers&&ze(P=>{var z,G,F;return{frontCover:((z=g.partialCovers)==null?void 0:z.frontCover)||P.frontCover,initialPage:((G=g.partialCovers)==null?void 0:G.initialPage)||P.initialPage,backCover:((F=g.partialCovers)==null?void 0:F.backCover)||P.backCover}})}).catch(g=>{f.error("Failed to restore job status:",g)})),f.debug("Auto-nav check:",{generationComplete:O,completedStoryId:be,urlStoryId:i,hasActiveJob:!!x}),O&&be&&!i&&(f.info("Generation completed, navigating to story:",be),o({storyId:be},{replace:!0})))},[x,O,be,d,o,At]),n.useEffect(()=>{if(d.get("new")==="true"){f.info("New story requested - resetting all story settings"),or(""),us(""),Mr(""),vr(""),Ft(""),Ue("watercolor"),ys("standard"),Vs(30),vs(""),cr(""),lr(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const b=new URLSearchParams(d);b.delete("new"),o(b,{replace:!0}),Ve(null),jt("photo"),de(1)}},[d,o]),n.useEffect(()=>{const i=d.get("storyId");i&&L!==6&&de(6),(async()=>{if(!(!i||!D)){if(on.current){on.current=!1,f.info("Skipping story reload - just finished generating");return}f.info("Loading saved story progressively:",i),_(!0),ae(null),er(null);try{await Le.getStoryProgressively(i,(g,M)=>{var p,P,z,G;f.info("Metadata loaded:",g.title,`(${M} images to load)`),Mt(g.id),tr(g.title||""),or(g.storyType||""),Ue(g.artStyle||"pixar"),Ys(g.outline||""),Xs(g.outlinePrompt||""),ea(g.outlineModelId),ta(g.outlineUsage),ra(g.storyTextPrompts||[]),Ss(g.styledAvatarGeneration||[]),Cs(g.costumedAvatarGeneration||[]),(p=g.generationLog)!=null&&p.length&&(console.log("[StoryWizard] Loading story metadata, generationLog:",((P=g.generationLog)==null?void 0:P.length)??0,"entries"),ks(g.generationLog)),g.visualBible?Fr({mainCharacters:g.visualBible.mainCharacters||[],secondaryCharacters:g.visualBible.secondaryCharacters||[],animals:g.visualBible.animals||[],artifacts:g.visualBible.artifacts||[],locations:g.visualBible.locations||[],vehicles:g.visualBible.vehicles||[],clothing:g.visualBible.clothing||[],changeLog:g.visualBible.changeLog||[]}):Fr(null),g.clothingRequirements?as(g.clothingRequirements):as(null),wt(g.sceneImages||[]),Er(g.sceneDescriptions||[]),ze(g.coverImages||{frontCover:null,initialPage:null,backCover:null}),ys(g.languageLevel||"standard"),g.language&&kr(g.language),Rr(!1),Cn(g.isPartial||!1),kn(g.failureReason),Pn(g.generatedPages),An(g.totalPages),Hr(g.story||""),Qs(g.originalStory||g.story||""),nn({storyCategory:g.storyCategory,storyTopic:g.storyTopic,storyTheme:g.storyTheme,storyTypeName:g.storyTypeName,storyDetails:g.storyDetails,artStyle:g.artStyle,language:g.language,languageLevel:g.languageLevel,pages:g.pages,dedication:g.dedication,characters:(z=g.characters)==null?void 0:z.map(F=>{var ge;return{id:F.id,name:F.name,isMain:(ge=g.mainCharacters)==null?void 0:ge.includes(F.id)}}),mainCharacters:g.mainCharacters,relationships:g.relationships,relationshipTexts:g.relationshipTexts,season:g.season,userLocation:g.userLocation}),(G=g.characters)!=null&&G.length&&lr(g.characters.map(F=>{var ge,le;return{id:F.id,name:F.name,photoData:F.photoData||((ge=F.photos)==null?void 0:ge.face)||((le=F.photos)==null?void 0:le.original)}})),de(6),_(!1),ae(null),M>0&&er({loaded:0,total:M}),Vr.current=!0,Le.getStoryDevMetadata(i).then(F=>{Ha(F),f.debug("Dev metadata merged into story")}).catch(F=>{f.warn("Failed to load dev metadata:",F),Vr.current=!1})},(g,M,p,P)=>{if(typeof g=="number")wt(z=>z.map(G=>{if(G.pageNumber!==g)return G;const F=G.imageVersions||[],ge=p==null?void 0:p.map((le,ue)=>({...F[ue]||{},...le}));return{...G,imageData:M,imageVersions:ge||F}}));else{const z=g;ze(G=>{const F=G[z];return typeof F=="object"&&F!==null?{...G,[z]:{...F,imageData:M}}:{...G,[z]:M}})}P!==void 0&&er(z=>z?{...z,loaded:P}:null)},()=>{f.info("All images loaded"),er(null)})}catch(g){f.error("Failed to load story:",g),_(!1),ae(null),er(null)}}})()},[d,D,pr]),n.useEffect(()=>{L===6&&A&&(f.info("Clearing unviewed completion - user is viewing story"),he())},[L,A,he]),n.useEffect(()=>{(async()=>{const b=d.get("payment"),g=d.get("session_id");if(b==="success"&&g){f.info("Payment successful! Checking order status..."),f.info("Session ID:",g);try{const P=await Le.getOrderStatus(g);if(f.info("Order Status:",P),P.order){const z=`CHF ${(P.order.amount_total/100).toFixed(2)}`,G={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement rÃ©ussi!"},F={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a Ã©tÃ© reÃ§ue et sera bientÃ´t imprimÃ©e."},ge=[`${s==="de"?"Kunde":s==="fr"?"Client":"Customer"}: ${P.order.customer_name}`,`Email: ${P.order.customer_email}`,`${s==="de"?"Betrag":s==="fr"?"Montant":"Amount"}: ${z}`,`${s==="de"?"Versand an":s==="fr"?"ExpÃ©diÃ© Ã ":"Shipping to"}: ${P.order.shipping_name}`,`${P.order.shipping_address_line1}`,`${P.order.shipping_postal_code} ${P.order.shipping_city}`,`${P.order.shipping_country}`];T(F[s]||F.en,G[s]||G.en,ge)}}catch(P){f.error("Error checking order status:",P)}const p=new URLSearchParams(d);p.delete("payment"),p.delete("session_id"),o(p,{replace:!0})}else if(b==="cancelled"){f.info("Payment cancelled by user");const p={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie kÃ¶nnen es erneut versuchen.",fr:"Paiement annulÃ©. Vous pouvez rÃ©essayer quand vous Ãªtes prÃªt."};v(p[s]||p.en,s==="de"?"Abgebrochen":s==="fr"?"AnnulÃ©":"Cancelled");const P=new URLSearchParams(d);P.delete("payment"),o(P,{replace:!0})}const M=d.get("credits_payment");if(M==="success"){f.info("Credits payment successful!"),await $();const p={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},P={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};T(P[s]||P.en,p[s]||p.en);const z=new URLSearchParams(d);z.delete("credits_payment"),z.delete("session_id"),o(z,{replace:!0})}else if(M==="cancelled"){f.info("Credits payment cancelled by user");const p={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};v(p[s]||p.en,s==="de"?"Abgebrochen":s==="fr"?"Annule":"Cancelled");const P=new URLSearchParams(d);P.delete("credits_payment"),o(P,{replace:!0})}})()},[d,o,s,T,v,$]);const Wa=n.useRef(!1);n.useEffect(()=>{if(d.get("autoGenerate")==="true"&&!Wa.current){Wa.current=!0;const b=localStorage.getItem("pending_story_type"),g=localStorage.getItem("pending_art_style");b&&(or(b),localStorage.removeItem("pending_story_type")),g&&(Ue(g),localStorage.removeItem("pending_art_style")),de(6);const M=new URLSearchParams(d);M.delete("autoGenerate"),o(M,{replace:!0})}},[d,o]);const cn=i=>{if(i.length===0)return;const b=i.filter(g=>{const M=parseInt(g.age);return M>=1&&M<=10});if(b.length>0){const g=b.map(M=>M.id);dr(g),f.info(`Auto-selected ${b.length} main character(s) aged 1-10`)}else{const g=i.reduce((M,p)=>{const P=parseInt(p.age)||999,z=parseInt(M.age)||999;return P<z?p:M});dr([g.id]),f.info(`Auto-selected youngest character as main: ${g.name} (age ${g.age})`)}};n.useEffect(()=>{D?(async()=>{try{_(!0);const b=await Ye.getCharacterData(ir);if(f.info("Loaded character data from API:",{characters:b.characters.length,relationships:Object.keys(b.relationships).length}),Oe(b.characters),Object.keys(b.relationships).length>0&&(ps(b.relationships),an.current=!0),Object.keys(b.relationshipTexts).length>0&&fs(b.relationshipTexts),b.customRelationships.length>0&&ya(b.customRelationships),b.characters.some(M=>M.storyRole)){const M=[],p=[];for(const P of b.characters)P.storyRole==="main"?M.push(P.id):P.storyRole==="out"&&p.push(P.id);dr(M),Gr(p),f.info(`Loaded character roles from database: ${M.length} main, ${p.length} excluded`)}else b.characters.length>0&&cn(b.characters)}catch(b){f.error("Failed to load character data:",b)}finally{_(!1),va(!0)}})():K||va(!0)},[D,K]),n.useEffect(()=>{Z&&re&&!Vr.current&&(Vr.current=!0,f.info("Developer mode enabled, fetching dev metadata for story:",re),Le.getStoryDevMetadata(re).then(i=>{Ha(i),f.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(i=>{f.warn("Failed to load dev metadata on toggle:",i),Vr.current=!1})),(!Z||!re)&&(Vr.current=!1)},[Z,re,Ha]),n.useEffect(()=>{ir&&D&&Lt&&(async()=>{try{f.info("Reloading characters with full avatars (dev mode)");const b=await Ye.getCharacterData(!0);Oe(b.characters),f.info(`Loaded ${b.characters.length} characters with full avatars`)}catch(b){f.error("Failed to reload with full avatars:",b)}})()},[ir,D,Lt]),n.useEffect(()=>{L===1&&Fe.length===0&&!R&&!w&&Lt&&un()},[L,Fe.length,R,w,Lt]);const mn=n.useRef(Nt);n.useEffect(()=>{mn.current!==Nt&&JSON.stringify(mn.current)!==JSON.stringify(Nt)&&(Xt([]),cr(""),mn.current=Nt)},[Nt]),n.useEffect(()=>{localStorage.setItem("story_language_level",Gt)},[Gt]),n.useEffect(()=>{localStorage.setItem("story_language",Et)},[Et]),n.useEffect(()=>{localStorage.setItem("story_pages",At.toString())},[At]),n.useEffect(()=>{localStorage.setItem("story_dedication",Pr)},[Pr]),n.useEffect(()=>{localStorage.setItem("story_details",Ar)},[Ar]),n.useEffect(()=>{localStorage.setItem("story_type",Rt)},[Rt]),n.useEffect(()=>{He?localStorage.setItem("story_category",He):localStorage.removeItem("story_category")},[He]),n.useEffect(()=>{st?localStorage.setItem("story_topic",st):localStorage.removeItem("story_topic")},[st]),n.useEffect(()=>{We?localStorage.setItem("story_theme",We):localStorage.removeItem("story_theme")},[We]),n.useEffect(()=>{Dt?localStorage.setItem("story_custom_theme_text",Dt):localStorage.removeItem("story_custom_theme_text")},[Dt]);const $n=n.useRef(He),In=n.useRef(st),Tn=n.useRef(We),Rn=n.useRef(!0);n.useEffect(()=>{if(Rn.current){Rn.current=!1;return}const i=$n.current!==He,b=In.current!==st,g=Tn.current!==We;(i||b||g)&&(cr(""),localStorage.removeItem("story_details"),Xt([])),$n.current=He,In.current=st,Tn.current=We},[He,st,We]),n.useEffect(()=>{localStorage.setItem("story_art_style",It)},[It]);const ia=n.useRef(!1);n.useEffect(()=>{if(L===4&&!ia.current&&!$r&&zt.length===0){const i=!!He,b=!!We||!!st,g=Fe.length>0;i&&b&&g&&(ia.current=!0,f.info("[StoryWizard] Pre-generating story ideas while user selects art style"),En())}ia.current&&zt.length===0&&(ia.current=!1)},[L,He,We,st,Fe.length,$r,zt.length]);const Dn=n.useRef({storyCategory:He,storyTheme:We,storyTopic:st});n.useEffect(()=>{const i=Dn.current,b=i.storyCategory!==He||i.storyTheme!==We||i.storyTopic!==st;Dn.current={storyCategory:He,storyTheme:We,storyTopic:st},b&&($r||zt.length>0)&&(f.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),gr.current&&(gr.current.abort(),gr.current=null),mr(!1),Yt(!1),Xr(!1),Xt([]),Us(null),ts(""),ia.current=!1)},[He,We,st,$r,zt.length]),n.useEffect(()=>{if(!$r)return;const b=setTimeout(()=>{f.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),mr(!1),Yt(!1),Xr(!1),k(s==="de"?"ZeitÃ¼berschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":s==="fr"?"DÃ©lai d'attente de gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(b)},[$r,s]),n.useEffect(()=>{if(!Ir&&!qs){ur(0),ja(0);return}const i=35e3,b=80,g=100,M=Date.now(),p=setInterval(()=>{const P=Date.now()-M,z=Math.min(P/i,1),G=1-Math.pow(1-z,3),F=Math.round(G*b);Ir&&ur(F),qs&&ja(F),z>=1&&clearInterval(p)},g);return()=>clearInterval(p)},[Ir,qs]),n.useEffect(()=>{L>=1&&L<=5&&localStorage.setItem("wizard_step",L.toString())},[L]);const vi=i=>{us(i)},ji=i=>{vr(i),!(i==="custom"||i==="realistic"||i==="")&&(He==="adventure"||(He==="life-challenge"||He==="educational")&&st!=="")&&zr(4)},Ni=i=>{Mr(i),He==="historical"&&i!==""&&zr(4)},wi=i=>{Ue(i),zr(5)};n.useEffect(()=>{if(L===2&&Fe.length>=2&&!w){const i=Fe.map(b=>b.id).sort().join("-");if(!Ws.current||Ws.current!==i){const g=Yo(s);f.debug("Initializing relationships for step 2",{charKey:i,existingCount:Object.keys(pt).length}),ps(M=>{const p={...M};let P=!1;return Fe.forEach((z,G)=>{Fe.forEach((F,ge)=>{if(G!==ge){const le=`${z.id}-${F.id}`;p[le]||(p[le]=g,P=!0,f.debug("Initializing missing relationship:",le))}})}),P?p:M}),Ws.current=i}}},[L,Fe,s,w]);const Si=()=>{if(Fe.length<2)return!0;for(let i=0;i<Fe.length;i++)for(let b=0;b<Fe.length;b++)if(i!==b){const g=`${Fe[i].id}-${Fe[b].id}`,M=pt[g];if(!M||Xn(M))return!1}return!0},Ci=()=>{if(Fe.length<2)return null;let i=0,b=null;for(const g of Fe){let M=0;for(const p of Fe)if(g.id!==p.id){const P=`${g.id}-${p.id}`,z=pt[P];(!z||Xn(z))&&M++}M>i&&(i=M,b=g)}return b},un=()=>{Ve({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),jt("photo"),Kt(!1)},ki=(i,b=1500)=>new Promise(g=>{const M=new Image;M.onload=()=>{const p=document.createElement("canvas");let{width:P,height:z}=M;(P>b||z>b)&&(P>z?(z=Math.round(z*b/P),P=b):(P=Math.round(P*b/z),z=b)),p.width=P,p.height=z;const G=p.getContext("2d");G==null||G.drawImage(M,0,0,P,z),g(p.toDataURL("image/jpeg",.85))},M.onerror=()=>g(i),M.src=i}),Pi=async(i,b)=>{var p,P,z,G,F;if(f.info(`ðŸ“¸ handlePhotoSelect called: file=${i==null?void 0:i.name}, character=${R==null?void 0:R.name}, developerMode=${Z}`),R&&!Z){const ge=!!((p=R.avatars)!=null&&p.winter||(P=R.avatars)!=null&&P.standard||(z=R.avatars)!=null&&z.summer||(G=R.avatars)!=null&&G.hasFullAvatars);if(f.info(`ðŸ“¸ hasAvatars=${ge}`),ge){const le=rn(R.id);if(f.info(`ðŸ“¸ cooldown check: canRegenerate=${le.canRegenerate}, waitSeconds=${le.waitSeconds}`),!le.canRegenerate){const ue=s==="de"?`Bitte warten Sie ${le.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${le.waitSeconds} seconds before uploading a new photo.`;k(ue);return}ui(R.id)}}const g=b&&((F=R==null?void 0:R.clothing)!=null&&F.structured)?{...R.clothing.structured}:null,M=new FileReader;M.onload=async ge=>{var ue,je,Ge,ct,mt,xe,rt,ye,ie,Y,me,te;const le=(ue=ge.target)==null?void 0:ue.result;R&&(Yr.current={physical:R.physical,gender:R.gender,age:R.age}),wr(void 0),Jt(!0),!(R!=null&&R.name)||R.name.trim().length<2?jt("name"):(jt("traits"),f.info("ðŸ“¸ Character has name, going to traits step to show avatar regeneration"));try{const Ne=await ki(le),Ze=Math.round(le.length/1024),ce=Math.round(Ne.length/1024);f.info(`Starting photo analysis... (${Ze}KB -> ${ce}KB)`);const Ke=R!=null&&R.id&&R.id>0?R.id:void 0,Re=await Ye.analyzePhoto(Ne,s,void 0,void 0,Ke);if(Re.success){if(Re.multipleFacesDetected&&Re.faces&&Re.faces.length>1){f.info(`Multiple faces detected (${Re.faces.length}), showing selection modal`),Gs(Ne),Hs(g?{structured:g}:null),xs(Re.faces),Ls(!0),Jt(!1);return}f.info("Photo analysis complete:",{hasPhotos:!!Re.photos,hasPhysical:!!Re.physical,hasClothing:!!Re.clothing,age:Re.age,gender:Re.gender}),Re._debug&&(Os(Re._debug),Re._debug.rawResponse,Re._debug.error&&console.warn("ðŸ“¸ [DEBUG] Gemini error:",Re._debug.error));const nt={original:((je=Re.photos)==null?void 0:je.face)||le,face:(Ge=Re.photos)==null?void 0:Ge.face,body:((ct=Re.photos)==null?void 0:ct.body)||le,bodyNoBg:(mt=Re.photos)==null?void 0:mt.bodyNoBg,faceBox:(xe=Re.photos)==null?void 0:xe.faceBox,bodyBox:(rt=Re.photos)==null?void 0:rt.bodyBox},bt=(ye=Re.photos)!=null&&ye.bodyNoBg?Math.round(Re.photos.bodyNoBg.length/1024):0,Ct=(ie=Re.photos)!=null&&ie.body?Math.round(Re.photos.body.length/1024):0,Va=(Y=Re.photos)!=null&&Y.face?Math.round(Re.photos.face.length/1024):0;if(f.info(`ðŸ“¸ [PHOTO CHANGE] Analysis returned: bodyNoBg=${bt}KB, body=${Ct}KB, face=${Va}KB`),(me=Re.photos)!=null&&me.bodyNoBg){const Qe=Re.photos.bodyNoBg.substring(Re.photos.bodyNoBg.indexOf("base64,")+7,Re.photos.bodyNoBg.indexOf("base64,")+27);f.info(`ðŸ“¸ [PHOTO CHANGE] bodyNoBg fingerprint: ${Qe}...`)}let rr,qa;g?(rr={structured:g},qa={upperBody:g.upperBody?"user":void 0,lowerBody:g.lowerBody?"user":void 0,shoes:g.shoes?"user":void 0,fullBody:g.fullBody?"user":void 0},f.info(`ðŸ‘• Keeping old clothing (marked as user-edited): ${JSON.stringify(g)}`)):f.info("ðŸ‘• Using new photo's clothing (cleared existing)");const Ua=Re.characterId,hn=(R==null?void 0:R.id)&&R.id>0,$s=hn?R.id:Ua;hn?f.info(`ðŸ“¸ [PHOTO] Keeping existing character ID: ${R.id} (server created new ID ${Ua} but ignoring)`):Ua&&f.info(`ðŸ“¸ [PHOTO] Using server-created character ID: ${Ua}`);const Wt=R?{...R,id:$s||R.id,photos:nt,avatars:{status:"generating"},clothing:rr,clothingSource:qa}:null;if(Wt){const Qe=(te=Wt.photos)==null?void 0:te.bodyNoBg,Tt=Qe?Math.round(Qe.length/1024):0;if(f.info(`ðŸ“¸ [CHAR FOR GEN] bodyNoBg=${Tt}KB, has photos: ${!!Wt.photos}`),Qe){const tt=Qe.substring(Qe.indexOf("base64,")+7,Qe.indexOf("base64,")+27);f.info(`ðŸ“¸ [CHAR FOR GEN] fingerprint: ${tt}...`)}}if(Ve(Qe=>{var tt;if(!Qe)return null;const Tt=(tt=Qe.avatars)!=null&&tt.standard?{...Qe.avatars,status:"generating",stale:!0}:{status:"generating"};return{...Qe,id:$s||Qe.id,photos:nt,avatars:Tt,clothing:rr,clothingSource:qa}}),$s&&!hn&&Oe(Qe=>{if(!Qe.some(tt=>tt.id===$s)){const tt={...R,id:$s,photos:nt,avatars:{status:"generating"},clothing:rr,clothingSource:qa};return f.info(`ðŸ“¸ Adding new character ${$s} to array to prevent data loss`),[...Qe,tt]}return Qe}),f.info("ðŸŽ¨ Auto-starting avatar generation in background..."),f.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!nt.bodyNoBg}, body=${!!nt.body}, face=${!!nt.face}`),Wt&&Wt.id&&Wt.name&&Wt.name.trim()){const Qe=Wt.id;St(Qe),Ye.generateAndSaveAvatarForCharacter(Wt,void 0,{avatarModel:xt.avatarModel||void 0}).then(Tt=>{Tt.success&&Tt.character?(Ve(tt=>!tt||tt.id!==Qe?tt:{...tt,avatars:Tt.character.avatars,physical:Tt.character.physical,clothing:Tt.character.clothing}),Oe(tt=>tt.map(Vt=>Vt.id===Qe?{...Vt,...Tt.character,id:Vt.id}:Vt)),f.success(`âœ… Avatar generated and traits extracted for ${Wt.name}`)):(f.error(`âŒ Avatar generation failed: ${Tt.error}`),Ve(tt=>tt&&tt.id===Qe?{...tt,avatars:{status:"failed"}}:tt),Oe(tt=>tt.map(Vt=>Vt.id===Qe?{...Vt,avatars:{status:"failed"}}:Vt)))}).catch(Tt=>{f.error("âŒ Avatar generation error:",Tt),Ve(tt=>tt&&tt.id===Qe?{...tt,avatars:{status:"failed"}}:tt),Oe(tt=>tt.map(Vt=>Vt.id===Qe?{...Vt,avatars:{status:"failed"}}:Vt))}).finally(()=>{St(null)})}else Wt&&Wt.id?(f.info("â­ï¸ Skipping auto-generation: character has no name yet"),St(null),Ve(Qe=>Qe&&{...Qe,avatars:{status:"pending"}})):(f.warn("â­ï¸ Skipping auto-generation: no character data available"),St(null))}else Re.error==="no_face_detected"?(f.warn("No face detected in photo"),k(m.noFaceDetected)):(f.warn("Photo analysis returned no data, using original photo"),Ve(nt=>nt?{...nt,photos:{original:le},avatars:void 0}:null))}catch(Ne){f.error("Photo analysis error:",Ne),Ve(Ze=>Ze?{...Ze,photos:{original:le},avatars:void 0}:null)}finally{Jt(!1)}},M.readAsDataURL(i)},Ai=async i=>{var b,g,M,p,P,z,G,F;if(!Or){f.error("No pending photo data for face selection");return}Ls(!1),Jt(!0);try{f.info(`Re-analyzing photo with selected face ID: ${i}`);const ge=Zt.map(je=>({id:je.id,x:je.faceBox.x,y:je.faceBox.y,width:je.faceBox.width,height:je.faceBox.height,confidence:je.confidence})),le=R!=null&&R.id&&R.id>0?R.id:void 0,ue=await Ye.analyzePhoto(Or,s,i,ge,le);if(ue.success){f.info("Photo analysis complete with selected face:",{hasPhotos:!!ue.photos,hasPhysical:!!ue.physical,hasClothing:!!ue.clothing,age:ue.age,gender:ue.gender}),ue._debug&&Os(ue._debug);const je=_s==null?void 0:_s.structured,Ge={original:((b=ue.photos)==null?void 0:b.face)||Or,face:(g=ue.photos)==null?void 0:g.face,body:((M=ue.photos)==null?void 0:M.body)||Or,bodyNoBg:(p=ue.photos)==null?void 0:p.bodyNoBg,faceBox:(P=ue.photos)==null?void 0:P.faceBox,bodyBox:(z=ue.photos)==null?void 0:z.bodyBox},ct=(G=ue.photos)!=null&&G.bodyNoBg?Math.round(ue.photos.bodyNoBg.length/1024):0;if(f.info(`ðŸ“¸ [FACE SELECT] Analysis returned: bodyNoBg=${ct}KB`),(F=ue.photos)!=null&&F.bodyNoBg){const me=ue.photos.bodyNoBg.substring(ue.photos.bodyNoBg.indexOf("base64,")+7,ue.photos.bodyNoBg.indexOf("base64,")+27);f.info(`ðŸ“¸ [FACE SELECT] bodyNoBg fingerprint: ${me}...`)}let mt,xe;je&&(mt={structured:je},xe={upperBody:je.upperBody?"user":void 0,lowerBody:je.lowerBody?"user":void 0,shoes:je.shoes?"user":void 0,fullBody:je.fullBody?"user":void 0});const rt=ue.characterId,ye=(R==null?void 0:R.id)&&R.id>0,ie=ye?R.id:rt;ye?f.info(`ðŸ“¸ [FACE SELECT] Keeping existing character ID: ${R.id} (server created new ID ${rt} but ignoring)`):rt&&f.info(`ðŸ“¸ [FACE SELECT] Using server-created character ID: ${rt}`);const Y=R?{...R,id:ie||R.id,photos:Ge,avatars:{status:"generating"},clothing:mt,clothingSource:xe}:null;if(Ve(me=>{var Ne;if(!me)return null;const te=(Ne=me.avatars)!=null&&Ne.standard?{...me.avatars,status:"generating",stale:!0}:{status:"generating"};return{...me,id:ie||me.id,photos:Ge,avatars:te,clothing:mt,clothingSource:xe}}),ie&&!ye&&Oe(me=>{if(!me.some(Ne=>Ne.id===ie)){const Ne={...R,id:ie,photos:Ge,avatars:{status:"generating"},clothing:mt,clothingSource:xe};return f.info(`ðŸ“¸ [FACE SELECT] Adding new character ${ie} to array to prevent data loss`),[...me,Ne]}return me}),R!=null&&R.name&&R.name.trim().length>=2?(jt("traits"),f.info("ðŸ“¸ Face selected, character has name, going to traits step")):jt("name"),f.info("ðŸŽ¨ Auto-starting avatar generation in background after face selection..."),f.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Ge.bodyNoBg}, body=${!!Ge.body}, face=${!!Ge.face}`),Y&&Y.name&&Y.name.trim()){const me=Y.id;St(me),Ye.generateAndSaveAvatarForCharacter(Y,void 0,{avatarModel:xt.avatarModel||void 0}).then(te=>{te.success&&te.character?(Ve(Ne=>!Ne||Ne.id!==me?Ne:{...Ne,avatars:te.character.avatars,physical:te.character.physical,clothing:te.character.clothing}),Oe(Ne=>Ne.map(Ze=>Ze.id===me?{...Ze,...te.character,id:Ze.id}:Ze)),f.success(`âœ… Avatar generated for ${Y.name} (face selection)`)):(f.error(`âŒ Avatar generation failed: ${te.error}`),Ve(Ne=>Ne&&Ne.id===me?{...Ne,avatars:{status:"failed"}}:Ne),Oe(Ne=>Ne.map(Ze=>Ze.id===me?{...Ze,avatars:{status:"failed"}}:Ze)))}).catch(te=>{f.error("âŒ Avatar generation error:",te),Ve(Ne=>Ne&&Ne.id===me?{...Ne,avatars:{status:"failed"}}:Ne),Oe(Ne=>Ne.map(Ze=>Ze.id===me?{...Ze,avatars:{status:"failed"}}:Ze))}).finally(()=>{St(null)})}else f.info("â­ï¸ Skipping auto-generation: character has no name yet"),St(null),Ve(me=>me&&{...me,avatars:{status:"pending"}})}else f.warn("Photo analysis failed after face selection"),k(m.noFaceDetected)}catch(ge){f.error("Photo analysis error after face selection:",ge),k("Failed to analyze photo. Please try again.")}finally{Jt(!1),Gs(null),Hs(null),xs([])}},$i=()=>{Ls(!1),Gs(null),Hs(null),xs([]),jt("photo")},Ii=async()=>{if(R){Ve(i=>i&&{...i,avatars:void 0}),jr(!0);try{f.info(`ðŸ”„ Regenerating avatars for ${R.name}...`);const i=await Ye.regenerateAvatarsForCharacter(R.id,(b,g)=>f.info(`[${b}] ${g}`),{avatarModel:xt.avatarModel||void 0});if(i.success&&i.character){const b={...i.character.avatars,stale:!1};Ve(g=>g&&{...g,avatars:b,physical:i.character.physical,clothing:i.character.clothing}),Oe(g=>g.map(M=>M.id===R.id?{...M,avatars:b,physical:i.character.physical,clothing:i.character.clothing}:M)),f.success(`âœ… Avatars and traits regenerated for ${R.name}`)}else f.error(`âŒ Failed to regenerate avatars: ${i.error}`),k(`Failed to regenerate avatars: ${i.error||"Unknown error"}`)}catch(i){f.error(`âŒ Failed to regenerate avatars for ${R.name}:`,i),k(`Failed to regenerate avatars: ${i instanceof Error?i.message:"Unknown error"}`)}finally{jr(!1)}}},Ti=async()=>{var i,b,g,M,p,P,z,G,F,ge,le,ue,je,Ge,ct,mt;if(R){Ve(xe=>xe&&{...xe,avatars:void 0}),Nr(!0);try{f.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${R.name}...`),f.info(`Physical traits: ${JSON.stringify(R.physical)}`);const xe=await Ye.generateClothingAvatarsWithTraits(R);if(xe.success&&xe.avatars){const rt={...xe.avatars,stale:!1,generatedAt:new Date().toISOString()},ye=R.physicalTraitsSource||{},ie=xe.extractedTraits?{height:(i=R.physical)==null?void 0:i.height,eyeColor:ye.eyeColor==="user"?(b=R.physical)==null?void 0:b.eyeColor:xe.extractedTraits.eyeColor,eyeColorHex:ye.eyeColor==="user"?(g=R.physical)==null?void 0:g.eyeColorHex:xe.extractedTraits.eyeColorHex,hairColor:ye.hairColor==="user"?(M=R.physical)==null?void 0:M.hairColor:xe.extractedTraits.hairColor,hairColorHex:ye.hairColor==="user"?(p=R.physical)==null?void 0:p.hairColorHex:xe.extractedTraits.hairColorHex,hairLength:ye.hairLength==="user"?(P=R.physical)==null?void 0:P.hairLength:xe.extractedTraits.hairLength,hairStyle:ye.hairStyle==="user"?(z=R.physical)==null?void 0:z.hairStyle:xe.extractedTraits.hairStyle,build:ye.build==="user"?(G=R.physical)==null?void 0:G.build:xe.extractedTraits.build,face:ye.face==="user"?(F=R.physical)==null?void 0:F.face:xe.extractedTraits.face,facialHair:ye.facialHair==="user"?(ge=R.physical)==null?void 0:ge.facialHair:xe.extractedTraits.facialHair,other:ye.other==="user"?(le=R.physical)==null?void 0:le.other:xe.extractedTraits.other,skinTone:ye.skinTone==="user"?(ue=R.physical)==null?void 0:ue.skinTone:xe.extractedTraits.skinTone,skinToneHex:ye.skinTone==="user"?(je=R.physical)==null?void 0:je.skinToneHex:xe.extractedTraits.skinToneHex,detailedHairAnalysis:xe.extractedTraits.detailedHairAnalysis||((Ge=R.physical)==null?void 0:Ge.detailedHairAnalysis),apparentAge:ye.apparentAge==="user"?(ct=R.physical)==null?void 0:ct.apparentAge:xe.extractedTraits.apparentAge||((mt=R.physical)==null?void 0:mt.apparentAge)}:R.physical,Y=xe.extractedTraits?{eyeColor:ye.eyeColor==="user"?"user":xe.extractedTraits.eyeColor?"extracted":void 0,hairColor:ye.hairColor==="user"?"user":xe.extractedTraits.hairColor?"extracted":void 0,hairLength:ye.hairLength==="user"?"user":xe.extractedTraits.hairLength?"extracted":void 0,hairStyle:ye.hairStyle==="user"?"user":xe.extractedTraits.hairStyle?"extracted":void 0,build:ye.build==="user"?"user":xe.extractedTraits.build?"extracted":void 0,face:ye.face==="user"?"user":xe.extractedTraits.face?"extracted":void 0,facialHair:ye.facialHair==="user"?"user":xe.extractedTraits.facialHair?"extracted":void 0,other:ye.other==="user"?"user":xe.extractedTraits.other?"extracted":void 0,skinTone:ye.skinTone==="user"?"user":xe.extractedTraits.skinTone?"extracted":void 0,apparentAge:ye.apparentAge==="user"?"user":xe.extractedTraits.apparentAge?"extracted":void 0}:R.physicalTraitsSource,me=xe.extractedClothing?{...R.clothing,structured:{upperBody:xe.extractedClothing.upperBody||void 0,lowerBody:xe.extractedClothing.lowerBody||void 0,shoes:xe.extractedClothing.shoes||void 0,fullBody:xe.extractedClothing.fullBody||void 0}}:R.clothing;Ve(te=>te&&{...te,avatars:rt,physical:ie,physicalTraitsSource:Y,clothing:me}),Oe(te=>te.map(Ne=>Ne.id===R.id?{...Ne,avatars:rt,physical:ie,physicalTraitsSource:Y,clothing:me}:Ne)),f.success(`âœ… Avatars WITH TRAITS regenerated for ${R.name}`),xe.extractedTraits&&f.info(`ðŸ“‹ Extracted traits saved: ${JSON.stringify(xe.extractedTraits)}`),xe.extractedClothing&&f.info(`ðŸ‘• Extracted clothing saved: ${JSON.stringify(xe.extractedClothing)}`)}else f.error(`âŒ Failed to regenerate avatars with traits: ${xe.error}`),k(`Failed to regenerate avatars: ${xe.error||"Unknown error"}`)}catch(xe){f.error(`âŒ Failed to regenerate avatars with traits for ${R.name}:`,xe),k(`Failed to regenerate avatars: ${xe instanceof Error?xe.message:"Unknown error"}`)}finally{Nr(!1)}}},Ri=async()=>{var g,M,p,P,z,G,F,ge,le,ue,je,Ge,ct,mt,xe,rt;if(!R)return;const i={...R},b=R.id;Nr(!0);try{f.info(`ðŸ’¾ Saving character and regenerating avatars for ${i.name}...`),await gn(),f.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${i.name}...`);const ie=(await new Promise(me=>{Oe(te=>(me(te),te))})).find(me=>me.id===b);if(!ie){f.warn("Character not found in characters array after save");return}const Y=await Ye.generateClothingAvatarsWithTraits(ie);if(Y.success&&Y.avatars){const me={...Y.avatars,stale:!1,generatedAt:new Date().toISOString()},te=ie.physicalTraitsSource||{},Ne=Y.extractedTraits?{height:(g=ie.physical)==null?void 0:g.height,eyeColor:te.eyeColor==="user"?(M=ie.physical)==null?void 0:M.eyeColor:Y.extractedTraits.eyeColor,eyeColorHex:te.eyeColor==="user"?(p=ie.physical)==null?void 0:p.eyeColorHex:Y.extractedTraits.eyeColorHex,hairColor:te.hairColor==="user"?(P=ie.physical)==null?void 0:P.hairColor:Y.extractedTraits.hairColor,hairColorHex:te.hairColor==="user"?(z=ie.physical)==null?void 0:z.hairColorHex:Y.extractedTraits.hairColorHex,hairLength:te.hairLength==="user"?(G=ie.physical)==null?void 0:G.hairLength:Y.extractedTraits.hairLength,hairStyle:te.hairStyle==="user"?(F=ie.physical)==null?void 0:F.hairStyle:Y.extractedTraits.hairStyle,build:te.build==="user"?(ge=ie.physical)==null?void 0:ge.build:Y.extractedTraits.build,face:te.face==="user"?(le=ie.physical)==null?void 0:le.face:Y.extractedTraits.face,facialHair:te.facialHair==="user"?(ue=ie.physical)==null?void 0:ue.facialHair:Y.extractedTraits.facialHair,other:te.other==="user"?(je=ie.physical)==null?void 0:je.other:Y.extractedTraits.other,skinTone:te.skinTone==="user"?(Ge=ie.physical)==null?void 0:Ge.skinTone:Y.extractedTraits.skinTone,skinToneHex:te.skinTone==="user"?(ct=ie.physical)==null?void 0:ct.skinToneHex:Y.extractedTraits.skinToneHex,detailedHairAnalysis:Y.extractedTraits.detailedHairAnalysis||((mt=ie.physical)==null?void 0:mt.detailedHairAnalysis),apparentAge:te.apparentAge==="user"?(xe=ie.physical)==null?void 0:xe.apparentAge:Y.extractedTraits.apparentAge||((rt=ie.physical)==null?void 0:rt.apparentAge)}:ie.physical,Ze=Y.extractedTraits?{eyeColor:te.eyeColor==="user"?"user":Y.extractedTraits.eyeColor?"extracted":void 0,hairColor:te.hairColor==="user"?"user":Y.extractedTraits.hairColor?"extracted":void 0,hairLength:te.hairLength==="user"?"user":Y.extractedTraits.hairLength?"extracted":void 0,hairStyle:te.hairStyle==="user"?"user":Y.extractedTraits.hairStyle?"extracted":void 0,build:te.build==="user"?"user":Y.extractedTraits.build?"extracted":void 0,face:te.face==="user"?"user":Y.extractedTraits.face?"extracted":void 0,facialHair:te.facialHair==="user"?"user":Y.extractedTraits.facialHair?"extracted":void 0,other:te.other==="user"?"user":Y.extractedTraits.other?"extracted":void 0,skinTone:te.skinTone==="user"?"user":Y.extractedTraits.skinTone?"extracted":void 0,apparentAge:te.apparentAge==="user"?"user":Y.extractedTraits.apparentAge?"extracted":void 0}:ie.physicalTraitsSource,ce=Y.extractedClothing?{...ie.clothing,structured:{upperBody:Y.extractedClothing.upperBody||void 0,lowerBody:Y.extractedClothing.lowerBody||void 0,shoes:Y.extractedClothing.shoes||void 0,fullBody:Y.extractedClothing.fullBody||void 0}}:ie.clothing;Ve(bt=>bt&&bt.id===b?{...bt,avatars:me,physical:Ne,physicalTraitsSource:Ze,clothing:ce}:bt),Oe(bt=>bt.map(Ct=>Ct.id===b?{...Ct,avatars:me,physical:Ne,physicalTraitsSource:Ze,clothing:ce}:Ct)),f.success(`âœ… Avatars regenerated for ${ie.name}`);const Ke={...ie,avatars:me,physical:Ne,physicalTraitsSource:Ze,clothing:ce},nt=(await new Promise(bt=>{Oe(Ct=>(bt(Ct),Ct))})).map(bt=>bt.id===b?Ke:bt);await Ye.saveCharacterData({characters:nt,relationships:pt,relationshipTexts:Pt,customRelationships:Cr,customStrengths:[],customWeaknesses:[],customFears:[]}),f.success("ðŸ’¾ Character saved with new avatars, traits, and clothing"),T(s==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else f.error(`âŒ Failed to regenerate avatars: ${Y.error}`),k(`Failed to regenerate avatars: ${Y.error||"Unknown error"}`)}catch(ye){f.error("âŒ Failed to save and regenerate:",ye),k(`Failed: ${ye instanceof Error?ye.message:"Unknown error"}`)}finally{Nr(!1)}},Di=async()=>{var M,p,P,z,G,F,ge,le,ue,je,Ge,ct,mt,xe,rt,ye,ie,Y;if(!R)return;const i=R.id;wr(void 0),jt("traits");const b=(M=R.avatars)==null?void 0:M.status,g=!!((p=R.avatars)!=null&&p.standard||(P=R.avatars)!=null&&P.winter||(z=R.avatars)!=null&&z.summer||(G=R.avatars)!=null&&G.hasFullAvatars);if(b==="generating"||b==="complete"&&g){f.info(`â­ï¸ Skipping avatar generation - already ${b}${g?" with avatars":""}`);return}St(i),Ve(me=>me&&me.id===i?{...me,avatars:{status:"generating"}}:me),f.info(`ðŸŽ¨ Starting avatar generation for ${R.name||"unnamed"} (id: ${i})...`);try{const me=await Ye.generateClothingAvatarsWithTraits(R);if(me.success&&me.avatars){const te={...me.avatars,stale:!1,generatedAt:new Date().toISOString()},Ne=me.extractedTraits?{...R.physical,build:me.extractedTraits.build||((F=R.physical)==null?void 0:F.build),eyeColor:me.extractedTraits.eyeColor||((ge=R.physical)==null?void 0:ge.eyeColor),eyeColorHex:me.extractedTraits.eyeColorHex||((le=R.physical)==null?void 0:le.eyeColorHex),hairColor:me.extractedTraits.hairColor||((ue=R.physical)==null?void 0:ue.hairColor),hairColorHex:me.extractedTraits.hairColorHex||((je=R.physical)==null?void 0:je.hairColorHex),hairLength:me.extractedTraits.hairLength||((Ge=R.physical)==null?void 0:Ge.hairLength),hairStyle:me.extractedTraits.hairStyle||((ct=R.physical)==null?void 0:ct.hairStyle),facialHair:me.extractedTraits.facialHair||((mt=R.physical)==null?void 0:mt.facialHair),skinTone:me.extractedTraits.skinTone||((xe=R.physical)==null?void 0:xe.skinTone),skinToneHex:me.extractedTraits.skinToneHex||((rt=R.physical)==null?void 0:rt.skinToneHex),face:me.extractedTraits.face||((ye=R.physical)==null?void 0:ye.face),other:me.extractedTraits.other||((ie=R.physical)==null?void 0:ie.other),detailedHairAnalysis:me.extractedTraits.detailedHairAnalysis||((Y=R.physical)==null?void 0:Y.detailedHairAnalysis)}:R.physical,Ze=me.extractedClothing?{...R.clothing,structured:{upperBody:me.extractedClothing.upperBody||void 0,lowerBody:me.extractedClothing.lowerBody||void 0,shoes:me.extractedClothing.shoes||void 0,fullBody:me.extractedClothing.fullBody||void 0}}:R.clothing;Oe(ce=>ce.map(Ke=>Ke.id===i?{...Ke,avatars:te,physical:Ne,clothing:Ze}:Ke)),Ve(ce=>ce&&ce.id===i?{...ce,avatars:te,physical:Ne,clothing:Ze}:ce),f.success(`âœ… Avatar generated for ${R.name} (id: ${i})`)}else f.error(`âŒ Failed to generate avatar: ${me.error}`),k(`Failed to generate avatar: ${me.error||"Unknown error"}`),Oe(te=>te.map(Ne=>Ne.id===i?{...Ne,avatars:{status:"failed"}}:Ne)),Ve(te=>te&&te.id===i?{...te,avatars:{status:"failed"}}:te)}catch(me){f.error("âŒ Avatar generation failed:",me),k(`Avatar generation failed: ${me instanceof Error?me.message:"Unknown error"}`),Oe(te=>te.map(Ne=>Ne.id===i?{...Ne,avatars:{status:"failed"}}:Ne)),Ve(te=>te&&te.id===i?{...te,avatars:{status:"failed"}}:te)}finally{St(null)}},gn=async()=>{var i;if(R){_(!0);try{const b=yt.current,g=Ms.current;if(!b){f.warn("No current character to save");return}const M=b.id&&g.find(G=>G.id===b.id),p=M?g.map(G=>G.id===b.id?b:G):[...g,b];f.info("Saving characters with relationships:",p.length);const P=!M&&!!((i=b.photos)!=null&&i.original);await Ye.saveCharacterData({characters:p,relationships:pt,relationshipTexts:Pt,customRelationships:Cr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:P}),Lr.current=!1,f.success("Character data saved successfully"),Oe(p),cn(p);const z=p.find(G=>G.id===R.id);z&&Ye.needsAvatars(z)&&Qr!==z.id&&(f.info(`ðŸŽ¨ Starting background avatar generation for ${z.name}...`),Ye.generateAndSaveAvatarForCharacter(z,void 0,{avatarModel:xt.avatarModel||void 0}).then(G=>{G.success&&G.character?(Oe(F=>F.map(ge=>ge.id===z.id?{...ge,avatars:G.character.avatars,physical:G.character.physical,clothing:G.character.clothing}:ge)),f.success(`âœ… Avatars and traits saved for ${z.name}`)):G.skipped||(f.warn(`Avatar generation failed for ${z.name}: ${G.error}`),Oe(F=>F.map(ge=>ge.id===z.id?{...ge,avatars:{status:"failed"}}:ge)))}).catch(G=>{f.error(`âŒ Background avatar generation error for ${z.name}:`,G),Oe(F=>F.map(ge=>ge.id===z.id?{...ge,avatars:{status:"failed"}}:ge))})),Ve(null),Kt(!0)}catch(b){f.error("Failed to save character:",b),k(s==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de l'enregistrement du personnage. Veuillez rÃ©essayer.":"Failed to save character. Please try again.")}finally{_(!1)}}},Fi=async i=>{Ve({...i}),jt("traits"),Kt(!1);const b=await Ye.loadFullCharacter(i.id);b&&(Ve(g=>g&&g.id===i.id?{...g,...b}:g),Oe(g=>g.map(M=>M.id===i.id?{...M,...b}:M)))},Ei=async i=>{try{const b=await Ye.deleteCharacter(i);b.success?(Oe(g=>g.filter(M=>M.id!==i)),ps(g=>{const M={...g};return Object.keys(M).forEach(p=>{(p.includes(`${i}-`)||p.includes(`-${i}`))&&delete M[p]}),M}),fs(g=>{const M={...g};return Object.keys(M).forEach(p=>{(p.includes(`${i}-`)||p.includes(`-${i}`))&&delete M[p]}),M}),dr(g=>g.filter(M=>M!==i)),bs.current=!0,f.success(`Character ${i} deleted`)):(f.error("Failed to delete character:",b.error),k(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character"))}catch(b){f.error("Failed to delete character:",b),k(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character")}},zi=(i,b,g)=>{const p=Xo(g,s),P=`${i}-${b}`,z=`${b}-${i}`;f.debug("Updating relationship:",P,"=",g,", inverse:",z,"=",p),Lr.current=!0,ps(G=>({...G,[P]:g,[z]:p}))},Bi=(i,b)=>{Lr.current=!0;const[g,M]=i.split("-").map(Number),p=`${M}-${g}`;fs(P=>({...P,[i]:b,[p]:b}))},Mi=(i,b)=>{Lr.current=!0,ya(g=>[...g,{forward:i,inverse:b}])},Oi=(i,b)=>{b==="out"?(Gr(g=>g.includes(i)?g:[...g,i]),dr(g=>g.filter(M=>M!==i))):b==="in"?(Gr(g=>g.filter(M=>M!==i)),dr(g=>g.filter(M=>M!==i))):b==="main"&&(Gr(g=>g.filter(M=>M!==i)),dr(g=>g.includes(i)?g:[...g,i])),bs.current=!0,Oe(g=>g.map(M=>M.id===i?{...M,storyRole:b}:M))},Li=async()=>{const[i,b,g]=await Promise.all([new Promise(p=>{Oe(P=>(p(P),P))}),new Promise(p=>{dr(P=>(p(P),P))}),new Promise(p=>{Gr(P=>(p(P),P))})]);if(i.length===0)return;if(!bs.current){f.debug("Roles not modified, skipping save");return}const M={};for(const p of i)b.includes(p.id)?M[p.id]="main":g.includes(p.id)?M[p.id]="out":M[p.id]="in";try{await Ye.saveCharacterRoles(M),bs.current=!1}catch(p){f.error("Failed to save character roles:",p)}},oa=n.useRef(null),zr=async i=>{i>=0&&i<=7&&(L===1&&R&&i!==1&&await gn(),L===1&&i!==1&&(oa.current=(async()=>{await _i(),await Li()})(),oa.current.catch(b=>f.error("Background save failed:",b))),i===1&&L!==1&&Ve(null),de(i),window.scrollTo(0,0))},Gi=i=>i===1?!0:i===2||i===3?Fe.length>0:i===4?Fe.length>0&&He!=="":i===5?Fe.length>0&&He!==""&&It!=="":i===6?Dr!=="":!1,ns=()=>L===1?Fe.length>0&&Qt.length>0:L===2?!0:L===3?!(!He||He==="adventure"&&!We||(He==="life-challenge"||He==="educational")&&!st||He==="historical"&&!st||He==="custom"&&!(Dt!=null&&Dt.trim())):L===4?It!=="":L===5?Fe.filter(b=>!Nt.includes(b.id)).length>0&&Qt.length>0&&Ar.trim().length>0:!1,_i=async()=>{const i=await new Promise(b=>{Oe(g=>(b(g),g))});if(i.length!==0){if(!Lr.current){f.debug("Relationships not modified, skipping save");return}try{f.debug("Auto-saving character data with latest state..."),await Ye.saveCharacterData({characters:i,relationships:pt,relationshipTexts:Pt,customRelationships:Cr,customStrengths:[],customWeaknesses:[],customFears:[]}),Lr.current=!1,f.debug("Character data auto-saved")}catch(b){f.error("Failed to auto-save character data:",b)}}},Hi=async()=>{if(L<5&&ns()){if(L===1&&Fe.length===1){ee(!0);return}await zr(L+1)}},Fn=async()=>{L>0&&await zr(L-1)},Wi=(i,b)=>{cr(i),rs(b??null)},En=async()=>{gr.current&&gr.current.abort(),mr(!0),Yt(!0),Xr(!0),Xt([]),Us(null),ts(""),rs(null);const i=Fe.filter(b=>!Nt.includes(b.id));Na({storyType:Rt,storyCategory:He||"",storyTopic:st||"",storyTheme:We||"",characters:i.map(b=>({id:b.id,name:b.name})),language:Et,languageLevel:Gt,pages:At,userLocation:hr||void 0,season:xr||void 0}),gr.current=Le.generateStoryIdeasStream({storyType:Rt,storyTypeName:la(),storyCategory:He||void 0,storyTopic:st||void 0,storyTheme:We||void 0,customThemeText:We==="custom"?Dt:void 0,language:Et,languageLevel:Gt,pages:At,characters:i.map(b=>({name:b.name,age:b.age,gender:b.gender,traits:b.traits,isMain:Qt.includes(b.id)})),relationships:Object.entries(pt).map(([b,g])=>{const[M,p]=b.split("-").map(Number),P=i.find(G=>G.id===M),z=i.find(G=>G.id===p);return{character1:(P==null?void 0:P.name)||"",character2:(z==null?void 0:z.name)||"",relationship:g}}).filter(b=>b.character1&&b.character2),ideaModel:(h==null?void 0:h.role)==="admin"||S?xt.ideaModel:void 0,userLocation:hr||void 0,season:xr},{onStatus:(b,g,M)=>{g&&M&&Us({prompt:g,model:M})},onStory1:b=>{Xt(g=>{const M=[...g];return M[0]=b,M}),ur(100),Yt(!1)},onStory2:b=>{Xt(g=>{const M=[...g];return M[1]=b,M}),ja(100),Xr(!1)},onError:b=>{f.error("Failed to generate story ideas:",b),k(s==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":s==="fr"?"Erreur lors de la gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Failed to generate ideas. Please try again."),mr(!1),Yt(!1),Xr(!1)},onDone:b=>{mr(!1),Yt(!1),Xr(!1),b&&ts(b),gr.current=null,f.info("[IDEAS] onDone complete")}})},la=()=>{const i=yn.find(b=>b.id===Rt);return i?i.name[s]:Rt},is=async i=>{var g,M,p,P,z,G,F,ge,le,ue,je,Ge,ct,mt,xe,rt;if(console.log("[generateStory] Called with overrides:",i),console.log("[generateStory] user:",h==null?void 0:h.email,"emailVerified:",h==null?void 0:h.emailVerified,"isImpersonating:",S),oa.current&&(await oa.current,oa.current=null),!(i!=null&&i.skipEmailCheck)&&!S&&h&&h.emailVerified!==!0){await $();const ye=localStorage.getItem("currentUser");let ie=h.emailVerified;if(ye)try{ie=JSON.parse(ye).emailVerified}catch{}if(ie===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",Rt),localStorage.setItem("pending_art_style",It),vt(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),Rr(!0),c(!1),de(6),nn({storyCategory:He||void 0,storyTopic:st||void 0,storyTheme:We||void 0,storyTypeName:la(),storyDetails:Ar||void 0,artStyle:It||void 0,language:Et||void 0,languageLevel:Gt||void 0,pages:At||void 0,dedication:Pr||void 0,characters:Fe.filter(ye=>!Nt.includes(ye.id)).map(ye=>({id:ye.id,name:ye.name})),mainCharacters:Qt,relationships:pt,relationshipTexts:Pt,season:xr||void 0,userLocation:hr||void 0}),Hr(""),tr(""),wt([]),Er([]),Oa(null),La({}),ze({frontCover:null,initialPage:null,backCover:null});const b=Fe.filter(ye=>!Nt.includes(ye.id)).filter(ye=>!ye.avatars||ye.avatars.stale||ye.avatars.status!=="complete");if(b.length>0){console.log("[generateStory] Characters needing avatar regeneration:",b.map(ye=>ye.name)),fe({current:1,total:100,message:s==="de"?`Aktualisiere Avatare fÃ¼r ${b.length} Charakter(e)...`:s==="fr"?`Mise Ã  jour des avatars pour ${b.length} personnage(s)...`:`Updating avatars for ${b.length} character(s)...`});for(let ye=0;ye<b.length;ye++){const ie=b[ye];try{console.log(`[generateStory] Regenerating avatars for ${ie.name} (${ye+1}/${b.length})`),fe({current:2,total:100,message:s==="de"?`Generiere Avatare fÃ¼r ${ie.name}...`:s==="fr"?`GÃ©nÃ©ration des avatars pour ${ie.name}...`:`Generating avatars for ${ie.name}...`});const Y=await Ye.generateClothingAvatarsWithTraits(ie);if(Y.success&&Y.avatars){const me={...Y.avatars,stale:!1,generatedAt:new Date().toISOString()},te=ie.physicalTraitsSource||{},Ne=Y.extractedTraits?{...ie.physical,height:(g=ie.physical)==null?void 0:g.height,build:te.build==="user"?(M=ie.physical)==null?void 0:M.build:Y.extractedTraits.build,eyeColor:te.eyeColor==="user"?(p=ie.physical)==null?void 0:p.eyeColor:Y.extractedTraits.eyeColor,eyeColorHex:te.eyeColor==="user"?(P=ie.physical)==null?void 0:P.eyeColorHex:Y.extractedTraits.eyeColorHex,hairColor:te.hairColor==="user"?(z=ie.physical)==null?void 0:z.hairColor:Y.extractedTraits.hairColor,hairColorHex:te.hairColor==="user"?(G=ie.physical)==null?void 0:G.hairColorHex:Y.extractedTraits.hairColorHex,hairLength:te.hairLength==="user"?(F=ie.physical)==null?void 0:F.hairLength:Y.extractedTraits.hairLength,hairStyle:te.hairStyle==="user"?(ge=ie.physical)==null?void 0:ge.hairStyle:Y.extractedTraits.hairStyle,facialHair:te.facialHair==="user"?(le=ie.physical)==null?void 0:le.facialHair:Y.extractedTraits.facialHair,skinTone:te.skinTone==="user"?(ue=ie.physical)==null?void 0:ue.skinTone:Y.extractedTraits.skinTone,skinToneHex:te.skinTone==="user"?(je=ie.physical)==null?void 0:je.skinToneHex:Y.extractedTraits.skinToneHex,face:te.face==="user"?(Ge=ie.physical)==null?void 0:Ge.face:Y.extractedTraits.face,other:te.other==="user"?(ct=ie.physical)==null?void 0:ct.other:Y.extractedTraits.other,detailedHairAnalysis:Y.extractedTraits.detailedHairAnalysis||((mt=ie.physical)==null?void 0:mt.detailedHairAnalysis),apparentAge:te.apparentAge==="user"?(xe=ie.physical)==null?void 0:xe.apparentAge:Y.extractedTraits.apparentAge||((rt=ie.physical)==null?void 0:rt.apparentAge)}:ie.physical,Ze=Y.extractedTraits?{...te,build:te.build==="user"?"user":Y.extractedTraits.build?"extracted":void 0,eyeColor:te.eyeColor==="user"?"user":Y.extractedTraits.eyeColor?"extracted":void 0,hairColor:te.hairColor==="user"?"user":Y.extractedTraits.hairColor?"extracted":void 0,hairLength:te.hairLength==="user"?"user":Y.extractedTraits.hairLength?"extracted":void 0,hairStyle:te.hairStyle==="user"?"user":Y.extractedTraits.hairStyle?"extracted":void 0,face:te.face==="user"?"user":Y.extractedTraits.face?"extracted":void 0,facialHair:te.facialHair==="user"?"user":Y.extractedTraits.facialHair?"extracted":void 0,other:te.other==="user"?"user":Y.extractedTraits.other?"extracted":void 0,skinTone:te.skinTone==="user"?"user":Y.extractedTraits.skinTone?"extracted":void 0,apparentAge:te.apparentAge==="user"?"user":Y.extractedTraits.apparentAge?"extracted":void 0}:ie.physicalTraitsSource,ce=Y.extractedClothing?{...ie.clothing,structured:{upperBody:Y.extractedClothing.upperBody||void 0,lowerBody:Y.extractedClothing.lowerBody||void 0,shoes:Y.extractedClothing.shoes||void 0,fullBody:Y.extractedClothing.fullBody||void 0}}:ie.clothing;Oe(Ke=>Ke.map(Re=>Re.id===ie.id?{...Re,avatars:me,physical:Ne,physicalTraitsSource:Ze,clothing:ce}:Re)),Ve(Ke=>Ke&&Ke.id===ie.id?{...Ke,avatars:me,physical:Ne,physicalTraitsSource:Ze,clothing:ce}:Ke),Oe(Ke=>{const Re=Ke.map(nt=>nt.id===ie.id?{...nt,avatars:me,physical:Ne,physicalTraitsSource:Ze,clothing:ce}:nt);return Ye.saveCharacterData({characters:Re,relationships:pt,relationshipTexts:Pt,customRelationships:Cr,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(nt=>console.error("Failed to save avatar update:",nt)),Re}),console.log(`[generateStory] âœ… Avatars regenerated for ${ie.name}`)}else console.warn(`[generateStory] âš ï¸ Failed to regenerate avatars for ${ie.name}: ${Y.error}`)}catch(Y){console.error(`[generateStory] âŒ Error regenerating avatars for ${ie.name}:`,Y)}}}fe({current:5,total:100,message:s==="de"?"Starte Generierung...":s==="fr"?"DÃ©marrage de la gÃ©nÃ©ration...":"Starting generation..."});try{const ye=Fe.filter(ce=>!Nt.includes(ce.id)),{jobId:ie,creditsRemaining:Y}=await Le.createStoryJob({storyType:Rt,storyTypeName:la(),storyCategory:He||void 0,storyTopic:st||void 0,storyTheme:We||void 0,customThemeText:We==="custom"?Dt:void 0,artStyle:It,language:Et,languageLevel:Gt,pages:At,dedication:Pr,storyDetails:Ar,characters:ye,mainCharacters:Qt,relationships:pt,relationshipTexts:Pt,skipImages:(i==null?void 0:i.skipImages)??oe,imageGenMode:Te,generationMode:Se!=="auto"?Se:void 0,skipOutline:X,skipText:E,skipSceneDescriptions:pe,skipCovers:De,enableAutoRepair:Ie,useGridRepair:q,forceRepairThreshold:ve,enableFinalChecks:Ae,checkOnlyMode:Me,enableSceneValidation:$t,separatedEvaluation:nr,incrementalConsistency:Xe?{enabled:!0,dryRun:ot,lookbackCount:Pe}:void 0,modelOverrides:(h==null?void 0:h.role)==="admin"||S?{outlineModel:xt.outlineModel,textModel:xt.textModel,sceneDescriptionModel:xt.sceneDescriptionModel,imageModel:xt.imageModel,coverImageModel:xt.coverImageModel,qualityModel:xt.qualityModel}:void 0,userLocation:hr||void 0,season:xr||void 0,ideaGeneration:Ks&&es&&zt.length>0?{input:Ks,output:zt,rawResponse:Tr,prompt:es.prompt,model:es.model,selectedIndex:Ns}:void 0});fr(ie),f.info("Story job created:",ie),C(ie,la()||"New Story"),Y!=null&&N(Y);let me=!1,te=0,Ne=Date.now();const Ze=180*1e3;for(Ht(!1);!me;){await new Promise(Ke=>setTimeout(Ke,2e3));const ce=await Le.getJobStatus(ie);if(ce.progress&&(ce.progress.current!==te?(f.debug(`Progress: ${ce.progress.current}% - ${ce.progress.message||""}`),te=ce.progress.current,Ne=Date.now(),Ht(!1)):Date.now()-Ne>=Ze&&Ht(!0),fe(Ke=>ce.progress.current>=Ke.current?ce.progress:ce.progress.message?{...Ke,message:ce.progress.message}:Ke)),ce.partialCovers){let Ke=!1;ze(Re=>{var bt,Ct,Va;const nt={...Re};if((bt=ce.partialCovers)!=null&&bt.frontCover&&!Re.frontCover){nt.frontCover=ce.partialCovers.frontCover,f.debug("Front cover received during streaming");const rr=ce.partialCovers.frontCover;typeof rr=="object"&&(rr!=null&&rr.storyTitle)&&(tr(rr.storyTitle),f.debug(`Story title from front cover: ${rr.storyTitle}`)),Ke=!0}return(Ct=ce.partialCovers)!=null&&Ct.initialPage&&!Re.initialPage&&(nt.initialPage=ce.partialCovers.initialPage,f.debug("Initial page cover received during streaming")),(Va=ce.partialCovers)!=null&&Va.backCover&&!Re.backCover&&(nt.backCover=ce.partialCovers.backCover,f.debug("Back cover received during streaming")),nt}),Ke&&(f.debug("Transitioning to StoryDisplay - front cover ready"),de(6))}if(ce.storyText&&!Ot&&(Oa(ce.storyText),tr(ce.storyText.title),f.debug(`Story text received: ${ce.storyText.totalPages} pages ready for display`)),ce.partialPages&&ce.partialPages.length>0&&La(Ke=>{var bt;const Re={...Ke};let nt=0;return(bt=ce.partialPages)==null||bt.forEach(Ct=>{Ct.imageData&&!Ke[Ct.pageNumber]&&(Re[Ct.pageNumber]=Ct.imageData,nt++)}),nt>0&&f.debug(`${nt} new page images received (total: ${Object.keys(Re).length})`),Re}),console.log("[StoryWizard] Job status check:",{status:ce.status,hasResult:!!ce.result,resultKeys:ce.result?Object.keys(ce.result):[],progress:ce.progress}),ce.status==="completed"&&ce.result)Mt(ce.result.storyId),tr(ce.result.title),Ys(ce.result.outline),Xs(ce.result.outlinePrompt||""),ea(ce.result.outlineModelId),ta(ce.result.outlineUsage),ra(ce.result.storyTextPrompts||[]),Ss(ce.result.styledAvatarGeneration||[]),Cs(ce.result.costumedAvatarGeneration||[]),ks(ce.result.generationLog||[]),Ps(ce.result.finalChecksReport||null),ce.result.visualBible?Fr({mainCharacters:ce.result.visualBible.mainCharacters||[],secondaryCharacters:ce.result.visualBible.secondaryCharacters||[],animals:ce.result.visualBible.animals||[],artifacts:ce.result.visualBible.artifacts||[],locations:ce.result.visualBible.locations||[],vehicles:ce.result.visualBible.vehicles||[],clothing:ce.result.visualBible.clothing||[],changeLog:ce.result.visualBible.changeLog||[]}):Fr(null),ce.result.clothingRequirements?as(ce.result.clothingRequirements):as(null),Hr(ce.result.story),Qs(ce.result.story),Er(ce.result.sceneDescriptions||[]),wt(ce.result.sceneImages||[]),ze(ce.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),Oa(null),La({}),me=!0,ce.currentCredits!==null&&ce.currentCredits!==void 0&&N(ce.currentCredits),de(6),f.success("Story generation completed!"),nn({storyCategory:He||void 0,storyTopic:st||void 0,storyTheme:We||void 0,storyTypeName:la(),storyDetails:Ar||void 0,artStyle:It||void 0,language:Et||void 0,languageLevel:Gt||void 0,pages:At||void 0,dedication:Pr||void 0,characters:Fe.map(Ke=>({id:Ke.id,name:Ke.name})),mainCharacters:Qt,relationships:pt,relationshipTexts:Pt,season:xr||void 0,userLocation:hr||void 0}),on.current=!0,Zr&&bi(ce.result.storyId),y();else if(ce.status==="failed")throw new Error(ce.error||"Story generation failed")}fe({current:100,total:100,message:s==="de"?"Fertig!":s==="fr"?"TerminÃ©!":"Complete!"})}catch(ye){f.error("Generation failed:",ye);const ie=ye instanceof Error?ye.message:String(ye);if(ie.includes("already in progress")){const Y=ie.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),me=Y?Y[1]:null,te=s==="de"?"Eine Geschichte wird bereits erstellt. MÃ¶chtest du diese abbrechen und eine neue starten?":s==="fr"?"Une histoire est dÃ©jÃ  en cours de crÃ©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(me&&window.confirm(te))try{await Le.cancelJob(me),f.info("Cancelled existing job:",me),await is(i);return}catch(Ne){f.error("Failed to cancel existing job:",Ne),k(s==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es spÃ¤ter erneut.":s==="fr"?"Ã‰chec de l'annulation. Veuillez rÃ©essayer plus tard.":"Failed to cancel. Please try again later.")}Rr(!1);return}else k(s==="de"?`Generierung fehlgeschlagen: ${ie}`:s==="fr"?`Ã‰chec de la gÃ©nÃ©ration: ${ie}`:`Generation failed: ${ie}`)}finally{Ht(!1),y(),setTimeout(()=>Rr(!1),500)}};n.useEffect(()=>{if(Wa.current&&D&&Fe.length>0&&L===5&&!_t){Wa.current=!1;const i=localStorage.getItem("verificationGenerationStarted");if(i){const g=parseInt(i,10),M=Date.now()-120*1e3;if(g>M){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await $(),setTimeout(()=>{is({skipEmailCheck:!0})},500)})()}},[D,Fe,L,_t,$]);const Vi=()=>{switch(L){case 1:return e.jsx(ll,{characters:Fe,currentCharacter:R,characterStep:fa,showCharacterCreated:pa,isLoading:w,isAnalyzingPhoto:ut,isGeneratingAvatar:Qr===(R==null?void 0:R.id),isRegeneratingAvatars:gs,isRegeneratingAvatarsWithTraits:hs,developerMode:Z,isImpersonating:S,changedTraits:sn,photoAnalysisDebug:ba,mainCharacters:Qt,excludedCharacters:Nt,onCharacterRoleChange:Oi,onCharacterChange:Ve,onCharacterStepChange:jt,onContinueToAvatar:()=>jt("avatar"),onPhotoSelect:Pi,onSaveAndGenerateAvatar:Di,onSaveCharacter:gn,onEditCharacter:Fi,onDeleteCharacter:Ei,onStartNewCharacter:un,onRegenerateAvatars:Ii,onRegenerateAvatarsWithTraits:Ti,onSaveAndRegenerateWithTraits:Ri,onSaveAndTryNewPhoto:async()=>{var g;if(f.info(`ðŸ“¸ onSaveAndTryNewPhoto called, currentCharacter: ${R==null?void 0:R.name}`),!R){f.warn("ðŸ“¸ No currentCharacter, returning early");return}_(!0);try{const M=R.id&&Fe.find(z=>z.id===R.id),p=M?Fe.map(z=>z.id===R.id?R:z):[...Fe,R],P=!M&&!!((g=R.photos)!=null&&g.original);await Ye.saveCharacterData({characters:p,relationships:pt,relationshipTexts:Pt,customRelationships:Cr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:P}),Oe(p),cn(p),f.info(`ðŸ“¸ Setting characterStep to 'photo', currentCharacter still: ${R==null?void 0:R.name}`),jt("photo")}catch(M){f.error("ðŸ“¸ Error saving character:",M)}finally{_(!1),f.info("ðŸ“¸ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:pt,relationshipTexts:Pt,onRelationshipChange:zi,onRelationshipTextChange:Bi,customRelationships:Cr,onAddCustomRelationship:Mi});case 2:return e.jsx(dl,{languageLevel:Gt,onLanguageLevelChange:ys,pages:At,onPagesChange:Vs,storyLanguage:Et,onStoryLanguageChange:kr,developerMode:Z,userLocation:hr,onLocationChange:Js,season:xr,onSeasonChange:wa,userCredits:S?-1:(h==null?void 0:h.credits)??0});case 3:return e.jsx(cl,{storyCategory:He,storyTopic:st,storyTheme:We,customThemeText:Dt,onCategoryChange:vi,onTopicChange:Ni,onThemeChange:ji,onCustomThemeTextChange:Ft,onLegacyStoryTypeChange:or});case 4:return e.jsx(ml,{artStyle:It,onArtStyleChange:wi});case 5:return e.jsx(ul,{characters:Fe,mainCharacters:Qt,excludedCharacters:Nt,storyCategory:He,storyTopic:st,storyTheme:We,customThemeText:Dt,onCustomThemeTextChange:Ft,artStyle:It,storyLanguage:Et,languageLevel:Gt,pages:At,userLocation:hr,season:xr,storyDetails:Ar,onStoryDetailsChange:cr,dedication:Pr,onDedicationChange:vs,onGenerateIdeas:En,isGeneratingIdeas:$r,isGeneratingIdea1:Ir,isGeneratingIdea2:qs,ideaProgress1:_r,ideaProgress2:js,ideaPrompt:es,ideaFullResponse:Tr,generatedIdeas:zt,onSelectIdea:Wi,onUseDirectly:()=>is(),onEditStep:zr,developerMode:Z,imageGenMode:Te,onImageGenModeChange:B,generationMode:Se,onGenerationModeChange:W});case 6:const i=U.frontCover||U.initialPage||Object.keys(ln).length>0||As.some(g=>g.imageData);if(Dr&&i||Ot&&i||_t&&i){const g=Dr?As:Object.entries(ln).map(([p,P])=>{var z;return{pageNumber:parseInt(p),imageData:P,description:((z=Ot==null?void 0:Ot.sceneDescriptions.find(G=>G.pageNumber===parseInt(p)))==null?void 0:z.description)||""}}),M=Dr||Object.entries((Ot==null?void 0:Ot.pageTexts)||{}).sort(([p],[P])=>parseInt(p)-parseInt(P)).map(([p,P])=>`--- Page ${p} ---
${P}`).join(`

`);return e.jsxs(e.Fragment,{children:[at&&at.total>0&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${at.loaded/at.total*100}%`}})}),e.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:s==="de"?`Bilder: ${at.loaded}/${at.total}`:s==="fr"?`Images: ${at.loaded}/${at.total}`:`Images: ${at.loaded}/${at.total}`})]}),Z&&re&&!_t&&e.jsx(Uo,{storyId:re,sceneImages:g,characters:Fe.filter(p=>!Nt.includes(p.id)),finalChecksReport:sa,imageModel:xt.imageModel||void 0,onImageUpdate:(p,P,z)=>{wt(G=>G.map(F=>F.pageNumber===p?{...F,imageData:P,imageVersions:[...F.imageVersions||[],{imageData:P,createdAt:new Date().toISOString(),isActive:!0,type:"repair"}].map((ge,le,ue)=>({...ge,isActive:le===ue.length-1}))}:F))},onRefreshStory:re?async()=>{try{f.info("Refreshing story data after repair...");const p=await Le.getStory(re);p&&(wt(p.sceneImages||[]),Ps(p.finalChecksReport||null),f.success("Story data refreshed"))}catch(p){f.error("Failed to refresh story:",p)}}:void 0,autoRunFullWorkflow:fi===re}),e.jsx(Oo,{title:ws,dedication:Pr||void 0,story:M,originalStory:ka,outline:Pa,outlinePrompt:Aa,outlineModelId:$a,outlineUsage:Ia,storyTextPrompts:Ta,visualBible:Ra||void 0,sceneImages:g,sceneDescriptions:(Ot==null?void 0:Ot.sceneDescriptions)||Ba,characters:xa||Fe.filter(p=>!Nt.includes(p.id)),progressiveMode:_t,progressiveData:Ot||void 0,completedPageImages:ln,coverImages:U,regeneratingCovers:Sa,languageLevel:Gt,storyLanguage:Et,isGenerating:_t,developerMode:Z,styledAvatarGeneration:Fa,costumedAvatarGeneration:Ea,generationLog:za,finalChecksReport:sa,clothingRequirements:Da||void 0,storyId:re,onVisualBibleChange:re?async p=>{try{f.info("Updating Visual Bible for story:",re),await Le.updateVisualBible(re,p),Fr(p),f.success("Visual Bible updated successfully")}catch(P){f.error("Failed to update Visual Bible:",P),k(s==="de"?"Visual Bible konnte nicht aktualisiert werden":s==="fr"?"Ã‰chec de la mise Ã  jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:re?async(p,P,z)=>{var G;try{f.info("Regenerating image for page:",p,P?"(scene edited)":"",z?`(${z.length} characters)`:"");const F=await Le.regenerateImage(re,p,P,z);if(f.info("Regenerate result:",{hasImageData:!!(F!=null&&F.imageData),length:(G=F==null?void 0:F.imageData)==null?void 0:G.length,versionCount:F==null?void 0:F.versionCount,creditsRemaining:F==null?void 0:F.creditsRemaining}),!(F!=null&&F.imageData))throw f.error("No imageData in response!",F),new Error("No image data returned from server");wt(ge=>ge.map(le=>le.pageNumber===p?{...le,imageData:F.imageData,description:F.newDescription||le.description,prompt:F.newPrompt,qualityScore:F.qualityScore,qualityReasoning:F.qualityReasoning,totalAttempts:F.totalAttempts,retryHistory:F.retryHistory,wasRegenerated:!0,originalImage:F.originalImage,originalScore:F.originalScore,originalReasoning:F.originalReasoning,imageVersions:F.imageVersions,referencePhotos:F.referencePhotos||le.referencePhotos,landmarkPhotos:F.landmarkPhotos||le.landmarkPhotos,visualBibleGrid:F.visualBibleGrid||le.visualBibleGrid}:le)),F.creditsRemaining!==void 0&&N&&N(F.creditsRemaining),f.info("Image regenerated successfully, updated state")}catch(F){f.error("Image regeneration failed:",F);const ge=F instanceof Error?F.message:String(F);k(s==="de"?`Bildgenerierung fehlgeschlagen: ${ge}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${ge}`:`Image regeneration failed: ${ge}`)}}:void 0,onDownloadTxt:()=>{const p=new Blob([Dr],{type:"text/plain"}),P=URL.createObjectURL(p),z=document.createElement("a");z.href=P,z.download=`${ws}.txt`,z.click(),URL.revokeObjectURL(P)},onDownloadPdf:re?async p=>{try{const P=await Le.generatePdf(re,p),z=URL.createObjectURL(P),G=document.createElement("a");G.href=z,G.download=`${ws}.pdf`,G.click(),URL.revokeObjectURL(z)}catch(P){f.error("PDF download failed:",P),k(s==="de"?"PDF-Download fehlgeschlagen":s==="fr"?"Ã‰chec du tÃ©lÃ©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:re?()=>{try{const p=sessionStorage.getItem("mystories_selected"),P=p?JSON.parse(p):[];P.includes(re)||(P.push(re),sessionStorage.setItem("mystories_selected",JSON.stringify(P))),f.info("Added story to book selection:",re),T(s==="de"?"Geschichte zum Buch hinzugefÃ¼gt. Du kannst weitere hinzufÃ¼gen oder das Buch bestellen.":s==="fr"?"Histoire ajoutÃ©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",s==="de"?"Zum Buch hinzugefÃ¼gt":s==="fr"?"AjoutÃ© au livre":"Added to Book"),r("/stories")}catch(p){f.error("Failed to add story to selection:",p)}}:void 0,onPrintBook:re?async()=>{let p=await jo.getShippingAddress();if(!p){const G=prompt(s==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":s==="fr"?"Aucune adresse enregistrÃ©e. Veuillez entrer (Format: PrÃ©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!G)return;const F=G.split(",").map(ge=>ge.trim());if(F.length<7){k(s==="de"?"UngÃ¼ltiges Adressformat":s==="fr"?"Format d'adresse invalide":"Invalid address format");return}p={firstName:F[0],lastName:F[1],addressLine1:F[2],postCode:F[3],city:F[4],country:F[5],email:F[6]}}const P=`${p.firstName} ${p.lastName}
${p.addressLine1}
${p.postCode} ${p.city}
${p.country}`,z=s==="de"?`Druckauftrag an folgende Adresse senden?

${P}`:s==="fr"?`Envoyer la commande Ã  cette adresse?

${P}`:`Send print order to this address?

${P}`;if(confirm(z))try{f.info("Creating print order for story:",re);const G=await Le.createPrintOrder(re,{firstName:p.firstName,lastName:p.lastName,addressLine1:p.addressLine1,city:p.city,postCode:p.postCode,country:p.country,email:p.email||""}),F=s==="de"?`âœ… Druckauftrag erfolgreich erstellt!

Order ID: ${G.orderId}
${G.isDraft?"(Entwurf - muss in Gelato bestÃ¤tigt werden)":""}

MÃ¶chten Sie das Gelato Dashboard Ã¶ffnen, um den Auftrag zu verfolgen?`:s==="fr"?`âœ… Commande d'impression crÃ©Ã©e avec succÃ¨s!

ID de commande: ${G.orderId}
${G.isDraft?"(Brouillon - doit Ãªtre confirmÃ© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`âœ… Print order created successfully!

Order ID: ${G.orderId}
${G.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;G.dashboardUrl&&confirm(F)?window.open(G.dashboardUrl,"_blank"):G.dashboardUrl||T(s==="de"?`Druckauftrag erstellt! Order ID: ${G.orderId}`:s==="fr"?`Commande crÃ©Ã©e! ID: ${G.orderId}`:`Print order created! Order ID: ${G.orderId}`)}catch(G){f.error("Print order failed:",G);const F=G instanceof Error?G.message:String(G);k(s==="de"?`Druckauftrag fehlgeschlagen: ${F}`:s==="fr"?`Ã‰chec de la commande d'impression: ${F}`:`Print order failed: ${F}`)}}:void 0,onCreateAnother:()=>{f.info("Creating new story - resetting settings"),Mt(null),fr(null),lr(null);const p=new URLSearchParams(d);p.delete("storyId"),o(p,{replace:!0}),Hr(""),tr(""),Er([]),wt([]),ze({frontCover:null,initialPage:null,backCover:null}),Cn(!1),kn(void 0),Pn(void 0),An(void 0),or(""),us(""),Mr(""),vr(""),Ue("watercolor"),ys("standard"),Vs(30),vs(""),cr(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),Ve(null),jt("photo"),de(1)},onRegenerateCover:re?async(p,P,z,G,F)=>{const ge=p==="front"?"frontCover":p==="back"?"backCover":"initialPage";try{f.info("Regenerating cover:",p,P?`with scene: "${P.substring(0,50)}..."`:"",z?`with ${z.length} characters`:""),Zs(ue=>new Set(ue).add(ge));const le=await Le.regenerateCover(re,p,P,z,G,F);ze(ue=>ue&&{...ue,[p==="front"?"frontCover":p==="back"?"backCover":"initialPage"]:{imageData:le.imageData,description:le.description,prompt:le.prompt,qualityScore:le.qualityScore,qualityReasoning:le.qualityReasoning,totalAttempts:le.totalAttempts,retryHistory:le.retryHistory,referencePhotos:le.referencePhotos,wasRegenerated:le.wasRegenerated,regenerationCount:le.regenerationCount,previousImage:le.previousImage,previousScore:le.previousScore,originalImage:le.originalImage,originalScore:le.originalScore,modelId:le.modelId}}),le.creditsRemaining!==void 0&&N&&N(le.creditsRemaining),f.info("Cover regenerated successfully")}catch(le){f.error("Cover regeneration failed:",le);const ue=le instanceof Error?le.message:String(le);k(s==="de"?`Cover-Generierung fehlgeschlagen: ${ue}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${ue}`:`Cover regeneration failed: ${ue}`)}finally{Zs(le=>{const ue=new Set(le);return ue.delete(ge),ue})}}:void 0,onEditImage:p=>{_a({type:"image",pageNumber:p}),na(""),Ga(!0)},onEditCover:p=>{_a({type:"cover",coverType:p}),na(""),Ga(!0)},onRepairImage:re&&((h==null?void 0:h.role)==="admin"||S)?async p=>{var P,z,G;try{f.info("Starting auto-repair for page:",p);const F=As.find(ue=>ue.pageNumber===p);let ge=F==null?void 0:F.fixTargets;if(!ge||ge.length===0){const ue=(z=(P=F==null?void 0:F.retryHistory)==null?void 0:P.filter(je=>je.type==="auto_repair"))==null?void 0:z.slice(-1)[0];(G=ue==null?void 0:ue.preRepairEval)!=null&&G.fixTargets&&ue.preRepairEval.fixTargets.length>0&&(ge=ue.preRepairEval.fixTargets,f.info(`Using ${ge.length} fix targets from retryHistory.preRepairEval`))}ge&&ge.length>0?f.info(`Using ${ge.length} existing fix targets`):f.info("No stored fix targets found, will re-evaluate");const le=await Le.repairImage(re,p,ge);le.repaired?(wt(ue=>ue.map(je=>je.pageNumber===p?{...je,imageData:le.imageData,wasAutoRepaired:!0,repairHistory:le.repairHistory,repairedAt:new Date().toISOString()}:je)),f.info("Auto-repair completed successfully:",{repaired:le.repaired,repairs:le.repairHistory.length})):le.noErrorsFound&&f.info("No physics errors detected in the image")}catch(F){throw f.error("Auto-repair failed:",F),F}}:void 0,onIteratePage:re&&((h==null?void 0:h.role)==="admin"||S)?async p=>{var P;try{f.info("Starting iteration for page:",p,"imageModel:",xt.imageModel);const z=await Le.iteratePage(re,p,xt.imageModel||void 0);z.success&&(wt(G=>G.map(F=>{var ge;if(F.pageNumber===p){const le=F.imageVersions||[],ue=(ge=z.imageVersions)==null?void 0:ge.map((je,Ge)=>{var ct;return{imageData:je.imageData||((ct=le[Ge])==null?void 0:ct.imageData)||"",description:je.description,prompt:je.prompt,modelId:je.modelId,createdAt:je.createdAt||new Date().toISOString(),isActive:je.isActive??!1,type:je.type,qualityScore:je.qualityScore}});return{...F,imageData:z.imageData,description:z.sceneDescription,prompt:z.imagePrompt,qualityScore:z.qualityScore,qualityReasoning:z.qualityReasoning,wasIterated:!0,iteratedAt:new Date().toISOString(),iterationFeedback:z.composition,previewMismatches:z.previewMismatches,imageVersions:ue||F.imageVersions}}return F})),Er(G=>G.map(F=>F.pageNumber===p?{...F,description:z.sceneDescription,iteratedAt:new Date().toISOString()}:F)),f.info("Iteration completed successfully:",{mismatches:((P=z.previewMismatches)==null?void 0:P.length)||0,score:z.qualityScore,message:z.message}))}catch(z){throw f.error("Iteration failed:",z),z}}:void 0,onRevertRepair:re&&((h==null?void 0:h.role)==="admin"||S)?async(p,P)=>{try{f.info("Reverting repair for page:",p),wt(z=>z.map(G=>G.pageNumber===p?{...G,imageData:P,wasAutoRepaired:!1}:G)),await Le.updateSceneImage(re,p,P),f.info("Repair reverted successfully")}catch(z){throw f.error("Failed to revert repair:",z),z}}:void 0,onSaveStoryText:re?async p=>{try{f.info("Saving story text for story:",re),await Le.saveStoryText(re,p),Hr(p),f.info("Story text saved successfully")}catch(P){throw f.error("Failed to save story text:",P),P}}:void 0,onSaveTitleChange:re?async p=>{try{f.info("Saving title for story:",re,p),await Le.saveStoryTitle(re,p),tr(p),f.info("Title saved successfully")}catch(P){throw f.error("Failed to save title:",P),P}}:void 0,userCredits:S?-1:(h==null?void 0:h.credits)||0,imageRegenerationCost:5,isImpersonating:S,onSelectImageVersion:re?async(p,P)=>{try{f.info("Selecting image version:",{pageNumber:p,versionIndex:P});const z=await Le.setActiveImage(re,p,P);wt(G=>G.map(F=>{if(F.pageNumber===p&&F.imageVersions){const ge=F.imageVersions[P];return{...F,imageData:(ge==null?void 0:ge.imageData)||F.imageData,imageVersions:F.imageVersions.map((le,ue)=>({...le,isActive:ue===P}))}}return F})),f.info("Image version selected:",z)}catch(z){throw f.error("Failed to select image version:",z),z}}:void 0,isPartial:Ma,failureReason:gi,generatedPages:hi,totalPages:xi,generationSettings:pi||void 0,onRefreshStory:re?async()=>{if(f.info("Refreshing story data:",re),Vr.current=!1,ft(p=>p+1),Z)try{const p=await Le.getStoryDevMetadata(re);Ha(p),Vr.current=!0,f.info("Dev metadata refreshed after repair")}catch(p){f.warn("Failed to refresh dev metadata:",p)}}:void 0})]})}return d.get("storyId")?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(lt,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):_t?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:s==="de"?"Geschichte wird erstellt...":s==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:s==="de"?"Einen Moment Geduld bitte":s==="fr"?"Veuillez patienter":"Please wait a moment"})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ds,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:m.generateStory}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Bereit, deine Geschichte zu erstellen!":s==="fr"?"PrÃªt Ã  crÃ©er votre histoire!":"Ready to create your story!"}),e.jsxs(en,{onClick:()=>is(),size:"lg",icon:Ds,children:[m.generateStory," (",At*10," Credits)"]})]});default:return null}};return D?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Yi,{currentStep:L,onStepClick:zr,canAccessStep:Gi,developerMode:Z,onDeveloperModeChange:$e,hideSteps:L===6&&!!re,onShowGenerationProgress:()=>{c(!1),de(6)}}),e.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:e.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[w&&!_t?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(lt,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:j?s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story...":s==="de"?"Wird geladen...":s==="fr"?"Chargement...":"Loading..."}),j&&e.jsxs("div",{className:"w-64 mt-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:j.total?`${Math.min(100,j.loaded/j.total*100)}%`:"100%"}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[(j.loaded/(1024*1024)).toFixed(1)," MB",j.total&&e.jsxs("span",{children:[" (",Math.round(j.loaded/j.total*100),"%)"]})]})]})]}):e.jsxs(e.Fragment,{children:[L>=1&&L<=5&&!R&&e.jsx(ko,{step:L,text:(ai[s]||ai.en)[L]}),e.jsx(n.Suspense,{fallback:e.jsx(zn,{}),children:Vi()})]}),L<6&&!R&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[L===1&&Fe.length>=2&&!Si()&&(()=>{const i=Ci();if(!i)return null;const b=s==="de"?`${i.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:s==="fr"?`${i.name} a des relations non dÃ©finies ("ne connaÃ®t pas")`:`${i.name} has undefined relationships ("not known to")`;return e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"âš ï¸"}),e.jsx("p",{className:"text-amber-700 text-sm",children:b})]})})(),L!==5&&e.jsxs("div",{className:`flex ${L===1?"justify-end":"justify-between"}`,children:[L>1&&e.jsxs("button",{onClick:Fn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(Hn,{size:20})," ",m.back]}),e.jsxs("button",{onClick:Hi,disabled:!ns(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${ns()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[m.next," ",e.jsx(ao,{size:20})]})]}),L===5&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:()=>is(),disabled:!ns(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${ns()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Ds,{size:20})," ",m.generateStory," (",At*10," Credits)"]}),Z&&e.jsxs("button",{onClick:()=>is({skipImages:!0}),disabled:!ns(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${ns()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Ds,{size:20}),s==="de"?"Nur Text generieren (ohne Bilder)":s==="fr"?"GÃ©nÃ©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),Z&&e.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["ðŸ› ï¸ ",s==="de"?"Entwickler-Optionen - Schritte Ã¼berspringen":s==="fr"?"Options dÃ©veloppeur - Sauter des Ã©tapes":"Developer Options - Skip Steps"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:X,onChange:i=>Q(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Gliederung Ã¼berspringen":s==="fr"?"Sauter le plan":"Skip outline generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:E,onChange:i=>V(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Text Ã¼berspringen":s==="fr"?"Sauter le texte":"Skip text generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:pe,onChange:i=>J(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenenbeschreibungen Ã¼berspringen":s==="fr"?"Sauter les descriptions de scÃ¨nes":"Skip scene descriptions"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:oe,onChange:i=>H(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Bilder Ã¼berspringen":s==="fr"?"Sauter les images":"Skip image generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:De,onChange:i=>Be(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Cover Ã¼berspringen":s==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2",children:s==="de"?"Hinweis: Ãœbersprungene Schritte verwenden Platzhalter/leere Daten":s==="fr"?"Note: Les Ã©tapes sautÃ©es utiliseront des donnÃ©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["ðŸ”§ ",s==="de"?"Feature-Optionen":s==="fr"?"Options de fonctionnalitÃ©s":"Feature Options"]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Ie,onChange:i=>qe(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Auto-Reparatur aktivieren":s==="fr"?"Activer la rÃ©paration auto":"Enable auto-repair"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":s==="fr"?"Essaie de corriger automatiquement les erreurs d'image dÃ©tectÃ©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),Ie&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:q,onChange:i=>se(i.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Grid-Reparatur verwenden":s==="fr"?"Utiliser la rÃ©paration en grille":"Use grid repair"})]}),Ie&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":s==="fr"?"Extrait les rÃ©gions problÃ©matiques dans une grille, rÃ©pare avec Gemini, vÃ©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),Ie&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:s==="de"?"Reparatur-Schwelle:":s==="fr"?"Seuil de rÃ©paration:":"Force repair threshold:"}),e.jsxs("select",{value:ve===null?"default":ve,onChange:i=>ke(i.target.value==="default"?null:parseInt(i.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"default",children:s==="de"?"Standard (nur bei Fehler)":s==="fr"?"DÃ©faut (seulement si erreur)":"Default (only on failure)"}),e.jsx("option",{value:"100",children:s==="de"?"100% (immer reparieren)":s==="fr"?"100% (toujours rÃ©parer)":"100% (always repair)"}),e.jsx("option",{value:"90",children:"90%"}),e.jsx("option",{value:"80",children:"80%"}),e.jsx("option",{value:"75",children:"75%"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die QualitÃ¤tsprÃ¼fung bestehen":s==="fr"?"Ã€ 100%, toutes les pages avec des problÃ¨mes sont rÃ©parÃ©es, mÃªme si elles passent le contrÃ´le qualitÃ©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Ae,onChange:i=>_e(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"KonsistenzprÃ¼fung aktivieren":s==="fr"?"Activer la vÃ©rification de cohÃ©rence":"Enable final checks"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft Bilder und Text auf Konsistenz am Ende der Generierung":s==="fr"?"VÃ©rifie la cohÃ©rence des images et du texte Ã  la fin de la gÃ©nÃ©ration":"Checks images and text for consistency at end of generation"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:$t,onChange:i=>yr(i.target.checked),className:"rounded border-cyan-300 text-cyan-600 focus:ring-cyan-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenen-Validierung":s==="fr"?"Validation de scÃ¨ne":"Scene validation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt gÃ¼nstige Vorschau, prÃ¼ft Geometrie, repariert Kompositionsprobleme":s==="fr"?"GÃ©nÃ¨re un aperÃ§u Ã©conomique, vÃ©rifie la gÃ©omÃ©trie, rÃ©pare les problÃ¨mes de composition":"Generates cheap preview, checks geometry, repairs composition issues"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:nr,onChange:i=>Jr(i.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Getrennte Auswertung":s==="fr"?"Ã‰valuation sÃ©parÃ©e":"Separated evaluation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt alle Bilder zuerst, dann wertet alle parallel aus und repariert":s==="fr"?"GÃ©nÃ¨re toutes les images d'abord, puis Ã©value et rÃ©pare en parallÃ¨le":"Generates all images first, then evaluates and repairs in batch"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Zr,onChange:i=>cs(i.target.checked),className:"rounded border-purple-300 text-purple-600 focus:ring-purple-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Volle Reparatur nach Generierung":s==="fr"?"RÃ©paration complÃ¨te aprÃ¨s gÃ©nÃ©ration":"Full repair after generation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"FÃ¼hrt nach der Generierung den kompletten Reparatur-Workflow aus (bis zu 4 Versuche pro Seite)":s==="fr"?"ExÃ©cute le workflow de rÃ©paration complet aprÃ¨s la gÃ©nÃ©ration (jusqu'Ã  4 tentatives par page)":"Runs the full repair workflow after generation (up to 4 retries per page)"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Xe,onChange:i=>et(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Inkrementelle Konsistenz":s==="fr"?"CohÃ©rence incrÃ©mentielle":"Incremental consistency"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft jedes Bild gegen vorherige Bilder wÃ¤hrend der Generierung":s==="fr"?"VÃ©rifie chaque image par rapport aux images prÃ©cÃ©dentes pendant la gÃ©nÃ©ration":"Checks each image against previous images during generation"}),Xe&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:ot,onChange:i=>a(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur Protokoll (Dry Run)":s==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),Xe&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Zeigt nur an, was repariert wÃ¼rde, ohne tatsÃ¤chlich zu reparieren":s==="fr"?"Affiche uniquement ce qui serait rÃ©parÃ© sans effectuer de rÃ©parations":"Shows what would be fixed without actually fixing"}),Xe&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-700 text-sm",children:s==="de"?"Vergleichsfenster:":s==="fr"?"FenÃªtre de comparaison:":"Lookback window:"}),e.jsx("input",{type:"range",min:"1",max:"5",value:Pe,onChange:i=>Je(parseInt(i.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),e.jsx("span",{className:"text-gray-600 font-medium w-4",children:Pe})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?`Vergleicht jedes Bild mit den ${Pe} vorherigen`:s==="fr"?`Compare chaque image avec les ${Pe} prÃ©cÃ©dentes`:`Compares each image with the previous ${Pe}`})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[e.jsx("input",{type:"checkbox",checked:Me,onChange:i=>Bs(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur PrÃ¼fung (keine Regenerierung)":s==="fr"?"VÃ©rification seule (pas de rÃ©gÃ©nÃ©ration)":"Check only (no regeneration)"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"FÃ¼hrt alle QualitÃ¤tsprÃ¼fungen durch, Ã¼berspringt aber Regenerierung/Reparatur":s==="fr"?"ExÃ©cute toutes les vÃ©rifications de qualitÃ© mais ignore la rÃ©gÃ©nÃ©ration/rÃ©paration":"Runs all quality checks but skips regeneration/repair"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:ir,onChange:i=>ha(i.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Alle Avatare laden":s==="fr"?"Charger tous les avatars":"Load all avatars"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"LÃ¤dt alle Avatar-Varianten (30MB+). NÃ¼tzlich zum Debuggen.":s==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le dÃ©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),Z&&((h==null?void 0:h.role)==="admin"||S)&&e.jsx(Ho,{selections:xt,onChange:ms}),e.jsxs("button",{onClick:Fn,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(Hn,{size:20})," ",m.back]})]})]})]})}),_t&&!Dr&&!Ot&&!U.frontCover&&!u&&e.jsx(Po,{current:Bt.current,total:Bt.total,message:Bt.message,coverImages:U,characters:Fe,jobId:Wr||void 0,isStalled:ss,onDismissStalled:()=>Ht(!1),isImpersonating:S,onMinimize:()=>l(!0),onCancel:Wr?async()=>{try{await Le.cancelJob(Wr),f.info("Job cancelled by user"),Rr(!1),fr(null),Ht(!1),fe({current:0,total:0,message:""}),v(s==="de"?"Generierung abgebrochen":s==="fr"?"GÃ©nÃ©ration annulÃ©e":"Generation cancelled")}catch(i){f.error("Failed to cancel job:",i),k(s==="de"?"Abbruch fehlgeschlagen":s==="fr"?"Ã‰chec de l'annulation":"Failed to cancel")}}:void 0}),I&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Geschichte wird im Hintergrund generiert":s==="fr"?"Histoire en cours de gÃ©nÃ©ration":"Story generating in background"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Was mÃ¶chtest du tun?":s==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{c(!0),l(!1),r("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Neue Geschichte erstellen":s==="fr"?"CrÃ©er une autre histoire":"Create another story"}),Ee&&e.jsx("button",{onClick:()=>{c(!0),l(!1),r("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Meine Geschichten lesen":s==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),ne&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Nur ein Charakter":s==="fr"?"Un seul personnage":"Only One Character"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":s==="fr"?"Les histoires sont plus intÃ©ressantes avec plusieurs personnages. Vous n'avez crÃ©Ã© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{ee(!1),un()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Weiteren Charakter erstellen":s==="fr"?"CrÃ©er un autre personnage":"Create another character"}),e.jsx("button",{onClick:async()=>{ee(!1),await zr(L+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Trotzdem weiter":s==="fr"?"Continuer quand mÃªme":"Continue anyway"})]})]})}),Ca&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[e.jsx("div",{className:"relative inline-block mb-4",children:e.jsx(lt,{size:40,className:"animate-spin text-indigo-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s==="de"?"Bild wird erstellt...":s==="fr"?"CrÃ©ation de l'image...":"Generating image..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:s==="de"?"Dies dauert etwa 30 Sekunden":s==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),yi&&ht&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:s==="de"?"Bild bearbeiten":s==="fr"?"Modifier l'image":"Edit Image"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:ht.type==="image"?s==="de"?`Seite ${ht.pageNumber}`:s==="fr"?`Page ${ht.pageNumber}`:`Page ${ht.pageNumber}`:s==="de"?ht.coverType==="front"?"Titelseite":ht.coverType==="back"?"RÃ¼ckseite":"Einleitungsseite":s==="fr"?ht.coverType==="front"?"Couverture":ht.coverType==="back"?"Dos":"Page de dÃ©dicace":ht.coverType==="front"?"Front Cover":ht.coverType==="back"?"Back Cover":"Dedication Page"}),e.jsx("textarea",{value:aa,onChange:i=>na(i.target.value),placeholder:s==="de"?`Beschreibe die gewÃ¼nschte Ã„nderung...
z.B. "Mach den Himmel blauer" oder "FÃ¼ge einen Schmetterling hinzu"`:s==="fr"?`DÃ©crivez le changement souhaitÃ©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{onClick:()=>{Ga(!1),_a(null),na("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:s==="de"?"Abbrechen":s==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:async()=>{if(!(!aa.trim()||!re)){Ga(!1),t(!0);try{if(ht.type==="image"&&ht.pageNumber){const i=await Le.editImage(re,ht.pageNumber,aa);if(f.info("Edit result:",{hasImageData:!!(i!=null&&i.imageData),score:i==null?void 0:i.qualityScore}),!(i!=null&&i.imageData))throw f.error("No imageData in edit response!",i),new Error("No image data returned from server");wt(b=>b.map(g=>g.pageNumber===ht.pageNumber?{...g,imageData:i.imageData,qualityScore:i.qualityScore,qualityReasoning:i.qualityReasoning,wasEdited:!0,originalImage:i.originalImage,originalScore:i.originalScore,originalReasoning:i.originalReasoning}:g)),f.info("Image edited successfully, updated state with quality info")}else if(ht.type==="cover"&&ht.coverType){const i=await Le.editCover(re,ht.coverType,aa);ze(b=>{if(!b)return b;const g=ht.coverType==="front"?"frontCover":ht.coverType==="back"?"backCover":"initialPage",M=b[g],p={...typeof M=="object"?M:{},imageData:i.imageData,qualityScore:i.qualityScore,qualityReasoning:i.qualityReasoning,wasEdited:!0,originalImage:i.originalImage,originalScore:i.originalScore,originalReasoning:i.originalReasoning};return{...b,[g]:p}}),f.info("Cover edited successfully with quality info")}}catch(i){f.error("Edit failed:",i),k(s==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de la modification. Veuillez rÃ©essayer.":"Edit failed. Please try again.")}finally{t(!1),_a(null),na("")}}},disabled:!aa.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:s==="de"?"Bearbeiten":s==="fr"?"Modifier":"Edit"})]})]})}),e.jsx(tl,{isOpen:Sr,faces:Zt,onSelect:Ai,onUploadNew:$i,developerMode:Z}),e.jsx(Qo,{isOpen:gt,onClose:()=>vt(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const i=localStorage.getItem("verificationGenerationStarted");if(i){const b=parseInt(i,10),g=Date.now()-120*1e3;if(b>g){console.log("[EmailVerification] Another window started recently, skipping"),vt(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),is({skipEmailCheck:!0}),vt(!1)}})]}):e.jsx(zn,{fullScreen:!0})}const _l=Object.freeze(Object.defineProperty({__proto__:null,default:gl},Symbol.toStringTag,{value:"Module"}));export{To as I,fo as S,bo as U,Is as a,ci as b,Ye as c,Dl as d,Ml as e,Xo as f,Yo as g,Ol as h,Xn as i,zl as j,Ll as k,El as l,Bl as m,Gl as n,ti as o,ri as p,Fl as q,Sn as r,Rl as s,si as t,Tl as u,yn as v,_l as w};
