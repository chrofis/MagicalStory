const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WizardStep2Characters-CIPuf9Lp.js","assets/index-D5ayR4Fz.js","assets/vendor-react-CqfXSjHo.js","assets/vendor-firebase-DTVMaYMy.js","assets/index-CkNL5W9H.css","assets/Input-Bdba03QN.js","assets/Textarea-RQfZVo3o.js","assets/sparkles-BXVFp1q6.js","assets/book-open-CRxt8inI.js","assets/check-DfkRZ6bM.js","assets/pen-CHfAMX64.js","assets/trash-2-z_cTNaQb.js","assets/Modal-CZu_UIV3.js","assets/download-BvNt-bP1.js","assets/chevron-right-9ffzvTIl.js","assets/arrow-right-C25iBFJU.js","assets/camera-DUV9H6eh.js","assets/pencil-dAGAdgjR.js","assets/circle-x-CXmsIU8B.js","assets/clock-B3ZuTpKz.js","assets/palette-DE6Vyzdu.js","assets/book-BtPGXLhy.js","assets/shopping-cart-BpwSa4vp.js","assets/arrow-left-BptK4nyI.js","assets/WizardStep4StoryType-8loGo2pN.js","assets/WizardStep5ArtStyle-Df7xVbdZ.js","assets/artStyles-DJIZ4CgP.js","assets/WizardStep6Summary-DkD7uXQf.js"])))=>i.map(i=>d[i]);
import{c as rt,b as Ke,d as hn,j as e,X as zt,u as lr,a as xn,L as Ze,T as pn,C as ea,s as Ee,E as Gi,e as _i,f as Hi,g as In,_ as ta}from"./index-D5ayR4Fz.js";import{b as i,u as Vi,e as Wi}from"./vendor-react-CqfXSjHo.js";import{U as ws,B as Wa,I as Tn}from"./Input-Bdba03QN.js";import{S as qi,A as Rn,N as Ui}from"./Textarea-RQfZVo3o.js";import{C as fn}from"./circle-x-CXmsIU8B.js";import{C as Ki}from"./clock-B3ZuTpKz.js";import{M as Xn,H as Ji,C as Dn,R as Qt,F as vs,P as Fn,a as qa,I as En,S as ei,b as Qi}from"./Modal-CZu_UIV3.js";import{D as rs,C as Mt}from"./download-BvNt-bP1.js";import{C as Ss}from"./chevron-right-9ffzvTIl.js";import{P as ti}from"./palette-DE6Vyzdu.js";import{B as Zi}from"./book-BtPGXLhy.js";import{C as Yi}from"./check-DfkRZ6bM.js";import{S as Bn}from"./shopping-cart-BpwSa4vp.js";import{B as Ua}from"./book-open-CRxt8inI.js";import{S as Ns}from"./sparkles-BXVFp1q6.js";import{A as zn}from"./arrow-left-BptK4nyI.js";import{A as Xi}from"./arrow-right-C25iBFJU.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ri=rt("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eo=rt("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const to=rt("Cpu",[["rect",{width:"16",height:"16",x:"4",y:"4",rx:"2",key:"14l7u7"}],["rect",{width:"6",height:"6",x:"9",y:"9",rx:"1",key:"5aljv4"}],["path",{d:"M15 2v2",key:"13l42r"}],["path",{d:"M15 20v2",key:"15mkzm"}],["path",{d:"M2 15h2",key:"1gxd5l"}],["path",{d:"M2 9h2",key:"1bbxkp"}],["path",{d:"M20 15h2",key:"19e6y8"}],["path",{d:"M20 9h2",key:"19tzq7"}],["path",{d:"M9 2v2",key:"165o2o"}],["path",{d:"M9 20v2",key:"i2bqo8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ro=rt("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const si=rt("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Or=rt("Images",[["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"m22 13-1.296-1.296a2.41 2.41 0 0 0-3.408 0L11 18",key:"nf6bnh"}],["circle",{cx:"12",cy:"8",r:"2",key:"1822b1"}],["rect",{width:"16",height:"16",x:"6",y:"2",rx:"2",key:"12espp"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const so=rt("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ao=rt("Link2Off",[["path",{d:"M9 17H7A5 5 0 0 1 7 7",key:"10o201"}],["path",{d:"M15 7h2a5 5 0 0 1 4 8",key:"1d3206"}],["line",{x1:"8",x2:"12",y1:"12",y2:"12",key:"rvw6j4"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const no=rt("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=rt("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const io=rt("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oo=rt("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=rt("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lo=rt("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ys=rt("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const co=rt("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mn=rt("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mo=rt("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uo=rt("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const go=rt("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dn=rt("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lr=rt("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ho=rt("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]),xo={async login(r,l){const o=await Ke.post("/api/auth/login",{username:r,password:l},{skipAuth:!0}),c={id:o.user.id,username:o.user.username,email:o.user.email,role:o.user.role,credits:o.user.credits};return{token:o.token,user:c}},async register(r,l,o){return Ke.post("/api/auth/register",{username:r,password:l,email:o},{skipAuth:!0})},async loginWithFirebase(r){const l=await Ke.post("/api/auth/firebase",{idToken:r},{skipAuth:!0}),o={id:l.user.id,username:l.user.username,email:l.user.email,role:l.user.role,credits:l.user.credits};return{token:l.token,user:o}},async getQuota(){const r=await Ke.get("/api/user/quota");return{storyQuota:r.storyQuota,storiesGenerated:r.storiesGenerated,remaining:r.remaining}},async getCredits(){const r=await Ke.get("/api/user/quota");return{credits:r.credits,unlimited:r.unlimited}},async updateEmail(r){await Ke.put("/api/user/update-email",{email:r})},async getShippingAddress(){try{return await Ke.get("/api/user/shipping-address")}catch{return null}},async updateShippingAddress(r){await Ke.put("/api/user/shipping-address",r)}},ve=hn("CharacterService");function ai(r){if(!r)return;const l=parseInt(r,10);if(!(isNaN(l)||l<0))return l<=1?"infant":l<=2?"toddler":l<=4?"preschooler":l<=6?"kindergartner":l<=8?"young-school-age":l<=10?"school-age":l<=12?"preteen":l<=14?"young-teen":l<=17?"teenager":l<=25?"young-adult":l<=39?"adult":l<=59?"middle-aged":l<=75?"senior":"elderly"}function cn(r){const l={height:r.height,build:r.build,face:r.other_features||r.otherFeatures,eyeColor:r.eye_color||r.eyeColor,hairColor:r.hair_color||r.hairColor,hairLength:r.hair_length||r.hairLength,hairStyle:r.hair_style||r.hairStyle,facialHair:r.facial_hair||r.facialHair,skinTone:r.skin_tone||r.skinTone,skinUndertone:r.skin_undertone||r.skinUndertone,skinToneHex:r.skin_tone_hex||r.skinToneHex,hair:r.hair_color||r.hairColor,other:r.other,detailedHairAnalysis:r.detailed_hair_analysis||r.detailedHairAnalysis,apparentAge:r.apparent_age||r.apparentAge},o=r.age_category||r.ageCategory||ai(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,ageCategory:o,physical:l.height||l.build||l.face||l.eyeColor||l.hairColor||l.hairLength||l.hairStyle||l.facialHair||l.skinTone||l.hair||l.other||l.detailedHairAnalysis||l.apparentAge?l:void 0,physicalTraitsSource:r.physical_traits_source||r.physicalTraitsSource,traits:{strengths:r.strengths||[],flaws:r.flaws||r.weaknesses||[],challenges:r.challenges||r.fears||[],specialDetails:r.special_details||r.specialDetails},photos:{original:r.photo_url||r.photoUrl,face:r.thumbnail_url||r.thumbnailUrl,body:r.body_photo_url||r.bodyPhotoUrl,bodyNoBg:r.body_no_bg_url||r.bodyNoBgUrl,faceBox:r.face_box||r.faceBox,bodyBox:r.body_box||r.bodyBox},avatars:r.avatars||r.clothing_avatars||r.clothingAvatars,clothing:r.clothing||r.structured_clothing||r.structuredClothing?{current:r.clothing,structured:r.structured_clothing||r.structuredClothing}:void 0,generatedOutfits:r.generated_outfits||r.generatedOutfits,storyRole:r.storyRole}}function On(r){var o,c,s,E,g,S,R,V,M,N,k,f,q,j,x,O,xe,ne,T,L,z,F,W,P;const l=r.ageCategory||ai(r.age);return{id:r.id,name:r.name,gender:r.gender,age:r.age,age_category:l,apparent_age:(o=r.physical)==null?void 0:o.apparentAge,height:(c=r.physical)==null?void 0:c.height,build:(s=r.physical)==null?void 0:s.build,eye_color:(E=r.physical)==null?void 0:E.eyeColor,hair_color:(g=r.physical)==null?void 0:g.hairColor,hair_length:(S=r.physical)==null?void 0:S.hairLength,hair_style:(R=r.physical)==null?void 0:R.hairStyle,facial_hair:(V=r.physical)==null?void 0:V.facialHair,skin_tone:(M=r.physical)==null?void 0:M.skinTone,skin_undertone:(N=r.physical)==null?void 0:N.skinUndertone,skin_tone_hex:(k=r.physical)==null?void 0:k.skinToneHex,other_features:(f=r.physical)==null?void 0:f.face,other:(q=r.physical)==null?void 0:q.other,detailed_hair_analysis:(j=r.physical)==null?void 0:j.detailedHairAnalysis,physical_traits_source:r.physicalTraitsSource,face_box:(x=r.photos)==null?void 0:x.faceBox,body_box:(O=r.photos)==null?void 0:O.bodyBox,strengths:(xe=r.traits)==null?void 0:xe.strengths,flaws:(ne=r.traits)==null?void 0:ne.flaws,challenges:(T=r.traits)==null?void 0:T.challenges,special_details:(L=r.traits)==null?void 0:L.specialDetails,weaknesses:(z=r.traits)==null?void 0:z.flaws,fears:(F=r.traits)==null?void 0:F.challenges,clothing:(W=r.clothing)==null?void 0:W.current,structured_clothing:(P=r.clothing)==null?void 0:P.structured,generated_outfits:r.generatedOutfits,storyRole:r.storyRole}}function po(r){return!r||r.length===0?[]:typeof r[0]=="string"?r.map(l=>({forward:l,inverse:l})):r}const Ge={async getCharacters(r=!1){const l=r?"/api/characters?includeAllAvatars=true":"/api/characters";return((await Ke.get(l)).characters||[]).map(cn)},async getCharacterData(r=!1){const l=r?"/api/characters?includeAllAvatars=true":"/api/characters",o=await Ke.get(l);return{characters:(o.characters||[]).map(cn),relationships:o.relationships||{},relationshipTexts:o.relationshipTexts||{},customRelationships:po(o.customRelationships),customStrengths:o.customStrengths||[],customWeaknesses:o.customWeaknesses||[],customFears:o.customFears||[]}},async saveCharacters(r){await Ke.post("/api/characters",{characters:r.map(On)})},async saveCharacterData(r,l){const o=s=>{var g,S,R,V;const E=On(s);return l!=null&&l.includePhotos&&(E.photo_url=(g=s.photos)==null?void 0:g.original,E.thumbnail_url=(S=s.photos)==null?void 0:S.face,E.body_photo_url=(R=s.photos)==null?void 0:R.body,E.body_no_bg_url=(V=s.photos)==null?void 0:V.bodyNoBg),E},c={characters:r.characters.map(o),relationships:r.relationships,relationshipTexts:r.relationshipTexts,customRelationships:r.customRelationships,customStrengths:r.customStrengths,customWeaknesses:r.customWeaknesses,customFears:r.customFears};await Ke.post("/api/characters",c)},async deleteCharacter(r){try{const l=await Ke.delete(`/api/characters/${r}`);return ve.success(`Deleted character ${r}: ${l.message}`),{success:!0}}catch(l){return ve.error(`Failed to delete character ${r}:`,l),{success:!1,error:String(l)}}},async saveCharacterRoles(r){try{return await Ke.put("/api/characters/roles",{roles:r}),ve.success(`Saved character roles: ${Object.keys(r).length} characters`),{success:!0}}catch(l){return ve.error("Failed to save character roles:",l),{success:!1,error:String(l)}}},async loadCharacterAvatars(r){try{const l=await Ke.get(`/api/characters/${r}/avatars`);return ve.info(`Loaded full avatars for character ${r}`),l.avatars||null}catch(l){return ve.error(`Failed to load avatars for character ${r}:`,l),null}},async loadFullCharacter(r){try{const l=await Ke.get(`/api/characters/${r}/full`);return l.character?(ve.info(`Loaded full data for character ${r}`),cn(l.character)):null}catch(l){return ve.error(`Failed to load full data for character ${r}:`,l),null}},async generateAvatarOptions(r,l){try{return await Ke.post("/api/generate-avatar-options",{facePhoto:r,gender:l,category:"standard"})}catch(o){const c=o instanceof Error?o.message:"Unknown error";return{success:!1,options:[],error:c}}},async generateClothingAvatars(r,l){var o,c,s,E,g,S,R,V,M,N,k;try{const f=parseInt(r.age)||10,q=r.gender||"child";let j;q==="male"?j=f>=18?"man":"boy":q==="female"?j=f>=18?"woman":"girl":j=f>=18?"person":"child";let O=`${((o=r.name)==null?void 0:o.trim())||`This ${j}`} is a ${f}-year-old ${j}`;r.physical&&(r.physical.hair&&(O+=`, ${r.physical.hair}`),r.physical.face&&(O+=`, ${r.physical.face}`),r.physical.build&&(O+=`, ${r.physical.build}`),r.physical.other&&(O+=`, ${r.physical.other}`));const xe=((c=r.photos)==null?void 0:c.bodyNoBg)||((s=r.photos)==null?void 0:s.body)||((E=r.photos)==null?void 0:E.face)||((g=r.photos)==null?void 0:g.original);ve.info(`ðŸŽ¨ Generating clothing avatars for ${r.name||"unnamed"} (id: ${r.id})`);const ne=await Ke.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:xe,physicalDescription:O,name:r.name,age:r.age,apparentAge:(S=r.physical)==null?void 0:S.apparentAge,gender:r.gender,build:(R=r.physical)==null?void 0:R.build,clothing:(V=r.clothing)==null?void 0:V.structured,avatarModel:l==null?void 0:l.avatarModel});if(ne.async&&ne.jobId){ve.info(`Avatar job started: ${ne.jobId}, polling for completion...`);const L=60,z=2e3;for(let F=0;F<L;F++){await new Promise(P=>setTimeout(P,z));const W=await Ke.get(`/api/avatar-jobs/${ne.jobId}`);if(W.status==="complete"&&W.clothingAvatars){ve.success(`Avatar job ${ne.jobId} completed after ${(F+1)*2}s`);const P=W.clothingAvatars.extractedTraits,ee=(M=W.clothingAvatars.structuredClothing)==null?void 0:M.standard;return ve.info(`ðŸ” [DEBUG] extractedTraits: ${(N=JSON.stringify(P))==null?void 0:N.substring(0,100)}`),ve.info(`ðŸ” [DEBUG] extractedClothing: ${JSON.stringify(ee)}`),ve.info(`ðŸ” [DEBUG] structuredClothing keys: ${Object.keys(W.clothingAvatars.structuredClothing||{})}`),{success:!0,avatars:W.clothingAvatars,extractedTraits:P,extractedClothing:ee}}if(W.status==="failed")return ve.error(`Avatar job failed: ${W.error}`),{success:!1,error:W.error};F%5===0&&ve.info(`Avatar job ${ne.jobId}: ${W.message||W.status} (${W.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}const T=ne;if(T.success&&T.clothingAvatars){ve.success(`Clothing avatars generated for ${r.name}`);const L=T.clothingAvatars.extractedTraits,z=(k=T.clothingAvatars.structuredClothing)==null?void 0:k.standard;return L&&ve.info(`Extracted traits: ${JSON.stringify(L)}`),z&&ve.info(`Extracted clothing: ${JSON.stringify(z)}`),{success:!0,avatars:T.clothingAvatars,extractedTraits:L,extractedClothing:z}}else return ve.error(`Failed to generate avatars: ${T.error}`),{success:!1,error:T.error}}catch(f){return ve.error("Clothing avatar generation failed:",f),{success:!1,error:String(f)}}},async generateClothingAvatarsWithTraits(r){var l,o,c,s,E,g,S,R,V,M,N,k,f,q,j,x,O,xe;try{const ne=parseInt(r.age)||10,T=r.gender||"child";let L;T==="male"?L=ne>=18?"man":"boy":T==="female"?L=ne>=18?"woman":"girl":L=ne>=18?"person":"child";let F=`${((l=r.name)==null?void 0:l.trim())||`This ${L}`} is a ${ne}-year-old ${L}`;r.physical&&(r.physical.hair&&(F+=`, ${r.physical.hair}`),r.physical.face&&(F+=`, ${r.physical.face}`),r.physical.build&&(F+=`, ${r.physical.build}`),r.physical.other&&(F+=`, ${r.physical.other}`));const W=((o=r.photos)==null?void 0:o.bodyNoBg)||((c=r.photos)==null?void 0:c.body)||((s=r.photos)==null?void 0:s.face)||((E=r.photos)==null?void 0:E.original),P=(g=r.photos)!=null&&g.bodyNoBg?"bodyNoBg":(S=r.photos)!=null&&S.body?"body":(R=r.photos)!=null&&R.face?"face":"original",ee=W?Math.round(W.length/1024):0,Q=W==null?void 0:W.startsWith("data:image/png");ve.info(`ðŸŽ¨ Generating clothing avatars WITH TRAITS for ${r.name} (id: ${r.id})`),ve.info(`ðŸ“¸ Photo source: ${P}, size: ${ee}KB, format: ${Q?"PNG":"JPEG"}`),ve.info(`ðŸ“¸ Available photos: bodyNoBg=${!!((V=r.photos)!=null&&V.bodyNoBg)}, body=${!!((M=r.photos)!=null&&M.body)}, face=${!!((N=r.photos)!=null&&N.face)}, original=${!!((k=r.photos)!=null&&k.original)}`),ve.info(`Physical traits: ${JSON.stringify(r.physical)}`);const Ne=r.physicalTraitsSource||{};ve.info(`Physical traits source: ${JSON.stringify(Ne)}`),ve.info(`Physical skinTone value: '${(f=r.physical)==null?void 0:f.skinTone}', source: '${Ne.skinTone}'`),ve.info(`Physical hairStyle value: '${(q=r.physical)==null?void 0:q.hairStyle}', source: '${Ne.hairStyle}'`);const Se={};r.physical&&(Ne.eyeColor==="user"&&r.physical.eyeColor&&(Se.eyeColor=r.physical.eyeColor),Ne.hairColor==="user"&&r.physical.hairColor&&(Se.hairColor=r.physical.hairColor),Ne.hairLength==="user"&&r.physical.hairLength&&(Se.hairLength=r.physical.hairLength),Ne.hairStyle==="user"&&r.physical.hairStyle&&(Se.hairStyle=r.physical.hairStyle),Ne.build==="user"&&r.physical.build&&(Se.build=r.physical.build),Ne.skinTone==="user"&&r.physical.skinTone&&(Se.skinTone=r.physical.skinTone,r.physical.skinToneHex&&(Se.skinToneHex=r.physical.skinToneHex)),Ne.face==="user"&&r.physical.face&&(Se.face=r.physical.face),Ne.facialHair==="user"&&r.physical.facialHair&&(Se.facialHair=r.physical.facialHair),Ne.other==="user"&&r.physical.other&&(Se.other=r.physical.other));const b=Object.keys(Se).length>0;ve.info(`Physical traits to send (user-edited only): ${b?JSON.stringify(Se):"none"}`);const H=r.clothingSource||{},ie={};(j=r.clothing)!=null&&j.structured&&(H.upperBody==="user"&&r.clothing.structured.upperBody&&(ie.upperBody=r.clothing.structured.upperBody),H.lowerBody==="user"&&r.clothing.structured.lowerBody&&(ie.lowerBody=r.clothing.structured.lowerBody),H.shoes==="user"&&r.clothing.structured.shoes&&(ie.shoes=r.clothing.structured.shoes),H.fullBody==="user"&&r.clothing.structured.fullBody&&(ie.fullBody=r.clothing.structured.fullBody));const je=Object.keys(ie).length>0;ve.info(`Clothing to send (user-edited only): ${je?JSON.stringify(ie):"none"}`);const le=await Ke.post("/api/generate-clothing-avatars?async=true",{characterId:r.id,facePhoto:W,physicalDescription:F,name:r.name,age:r.age,apparentAge:(x=r.physical)==null?void 0:x.apparentAge,gender:r.gender,build:Se.build||"average",physicalTraits:b?Se:void 0,clothing:je?ie:void 0});if(le.async&&le.jobId){ve.info(`Avatar job started: ${le.jobId}, polling for completion...`);const G=60,I=2e3;for(let me=0;me<G;me++){await new Promise(ge=>setTimeout(ge,I));const te=await Ke.get(`/api/avatar-jobs/${le.jobId}`);if(te.status==="complete"&&te.clothingAvatars){ve.success(`Avatar job ${le.jobId} completed after ${(me+1)*2}s`);const ge=te.clothingAvatars.extractedTraits,Z=(O=te.clothingAvatars.structuredClothing)==null?void 0:O.standard;return{success:!0,avatars:te.clothingAvatars,extractedTraits:ge,extractedClothing:Z}}if(te.status==="failed")return ve.error(`Avatar job failed: ${te.error}`),{success:!1,error:te.error};me%5===0&&ve.info(`Avatar job ${le.jobId}: ${te.message||te.status} (${te.progress||0}%)`)}return{success:!1,error:"Avatar generation timed out"}}if(le.success&&le.clothingAvatars){ve.success(`Clothing avatars WITH TRAITS generated for ${r.name}`);const G=le.clothingAvatars.extractedTraits,I=(xe=le.clothingAvatars.structuredClothing)==null?void 0:xe.standard;return{success:!0,avatars:le.clothingAvatars,extractedTraits:G,extractedClothing:I}}else return ve.error(`Failed to generate avatars with traits: ${le.error}`),{success:!1,error:le.error}}catch(ne){return ve.error("Clothing avatar generation with traits failed:",ne),{success:!1,error:String(ne)}}},async analyzePhoto(r,l,o,c,s){var E,g,S,R,V,M,N,k,f,q,j,x,O,xe,ne,T,L,z,F,W;try{const P=await Ke.post("/api/analyze-photo",{imageData:r,language:l,selectedFaceId:o,cachedFaces:c,existingCharacterId:s});if(!P.success)return{success:!1,error:P.error};if(P.multipleFacesDetected&&P.faces)return ve.info(`Multiple faces detected (${P.faceCount}), showing selection UI`),{success:!0,multipleFacesDetected:!0,faceCount:P.faceCount,faces:P.faces};const ee={height:(E=P.attributes)==null?void 0:E.height,build:(g=P.attributes)==null?void 0:g.build,face:(S=P.attributes)==null?void 0:S.face,eyeColor:((R=P.attributes)==null?void 0:R.eye_color)||((V=P.attributes)==null?void 0:V.eyeColor),hairColor:((M=P.attributes)==null?void 0:M.hair_color)||((N=P.attributes)==null?void 0:N.hairColor),hairLength:((k=P.attributes)==null?void 0:k.hair_length)||((f=P.attributes)==null?void 0:f.hairLength),hairStyle:((q=P.attributes)==null?void 0:q.hair_style)||((j=P.attributes)==null?void 0:j.hairStyle),hair:((x=P.attributes)==null?void 0:x.hair_color)||((O=P.attributes)==null?void 0:O.hairColor),other:(xe=P.attributes)==null?void 0:xe.other_features};return{success:P.success,characterId:P.characterId,multipleFacesDetected:!1,faceCount:P.faceCount,photos:{face:P.faceThumbnail,body:P.bodyCrop,bodyNoBg:P.bodyNoBg,faceBox:P.faceBox,bodyBox:P.bodyBox},age:(ne=P.attributes)==null?void 0:ne.age,apparentAge:(T=P.attributes)==null?void 0:T.apparent_age,gender:(L=P.attributes)==null?void 0:L.gender,physical:ee.height||ee.build||ee.face||ee.eyeColor||ee.hairColor||ee.hairLength||ee.hairStyle||ee.hair||ee.other?ee:void 0,clothing:(z=P.attributes)!=null&&z.clothing||(F=P.attributes)!=null&&F.clothingStyle||(W=P.attributes)!=null&&W.clothingColors?{current:P.attributes.clothing,style:P.attributes.clothingStyle||P.attributes.clothingColors}:void 0,_debug:P._debug}}catch(P){return ve.error("Photo analysis failed:",P),{success:!1,error:"unknown_error"}}},needsAvatars(r){var s,E,g,S;if(!!!((s=r.photos)!=null&&s.original||(E=r.photos)!=null&&E.face||(g=r.photos)!=null&&g.body||(S=r.photos)!=null&&S.bodyNoBg))return!1;const o=r.avatars;return o?o.status==="generating"||o.status==="pending"?!1:o.status==="failed"?!0:!!!(o.winter||o.standard||o.summer||o.formal||o.hasFullAvatars):!0},async generateAndSaveAvatarForCharacter(r,l,o){var s,E,g,S,R,V,M,N,k,f,q,j,x,O,xe,ne,T,L,z,F;const c={characterId:r.id,characterName:r.name,success:!1};try{if(!!!((s=r.photos)!=null&&s.original||(E=r.photos)!=null&&E.face||(g=r.photos)!=null&&g.body||(S=r.photos)!=null&&S.bodyNoBg))return c.skipped=!0,c.skipReason="No photo available",c;l==null||l("generating",`Generating avatars for ${r.name}...`),ve.info(`ðŸŽ¨ Generating avatars for ${r.name} (id: ${r.id})${o!=null&&o.avatarModel?`, model: ${o.avatarModel}`:""}`);const P=await Ge.generateClothingAvatars(r,o);if(!P.success||!P.avatars)return c.error=P.error||"Avatar generation failed",l==null||l("error",c.error),c;c.avatars=P.avatars,c.extractedTraits=P.extractedTraits,c.extractedClothing=P.extractedClothing,l==null||l("saving",`Fetching updated data for ${r.name}...`);let ee=null;const Q=30;for(let Ne=0;Ne<Q;Ne++){if(Ne>0){const Se=Math.min(500*Math.pow(1.2,Ne),3e3);ve.info(`[AVATAR] Retry ${Ne+1}/${Q}: waiting ${Math.round(Se)}ms for avatar data...`),await new Promise(b=>setTimeout(b,Se))}if(ee=await Ge.loadFullCharacter(r.id),(R=ee==null?void 0:ee.avatars)!=null&&R.standard||(V=ee==null?void 0:ee.avatars)!=null&&V.winter||(M=ee==null?void 0:ee.avatars)!=null&&M.summer){ve.info(`[AVATAR] Got fresh data with avatars on attempt ${Ne+1}`);break}}return ee?(c.character=ee,(N=ee.avatars)!=null&&N.standard||(k=ee.avatars)!=null&&k.winter||(f=ee.avatars)!=null&&f.summer||ve.warn(`âš ï¸ Fresh DB data for ${r.name} missing avatars after ${Q} retries - server may not have saved them`),ve.info(`ðŸ“‹ Using server-saved data for ${r.name}`)):(ve.error(`âŒ Character ${r.name} (id: ${r.id}) not found in DB after avatar job - avatars lost!`),c.character={...r,avatars:{status:"failed"},physical:P.extractedTraits?{...r.physical,apparentAge:P.extractedTraits.apparentAge||((q=r.physical)==null?void 0:q.apparentAge),build:P.extractedTraits.build||((j=r.physical)==null?void 0:j.build),eyeColor:P.extractedTraits.eyeColor||((x=r.physical)==null?void 0:x.eyeColor),eyeColorHex:P.extractedTraits.eyeColorHex||((O=r.physical)==null?void 0:O.eyeColorHex),hairColor:P.extractedTraits.hairColor||((xe=r.physical)==null?void 0:xe.hairColor),hairColorHex:P.extractedTraits.hairColorHex||((ne=r.physical)==null?void 0:ne.hairColorHex),hairLength:P.extractedTraits.hairLength||((T=r.physical)==null?void 0:T.hairLength),hairStyle:P.extractedTraits.hairStyle||((L=r.physical)==null?void 0:L.hairStyle),skinTone:P.extractedTraits.skinTone||((z=r.physical)==null?void 0:z.skinTone),skinToneHex:P.extractedTraits.skinToneHex||((F=r.physical)==null?void 0:F.skinToneHex)}:r.physical,clothing:P.extractedClothing?{...r.clothing,structured:{upperBody:P.extractedClothing.upperBody||void 0,lowerBody:P.extractedClothing.lowerBody||void 0,shoes:P.extractedClothing.shoes||void 0,fullBody:P.extractedClothing.fullBody||void 0}}:r.clothing}),c.success=!0,l==null||l("complete",`Avatars saved for ${r.name}`),ve.success(`âœ… Avatars generated and saved for ${r.name}`),c}catch(W){return c.error=String(W),l==null||l("error",c.error),ve.error(`Failed to generate/save avatars for ${r.name}:`,W),c}},async generateAvatarsForCharacters(r,l){const{forceRegenerate:o=!1,maxConcurrent:c=2,onProgress:s}=l||{};ve.info("ðŸŽ¨ Starting batch avatar generation...");const E=await Ge.getCharacterData();let g;if(r&&r.length>0?g=E.characters.filter(k=>r.includes(k.id)):g=E.characters.filter(k=>{var f,q;return o?!!((f=k.photos)!=null&&f.original||(q=k.photos)!=null&&q.face):Ge.needsAvatars(k)}),g.length===0)return ve.info("No characters need avatar generation"),{results:[],successCount:0,failCount:0,skipCount:0};ve.info(`Processing ${g.length} characters for avatar generation`);const S=[],R=new Map;for(let k=0;k<g.length;k+=c){const q=g.slice(k,k+c).map(async x=>{var xe,ne,T,L,z;const O={characterId:x.id,characterName:x.name,success:!1};try{if(!!!((xe=x.photos)!=null&&xe.original||(ne=x.photos)!=null&&ne.face||(T=x.photos)!=null&&T.body||(L=x.photos)!=null&&L.bodyNoBg))return O.skipped=!0,O.skipReason="No photo available",O;if(!o&&((z=x.avatars)!=null&&z.winter))return O.skipped=!0,O.skipReason="Avatars already exist",O;s==null||s(x.id,"generating",`Generating avatars for ${x.name}...`),ve.info(`ðŸŽ¨ Generating avatars for ${x.name}...`);const W=await Ge.generateClothingAvatars(x);return!W.success||!W.avatars?(O.error=W.error||"Avatar generation failed",s==null||s(x.id,"error",O.error),O):(O.avatars=W.avatars,O.success=!0,R.set(x.id,{...x,avatars:W.avatars}),s==null||s(x.id,"complete",`Avatars generated for ${x.name}`),ve.success(`âœ… Avatars generated for ${x.name}`),O)}catch(F){return O.error=String(F),s==null||s(x.id,"error",O.error),ve.error(`Failed to generate avatars for ${x.name}:`,F),O}}),j=await Promise.all(q);S.push(...j)}if(R.size>0){ve.info(`ðŸ’¾ Saving ${R.size} character avatar updates...`);const k=await Ge.getCharacterData(),f=k.characters.map(q=>R.get(q.id)||q);await Ge.saveCharacterData({...k,characters:f}),ve.success(`ðŸ’¾ Saved character data for ${R.size} characters`)}const V=S.filter(k=>k.success).length,M=S.filter(k=>!k.success&&!k.skipped).length,N=S.filter(k=>k.skipped).length;return ve.info(`Avatar generation complete: ${V} success, ${M} failed, ${N} skipped`),{results:S,successCount:V,failCount:M,skipCount:N}},async regenerateAvatarsForCharacter(r,l,o){ve.info(`ðŸ”„ Regenerating avatars for character ${r}...`);const s=(await Ge.getCharacterData()).characters.find(g=>g.id===r);if(!s)return{characterId:r,characterName:"Unknown",success:!1,error:"Character not found"};const E={...s,avatars:{status:"pending"}};return Ge.generateAndSaveAvatarForCharacter(E,l?(g,S)=>l(g,S):void 0,o)}},Ln={sm:"h-1",md:"h-2",lg:"h-3"},fo={default:"bg-indigo-600",success:"bg-green-500",warning:"bg-yellow-500",gradient:"bg-gradient-to-r from-indigo-500 to-indigo-600"};function bo({value:r,max:l=100,label:o,showPercentage:c=!1,size:s="md",variant:E="gradient",className:g=""}){const S=Math.min(Math.max(r/l*100,0),100);return e.jsxs("div",{className:g,children:[(o||c)&&e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[o&&e.jsx("span",{className:"text-sm font-medium text-gray-700",children:o}),c&&e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(S),"%"]})]}),e.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${Ln[s]}`,children:e.jsx("div",{className:`${Ln[s]} ${fo[E]} rounded-full transition-all duration-500 ease-out`,style:{width:`${S}%`}})})]})}const zr=hn("ImageLoad");function La({src:r,alt:l,className:o,label:c}){const[s,E]=i.useState(!0),[g,S]=i.useState(null),R=i.useRef(0),V=i.useRef(null);i.useEffect(()=>{r&&r.length>100?(R.current=Date.now(),zr.info(`â³ Loading ${c||l}`,{isBase64:r==null?void 0:r.startsWith("data:"),sizeKB:Math.round(r.length*3/4/1024)})):R.current=0,E(!0),S(null)},[r,l,c]);const M=()=>{if(E(!1),R.current===0){zr.info(`âœ… Loaded ${c||l} (placeholder/empty)`);return}const k=Date.now()-R.current;S(k);const q=(r==null?void 0:r.startsWith("data:"))?Math.round(r.length*3/4/1024):null,j=V.current?`${V.current.naturalWidth}x${V.current.naturalHeight}`:"unknown";k<100?zr.success(`âœ… Loaded ${c||l} in ${k}ms`,{sizeKB:q,naturalSize:j}):k<500?zr.info(`âœ… Loaded ${c||l} in ${k}ms`,{sizeKB:q,naturalSize:j}):k<2e3?zr.warn(`âš ï¸ Slow load: ${c||l} took ${k}ms`,{sizeKB:q,naturalSize:j}):zr.error(`ðŸ¢ Very slow: ${c||l} took ${k}ms`,{sizeKB:q,naturalSize:j}),k>1e3&&yo({type:"slow_image_load",label:c||l,loadTimeMs:k,sizeKB:q,naturalSize:j,userAgent:navigator.userAgent,timestamp:new Date().toISOString()})},N=()=>{if(E(!1),R.current===0){zr.error(`âŒ Failed to load ${c||l} (no data received)`);return}const k=Date.now()-R.current;zr.error(`âŒ Failed to load ${c||l} after ${k}ms`)};return e.jsx("img",{ref:V,src:r,alt:l,className:o,onLoad:M,onError:N,draggable:!1})}async function yo(r){try{await fetch("/api/log-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errorType:"Performance",message:`Slow image load: ${r.label} took ${r.loadTimeMs}ms`,userAgent:r.userAgent,timestamp:r.timestamp,url:window.location.href})})}catch{}}function vo({step:r,text:l}){const o=`wizard_helper_dismissed_${r}`,[c,s]=i.useState(()=>localStorage.getItem(o)==="true");i.useEffect(()=>{const g=localStorage.getItem(o)==="true";s(g)},[r,o]);const E=()=>{localStorage.setItem(o,"true"),s(!0)};return c?null:e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 md:px-4 md:py-3 mb-4 flex items-start gap-2 md:gap-3",children:[e.jsx("p",{className:"text-sm text-indigo-700 flex-1",children:l}),e.jsx("button",{onClick:E,className:"text-indigo-400 hover:text-indigo-600 transition-colors flex-shrink-0 p-0.5","aria-label":"Dismiss",children:e.jsx(zt,{size:16})})]})}function jo({current:r,total:l,message:o,isGenerating:c=!0,coverImages:s,jobId:E,onCancel:g,onMinimize:S,characters:R=[],isStalled:V=!1,onDismissStalled:M,isImpersonating:N=!1}){const{language:k}=lr(),{user:f}=xn(),q=(f==null?void 0:f.role)==="admin"||N,[j,x]=i.useState(!1),[O,xe]=i.useState(0),ne=[{en:"{name} is getting ready for their big adventure...",de:"{name} macht sich bereit fÃ¼r das grosse Abenteuer...",fr:"{name} se prÃ©pare pour sa grande aventure..."},{en:"{name} is practicing their hero pose...",de:"{name} Ã¼bt gerade die Heldenpose...",fr:"{name} s'entraÃ®ne Ã  prendre la pose du hÃ©ros..."},{en:"{name} can't wait to see what happens next!",de:"{name} kann es kaum erwarten zu sehen, was als NÃ¤chstes passiert!",fr:"{name} a hÃ¢te de voir ce qui va se passer !"},{en:"{name} is warming up for the adventure ahead...",de:"{name} wÃ¤rmt sich fÃ¼r das bevorstehende Abenteuer auf...",fr:"{name} s'Ã©chauffe pour l'aventure Ã  venir..."},{en:"{name} just found a magic feather! Adding it to the story...",de:"{name} hat gerade eine Zauberfeder gefunden! Wir fÃ¼gen sie der Geschichte hinzu...",fr:"{name} vient de trouver une plume magique ! On l'ajoute au rÃ©cit..."},{en:"{name} is whispering secrets to the story wizard...",de:"{name} flÃ¼stert dem Geschichtenzauberer Geheimnisse zu...",fr:"{name} chuchote des secrets au magicien des histoires..."},{en:"{name} is peeking around the corner to see what's coming...",de:"{name} schaut um die Ecke, um zu sehen, was kommt...",fr:"{name} jette un coup d'Å“il au coin pour voir ce qui arrive..."},{en:"{name} is doing a little happy dance!",de:"{name} macht einen kleinen Freudentanz!",fr:"{name} fait une petite danse de joie !"},{en:"{name} is collecting stars for the story...",de:"{name} sammelt Sterne fÃ¼r die Geschichte...",fr:"{name} collectionne des Ã©toiles pour le rÃ©cit..."},{en:"{name} just met a friendly dragon! Making friends...",de:"{name} hat gerade einen freundlichen Drachen getroffen! Sie werden Freunde...",fr:"{name} vient de rencontrer un dragon amical ! Ils deviennent amis..."}],T=i.useRef({}),[L,z]=i.useState(null),F=i.useMemo(()=>R.filter(te=>{var Z;const ge=te.avatars;return ge&&(((Z=ge.faceThumbnails)==null?void 0:Z.standard)||ge.standard||ge.summer||ge.winter||ge.formal||ge.hasFullAvatars)}),[R]),W=te=>{var Te;const ge=te.avatars;if(!ge)return"";if((Te=ge.faceThumbnails)!=null&&Te.standard)return ge.faceThumbnails.standard;const Z=[];return ge.standard&&Z.push(ge.standard),ge.summer&&Z.push(ge.summer),ge.winter&&Z.push(ge.winter),ge.formal&&Z.push(ge.formal),Z[Math.floor(Math.random()*Z.length)]||""},P=i.useMemo(()=>{const te=[{type:"message",key:"timeInfo"},{type:"message",key:"tipCharacters"},{type:"message",key:"emailInfo"},{type:"message",key:"tipStoryPlot"},{type:"message",key:"canClose"},{type:"message",key:"tipLocations"},{type:"message",key:"tipArtStyle"}];if(F.length===0)return te;const ge=[],Z=Math.max(te.length,F.length);for(let Te=0;Te<Z;Te++)ge.push(te[Te%te.length]),ge.push({type:"character",char:F[Te%F.length]});return ge},[F]);if(i.useEffect(()=>{if(P.length<=1)return;const te=setInterval(()=>{xe(ge=>(ge+1)%P.length)},8e3);return()=>clearInterval(te)},[P.length]),i.useEffect(()=>{if(P.length===0)return;const te=P[O];if(te.type==="character"){const ge=te.char,Z=W(ge),Me=((T.current[ge.id]??-1)+1)%ne.length;T.current[ge.id]=Me;const Je=ne[Me],vt=(k==="de"?Je.de:k==="fr"?Je.fr:Je.en).replace("{name}",ge.name);z({avatarUrl:Z,message:vt})}else z(null)},[O,P,k]),!c||l===0)return null;const ee=l===100?r:Math.round(r/l*100),Q=te=>{if(te)return typeof te=="string"?te:te.imageData},Ne=Q(s==null?void 0:s.frontCover),Se=Q(s==null?void 0:s.initialPage),b=Q(s==null?void 0:s.backCover),H=!!Ne,ie=!!Se,je=!!b,le=H||ie||je,G={en:{title:"Creating Your Story!",timeInfo:"Your story will start to display in about 1 minute. The full story can take up to 10 minutes.",emailInfo:"You will receive an email when your story is ready.",canClose:"You can wait here or close the browser - your story will keep generating.",tipCharacters:"The better you describe your characters, the more fun the story becomes!",tipStoryPlot:'"Story Plot / Story Details" lets you craft your own personal adventure.',tipLocations:'Add your hometown and favorite places to "Story Plot / Story Details" for a personal touch.',tipArtStyle:"What's your favorite art style? For picture books, watercolor works great!",coversPreview:"Cover Preview",frontCover:"Front",initialPage:"Inside",backCover:"Back",cancelJob:"Cancel Generation",cancelling:"Cancelling...",stalled:"Generation seems stuck",stalledDesc:"No progress for a while. This can happen due to high server load.",continueWaiting:"Keep Waiting",continueInBackground:"Continue in Background"},de:{title:"Geschichte wird erstellt!",timeInfo:"Deine Geschichte wird in etwa 1 Minute angezeigt. Die Erstellung der vollstÃ¤ndigen Geschichte kann bis zu 10 Minuten dauern.",emailInfo:"Du erhÃ¤ltst eine E-Mail, wenn deine Geschichte bereit ist.",canClose:"Du kannst hier warten oder den Browser schliessen - deine Geschichte wird weiter generiert.",tipCharacters:"Je besser du deine Charaktere beschreibst, desto lustiger wird die Geschichte!",tipStoryPlot:'Mit "Handlung / Angaben zur Geschichte" kannst du dein ganz persÃ¶nliches Abenteuer gestalten.',tipLocations:'FÃ¼ge deinen Heimatort und Lieblingsorte zu "Handlung / Angaben zur Geschichte" hinzu fÃ¼r eine persÃ¶nliche Note.',tipArtStyle:"Was ist dein Lieblings-Kunststil? FÃ¼r BilderbÃ¼cher funktioniert Aquarell besonders gut!",coversPreview:"Cover-Vorschau",frontCover:"Vorne",initialPage:"Innen",backCover:"Hinten",cancelJob:"Generierung abbrechen",cancelling:"Wird abgebrochen...",stalled:"Generierung scheint hÃ¤ngen zu bleiben",stalledDesc:"Seit einer Weile kein Fortschritt. Dies kann bei hoher Serverlast passieren.",continueWaiting:"Weiter warten",continueInBackground:"Im Hintergrund fortsetzen"},fr:{title:"CrÃ©ation de votre histoire!",timeInfo:"Votre rÃ©cit commencera Ã  s'afficher dans environ 1 minute. Le rÃ©cit complet peut prendre jusqu'Ã  10 minutes.",emailInfo:"Vous recevrez un email quand votre rÃ©cit sera prÃªt.",canClose:"Vous pouvez attendre ici ou fermer le navigateur - votre rÃ©cit continuera Ã  Ãªtre gÃ©nÃ©rÃ©.",tipCharacters:"Mieux vous dÃ©crivez vos personnages, plus le rÃ©cit sera amusant !",tipStoryPlot:'"Intrigue / Contexte du rÃ©cit" vous permet de crÃ©er votre propre aventure personnelle.',tipLocations:'Ajoutez votre ville et vos endroits prÃ©fÃ©rÃ©s Ã  "Intrigue / Contexte du rÃ©cit" pour une touche personnelle.',tipArtStyle:"Quel est votre style artistique prÃ©fÃ©rÃ© ? Pour les livres d'images, l'aquarelle fonctionne trÃ¨s bien !",coversPreview:"AperÃ§u des couvertures",frontCover:"Avant",initialPage:"IntÃ©rieur",backCover:"ArriÃ¨re",cancelJob:"Annuler la gÃ©nÃ©ration",cancelling:"Annulation...",stalled:"La gÃ©nÃ©ration semble bloquÃ©e",stalledDesc:"Aucun progrÃ¨s depuis un moment. Cela peut arriver en cas de forte charge serveur.",continueWaiting:"Continuer Ã  attendre",continueInBackground:"Continuer en arriÃ¨re-plan"}},I=G[k]||G.en,me=({imageData:te,label:ge,isReady:Z})=>e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden border-2 ${Z?"border-green-400":"border-gray-200"} bg-gray-100 flex items-center justify-center`,children:Z&&te?e.jsx("img",{src:te,alt:ge,className:"w-full h-full object-cover"}):e.jsx(Ze,{size:20,className:"animate-spin text-gray-400"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[Z&&e.jsx(ea,{size:12,className:"text-green-500"}),e.jsx("span",{className:`text-xs ${Z?"text-green-600 font-medium":"text-gray-400"}`,children:ge})]})]});return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:`bg-white rounded-2xl shadow-xl w-full p-6 md:p-8 ${le?"max-w-lg":"max-w-md"}`,children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("div",{className:"relative inline-block mb-3",children:[e.jsx(Ze,{size:48,className:"animate-spin text-indigo-600"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-xl",children:"âœ¨"})]}),e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:I.title})]}),!le&&P.length>0&&e.jsx("div",{className:"mb-6 min-h-[220px] flex items-center justify-center",children:(()=>{const te=P[O];if(te.type==="character"&&L)return e.jsxs("div",{className:"flex flex-col items-center gap-3 animate-fade-in",children:[e.jsx("div",{className:"w-32 h-44 md:w-40 md:h-52 rounded-xl overflow-hidden border-4 border-indigo-200 shadow-lg bg-gradient-to-b from-indigo-50 to-purple-50",children:e.jsx("img",{src:L.avatarUrl,alt:te.char.name,className:"w-full h-full object-contain"})}),e.jsx("p",{className:"text-sm text-center text-gray-600 max-w-xs italic",children:L.message})]},`char-${te.char.id}-${O}`);if(te.type==="message"){const ge=te.key,Z=I[ge]||"",Te=ge==="timeInfo"?e.jsx(Ki,{size:20,className:"text-indigo-500 shrink-0"}):ge==="emailInfo"?e.jsx(Xn,{size:20,className:"text-indigo-500 shrink-0"}):e.jsx(ea,{size:20,className:"text-indigo-500 shrink-0"});return e.jsxs("div",{className:"flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 max-w-sm animate-fade-in",children:[Te,e.jsx("p",{className:"text-sm text-gray-700",children:Z})]})}return null})()}),le&&e.jsxs("div",{className:"mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-indigo-700 text-center mb-3",children:I.coversPreview}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(me,{imageData:Ne,label:I.frontCover,isReady:H}),e.jsx(me,{imageData:Se,label:I.initialPage,isReady:ie}),e.jsx(me,{imageData:b,label:I.backCover,isReady:je})]})]}),le&&e.jsxs("div",{className:"mb-4 text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center gap-2",children:[e.jsx(Ze,{size:14,className:"animate-spin text-indigo-500"}),k==="de"?"Bilder fÃ¼r die Seiten werden jetzt erstellt...":k==="fr"?"CrÃ©ation des images pour les pages en cours...":"Now generating images for the pages..."]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:k==="de"?"Dies kann einige Minuten dauern. Du kannst den Browser schliessen.":k==="fr"?"Cela peut prendre quelques minutes. Vous pouvez fermer le navigateur.":"This may take a few minutes. You can close the browser."})]}),e.jsx("div",{className:"mb-4",children:e.jsx(bo,{value:ee,max:100,showPercentage:!0,size:"lg"})}),S&&e.jsx("button",{onClick:S,className:"w-full mb-4 px-4 py-2.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors text-sm",children:I.continueInBackground}),V&&e.jsx("div",{className:"mb-4 bg-amber-50 border border-amber-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(pn,{className:"w-5 h-5 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-amber-800 mb-1",children:I.stalled}),e.jsx("p",{className:"text-sm text-amber-700 mb-3",children:I.stalledDesc}),e.jsxs("div",{className:"flex gap-2",children:[M&&e.jsx("button",{onClick:M,className:"px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm font-medium transition-colors",children:I.continueWaiting}),g&&e.jsx("button",{onClick:()=>{if(!j){x(!0);try{g()}finally{x(!1)}}},disabled:j,className:"px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:j?I.cancelling:I.cancelJob})]})]})]})}),q&&E&&g&&e.jsxs("button",{onClick:async()=>{if(!j){x(!0);try{g()}finally{x(!1)}}},disabled:j,className:"mt-4 w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium transition-colors disabled:opacity-50",children:[j?e.jsx(Ze,{size:16,className:"animate-spin"}):e.jsx(fn,{size:16}),j?I.cancelling:I.cancelJob]})]})})}function Xs(r,l){const o=new Blob([r],{type:"text/plain;charset=utf-8"}),c=URL.createObjectURL(o),s=document.createElement("a");s.href=c,s.download=l,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(c)}function un(r,l=0){const o="  ".repeat(l);if(r==null)return`${o}null`;if(typeof r=="boolean")return`${o}${r?"YES":"NO"}`;if(typeof r=="number")return`${o}${r}`;if(typeof r=="string")return`${o}${r}`;if(Array.isArray(r))return r.length===0?`${o}[]`:r.map((c,s)=>`${o}[${s}]: ${un(c,0)}`).join(`
`);if(typeof r=="object"){const c=Object.entries(r);return c.length===0?`${o}{}`:c.map(([s,E])=>{const g=un(E,l+1);return typeof E=="object"&&E!==null?`${o}${s}:
${g}`:`${o}${s}: ${g.trim()}`}).join(`
`)}return`${o}${String(r)}`}function Ga({data:r,language:l,title:o}){const[c,s]=i.useState(new Set);if(!r)return e.jsx("div",{className:"text-gray-400 italic text-sm",children:l==="de"?"Keine Daten":"No data"});let E=r;if(typeof r=="string")try{E=JSON.parse(r)}catch{return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-end mb-1",children:e.jsxs("button",{onClick:()=>Xs(r,`${o||"evaluation"}.txt`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Download as text file",children:[e.jsx(rs,{size:12})," Download"]})}),e.jsx("pre",{className:"text-sm whitespace-pre-wrap bg-gray-50 p-3 rounded max-h-80 overflow-auto font-mono",children:r})]})}const g=V=>{const M=new Set(c);M.has(V)?M.delete(V):M.add(V),s(M)},S=()=>{const V=un(E);Xs(V,`${o||"evaluation"}.txt`)},R=(V,M,N=0)=>{const k=c.has(V);if(M==null)return e.jsx("span",{className:"text-gray-400",children:"null"});if(typeof M=="boolean")return e.jsx("span",{className:M?"text-green-600 font-medium":"text-red-600 font-medium",children:M?"âœ“":"âœ—"});if(typeof M=="number"){const f=M>=70?"text-green-600":M>=50?"text-yellow-600":"text-red-600";return e.jsx("span",{className:`font-bold ${f}`,children:M})}if(typeof M=="string")return M.length>100?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>g(V),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[k?e.jsx(Mt,{size:14}):e.jsx(Ss,{size:14}),k?"Collapse":`Show (${M.length} chars)`]}),k&&e.jsx("div",{className:"mt-1 p-2 bg-gray-100 rounded text-sm whitespace-pre-wrap font-mono",children:M})]}):e.jsx("span",{className:"text-gray-700",children:M});if(Array.isArray(M))return M.length===0?e.jsx("span",{className:"text-gray-400",children:"[]"}):e.jsx("div",{className:"ml-2 border-l-2 border-gray-200 pl-2",children:M.map((f,q)=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"text-gray-400 text-xs",children:["[",q,"]"]})," ",R(`${V}.${q}`,f,N+1)]},q))});if(typeof M=="object"){const f=Object.entries(M);return f.length===0?e.jsx("span",{className:"text-gray-400",children:"{}"}):N>0?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>g(V),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[k?e.jsx(Mt,{size:14}):e.jsx(Ss,{size:14}),k?"Collapse":`{${f.length} fields}`]}),k&&e.jsx("div",{className:"ml-2 mt-1 border-l-2 border-gray-200 pl-2",children:f.map(([q,j])=>e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium text-gray-600",children:[q,":"]})," ",R(`${V}.${q}`,j,N+1)]},q))})]}):e.jsx("div",{className:"space-y-1",children:f.map(([q,j])=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-medium text-gray-600 min-w-[100px]",children:[q,":"]}),e.jsx("div",{className:"flex-1",children:R(`${V}.${q}`,j,N+1)})]},q))})}return e.jsx("span",{children:String(M)})};return e.jsxs("div",{className:"text-sm space-y-1 max-h-[500px] overflow-auto",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:S,className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",title:"Download as text file",children:[e.jsx(rs,{size:12})," Download"]})}),R("root",E)]})}function No({beforeImage:r,maskImage:l,onEnlarge:o}){return e.jsxs("div",{className:"relative w-40 h-40 cursor-pointer hover:ring-2 hover:ring-amber-400 rounded overflow-hidden border",onClick:()=>o(r,"Before with Mask"),children:[e.jsx("img",{src:r,alt:"Before",className:"w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 w-full h-full",style:{backgroundImage:`url(${l})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",mixBlendMode:"multiply",opacity:.5}}),e.jsx("img",{src:l,alt:"Mask overlay",className:"absolute inset-0 w-full h-full object-contain pointer-events-none",style:{mixBlendMode:"screen",opacity:.7,filter:"sepia(1) saturate(5) hue-rotate(-50deg)"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-[10px] text-center py-1 font-medium",children:"ðŸŽ¯ Edit Area"})]})}function js({retryHistory:r,totalAttempts:l,language:o,onRevertRepair:c,storyId:s,pageNumber:E}){const[g,S]=i.useState(null),[R,V]=i.useState({}),[M,N]=i.useState(new Set),k=async x=>{if(!(!s||E===void 0||M.has(x))){N(O=>new Set(O).add(x));try{const O=localStorage.getItem("auth_token"),xe=new URLSearchParams({page:String(E),type:"retry",index:String(x)}),ne=await fetch(`/api/stories/${s}/dev-image?${xe}`,{headers:O?{Authorization:`Bearer ${O}`}:{}});if(ne.ok){const T=await ne.json();V(L=>({...L,[x]:{imageData:T.imageData,annotatedOriginal:T.annotatedOriginal,grids:T.grids,bboxOverlayImage:T.bboxOverlayImage}}))}}catch(O){console.error(`Failed to load retry images for retry ${x}:`,O)}finally{N(O=>{const xe=new Set(O);return xe.delete(x),xe})}}};if(!r||r.length===0)return null;const f=r.filter(x=>x.type==="auto_repair"||x.type==="grid_repair"||x.type==="grid_repair_failed").length,q=r.filter(x=>x.type==="grid_repair"||x.type==="grid_repair_failed").length,j=r.filter(x=>x.type==="grid_repair_failed").length;return e.jsxs(e.Fragment,{children:[g&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>S(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:g.title}),e.jsx("img",{src:g.src,alt:g.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>S(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-purple-700 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ji,{size:14}),o==="de"?"Generierungshistorie":o==="fr"?"Historique de gÃ©nÃ©ration":"Generation History",f>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["ðŸ”§ ",f," ",o==="de"?"Reparatur":"repair",f>1?o==="de"?"en":"s":"",q>0&&e.jsxs("span",{className:"ml-1",children:["(",q," grid",j>0?`, ${j} failed`:"",")"]})]})]}),e.jsxs("span",{className:"text-purple-600",children:[l," ",o==="de"?"Versuche":o==="fr"?"tentatives":"attempts"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:r.map((x,O)=>{var xe,ne;return e.jsxs("div",{className:`border rounded-lg p-3 ${x.type==="grid_repair_failed"?"bg-red-50 border-red-300":x.type==="grid_repair"?"bg-violet-50 border-violet-300":x.type==="auto_repair"?"bg-amber-50 border-amber-300":O===r.length-1?"bg-green-50 border-green-300":"bg-white border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[x.type==="grid_repair_failed"?e.jsx("span",{className:"text-red-700",children:"ðŸ”² Grid Repair Failed"}):x.type==="grid_repair"?e.jsx("span",{className:"text-violet-700",children:"ðŸ”² Grid Repair"}):x.type==="auto_repair"?e.jsx("span",{className:"text-amber-700",children:"ðŸ”§ Auto-Repair"}):e.jsx(e.Fragment,{children:o==="de"?`Versuch ${x.attempt}`:o==="fr"?`Tentative ${x.attempt}`:`Attempt ${x.attempt}`}),x.type==="text_edit"&&e.jsx("span",{className:"text-xs ml-2 text-blue-600",children:"(text edit)"}),x.type==="text_edit_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(text edit failed)"}),x.type==="auto_repair_failed"&&e.jsx("span",{className:"text-xs ml-2 text-red-600",children:"(auto-repair failed)"}),O===r.length-1&&x.type!=="auto_repair"&&e.jsx("span",{className:"text-xs ml-2 text-green-600 font-bold",children:"âœ“ USED"})]}),x.type==="auto_repair"&&x.preRepairScore!==void 0&&x.postRepairScore!==void 0?e.jsxs("span",{className:"font-bold text-sm",children:[e.jsxs("span",{className:x.preRepairScore>=70?"text-green-600":x.preRepairScore>=50?"text-yellow-600":"text-red-600",children:[x.preRepairScore,"%"]}),e.jsx("span",{className:"text-gray-400 mx-1",children:"â†’"}),e.jsxs("span",{className:x.postRepairScore>=70?"text-green-600":x.postRepairScore>=50?"text-yellow-600":"text-red-600",children:[x.postRepairScore,"%"]})]}):x.score!==void 0&&e.jsxs("span",{className:`font-bold ${x.score>=70?"text-green-600":x.score>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(x.score),"%"]})]}),x.error&&e.jsxs("div",{className:"text-xs text-red-600 mb-2",children:["Error: ",x.error]}),x.textIssue&&x.textIssue!=="NONE"&&e.jsxs("div",{className:"text-xs text-orange-600 mb-2",children:["Text issue: ",x.textIssue,x.expectedText&&e.jsxs("span",{className:"block",children:['Expected: "',x.expectedText,'"']}),x.actualText&&e.jsxs("span",{className:"block",children:['Actual: "',x.actualText,'"']})]}),x.type==="auto_repair"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[x.fixTargetsCount&&e.jsxs("div",{className:"text-xs text-amber-700",children:["Fixed ",x.fixTargetsCount," target",x.fixTargetsCount>1?"s":""]}),c&&((ne=(xe=x.repairDetails)==null?void 0:xe[0])==null?void 0:ne.beforeImage)&&x.postRepairScore!==void 0&&x.preRepairScore!==void 0&&x.postRepairScore<=x.preRepairScore&&e.jsxs("button",{onClick:()=>c(O,x.repairDetails[0].beforeImage),className:"text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded border border-red-300 transition-colors",children:["â†©ï¸ ",o==="de"?"ZurÃ¼cksetzen":"Revert to Original"]})]}),x.postRepairScore!==void 0&&x.preRepairScore!==void 0&&x.postRepairScore<x.preRepairScore&&e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200",children:["âš ï¸ ",o==="de"?`Bewertung verschlechtert: ${x.preRepairScore}% â†’ ${x.postRepairScore}%`:`Score decreased: ${x.preRepairScore}% â†’ ${x.postRepairScore}%`]}),x.bboxDetection&&Array.isArray(x.bboxDetection)&&x.bboxDetection.length>0&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900",children:["ðŸ“¦ ",o==="de"?"Bounding Box Erkennung":"Bounding Box Detection"," (",x.bboxDetection.length,")"]}),e.jsx("div",{className:"mt-3 space-y-2",children:x.bboxDetection.map((T,L)=>e.jsxs("div",{className:`p-3 rounded-lg border ${T.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:`font-medium text-sm ${T.success?"text-green-800":"text-red-800"}`,children:[T.success?"âœ“":"âœ—"," ",T.issue.substring(0,60),T.issue.length>60?"...":""]}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${T.severity==="CRITICAL"?"bg-red-200 text-red-800":T.severity==="MAJOR"?"bg-orange-200 text-orange-800":T.severity==="MODERATE"?"bg-yellow-200 text-yellow-800":"bg-gray-200 text-gray-800"}`,children:[T.severity," â€¢ ",T.type]})]}),T.success&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${T.faceBox?"bg-purple-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-purple-800",children:"Face Box:"}),T.faceBox?e.jsxs("span",{className:"ml-1 font-mono text-purple-600",children:["[",T.faceBox.map(z=>(z*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]}),e.jsxs("div",{className:`p-2 rounded ${T.bodyBox?"bg-blue-100":"bg-gray-100"}`,children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Body Box:"}),T.bodyBox?e.jsxs("span",{className:"ml-1 font-mono text-blue-600",children:["[",T.bodyBox.map(z=>(z*100).toFixed(0)+"%").join(", "),"]"]}):e.jsx("span",{className:"ml-1 text-gray-500 italic",children:"not detected"})]})]}),T.label&&T.label!==T.issue&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Detected as:"})," ",T.label]}),T.usage&&e.jsxs("div",{className:"mt-1 text-xs text-gray-400",children:["Tokens: ",T.usage.input_tokens," in / ",T.usage.output_tokens," out"]})]},L))})]}),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ“Š ",o==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[x.preRepairScore,"%"]})]}),e.jsx(Ga,{data:x.preRepairEval||x.reasoning,language:o,title:`evaluation-before-attempt-${O}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[x.postRepairScore,"%"]})]}),e.jsx(Ga,{data:x.postRepairEval,language:o,title:`evaluation-after-attempt-${O}`})]})]})]}),x.repairDetails&&x.repairDetails.length>0&&e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-amber-700 font-medium hover:text-amber-900",children:["ðŸ–¼ï¸ ",o==="de"?"Reparatur-Details":"Repair Details"," (",x.repairDetails.length,")"]}),e.jsx("div",{className:"mt-3 space-y-3",children:x.repairDetails.map((T,L)=>{var z,F;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("div",{className:"font-medium text-amber-800 text-base",children:T.description}),T.modelId&&e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded",children:T.modelId})]}),e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:["Show fix prompt",e.jsxs("button",{onClick:W=>{W.stopPropagation(),Xs(T.fullPrompt||T.fixPrompt||"",`fix-prompt-${L}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(rs,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:T.fullPrompt||T.fixPrompt})]}),e.jsxs("div",{className:"flex gap-4 items-start",children:[T.beforeImage&&T.maskImage?e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before + Mask"}),e.jsx(No,{beforeImage:T.beforeImage,maskImage:T.maskImage,onEnlarge:(W,P)=>S({src:W,title:P})})]}):T.beforeImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"Before"}),e.jsx("img",{src:T.beforeImage,alt:"Before",className:"w-32 h-32 object-contain border rounded cursor-pointer hover:ring-2 hover:ring-amber-400",onClick:()=>S({src:T.beforeImage,title:"Before Repair"})})]}),e.jsx("div",{className:"flex items-center h-32 text-gray-400 text-2xl",children:"â†’"}),T.afterImage&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:"After"}),e.jsx("img",{src:T.afterImage,alt:"After",className:"w-32 h-32 object-contain border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>S({src:T.afterImage,title:"After Repair"})})]})]}),T.verification&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded border text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"ðŸ” Verification:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[T.verification.lpips&&e.jsxs("div",{className:`p-2 rounded ${T.verification.lpips.changed?"bg-green-100":"bg-yellow-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LPIPS: "}),e.jsx("span",{className:T.verification.lpips.changed?"text-green-700":"text-yellow-700",children:(z=T.verification.lpips.lpipsScore)==null?void 0:z.toFixed(4)}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",T.verification.lpips.changed?"âœ“ changed":"âš  unchanged",")"]})]}),T.verification.llm&&e.jsxs("div",{className:`p-2 rounded ${T.verification.llm.fixed?"bg-green-100":"bg-red-100"}`,children:[e.jsx("span",{className:"font-medium",children:"LLM: "}),e.jsx("span",{className:T.verification.llm.fixed?"text-green-700":"text-red-700",children:T.verification.llm.fixed?"âœ“ Fixed":"âœ— Not fixed"}),e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",Math.round(T.verification.llm.confidence*100),"%)"]})]})]}),((F=T.verification.llm)==null?void 0:F.explanation)&&e.jsx("div",{className:"mt-2 text-gray-600 text-sm italic",children:T.verification.llm.explanation})]})]},L)})})]})]}),(x.type==="grid_repair"||x.type==="grid_repair_failed")&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[x.gridTotalIssues!==void 0&&e.jsxs("span",{className:"text-violet-700",children:[o==="de"?"Probleme:":"Issues:"," ",x.gridTotalIssues]}),x.gridFixedCount!==void 0&&e.jsxs("span",{className:"text-green-600",children:["âœ“ ",o==="de"?"Behoben:":"Fixed:"," ",x.gridFixedCount]}),x.gridFailedCount!==void 0&&x.gridFailedCount>0&&e.jsxs("span",{className:"text-red-600",children:["âœ— ",o==="de"?"Fehlgeschlagen:":"Failed:"," ",x.gridFailedCount]})]}),x.type==="grid_repair_failed"&&x.failReason&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-100 p-2 rounded border border-red-200",children:["âš ï¸ ",o==="de"?"Fehlergrund:":"Failure reason:"," ",x.failReason==="no_repairs_made"?o==="de"?"Keine Reparaturen durchgefÃ¼hrt":"No repairs were made":x.failReason==="no_image_data"?o==="de"?"Keine Bilddaten zurÃ¼ckgegeben":"No image data returned":x.failReason==="image_too_small"?o==="de"?"ZurÃ¼ckgegebenes Bild zu klein/ungÃ¼ltig":"Returned image too small/invalid":x.failReason==="image_unchanged"?o==="de"?"Bild wurde nicht verÃ¤ndert":"Image was not changed":x.failReason]}),(()=>{var L;const T=x.annotatedOriginal||((L=R[O])==null?void 0:L.annotatedOriginal);return T?e.jsxs("details",{className:"text-sm",open:!0,children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“ ",o==="de"?"Schritt 1: Erkannte Probleme":"Step 1: Detected Issues"]}),e.jsxs("div",{className:"mt-3 bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-2 font-medium",children:[o==="de"?"Originalbild mit markierten Problembereichen":"Original image with marked issue regions",e.jsxs("span",{className:"ml-2 text-gray-400",children:["(ðŸ”´ ",o==="de"?"kritisch":"critical",", ðŸŸ  ",o==="de"?"wichtig":"major",", ðŸŸ¡ ",o==="de"?"gering":"minor",")"]})]}),e.jsx("img",{src:`data:image/jpeg;base64,${T}`,alt:"Annotated original",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>S({src:`data:image/jpeg;base64,${T}`,title:o==="de"?"Erkannte Probleme":"Detected Issues"})})]})]}):x.hasAnnotatedOriginal&&s&&E!==void 0?e.jsx("button",{onClick:()=>k(O),disabled:M.has(O),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:M.has(O)?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{size:14,className:"animate-spin"})," Loading..."]}):e.jsx(e.Fragment,{children:"ðŸ“ Load Detected Issues"})}):null})(),e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ“Š ",o==="de"?"Bewertungen anzeigen":"View Evaluations"]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-red-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-red-100 px-2 py-0.5 rounded",children:"Before"}),e.jsxs("span",{className:"text-red-600",children:[x.preRepairScore,"%"]})]}),e.jsx(Ga,{data:x.preRepairEval||x.reasoning,language:o,title:`evaluation-before-grid-${O}`})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border-2 border-green-200 shadow-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-2 text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-green-100 px-2 py-0.5 rounded",children:"After"}),e.jsxs("span",{className:"text-green-600",children:[x.postRepairScore,"%"]})]}),e.jsx(Ga,{data:x.postRepairEval,language:o,title:`evaluation-after-grid-${O}`})]})]})]}),(()=>{var L,z;const T=x.grids||((L=R[O])==null?void 0:L.grids);return T&&T.length>0?e.jsxs("details",{className:"text-sm",children:[e.jsxs("summary",{className:"cursor-pointer text-violet-700 font-medium hover:text-violet-900",children:["ðŸ”² ",o==="de"?"Grid-Details":"Grid Details"," (",T.length," ",T.length===1?"grid":"grids",")"]}),e.jsx("div",{className:"mt-3 space-y-4",children:T.map((F,W)=>{var P,ee;return e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("span",{className:"font-medium text-violet-800",children:["Grid"," ",F.batchNum||W+1]}),((P=F.manifest)==null?void 0:P.issues)&&e.jsxs("span",{className:"text-xs text-gray-500",children:[F.manifest.issues.length," ",o==="de"?"Regionen":"regions"]})]}),((ee=F.manifest)==null?void 0:ee.issues)&&F.manifest.issues.length>0&&e.jsxs("div",{className:"mb-3 p-2 bg-violet-50 rounded text-sm",children:[e.jsx("div",{className:"font-medium text-violet-800 mb-1",children:o==="de"?"Zu reparierende Probleme:":"Issues to repair:"}),e.jsx("div",{className:"space-y-1",children:F.manifest.issues.map((Q,Ne)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"font-mono font-bold text-violet-600 min-w-[20px]",children:[Q.letter,":"]}),e.jsx("span",{className:"text-gray-700",children:Q.fixInstruction||Q.description||"Unknown issue"})]},Ne))})]}),F.prompt&&e.jsxs("details",{className:"mb-3",children:[e.jsxs("summary",{className:"text-gray-500 cursor-pointer hover:text-gray-700 text-sm flex items-center gap-2",children:[o==="de"?"Reparatur-Prompt anzeigen":"Show repair prompt",e.jsxs("button",{onClick:Q=>{Q.stopPropagation(),Xs(F.prompt||"",`grid-repair-prompt-${W}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(rs,{size:10})," Download"]})]}),e.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap font-mono max-h-[500px] overflow-auto",children:F.prompt})]}),e.jsxs("div",{className:"flex gap-4 items-start flex-wrap",children:[F.original&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Original-Grid":"Input Grid"}),e.jsx("img",{src:F.original.startsWith("data:")?F.original:`data:image/png;base64,${F.original}`,alt:"Input grid",className:"max-w-xs border rounded cursor-pointer hover:ring-2 hover:ring-violet-400",onClick:()=>S({src:F.original.startsWith("data:")?F.original:`data:image/png;base64,${F.original}`,title:o==="de"?"Original-Grid":"Input Grid"})})]}),F.original&&F.repaired&&e.jsx("div",{className:"flex items-center self-center text-gray-400 text-2xl",children:"â†’"}),F.repaired&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Repariertes Grid":"Repaired Grid"}),e.jsx("img",{src:F.repaired.startsWith("data:")?F.repaired:`data:image/png;base64,${F.repaired}`,alt:"Repaired grid",className:"max-w-xs border-2 border-green-300 rounded cursor-pointer hover:ring-2 hover:ring-green-400",onClick:()=>S({src:F.repaired.startsWith("data:")?F.repaired:`data:image/png;base64,${F.repaired}`,title:o==="de"?"Repariertes Grid":"Repaired Grid"})})]})]}),F.repairs&&F.repairs.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"font-medium text-violet-800 mb-2",children:["âœ… ",o==="de"?"Verifizierungsergebnisse":"Verification Results"]}),e.jsx("div",{className:"space-y-2",children:F.repairs.map((Q,Ne)=>{var Se,b,H,ie,je,le,G,I,me,te,ge,Z;return e.jsxs("div",{className:`mb-3 p-3 rounded-lg border ${(Se=Q.verification)!=null&&Se.accepted?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:"font-mono font-bold text-xl text-violet-600 w-8",children:Q.letter}),e.jsxs("div",{className:"flex items-center gap-2",children:[Q.originalThumbnail&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:o==="de"?"Vorher":"Before"}),e.jsx("img",{src:`data:image/jpeg;base64,${Q.originalThumbnail}`,alt:"Before",className:"w-16 h-16 object-contain cursor-pointer hover:ring-2 hover:ring-violet-400 rounded border",onClick:()=>S({src:`data:image/jpeg;base64,${Q.originalThumbnail}`,title:`${Q.letter}: Before`})})]}),Q.repairedThumbnail&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:o==="de"?"Nachher":"After"}),e.jsx("img",{src:`data:image/jpeg;base64,${Q.repairedThumbnail}`,alt:"After",className:`w-16 h-16 object-contain cursor-pointer hover:ring-2 rounded border ${(b=Q.verification)!=null&&b.accepted?"border-green-300":"border-red-300"}`,onClick:()=>S({src:`data:image/jpeg;base64,${Q.repairedThumbnail}`,title:`${Q.letter}: After`})})]}),Q.diffImage&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Diff"}),e.jsx("img",{src:`data:image/jpeg;base64,${Q.diffImage}`,alt:"Diff",className:"w-16 h-16 object-contain cursor-pointer hover:ring-2 hover:ring-purple-400 rounded border",onClick:()=>S({src:`data:image/jpeg;base64,${Q.diffImage}`,title:`${Q.letter}: Diff`})})]})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-3",children:[e.jsx("span",{className:`text-2xl ${(H=Q.verification)!=null&&H.accepted?"text-green-600":"text-red-600"}`,children:(ie=Q.verification)!=null&&ie.accepted?"âœ“":"âœ—"}),e.jsxs("span",{className:`text-lg font-medium ${(((je=Q.verification)==null?void 0:je.confidence)??0)>=.7?"text-green-600":(((le=Q.verification)==null?void 0:le.confidence)??0)>=.5?"text-yellow-600":"text-red-600"}`,children:[Math.round((((G=Q.verification)==null?void 0:G.confidence)??0)*100),"%"]})]})]}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsx("span",{className:`inline-block px-2 py-0.5 rounded text-xs mr-2 ${Q.severity==="critical"?"bg-red-200 text-red-800":Q.severity==="major"?"bg-orange-200 text-orange-800":"bg-yellow-200 text-yellow-800"}`,children:Q.type||"unknown"}),e.jsx("span",{className:"text-gray-700",children:Q.description})]}),Q.fixInstruction&&e.jsxs("div",{className:"mt-1 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Fix:"})," ",Q.fixInstruction]}),(((I=Q.verification)==null?void 0:I.explanation)||((me=Q.verification)==null?void 0:me.reason))&&e.jsxs("div",{className:`mt-2 text-sm p-2 rounded ${(te=Q.verification)!=null&&te.accepted?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:[e.jsx("span",{className:"font-medium",children:o==="de"?"Ergebnis:":"Result:"})," ",((ge=Q.verification)==null?void 0:ge.explanation)||((Z=Q.verification)==null?void 0:Z.reason)]})]},Ne)})})]})]},W)})})]}):x.hasGrids&&s&&E!==void 0&&!((z=R[O])!=null&&z.grids)?e.jsx("button",{onClick:()=>k(O),disabled:M.has(O),className:"text-sm px-3 py-2 bg-violet-100 hover:bg-violet-200 text-violet-700 rounded border border-violet-300 flex items-center gap-2 disabled:opacity-50",children:M.has(O)?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ”² Load Grid Details (",x.gridsCount||"?"," grids)"]})}):null})()]}),x.type!=="auto_repair"&&x.type!=="grid_repair"&&x.type!=="grid_repair_failed"&&x.prompt&&e.jsxs("details",{className:"text-sm mb-2",children:[e.jsxs("summary",{className:"cursor-pointer text-blue-700 font-medium hover:text-blue-900 flex items-center gap-2",children:["ðŸ“¤ ",o==="de"?"Eingabe-Prompt":"Input Prompt",e.jsxs("button",{onClick:T=>{T.stopPropagation(),Xs(x.prompt||"",`prompt-attempt-${x.attempt}.txt`)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded",children:[e.jsx(rs,{size:10})," Download"]})]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-blue-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono border border-blue-200",children:x.prompt})]}),x.type!=="auto_repair"&&x.type!=="grid_repair"&&x.type!=="grid_repair_failed"&&x.reasoning?e.jsxs("details",{className:"text-sm text-gray-600 mb-2",children:[e.jsxs("summary",{className:"cursor-pointer font-medium",children:["ðŸ“¥ ",o==="de"?"Bewertungs-Feedback":"Evaluation Feedback"]}),e.jsx("pre",{className:"mt-2 whitespace-pre-wrap bg-gray-50 p-3 rounded text-sm overflow-auto max-h-[500px] font-mono",children:x.reasoning})]}):x.type!=="auto_repair"&&x.type!=="grid_repair"&&x.type!=="grid_repair_failed"&&x.score===0&&e.jsx("div",{className:"text-sm text-gray-500 italic mb-2",children:o==="de"?"QualitÃ¤tsbewertung fehlgeschlagen":o==="fr"?"Ã‰valuation de qualitÃ© Ã©chouÃ©e":"Quality evaluation failed"}),(()=>{var L;if(x.type==="auto_repair"||x.type==="grid_repair"||x.type==="grid_repair_failed"||x.type==="bbox_detection_only")return null;const T=x.imageData||((L=R[O])==null?void 0:L.imageData);return T?e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:o==="de"?"Generiertes Bild":"Generated Image"}),e.jsx("img",{src:T,alt:`Attempt ${x.attempt}`,className:`w-48 h-48 object-contain rounded border cursor-pointer hover:ring-2 ${O===r.length-1?"border-green-300 hover:ring-green-400":"border-gray-200 opacity-75 hover:ring-gray-400"}`,onClick:()=>S({src:T,title:`${o==="de"?"Versuch":"Attempt"} ${x.attempt}`})})]}):x.type==="generation"&&s&&E!==void 0&&!R[O]?e.jsx("button",{onClick:()=>k(O),disabled:M.has(O),className:"mt-2 text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:M.has(O)?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{size:14,className:"animate-spin"})," Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ–¼ï¸ ",o==="de"?"Bild laden":"Load Image"]})}):null})(),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(x.timestamp).toLocaleTimeString()})]},O)})})]})]})}function wo(r){if(!r||r.length===0)return{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1};const l=r.find(c=>c.type==="bbox_detection_only"&&c.bboxDetection)||r.find(c=>c.bboxDetection);if(!l)return{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1};const o=l.bboxDetection;return o&&typeof o=="object"&&"figures"in o?{bboxDetection:o,bboxOverlayImage:l.bboxOverlayImage||null,hasBboxOverlay:!!l.hasBboxOverlay||!!l.bboxOverlayImage}:{bboxDetection:null,bboxOverlayImage:null,hasBboxOverlay:!1}}function So(r,l){const o=new Blob([r],{type:"text/plain;charset=utf-8"}),c=URL.createObjectURL(o),s=document.createElement("a");s.href=c,s.download=l,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(c)}function Zs({retryHistory:r,bboxDetection:l,bboxOverlayImage:o,language:c,storyId:s,pageNumber:E}){var T,L;const[g,S]=i.useState(null),[R,V]=i.useState(null),[M,N]=i.useState(!1),k=wo(r),f=l||k.bboxDetection,q=o||k.bboxOverlayImage,j=!!o||k.hasBboxOverlay;if(!f)return null;const x=((T=f.figures)==null?void 0:T.length)||0,O=((L=f.objects)==null?void 0:L.length)||0,xe=async()=>{if(!s||E===void 0||M)return;const z=(r==null?void 0:r.findIndex(F=>F.type==="bbox_detection_only"&&F.bboxDetection||F.bboxDetection))??0;N(!0);try{const F=localStorage.getItem("auth_token"),W=new URLSearchParams({page:String(E),type:"retry",index:String(z),field:"bboxOverlay"}),P=await fetch(`/api/stories/${s}/dev-image?${W}`,{headers:F?{Authorization:`Bearer ${F}`}:{}});if(P.ok){const ee=await P.json();ee.bboxOverlayImage&&V(ee.bboxOverlayImage)}}catch(F){console.error("Failed to load bbox overlay:",F)}finally{N(!1)}},ne=q||R;return e.jsxs(e.Fragment,{children:[g&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>S(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("div",{className:"absolute -top-8 left-0 text-white text-sm",children:g.title}),e.jsx("img",{src:g.src,alt:g.title,className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),e.jsx("button",{className:"absolute -top-8 right-0 text-white hover:text-gray-300",onClick:()=>S(null),children:"âœ• Close"})]})}),e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-blue-700 flex items-center justify-between",children:e.jsxs("span",{className:"flex items-center gap-2",children:["ðŸ“¦ ",c==="de"?"Objekterkennung":"Object Detection",e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded",children:[x," ",c==="de"?"Figuren":"figures",","," ",O," ",c==="de"?"Objekte":"objects"]}),f.positionMismatches&&f.positionMismatches.length>0&&e.jsxs("span",{className:"text-xs bg-yellow-200 text-yellow-800 px-1.5 py-0.5 rounded",children:["âš ï¸ ",f.positionMismatches.length," ",c==="de"?"Abweichungen":"mismatches"]}),f.missingCharacters&&f.missingCharacters.length>0&&e.jsxs("span",{className:"text-xs bg-red-200 text-red-800 px-1.5 py-0.5 rounded",children:["âŒ ",f.missingCharacters.length," ",c==="de"?"Char fehlt":"char missing"]}),f.missingObjects&&f.missingObjects.length>0&&e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-1.5 py-0.5 rounded",children:["âš ï¸ ",f.missingObjects.length," ",c==="de"?"Obj fehlt":"obj missing"]}),f.matchedObjects&&f.matchedObjects.length>0&&e.jsxs("span",{className:"text-xs bg-green-200 text-green-800 px-1.5 py-0.5 rounded",children:["âœ“ ",f.matchedObjects.length," ",c==="de"?"Obj gefunden":"obj matched"]})]})}),e.jsxs("div",{className:"mt-3 space-y-3",children:[ne?e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1 font-medium",children:[c==="de"?"Erkannte Regionen":"Detected Regions",e.jsx("span",{className:"ml-2 text-gray-400",children:"(ðŸŸ¢ Body, ðŸ”µ Face, ðŸŸ  Object, ðŸŸ£ Matched)"})]}),e.jsx("img",{src:ne,alt:"Bbox overlay",className:"max-w-md border rounded cursor-pointer hover:ring-2 hover:ring-blue-400",onClick:()=>S({src:ne,title:c==="de"?"Erkannte Regionen":"Detected Regions"})})]}):j&&s&&E!==void 0?e.jsx("button",{onClick:xe,disabled:M,className:"text-sm px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 flex items-center gap-2 disabled:opacity-50",children:M?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{size:14,className:"animate-spin"})," ",c==="de"?"LÃ¤dt...":"Loading..."]}):e.jsxs(e.Fragment,{children:["ðŸ“¦ ",c==="de"?"Erkannte Regionen laden":"Load Detected Regions"]})}):null,f.expectedCharacters&&f.expectedCharacters.length>0&&e.jsxs("details",{className:"bg-violet-50 p-3 rounded border border-violet-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-violet-800",children:["ðŸ‘¥ ",c==="de"?"Erwartete Charaktere":"Expected Characters"," (",f.expectedCharacters.length,")"]}),e.jsx("div",{className:"mt-2 grid grid-cols-1 gap-2 text-sm",children:f.expectedCharacters.map((z,F)=>e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-medium text-violet-700",children:z.name}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:[z.description,z.position&&e.jsxs("span",{className:"ml-2 text-violet-500",children:["@ ",z.position]})]})]},F))})]}),f.expectedPositions&&Object.keys(f.expectedPositions).length>0&&e.jsxs("div",{className:"bg-purple-50 p-3 rounded border border-purple-200",children:[e.jsxs("div",{className:"font-medium text-purple-800 mb-2",children:["ðŸ“ ",c==="de"?"Erwartete Positionen":"Expected Positions"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:Object.entries(f.expectedPositions).map(([z,F])=>e.jsxs("div",{className:"bg-white p-2 rounded border flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-purple-700",children:z}),e.jsx("span",{className:"text-gray-600 text-xs",children:F})]},z))})]}),f.positionMismatches&&f.positionMismatches.length>0&&e.jsxs("div",{className:"bg-yellow-50 p-3 rounded border border-yellow-300",children:[e.jsxs("div",{className:"font-medium text-yellow-800 mb-2",children:["âš ï¸ ",c==="de"?"Positionsabweichungen":"Position Mismatches"," (",f.positionMismatches.length,")"]}),e.jsx("div",{className:"space-y-2",children:f.positionMismatches.map((z,F)=>e.jsxs("div",{className:"text-sm bg-white p-2 rounded border border-yellow-200",children:[e.jsx("div",{className:"font-medium text-yellow-700",children:z.character}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1 flex gap-3",children:[e.jsxs("span",{children:[c==="de"?"Erwartet":"Expected",": ",e.jsx("span",{className:"font-medium text-purple-600",children:z.expected}),e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",z.expectedLCR,")"]})]}),e.jsx("span",{className:"text-gray-400",children:"â†’"}),e.jsxs("span",{children:[c==="de"?"Erkannt":"Actual",": ",e.jsx("span",{className:"font-medium text-orange-600",children:z.actual})]})]})]},F))})]}),f.missingCharacters&&f.missingCharacters.length>0&&e.jsxs("div",{className:"bg-red-50 p-3 rounded border border-red-300",children:[e.jsxs("div",{className:"font-medium text-red-800 mb-2",children:["âŒ ",c==="de"?"Fehlende Charaktere":"Missing Characters"," (",f.missingCharacters.length,")"]}),e.jsx("div",{className:"text-sm text-red-700",children:c==="de"?"Diese Charaktere wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These characters were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:f.missingCharacters.map((z,F)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-red-200 text-sm font-medium text-red-700",children:z},F))})]}),f.expectedObjects&&f.expectedObjects.length>0&&e.jsxs("div",{className:"bg-indigo-50 p-3 rounded border border-indigo-200",children:[e.jsxs("div",{className:"font-medium text-indigo-800 mb-2",children:["ðŸŽ¯ ",c==="de"?"Erwartete Objekte":"Expected Objects"," (",f.expectedObjects.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm",children:f.expectedObjects.map((z,F)=>{var ee,Q;const W=(ee=f.matchedObjects)==null?void 0:ee.find(Ne=>Ne.expected===z),P=(Q=f.missingObjects)==null?void 0:Q.includes(z);return e.jsxs("div",{className:`bg-white p-2 rounded border flex justify-between items-center ${P?"border-red-300":W?"border-green-300":""}`,children:[e.jsxs("span",{className:`font-medium ${P?"text-red-600":W?"text-green-600":"text-indigo-700"}`,children:[P?"âŒ":W?"âœ“":"â€¢"," ",z]}),W&&e.jsxs("span",{className:"text-xs text-gray-500 truncate ml-2",children:["â†’ ",W.matched]})]},F)})})]}),f.missingObjects&&f.missingObjects.length>0&&!f.expectedObjects&&e.jsxs("div",{className:"bg-amber-50 p-3 rounded border border-amber-300",children:[e.jsxs("div",{className:"font-medium text-amber-800 mb-2",children:["âš ï¸ ",c==="de"?"Fehlende Objekte":"Missing Objects"," (",f.missingObjects.length,")"]}),e.jsx("div",{className:"text-sm text-amber-700",children:c==="de"?"Diese Objekte wurden in der Szene erwartet, aber nicht im Bild gefunden:":"These objects were expected in the scene but not detected in the image:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:f.missingObjects.map((z,F)=>e.jsx("span",{className:"bg-white px-2 py-1 rounded border border-amber-200 text-sm font-medium text-amber-700",children:z},F))})]}),f.figures&&f.figures.length>0&&e.jsxs("div",{className:"bg-green-50 p-3 rounded border border-green-200",children:[e.jsxs("div",{className:"font-medium text-green-800 mb-2",children:[c==="de"?"Figuren":"Figures"," (",f.figures.length,")",f.unknownFigures!==void 0&&f.unknownFigures>0&&e.jsxs("span",{className:"ml-2 text-xs bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded",children:[f.unknownFigures," ",c==="de"?"unbekannt":"unknown"]})]}),e.jsx("div",{className:"space-y-2",children:f.figures.map((z,F)=>{const W=z.name&&z.name!=="UNKNOWN",P=z.confidence==="high"?"text-green-600":z.confidence==="medium"?"text-yellow-600":"text-orange-600",ee=z.confidence==="high"?"â˜…":z.confidence==="medium"?"â—†":"â—‹";return e.jsxs("div",{className:`text-sm bg-white p-2 rounded border ${W?"border-green-300":"border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:`font-medium ${W?"text-green-700":"text-gray-600"}`,children:W?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:P,children:ee})," ",z.name]}):e.jsxs(e.Fragment,{children:["? ",z.label||`Figure ${F+1}`]})}),W&&z.confidence&&e.jsx("span",{className:`text-xs ${P}`,children:z.confidence})]}),W&&z.label&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:z.label}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1 grid grid-cols-2 gap-2",children:[z.bodyBox&&e.jsxs("span",{children:["Body: [",z.bodyBox.map(Q=>(Q*100).toFixed(0)+"%").join(", "),"]"]}),z.faceBox&&e.jsxs("span",{children:["Face: [",z.faceBox.map(Q=>(Q*100).toFixed(0)+"%").join(", "),"]"]}),z.position&&e.jsxs("span",{children:["Pos: ",z.position]})]})]},F)})})]}),f.objects&&f.objects.length>0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsxs("div",{className:"font-medium text-orange-800 mb-2",children:[c==="de"?"Objekte":"Objects"," (",f.objects.length,")"]}),e.jsx("div",{className:"space-y-2",children:f.objects.map((z,F)=>{const W=!!z.name,P=z.found!==!1;return e.jsxs("div",{className:`text-sm bg-white p-2 rounded border ${W&&P?"border-green-300":W&&!P?"border-red-300":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:`font-medium ${W&&P?"text-green-700":W&&!P?"text-red-600":"text-orange-700"}`,children:W?e.jsxs(e.Fragment,{children:[P?"âœ“":"âœ—"," ",z.name]}):z.label||`Object ${F+1}`}),W&&e.jsx("span",{className:`text-xs ${P?"text-green-600":"text-red-600"}`,children:P?c==="de"?"gefunden":"found":c==="de"?"fehlt":"missing"})]}),W&&z.label&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:z.label}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[z.bodyBox&&e.jsxs("span",{children:["Box: [",z.bodyBox.map(ee=>(ee*100).toFixed(0)+"%").join(", "),"]"]}),z.position&&e.jsxs("span",{className:"ml-2",children:["Pos: ",z.position]})]})]},F)})})]}),f.characterDescriptions&&Object.keys(f.characterDescriptions).length>0&&e.jsxs("details",{className:"bg-cyan-50 p-3 rounded border border-cyan-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-cyan-800",children:["ðŸ‘¤ ",c==="de"?"Charakter-Beschreibungen":"Character Descriptions"," (",Object.keys(f.characterDescriptions).length,")"]}),e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2 text-sm",children:Object.entries(f.characterDescriptions).map(([z,F])=>e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("span",{className:"font-medium text-cyan-700",children:z}),e.jsxs("span",{className:"text-gray-600 ml-2",children:[F.genderTerm||F.gender||"?",", ",F.age?`${F.age}y`:"?",F.isChild?" (child)":F.isChild===!1?" (adult)":""]})]},z))})]}),f.rawPrompt&&e.jsxs("details",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-gray-700",children:["ðŸ“ ",c==="de"?"Bbox-Prompt":"Bbox Prompt"]}),e.jsx("pre",{className:"mt-2 text-xs bg-white p-2 rounded border overflow-x-auto whitespace-pre-wrap max-h-48 overflow-y-auto",children:f.rawPrompt})]}),f.rawResponse&&e.jsxs("details",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("summary",{className:"cursor-pointer font-medium text-gray-700",children:["ðŸ“¤ ",c==="de"?"Bbox-Antwort":"Bbox Response"]}),e.jsx("pre",{className:"mt-2 text-xs bg-white p-2 rounded border overflow-x-auto whitespace-pre-wrap max-h-64 overflow-y-auto",children:f.rawResponse})]}),e.jsxs("button",{onClick:()=>So(JSON.stringify(f,null,2),`object-detection-page-${E}.json`),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 bg-blue-50 rounded hover:bg-blue-100",children:[e.jsx(rs,{size:12})," ",c==="de"?"JSON herunterladen":"Download JSON"]})]})]})]})}function Co({src:r,alt:l,onClose:o}){const c=i.useCallback(s=>{s.key==="Escape"&&o()},[o]);return i.useEffect(()=>(r&&(document.addEventListener("keydown",c),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",c),document.body.style.overflow="unset"}),[r,c]),r?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm cursor-pointer",onClick:o,children:[e.jsx("button",{onClick:o,className:"absolute top-4 right-4 p-2 rounded-full bg-black/50 hover:bg-black/70 text-white transition-colors z-10","aria-label":"Close",children:e.jsx(zt,{size:24})}),e.jsx("img",{src:r,alt:l||"Enlarged image",className:"max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl",onClick:s=>s.stopPropagation()})]}):null}function Ys({referencePhotos:r,landmarkPhotos:l,visualBibleGrid:o,language:c,storyId:s,pageNumber:E}){var Se;const[g,S]=i.useState(null),[R,V]=i.useState(null),[M,N]=i.useState(null),[k,f]=i.useState(!1),[q,j]=i.useState(null),x=r==null?void 0:r.some(b=>b.hasPhoto&&!b.photoUrl),O=l==null?void 0:l.some(b=>b.hasPhoto&&!b.photoData),xe=i.useCallback(async()=>{if(!(!s||!E||k)&&!(!x&&!O)){f(!0),j(null);try{if(x){const b=await Ee.getDevImage(s,E,"reference");b!=null&&b.referencePhotos&&V(b.referencePhotos)}if(O){const b=await Ee.getDevImage(s,E,"landmark");b!=null&&b.landmarkPhotos&&N(b.landmarkPhotos)}}catch(b){j(b instanceof Error?b.message:"Failed to load images")}finally{f(!1)}}},[s,E,k,x,O]),ne=R||r,T=M||l,L=ne&&ne.length>0,z=T&&T.length>0,F=!!o;if(!L&&!z&&!F)return null;const W=((r==null?void 0:r.length)||0)+((l==null?void 0:l.length)||0)+(F?1:0),P=b=>{switch(b){case"bodyNoBg":case"body-no-bg":return c==="de"?"GanzkÃ¶rper (freigestellt)":c==="fr"?"Corps entier (dÃ©tourÃ©)":"Full body (no bg)";case"body":return c==="de"?"GanzkÃ¶rper":c==="fr"?"Corps entier":"Full body";case"face":return c==="de"?"Gesicht":c==="fr"?"Visage":"Face only";case"clothing-winter":return c==="de"?"Winter-Avatar":c==="fr"?"Avatar hiver":"Winter avatar";case"clothing-summer":return c==="de"?"Sommer-Avatar":c==="fr"?"Avatar Ã©tÃ©":"Summer avatar";case"clothing-formal":return c==="de"?"Formell-Avatar":c==="fr"?"Avatar formel":"Formal avatar";case"clothing-standard":return c==="de"?"Standard-Avatar":c==="fr"?"Avatar standard":"Standard avatar";case"none":return c==="de"?"Kein Foto":c==="fr"?"Pas de photo":"No photo";default:return b}},ee=b=>{switch(b){case"bodyNoBg":case"body-no-bg":return"bg-green-100 text-green-700 border-green-300";case"body":return"bg-blue-100 text-blue-700 border-blue-300";case"face":return"bg-yellow-100 text-yellow-700 border-yellow-300";case"clothing-winter":return"bg-cyan-100 text-cyan-700 border-cyan-300";case"clothing-summer":return"bg-orange-100 text-orange-700 border-orange-300";case"clothing-formal":return"bg-purple-100 text-purple-700 border-purple-300";case"clothing-standard":return"bg-teal-100 text-teal-700 border-teal-300";case"none":return"bg-red-100 text-red-700 border-red-300";default:return"bg-gray-100 text-gray-700 border-gray-300"}},Q=(Se=ne==null?void 0:ne.find(b=>b.clothingCategory))==null?void 0:Se.clothingCategory,Ne=b=>{if(!b)return"";switch(b){case"winter":return c==="de"?"Winter":c==="fr"?"Hiver":"Winter";case"summer":return c==="de"?"Sommer":c==="fr"?"Ã‰tÃ©":"Summer";case"formal":return c==="de"?"Formell":c==="fr"?"Formel":"Formal";case"standard":return"Standard";default:return b}};return e.jsxs("details",{className:"bg-pink-50 border border-pink-300 rounded-lg p-3",onToggle:b=>{b.target.open&&(x||O)&&xe()},children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-900 flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ“¸"}),c==="de"?"Referenzfotos":c==="fr"?"Photos de rÃ©fÃ©rence":"Reference Photos",e.jsxs("span",{className:"text-xs text-pink-600",children:["(",W,")"]}),Q&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-pink-200 text-pink-800 text-xs rounded",children:["ðŸ‘• ",Ne(Q)]}),z&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded",children:["ðŸ“ ",T.length," ",c==="de"?"Wahrzeichen":"Landmark"]}),F&&e.jsx("span",{className:"ml-2 px-2 py-0.5 bg-indigo-200 text-indigo-800 text-xs rounded",children:"ðŸ”² VB Grid"}),k&&e.jsx("span",{className:"ml-2 text-xs text-gray-500 animate-pulse",children:"Loading..."})]}),q&&e.jsx("div",{className:"mt-3 text-sm text-red-600 bg-red-50 p-2 rounded",children:q}),L&&e.jsx("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2",children:ne.map((b,H)=>e.jsxs("div",{className:"bg-white rounded-lg p-2 border border-pink-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:b.name}),b.photoType&&e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap ${ee(b.photoType)}`,children:P(b.photoType)})]}),b.photoUrl?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:b.photoUrl,alt:`${b.name} - ${P(b.photoType||"unknown")}`,className:`w-full max-h-32 object-contain rounded border bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity ${b.isStyled?"border-purple-400 ring-2 ring-purple-200":"border-gray-200"}`,onClick:()=>S(b.photoUrl),title:"Click to enlarge"}),b.isStyled&&e.jsx("span",{className:"absolute top-1 right-1 px-1 py-0.5 text-[9px] font-bold bg-purple-500 text-white rounded",children:"ðŸŽ¨ STYLED"})]}),b.photoHash&&e.jsxs("div",{className:"mt-1 text-[9px] font-mono text-gray-500 bg-gray-100 px-1 py-0.5 rounded text-center",children:["ðŸ” ",b.photoHash]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:c==="de"?"Foto nicht geladen":"Photo not loaded"})]},H))}),z&&e.jsxs("div",{className:L?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-amber-700 mb-2 flex items-center gap-1",children:["ðŸ“ ",c==="de"?"Wahrzeichen-Referenzfotos":c==="fr"?"Photos de monuments":"Landmark Reference Photos"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:T.map((b,H)=>e.jsxs("div",{className:"bg-amber-50 rounded-lg p-2 border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800 truncate",children:b.name}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-amber-100 text-amber-700 border-amber-300",children:"ðŸ“ LANDMARK"})]}),b.photoData?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:b.photoData,alt:`${b.name} landmark`,className:"w-full max-h-32 object-contain rounded border border-amber-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(b.photoData),title:"Click to enlarge"})}),b.attribution&&e.jsxs("div",{className:"mt-1 text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 rounded truncate",title:b.attribution,children:["ðŸ“· ",b.attribution]}),b.source&&e.jsxs("div",{className:"mt-0.5 text-[9px] text-gray-400",children:["Source: ",b.source]})]}):e.jsx("div",{className:"text-xs text-gray-500 italic py-2 text-center bg-gray-100 rounded",children:c==="de"?"Foto nicht geladen":"Photo not loaded"})]},H))})]}),F&&e.jsxs("div",{className:L||z?"mt-4 pt-3 border-t border-pink-200":"mt-3",children:[e.jsxs("div",{className:"text-xs font-semibold text-indigo-700 mb-2 flex items-center gap-1",children:["ðŸ”² ",c==="de"?"Visual Bible Referenzgitter":c==="fr"?"Grille Visual Bible":"Visual Bible Reference Grid"]}),e.jsxs("div",{className:"bg-indigo-50 rounded-lg p-2 border border-indigo-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-gray-800",children:c==="de"?"Kombinierte Referenzen":c==="fr"?"RÃ©fÃ©rences combinÃ©es":"Combined References"}),e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium border whitespace-nowrap bg-indigo-100 text-indigo-700 border-indigo-300",children:"ðŸ”² VB GRID"})]}),e.jsx("div",{className:"text-[10px] text-gray-500 mb-2",children:c==="de"?"SekundÃ¤re Charaktere, Tiere, Artefakte, Fahrzeuge und zusÃ¤tzliche Wahrzeichen":c==="fr"?"Personnages secondaires, animaux, artefacts, vÃ©hicules et monuments supplÃ©mentaires":"Secondary characters, animals, artifacts, vehicles, and additional landmarks"}),e.jsx("img",{src:o,alt:"Visual Bible Reference Grid",className:"w-full max-h-64 object-contain rounded border border-indigo-200 bg-gray-50 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>S(o),title:"Click to enlarge"})]})]}),e.jsx(Co,{src:g,onClose:()=>S(null)})]})}function ko({pageNumber:r,scene:l,onSceneChange:o,onClose:c,onRegenerate:s,isRegenerating:E,imageRegenerationCost:g,characters:S=[],selectedCharacterIds:R=[],onCharacterSelectionChange:V,consistencyRegen:M}){const{language:N}=lr(),[k,f]=i.useState(!1),[q,j]=i.useState(!1),x=O=>{V&&(R.includes(O)?V(R.filter(xe=>xe!==O)):V([...R,O]))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(gt,{size:20}),N==="de"?`Szene bearbeiten - Seite ${r}`:N==="fr"?`Modifier la scÃ¨ne - Page ${r}`:`Edit Scene - Page ${r}`]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:N==="de"?"Bearbeiten Sie die Szenenbeschreibung und wÃ¤hlen Sie die Charaktere aus.":N==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages.":"Edit the scene description and select the characters."})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[S.length>0&&V&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(ws,{size:16}),N==="de"?"Charaktere in dieser Szene:":N==="fr"?"Personnages dans cette scÃ¨ne:":"Characters in this scene:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(O=>{const xe=R.includes(O.id);return e.jsxs("button",{type:"button",onClick:()=>x(O.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${xe?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:O.name}),xe&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},O.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:N==="de"?"WÃ¤hlen Sie die Charaktere aus, die im Bild erscheinen sollen.":N==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre dans l'image.":"Select the characters that should appear in the image."})]}),M&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(pn,{className:"text-amber-600",size:20}),e.jsx("h4",{className:"font-semibold text-amber-800",children:N==="de"?"Konsistenz-Korrektur angewendet":N==="fr"?"Correction de cohÃ©rence appliquÃ©e":"Consistency Fix Applied"}),e.jsxs("span",{className:"text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded",children:["Score: ",M.score,"%"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-amber-700 mb-2",children:N==="de"?"Behobene Probleme:":N==="fr"?"ProblÃ¨mes corrigÃ©s:":"Issues Fixed:"}),e.jsx("ul",{className:"text-sm text-amber-900 space-y-1",children:M.issues.map((O,xe)=>e.jsxs("li",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium",children:[O.type.toUpperCase(),O.characterInvolved&&` (${O.characterInvolved})`,":"]}),e.jsx("span",{className:"text-amber-700 ml-2",children:O.description}),e.jsxs("span",{className:"text-amber-600 ml-2 text-xs",children:["â†’ ",O.recommendation]})]},xe))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 mb-1 text-center",children:"Original"}),e.jsx("img",{src:M.originalImage,alt:"Original",className:"w-full rounded-lg border border-gray-300",draggable:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-green-600 mb-1 text-center",children:N==="de"?"Korrigiert":N==="fr"?"CorrigÃ©":"Fixed"}),e.jsx("img",{src:M.fixedImage,alt:"Fixed",className:"w-full rounded-lg border-2 border-green-500",draggable:!1})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>f(!k),className:"flex items-center gap-1 text-xs text-gray-600 hover:text-gray-800",children:[k?e.jsx(Dn,{size:14}):e.jsx(Mt,{size:14}),N==="de"?"Original-Prompt":N==="fr"?"Prompt original":"Original Prompt"]}),k&&e.jsx("pre",{className:"text-xs bg-gray-100 p-2 rounded overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:M.originalPrompt}),e.jsxs("button",{onClick:()=>j(!q),className:"flex items-center gap-1 text-xs text-green-600 hover:text-green-800",children:[q?e.jsx(Dn,{size:14}):e.jsx(Mt,{size:14}),N==="de"?"Korrigierter Prompt (mit Korrekturen)":N==="fr"?"Prompt corrigÃ© (avec corrections)":"Fixed Prompt (with corrections)"]}),q&&e.jsx("pre",{className:"text-xs bg-green-50 p-2 rounded border border-green-200 overflow-x-auto max-h-32 overflow-y-auto whitespace-pre-wrap",children:M.fixedPrompt})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-xs text-gray-400",children:N==="de"?`Korrigiert am ${new Date(M.timestamp).toLocaleString()}`:N==="fr"?`CorrigÃ© le ${new Date(M.timestamp).toLocaleString()}`:`Fixed at ${new Date(M.timestamp).toLocaleString()}`}),M.clothing&&e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded",children:["ðŸŽ¨ ",M.clothing]})]}),M.avatarsUsed&&M.avatarsUsed.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-blue-50 rounded border border-blue-200",children:[e.jsx("p",{className:"text-xs font-medium text-blue-700 mb-1",children:N==="de"?"Verwendete Avatare:":N==="fr"?"Avatars utilisÃ©s:":"Avatars used:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:M.avatarsUsed.map((O,xe)=>e.jsxs("span",{className:`text-xs px-2 py-1 rounded ${O.hasPhoto?"bg-green-100 text-green-700":"bg-gray-100 text-gray-500"}`,children:[O.name,O.category&&O.category!=="standard"&&e.jsxs("span",{className:"ml-1 opacity-75",children:["(",O.category,")"]}),!O.hasPhoto&&" âš ï¸"]},xe))})]}),M.retryHistory&&M.retryHistory.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx(js,{retryHistory:M.retryHistory,totalAttempts:M.totalAttempts||1,language:N})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:N==="de"?"Szenenbeschreibung:":N==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:l,onChange:O=>o(O.target.value),className:"w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y",placeholder:N==="de"?"Beschreiben Sie die Szene...":N==="fr"?"DÃ©crivez la scÃ¨ne...":"Describe the scene..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:N==="de"?"Tipp: Beschreiben Sie die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":N==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:R.length>0&&e.jsx("span",{children:N==="de"?`${R.length} Charakter(e) ausgewÃ¤hlt`:N==="fr"?`${R.length} personnage(s) sÃ©lectionnÃ©(s)`:`${R.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:c,disabled:E,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium disabled:opacity-50 order-2 sm:order-1",children:N==="de"?"Abbrechen":N==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:s,disabled:E||!l.trim(),className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${E||!l.trim()?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:E?e.jsxs(e.Fragment,{children:[e.jsx(Qt,{size:16,className:"animate-spin"}),N==="de"?"Generiere...":N==="fr"?"GÃ©nÃ©ration...":"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Qt,{size:16}),N==="de"?"Neu generieren":N==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",g,")"]})]})})]})]})]})})}function Po({pageNumber:r,versions:l,onClose:o,onSelectVersion:c,developerMode:s=!1}){const{language:E}=lr();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Or,{size:20}),E==="de"?`Bildversionen - Seite ${r}`:E==="fr"?`Versions d'image - Page ${r}`:`Image Versions - Page ${r}`]}),e.jsx("button",{onClick:o,className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(zt,{size:20})})]}),e.jsxs("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:l.map((g,S)=>e.jsxs("div",{className:`relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${g.isActive?"border-green-500 ring-2 ring-green-200":"border-gray-200 hover:border-indigo-300"}`,onClick:()=>c(r,S),children:[e.jsx("img",{src:g.imageData,alt:`Version ${S+1}`,className:"w-full aspect-square object-cover"}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:S===0?"Original":`V${S+1}`}),g.isActive&&e.jsx("span",{className:"bg-green-500 px-2 py-0.5 rounded text-[10px] font-bold",children:E==="de"?"Aktiv":E==="fr"?"Actif":"Active"})]}),e.jsx("div",{className:"text-[10px] text-gray-300 mt-1",children:new Date(g.createdAt).toLocaleDateString()})]})]},S))}),s&&l.length>1&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold text-gray-700",children:E==="de"?"Szenen- und Prompt-Vergleich":E==="fr"?"Comparaison de scÃ¨nes et prompts":"Scene & Prompt Comparison"}),l.map((g,S)=>e.jsxs("details",{className:`rounded-lg p-3 ${g.isActive?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-medium text-gray-700",children:[S===0?"Original":`V${S+1}`,g.isActive&&e.jsx("span",{className:"ml-2 text-green-600 text-xs",children:"(Active)"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[g.userInput&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-purple-700",children:E==="de"?"Benutzer-Eingabe:":E==="fr"?"EntrÃ©e utilisateur:":"User Input:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-purple-50 p-2 rounded border border-purple-200 max-h-24 overflow-y-auto",children:g.userInput})]}),g.description&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700",children:E==="de"?"Erweiterte Szene:":E==="fr"?"ScÃ¨ne Ã©tendue:":"Expanded Scene:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-24 overflow-y-auto",children:g.description})]}),g.prompt&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-blue-700",children:E==="de"?"API-Prompt:":E==="fr"?"Prompt API:":"API Prompt:"}),e.jsx("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap bg-white p-2 rounded border border-gray-200 max-h-32 overflow-y-auto",children:g.prompt})]}),g.modelId&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Model: ",g.modelId]})]})]},S))]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 text-sm text-gray-500",children:E==="de"?"Klicken Sie auf ein Bild, um es auszuwÃ¤hlen":E==="fr"?"Cliquez sur une image pour la sÃ©lectionner":"Click an image to select it"})]})})}function Ao({src:r,title:l,onClose:o}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:o,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-2 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:l}),e.jsx("button",{onClick:o,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(zt,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50",children:e.jsx("img",{src:r,alt:l,className:"max-w-full max-h-[80vh] object-contain mx-auto"})})]})})}function $o({beforeImage:r,afterImage:l,diffImage:o,title:c,onClose:s}){return e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:s,children:e.jsxs("div",{className:"relative bg-white rounded-lg overflow-hidden max-w-[95vw] max-h-[95vh]",onClick:E=>E.stopPropagation(),children:[e.jsxs("div",{className:"bg-gray-100 px-4 py-3 flex items-center justify-between border-b",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:c}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700 p-1",children:e.jsx(zt,{size:20})})]}),e.jsx("div",{className:"p-4 bg-gray-50 overflow-auto max-h-[calc(95vh-60px)]",children:e.jsxs("div",{className:`grid gap-4 ${o?"grid-cols-1 lg:grid-cols-3":"grid-cols-1 lg:grid-cols-2"}`,children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-red-100 px-3 py-1 rounded-full",children:"Before"}),e.jsx("img",{src:r,alt:"Before repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-green-100 px-3 py-1 rounded-full",children:"After"}),e.jsx("img",{src:l,alt:"After repair",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]}),o&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 bg-purple-100 px-3 py-1 rounded-full",children:"Diff (changes in magenta)"}),e.jsx("img",{src:o,alt:"Difference",className:"max-w-full max-h-[70vh] object-contain border rounded shadow-sm"})]})]})})]})})}const Gn={en:{adventure:"Adventure","life-challenge":"Life Challenge",educational:"Educational",historical:"Historical"},de:{adventure:"Abenteuer","life-challenge":"Lebensherausforderung",educational:"Bildung",historical:"Historisch"},fr:{adventure:"Aventure","life-challenge":"DÃ©fi de vie",educational:"Ã‰ducatif",historical:"Historique"}},_n={en:{"1st-grade":"Picture Book (1st Grade)",standard:"Standard",advanced:"Advanced"},de:{"1st-grade":"Bilderbuch (1. Klasse)",standard:"Standard",advanced:"Fortgeschritten"},fr:{"1st-grade":"Livre illustrÃ© (1Ã¨re annÃ©e)",standard:"Standard",advanced:"AvancÃ©"}},Io={"de-CH":"Schweizerdeutsch","de-DE":"Deutsch (Deutschland)",en:"English",fr:"FranÃ§ais"};function To({settings:r,language:l}){var f,q;const[o,c]=i.useState(!1),s=j=>{const x={en:{title:"Story Info",category:"Category",topic:"Topic",theme:"Theme",storyType:"Story Type",storyDetails:"Story Idea",artStyle:"Art Style",language:"Language",readingLevel:"Reading Level",pages:"Length",dedication:"Dedication",mainCharacters:"Main Characters",otherCharacters:"Other Characters",relationships:"Relationships",season:"Season",location:"Location",noData:"Not specified",spring:"Spring",summer:"Summer",autumn:"Autumn",winter:"Winter"},de:{title:"Story-Info",category:"Kategorie",topic:"Thema",theme:"Thema",storyType:"Story-Typ",storyDetails:"Story-Idee",artStyle:"Kunststil",language:"Sprache",readingLevel:"Lesestufe",pages:"LÃ¤nge",dedication:"Widmung",mainCharacters:"Hauptfiguren",otherCharacters:"Andere Figuren",relationships:"Beziehungen",season:"Jahreszeit",location:"Ort",noData:"Nicht angegeben",spring:"FrÃ¼hling",summer:"Sommer",autumn:"Herbst",winter:"Winter"},fr:{title:"Info histoire",category:"CatÃ©gorie",topic:"Sujet",theme:"ThÃ¨me",storyType:"Type d'histoire",storyDetails:"IdÃ©e d'histoire",artStyle:"Style artistique",language:"Langue",readingLevel:"Niveau de lecture",pages:"Longueur",dedication:"DÃ©dicace",mainCharacters:"Personnages principaux",otherCharacters:"Autres personnages",relationships:"Relations",season:"Saison",location:"Lieu",noData:"Non spÃ©cifiÃ©",spring:"Printemps",summer:"Ã‰tÃ©",autumn:"Automne",winter:"Hiver"}};return(x[l]||x.en)[j]||j},E=j=>(Gn[l]||Gn.en)[j]||j,g=j=>(_n[l]||_n.en)[j]||j,S=(j,x)=>j==null||j===""?e.jsx("span",{className:"text-gray-400 italic",children:s("noData")}):e.jsx("span",{className:"text-gray-800",children:j}),R=r.mainCharacters||[],V=((f=r.characters)==null?void 0:f.filter(j=>R.includes(j.id)))||[],M=((q=r.characters)==null?void 0:q.filter(j=>!R.includes(j.id)))||[],N=j=>s(j)||j,k=()=>{if(!r.userLocation)return null;const j=[r.userLocation.city,r.userLocation.region,r.userLocation.country].filter(Boolean);return j.length>0?j.join(", "):null};return e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>c(!o),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-amber-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qi,{size:16,className:"text-amber-600"}),e.jsx("span",{className:"font-medium text-amber-800",children:s("title")}),e.jsx("span",{className:"text-xs bg-amber-200 text-amber-700 px-2 py-0.5 rounded",children:"DEV"})]}),o?e.jsx(Mt,{size:18,className:"text-amber-600"}):e.jsx(Ss,{size:18,className:"text-amber-600"})]}),o&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[V.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(dn,{size:12}),s("mainCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:V.map(j=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800 border border-indigo-200",children:[e.jsx(dn,{size:10}),e.jsx("span",{children:j.name})]},j.id))})]}),M.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-2",children:[e.jsx(ws,{size:12}),s("otherCharacters")]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:M.map(j=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-200",children:[e.jsx(dn,{size:10}),e.jsx("span",{children:j.name})]},j.id))})]}),r.relationships&&Object.keys(r.relationships).length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-2",children:s("relationships")}),e.jsx("div",{className:"text-xs bg-white/50 p-2 rounded border border-amber-100 space-y-1",children:Object.entries(r.relationships).map(([j,x])=>{var L,z;const[O,xe]=j.split("-").map(F=>parseInt(F,10)),ne=(L=r.characters)==null?void 0:L.find(F=>F.id===O),T=(z=r.characters)==null?void 0:z.find(F=>F.id===xe);return!ne||!T?null:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"text-amber-600 font-medium whitespace-nowrap",children:[ne.name," â†’ ",T.name,":"]}),e.jsx("span",{className:"text-gray-700",children:x})]},j)})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(ro,{size:12}),s("language")]}),e.jsx("div",{className:"text-sm",children:r.language?Io[r.language]||r.language:S(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("readingLevel")}),e.jsx("div",{className:"text-sm",children:r.languageLevel?g(r.languageLevel):S(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("pages")}),e.jsx("div",{className:"text-sm",children:r.pages?`${r.pages} ${l==="de"?"Seiten":"pages"}`:S(void 0)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("season")}),e.jsx("div",{className:"text-sm",children:r.season?N(r.season):S(void 0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:s("location")}),e.jsx("div",{className:"text-sm",children:k()||S(void 0)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(ti,{size:12}),s("artStyle")]}),e.jsx("div",{className:"text-sm capitalize",children:S(r.artStyle)})]})]}),r.storyDetails&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(vs,{size:12}),s("storyDetails")]}),e.jsx("div",{className:"text-sm bg-white/50 p-2 rounded border border-amber-100 whitespace-pre-wrap",children:r.storyDetails})]}),(r.storyCategory||r.storyTheme||r.storyTopic)&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-amber-100",children:[r.storyCategory&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-amber-700 mb-1",children:[e.jsx(Zi,{size:12}),s("category")]}),e.jsx("div",{className:"text-sm",children:E(r.storyCategory)})]}),(r.storyTheme||r.storyTopic)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-amber-700 mb-1",children:r.storyCategory==="adventure"?s("theme"):s("topic")}),e.jsx("div",{className:"text-sm",children:r.storyCategory==="adventure"?r.storyTheme:r.storyTopic})]})]})]})]})}function Ro({storyId:r,onShareStatusChange:l,variant:o="compact"}){const{language:c}=lr(),[s,E]=i.useState(!1),[g,S]=i.useState(null),[R,V]=i.useState(!1),[M,N]=i.useState(!1),[k,f]=i.useState(null),q=o==="full",j={share:c==="de"?"Teilen":c==="fr"?"Partager":"Share",shareStory:c==="de"?"Geschichte teilen":c==="fr"?"Partager l'histoire":"Share Story",enableSharing:c==="de"?"Link aktivieren":c==="fr"?"Activer le lien":"Enable sharing",disableSharing:c==="de"?"Link deaktivieren":c==="fr"?"DÃ©sactiver le lien":"Disable sharing",copyLink:c==="de"?"Link kopieren":c==="fr"?"Copier le lien":"Copy link",copied:c==="de"?"Kopiert!":c==="fr"?"CopiÃ©!":"Copied!",shareWhatsApp:c==="de"?"Per WhatsApp teilen":c==="fr"?"Partager sur WhatsApp":"Share on WhatsApp",sharingEnabled:c==="de"?"Teilen aktiv":c==="fr"?"Partage actif":"Sharing enabled",sharingDisabled:c==="de"?"Teilen inaktiv":c==="fr"?"Partage inactif":"Sharing disabled",anyoneWithLink:c==="de"?"Jeder mit dem Link kann die Geschichte lesen":c==="fr"?"Toute personne avec le lien peut lire l'histoire":"Anyone with the link can read the story",errorLoading:c==="de"?"Fehler beim Laden":c==="fr"?"Erreur de chargement":"Error loading"};i.useEffect(()=>{s&&!g&&x()},[s]);const x=async()=>{V(!0),f(null);try{const T=localStorage.getItem("auth_token"),L=await fetch(`/api/stories/${r}/share-status`,{headers:T?{Authorization:`Bearer ${T}`}:{}});if(!L.ok)throw new Error("Failed to fetch status");const z=await L.json();S(z)}catch{f(j.errorLoading)}finally{V(!1)}},O=async()=>{V(!0),f(null);try{const L=(g==null?void 0:g.isShared)?"DELETE":"POST",z=localStorage.getItem("auth_token"),F=await fetch(`/api/stories/${r}/share`,{method:L,headers:z?{Authorization:`Bearer ${z}`}:{}});if(!F.ok)throw new Error("Failed to toggle sharing");const W=await F.json();S({isShared:W.isShared,shareToken:W.shareToken,shareUrl:W.shareUrl}),l==null||l(W.isShared)}catch{f("Failed to update sharing")}finally{V(!1)}},xe=async()=>{if(g!=null&&g.shareUrl)try{await navigator.clipboard.writeText(g.shareUrl),N(!0),setTimeout(()=>N(!1),2e3)}catch{const L=document.createElement("textarea");L.value=g.shareUrl,document.body.appendChild(L),L.select(),document.execCommand("copy"),document.body.removeChild(L),N(!0),setTimeout(()=>N(!1),2e3)}},ne=()=>{if(!(g!=null&&g.shareUrl))return;const T=encodeURIComponent(g.shareUrl);window.open(`https://wa.me/?text=${T}`,"_blank")};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>E(!s),className:q?"bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full hover:bg-indigo-600":"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg",title:j.share,children:[e.jsx(Mn,{className:"w-4 h-4"}),e.jsx("span",{className:q?"":"hidden sm:inline",children:j.share}),(g==null?void 0:g.isShared)&&e.jsx("span",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>E(!1)}),e.jsxs("div",{className:"absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Mn,{className:"w-5 h-5 text-blue-600"}),j.shareStory]})}),e.jsx("div",{className:"p-4 space-y-4",children:R&&!g?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(Ze,{className:"w-6 h-6 animate-spin text-blue-500"})}):k?e.jsx("div",{className:"text-red-500 text-sm py-2",children:k}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[g!=null&&g.isShared?e.jsx(no,{className:"w-5 h-5 text-green-500"}):e.jsx(ao,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:g!=null&&g.isShared?"text-green-700":"text-gray-600",children:g!=null&&g.isShared?j.sharingEnabled:j.sharingDisabled})]}),e.jsx("button",{onClick:O,disabled:R,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${g!=null&&g.isShared?"bg-red-100 text-red-700 hover:bg-red-200":"bg-green-100 text-green-700 hover:bg-green-200"} disabled:opacity-50`,children:R?e.jsx(Ze,{className:"w-4 h-4 animate-spin"}):g!=null&&g.isShared?j.disableSharing:j.enableSharing})]}),(g==null?void 0:g.isShared)&&g.shareUrl&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xs text-gray-500",children:j.anyoneWithLink}),e.jsx("button",{onClick:xe,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-colors",children:M?e.jsxs(e.Fragment,{children:[e.jsx(Yi,{className:"w-4 h-4 text-green-500"}),j.copied]}):e.jsxs(e.Fragment,{children:[e.jsx(eo,{className:"w-4 h-4"}),j.copyLink]})}),e.jsxs("button",{onClick:ne,className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors",children:[e.jsx(oo,{className:"w-4 h-4"}),j.shareWhatsApp]})]})]})})]})]})]})}function Do({title:r,dedication:l,story:o,outline:c,outlinePrompt:s,outlineModelId:E,outlineUsage:g,storyTextPrompts:S=[],visualBible:R,sceneImages:V,sceneDescriptions:M=[],coverImages:N,regeneratingCovers:k=new Set,languageLevel:f="standard",storyLanguage:q,isGenerating:j=!1,onDownloadPdf:x,onAddToBook:O,onPrintBook:xe,onCreateAnother:ne,onDownloadTxt:T,onRegenerateImage:L,onRegenerateCover:z,characters:F=[],onEditImage:W,onEditCover:P,onRepairImage:ee,onIteratePage:Q,onRevertRepair:Ne,onVisualBibleChange:Se,storyId:b,developerMode:H=!1,styledAvatarGeneration:ie=[],costumedAvatarGeneration:je=[],generationLog:le=[],finalChecksReport:G,clothingRequirements:I,isPartial:me=!1,failureReason:te,generatedPages:ge,totalPages:Z,progressiveMode:Te=!1,progressiveData:Me,completedPageImages:Je={},originalStory:It,onSaveStoryText:vt,onSaveTitleChange:dr,userCredits:ss=0,imageRegenerationCost:Zt=5,isImpersonating:ra=!1,onSelectImageVersion:sa,generationSettings:kr,onRefreshStory:Pr}){var xa,Bs,zs,pa,tr,rr,Ms,sr,fa;const{t:aa,language:a}=lr(),Re=q?q.startsWith("de")?"de":q:a,ct=ra||ss===-1||ss>=Zt,[$e,Cs]=i.useState(null),[jt,cr]=i.useState(""),[Yt,Gr]=i.useState(!1),[mr,as]=i.useState(o),[at,na]=i.useState(!1),[Tt,Xt]=i.useState(!1),[De,Ar]=i.useState(r||""),[We,ns]=i.useState(!1),[qe,$r]=i.useState(null),[Ye,ur]=i.useState(null),[,wt]=i.useState(!1),[ht,ke]=i.useState(new Set),[ye,gr]=i.useState(null),[xt,C]=i.useState(null),[Fe,ks]=i.useState(null),[Ir,ia]=i.useState(null),[ot,oa]=i.useState(null),[nt,la]=i.useState(null),[hr,Xe]=i.useState(null),[pt,Ps]=i.useState(null),[xr,is]=i.useState("square"),[Ot,os]=i.useState(!1),[As,Ja]=i.useState({}),[$s,da]=i.useState(new Set),Qa=async t=>{if(!(!b||As[t]||$s.has(t))){da(h=>new Set(h).add(t));try{const h=localStorage.getItem("auth_token"),m=await fetch(`/api/stories/${b}/visual-bible-image/${t}`,{headers:h?{Authorization:`Bearer ${h}`}:{}});if(m.ok){const A=await m.json();Ja(d=>({...d,[t]:A.imageData}))}}catch(h){console.error(`Failed to load reference image for ${t}:`,h)}finally{da(h=>{const m=new Set(h);return m.delete(t),m})}}},pr=(t,h)=>{if(!h||!H)return null;const m=As[t],A=$s.has(t);return m?e.jsx("img",{src:m,alt:"Reference",className:"w-16 h-16 object-cover rounded border border-rose-300 cursor-pointer hover:opacity-80",onClick:()=>Xe({src:m,title:"Reference Image"})}):e.jsx("button",{onClick:()=>Qa(t),disabled:A,className:"w-16 h-16 flex items-center justify-center bg-rose-100 border border-rose-300 rounded text-rose-500 hover:bg-rose-200 disabled:opacity-50",title:"Load reference image",children:A?e.jsx(Ze,{size:16,className:"animate-spin"}):e.jsx(Or,{size:16})})},[ls,Is]=i.useState({}),[_r,ds]=i.useState(new Set),Ts=async(t,h)=>{const m=`${t}-${h}`;if(!(!b||ls[m]||_r.has(m))){ds(A=>new Set(A).add(m));try{const A=await Ee.getAvatarGenerationImage(b,t,h);A&&Is(d=>({...d,[m]:A}))}catch(A){console.error(`Failed to load avatar generation images for ${m}:`,A)}finally{ds(A=>{const d=new Set(A);return d.delete(m),d})}}},[Hr,ft]=i.useState({}),[Vr,Rt]=i.useState(new Set),Rs=async t=>{if(!(!b||Hr[t]||Vr.has(t))){Rt(h=>new Set(h).add(t));try{const h=await Ee.getEntityGridImage(b,t);h!=null&&h.gridImage&&ft(m=>({...m,[t]:h.gridImage}))}catch(h){console.error(`Failed to load entity grid image for ${t}:`,h)}finally{Rt(h=>{const m=new Set(h);return m.delete(t),m})}}},Tr=async(t,h,m)=>new Promise((A,d)=>{const re=new Image;re.onload=()=>{const he=document.createElement("canvas"),_e=he.getContext("2d");if(!_e){d(new Error("Could not get canvas context"));return}const{cellSize:Be,cols:st}=m,yt=Math.floor(h/st),pe=h%st*Be,dt=yt*Be;he.width=Be,he.height=Be,_e.drawImage(re,pe,dt,Be,Be,0,0,Be,Be),A(he.toDataURL("image/png"))},re.onerror=()=>d(new Error("Failed to load grid image")),re.src=t}),ca=async(t,h)=>{try{const m=t.manifest.cells[h],A=await Tr(t.gridImage,h,t.manifest),d=m.isReference?"Reference":`Page ${m.pageNumber}`,re=m.clothing&&m.clothing!=="standard"?` (${m.clothing})`:"";Xe({src:A,title:`${t.entityName} - ${d}${re}`})}catch(m){console.error("Failed to crop cell:",m)}},Ds=(t,h,m,A)=>{var he,_e,Be,st,yt;const d=`${t}-${h}`,re=ls[d];return re&&re[A]?re[A]:A==="output"&&((he=m.output)!=null&&he.imageData)?m.output.imageData:A==="facePhoto"&&((_e=m.inputs.facePhoto)!=null&&_e.imageData)?m.inputs.facePhoto.imageData:A==="originalAvatar"&&"originalAvatar"in m.inputs&&((Be=m.inputs.originalAvatar)!=null&&Be.imageData)?m.inputs.originalAvatar.imageData:A==="styleSample"&&"styleSample"in m.inputs&&((st=m.inputs.styleSample)!=null&&st.imageData)?m.inputs.styleSample.imageData:A==="standardAvatar"&&"standardAvatar"in m.inputs&&((yt=m.inputs.standardAvatar)!=null&&yt.imageData)&&m.inputs.standardAvatar.imageData||null},fr=(t,h,m,A,d,re)=>{const he=Ds(t,h,m,A),_e=`${t}-${h}`,Be=_r.has(_e),st=!!ls[_e];return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-600 text-[10px] mb-1",children:d}),he?e.jsx("img",{src:he,alt:d,className:"w-16 h-16 object-cover rounded border border-blue-300 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>Xe({src:he,title:d}),title:re?`${re} KB - Click to enlarge`:"Click to enlarge"}):re?e.jsx("button",{onClick:()=>Ts(t,h),disabled:Be||st,className:"w-16 h-16 flex flex-col items-center justify-center bg-blue-50 border border-blue-300 rounded text-blue-500 hover:bg-blue-100 disabled:opacity-50 text-[10px]",title:"Click to load images",children:Be?e.jsx(Ze,{size:16,className:"animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Or,{size:14}),e.jsxs("span",{className:"mt-0.5",children:[re," KB"]})]})}):e.jsx("span",{className:"text-gray-400 italic text-[10px]",children:"N/A"})]})};i.useEffect(()=>{Yt||as(o)},[o,Yt]),i.useEffect(()=>{Tt||Ar(r||"")},[r,Tt]);const Rr=async()=>{if(vt){na(!0);try{await vt(mr),Gr(!1)}catch(t){console.error("Failed to save story text:",t)}finally{na(!1)}}},Wr=async()=>{if(!(!dr||!De.trim())){ns(!0);try{await dr(De.trim()),Xt(!1)}catch(t){console.error("Failed to save title:",t)}finally{ns(!1)}}},ma=()=>{as(o),Gr(!1)},Lt=async t=>{if(!(!ee||xt!==null)){C(t);try{await ee(t)}catch(h){console.error("Failed to repair image:",h)}finally{C(null)}}},Gt=async t=>{if(!(!Q||nt!==null)){la(t);try{await Q(t)}catch(h){console.error("Failed to iterate page:",h)}finally{la(null)}}},mt=async t=>{if(!(!b||Fe!==null)){ks(t);try{const h=await fetch(`/api/stories/${b}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({entityName:t,entityType:"character"})});if(!h.ok){const A=await h.json();throw new Error(A.error||"Repair failed")}const m=await h.json();console.log("Entity repair result:",m),m.success&&!m.noChanges&&(Pr?await Pr():window.location.reload())}catch(h){console.error("Failed to repair entity consistency:",h),alert(`Failed to repair: ${h instanceof Error?h.message:"Unknown error"}`)}finally{ks(null)}}},qr=async(t,h)=>{if(!(!b||ot!==null)){oa({entity:t,page:h});try{const m=await fetch(`/api/stories/${b}/repair-entity-consistency`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({entityName:t,entityType:"character",pageNumber:h})});if(!m.ok){const d=await m.json();throw new Error(d.error||"Repair failed")}const A=await m.json();console.log("Single-page entity repair result:",A),A.success&&(Pr?await Pr():window.location.reload())}catch(m){console.error("Failed to repair single page:",m),alert(`Failed to repair page ${h}: ${m instanceof Error?m.message:"Unknown error"}`)}finally{oa(null)}}},cs=async(t,h)=>{if(!(!b||Ir!==null)){ia(t);try{const m=await fetch(`/api/stories/${b}/repair/image/${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({correctionNotes:`${h.type||""}: ${h.description||""}
Target: ${h.canonicalVersion||""}
Fix: ${h.recommendation||""}`})});if(!m.ok){const d=await m.json();throw new Error(d.error||"Repair failed")}const A=await m.json();console.log("Image issue repair result:",A),A.success&&(Pr?await Pr():window.location.reload())}catch(m){console.error("Failed to repair image issue:",m),alert(`Failed to repair: ${m instanceof Error?m.message:"Unknown error"}`)}finally{ia(null)}}},St=(t,h)=>{const m=mr.split(/(?=---\s*(?:Page|Seite)\s+\d+\s*---|(?=##\s*(?:Page|Seite)\s+\d+))/i);let A=0;for(let re=0;re<m.length;re++)if(/^(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i.test(m[re].trim())){A=re;break}const d=A+t;if(d<m.length){const re=m[d].match(/^(---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i),he=re?re[0]:"";m[d]=he+`
`+h.trim()+`
`}as(m.join(""))},_t=t=>{const h=V.find(m=>m.pageNumber===t);return(h==null?void 0:h.imageVersions)||[]},Dt=async(t,h)=>{if(sa)try{await sa(t,h),$r(null)}catch(m){console.error("Failed to select image version:",m)}},ua=t=>{if(!t)return"";let h;if(typeof t!="string"){const re=t;if(re.output)if(typeof re.output=="string")h=re.output;else if(typeof re.output=="object"){const he=re.output.translatedSummary||re.output.imageSummary||"";if(he)return he;h=JSON.stringify(t)}else h=JSON.stringify(t);else h=JSON.stringify(t)}else h=t;if(h.trim().startsWith("{"))try{const re=JSON.parse(h);if(re.output){if(typeof re.output=="string")h=re.output;else if(typeof re.output=="object"){const he=re.output.translatedSummary||re.output.imageSummary;if(he)return he}}}catch{}const m=h.match(/(?:#{1,3}\s*)?(?:\*\*)?6\.?\s*(?:\*\*)?\s*\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*\*?\*?\s*:?\s*\n?([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n---|\n```|$)/i);if(m&&m[2]&&m[2].trim())return m[2].trim();const A=h.match(/(?:#{1,3}\s*)?\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\s*\((?:[^()]+|\([^()]*\))+\)\s*:?\s*\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:#{1,3}\s*)?(?:\*\*)?\d+\.|\n\*\*|\n#{1,3}\s|$)/i);if(A&&A[2]&&A[2].trim())return A[2].trim();if(!h.includes("**")&&h.length<1e3)return h.trim();const d=h.match(/\*?\*?(Image Summary|Bildzusammenfassung|RÃ©sumÃ© de l['']Image)\*?\*?\s*\n([\s\S]*?)(?=\n\s*(?:\*\*)?\d+\.\s*\*\*|\n\s*\*\*\d+\.|$)/i);return d&&d[2]&&d[2].trim()?d[2].trim():h.substring(0,500).trim()+"..."},bt=t=>{if(!t||!F.length)return F.map(A=>A.id);let h;if(typeof t!="string"){const A=t;h=A.output&&typeof A.output=="string"?A.output:JSON.stringify(t)}else h=t;if(h.trim().startsWith("{"))try{const A=JSON.parse(h);A.output&&typeof A.output=="string"&&(h=A.output)}catch{}const m=h.toLowerCase();return F.filter(A=>m.includes(A.name.toLowerCase())).map(A=>A.id)},ms=t=>{const h=V.find(he=>he.pageNumber===t),m=M.find(he=>he.pageNumber===t),A=(h==null?void 0:h.description)||(m==null?void 0:m.description)||"",d=(m==null?void 0:m.translatedSummary)||ua(A)||(m==null?void 0:m.imageSummary)||"",re=bt(A);ur({pageNumber:t,scene:d,selectedCharacterIds:re})},br=async()=>{if(!Ye||!L)return;const t=Ye.pageNumber,h=Ye.scene,m=Ye.selectedCharacterIds;ur(null),ke(A=>new Set(A).add(t)),wt(!0);try{await L(t,h,m)}catch(A){console.error("Failed to regenerate image:",A)}finally{ke(A=>{const d=new Set(A);return d.delete(t),d}),ke(A=>(A.size===0&&wt(!1),A))}},Ur=t=>{let h="",m=[];if(t==="front"&&(N!=null&&N.frontCover)){const he=N.frontCover;typeof he=="object"&&(h=he.description||"",m=he.referencePhotos||[])}else if(t==="initial"&&(N!=null&&N.initialPage)){const he=N.initialPage;typeof he=="object"&&(h=he.description||"",m=he.referencePhotos||[])}else if(t==="back"&&(N!=null&&N.backCover)){const he=N.backCover;typeof he=="object"&&(h=he.description||"",m=he.referencePhotos||[])}let A=[];m.length>0&&F.length>0&&(A=F.filter(he=>m.some(_e=>_e.name===he.name)).map(he=>he.id)),A.length===0&&(A=F.map(he=>he.id)),gr({coverType:t,scene:h,selectedCharacterIds:A,title:t==="front"?r:void 0,dedication:t==="initial"?l:void 0})},yr=async()=>{if(!ye||!z)return;const{coverType:t,scene:h,selectedCharacterIds:m,title:A,dedication:d}=ye;gr(null);try{await z(t,h,m,A,d)}catch(re){console.error("Failed to regenerate cover:",re)}},Ht=(t,h,m,A)=>{Cs({type:t,id:h,field:m}),cr(A||"")},Ft=()=>{if(!$e||!R||!Se)return;const{type:t,id:h,field:m}=$e,A={...R};if(t==="secondaryCharacter")A.secondaryCharacters=(A.secondaryCharacters||[]).map(d=>d.id===h?{...d,[m]:jt}:d);else if(t==="animal")A.animals=(A.animals||[]).map(d=>d.id===h?{...d,[m]:jt}:d);else if(t==="artifact")A.artifacts=(A.artifacts||[]).map(d=>d.id===h?{...d,[m]:jt}:d);else if(t==="location")A.locations=(A.locations||[]).map(d=>d.id===h?{...d,[m]:jt}:d);else if(t==="mainCharacter"){const d=parseInt(h);A.mainCharacters=(A.mainCharacters||[]).map(re=>re.id!==d?re:m==="physical.face"?{...re,physical:{...re.physical,face:jt}}:m==="physical.hair"?{...re,physical:{...re.physical,hair:jt}}:m==="physical.build"?{...re,physical:{...re.physical,build:jt}}:re)}Se(A),Cs(null),cr("")},er=()=>{Cs(null),cr("")},Vt=(t=>t?t.split(/(?:---\s*(?:Page|Seite)\s+\d+\s*---|##\s*(?:Page|Seite)\s+\d+)/i).slice(1).filter(m=>m.trim().length>0):[])(Yt?mr:o),Ct=V.length>0,us=f==="1st-grade",ha=(()=>{if(!Te)return Vt.length;if(Vt.length===0)return 0;let t=1;for(let h=2;h<=Vt.length;h++){const m=h-1;if(V.some(d=>d.pageNumber===m&&d.imageData)||!!Je[m])t=h;else break}return t})(),Es=(Me==null?void 0:Me.totalPages)||Vt.length;Me!=null&&Me.totalScenes||V.length||Math.ceil(Es/(us?1:2));const Wt=t=>t?typeof t=="string"?t:t.imageData||null:null,Jr=t=>t?typeof t=="string"?{imageData:t}:t:null,Qr=t=>{var A,d;const m=((A=M.find(re=>re.pageNumber===t))==null?void 0:A.description)||((d=V.find(re=>re.pageNumber===t))==null?void 0:d.description);if(m){if(typeof m=="string")try{const re=JSON.parse(m);return JSON.stringify(re,null,2)}catch{return m}return typeof m=="object"?JSON.stringify(m,null,2):String(m)}},Dr=t=>{const h=M.find(m=>m.pageNumber===t);return t===1&&h&&(console.log("[StoryDisplay] Page 1 scene keys:",Object.keys(h)),console.log("[StoryDisplay] Page 1 has outlineExtract:",!!h.outlineExtract),console.log("[StoryDisplay] Page 1 has scenePrompt:",!!h.scenePrompt)),h==null?void 0:h.outlineExtract},kt=t=>{var h;return(h=M.find(m=>m.pageNumber===t))==null?void 0:h.scenePrompt},qt=t=>{var h;return(h=M.find(m=>m.pageNumber===t))==null?void 0:h.textModelId};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center gap-2",children:Tt?e.jsxs("div",{className:"flex items-center gap-2 w-full max-w-2xl",children:[e.jsx("input",{type:"text",value:De,onChange:t=>Ar(t.target.value),className:"flex-1 text-2xl md:text-3xl font-bold text-gray-800 text-center border-2 border-indigo-300 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500",autoFocus:!0,onKeyDown:t=>{t.key==="Enter"&&Wr(),t.key==="Escape"&&(Ar(r||""),Xt(!1))}}),e.jsx("button",{onClick:Wr,disabled:We||!De.trim(),className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",title:a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save",children:We?e.jsx(ts,{className:"animate-spin",size:20}):e.jsx(ys,{size:20})}),e.jsx("button",{onClick:()=>{Ar(r||""),Xt(!1)},disabled:We,className:"p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",title:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel",children:e.jsx(zt,{size:20})})]}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-800 text-center",children:r||aa.yourStory}),dr&&!j&&e.jsx("button",{onClick:()=>Xt(!0),className:"p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors",title:a==="de"?"Titel bearbeiten":a==="fr"?"Modifier le titre":"Edit title",children:e.jsx(gt,{size:18})})]})}),me&&e.jsx("div",{className:"bg-amber-50 border-2 border-amber-400 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-amber-500 text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-amber-800",children:a==="de"?"UnvollstÃ¤ndige Geschichte":a==="fr"?"Histoire incomplÃ¨te":"Incomplete Story"}),e.jsx("p",{className:"text-amber-700 text-sm mt-1",children:a==="de"?`Diese Geschichte konnte nicht vollstÃ¤ndig generiert werden. ${ge||V.length} von ${Z||"unbekannt"} Seiten wurden erstellt.`:a==="fr"?`Cette histoire n'a pas pu Ãªtre gÃ©nÃ©rÃ©e complÃ¨tement. ${ge||V.length} sur ${Z||"inconnu"} pages ont Ã©tÃ© crÃ©Ã©es.`:`This story could not be fully generated. ${ge||V.length} of ${Z||"unknown"} pages were created.`}),te&&H&&e.jsxs("details",{className:"mt-2 text-sm",children:[e.jsx("summary",{className:"cursor-pointer text-amber-600 hover:text-amber-700",children:a==="de"?"Fehlerdetails":a==="fr"?"DÃ©tails de l'erreur":"Error details"}),e.jsx("p",{className:"mt-1 bg-amber-100 p-2 rounded text-amber-800 font-mono text-xs",children:te})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[Ct&&b&&O&&e.jsxs("button",{onClick:O,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Bn,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),Ct&&x&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>os(!Ot),disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(vs,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Mt,{size:14,className:`transition-transform ${Ot?"rotate-180":""}`})]}),Ot&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:xr==="square",onChange:()=>is("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat",checked:xr==="A4",onChange:()=>is("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{x(xr),os(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),Ct&&b&&!j&&e.jsx(Ro,{storyId:b,variant:"full"}),ne&&e.jsxs("button",{onClick:ne,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Fn,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]}),H&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[T&&e.jsxs("button",{onClick:T,className:"bg-gray-500 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 hover:bg-gray-600",children:[e.jsx(rs,{size:14})," TXT"]}),Ct&&b&&xe&&e.jsxs("button",{onClick:xe,disabled:j,className:`bg-yellow-500 text-black px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 ${j?"opacity-50 cursor-not-allowed":"hover:bg-yellow-600"}`,children:[e.jsx(Ua,{size:14})," Print (DEV)"]})]}),H&&kr&&e.jsx("div",{className:"mt-4",children:e.jsx(To,{settings:kr,language:a})}),H&&e.jsxs("div",{className:"space-y-4 mt-6",children:[c&&e.jsxs("details",{className:"bg-purple-50 border-2 border-purple-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-purple-800 hover:text-purple-900 flex items-center gap-2",children:[e.jsx(vs,{size:20}),us?a==="de"?"VollstÃ¤ndige API-Ausgabe (Kombiniert)":a==="fr"?"Sortie API complÃ¨te (CombinÃ©e)":"Full API Output (Combined)":a==="de"?"VollstÃ¤ndige API-Ausgabe (Outline)":a==="fr"?"Sortie API complÃ¨te (Plan)":"Full API Output (Outline)",E&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-purple-600",children:["(",E,")"]}),g&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-purple-500",children:["[",g.input_tokens.toLocaleString()," in / ",g.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[s&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:s})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-purple-700 mb-2",children:us?a==="de"?"ðŸ“¥ API-Antwort (Kombiniert)":a==="fr"?"ðŸ“¥ RÃ©ponse API (CombinÃ©e)":"ðŸ“¥ API Response (Combined)":a==="de"?"ðŸ“¥ API-Antwort (Outline)":a==="fr"?"ðŸ“¥ RÃ©ponse API (Plan)":"ðŸ“¥ API Response (Outline)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-purple-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:c})]})]})]}),o&&S.length>0&&e.jsxs("details",{className:"bg-amber-50 border-2 border-amber-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Ua,{size:20}),a==="de"?"VollstÃ¤ndige API-Ausgabe (Story-Text)":a==="fr"?"Sortie API complÃ¨te (Texte)":"Full API Output (Story Text)",((xa=S[0])==null?void 0:xa.modelId)&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-amber-600",children:["(",S[0].modelId,")"]}),((Bs=S[0])==null?void 0:Bs.usage)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-500",children:["[",S[0].usage.input_tokens.toLocaleString()," in / ",S[0].usage.output_tokens.toLocaleString()," out]"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¤ Prompt (Eingabe)":a==="fr"?"ðŸ“¤ Prompt (EntrÃ©e)":"ðŸ“¤ Prompt (Input)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((zs=S[0])==null?void 0:zs.prompt)||"No prompt available"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-amber-700 mb-2",children:a==="de"?"ðŸ“¥ Rohe API-Antwort (ungefiltert)":a==="fr"?"ðŸ“¥ RÃ©ponse API brute (non filtrÃ©e)":"ðŸ“¥ Raw API Response (unfiltered)"}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-4 rounded-lg border border-amber-200 overflow-x-auto max-h-[400px] overflow-y-auto",children:((pa=S[0])==null?void 0:pa.rawResponse)||o})]})]})]}),R&&e.jsxs("details",{className:"bg-rose-50 border-2 border-rose-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-rose-800 hover:text-rose-900 flex items-center gap-2",children:[e.jsx(Ua,{size:20}),a==="de"?"Visual Bible (Wiederkehrende Elemente)":a==="fr"?"Bible Visuelle (Ã‰lÃ©ments RÃ©currents)":"Visual Bible (Recurring Elements)",R.changeLog&&R.changeLog.length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-rose-200 text-rose-800 rounded-full text-xs font-medium",children:[R.changeLog.length," ",a==="de"?"Ã„nderungen":a==="fr"?"changements":"changes"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[R.mainCharacters&&R.mainCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-purple-300 rounded-lg p-3",children:[e.jsxs("h4",{className:"text-sm font-bold text-purple-700 mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ‘—"}),a==="de"?"Hauptcharaktere (Style Profile)":a==="fr"?"Personnages Principaux (Profil Style)":"Main Characters (Style Profile)"]}),e.jsx("div",{className:"space-y-3",children:R.mainCharacters.map(t=>{var h,m,A,d;return e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-sm",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-800 hover:text-purple-900",children:[t.name,Object.keys(t.generatedOutfits||{}).length>0&&e.jsxs("span",{className:"ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs",children:[Object.keys(t.generatedOutfits).length," ",a==="de"?"Outfits":a==="fr"?"tenues":"outfits"]})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"font-medium text-gray-600",children:"Physical:"}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[((h=t.physical)==null?void 0:h.skinTone)||"N/A"," | ",((m=t.physical)==null?void 0:m.hair)||"N/A"," | ",((A=t.physical)==null?void 0:A.build)||"N/A",((d=t.physical)==null?void 0:d.other)&&` | ${t.physical.other}`]})]}),t.generatedOutfits&&Object.keys(t.generatedOutfits).length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-purple-200",children:[e.jsx("span",{className:"font-medium text-gray-600 text-xs",children:"Generated Outfits:"}),e.jsx("div",{className:"mt-1 space-y-1",children:Object.entries(t.generatedOutfits).map(([re,he])=>{var _e;return e.jsxs("div",{className:"bg-white p-1.5 rounded text-xs",children:[e.jsxs("span",{className:"font-medium text-purple-600",children:["Page ",re,":"]}),e.jsxs("span",{className:"text-gray-700 ml-1",children:[(_e=he.outfit)==null?void 0:_e.substring(0,80),"..."]}),e.jsx("span",{className:`ml-1 px-1 py-0.5 rounded text-[10px] ${he.setting==="outdoor-cold"?"bg-blue-100 text-blue-700":he.setting==="outdoor-warm"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:he.setting})]},re)})})]})]})]},t.id)})})]}),R.secondaryCharacters&&R.secondaryCharacters.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Nebencharaktere":a==="fr"?"Personnages Secondaires":"Secondary Characters"}),e.jsx("div",{className:"space-y-2",children:R.secondaryCharacters.map(t=>{var h;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[pr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((h=t.appearsInPages)==null?void 0:h.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),($e==null?void 0:$e.type)==="secondaryCharacter"&&($e==null?void 0:$e.id)===t.id&&($e==null?void 0:$e.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:jt,onChange:m=>cr(m.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ft,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(ys,{size:12})," Save"]}),e.jsxs("button",{onClick:er,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),H&&Se&&e.jsx("button",{onClick:()=>Ht("secondaryCharacter",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(gt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((tr=R.animals)==null?void 0:tr.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Tiere & Wesen":a==="fr"?"Animaux & CrÃ©atures":"Animals & Creatures"}),e.jsx("div",{className:"space-y-2",children:R.animals.map(t=>{var h;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[pr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((h=t.appearsInPages)==null?void 0:h.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),($e==null?void 0:$e.type)==="animal"&&($e==null?void 0:$e.id)===t.id&&($e==null?void 0:$e.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:jt,onChange:m=>cr(m.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ft,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(ys,{size:12})," Save"]}),e.jsxs("button",{onClick:er,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),H&&Se&&e.jsx("button",{onClick:()=>Ht("animal",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(gt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((rr=R.artifacts)==null?void 0:rr.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Artefakte & Objekte":a==="fr"?"Artefacts & Objets":"Artifacts & Objects"}),e.jsx("div",{className:"space-y-2",children:R.artifacts.map(t=>{var h;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[pr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((h=t.appearsInPages)==null?void 0:h.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),($e==null?void 0:$e.type)==="artifact"&&($e==null?void 0:$e.id)===t.id&&($e==null?void 0:$e.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:jt,onChange:m=>cr(m.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ft,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(ys,{size:12})," Save"]}),e.jsxs("button",{onClick:er,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),H&&Se&&e.jsx("button",{onClick:()=>Ht("artifact",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(gt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),((Ms=R.locations)==null?void 0:Ms.length)>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Wiederkehrende Orte":a==="fr"?"Lieux RÃ©currents":"Recurring Locations"}),e.jsx("div",{className:"space-y-2",children:R.locations.map(t=>{var h;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[!t.isRealLandmark&&pr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.isRealLandmark&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 font-semibold",children:"ðŸ“ LANDMARK"}),t.photoFetchStatus==="success"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700",children:"ðŸ“· Photo"}),!t.isRealLandmark&&t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((h=t.appearsInPages)==null?void 0:h.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),t.isRealLandmark&&t.landmarkQuery&&e.jsxs("div",{className:"text-amber-700 text-xs mt-1",children:["Landmark: ",e.jsx("span",{className:"font-mono bg-amber-50 px-1 rounded",children:t.landmarkQuery})]}),($e==null?void 0:$e.type)==="location"&&($e==null?void 0:$e.id)===t.id&&($e==null?void 0:$e.field)==="description"?e.jsxs("div",{className:"mt-1",children:[e.jsx("textarea",{value:jt,onChange:m=>cr(m.target.value),className:"w-full p-2 text-xs border border-rose-300 rounded resize-y min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsxs("button",{onClick:Ft,className:"px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 flex items-center gap-1",children:[e.jsx(ys,{size:12})," Save"]}),e.jsxs("button",{onClick:er,className:"px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 flex items-center gap-1",children:[e.jsx(zt,{size:12})," Cancel"]})]})]}):e.jsxs("div",{className:"text-gray-700 text-xs mt-1 flex items-start gap-1",children:[e.jsx("span",{className:"flex-1",children:t.description}),H&&Se&&e.jsx("button",{onClick:()=>Ht("location",t.id,"description",t.description),className:"p-1 text-rose-500 hover:text-rose-700 hover:bg-rose-100 rounded",title:"Edit description",children:e.jsx(gt,{size:12})})]}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]}),t.referencePhotoData&&e.jsxs("div",{className:"mt-2 border border-amber-200 rounded overflow-hidden",children:[e.jsx("img",{src:t.referencePhotoData,alt:`${t.name} reference`,className:"w-full max-h-32 object-contain bg-gray-50"}),t.photoAttribution&&e.jsxs("div",{className:"text-[9px] text-gray-500 bg-gray-100 px-1 py-0.5 truncate",children:["ðŸ“· ",t.photoAttribution]})]})]})]},t.id)})})]}),R.vehicles&&R.vehicles.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Fahrzeuge":a==="fr"?"VÃ©hicules":"Vehicles"}),e.jsx("div",{className:"space-y-2",children:R.vehicles.map(t=>{var h;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm flex gap-3",children:[pr(t.id,t.hasReferenceImage),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2 flex-wrap",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),t.hasReferenceImage&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"has ref"}),((h=t.appearsInPages)==null?void 0:h.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]})]},t.id)})})]}),R.clothing&&R.clothing.length>0&&e.jsxs("div",{className:"bg-white border border-rose-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-bold text-rose-700 mb-2",children:a==="de"?"Kleidung & KostÃ¼me":a==="fr"?"VÃªtements & Costumes":"Clothing & Costumes"}),e.jsx("div",{className:"space-y-2",children:R.clothing.map(t=>{var h;return e.jsxs("div",{className:"bg-rose-50 p-2 rounded text-sm",children:[e.jsxs("div",{className:"font-semibold text-rose-800 flex items-center gap-2",children:[t.name,t.id&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600 font-mono",children:t.id}),t.wornBy&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:["worn by ",t.wornBy]}),t.source&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${t.source==="outline"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:t.source==="outline"?"Outline":"Story"}),((h=t.appearsInPages)==null?void 0:h.length)>0&&e.jsxs("span",{className:"text-xs text-rose-600",children:["(Pages: ",t.appearsInPages.join(", "),")"]})]}),e.jsx("div",{className:"text-gray-700 text-xs mt-1",children:t.description}),t.extractedDescription&&e.jsxs("div",{className:"text-green-700 text-xs mt-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"font-semibold",children:"Extracted:"})," ",t.extractedDescription]})]},t.id)})})]}),R.changeLog&&R.changeLog.length>0&&e.jsxs("details",{className:"bg-white border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-bold text-amber-700 hover:text-amber-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“"}),a==="de"?"Ã„nderungsprotokoll":a==="fr"?"Journal des Modifications":"Change Log",e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-xs",children:R.changeLog.length})]}),e.jsx("div",{className:"mt-2 space-y-1 max-h-[500px] overflow-y-auto",children:R.changeLog.slice().reverse().map((t,h)=>{var m;return e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs border-l-2 border-amber-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.type==="mainCharacter"?"bg-purple-100 text-purple-700":t.type==="secondaryCharacter"?"bg-rose-100 text-rose-700":t.type==="generatedOutfit"?"bg-green-100 text-green-700":t.type==="animal"?"bg-orange-100 text-orange-700":t.type==="artifact"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:t.type}),e.jsx("span",{className:"font-semibold text-amber-800",children:t.element}),e.jsxs("span",{className:"text-gray-500",children:[Re==="de"?"Seite":"Page"," ",t.page]})]}),e.jsxs("div",{className:"mt-1 text-gray-600",children:[e.jsxs("span",{className:"font-medium",children:[t.change,":"]}),e.jsxs("span",{className:"ml-1 text-gray-700",children:[(m=t.after)==null?void 0:m.substring(0,100),t.after&&t.after.length>100?"...":""]})]}),t.before&&e.jsxs("div",{className:"text-gray-400 line-through text-[10px] mt-0.5",children:[a==="de"?"Vorher":a==="fr"?"Avant":"Before",": ",t.before.substring(0,50),"..."]}),e.jsx("div",{className:"text-gray-400 text-[10px] mt-0.5",children:new Date(t.timestamp).toLocaleTimeString()})]},h)})})]}),(!R.mainCharacters||R.mainCharacters.length===0)&&(!R.secondaryCharacters||R.secondaryCharacters.length===0)&&(!R.animals||R.animals.length===0)&&(!R.artifacts||R.artifacts.length===0)&&(!R.locations||R.locations.length===0)&&(!R.vehicles||R.vehicles.length===0)&&(!R.clothing||R.clothing.length===0)&&e.jsx("div",{className:"text-gray-500 text-sm italic",children:a==="de"?"Keine wiederkehrenden Elemente gefunden":a==="fr"?"Aucun Ã©lÃ©ment rÃ©current trouvÃ©":"No recurring elements found in this story"})]})]}),I&&Object.keys(I).length>0&&e.jsxs("details",{className:"bg-teal-50 border-2 border-teal-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-teal-800 hover:text-teal-900 flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸ‘”"}),a==="de"?`Kleidungsanforderungen (${Object.keys(I).length} Charaktere)`:a==="fr"?`Exigences vestimentaires (${Object.keys(I).length} personnages)`:`Clothing Requirements (${Object.keys(I).length} characters)`]}),e.jsx("div",{className:"mt-4 space-y-3",children:Object.entries(I).map(([t,h])=>{var m,A,d,re,he,_e,Be,st,yt,Pt,pe,dt,Zr,ar,vr;return e.jsxs("div",{className:"bg-white border border-teal-200 rounded-lg p-3",children:[e.jsx("h4",{className:"font-bold text-teal-700 mb-2",children:t}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:`p-2 rounded ${(m=h.standard)!=null&&m.used?"bg-green-50 border border-green-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(A=h.standard)!=null&&A.used?"âœ…":"â¬œ"," Standard"]}),((d=h.standard)==null?void 0:d.used)&&((re=h.standard)==null?void 0:re.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:h.standard.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(he=h.winter)!=null&&he.used?"bg-blue-50 border border-blue-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(_e=h.winter)!=null&&_e.used?"â„ï¸":"â¬œ"," Winter"]}),((Be=h.winter)==null?void 0:Be.used)&&((st=h.winter)==null?void 0:st.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:h.winter.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(yt=h.summer)!=null&&yt.used?"bg-yellow-50 border border-yellow-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(Pt=h.summer)!=null&&Pt.used?"â˜€ï¸":"â¬œ"," Summer"]}),((pe=h.summer)==null?void 0:pe.used)&&((dt=h.summer)==null?void 0:dt.signature)&&e.jsx("div",{className:"text-gray-600 mt-1",children:h.summer.signature})]}),e.jsxs("div",{className:`p-2 rounded ${(Zr=h.costumed)!=null&&Zr.used?"bg-purple-50 border border-purple-200":"bg-gray-50 border border-gray-200 opacity-50"}`,children:[e.jsxs("div",{className:"font-semibold text-gray-700 flex items-center gap-1",children:[(ar=h.costumed)!=null&&ar.used?"ðŸŽ­":"â¬œ"," Costumed"]}),((vr=h.costumed)==null?void 0:vr.used)&&e.jsxs("div",{className:"text-gray-600 mt-1",children:[h.costumed.costume&&e.jsxs("span",{className:"font-medium",children:[h.costumed.costume,": "]}),h.costumed.description]})]})]})]},t)})})]}),ie&&ie.length>0&&e.jsxs("details",{className:"bg-pink-50 border-2 border-pink-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-pink-800 hover:text-pink-900 flex items-center gap-2",children:[e.jsx(Or,{size:20}),a==="de"?`Stilisierte Avatare (${ie.length})`:a==="fr"?`Avatars stylisÃ©s (${ie.length})`:`Styled Avatars (${ie.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:ie.map((t,h)=>{var m,A;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-pink-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-pink-700 hover:text-pink-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.artStyle," (",t.clothingCategory||"standard",")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[fr("styled",h,t,"facePhoto","Face Photo",(m=t.inputs.facePhoto)==null?void 0:m.sizeKB),fr("styled",h,t,"originalAvatar","Original Avatar",(A=t.inputs.originalAvatar)==null?void 0:A.sizeKB),t.inputs.styleSample&&fr("styled",h,t,"styleSample","Style Sample",t.inputs.styleSample.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:fr("styled",h,t,"output","Styled Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},h)})})]}),je&&je.length>0&&e.jsxs("details",{className:"bg-orange-50 border-2 border-orange-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-orange-800 hover:text-orange-900 flex items-center gap-2",children:[e.jsx(Or,{size:20}),a==="de"?`KostÃ¼m-Avatare (${je.length})`:a==="fr"?`Avatars costumÃ©s (${je.length})`:`Costumed Avatars (${je.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:je.map((t,h)=>{var m,A;return e.jsxs("details",{className:`border rounded-lg p-3 ${t.success?"bg-white border-orange-200":"bg-red-50 border-red-300"}`,children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 hover:text-orange-800 flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.success?"bg-green-500":"bg-red-500"}`}),t.characterName," - ",t.costumeType," (",t.artStyle,")",e.jsxs("span",{className:"text-xs text-gray-500 ml-auto",children:[(t.durationMs/1e3).toFixed(1),"s"]})]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[t.costumeDescription&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-yellow-700",children:"Costume:"}),e.jsx("p",{className:"mt-1 text-gray-700",children:t.costumeDescription})]}),e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-blue-700",children:"Inputs:"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-3",children:[fr("costumed",h,t,"facePhoto","Face Photo",(m=t.inputs.facePhoto)==null?void 0:m.sizeKB),fr("costumed",h,t,"standardAvatar","Standard Avatar",(A=t.inputs.standardAvatar)==null?void 0:A.sizeKB)]})]}),t.prompt&&e.jsxs("details",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsxs("summary",{className:"cursor-pointer font-semibold text-purple-700 hover:text-purple-800",children:["Prompt (",t.prompt.length," chars)"]}),e.jsx("pre",{className:"mt-2 text-gray-700 whitespace-pre-wrap text-[10px] max-h-[500px] overflow-y-auto",children:t.prompt})]}),t.success&&t.output&&e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Output:"}),e.jsx("div",{className:"mt-2",children:fr("costumed",h,t,"output","Costumed Avatar Output",t.output.sizeKB)})]}),!t.success&&t.error&&e.jsxs("div",{className:"bg-red-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-red-700",children:"Error:"}),e.jsx("p",{className:"mt-1 text-red-600",children:t.error})]}),e.jsxs("div",{className:"text-[10px] text-gray-400",children:["Generated: ",new Date(t.timestamp).toLocaleString()]})]})]},h)})})]}),le&&le.length>0&&e.jsxs("details",{className:"bg-slate-50 border-2 border-slate-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-slate-800 hover:text-slate-900 flex items-center gap-2",children:[e.jsx(vs,{size:20}),a==="de"?`Generierungslog (${le.length})`:a==="fr"?`Journal de gÃ©nÃ©ration (${le.length})`:`Generation Log (${le.length})`,le.filter(t=>t.level==="warn").length>0&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded-full",children:[le.filter(t=>t.level==="warn").length," warnings"]}),le.filter(t=>t.level==="error").length>0&&e.jsxs("span",{className:"ml-1 px-2 py-0.5 bg-red-200 text-red-800 text-xs rounded-full",children:[le.filter(t=>t.level==="error").length," errors"]})]}),e.jsx("div",{className:"mt-4 space-y-1 max-h-96 overflow-y-auto",children:le.map((t,h)=>e.jsxs("div",{className:`text-xs p-2 rounded flex items-start gap-2 ${t.level==="error"?"bg-red-50 text-red-800":t.level==="warn"?"bg-yellow-50 text-yellow-800":t.level==="debug"?"bg-gray-50 text-gray-600":"bg-white text-slate-700"}`,children:[e.jsx("span",{className:"text-gray-400 font-mono text-[10px] whitespace-nowrap",children:new Date(t.timestamp).toLocaleTimeString()}),e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium whitespace-nowrap ${t.stage==="outline"?"bg-blue-100 text-blue-700":t.stage==="avatars"?"bg-purple-100 text-purple-700":t.stage==="scenes"?"bg-green-100 text-green-700":t.stage==="images"?"bg-orange-100 text-orange-700":t.stage==="covers"?"bg-pink-100 text-pink-700":"bg-gray-100 text-gray-700"}`,children:t.stage}),t.character&&e.jsxs("span",{className:"font-medium text-slate-600",children:["[",t.character,"]"]}),e.jsx("span",{className:"flex-1",children:t.message}),e.jsx("span",{className:"text-gray-400 text-[10px]",children:t.event})]},h))})]}),G&&e.jsxs("details",{className:`border-2 rounded-xl p-4 ${G.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsxs("summary",{className:`cursor-pointer text-lg font-bold flex items-center gap-2 ${G.overallConsistent?"text-green-800 hover:text-green-900":"text-amber-800 hover:text-amber-900"}`,children:[G.overallConsistent?"âœ“":"âš ï¸",a==="de"?`KonsistenzprÃ¼fung (${G.totalIssues} Probleme)`:a==="fr"?`VÃ©rification de cohÃ©rence (${G.totalIssues} problÃ¨mes)`:`Final Checks (${G.totalIssues} issues)`]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-700",children:G.summary}),G.imageChecks&&G.imageChecks.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"Bildkonsistenz":a==="fr"?"CohÃ©rence des images":"Image Consistency"}),G.imageChecks.map((t,h)=>{var m,A;return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${t.consistent?"text-green-600":"text-amber-600"}`,children:t.consistent?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:t.type==="full"?"Full Check":t.type==="character"?`Character: ${t.characterName}`:t.type==="sequence"?"Sequence Check":t.type}),t.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",t.overallScore,"/10"]})]}),t.issues&&t.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:t.issues.map((d,re)=>{var he,_e;return e.jsxs("div",{className:`text-xs p-2 rounded ${d.severity==="high"?"bg-red-50 border-l-4 border-red-400":d.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${d.severity==="high"?"bg-red-200 text-red-800":d.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:d.severity}),e.jsxs("span",{className:"text-gray-500",children:["Pages ",(he=d.images)==null?void 0:he.join(", ")]}),d.pagesToFix&&d.pagesToFix.length>0&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px]",children:["Fix: ",d.pagesToFix.join(", ")]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:(_e=d.type)==null?void 0:_e.replace(/_/g," ")}),d.characterInvolved&&e.jsx("span",{className:"px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px]",children:d.characterInvolved})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:d.description}),d.details&&Object.keys(d.details).length>0&&e.jsx("div",{className:"mt-1 pl-2 border-l-2 border-gray-200",children:Object.entries(d.details).map(([Be,st])=>e.jsxs("p",{className:"text-gray-500 text-[10px]",children:[e.jsxs("span",{className:"font-medium",children:[Be,":"]})," ",st]},Be))}),d.canonicalVersion&&e.jsxs("p",{className:"text-blue-700 mt-1",children:["ðŸŽ¯ Target: ",d.canonicalVersion]}),d.recommendation&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:["ðŸ’¡ ",d.recommendation]}),b&&d.pagesToFix&&d.pagesToFix.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:d.pagesToFix.map(Be=>e.jsx("button",{onClick:()=>cs(Be,d),disabled:j||Ir!==null,className:`flex items-center gap-1 px-2 py-1 text-[10px] font-medium rounded transition-colors ${Ir===Be?"bg-amber-300 text-amber-800":j||Ir!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:Ir===Be?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-3 h-3 animate-spin"}),e.jsxs("span",{children:["Repairing P",Be,"..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Lr,{className:"w-3 h-3"}),e.jsxs("span",{children:["Repair P",Be]})]})},Be))})]},re)})}),t.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:t.summary}),(t.evaluationPrompts||t.evaluationPrompt)&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:["ðŸ” View Evaluation Prompt",(((m=t.evaluationPrompts)==null?void 0:m.length)??0)>1?`s (${(A=t.evaluationPrompts)==null?void 0:A.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:(t.evaluationPrompts??(t.evaluationPrompt?[t.evaluationPrompt]:[])).map((d,re)=>{var he;return e.jsxs("div",{children:[(((he=t.evaluationPrompts)==null?void 0:he.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-blue-700 mb-1",children:["Batch ",re+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:d})]},re)})})]}),e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result (Full JSON)"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-96 overflow-y-auto bg-white p-2 rounded border",children:JSON.stringify({type:t.type,characterName:t.characterName,consistent:t.consistent,overallScore:t.overallScore,issues:t.issues,summary:t.summary},null,2)})]}),t.rawResponses&&t.rawResponses.length>0&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsxs("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:["ðŸ“ View Raw Response",t.rawResponses.length>1?`s (${t.rawResponses.length} batches)`:""]}),e.jsx("div",{className:"mt-2 space-y-3",children:t.rawResponses.map((d,re)=>{var he;return e.jsxs("div",{children:[(((he=t.rawResponses)==null?void 0:he.length)??0)>1&&e.jsxs("div",{className:"text-xs font-semibold text-purple-700 mb-1",children:["Batch ",re+1,":"]}),e.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto bg-white p-2 rounded border",children:d})]},re)})})]})]},h)})]}),((sr=G.entity)==null?void 0:sr.grids)&&G.entity.grids.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"EntitÃ¤ts-Konsistenz (Raster)":a==="fr"?"CohÃ©rence des entitÃ©s (grilles)":"Entity Consistency (Grids)"}),e.jsx("div",{className:"space-y-2",children:G.entity.grids.map((t,h)=>{var he,_e,Be,st,yt,Pt,pe,dt,Zr,ar,vr,nr,At,Fr,ba,jr,gs,Ut,Nr,Er,ya,Os,va,Ls,ja,Gs,Na,_s,wa,Hs,Sa,Vs,Ca,wr,ka,Yr,Pa,hs,Aa,xs,$a,ps;const m=(_e=(he=G.entity)==null?void 0:he.characters)==null?void 0:_e[t.entityName],A=(m==null?void 0:m.consistent)??!0,d=(m==null?void 0:m.score)??0,re=(m==null?void 0:m.issues)??[];return e.jsxs("details",{className:`bg-white border rounded-lg overflow-hidden ${A?"border-green-200":"border-amber-200"}`,children:[e.jsxs("summary",{className:"cursor-pointer p-3 flex items-center gap-2 hover:bg-gray-50",children:[e.jsx("span",{className:`text-sm ${A?"text-green-600":"text-amber-600"}`,children:A?"âœ“":"âš ï¸"}),e.jsx("span",{className:"font-medium text-sm text-gray-800",children:t.entityName}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",t.cellCount," appearances)"]}),e.jsxs("span",{className:`ml-auto text-xs px-2 py-0.5 rounded ${d>=8?"bg-green-100 text-green-700":d>=5?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:["Score: ",d,"/10"]})]}),e.jsxs("div",{className:"p-3 border-t border-gray-100 space-y-3",children:[(()=>{const K=t.gridImage||Hr[t.entityName],Ae=Vr.has(t.entityName),Pe=t.gridImageSizeKB;return K?e.jsx("div",{className:"flex justify-center bg-gray-50 rounded p-2",children:e.jsx("img",{src:K,alt:`${t.entityName} consistency grid`,className:"max-w-full h-auto rounded shadow-sm cursor-pointer hover:opacity-90 transition-opacity",style:{maxHeight:"400px"},onClick:()=>Xe({src:K,title:`${t.entityName} - Entity Consistency Grid`}),title:"Click to enlarge"})}):e.jsx("div",{className:"flex justify-center bg-gray-50 rounded p-2",children:e.jsx("button",{onClick:()=>Rs(t.entityName),disabled:Ae,className:"flex items-center gap-2 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm text-gray-700 disabled:opacity-50",children:Ae?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading grid..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Or,{className:"w-4 h-4"}),e.jsxs("span",{children:["Load Grid Image",Pe?` (${Pe} KB)`:""]})]})})})})(),((Be=t.manifest)==null?void 0:Be.cells)&&e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Cells: "}),t.manifest.cells.map((K,Ae)=>{const Pe=t.gridImage||Hr[t.entityName];return e.jsxs("span",{className:"inline-flex items-center bg-gray-100 rounded px-1.5 py-0.5 mr-1 mb-1 gap-1",children:[e.jsxs("button",{onClick:()=>Pe&&ca({...t,gridImage:Pe},Ae),className:`${Pe?"hover:text-blue-600 hover:underline cursor-pointer":"text-gray-400 cursor-not-allowed"}`,title:Pe?"Click to enlarge this cell":"Load grid image first",disabled:!Pe,children:[K.letter,": ",K.isReference?"Ref":`P${K.pageNumber}`,K.clothing&&K.clothing!=="standard"&&` (${K.clothing})`]}),!K.isReference&&b&&typeof K.pageNumber=="number"&&e.jsx("button",{onClick:Kt=>{Kt.stopPropagation(),qr(t.entityName,K.pageNumber)},disabled:j||ot!==null||Fe!==null,className:`ml-0.5 px-1 py-0 text-[9px] rounded transition-colors ${(ot==null?void 0:ot.entity)===t.entityName&&(ot==null?void 0:ot.page)===K.pageNumber?"bg-amber-300 text-amber-800":j||ot!==null||Fe!==null?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,title:`Repair page ${K.pageNumber} for ${t.entityName}`,children:(ot==null?void 0:ot.entity)===t.entityName&&(ot==null?void 0:ot.page)===K.pageNumber?"...":"âš¡"})]},Ae)})]}),re.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Issues:"}),re.map((K,Ae)=>e.jsxs("div",{className:`text-xs p-2 rounded ${K.severity==="critical"?"bg-red-50 border-l-4 border-red-400":K.severity==="major"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${K.severity==="critical"?"bg-red-200 text-red-800":K.severity==="major"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:K.subType||K.type}),K.pagesToFix&&e.jsxs("span",{className:"text-[10px] text-gray-500",children:["Fix page(s): ",K.pagesToFix.join(", ")]})]}),e.jsx("p",{className:"mt-1 text-gray-700",children:K.description}),K.fixInstruction&&e.jsx("p",{className:"mt-1 text-blue-600 italic",children:K.fixInstruction})]},Ae))]}),(m==null?void 0:m.summary)&&e.jsx("p",{className:"text-xs text-gray-500 italic",children:m.summary}),b&&(!A||d<8)&&t.entityType==="character"&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[e.jsx("button",{onClick:()=>mt(t.entityName),disabled:j||Fe!==null,className:`flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded transition-colors ${j||Fe!==null?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-amber-500 text-white hover:bg-amber-600"}`,children:Fe===t.entityName?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Repairing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Lr,{className:"w-3 h-3"}),e.jsx("span",{children:"Repair Consistency"})]})}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:"Regenerate appearances to match reference photo"})]}),((st=G.entityRepairs)==null?void 0:st[t.entityName])&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-medium text-green-600",children:"âœ“ Repaired"}),e.jsxs("span",{className:"text-[10px] text-gray-400",children:[(Pt=(yt=G.entityRepairs)==null?void 0:yt[t.entityName])!=null&&Pt.cellsRepaired?`${(pe=G.entityRepairs[t.entityName])==null?void 0:pe.cellsRepaired} pages updated`:(Zr=(dt=G.entityRepairs)==null?void 0:dt[t.entityName])!=null&&Zr.pages?`${Object.keys(((ar=G.entityRepairs[t.entityName])==null?void 0:ar.pages)||{}).length} page(s) repaired individually`:"repair complete",(((nr=(vr=G.entityRepairs)==null?void 0:vr[t.entityName])==null?void 0:nr.clothingGroupCount)??0)>1&&` (${(Fr=(At=G.entityRepairs)==null?void 0:At[t.entityName])==null?void 0:Fr.clothingGroupCount} clothing groups)`]})]}),(gs=(jr=(ba=G.entityRepairs)==null?void 0:ba[t.entityName])==null?void 0:jr.gridsByClothing)!=null&&gs.length?e.jsx("div",{className:"space-y-4",children:(Er=(Nr=(Ut=G.entityRepairs)==null?void 0:Ut[t.entityName])==null?void 0:Nr.gridsByClothing)==null?void 0:Er.map(K=>{var Ae;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 border-b border-gray-100 pb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase",children:K.clothingCategory}),e.jsxs("span",{className:"text-[9px] text-gray-400",children:["(",K.cropCount," pages)"]}),e.jsxs("span",{className:"text-[9px] text-gray-400 ml-auto",children:["ref: ",K.referenceUsed]})]}),(Ae=K.cellComparisons)!=null&&Ae.length?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[9px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Cell"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),K.cellComparisons.map(Pe=>e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-xs font-bold text-gray-700",children:Pe.letter}),e.jsxs("div",{className:"text-[9px] text-gray-400",children:["P",Pe.pageNumber]})]}),e.jsx("img",{src:Pe.before,alt:`${Pe.letter} before`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>Pe.before&&Xe({src:Pe.before,title:`${t.entityName} - Cell ${Pe.letter} Page ${Pe.pageNumber} Before (${K.clothingCategory})`})}),e.jsx("img",{src:Pe.after,alt:`${Pe.letter} after`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>Pe.after&&Xe({src:Pe.after,title:`${t.entityName} - Cell ${Pe.letter} Page ${Pe.pageNumber} After (${K.clothingCategory})`})}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:Pe.diff,alt:`${Pe.letter} diff`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>Pe.diff&&Xe({src:Pe.diff,title:`${t.entityName} - Cell ${Pe.letter} Page ${Pe.pageNumber} Diff (${K.clothingCategory})`})})})]},`${K.clothingCategory}-${Pe.letter}`))]}):e.jsxs("div",{className:`grid gap-2 ${K.gridDiff?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"Before"}),e.jsx("div",{className:"bg-gray-50 rounded p-0.5",children:e.jsx("img",{src:K.gridBefore,alt:"Before repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>K.gridBefore&&Xe({src:K.gridBefore,title:`${t.entityName} - ${K.clothingCategory} Grid Before`})})})]}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"After"}),e.jsx("div",{className:"bg-gray-50 rounded p-0.5",children:e.jsx("img",{src:K.gridAfter,alt:"After repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>K.gridAfter&&Xe({src:K.gridAfter,title:`${t.entityName} - ${K.clothingCategory} Grid After`})})})]}),K.gridDiff&&e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-[9px] font-medium text-gray-500",children:"Diff"}),e.jsx("div",{className:"bg-gray-900 rounded p-0.5",children:e.jsx("img",{src:K.gridDiff,alt:"Difference",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>Xe({src:K.gridDiff,title:`${t.entityName} - ${K.clothingCategory} Grid Diff`})})})]})]})]},K.clothingCategory)})}):(va=(Os=(ya=G.entityRepairs)==null?void 0:ya[t.entityName])==null?void 0:Os.cellComparisons)!=null&&va.length?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[10px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Cell"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),(Gs=(ja=(Ls=G.entityRepairs)==null?void 0:Ls[t.entityName])==null?void 0:ja.cellComparisons)==null?void 0:Gs.map(K=>e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-xs font-bold text-gray-700",children:K.letter}),e.jsxs("div",{className:"text-[9px] text-gray-400",children:["P",K.pageNumber]})]}),e.jsx("img",{src:K.before,alt:`${K.letter} before`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>K.before&&Xe({src:K.before,title:`${t.entityName} - Cell ${K.letter} Page ${K.pageNumber} Before`})}),e.jsx("img",{src:K.after,alt:`${K.letter} after`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>K.after&&Xe({src:K.after,title:`${t.entityName} - Cell ${K.letter} Page ${K.pageNumber} After`})}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:K.diff,alt:`${K.letter} diff`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>K.diff&&Xe({src:K.diff,title:`${t.entityName} - Cell ${K.letter} Page ${K.pageNumber} Diff`})})})]},K.letter))]}):(_s=(Na=G.entityRepairs)==null?void 0:Na[t.entityName])!=null&&_s.pages&&Object.keys(((wa=G.entityRepairs[t.entityName])==null?void 0:wa.pages)||{}).length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-1 text-[10px] font-medium text-gray-500 px-1",children:[e.jsx("span",{children:"Page"}),e.jsx("span",{children:"Before"}),e.jsx("span",{children:"After"}),e.jsx("span",{children:"Diff"})]}),Object.entries(((Hs=G.entityRepairs[t.entityName])==null?void 0:Hs.pages)||{}).map(([K,Ae])=>{var Pe,Kt,fs;return e.jsxs("div",{className:"grid grid-cols-4 gap-1 items-center bg-gray-50 rounded p-1",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("span",{className:"text-xs font-bold text-gray-700",children:["P",K]}),Ae.clothingCategory&&Ae.clothingCategory!=="standard"&&e.jsx("div",{className:"text-[8px] text-gray-400",children:Ae.clothingCategory})]}),e.jsx("img",{src:(Pe=Ae.comparison)==null?void 0:Pe.before,alt:`P${K} before`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var et;return((et=Ae.comparison)==null?void 0:et.before)&&Xe({src:Ae.comparison.before,title:`${t.entityName} - Page ${K} Before${Ae.clothingCategory?` (${Ae.clothingCategory})`:""}`})}}),e.jsx("img",{src:(Kt=Ae.comparison)==null?void 0:Kt.after,alt:`P${K} after`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var et;return((et=Ae.comparison)==null?void 0:et.after)&&Xe({src:Ae.comparison.after,title:`${t.entityName} - Page ${K} After${Ae.clothingCategory?` (${Ae.clothingCategory})`:""}`})}}),e.jsx("div",{className:"bg-gray-900 rounded",children:e.jsx("img",{src:(fs=Ae.comparison)==null?void 0:fs.diff,alt:`P${K} diff`,className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var et;return((et=Ae.comparison)==null?void 0:et.diff)&&Xe({src:Ae.comparison.diff,title:`${t.entityName} - Page ${K} Diff${Ae.clothingCategory?` (${Ae.clothingCategory})`:""}`})}})})]},K)})]}):(Vs=(Sa=G.entityRepairs)==null?void 0:Sa[t.entityName])!=null&&Vs.gridBeforeRepair?e.jsxs("div",{className:`grid gap-3 ${(wr=(Ca=G.entityRepairs)==null?void 0:Ca[t.entityName])!=null&&wr.gridDiff?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"Before Repair"}),e.jsx("div",{className:"bg-gray-50 rounded p-1",children:e.jsx("img",{src:(Yr=(ka=G.entityRepairs)==null?void 0:ka[t.entityName])==null?void 0:Yr.gridBeforeRepair,alt:"Before repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var Ae,Pe;const K=(Pe=(Ae=G.entityRepairs)==null?void 0:Ae[t.entityName])==null?void 0:Pe.gridBeforeRepair;K&&Xe({src:K,title:`${t.entityName} - Grid Before Repair`})}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"After Repair"}),e.jsx("div",{className:"bg-gray-50 rounded p-1",children:e.jsx("img",{src:(hs=(Pa=G.entityRepairs)==null?void 0:Pa[t.entityName])==null?void 0:hs.gridAfterRepair,alt:"After repair",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var Ae,Pe;const K=(Pe=(Ae=G.entityRepairs)==null?void 0:Ae[t.entityName])==null?void 0:Pe.gridAfterRepair;K&&Xe({src:K,title:`${t.entityName} - Grid After Repair`})}})})]}),((xs=(Aa=G.entityRepairs)==null?void 0:Aa[t.entityName])==null?void 0:xs.gridDiff)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-500",children:"Difference"}),e.jsx("div",{className:"bg-gray-900 rounded p-1",children:e.jsx("img",{src:((ps=($a=G.entityRepairs)==null?void 0:$a[t.entityName])==null?void 0:ps.gridDiff)??void 0,alt:"Difference",className:"w-full h-auto rounded cursor-pointer hover:opacity-80",onClick:()=>{var Ae,Pe;const K=(Pe=(Ae=G.entityRepairs)==null?void 0:Ae[t.entityName])==null?void 0:Pe.gridDiff;K&&Xe({src:K,title:`${t.entityName} - Grid Diff`})}})})]})]}):null]})]})]},h)})}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:G.entity.summary})]}),G.textCheck&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm text-gray-800",children:a==="de"?"TextqualitÃ¤t":a==="fr"?"QualitÃ© du texte":"Text Quality"}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:`text-sm font-medium ${G.textCheck.quality==="good"?"text-green-600":G.textCheck.quality==="needs_review"?"text-amber-600":"text-red-600"}`,children:G.textCheck.quality==="good"?"âœ“":"âš ï¸"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:G.textCheck.quality==="good"?"Good":G.textCheck.quality==="needs_review"?"Needs Review":"Has Issues"}),G.textCheck.overallScore!==void 0&&e.jsxs("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-0.5 rounded",children:["Score: ",G.textCheck.overallScore,"/10"]})]}),G.textCheck.issues&&G.textCheck.issues.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:G.textCheck.issues.map((t,h)=>e.jsxs("div",{className:`text-xs p-2 rounded ${t.severity==="high"?"bg-red-50 border-l-4 border-red-400":t.severity==="medium"?"bg-amber-50 border-l-4 border-amber-400":"bg-gray-50 border-l-4 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium ${t.severity==="high"?"bg-red-200 text-red-800":t.severity==="medium"?"bg-amber-200 text-amber-800":"bg-gray-200 text-gray-700"}`,children:t.severity}),t.page&&e.jsxs("span",{className:"text-gray-500",children:["Page ",t.page]}),e.jsx("span",{className:"px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px]",children:t.type})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:t.issue}),(t.originalText||t.text)&&e.jsxs("p",{className:"text-red-600 mt-1 line-through",children:['"',t.originalText||t.text,'"']}),t.correctedText&&e.jsxs("p",{className:"text-green-700 mt-1 font-medium",children:['âœ“ "',t.correctedText,'"']}),!t.correctedText&&t.suggestion&&e.jsxs("p",{className:"text-green-700 mt-1",children:["â†’ ",t.suggestion]})]},h))}),G.textCheck.summary&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 italic",children:G.textCheck.summary}),G.textCheck.fullOriginalText&&e.jsxs("details",{className:"mt-3 bg-gray-50 border border-gray-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-gray-700",children:"ðŸ“„ View Original Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-600 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:G.textCheck.fullOriginalText})]}),G.textCheck.fullCorrectedText&&e.jsxs("details",{className:"mt-3 bg-green-50 border border-green-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-green-800",children:"ðŸ“‹ View Full Corrected Text"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:G.textCheck.fullCorrectedText})]}),G.textCheck.rawResponse&&e.jsxs("details",{className:"mt-3 bg-purple-50 border border-purple-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-purple-800",children:"ðŸ“ View Raw Response"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:G.textCheck.rawResponse})]}),G.textCheck&&e.jsxs("details",{className:"mt-3 bg-indigo-50 border border-indigo-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-indigo-800",children:"ðŸ”§ View Parsed Result"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:JSON.stringify({quality:G.textCheck.quality,overallScore:G.textCheck.overallScore,issues:G.textCheck.issues,summary:G.textCheck.summary,parseError:G.textCheck.parseError},null,2)})]}),G.textCheck.evaluationPrompt&&e.jsxs("details",{className:"mt-3 bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("summary",{className:"cursor-pointer text-xs font-medium text-blue-800",children:"ðŸ” View Evaluation Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-sans max-h-[500px] overflow-y-auto",children:G.textCheck.evaluationPrompt})]})]})]}),G.error&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-2 text-xs text-red-700",children:["Error: ",G.error]})]})]}),M.length>0&&e.jsxs("details",{className:"bg-green-50 border-2 border-green-200 rounded-xl p-4",children:[e.jsxs("summary",{className:"cursor-pointer text-lg font-bold text-green-800 hover:text-green-900 flex items-center gap-2",children:[e.jsx(vs,{size:20}),a==="de"?`Alle Szenenbeschreibungen (${M.length})`:a==="fr"?`Toutes les descriptions de scÃ¨nes (${M.length})`:`All Scene Descriptions (${M.length})`]}),e.jsx("div",{className:"mt-4 space-y-4",children:M.map(t=>e.jsxs("details",{className:"bg-white border border-green-200 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-700 hover:text-green-800",children:Re==="de"?`Seite ${t.pageNumber}`:Re==="fr"?`Page ${t.pageNumber}`:`Page ${t.pageNumber}`}),e.jsxs("div",{className:"mt-2 space-y-2",children:[t.outlineExtract&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-amber-700",children:"Outline Extract:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.outlineExtract})]}),t.scenePrompt&&e.jsxs("div",{className:"bg-purple-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-purple-700",children:"Scene Prompt:"}),e.jsx("p",{className:"text-gray-700 mt-1 whitespace-pre-wrap",children:t.scenePrompt})]}),e.jsxs("div",{className:"bg-green-50 p-2 rounded text-xs",children:[e.jsx("span",{className:"font-semibold text-green-700",children:"Scene Description:"}),t.textModelId&&e.jsxs("span",{className:"ml-2 text-green-600",children:["(",t.textModelId,")"]}),e.jsx("pre",{className:"text-gray-700 mt-1 whitespace-pre-wrap font-mono text-xs overflow-x-auto",children:(()=>{if(typeof t.description=="string")try{const h=JSON.parse(t.description);return JSON.stringify(h,null,2)}catch{return t.description}if(typeof t.description=="object"){const h=t.description;if(h!=null&&h.text)try{const m=JSON.parse(h.text);return JSON.stringify(m,null,2)}catch{return h.text}return JSON.stringify(t.description,null,2)}return String(t.description)})()})]})]})]},t.pageNumber))})]})]}),N&&Wt(N.frontCover)&&(()=>{var h,m;const t=Jr(N.frontCover);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Re==="de"?"Titelseite":Re==="fr"?"Couverture":"Front Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(La,{src:Wt(N.frontCover),alt:"Front Cover",className:"w-full rounded-lg shadow-lg",label:"Front Cover"}),k.has("frontCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(Ze,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),z&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Ur("front"),disabled:j||!ct||k.has("frontCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||!ct||k.has("frontCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:ct?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Qt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Zt," ",a==="de"?"Credits":"credits",")"]})]})}),H&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[P&&e.jsxs("button",{onClick:()=>P("front"),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const A=t.description;if(typeof A=="string")try{return JSON.stringify(JSON.parse(A),null,2)}catch{return A}if(typeof A=="object"){const d=A;if(d!=null&&d.text)try{return JSON.stringify(JSON.parse(d.text),null,2)}catch{return d.text}return JSON.stringify(A,null,2)}return String(A)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((h=t.referencePhotos)==null?void 0:h.length)??0)>0||(((m=t.landmarkPhotos)==null?void 0:m.length)??0)>0||t.visualBibleGrid)&&e.jsx(Ys,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),e.jsx(Zs,{retryHistory:t.retryHistory,bboxDetection:t.bboxDetection,bboxOverlayImage:t.bboxOverlayImage,language:a,storyId:b,pageNumber:0}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(js,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),N&&Wt(N.initialPage)&&(()=>{var h,m;const t=Jr(N.initialPage);return e.jsxs("div",{className:"mt-6 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Re==="de"?"Widmungsseite":Re==="fr"?"Page de dÃ©dicace":"Dedication Page"}),e.jsxs("div",{className:"relative",children:[e.jsx(La,{src:Wt(N.initialPage),alt:"Dedication Page",className:"w-full rounded-lg shadow-lg",label:"Dedication Page"}),k.has("initialPage")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(Ze,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),z&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Ur("initial"),disabled:j||!ct||k.has("initialPage"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||!ct||k.has("initialPage")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:ct?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Qt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Zt," ",a==="de"?"Credits":"credits",")"]})]})}),H&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[P&&e.jsxs("button",{onClick:()=>P("initial"),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const A=t.description;if(typeof A=="string")try{return JSON.stringify(JSON.parse(A),null,2)}catch{return A}if(typeof A=="object"){const d=A;if(d!=null&&d.text)try{return JSON.stringify(JSON.parse(d.text),null,2)}catch{return d.text}return JSON.stringify(A,null,2)}return String(A)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((h=t.referencePhotos)==null?void 0:h.length)??0)>0||(((m=t.landmarkPhotos)==null?void 0:m.length)??0)>0||t.visualBibleGrid)&&e.jsx(Ys,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),e.jsx(Zs,{retryHistory:t.retryHistory,bboxDetection:t.bboxDetection,bboxOverlayImage:t.bboxOverlayImage,language:a,storyId:b,pageNumber:-1}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(js,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),Te&&!o&&(N==null?void 0:N.frontCover)&&e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-8 mt-6",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-indigo-700",children:Re==="de"?"Geschichte wird erstellt...":Re==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:Re==="de"?"Die Seiten werden gleich angezeigt":Re==="fr"?"Les pages seront bientÃ´t affichÃ©es":"Pages will appear shortly"})]})}),Ct&&o&&e.jsxs("div",{className:"space-y-8 mt-8",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 text-center mb-6",children:r||(Re==="de"?"Ihre Geschichte":Re==="fr"?"Votre histoire":"Your Story")}),Vt.slice(0,Te?ha:Vt.length).map((t,h)=>{var Be,st,yt,Pt;const m=h+1,A=m,d=V.find(pe=>pe.pageNumber===A),re=Te?Je[A]:void 0,he=!!(d!=null&&d.imageData||re),_e=Te&&m===ha&&!he;return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:Re==="de"?`Seite ${m}`:Re==="fr"?`Page ${m}`:`Page ${m}`}),us?e.jsxs("div",{className:"flex flex-col items-center max-w-2xl mx-auto",children:[_e?e.jsxs("div",{className:"w-full mb-4 aspect-[4/3] bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg shadow-md flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-indigo-600 font-medium",children:Re==="de"?"Bild wird erstellt...":Re==="fr"?"CrÃ©ation de l'image...":"Creating image..."}),e.jsx("p",{className:"text-indigo-400 text-sm mt-1",children:Re==="de"?"Die nÃ¤chste Seite erscheint bald":Re==="fr"?"La page suivante arrive bientÃ´t":"Next page coming soon"})]}):d!=null&&d.imageData||re?e.jsxs("div",{className:"w-full mb-4 relative",children:[e.jsx(La,{src:((d==null?void 0:d.imageData)||re)??"",alt:`Scene for page ${m}`,className:`w-full rounded-lg shadow-md object-cover ${ht.has(m)?"opacity-50":""}`,label:`Page ${m}`}),ht.has(m)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(ts,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]}),L&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>ms(m),disabled:j||ht.has(m)||!ct,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||ht.has(m)||!ct?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:ct?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Qt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Zt," ",a==="de"?"Credits":"credits",")"]})]}),vt&&e.jsxs("button",{onClick:()=>Gr(!0),disabled:j,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),_t(m).length>1&&e.jsxs("button",{onClick:()=>$r({pageNumber:m,versions:_t(m)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(Or,{size:14}),_t(m).length]})]})}),H&&e.jsxs("div",{className:"mt-3 space-y-2",children:[W&&e.jsxs("button",{onClick:()=>W(m),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),ee&&e.jsx("button",{onClick:()=>Lt(m),disabled:j||xt!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||xt!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:xt===m?e.jsxs(e.Fragment,{children:[e.jsx(ts,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Lr,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),Q&&e.jsx("button",{onClick:()=>Gt(m),disabled:j||nt!==null||xt!==null,className:`w-full bg-purple-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||nt!==null||xt!==null?"opacity-50 cursor-not-allowed":"hover:bg-purple-600"}`,title:a==="de"?"Bild analysieren, 17 Checks durchfÃ¼hren, mit korrigierter Szene neu generieren":a==="fr"?"Analyser l'image, exÃ©cuter 17 vÃ©rifications, rÃ©gÃ©nÃ©rer avec scÃ¨ne corrigÃ©e":"Analyze image, run 17 checks, regenerate with corrected scene",children:nt===m?e.jsxs(e.Fragment,{children:[e.jsx(ts,{size:14,className:"animate-spin"}),a==="de"?"Iteriere...":a==="fr"?"ItÃ©ration...":"Iterating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(qa,{size:14}),a==="de"?"NÃ¤chste Iteration":a==="fr"?"Prochaine ItÃ©ration":"Next Iteration"]})}),(d==null?void 0:d.repairHistory)&&d.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Lr,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",d.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:d.repairHistory.map((pe,dt)=>e.jsxs("div",{className:`border rounded-lg p-3 ${pe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${pe.attempt}`:`Repair ${pe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${pe.success?"text-green-600":"text-red-600"}`,children:["(",pe.success?"âœ“":"âœ—"," ",pe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:pe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",pe.fixPrompt]}),pe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:pe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),pe.beforeImage&&pe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>Ps({beforeImage:pe.beforeImage,afterImage:pe.afterImage,diffImage:pe.diffImage,title:a==="de"?`Reparatur ${pe.attempt}`:`Repair ${pe.attempt}`}),title:a==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:pe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:pe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),pe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:pe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(pe.timestamp).toLocaleTimeString()})]},dt))})]}),Dr(m)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Dr(m)})]}),kt(m)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:kt(m)})]}),Qr(m)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",qt(m)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",qt(m),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Qr(m)})]}),(d==null?void 0:d.prompt)&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",(d==null?void 0:d.modelId)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",d.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:d==null?void 0:d.prompt})]}),((((Be=d==null?void 0:d.referencePhotos)==null?void 0:Be.length)??0)>0||(((st=d==null?void 0:d.landmarkPhotos)==null?void 0:st.length)??0)>0||(d==null?void 0:d.visualBibleGrid))&&d&&e.jsx(Ys,{referencePhotos:d.referencePhotos||[],landmarkPhotos:d.landmarkPhotos,visualBibleGrid:d.visualBibleGrid,language:a,storyId:b||void 0,pageNumber:m}),(d==null?void 0:d.qualityScore)!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",(d==null?void 0:d.qualityModelId)&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",d.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${((d==null?void 0:d.qualityScore)??0)>=70?"text-green-600":((d==null?void 0:d.qualityScore)??0)>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round((d==null?void 0:d.qualityScore)??0),"%"]})]}),(d==null?void 0:d.qualityReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.qualityReasoning})]})]}),e.jsx(Zs,{retryHistory:d==null?void 0:d.retryHistory,language:a,storyId:b,pageNumber:d==null?void 0:d.pageNumber}),(d==null?void 0:d.retryHistory)&&d.retryHistory.length>0&&e.jsx(js,{retryHistory:d.retryHistory,totalAttempts:(d==null?void 0:d.totalAttempts)||d.retryHistory.length,language:a,onRevertRepair:Ne?(pe,dt)=>Ne(d.pageNumber,dt):void 0,storyId:b,pageNumber:d.pageNumber}),(d==null?void 0:d.wasRegenerated)&&(!(d!=null&&d.retryHistory)||d.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),(d==null?void 0:d.originalScore)!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(d.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),(d==null?void 0:d.originalImage)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:d.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),(d==null?void 0:d.originalReasoning)&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`w-full flex flex-col items-center justify-center rounded-lg p-8 mb-4 ${j?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Re==="de"?"Bild wird noch erstellt...":Re==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Re==="de"?"Kein Bild fÃ¼r diese Seite":Re==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"w-full bg-indigo-50 rounded-lg p-6 border-2 border-indigo-200",children:Yt?e.jsx("textarea",{value:t.trim(),onChange:pe=>St(h,pe.target.value),className:"w-full min-h-[400px] p-3 text-gray-800 leading-snug font-serif text-xl text-center bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl text-center",children:t.trim()})})]}):e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-stretch",children:[d&&d.imageData?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:d.imageData,alt:`Scene for page ${m}`,className:`w-full rounded-lg shadow-md object-cover ${ht.has(m)?"opacity-50":""}`}),ht.has(m)&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 rounded-lg",children:[e.jsx(ts,{size:40,className:"animate-spin text-indigo-600 mb-2"}),e.jsx("p",{className:"text-indigo-700 font-medium text-sm",children:a==="de"?"Neues Bild wird erstellt...":a==="fr"?"Nouvelle image en cours...":"Generating new image..."})]})]}),L&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("button",{onClick:()=>ms(m),disabled:j||ht.has(m)||!ct,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||ht.has(m)||!ct?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:ct?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Qt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Zt," ",a==="de"?"Credits":"credits",")"]})]}),vt&&e.jsxs("button",{onClick:()=>Gr(!0),disabled:j,className:`flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14}),a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),_t(m).length>1&&e.jsxs("button",{onClick:()=>$r({pageNumber:m,versions:_t(m)}),className:"px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm text-gray-600 flex items-center gap-1",children:[e.jsx(Or,{size:14}),_t(m).length]})]})}),H&&e.jsxs("div",{className:"mt-3 space-y-2",children:[W&&e.jsxs("button",{onClick:()=>W(m),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),ee&&e.jsx("button",{onClick:()=>Lt(m),disabled:j||xt!==null,className:`w-full bg-amber-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||xt!==null?"opacity-50 cursor-not-allowed":"hover:bg-amber-600"}`,title:a==="de"?"Physik-Fehler automatisch erkennen und reparieren":a==="fr"?"DÃ©tecter et rÃ©parer automatiquement les erreurs physiques":"Automatically detect and fix physics errors",children:xt===m?e.jsxs(e.Fragment,{children:[e.jsx(ts,{size:14,className:"animate-spin"}),a==="de"?"Repariere...":a==="fr"?"RÃ©paration...":"Repairing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Lr,{size:14}),a==="de"?"Auto-Reparatur":a==="fr"?"Auto-RÃ©paration":"Auto-Repair"]})}),Q&&e.jsx("button",{onClick:()=>Gt(m),disabled:j||nt!==null||xt!==null,className:`w-full bg-purple-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||nt!==null||xt!==null?"opacity-50 cursor-not-allowed":"hover:bg-purple-600"}`,title:a==="de"?"Bild analysieren, 17 Checks durchfÃ¼hren, mit korrigierter Szene neu generieren":a==="fr"?"Analyser l'image, exÃ©cuter 17 vÃ©rifications, rÃ©gÃ©nÃ©rer avec scÃ¨ne corrigÃ©e":"Analyze image, run 17 checks, regenerate with corrected scene",children:nt===m?e.jsxs(e.Fragment,{children:[e.jsx(ts,{size:14,className:"animate-spin"}),a==="de"?"Iteriere...":a==="fr"?"ItÃ©ration...":"Iterating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(qa,{size:14}),a==="de"?"NÃ¤chste Iteration":a==="fr"?"Prochaine ItÃ©ration":"Next Iteration"]})}),(d==null?void 0:d.repairHistory)&&d.repairHistory.length>0&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900 flex items-center gap-2",children:[e.jsx(Lr,{size:14}),a==="de"?"Reparatur-Historie":a==="fr"?"Historique de rÃ©paration":"Repair History",e.jsxs("span",{className:"text-amber-600 font-normal",children:["(",d.repairHistory.length," ",a==="de"?"Reparaturen":"repairs",")"]})]}),e.jsx("div",{className:"mt-3 space-y-3",children:d.repairHistory.map((pe,dt)=>e.jsxs("div",{className:`border rounded-lg p-3 ${pe.success?"bg-green-50 border-green-300":"bg-red-50 border-red-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("span",{className:"font-semibold text-sm",children:[a==="de"?`Reparatur ${pe.attempt}`:`Repair ${pe.attempt}`,e.jsxs("span",{className:`ml-2 text-xs ${pe.success?"text-green-600":"text-red-600"}`,children:["(",pe.success?"âœ“":"âœ—"," ",pe.errorType,")"]})]})}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:pe.description}),e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer text-amber-700",children:a==="de"?"Details anzeigen":"Show details"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"bg-white p-2 rounded border",children:[e.jsx("strong",{children:a==="de"?"Fix-Anweisung:":"Fix instruction:"})," ",pe.fixPrompt]}),pe.maskImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1",children:a==="de"?"Maske:":"Mask:"}),e.jsx("img",{src:pe.maskImage,alt:"Repair mask",className:"w-32 h-32 object-contain border rounded"})]}),pe.beforeImage&&pe.afterImage&&e.jsxs("div",{className:"flex gap-4 cursor-pointer p-2 -m-2 rounded-lg hover:bg-amber-100 transition-colors",onClick:()=>Ps({beforeImage:pe.beforeImage,afterImage:pe.afterImage,diffImage:pe.diffImage,title:a==="de"?`Reparatur ${pe.attempt}`:`Repair ${pe.attempt}`}),title:a==="de"?"Klicken fÃ¼r Vergleichsansicht":"Click to compare",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Vorher:":"Before:"}),e.jsx("img",{src:pe.beforeImage,alt:"Before repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:a==="de"?"Nachher:":"After:"}),e.jsx("img",{src:pe.afterImage,alt:"After repair",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]}),pe.diffImage&&e.jsxs("div",{children:[e.jsx("strong",{className:"block mb-1 text-xs",children:"Diff:"}),e.jsx("img",{src:pe.diffImage,alt:"Difference",className:"w-32 h-32 object-contain border rounded bg-gray-100"})]})]})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(pe.timestamp).toLocaleTimeString()})]},dt))})]}),Dr(m)&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:a==="de"?"Auszug aus Gliederung":a==="fr"?"Extrait du plan":"Outline Extract"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Dr(m)})]}),kt(m)&&e.jsxs("details",{className:"bg-purple-50 border border-purple-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-purple-800 hover:text-purple-900",children:a==="de"?"Szenen-Prompt":a==="fr"?"Prompt de scÃ¨ne":"Scene Prompt"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:kt(m)})]}),Qr(m)&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:[a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description",qt(m)&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-green-600",children:["(",qt(m),")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:Qr(m)})]}),d.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",d.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",d.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:d.prompt})]}),((((yt=d.referencePhotos)==null?void 0:yt.length)??0)>0||(((Pt=d.landmarkPhotos)==null?void 0:Pt.length)??0)>0||d.visualBibleGrid)&&e.jsx(Ys,{referencePhotos:d.referencePhotos||[],landmarkPhotos:d.landmarkPhotos,visualBibleGrid:d.visualBibleGrid,language:a,storyId:b||void 0,pageNumber:m}),d.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",d.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",d.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${d.qualityScore>=70?"text-green-600":d.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(d.qualityScore),"%"]})]}),d.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.qualityReasoning})]})]}),e.jsx(Zs,{retryHistory:d.retryHistory,language:a,storyId:b,pageNumber:d.pageNumber}),d.retryHistory&&d.retryHistory.length>0&&e.jsx(js,{retryHistory:d.retryHistory,totalAttempts:d.totalAttempts||d.retryHistory.length,language:a,onRevertRepair:Ne?(pe,dt)=>Ne(d.pageNumber,dt):void 0,storyId:b,pageNumber:d.pageNumber}),d.wasRegenerated&&(!d.retryHistory||d.retryHistory.length===0)&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-700 flex items-center justify-between",children:[e.jsxs("span",{children:["ðŸ”„ ",a==="de"?"Bild regeneriert":a==="fr"?"Image rÃ©gÃ©nÃ©rÃ©e":"Image Regenerated"]}),d.originalScore!==void 0&&e.jsxs("span",{className:"text-red-600",children:["Original: ",Math.round(d.originalScore),"%"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:a==="de"?"Das Bild wurde automatisch regeneriert, da die erste Version eine niedrige QualitÃ¤t hatte.":a==="fr"?"L'image a Ã©tÃ© automatiquement rÃ©gÃ©nÃ©rÃ©e car la premiÃ¨re version avait une qualitÃ© faible.":"Image was automatically regenerated because the first version had low quality."}),d.originalImage&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:a==="de"?"Originalbild:":a==="fr"?"Image originale:":"Original Image:"}),e.jsx("img",{src:d.originalImage,alt:"Original (lower quality)",className:"w-full rounded border-2 border-orange-200 opacity-75"}),d.originalReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600 bg-white p-2 rounded border",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Original Feedback:":a==="fr"?"Retour original:":"Original Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:d.originalReasoning})]})]})]})]})]})]}):e.jsx("div",{className:`flex flex-col items-center justify-center rounded-lg p-8 ${j?"bg-gradient-to-br from-indigo-100 to-purple-100":"bg-gray-100"}`,children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-indigo-300 border-t-indigo-600 mb-3"}),e.jsx("p",{className:"text-indigo-600 font-medium text-center",children:Re==="de"?"Bild wird noch erstellt...":Re==="fr"?"Image en cours de crÃ©ation...":"Image is being created..."})]}):e.jsx("p",{className:"text-gray-500 text-center",children:Re==="de"?"Kein Bild fÃ¼r diese Seite":Re==="fr"?"Pas d'image pour cette page":"No image for this page"})}),e.jsx("div",{className:"flex flex-col w-full h-full",children:Yt?e.jsx("textarea",{value:t.trim(),onChange:pe=>St(h,pe.target.value),className:"w-full flex-1 min-h-[300px] p-4 text-gray-800 leading-snug font-serif text-xl bg-white border-2 border-amber-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 outline-none resize-y",placeholder:a==="de"?"Text eingeben...":a==="fr"?"Entrez le texte...":"Enter text..."}):e.jsx("div",{className:"prose max-w-none",children:e.jsx("p",{className:"text-gray-800 leading-snug whitespace-pre-wrap font-serif text-xl",children:t.trim()})})})]})]},m)})]}),N&&Wt(N.backCover)&&(()=>{var h,m;const t=Jr(N.backCover);return e.jsxs("div",{className:"mt-8 max-w-2xl mx-auto",children:[e.jsx("p",{className:"text-sm text-gray-500 text-center mb-2",children:Re==="de"?"RÃ¼ckseite":Re==="fr"?"QuatriÃ¨me de couverture":"Back Cover"}),e.jsxs("div",{className:"relative",children:[e.jsx(La,{src:Wt(N.backCover),alt:"Back Cover",className:"w-full rounded-lg shadow-lg",label:"Back Cover"}),k.has("backCover")&&e.jsx("div",{className:"absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg",children:e.jsx(Ze,{className:"w-10 h-10 animate-spin text-indigo-600"})})]}),z&&e.jsx("div",{className:"mt-3",children:e.jsxs("button",{onClick:()=>Ur("back"),disabled:j||!ct||k.has("backCover"),className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j||!ct||k.has("backCover")?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,title:ct?"":a==="de"?"Nicht genug Credits":a==="fr"?"Pas assez de crÃ©dits":"Not enough credits",children:[e.jsx(Qt,{size:14}),a==="de"?"Bild neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer l'image":"Regenerate Image",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Zt," ",a==="de"?"Credits":"credits",")"]})]})}),H&&t&&e.jsxs("div",{className:"mt-3 space-y-2",children:[P&&e.jsxs("button",{onClick:()=>P("back"),disabled:j,className:`w-full bg-indigo-500 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-semibold ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:14})," ",a==="de"?"Bearbeiten":"Edit"]}),t.description&&e.jsxs("details",{className:"bg-green-50 border border-green-300 rounded-lg p-3",children:[e.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-green-800 hover:text-green-900",children:a==="de"?"Szenenbeschreibung":a==="fr"?"Description de scÃ¨ne":"Scene Description"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto",children:(()=>{const A=t.description;if(typeof A=="string")try{return JSON.stringify(JSON.parse(A),null,2)}catch{return A}if(typeof A=="object"){const d=A;if(d!=null&&d.text)try{return JSON.stringify(JSON.parse(d.text),null,2)}catch{return d.text}return JSON.stringify(A,null,2)}return String(A)})()})]}),t.prompt&&e.jsxs("details",{className:"bg-blue-50 border border-blue-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-blue-800 hover:text-blue-900",children:[a==="de"?"API-Prompt":a==="fr"?"Prompt API":"API Prompt",t.modelId&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-blue-600",children:["(",t.modelId,")"]})]}),e.jsx("pre",{className:"mt-2 text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-gray-200 overflow-x-auto max-h-[500px] overflow-y-auto",children:t.prompt})]}),((((h=t.referencePhotos)==null?void 0:h.length)??0)>0||(((m=t.landmarkPhotos)==null?void 0:m.length)??0)>0||t.visualBibleGrid)&&e.jsx(Ys,{referencePhotos:t.referencePhotos||[],landmarkPhotos:t.landmarkPhotos,visualBibleGrid:t.visualBibleGrid,language:a}),t.qualityScore!==void 0&&e.jsxs("details",{className:"bg-indigo-50 border border-indigo-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-900 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[a==="de"?"QualitÃ¤tsbewertung":a==="fr"?"Score de qualitÃ©":"Quality Score",t.qualityModelId&&e.jsxs("span",{className:"text-xs font-normal text-indigo-500",children:["(",t.qualityModelId,")"]})]}),e.jsxs("span",{className:`text-lg font-bold ${t.qualityScore>=70?"text-green-600":t.qualityScore>=50?"text-yellow-600":"text-red-600"}`,children:[Math.round(t.qualityScore),"%"]})]}),t.qualityReasoning&&e.jsxs("div",{className:"mt-2 text-xs text-gray-800 bg-white p-3 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:a==="de"?"Feedback:":a==="fr"?"Retour:":"Feedback:"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.qualityReasoning})]})]}),e.jsx(Zs,{retryHistory:t.retryHistory,bboxDetection:t.bboxDetection,bboxOverlayImage:t.bboxOverlayImage,language:a,storyId:b,pageNumber:-2}),t.retryHistory&&t.retryHistory.length>0&&e.jsx(js,{retryHistory:t.retryHistory,totalAttempts:t.totalAttempts||t.retryHistory.length,language:a}),t.previousImage&&e.jsxs("details",{className:"bg-orange-50 border border-orange-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-orange-800 hover:text-orange-900",children:[a==="de"?"Vorherige Version":a==="fr"?"Version prÃ©cÃ©dente":"Previous Version",t.previousScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-orange-600",children:["(",Math.round(t.previousScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.previousImage,alt:"Previous version",className:"w-full rounded border-2 border-orange-200 opacity-75"})})]}),t.originalImage&&t.originalImage!==t.previousImage&&e.jsxs("details",{className:"bg-amber-50 border border-amber-300 rounded-lg p-3",children:[e.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-amber-800 hover:text-amber-900",children:[a==="de"?"Originalbild":a==="fr"?"Image originale":"Original Image",t.originalScore!==void 0&&e.jsxs("span",{className:"ml-2 text-xs font-normal text-amber-600",children:["(",Math.round(t.originalScore),"%)"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:t.originalImage,alt:"Original version",className:"w-full rounded border-2 border-amber-200 opacity-75"})})]})]})]})})(),Ct&&o&&e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-4 mt-6",children:[e.jsx("h3",{className:"text-base font-bold text-gray-800 mb-3 text-center",children:a==="de"?"Was mÃ¶chten Sie als NÃ¤chstes tun?":a==="fr"?"Que souhaitez-vous faire ensuite ?":"What would you like to do next?"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-2",children:[b&&O&&e.jsxs("button",{onClick:O,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Bn,{size:16})," ",a==="de"?"Buch erstellen":a==="fr"?"CrÃ©er le livre":"Create Book"]}),x&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>os(!Ot),disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 w-full ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(vs,{size:16}),a==="de"?"PDF herunterladen":a==="fr"?"TÃ©lÃ©charger PDF":"Download PDF",e.jsx(Mt,{size:14,className:`transition-transform ${Ot?"rotate-180":""}`})]}),Ot&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:xr==="square",onChange:()=>is("square"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Square (20Ã—20cm)"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsx("input",{type:"radio",name:"pdfFormat2",checked:xr==="A4",onChange:()=>is("A4"),className:"text-indigo-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:"A4 (21Ã—28cm)"})]})]}),e.jsx("button",{onClick:()=>{x(xr),os(!1)},className:"w-full py-2 bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600",children:a==="de"?"Herunterladen":a==="fr"?"TÃ©lÃ©charger":"Download"})]})]}),vt&&!Yt&&e.jsxs("button",{onClick:()=>Gr(!0),disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(gt,{size:16})," ",a==="de"?"Text bearbeiten":a==="fr"?"Modifier le texte":"Edit Text"]}),ne&&e.jsxs("button",{onClick:ne,disabled:j,className:`bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-1.5 ${j?"opacity-50 cursor-not-allowed":"hover:bg-indigo-600"}`,children:[e.jsx(Fn,{size:16})," ",a==="de"?"Neue Geschichte":a==="fr"?"Nouvelle histoire":"New Story"]})]})]}),Yt&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-lg p-3 md:p-4 z-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-2 md:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-600",children:[e.jsx(gt,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"font-semibold text-sm md:text-base",children:a==="de"?"Bearbeitungsmodus":a==="fr"?"Mode Ã©dition":"Edit Mode"}),It&&e.jsxs("span",{className:"text-xs text-gray-500 hidden sm:inline",children:["(",a==="de"?"Original gespeichert":a==="fr"?"Original sauvegardÃ©":"Original saved",")"]})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto justify-center md:justify-end",children:[e.jsxs("button",{onClick:ma,disabled:at,className:"px-3 md:px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(zt,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"})]}),It&&mr!==It&&e.jsxs("button",{onClick:()=>as(It),disabled:at,className:"px-3 md:px-4 py-2 border border-amber-400 text-amber-700 rounded-lg hover:bg-amber-50 text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(qa,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:a==="de"?"ZurÃ¼cksetzen":a==="fr"?"Restaurer":"Restore"})]}),e.jsxs("button",{onClick:Rr,disabled:at,className:`px-3 md:px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold flex items-center gap-1.5 ${at?"opacity-50 cursor-not-allowed":"hover:bg-green-600"}`,children:[e.jsx(ys,{size:16}),at?a==="de"?"Speichern...":a==="fr"?"Sauvegarde...":"Saving...":a==="de"?"Speichern":a==="fr"?"Sauvegarder":"Save"]})]})]})}),Ye&&e.jsx(ko,{pageNumber:Ye.pageNumber,scene:Ye.scene,onSceneChange:t=>ur({...Ye,scene:t}),onClose:()=>ur(null),onRegenerate:br,isRegenerating:ht.has(Ye.pageNumber),imageRegenerationCost:Zt,characters:F.map(t=>({id:t.id,name:t.name})),selectedCharacterIds:Ye.selectedCharacterIds,onCharacterSelectionChange:t=>ur({...Ye,selectedCharacterIds:t}),consistencyRegen:H?(fa=V.find(t=>t.pageNumber===Ye.pageNumber))==null?void 0:fa.consistencyRegen:void 0}),ye&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Qt,{size:20}),a==="de"?"Cover bearbeiten":a==="fr"?"Modifier la couverture":"Edit Cover"," - ",ye.coverType==="front"?a==="de"?"Titelseite":a==="fr"?"Couverture":"Front Cover":ye.coverType==="initial"?a==="de"?"Einleitungsseite":a==="fr"?"Page de dÃ©dicace":"Dedication Page":a==="de"?"RÃ¼ckseite":a==="fr"?"Dos":"Back Cover"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a==="de"?"Bearbeite die Szenenbeschreibung und wÃ¤hle die Charaktere aus":a==="fr"?"Modifiez la description de la scÃ¨ne et sÃ©lectionnez les personnages":"Edit the scene description and select the characters"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[F.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(ws,{size:16}),a==="de"?"Charaktere auf dem Cover:":a==="fr"?"Personnages sur la couverture:":"Characters on the cover:"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:F.map(t=>{const h=ye.selectedCharacterIds.includes(t.id);return e.jsxs("button",{type:"button",onClick:()=>{const m=h?ye.selectedCharacterIds.filter(A=>A!==t.id):[...ye.selectedCharacterIds,t.id];gr({...ye,selectedCharacterIds:m})},className:`flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${h?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-gray-200 bg-white text-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{className:"font-medium",children:t.name}),h&&e.jsx("span",{className:"text-indigo-500",children:"âœ“"})]},t.id)})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"WÃ¤hle die Charaktere aus, die auf dem Cover erscheinen sollen.":a==="fr"?"SÃ©lectionnez les personnages qui doivent apparaÃ®tre sur la couverture.":"Select the characters that should appear on the cover."})]}),ye.coverType==="front"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Titel:":a==="fr"?"Titre:":"Title:"}),e.jsx("input",{type:"text",value:ye.title||"",onChange:t=>gr({...ye,title:t.target.value}),placeholder:a==="de"?"Der Titel des Buches":a==="fr"?"Le titre du livre":"The book title",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),ye.coverType==="initial"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Widmung:":a==="fr"?"DÃ©dicace:":"Dedication:"}),e.jsx("input",{type:"text",value:ye.dedication||"",onChange:t=>gr({...ye,dedication:t.target.value}),placeholder:a==="de"?'z.B. "FÃ¼r meine liebste Tochter Emma"':a==="fr"?'par ex. "Pour ma chÃ¨re fille Emma"':'e.g. "For my dear daughter Emma"',className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:a==="de"?"Leer lassen fÃ¼r keine Widmung":a==="fr"?"Laisser vide pour aucune dÃ©dicace":"Leave empty for no dedication"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a==="de"?"Szenenbeschreibung:":a==="fr"?"Description de la scÃ¨ne:":"Scene description:"}),e.jsx("textarea",{value:ye.scene,onChange:t=>gr({...ye,scene:t.target.value}),placeholder:a==="de"?'z.B. "Die Hauptfigur steht vor einem magischen Schloss bei Sonnenuntergang"':a==="fr"?'par ex. "Le personnage principal devant un chÃ¢teau magique au coucher du soleil"':'e.g. "The main character standing in front of a magical castle at sunset"',className:"w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a==="de"?"Tipp: Beschreibe die Aktionen und die Umgebung. Die ausgewÃ¤hlten Charaktere werden automatisch hinzugefÃ¼gt.":a==="fr"?"Conseil: DÃ©crivez les actions et l'environnement. Les personnages sÃ©lectionnÃ©s seront ajoutÃ©s automatiquement.":"Tip: Describe the actions and the environment. Selected characters will be added automatically."})]})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:ye.selectedCharacterIds.length>0&&e.jsx("span",{children:a==="de"?`${ye.selectedCharacterIds.length} Charakter(e) ausgewÃ¤hlt`:a==="fr"?`${ye.selectedCharacterIds.length} personnage(s) sÃ©lectionnÃ©(s)`:`${ye.selectedCharacterIds.length} character(s) selected`})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[e.jsx("button",{onClick:()=>gr(null),className:"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium order-2 sm:order-1",children:a==="de"?"Abbrechen":a==="fr"?"Annuler":"Cancel"}),e.jsxs("button",{onClick:yr,disabled:k.has(ye.coverType==="front"?"frontCover":ye.coverType==="initial"?"initialPage":"backCover")||ye.selectedCharacterIds.length===0,className:`px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 order-1 sm:order-2 ${k.has(ye.coverType==="front"?"frontCover":ye.coverType==="initial"?"initialPage":"backCover")||ye.selectedCharacterIds.length===0?"opacity-50 cursor-not-allowed":"hover:bg-indigo-700"}`,children:[e.jsx(Qt,{size:16}),a==="de"?"Neu generieren":a==="fr"?"RÃ©gÃ©nÃ©rer":"Regenerate",e.jsxs("span",{className:"text-xs opacity-80",children:["(",Zt," ",a==="de"?"Credits":"credits",")"]})]})]})]})]})}),qe&&e.jsx(Po,{pageNumber:qe.pageNumber,versions:qe.versions,onClose:()=>$r(null),onSelectVersion:Dt,developerMode:H}),hr&&e.jsx(Ao,{src:hr.src,title:hr.title,onClose:()=>Xe(null)}),pt&&e.jsx($o,{beforeImage:pt.beforeImage,afterImage:pt.afterImage,diffImage:pt.diffImage,title:pt.title,onClose:()=>Ps(null)})]})}const _a={"claude-sonnet":{provider:"anthropic",description:"Claude Sonnet 4.5 - Best narrative quality",descriptionDe:"Claude Sonnet 4.5 - Beste ErzÃ¤hlqualitÃ¤t",descriptionFr:"Claude Sonnet 4.5 - Meilleure qualitÃ© narrative"},"claude-haiku":{provider:"anthropic",description:"Claude Haiku 3.5 - Fast and cheap",descriptionDe:"Claude Haiku 3.5 - Schnell und gÃ¼nstig",descriptionFr:"Claude Haiku 3.5 - Rapide et Ã©conomique"},"gemini-2.5-pro":{provider:"google",description:"Gemini 2.5 Pro - High quality, large output",descriptionDe:"Gemini 2.5 Pro - Hohe QualitÃ¤t, grosse Ausgabe",descriptionFr:"Gemini 2.5 Pro - Haute qualitÃ©, grande sortie"},"gemini-2.5-flash":{provider:"google",description:"Gemini 2.5 Flash - Fast with large output",descriptionDe:"Gemini 2.5 Flash - Schnell mit grosser Ausgabe",descriptionFr:"Gemini 2.5 Flash - Rapide avec grande sortie"},"gemini-2.0-flash":{provider:"google",description:"Gemini 2.0 Flash - Very fast",descriptionDe:"Gemini 2.0 Flash - Sehr schnell",descriptionFr:"Gemini 2.0 Flash - TrÃ¨s rapide"}},Hn={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast scene generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Szenengenerierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide de scÃ¨nes"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"flux-schnell":{description:"FLUX Schnell (Runware) - Ultra cheap ($0.0006/image)",descriptionDe:"FLUX Schnell (Runware) - Ultra gÃ¼nstig ($0.0006/Bild)",descriptionFr:"FLUX Schnell (Runware) - Ultra Ã©conomique ($0.0006/image)"},"flux-dev":{description:"FLUX Dev (Runware) - Better quality ($0.004/image)",descriptionDe:"FLUX Dev (Runware) - Bessere QualitÃ¤t ($0.004/Bild)",descriptionFr:"FLUX Dev (Runware) - Meilleure qualitÃ© ($0.004/image)"}},Fo={"gemini-2.0-flash":{description:"Gemini 2.0 Flash - Fast evaluation",descriptionDe:"Gemini 2.0 Flash - Schnelle Bewertung",descriptionFr:"Gemini 2.0 Flash - Ã‰valuation rapide"},"gemini-2.5-flash":{description:"Gemini 2.5 Flash - More thorough",descriptionDe:"Gemini 2.5 Flash - GrÃ¼ndlicher",descriptionFr:"Gemini 2.5 Flash - Plus approfondi"}},Eo={gemini:{description:"Google Gemini - Best quality (~$0.035/image)",descriptionDe:"Google Gemini - Beste QualitÃ¤t (~$0.035/Bild)",descriptionFr:"Google Gemini - Meilleure qualitÃ© (~$0.035/image)"},runware:{description:"FLUX Schnell - Ultra cheap for testing ($0.0006/image)",descriptionDe:"FLUX Schnell - Ultra gÃ¼nstig zum Testen ($0.0006/Bild)",descriptionFr:"FLUX Schnell - Ultra Ã©conomique pour tests ($0.0006/image)"}},Bo={"gemini-2.5-flash-image":{description:"Gemini 2.5 Flash Image - Fast avatar generation",descriptionDe:"Gemini 2.5 Flash Image - Schnelle Avatar-Generierung",descriptionFr:"Gemini 2.5 Flash Image - GÃ©nÃ©ration rapide d'avatars"},"gemini-3-pro-image-preview":{description:"Gemini 3 Pro Image - Higher quality (preview)",descriptionDe:"Gemini 3 Pro Image - HÃ¶here QualitÃ¤t (Vorschau)",descriptionFr:"Gemini 3 Pro Image - QualitÃ© supÃ©rieure (aperÃ§u)"},"ace-plus-plus":{description:"ACE++ (Runware) - Cheap face-consistent avatars (~$0.005)",descriptionDe:"ACE++ (Runware) - GÃ¼nstige gesichtskonsistente Avatare (~$0.005)",descriptionFr:"ACE++ (Runware) - Avatars Ã©conomiques avec visage cohÃ©rent (~$0.005)"}};function Cr({label:r,icon:l,value:o,options:c,onChange:s,language:E}){const g=S=>E==="de"&&S.descriptionDe?S.descriptionDe:E==="fr"&&S.descriptionFr?S.descriptionFr:S.description;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("label",{className:"text-xs font-semibold text-gray-600 flex items-center gap-1",children:[l,r]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:o||"",onChange:S=>s(S.target.value||null),className:"w-full appearance-none bg-white border border-gray-300 rounded-lg px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:E==="de"?"Server-Standard":E==="fr"?"Par dÃ©faut serveur":"Server Default"}),Object.entries(c).map(([S,R])=>e.jsxs("option",{value:S,children:[S," ",R.provider?`(${R.provider})`:""]},S))]}),e.jsx(Mt,{size:14,className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"})]}),o&&c[o]&&e.jsx("p",{className:"text-[10px] text-gray-500 italic",children:g(c[o])})]})}function zo({selections:r,onChange:l}){const{language:o}=lr(),c=(s,E)=>{l({...r,[s]:E})};return e.jsxs("div",{className:"bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-yellow-800 mb-3 flex items-center gap-2",children:[e.jsx(to,{size:16}),o==="de"?"AI-Modell Auswahl (Dev)":o==="fr"?"SÃ©lection de modÃ¨le IA (Dev)":"AI Model Selection (Dev)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(Cr,{label:o==="de"?"Ideen-Modell":o==="fr"?"ModÃ¨le d'idÃ©es":"Idea Model",icon:e.jsx(so,{size:12}),value:r.ideaModel,options:_a,onChange:s=>c("ideaModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Geschichte (Kombiniert)":o==="fr"?"Histoire (CombinÃ©)":"Story (Combined)",icon:e.jsx(Ns,{size:12}),value:r.outlineModel,options:_a,onChange:s=>c("outlineModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Text-Modell":o==="fr"?"ModÃ¨le de texte":"Text Model",icon:e.jsx(Ns,{size:12}),value:r.textModel,options:_a,onChange:s=>c("textModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Szenen-Modell":o==="fr"?"ModÃ¨le de scÃ¨ne":"Scene Description Model",icon:e.jsx(ti,{size:12}),value:r.sceneDescriptionModel,options:_a,onChange:s=>c("sceneDescriptionModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Bild-Modell":o==="fr"?"ModÃ¨le d'image":"Image Model",icon:e.jsx(En,{size:12}),value:r.imageModel,options:Hn,onChange:s=>c("imageModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Cover-Modell":o==="fr"?"ModÃ¨le de couverture":"Cover Image Model",icon:e.jsx(uo,{size:12}),value:r.coverImageModel,options:Hn,onChange:s=>c("coverImageModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Bewertungs-Modell":o==="fr"?"ModÃ¨le d'Ã©valuation":"Quality Eval Model",icon:e.jsx(Gi,{size:12}),value:r.qualityModel,options:Fo,onChange:s=>c("qualityModel",s),language:o}),e.jsx(Cr,{label:o==="de"?"Bild-Reparatur":o==="fr"?"RÃ©paration d'image":"Image Repair",icon:e.jsx(co,{size:12}),value:r.imageBackend,options:Eo,onChange:s=>c("imageBackend",s),language:o}),e.jsx(Cr,{label:o==="de"?"Avatar-Modell":o==="fr"?"ModÃ¨le d'avatar":"Avatar Model",icon:e.jsx(En,{size:12}),value:r.avatarModel,options:Bo,onChange:s=>c("avatarModel",s),language:o})]}),e.jsx("p",{className:"text-[10px] text-yellow-700 mt-3 italic",children:o==="de"?'Hinweis: Nur sichtbar fÃ¼r Admin-Benutzer im Entwicklermodus. "Server-Standard" verwendet die Umgebungsvariablen-Konfiguration.':o==="fr"?`Note: Visible uniquement pour les utilisateurs admin en mode dÃ©veloppeur. "Par dÃ©faut serveur" utilise la configuration des variables d'environnement.`:'Note: Only visible to admin users in developer mode. "Server Default" uses the environment variable configuration.'})]})}function Vn(){return{currentStep:"idle",stepStatus:{idle:"completed","collect-feedback":"pending","identify-redo-pages":"pending","redo-pages":"pending","re-evaluate":"pending","consistency-check":"pending","character-repair":"pending","artifact-repair":"pending"},collectedFeedback:{pages:{},totalIssues:0},redoPages:{pageNumbers:[],reasons:{}},redoResults:{pagesCompleted:[],newVersions:{}},reEvaluationResults:{pages:{}},consistencyResults:{},characterRepairResults:{charactersProcessed:[],pagesRepaired:{}},artifactRepairResults:{pagesProcessed:[],issuesFixed:0},sessionId:`repair-${Date.now()}`}}const Ha=["idle","collect-feedback","identify-redo-pages","redo-pages","re-evaluate","consistency-check","character-repair","artifact-repair"];function Mo({storyId:r,sceneImages:l,characters:o,finalChecksReport:c,imageModel:s,onImageUpdate:E}){const[g,S]=i.useState(Vn),[R,V]=i.useState({current:0,total:0,currentPage:void 0}),M=i.useMemo(()=>Object.values(g.stepStatus).some(b=>b==="in-progress"),[g.stepStatus]),N=i.useMemo(()=>Ha.indexOf(g.currentStep),[g.currentStep]),k=i.useCallback(b=>{S(H=>({...H,currentStep:b,stepStatus:{...H.stepStatus,[b]:"in-progress"}}))},[]),f=i.useCallback((b,H)=>{S(ie=>({...ie,stepStatus:{...ie.stepStatus,[b]:"completed"},...b==="collect-feedback"&&H?{collectedFeedback:H}:{},...b==="re-evaluate"&&H?{reEvaluationResults:H}:{},...b==="consistency-check"&&H?{consistencyResults:H}:{}}))},[]),q=i.useCallback((b,H)=>{S(ie=>({...ie,stepStatus:{...ie.stepStatus,[b]:"failed"}}))},[]),j=i.useCallback(b=>{S(H=>({...H,stepStatus:{...H.stepStatus,[b]:"skipped"}}))},[]),x=i.useCallback(()=>{S(Vn()),V({current:0,total:0,currentPage:void 0})},[]),O=i.useCallback(async()=>{var b,H,ie,je;if(r){k("collect-feedback");try{const le={};let G=0;for(const I of l){const me={pageNumber:I.pageNumber,qualityScore:I.qualityScore,fixableIssues:[],entityIssues:[],manualNotes:"",needsFullRedo:!1},te=(b=I.retryHistory)==null?void 0:b.slice(-1)[0];if((H=te==null?void 0:te.postRepairEval)!=null&&H.fixableIssues?me.fixableIssues=te.postRepairEval.fixableIssues:(ie=te==null?void 0:te.preRepairEval)!=null&&ie.fixableIssues&&(me.fixableIssues=te.preRepairEval.fixableIssues),c!=null&&c.entity)for(const[ge,Z]of Object.entries(c.entity.characters||{})){const Te=((je=Z.issues)==null?void 0:je.filter(Me=>{var Je;return((Je=Me.pagesToFix)==null?void 0:Je.includes(I.pageNumber))||Me.pageNumber===I.pageNumber}))||[];for(const Me of Te)me.entityIssues.push({character:ge,issue:Me.description,severity:Me.severity})}G+=me.fixableIssues.length+me.entityIssues.length,le[I.pageNumber]=me}f("collect-feedback",{pages:le,totalIssues:G})}catch(le){console.error("Failed to collect feedback:",le),q("collect-feedback",le instanceof Error?le.message:"Unknown error")}}},[r,l,c,k,f,q]),xe=i.useCallback((b,H)=>{S(ie=>({...ie,collectedFeedback:{...ie.collectedFeedback,pages:{...ie.collectedFeedback.pages,[b]:{...ie.collectedFeedback.pages[b],...H}}}}))},[]),ne=i.useCallback((b,H)=>{S(ie=>{const je=ie.redoPages.pageNumbers.includes(b),le=je?ie.redoPages.pageNumbers.filter(I=>I!==b):[...ie.redoPages.pageNumbers,b].sort((I,me)=>I-me),G={...ie.redoPages.reasons};return je?delete G[b]:H&&(G[b]=H),{...ie,redoPages:{pageNumbers:le,reasons:G}}})},[]),T=i.useCallback((b=6,H=3)=>{k("identify-redo-pages");const ie=[],je={};for(const[le,G]of Object.entries(g.collectedFeedback.pages)){const I=parseInt(le),me=G.fixableIssues.length+G.entityIssues.length,te=G.qualityScore??10;te<b?(ie.push(I),je[I]=`Low quality score: ${te}`):me>=H?(ie.push(I),je[I]=`Too many issues: ${me}`):G.needsFullRedo&&(ie.push(I),je[I]="Manually marked for redo")}S(le=>({...le,redoPages:{pageNumbers:ie.sort((G,I)=>G-I),reasons:je},stepStatus:{...le.stepStatus,"identify-redo-pages":"completed"}}))},[g.collectedFeedback.pages,k]),L=i.useCallback(async()=>{var je;if(!r||g.redoPages.pageNumbers.length===0)return;k("redo-pages");const b=g.redoPages.pageNumbers;V({current:0,total:b.length,currentPage:void 0});const H=[],ie={};try{for(let le=0;le<b.length;le++){const G=b[le];V({current:le,total:b.length,currentPage:G});try{const I=await Ee.iteratePage(r,G,s);if(I.success){H.push(G);const me=l.find(ge=>ge.pageNumber===G),te=((je=me==null?void 0:me.imageVersions)==null?void 0:je.length)??0;ie[G]=te,E&&E(G,I.imageData,te)}}catch(I){console.error(`Failed to redo page ${G}:`,I)}}S(le=>({...le,redoResults:{pagesCompleted:H,newVersions:ie},stepStatus:{...le.stepStatus,"redo-pages":"completed"}})),V({current:b.length,total:b.length,currentPage:void 0})}catch(le){console.error("Redo pages failed:",le),q("redo-pages",le instanceof Error?le.message:"Unknown error")}},[r,g.redoPages.pageNumbers,s,l,E,k,q]),z=i.useCallback(async b=>{if(!r)return;k("re-evaluate");const H=b??g.redoResults.pagesCompleted;if(H.length===0){j("re-evaluate");return}try{const ie=await Ee.reEvaluatePages(r,H),je={};for(const[le,G]of Object.entries(ie.pages||{}))je[parseInt(le)]={qualityScore:G.qualityScore,fixableIssues:G.fixableIssues};f("re-evaluate",{pages:je})}catch(ie){console.error("Re-evaluation failed:",ie),q("re-evaluate",ie instanceof Error?ie.message:"Unknown error")}},[r,g.redoResults.pagesCompleted,k,f,q,j]),F=i.useCallback(async()=>{if(r){k("consistency-check");try{const b=await Ee.runEntityConsistency(r);f("consistency-check",{report:b.report})}catch(b){console.error("Consistency check failed:",b),q("consistency-check",b instanceof Error?b.message:"Unknown error")}}},[r,k,f,q]),W=i.useCallback(async(b,H)=>{var ie,je;if(!(!r||H.length===0)){k("character-repair");try{const G=((je=(ie=(await Ee.repairCharacters(r,[{character:b,pages:H}])).results)==null?void 0:ie[0])==null?void 0:je.pagesRepaired)||H;S(I=>({...I,characterRepairResults:{charactersProcessed:[...I.characterRepairResults.charactersProcessed,b],pagesRepaired:{...I.characterRepairResults.pagesRepaired,[b]:G}},stepStatus:{...I.stepStatus,"character-repair":"completed"}}))}catch(le){console.error("Character repair failed:",le),q("character-repair",le instanceof Error?le.message:"Unknown error")}}},[r,k,q]),P=i.useCallback(async b=>{if(!(!r||b.length===0)){k("artifact-repair");try{const H=await Ee.repairArtifacts(r,b);S(ie=>({...ie,artifactRepairResults:{pagesProcessed:H.pagesProcessed||b,issuesFixed:H.issuesFixed||0},stepStatus:{...ie.stepStatus,"artifact-repair":"completed"}}))}catch(H){console.error("Artifact repair failed:",H),q("artifact-repair",H instanceof Error?H.message:"Unknown error")}}},[r,k,q]),ee=i.useCallback(b=>{const H=Ha.indexOf(b);if(b==="idle")return!0;if(M)return!1;switch(b){case"collect-feedback":return!0;case"identify-redo-pages":return g.stepStatus["collect-feedback"]==="completed";case"redo-pages":return g.redoPages.pageNumbers.length>0;case"re-evaluate":return g.stepStatus["redo-pages"]==="completed"||g.stepStatus["redo-pages"]==="skipped";case"consistency-check":return H>Ha.indexOf("collect-feedback");case"character-repair":return g.stepStatus["consistency-check"]==="completed";case"artifact-repair":return g.stepStatus["collect-feedback"]==="completed";default:return!1}},[g,M]),Q=i.useCallback(b=>{const H=Ha.indexOf(b);return H>0?H:0},[]),Ne=i.useCallback(()=>Object.entries(g.collectedFeedback.pages).filter(([b,H])=>{const ie=H.qualityScore??10,je=H.fixableIssues.length+H.entityIssues.length;return ie<7||je>0||H.needsFullRedo}).map(([b])=>parseInt(b)).sort((b,H)=>b-H),[g.collectedFeedback.pages]),Se=i.useCallback(()=>{const b=g.consistencyResults.report;return b!=null&&b.characters?Object.entries(b.characters).filter(([H,ie])=>{var je;return"overallConsistent"in ie?!ie.overallConsistent||(ie.totalIssues??0)>0:!ie.consistent||(((je=ie.issues)==null?void 0:je.length)??0)>0}).map(([H])=>H):[]},[g.consistencyResults.report]);return{workflowState:g,isRunning:M,currentStepIndex:N,startStep:k,completeStep:f,failStep:q,skipStep:j,resetWorkflow:x,collectFeedback:O,updatePageFeedback:xe,toggleRedoPage:ne,autoIdentifyRedoPages:T,redoMarkedPages:L,redoProgress:R,reEvaluatePages:z,runConsistencyCheck:F,repairCharacter:W,repairArtifacts:P,canProceedToStep:ee,getStepNumber:Q,getPagesNeedingAttention:Ne,getCharactersWithIssues:Se}}const Mr={idle:{label:"Ready",icon:ri,description:""},"collect-feedback":{label:"1. Collect Feedback",icon:ei,description:"Gather all issues from evaluation data"},"identify-redo-pages":{label:"2. Identify Redo Pages",icon:pn,description:"Mark pages needing complete regeneration"},"redo-pages":{label:"3. Redo Pages",icon:Qt,description:"Regenerate marked pages via iteration"},"re-evaluate":{label:"4. Re-evaluate",icon:ea,description:"Run quality evaluation on new images"},"consistency-check":{label:"5. Consistency Check",icon:ws,description:"Run entity consistency on all pages"},"character-repair":{label:"6. Character Repair",icon:ws,description:"Fix character appearance issues"},"artifact-repair":{label:"7. Artifact Repair",icon:si,description:"Fix remaining artifacts via grid repair"}};function Oo({status:r}){const l={pending:{color:"bg-gray-100 text-gray-600",icon:ri},"in-progress":{color:"bg-blue-100 text-blue-600",icon:Ze},completed:{color:"bg-green-100 text-green-600",icon:ea},skipped:{color:"bg-yellow-100 text-yellow-600",icon:mo},failed:{color:"bg-red-100 text-red-600",icon:fn}},{color:o,icon:c}=l[r],s=r==="in-progress";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${o}`,children:[e.jsx(c,{className:`w-3 h-3 ${s?"animate-spin":""}`}),r]})}function Lo({feedback:r,isMarkedForRedo:l,onToggleRedo:o,onUpdateNotes:c}){const[s,E]=i.useState(!1),g=r.fixableIssues.length+r.entityIssues.length,S=g>0||r.qualityScore!==void 0&&r.qualityScore<7;return e.jsxs("div",{className:`border rounded-lg p-3 ${l?"border-red-300 bg-red-50":S?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>E(!s),className:"p-1 hover:bg-gray-100 rounded",children:s?e.jsx(Mt,{className:"w-4 h-4"}):e.jsx(Ss,{className:"w-4 h-4"})}),e.jsxs("span",{className:"font-medium",children:["Page ",r.pageNumber]}),r.qualityScore!==void 0&&e.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded ${r.qualityScore>=8?"bg-green-100 text-green-700":r.qualityScore>=6?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Score: ",r.qualityScore]}),g>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[g," issues"]})]}),e.jsx("button",{onClick:o,className:`px-3 py-1 text-xs rounded font-medium transition-colors ${l?"bg-red-600 text-white hover:bg-red-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:l?"Marked for Redo":"Mark for Redo"})]}),s&&e.jsxs("div",{className:"mt-3 space-y-2 pl-7",children:[r.fixableIssues.length>0&&e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Quality Issues:"}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:r.fixableIssues.map((R,V)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:`px-1 rounded ${R.severity==="critical"?"bg-red-100 text-red-700":R.severity==="major"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:R.severity}),e.jsx("span",{children:R.description})]},V))})]}),r.entityIssues.length>0&&e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Entity Issues:"}),e.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:r.entityIssues.map((R,V)=>e.jsxs("li",{className:"flex items-start gap-1",children:[e.jsx("span",{className:"px-1 rounded bg-purple-100 text-purple-700",children:R.character}),e.jsx("span",{children:R.issue})]},V))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-1",children:"Manual Notes:"}),e.jsx("textarea",{value:r.manualNotes,onChange:R=>c(R.target.value),placeholder:"Add notes about issues not captured automatically...",className:"w-full text-xs p-2 border rounded resize-none",rows:2})]})]})]})}function Go({storyId:r,sceneImages:l,characters:o,finalChecksReport:c,imageModel:s,onImageUpdate:E,onRefreshStory:g}){const[S,R]=i.useState(!0),[V,M]=i.useState(new Set(["collect-feedback"])),{workflowState:N,isRunning:k,resetWorkflow:f,collectFeedback:q,updatePageFeedback:j,toggleRedoPage:x,autoIdentifyRedoPages:O,redoMarkedPages:xe,redoProgress:ne,reEvaluatePages:T,runConsistencyCheck:L,repairCharacter:z,repairArtifacts:F,getStepNumber:W,getCharactersWithIssues:P}=Mo({storyId:r,sceneImages:l,characters:o,finalChecksReport:c,imageModel:s,onImageUpdate:E}),[ee,Q]=i.useState(""),[Ne,Se]=i.useState([]),[b,H]=i.useState([]),ie=I=>{M(me=>{const te=new Set(me);return te.has(I)?te.delete(I):te.add(I),te})},je=i.useMemo(()=>P(),[P]),le=i.useMemo(()=>Object.entries(N.collectedFeedback.pages).filter(([I,me])=>me.fixableIssues.some(te=>te.type==="artifact"||te.type==="distortion")).map(([I])=>parseInt(I)),[N.collectedFeedback.pages]),G=I=>{const me=Mr[I],te=me.icon,ge=N.stepStatus[I],Z=V.has(I),Te=W(I);return e.jsxs("button",{onClick:()=>ie(I),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${ge==="in-progress"?"bg-blue-50":ge==="completed"?"bg-green-50":ge==="failed"?"bg-red-50":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-amber-100 text-amber-700 text-sm font-bold",children:Te}),e.jsx(te,{className:`w-4 h-4 ${ge==="in-progress"?"animate-spin text-blue-600":"text-gray-600"}`}),e.jsx("span",{className:"font-medium text-sm",children:me.label})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oo,{status:ge}),Z?e.jsx(Mt,{className:"w-4 h-4"}):e.jsx(Ss,{className:"w-4 h-4"})]})]})};return r?e.jsxs("div",{className:"mb-6 border-2 border-amber-300 rounded-lg bg-amber-50/50 overflow-hidden",children:[e.jsxs("button",{onClick:()=>R(!S),className:"w-full flex items-center justify-between p-4 bg-amber-100 hover:bg-amber-200 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Lr,{className:"w-5 h-5 text-amber-700"}),e.jsx("span",{className:"font-bold text-amber-800",children:"Manual Repair Workflow"}),N.collectedFeedback.totalIssues>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs rounded-full",children:[N.collectedFeedback.totalIssues," issues"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(Ze,{className:"w-3 h-3 animate-spin"}),"Running..."]}),e.jsx("button",{onClick:I=>{I.stopPropagation(),f()},className:"p-1 hover:bg-amber-300 rounded",title:"Reset workflow",children:e.jsx(qa,{className:"w-4 h-4 text-amber-700"})}),S?e.jsx(Mt,{className:"w-4 h-4"}):e.jsx(Ss,{className:"w-4 h-4"})]})]}),S&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("collect-feedback"),V.has("collect-feedback")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["collect-feedback"].description}),e.jsxs("button",{onClick:q,disabled:k,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ei,{className:"w-4 h-4"}),"Collect Feedback"]}),Object.keys(N.collectedFeedback.pages).length>0&&e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Object.values(N.collectedFeedback.pages).sort((I,me)=>I.pageNumber-me.pageNumber).map(I=>e.jsx(Lo,{feedback:I,isMarkedForRedo:N.redoPages.pageNumbers.includes(I.pageNumber),onToggleRedo:()=>x(I.pageNumber),onUpdateNotes:me=>j(I.pageNumber,{manualNotes:me})},I.pageNumber))})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("identify-redo-pages"),V.has("identify-redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["identify-redo-pages"].description}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>O(6,3),disabled:k||N.stepStatus["collect-feedback"]!=="completed",className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ho,{className:"w-4 h-4"}),"Auto-Identify (score < 6 or 3+ issues)"]})}),N.redoPages.pageNumbers.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-red-800 mb-2",children:["Pages marked for redo: ",N.redoPages.pageNumbers.length]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:N.redoPages.pageNumbers.map(I=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded",title:N.redoPages.reasons[I],children:["Page ",I,e.jsx("button",{onClick:()=>x(I),className:"hover:text-red-900",children:e.jsx(fn,{className:"w-3 h-3"})})]},I))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("redo-pages"),V.has("redo-pages")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["redo-pages"].description}),e.jsxs("button",{onClick:xe,disabled:k||N.redoPages.pageNumbers.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(lo,{className:"w-4 h-4"}),"Redo ",N.redoPages.pageNumbers.length," Pages"]}),ne.total>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",ne.current," / ",ne.total]}),ne.currentPage&&e.jsxs("span",{className:"text-gray-500",children:["Currently: Page ",ne.currentPage]})]}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 transition-all",style:{width:`${ne.current/ne.total*100}%`}})})]}),N.redoResults.pagesCompleted.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-800 mb-2",children:["Completed: ",N.redoResults.pagesCompleted.length," pages"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:N.redoResults.pagesCompleted.map(I=>e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:["Page ",I," (v",N.redoResults.newVersions[I]??"?",")"]},I))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("re-evaluate"),V.has("re-evaluate")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["re-evaluate"].description}),e.jsxs("button",{onClick:()=>T(),disabled:k||N.redoResults.pagesCompleted.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ea,{className:"w-4 h-4"}),"Re-evaluate ",N.redoResults.pagesCompleted.length," Pages"]}),Object.keys(N.reEvaluationResults.pages).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium",children:"Evaluation Results:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(N.reEvaluationResults.pages).map(([I,me])=>e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-sm",children:[e.jsxs("span",{className:"font-medium",children:["Page ",I,":"]})," ",e.jsxs("span",{className:me.qualityScore>=7?"text-green-600":"text-amber-600",children:[me.qualityScore,"/10"]}),me.fixableIssues&&me.fixableIssues.length>0&&e.jsxs("span",{className:"text-gray-500 text-xs ml-1",children:["(",me.fixableIssues.length," issues)"]})]},I))})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("consistency-check"),V.has("consistency-check")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["consistency-check"].description}),e.jsxs("button",{onClick:async()=>{await L(),g&&await g()},disabled:k,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(ws,{className:"w-4 h-4"}),"Run Consistency Check"]}),N.consistencyResults.report&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:`p-3 rounded-lg border ${N.consistencyResults.report.overallConsistent?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"}`,children:[e.jsx("h5",{className:"text-sm font-medium mb-1",children:N.consistencyResults.report.overallConsistent?"All characters consistent!":`${N.consistencyResults.report.totalIssues} consistency issues found`}),e.jsx("p",{className:"text-xs text-gray-600",children:N.consistencyResults.report.summary})]}),je.length>0&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Characters needing repair:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:je.map(I=>e.jsx("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:I},I))})]})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("character-repair"),V.has("character-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["character-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Character:"}),e.jsxs("select",{value:ee,onChange:I=>{Q(I.target.value),Se([])},className:"w-full p-2 border rounded text-sm",disabled:k,children:[e.jsx("option",{value:"",children:"Choose a character..."}),je.map(I=>e.jsxs("option",{value:I,children:[I," (has issues)"]},I)),o.filter(I=>!je.includes(I.name)).map(I=>e.jsx("option",{value:I.name,children:I.name},I.name))]})]}),ee&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages to Repair:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:l.map(I=>e.jsxs("button",{onClick:()=>{Se(me=>me.includes(I.pageNumber)?me.filter(te=>te!==I.pageNumber):[...me,I.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${Ne.includes(I.pageNumber)?"bg-purple-100 border-purple-300 text-purple-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:k,children:["Page ",I.pageNumber]},I.pageNumber))})]}),e.jsxs("button",{onClick:async()=>{await z(ee,Ne),g&&await g()},disabled:k||!ee||Ne.length===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:[e.jsx(Lr,{className:"w-4 h-4"}),"Repair ",ee||"Character"," on ",Ne.length," pages"]}),Object.keys(N.characterRepairResults.pagesRepaired).length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h5",{className:"text-sm font-medium text-green-800 mb-2",children:"Repair Results:"}),Object.entries(N.characterRepairResults.pagesRepaired).map(([I,me])=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[I,":"]})," ",e.jsxs("span",{className:"text-gray-600",children:["Pages ",me.join(", ")]})]},I))]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[G("artifact-repair"),V.has("artifact-repair")&&e.jsxs("div",{className:"p-4 space-y-3 bg-white",children:[e.jsx("p",{className:"text-sm text-gray-600",children:Mr["artifact-repair"].description}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Pages for Grid Repair:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:le.length>0?le.map(I=>e.jsxs("button",{onClick:()=>{H(me=>me.includes(I)?me.filter(te=>te!==I):[...me,I])},className:`px-2 py-1 text-xs rounded border transition-colors ${b.includes(I)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:k,children:["Page ",I]},I)):e.jsx("span",{className:"text-sm text-gray-500",children:"No pages with artifact issues detected"})}),le.length===0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Or select manually:"}),l.map(I=>e.jsxs("button",{onClick:()=>{H(me=>me.includes(I.pageNumber)?me.filter(te=>te!==I.pageNumber):[...me,I.pageNumber])},className:`px-2 py-1 text-xs rounded border transition-colors ${b.includes(I.pageNumber)?"bg-amber-100 border-amber-300 text-amber-700":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:k,children:["Page ",I.pageNumber]},I.pageNumber))]})]}),e.jsxs("button",{onClick:async()=>{await F(b),g&&await g()},disabled:k||b.length===0,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",children:[e.jsx(si,{className:"w-4 h-4"}),"Run Grid Repair on ",b.length," pages"]}),N.artifactRepairResults.pagesProcessed.length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("h5",{className:"text-sm font-medium text-green-800",children:["Processed ",N.artifactRepairResults.pagesProcessed.length," pages, fixed ",N.artifactRepairResults.issuesFixed," issues"]})})]})]})]})]}):null}const Wn=[{code:"de-ch",name:"Deutsch",family:"de"},{code:"fr-ch",name:"FranÃ§ais",family:"fr"},{code:"it-ch",name:"Italiano",family:"it"},{code:"en-gb",name:"English",family:"en"},{code:"gsw-zh",name:"Mundart",family:"gsw"}],Va={de:[{code:"de-ch",name:"Schweiz"},{code:"de-de",name:"Hochdeutsch"},{code:"de-de-north",name:"Norddeutsch"},{code:"de-de-south",name:"SÃ¼ddeutsch"},{code:"de-at",name:"Ã–sterreich"},{code:"de-it",name:"SÃ¼dtirol"}],fr:[{code:"fr-ch",name:"Suisse"},{code:"fr-fr",name:"France"},{code:"fr-be",name:"Belgique"},{code:"fr-ca",name:"QuÃ©bec"},{code:"fr-af",name:"Afrique"}],it:[{code:"it-ch",name:"Svizzera"},{code:"it-it",name:"Standard"},{code:"it-it-north",name:"Nord"},{code:"it-it-central",name:"Toscana"},{code:"it-it-south",name:"Sud"},{code:"it-sm",name:"San Marino"}],en:[{code:"en-gb",name:"British"},{code:"en-us",name:"American"},{code:"en-ca",name:"Canadian"},{code:"en-au",name:"Australian"},{code:"en-ie",name:"Irish"},{code:"en-za",name:"South African"}],gsw:[{code:"gsw-zh",name:"ZÃ¼ritÃ¼Ã¼tsch"},{code:"gsw-be",name:"BÃ¤rndÃ¼tsch"},{code:"gsw-bs",name:"Baseldytsch"},{code:"gsw-lu",name:"LuzÃ¤rndÃ¼tsch"},{code:"gsw-sg",name:"SanggallerdÃ¼tsch"},{code:"gsw-vs",name:"WalliserdÃ¼tsch"},{code:"gsw-gr",name:"BÃ¼ndnerdÃ¼tsch"}]};function mn(r){return r.startsWith("gsw")?"gsw":r.startsWith("de")?"de":r.startsWith("fr")?"fr":r.startsWith("it")?"it":"en"}const _o=["spring","summer","autumn","winter"];function ni(){const r=new Date().getMonth();return r>=2&&r<=4?"spring":r>=5&&r<=7?"summer":r>=8&&r<=10?"autumn":"winter"}function Ho({languageLevel:r,onLanguageLevelChange:l,pages:o,onPagesChange:c,storyLanguage:s,onStoryLanguageChange:E,developerMode:g,userLocation:S,onLocationChange:R,season:V,onSeasonChange:M,userCredits:N}){const{t:k,language:f}=lr(),[q,j]=i.useState(!1),[x,O]=i.useState((S==null?void 0:S.city)||""),[xe,ne]=i.useState((S==null?void 0:S.country)||""),[T,L]=i.useState(!1),z=i.useRef(null);i.useEffect(()=>{const Z=Te=>{z.current&&!z.current.contains(Te.target)&&L(!1)};return document.addEventListener("mousedown",Z),()=>document.removeEventListener("mousedown",Z)},[]);const F=i.useCallback(()=>{const Z=mn(s),Te=Wn.find(Je=>Je.family===Z),Me=Va[Z].find(Je=>Je.code===s)||Va[Z][0];return Te&&Me?`${Te.name} (${Me.name})`:(Te==null?void 0:Te.name)||s},[s]);i.useEffect(()=>{S&&(O(S.city||""),ne(S.country||""))},[S]);const W=()=>{R({city:x||null,region:null,country:xe||null}),j(!1)},P={spring:{de:"FrÃ¼hling",fr:"Printemps",en:"Spring"},summer:{de:"Sommer",fr:"Ã‰tÃ©",en:"Summer"},autumn:{de:"Herbst",fr:"Automne",en:"Autumn"},winter:{de:"Winter",fr:"Hiver",en:"Winter"}},ee=g?4:10,Q=50,Ne=2,Se=10,b=N===-1,H=b?Q:Math.floor(N/Se),ie=Math.floor(H/2)*2,je=ee*Se,le=!b&&N<je,G=je-N,I=le?ee:Math.min(Q,Math.max(ee,ie)),me=!b&&ie<Q;i.useEffect(()=>{let Z=o;Z%2!==0&&(Z=Math.round(Z/2)*2),Z=Math.max(ee,Math.min(I,Z)),Z!==o&&c(Z)},[o,ee,I,c]);const te=[{value:"1st-grade",label:k.firstGrade,desc:k.firstGradeDesc,image:"/images/text and image on each page.jpg"},{value:"standard",label:k.standard,desc:k.standardDesc,image:"/images/left page text, right page image.jpg"},{value:"advanced",label:k.advanced,desc:k.advancedDesc,image:"/images/dense text left.jpg"}],ge=(Z,Te=!1)=>{const Me=Te?" (Test)":"",Je=Z*10,It=f==="de"?"Credits":f==="fr"?"crÃ©dits":"credits";if(r==="1st-grade")return`${Z} ${f==="de"?"Seiten":"pages"} = ${Je} ${It}${Me}`;const vt=Math.floor(Z/2),dr=Math.floor(Z/2);return f==="de"?`${Z} Seiten (${vt} Text + ${dr} Bilder) = ${Je} ${It}${Me}`:f==="fr"?`${Z} pages (${vt} texte + ${dr} images) = ${Je} ${It}${Me}`:`${Z} pages (${vt} text + ${dr} images) = ${Je} ${It}${Me}`};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("h2",{className:"text-3xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Ua,{size:24}),f==="de"?"Buchformat":f==="fr"?"Format du livre":"Book Format"]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:f==="de"?"Sprache:":f==="fr"?"Langue:":"Language:"}),e.jsxs("div",{className:"relative",ref:z,children:[e.jsxs("button",{type:"button",onClick:()=>L(!T),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium bg-white cursor-pointer pr-8 flex items-center gap-1 min-w-[160px]",children:[F(),e.jsx(Mt,{size:16,className:`absolute right-2 text-gray-400 transition-transform ${T?"rotate-180":""}`})]}),T&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-[180px] py-1",children:[Wn.map(Z=>{const Te=mn(s)===Z.family;return e.jsx("button",{type:"button",onClick:()=>{const Me=Va[Z.family][0];E(Me.code)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${Te?"font-semibold text-indigo-600":"text-gray-700"}`,children:Z.name},Z.family)}),e.jsx("div",{className:"border-t border-gray-300 my-1"}),Va[mn(s)].map(Z=>e.jsx("button",{type:"button",onClick:()=>{E(Z.code),L(!1)},className:`w-full text-left px-3 py-1.5 text-sm hover:bg-indigo-50 ${s===Z.code?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-700"}`,children:Z.name},Z.code))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(io,{className:"text-gray-500",size:16}),e.jsx("span",{className:"text-sm text-gray-600",children:f==="de"?"Ort:":f==="fr"?"Lieu:":"Location:"}),q?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"text",value:x,onChange:Z=>O(Z.target.value),placeholder:f==="de"?"Stadt":f==="fr"?"Ville":"City",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("input",{type:"text",value:xe,onChange:Z=>ne(Z.target.value),placeholder:f==="de"?"Land":f==="fr"?"Pays":"Country",className:"px-2 py-1 border border-gray-300 rounded text-base w-24 focus:outline-none focus:border-indigo-500"}),e.jsx("button",{onClick:W,className:"px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700",children:"OK"}),e.jsx("button",{onClick:()=>j(!1),className:"px-1 text-gray-500 text-xs hover:text-gray-700",children:"âœ•"})]}):e.jsx("button",{onClick:()=>j(!0),className:"text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline",children:S!=null&&S.city?`${S.city}${S.country?`, ${S.country}`:""}`:f==="de"?"Festlegen":f==="fr"?"DÃ©finir":"Set"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:f==="de"?"Jahreszeit:":f==="fr"?"Saison:":"Season:"}),e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:V,onChange:Z=>M(Z.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none text-sm font-medium appearance-none bg-white cursor-pointer pr-8",children:_o.map(Z=>e.jsx("option",{value:Z,children:P[Z][f]||P[Z].en},Z))}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:k.readingLevel}),e.jsx("div",{className:"flex overflow-x-auto gap-3 pb-2 md:grid md:grid-cols-3 md:gap-4 md:overflow-visible md:pb-0 -mx-4 px-4 md:mx-0 md:px-0",children:te.map(Z=>e.jsxs("button",{onClick:()=>l(Z.value),className:`flex-shrink-0 w-56 md:w-auto text-left rounded-lg border-2 transition-all overflow-hidden ${r===Z.value?"border-indigo-600 ring-2 ring-indigo-200":"border-gray-200 hover:border-indigo-300"}`,children:[e.jsx("div",{className:"w-full bg-gray-100 p-2 h-48 md:h-56",children:e.jsx("img",{src:Z.image,alt:Z.label,className:"w-full h-full object-contain"})}),e.jsxs("div",{className:"p-2 md:p-2.5",children:[e.jsx("div",{className:"font-semibold text-sm mb-0.5",children:Z.label}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-pre-line",children:Z.desc})]})]},Z.value))})]}),r&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-3",children:k.numberOfPages}),le?e.jsxs("div",{className:"bg-red-50 border-2 border-red-200 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-red-700 font-semibold mb-2",children:f==="de"?"Nicht genÃ¼gend Credits":f==="fr"?"CrÃ©dits insuffisants":"Not enough credits"}),e.jsx("p",{className:"text-red-600 text-sm",children:f==="de"?`Du benÃ¶tigst mindestens ${je} Credits fÃ¼r eine Geschichte mit ${ee} Seiten. Dir fehlen noch ${G} Credits.`:f==="fr"?`Vous avez besoin d'au moins ${je} crÃ©dits pour une histoire de ${ee} pages. Il vous manque ${G} crÃ©dits.`:`You need at least ${je} credits for a ${ee}-page story. You need ${G} more credits.`}),e.jsx("p",{className:"text-gray-500 text-xs mt-2",children:f==="de"?`Aktuell: ${N} Credits`:f==="fr"?`Actuel: ${N} crÃ©dits`:`Current: ${N} credits`})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"range",min:ee,max:I,step:Ne,value:Math.min(o,I),onChange:Z=>c(parseInt(Z.target.value)),className:`w-full h-3 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 touch-none
                           [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:h-6
                           [&::-webkit-slider-thumb]:bg-indigo-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                           [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:hover:bg-indigo-700
                           [&::-moz-range-thumb]:w-6 [&::-moz-range-thumb]:h-6 [&::-moz-range-thumb]:bg-indigo-600
                           [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0`}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-400",children:ee}),e.jsxs("span",{className:"text-xl font-bold text-indigo-600",children:[o," ",f==="de"?"Seiten":"pages"]}),e.jsxs("span",{className:`text-sm ${me?"text-orange-500 font-medium":"text-gray-400"}`,children:[I,me&&" âš ï¸"]})]}),me&&e.jsx("div",{className:"text-center text-sm text-orange-600 bg-orange-50 rounded-lg py-2 px-3",children:f==="de"?`Max. ${I} Seiten mit ${N} Credits mÃ¶glich`:f==="fr"?`Max. ${I} pages possibles avec ${N} crÃ©dits`:`Max. ${I} pages possible with ${N} credits`}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-base font-medium text-gray-700",children:ge(o,o===4)}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:r==="1st-grade"?f==="de"?"Jede Seite enthÃ¤lt ein Bild mit Text darunter":f==="fr"?"Chaque page contient une image avec du texte en dessous":"Each page contains an image with text below":f==="de"?"Abwechselnd Textseite und Bildseite":f==="fr"?"Alternance de pages de texte et d'images":"Alternating text page and image page"})]})]})]})]})}const Vo=Object.freeze(Object.defineProperty({__proto__:null,WizardStep3BookSettings:Ho,getCurrentSeason:ni},Symbol.toStringTag,{value:"Module"})),qn={en:{title:"Check Your Email",description:"We've sent you a verification link. Your story will start generating automatically once you verify your email!",currentEmail:"Verification sent to",sendVerification:"Send Verification Email",resendVerification:"Resend Verification Email",emailSent:"Verification email sent! Please check your inbox.",changeEmail:"Wrong email? Change it",newEmail:"New email address",currentPassword:"Current password",confirmChange:"Change & Verify",cancel:"Cancel",emailChanged:"Email changed! Please check your new inbox for verification.",checkSpam:"Don't see it? Check your spam folder.",fillAllFields:"Please fill in all fields"},de:{title:"E-Mail prÃ¼fen",description:"Wir haben Ihnen einen BestÃ¤tigungslink gesendet. Ihre Geschichte wird automatisch erstellt, sobald Sie Ihre E-Mail bestÃ¤tigen!",currentEmail:"BestÃ¤tigung gesendet an",sendVerification:"BestÃ¤tigungs-E-Mail senden",resendVerification:"BestÃ¤tigungs-E-Mail erneut senden",emailSent:"BestÃ¤tigungs-E-Mail gesendet! Bitte prÃ¼fen Sie Ihren Posteingang.",changeEmail:"Falsche E-Mail? Ã„ndern",newEmail:"Neue E-Mail-Adresse",currentPassword:"Aktuelles Passwort",confirmChange:"Ã„ndern & BestÃ¤tigen",cancel:"Abbrechen",emailChanged:"E-Mail geÃ¤ndert! Bitte prÃ¼fen Sie Ihren neuen Posteingang fÃ¼r die BestÃ¤tigung.",checkSpam:"Nicht gefunden? PrÃ¼fen Sie Ihren Spam-Ordner.",fillAllFields:"Bitte alle Felder ausfÃ¼llen"},fr:{title:"Verifiez votre e-mail",description:"Nous vous avons envoye un lien de verification. Votre histoire sera generee automatiquement une fois votre e-mail verifie!",currentEmail:"Verification envoyee a",sendVerification:"Envoyer l'e-mail de verification",resendVerification:"Renvoyer l'e-mail de verification",emailSent:"E-mail de verification envoye! Veuillez verifier votre boite de reception.",changeEmail:"Mauvais e-mail? Changer",newEmail:"Nouvelle adresse e-mail",currentPassword:"Mot de passe actuel",confirmChange:"Changer & Verifier",cancel:"Annuler",emailChanged:"E-mail change! Veuillez verifier votre nouvelle boite de reception pour la verification.",checkSpam:"Pas trouve? Verifiez votre dossier spam.",fillAllFields:"Veuillez remplir tous les champs"}};function Wo({isOpen:r,onClose:l,onVerified:o}){const{language:c}=lr(),{user:s,refreshUser:E}=xn(),g=qn[c]||qn.en,[S,R]=i.useState("verify"),[V,M]=i.useState(!1),[N,k]=i.useState(!1),[f,q]=i.useState(""),[j,x]=i.useState(""),[O,xe]=i.useState(!1),[ne,T]=i.useState(0),[L,z]=i.useState(""),[F,W]=i.useState(""),P=i.useRef(null),ee=i.useRef(null),Q=i.useRef(!1);if(i.useEffect(()=>(ne>0&&(ee.current=setTimeout(()=>{T(b=>b-1)},1e3)),()=>{ee.current&&clearTimeout(ee.current)}),[ne]),i.useEffect(()=>{if(r&&!Q.current&&!N){Q.current=!0;const b=setTimeout(async()=>{M(!0);try{const H=await Ke.post("/api/auth/send-verification",{});k(!0),x(g.emailSent),H.cooldown&&T(H.cooldown)}catch(H){const ie=H;ie.retryAfter?(T(ie.retryAfter),k(!0)):q(ie.message||"Failed to send verification email")}finally{M(!1)}},300);return()=>clearTimeout(b)}r||(Q.current=!1)},[r,N,g.emailSent]),i.useEffect(()=>{if(!r){P.current&&(clearInterval(P.current),P.current=null);return}return xe(!0),console.log("[EmailVerificationModal] Starting polling"),P.current=setInterval(async()=>{try{const b=await Ke.get("/api/auth/verification-status");console.log("[EmailVerificationModal] Poll result:",b.emailVerified),b.emailVerified&&(console.log("[EmailVerificationModal] Email verified! Refreshing user..."),await E(),console.log("[EmailVerificationModal] User refreshed, clearing interval"),P.current&&(clearInterval(P.current),P.current=null),xe(!1),console.log("[EmailVerificationModal] Calling onVerified callback"),o==null||o(),console.log("[EmailVerificationModal] Calling onClose"),l())}catch(b){console.debug("Verification status poll error:",b)}},3e3),()=>{P.current&&(clearInterval(P.current),P.current=null)}},[r,E,o,l]),!r)return null;const Ne=async()=>{M(!0),q("");try{const b=await Ke.post("/api/auth/send-verification",{});k(!0),x(g.emailSent),b.cooldown&&T(b.cooldown)}catch(b){const H=b;H.retryAfter?(T(H.retryAfter),q(c==="de"?`Bitte warten Sie ${H.retryAfter} Sekunden`:c==="fr"?`Veuillez patienter ${H.retryAfter} secondes`:`Please wait ${H.retryAfter} seconds`)):q(H.message||"Failed to send verification email")}finally{M(!1)}},Se=async()=>{if(!L||!F){q(g.fillAllFields);return}M(!0),q("");try{await Ke.post("/api/auth/change-email",{newEmail:L,password:F}),x(g.emailChanged),R("verify"),z(""),W("")}catch(b){q(b instanceof Error?b.message:"Failed to change email")}finally{M(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-8 animate-fade-in relative",children:[e.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Close",children:e.jsx(zt,{size:20})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Xn,{className:"w-8 h-8 text-indigo-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:g.title}),e.jsx("p",{className:"text-gray-500",children:g.description})]}),f&&e.jsx(Rn,{variant:"error",className:"mb-4",children:f}),j&&e.jsxs(Rn,{variant:"success",className:"mb-4",children:[j,e.jsx("p",{className:"text-sm mt-1 opacity-80",children:g.checkSpam})]}),O&&N&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-indigo-600 mb-4",children:[e.jsx(Ze,{size:16,className:"animate-spin"}),e.jsx("span",{className:"text-sm",children:c==="de"?"Warte auf BestÃ¤tigung...":c==="fr"?"En attente de verification...":"Waiting for verification..."})]}),S==="verify"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:g.currentEmail}),e.jsx("p",{className:"font-medium text-gray-800",children:s==null?void 0:s.email})]}),e.jsxs(Wa,{onClick:Ne,variant:"primary",loading:V,disabled:ne>0,className:"w-full",children:[e.jsx(Qt,{size:16,className:"mr-2"}),ne>0?`${c==="de"?"Warten":c==="fr"?"Patienter":"Wait"} ${ne}s`:N?g.resendVerification:g.sendVerification]}),e.jsxs("button",{onClick:()=>{R("change"),q(""),x("")},className:"w-full text-center text-indigo-600 font-semibold hover:text-indigo-800 flex items-center justify-center gap-2",children:[e.jsx(gt,{size:16}),g.changeEmail]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(Tn,{type:"email",label:g.newEmail,value:L,onChange:b=>z(b.target.value),placeholder:"your@newemail.com",disabled:V}),e.jsx(Tn,{type:"password",label:g.currentPassword,value:F,onChange:b=>W(b.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:V}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Wa,{onClick:()=>{R("verify"),q(""),z(""),W("")},variant:"secondary",className:"flex-1",disabled:V,children:g.cancel}),e.jsx(Wa,{onClick:Se,variant:"primary",loading:V,className:"flex-1",children:g.confirmChange})]})]})]})})}const bn=[{value:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"},inverse:{en:"Best Friends with",de:"Beste Freunde mit",fr:"Meilleurs amis avec"}},{value:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"},inverse:{en:"Friends with",de:"Freunde mit",fr:"Amis avec"}},{value:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "},inverse:{en:"Married to",de:"Verheiratet mit",fr:"MariÃ©(e) Ã "}},{value:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"},inverse:{en:"In a relationship with",de:"In einer Beziehung mit",fr:"En relation avec"}},{value:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"},inverse:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"}},{value:{en:"Younger Sibling of",de:"JÃ¼ngeres Geschwister von",fr:"FrÃ¨re/SÅ“ur cadet(te) de"},inverse:{en:"Older Sibling of",de:"Ã„lteres Geschwister von",fr:"FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de"}},{value:{en:"Parent of",de:"Elternteil von",fr:"Parent de"},inverse:{en:"Child of",de:"Kind von",fr:"Enfant de"}},{value:{en:"Child of",de:"Kind von",fr:"Enfant de"},inverse:{en:"Parent of",de:"Elternteil von",fr:"Parent de"}},{value:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"},inverse:{en:"Rivals with",de:"Rivalen mit",fr:"Rivaux avec"}},{value:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"},inverse:{en:"Neighbors with",de:"Nachbarn mit",fr:"Voisins avec"}},{value:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"},inverse:{en:"Not Known to",de:"Nicht bekannt mit",fr:"Pas connu de"}}];function qo(r){const l=bn.find(o=>o.value.en==="Not Known to");return l?l.value[r]:"Not Known to"}function Un(r){const l=bn.find(o=>o.value.en==="Not Known to");return l?r===l.value.en||r===l.value.de||r===l.value.fr:!1}function Uo(r,l,o=[]){for(const c of bn)if(c.value[l]===r)return c.inverse[l];for(const c of o){if(c.forward===r)return c.inverse;if(c.inverse===r)return c.forward}return r}const Ko=1440*60*1e3;function Ka(r){const l=`avatar_regen_${r}`,o=localStorage.getItem(l),c=Date.now();if(!o)return{canRegenerate:!0,waitSeconds:0,attempts:0};try{const{attempts:s,lastAttempt:E}=JSON.parse(o);if(c-E>Ko)return localStorage.removeItem(l),{canRegenerate:!0,waitSeconds:0,attempts:0};let g=0;s>=2&&s<4?g=30*1e3:s>=4&&s<6?g=60*1e3:s>=6&&s<8?g=120*1e3:s>=8&&s<10?g=300*1e3:s>=10&&(g=600*1e3);const S=c-E;return S>=g?{canRegenerate:!0,waitSeconds:0,attempts:s}:{canRegenerate:!1,waitSeconds:Math.ceil((g-S)/1e3),attempts:s}}catch{return{canRegenerate:!0,waitSeconds:0,attempts:0}}}function ii(r){const l=`avatar_regen_${r}`,o=localStorage.getItem(l),c=Date.now();let s=1;if(o)try{s=(JSON.parse(o).attempts||0)+1}catch{}localStorage.setItem(l,JSON.stringify({attempts:s,lastAttempt:c}))}function Cl(r){const[l,o]=i.useState(()=>Ka(r));i.useEffect(()=>{if(l.waitSeconds>0){const s=setInterval(()=>{o(Ka(r))},1e3);return()=>clearInterval(s)}},[l.waitSeconds,r]);const c=i.useCallback(()=>{ii(r),o(Ka(r))},[r]);return{...l,recordRegeneration:c}}const Kn={en:{title:"Multiple Faces Detected",description:"We detected multiple people in your photo. Please select which face belongs to the character you want to create.",selectFace:"Select Face",uploadDifferent:"Upload Different Photo",confidence:"Confidence"},de:{title:"Mehrere Gesichter erkannt",description:"Wir haben mehrere Personen in Ihrem Foto erkannt. Bitte wÃ¤hlen Sie aus, welches Gesicht zu dem Charakter gehÃ¶rt, den Sie erstellen mÃ¶chten.",selectFace:"Gesicht auswÃ¤hlen",uploadDifferent:"Anderes Foto hochladen",confidence:"Konfidenz"},fr:{title:"Plusieurs visages dÃ©tectÃ©s",description:"Nous avons dÃ©tectÃ© plusieurs personnes sur votre photo. Veuillez sÃ©lectionner le visage du personnage que vous souhaitez crÃ©er.",selectFace:"SÃ©lectionner le visage",uploadDifferent:"TÃ©lÃ©charger une autre photo",confidence:"Confiance"}};function Jo({isOpen:r,faces:l,onSelect:o,onUploadNew:c,developerMode:s=!1}){const{language:E}=lr(),g=Kn[E]||Kn.en;return e.jsx(Qi,{isOpen:r,onClose:c,title:g.title,size:"lg",showCloseButton:!1,closeOnOverlayClick:!1,closeOnEscape:!1,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-600 text-center",children:g.description}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:l.map((S,R)=>e.jsxs("button",{onClick:()=>o(S.id),className:`group relative bg-white border-2 border-gray-200 rounded-xl p-3
                hover:border-indigo-400 hover:shadow-lg transition-all duration-200
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2`,children:[e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-3",children:e.jsx("img",{draggable:!1,src:S.thumbnail,alt:`Face ${R+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"})}),e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-sm font-semibold text-indigo-600 group-hover:text-indigo-700",children:[g.selectFace," ",R+1]})}),s&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded",children:[g.confidence,": ",Math.round(S.confidence*100),"%"]})]},S.id))}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("button",{onClick:c,className:`w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gray-100 text-gray-700 rounded-lg font-medium
              hover:bg-gray-200 transition-colors`,children:[e.jsx(go,{size:20}),g.uploadDifferent]})})]})})}const kl=[{id:"adventure",name:{en:"Adventure",de:"Abenteuer",fr:"Aventure"},description:{en:"Exciting journeys and heroic quests",de:"Spannende Reisen und heldenhafte Abenteuer",fr:"Voyages passionnants et quÃªtes hÃ©roÃ¯ques"},emoji:"ðŸ—¡ï¸"},{id:"life-challenge",name:{en:"Life Skills",de:"Lebenskompetenzen",fr:"CompÃ©tences de vie"},description:{en:"Help overcome everyday challenges",de:"Hilfe bei alltÃ¤glichen Herausforderungen",fr:"Aide pour surmonter les dÃ©fis quotidiens"},emoji:"ðŸ’ª"},{id:"educational",name:{en:"Learning",de:"Lernen",fr:"Apprentissage"},description:{en:"Fun stories that teach something new",de:"Lustige Geschichten, die etwas Neues lehren",fr:"Histoires amusantes qui enseignent quelque chose de nouveau"},emoji:"ðŸ“š"},{id:"historical",name:{en:"History",de:"Geschichte",fr:"Histoire"},description:{en:"Experience real historical events",de:"Erlebe echte historische Ereignisse",fr:"Vivez de vrais Ã©vÃ©nements historiques"},emoji:"ðŸ›ï¸"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},description:{en:"Describe your own unique story idea",de:"Beschreibe deine eigene Geschichte",fr:"DÃ©cris ta propre idÃ©e d'histoire"},emoji:"âœ¨"}],Qo=["pirate","knight","cowboy","ninja","wizard","dragon","superhero","detective","easter"],Pl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"historical",name:{en:"Historical Times",de:"Historische Zeiten",fr:"Ã‰poques historiques"}},{id:"fantasy",name:{en:"Fantasy & Magic",de:"Fantasie & Magie",fr:"Fantaisie & Magie"}},{id:"locations",name:{en:"Exploration",de:"Entdeckung",fr:"Exploration"}},{id:"professions",name:{en:"Heroes & Helpers",de:"Helden & Helfer",fr:"HÃ©ros & Aides"}},{id:"seasonal",name:{en:"Seasonal",de:"Jahreszeiten",fr:"Saisonnier"}},{id:"custom",name:{en:"Custom",de:"Eigenes Thema",fr:"PersonnalisÃ©"}}],gn=[{id:"pirate",name:{en:"Pirate Adventure",de:"Piraten-Abenteuer",fr:"Aventure de Pirates"},emoji:"ðŸ´â€â˜ ï¸",group:"historical"},{id:"knight",name:{en:"Knights & Princess",de:"Ritter & Prinzessin",fr:"Chevaliers & Princesse"},emoji:"âš”ï¸",group:"historical"},{id:"cowboy",name:{en:"Cowboys & Indians",de:"Cowboys und Indianer",fr:"Cowboys et Indiens"},emoji:"ðŸ¤ ",group:"historical"},{id:"ninja",name:{en:"Secret Ninja",de:"Geheimer Ninja",fr:"Ninja Secret"},emoji:"ðŸ¥·",group:"historical"},{id:"viking",name:{en:"Viking Adventure",de:"Wikinger-Abenteuer",fr:"Aventure Viking"},emoji:"âš“",group:"historical"},{id:"roman",name:{en:"Ancient Rome",de:"Antikes Rom",fr:"Rome Antique"},emoji:"ðŸ›ï¸",group:"historical"},{id:"egyptian",name:{en:"Ancient Egypt",de:"Altes Ã„gypten",fr:"Ã‰gypte Ancienne"},emoji:"ðŸº",group:"historical"},{id:"greek",name:{en:"Ancient Greece",de:"Antikes Griechenland",fr:"GrÃ¨ce Antique"},emoji:"ðŸº",group:"historical"},{id:"caveman",name:{en:"Stone Age",de:"Steinzeit",fr:"Ã‚ge de Pierre"},emoji:"ðŸ¦´",group:"historical"},{id:"samurai",name:{en:"Samurai Adventure",de:"Samurai-Abenteuer",fr:"Aventure SamouraÃ¯"},emoji:"ðŸŽŒ",group:"historical"},{id:"wizard",name:{en:"Wizard & Witch",de:"Zauberer & Hexe",fr:"Sorcier & SorciÃ¨re"},emoji:"ðŸ§™",group:"fantasy"},{id:"dragon",name:{en:"Dragon Quest",de:"Drachen-Abenteuer",fr:"QuÃªte du Dragon"},emoji:"ðŸ‰",group:"fantasy"},{id:"unicorn",name:{en:"Magical Unicorn",de:"Magisches Einhorn",fr:"Licorne Magique"},emoji:"ðŸ¦„",group:"fantasy"},{id:"mermaid",name:{en:"Mermaid Adventure",de:"Meerjungfrauen-Abenteuer",fr:"Aventure de SirÃ¨ne"},emoji:"ðŸ§œâ€â™€ï¸",group:"fantasy"},{id:"dinosaur",name:{en:"Dinosaur World",de:"Dinosaurier-Welt",fr:"Monde des Dinosaures"},emoji:"ðŸ¦–",group:"fantasy"},{id:"superhero",name:{en:"Superhero",de:"Superheld",fr:"Super-hÃ©ros"},emoji:"ðŸ¦¸",group:"fantasy"},{id:"space",name:{en:"Space Explorer",de:"Weltraum-Entdecker",fr:"Explorateur Spatial"},emoji:"ðŸš€",group:"locations"},{id:"ocean",name:{en:"Ocean Explorer",de:"Ozean-Entdecker",fr:"Explorateur des OcÃ©ans"},emoji:"ðŸŒŠ",group:"locations"},{id:"jungle",name:{en:"Jungle Safari",de:"Dschungel-Safari",fr:"Safari dans la Jungle"},emoji:"ðŸŒ´",group:"locations"},{id:"farm",name:{en:"Farm Life",de:"Bauernhof-Leben",fr:"Vie Ã  la Ferme"},emoji:"ðŸ„",group:"locations"},{id:"forest",name:{en:"Forest Friends",de:"Waldfreunde",fr:"Amis de la ForÃªt"},emoji:"ðŸ¦Š",group:"locations"},{id:"fireman",name:{en:"Brave Firefighter",de:"Tapferer Feuerwehrmann",fr:"Pompier Courageux"},emoji:"ðŸš’",group:"professions"},{id:"doctor",name:{en:"Helpful Doctor",de:"Hilfreicher Arzt",fr:"Docteur Serviable"},emoji:"ðŸ‘¨â€âš•ï¸",group:"professions"},{id:"police",name:{en:"Police Officer",de:"Polizist",fr:"Policier"},emoji:"ðŸ‘®",group:"professions"},{id:"detective",name:{en:"Detective Mystery",de:"Detektiv-Geheimnis",fr:"MystÃ¨re DÃ©tective"},emoji:"ðŸ”",group:"professions"},{id:"christmas",name:{en:"Christmas Story",de:"Weihnachts-Geschichte",fr:"Histoire de NoÃ«l"},emoji:"ðŸŽ„",group:"seasonal"},{id:"newyear",name:{en:"New Year Story",de:"Neujahrs-Geschichte",fr:"Histoire du Nouvel An"},emoji:"ðŸŽ†",group:"seasonal"},{id:"easter",name:{en:"Easter Story",de:"Oster-Geschichte",fr:"Histoire de PÃ¢ques"},emoji:"ðŸ°",group:"seasonal"},{id:"halloween",name:{en:"Halloween Story",de:"Halloween-Geschichte",fr:"Histoire d'Halloween"},emoji:"ðŸŽƒ",group:"seasonal"},{id:"custom",name:{en:"Create Your Own",de:"Eigenes Thema",fr:"CrÃ©er le vÃ´tre"},emoji:"âœ¨",group:"custom"}],Al={name:{en:"Everyday Life",de:"Alltag",fr:"Vie Quotidienne"},emoji:"ðŸ "},Jn=[{id:"potty-training",name:{en:"Potty Training",de:"TÃ¶pfchen-Training",fr:"Apprentissage du pot"},emoji:"ðŸš½",ageGroup:"toddler"},{id:"washing-hands",name:{en:"Washing Hands",de:"HÃ¤nde waschen",fr:"Se laver les mains"},emoji:"ðŸ§¼",ageGroup:"toddler"},{id:"brushing-teeth",name:{en:"Brushing Teeth",de:"ZÃ¤hne putzen",fr:"Se brosser les dents"},emoji:"ðŸª¥",ageGroup:"toddler"},{id:"eating-vegetables",name:{en:"Eating Vegetables",de:"GemÃ¼se essen",fr:"Manger des lÃ©gumes"},emoji:"ðŸ¥¦",ageGroup:"toddler"},{id:"going-to-bed",name:{en:"Going to Bed",de:"Ins Bett gehen",fr:"Aller au lit"},emoji:"ðŸ›ï¸",ageGroup:"toddler"},{id:"saying-goodbye",name:{en:"Saying Goodbye",de:"Abschied nehmen",fr:"Dire au revoir"},emoji:"ðŸ‘‹",ageGroup:"toddler"},{id:"no-pacifier",name:{en:"No More Pacifier",de:"Ohne Schnuller",fr:"Plus de tÃ©tine"},emoji:"ðŸ¼",ageGroup:"toddler"},{id:"cleaning-up",name:{en:"Cleaning Up Toys",de:"AufrÃ¤umen",fr:"Ranger les jouets"},emoji:"ðŸ§¹",ageGroup:"preschool"},{id:"sitting-still",name:{en:"Sitting Still",de:"Still sitzen",fr:"Rester tranquille"},emoji:"ðŸª‘",ageGroup:"preschool"},{id:"sharing",name:{en:"Learning to Share",de:"Teilen lernen",fr:"Apprendre Ã  partager"},emoji:"ðŸ¤",ageGroup:"preschool"},{id:"waiting-turn",name:{en:"Waiting Your Turn",de:"Warten kÃ¶nnen",fr:"Attendre son tour"},emoji:"â³",ageGroup:"preschool"},{id:"first-kindergarten",name:{en:"First Day of Kindergarten",de:"Erster Kindergartentag",fr:"Premier jour de maternelle"},emoji:"ðŸŽ’",ageGroup:"preschool"},{id:"making-friends",name:{en:"Making Friends",de:"Freunde finden",fr:"Se faire des amis"},emoji:"ðŸ‘«",ageGroup:"preschool"},{id:"being-brave",name:{en:"Being Brave",de:"Mutig sein",fr:"ÃŠtre courageux"},emoji:"ðŸ’ª",ageGroup:"preschool"},{id:"new-sibling",name:{en:"New Baby Sibling",de:"Neues Geschwisterchen",fr:"Nouveau bÃ©bÃ© dans la famille"},emoji:"ðŸ‘¶",ageGroup:"preschool"},{id:"first-school",name:{en:"First Day of School",de:"Erster Schultag",fr:"Premier jour d'Ã©cole"},emoji:"ðŸ«",ageGroup:"early-school"},{id:"homework",name:{en:"Doing Homework",de:"Hausaufgaben machen",fr:"Faire ses devoirs"},emoji:"ðŸ“",ageGroup:"early-school"},{id:"reading-alone",name:{en:"Learning to Read",de:"Lesen lernen",fr:"Apprendre Ã  lire"},emoji:"ðŸ“–",ageGroup:"early-school"},{id:"losing-game",name:{en:"Losing a Game",de:"Verlieren kÃ¶nnen",fr:"Savoir perdre"},emoji:"ðŸŽ¯",ageGroup:"early-school"},{id:"being-different",name:{en:"Being Different is OK",de:"Anders sein ist OK",fr:"ÃŠtre diffÃ©rent c'est bien"},emoji:"ðŸŒˆ",ageGroup:"early-school"},{id:"dealing-bully",name:{en:"Dealing with Bullies",de:"Mit HÃ¤nseleien umgehen",fr:"Faire face aux moqueries"},emoji:"ðŸ›¡ï¸",ageGroup:"early-school"},{id:"telling-truth",name:{en:"Telling the Truth",de:"Die Wahrheit sagen",fr:"Dire la vÃ©ritÃ©"},emoji:"âœ…",ageGroup:"early-school"},{id:"trying-new-things",name:{en:"Trying New Things",de:"Neues ausprobieren",fr:"Essayer de nouvelles choses"},emoji:"ðŸŒŸ",ageGroup:"early-school"},{id:"moving-house",name:{en:"Moving to a New Home",de:"Umzug",fr:"DÃ©mÃ©nagement"},emoji:"ðŸ ",ageGroup:"family"},{id:"going-vacation",name:{en:"Going on Vacation",de:"In den Urlaub fahren",fr:"Partir en vacances"},emoji:"âœˆï¸",ageGroup:"family"},{id:"parents-splitting",name:{en:"Parents Living Apart",de:"Eltern leben getrennt",fr:"Parents sÃ©parÃ©s"},emoji:"ðŸ’”",ageGroup:"family"},{id:"visiting-doctor",name:{en:"Going to the Doctor",de:"Arztbesuch",fr:"Visite chez le mÃ©decin"},emoji:"ðŸ¥",ageGroup:"family"},{id:"staying-hospital",name:{en:"Staying in Hospital",de:"Im Krankenhaus",fr:"SÃ©jour Ã  l'hÃ´pital"},emoji:"ðŸ©º",ageGroup:"family"},{id:"death-pet",name:{en:"Losing a Pet",de:"Haustier verlieren",fr:"Perte d'un animal"},emoji:"ðŸŒˆ",ageGroup:"family"},{id:"grandparent-sick",name:{en:"Grandparent is Sick",de:"Grosseltern sind krank",fr:"Grand-parent malade"},emoji:"â¤ï¸",ageGroup:"family"},{id:"money-saving",name:{en:"Saving Money",de:"Geld sparen",fr:"Ã‰conomiser de l'argent"},emoji:"ðŸ’°",ageGroup:"preteen"},{id:"spending-wisely",name:{en:"Spending Wisely",de:"Klug ausgeben",fr:"DÃ©penser intelligemment"},emoji:"ðŸ›’",ageGroup:"preteen"},{id:"screen-time",name:{en:"Screen Time Balance",de:"Bildschirmzeit-Balance",fr:"Ã‰quilibre du temps d'Ã©cran"},emoji:"ðŸ“±",ageGroup:"preteen"},{id:"peer-pressure",name:{en:"Peer Pressure",de:"Gruppenzwang",fr:"Pression des pairs"},emoji:"ðŸ‘¥",ageGroup:"preteen"},{id:"body-changes",name:{en:"Body Changes",de:"KÃ¶rperliche VerÃ¤nderungen",fr:"Changements corporels"},emoji:"ðŸŒ±",ageGroup:"preteen"},{id:"responsibility",name:{en:"Taking Responsibility",de:"Verantwortung Ã¼bernehmen",fr:"Prendre ses responsabilitÃ©s"},emoji:"ðŸŽ¯",ageGroup:"preteen"},{id:"managing-time",name:{en:"Managing Time",de:"Zeitmanagement",fr:"Gestion du temps"},emoji:"â°",ageGroup:"preteen"},{id:"online-safety",name:{en:"Online Safety",de:"Sicherheit im Internet",fr:"SÃ©curitÃ© en ligne"},emoji:"ðŸ”’",ageGroup:"preteen"}],Zo=["going-to-bed","cleaning-up","first-kindergarten","first-school","losing-game","dealing-bully","telling-truth","spending-wisely","moving-house","screen-time"],$l=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},ageRange:"all"},{id:"family",name:{en:"Family Changes",de:"Familien-VerÃ¤nderungen",fr:"Changements familiaux"},ageRange:"all"},{id:"toddler",name:{en:"Toddler (2-4)",de:"Kleinkind (2-4)",fr:"Tout-petit (2-4)"},ageRange:"2-4"},{id:"preschool",name:{en:"Preschool (4-6)",de:"Vorschule (4-6)",fr:"PrÃ©scolaire (4-6)"},ageRange:"4-6"},{id:"early-school",name:{en:"Early School (6-9)",de:"Grundschule (6-9)",fr:"Ã‰cole primaire (6-9)"},ageRange:"6-9"},{id:"preteen",name:{en:"Pre-Teen (9-12)",de:"VorpubertÃ¤t (9-12)",fr:"PrÃ©adolescent (9-12)"},ageRange:"9-12"}],Qn=[{id:"alphabet",name:{en:"The Alphabet (ABC)",de:"Das Alphabet (ABC)",fr:"L'Alphabet (ABC)"},emoji:"ðŸ”¤",group:"letters"},{id:"vowels",name:{en:"Vowels (A, E, I, O, U)",de:"Vokale (A, E, I, O, U)",fr:"Voyelles (A, E, I, O, U)"},emoji:"ðŸ…°ï¸",group:"letters"},{id:"rhyming",name:{en:"Rhyming Words",de:"ReimwÃ¶rter",fr:"Mots qui riment"},emoji:"ðŸŽµ",group:"letters"},{id:"numbers-1-10",name:{en:"Numbers 1-10",de:"Zahlen 1-10",fr:"Nombres 1-10"},emoji:"ðŸ”¢",group:"numbers"},{id:"numbers-1-20",name:{en:"Numbers 1-20",de:"Zahlen 1-20",fr:"Nombres 1-20"},emoji:"ðŸ”¢",group:"numbers"},{id:"counting",name:{en:"Learning to Count",de:"ZÃ¤hlen lernen",fr:"Apprendre Ã  compter"},emoji:"âœ‹",group:"numbers"},{id:"shapes",name:{en:"Shapes",de:"Formen",fr:"Formes"},emoji:"ðŸ”·",group:"numbers"},{id:"addition",name:{en:"Simple Addition",de:"Einfaches Addieren",fr:"Addition simple"},emoji:"âž•",group:"numbers"},{id:"colors-basic",name:{en:"Basic Colors",de:"Grundfarben",fr:"Couleurs de base"},emoji:"ðŸŒˆ",group:"colors"},{id:"colors-mixing",name:{en:"Mixing Colors",de:"Farben mischen",fr:"MÃ©langer les couleurs"},emoji:"ðŸŽ¨",group:"colors"},{id:"planets",name:{en:"Planets & Space",de:"Planeten & Weltraum",fr:"PlanÃ¨tes & Espace"},emoji:"ðŸª",group:"science"},{id:"seasons",name:{en:"The Four Seasons",de:"Die vier Jahreszeiten",fr:"Les quatre saisons"},emoji:"ðŸ‚",group:"science"},{id:"weather",name:{en:"Weather",de:"Wetter",fr:"MÃ©tÃ©o"},emoji:"â›…",group:"science"},{id:"water-cycle",name:{en:"Water Cycle",de:"Wasserkreislauf",fr:"Cycle de l'eau"},emoji:"ðŸ’§",group:"science"},{id:"plants-grow",name:{en:"How Plants Grow",de:"Wie Pflanzen wachsen",fr:"Comment poussent les plantes"},emoji:"ðŸŒ±",group:"science"},{id:"day-night",name:{en:"Day and Night",de:"Tag und Nacht",fr:"Jour et nuit"},emoji:"ðŸŒ™",group:"science"},{id:"farm-animals",name:{en:"Farm Animals",de:"Bauernhoftiere",fr:"Animaux de la ferme"},emoji:"ðŸ·",group:"animals"},{id:"wild-animals",name:{en:"Wild Animals",de:"Wilde Tiere",fr:"Animaux sauvages"},emoji:"ðŸ¦",group:"animals"},{id:"ocean-animals",name:{en:"Ocean Animals",de:"Meerestiere",fr:"Animaux marins"},emoji:"ðŸ‹",group:"animals"},{id:"insects",name:{en:"Insects & Bugs",de:"Insekten & KÃ¤fer",fr:"Insectes"},emoji:"ðŸ›",group:"animals"},{id:"dinosaurs",name:{en:"Dinosaurs",de:"Dinosaurier",fr:"Dinosaures"},emoji:"ðŸ¦•",group:"animals"},{id:"body-parts",name:{en:"Body Parts",de:"KÃ¶rperteile",fr:"Parties du corps"},emoji:"ðŸ«€",group:"body"},{id:"five-senses",name:{en:"The Five Senses",de:"Die fÃ¼nf Sinne",fr:"Les cinq sens"},emoji:"ðŸ‘ï¸",group:"body"},{id:"healthy-eating",name:{en:"Healthy Eating",de:"Gesund essen",fr:"Manger sainement"},emoji:"ðŸ¥—",group:"body"},{id:"days-week",name:{en:"Days of the Week",de:"Wochentage",fr:"Jours de la semaine"},emoji:"ðŸ“…",group:"time"},{id:"months-year",name:{en:"Months of the Year",de:"Monate des Jahres",fr:"Mois de l'annÃ©e"},emoji:"ðŸ—“ï¸",group:"time"},{id:"telling-time",name:{en:"Telling Time",de:"Uhr lesen",fr:"Lire l'heure"},emoji:"ðŸ•",group:"time"},{id:"continents",name:{en:"Continents",de:"Kontinente",fr:"Continents"},emoji:"ðŸŒ",group:"geography"},{id:"countries-flags",name:{en:"Countries & Flags",de:"LÃ¤nder & Flaggen",fr:"Pays & Drapeaux"},emoji:"ðŸ³ï¸",group:"geography"},{id:"instruments",name:{en:"Musical Instruments",de:"Musikinstrumente",fr:"Instruments de musique"},emoji:"ðŸŽ¸",group:"arts"},{id:"famous-artists",name:{en:"Famous Artists",de:"BerÃ¼hmte KÃ¼nstler",fr:"Artistes cÃ©lÃ¨bres"},emoji:"ðŸ–¼ï¸",group:"arts"}],Yo=["alphabet","numbers-1-10","rhyming","seasons","weather","water-cycle","farm-animals","five-senses","days-week","months-year"],Il=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"}},{id:"letters",name:{en:"Letters & Reading",de:"Buchstaben & Lesen",fr:"Lettres & Lecture"}},{id:"numbers",name:{en:"Numbers & Math",de:"Zahlen & Mathe",fr:"Nombres & Maths"}},{id:"colors",name:{en:"Colors",de:"Farben",fr:"Couleurs"}},{id:"science",name:{en:"Nature & Science",de:"Natur & Wissenschaft",fr:"Nature & Science"}},{id:"animals",name:{en:"Animals",de:"Tiere",fr:"Animaux"}},{id:"body",name:{en:"Body & Health",de:"KÃ¶rper & Gesundheit",fr:"Corps & SantÃ©"}},{id:"time",name:{en:"Time & Calendar",de:"Zeit & Kalender",fr:"Temps & Calendrier"}},{id:"geography",name:{en:"World & Geography",de:"Welt & Geografie",fr:"Monde & GÃ©ographie"}},{id:"arts",name:{en:"Music & Art",de:"Musik & Kunst",fr:"Musique & Art"}}],Xo=["wilhelm-tell","gotthard-tunnel","moon-landing","columbus-voyage","wright-brothers","lindbergh-flight","galapagos-darwin","berlin-wall-fall","golden-gate"],Tl=[{id:"popular",name:{en:"Popular",de:"Beliebt",fr:"Populaires"},icon:"â­"},{id:"swiss",name:{en:"Swiss History",de:"Schweizer Geschichte",fr:"Histoire Suisse"},icon:"ðŸ‡¨ðŸ‡­"},{id:"exploration",name:{en:"Exploration & Discovery",de:"Entdeckungen",fr:"Exploration & DÃ©couverte"},icon:"ðŸ§­"},{id:"science",name:{en:"Science & Medicine",de:"Wissenschaft & Medizin",fr:"Science & MÃ©decine"},icon:"ðŸ”¬"},{id:"invention",name:{en:"Inventions",de:"Erfindungen",fr:"Inventions"},icon:"ðŸ’¡"},{id:"rights",name:{en:"Human Rights & Freedom",de:"Menschenrechte & Freiheit",fr:"Droits humains & LibertÃ©"},icon:"âœŠ"},{id:"construction",name:{en:"Great Constructions",de:"Grosse Bauwerke",fr:"Grandes Constructions"},icon:"ðŸ—ï¸"},{id:"culture",name:{en:"Culture & Arts",de:"Kultur & Kunst",fr:"Culture & Arts"},icon:"ðŸŽ­"},{id:"archaeology",name:{en:"Archaeological Discoveries",de:"ArchÃ¤ologische Entdeckungen",fr:"DÃ©couvertes ArchÃ©ologiques"},icon:"ðŸº"}],Zn=[{id:"swiss-founding",name:{en:"Founding of Switzerland (RÃ¼tlischwur)",de:"GrÃ¼ndung der Schweiz (RÃ¼tlischwur)",fr:"Fondation de la Suisse (Serment du GrÃ¼tli)"},shortName:{en:"RÃ¼tlischwur",de:"RÃ¼tlischwur",fr:"Serment du GrÃ¼tli"},emoji:"ðŸ¤",year:1291,category:"swiss"},{id:"wilhelm-tell",name:{en:"Wilhelm Tell and the Apple",de:"Wilhelm Tell und der Apfel",fr:"Guillaume Tell et la pomme"},shortName:{en:"Wilhelm Tell",de:"Wilhelm Tell",fr:"Guillaume Tell"},emoji:"ðŸ¹",year:1307,category:"swiss",mainPerson:"Wilhelm Tell"},{id:"battle-morgarten",name:{en:"Battle of Morgarten",de:"Schlacht am Morgarten",fr:"Bataille de Morgarten"},shortName:{en:"Morgarten",de:"Morgarten",fr:"Morgarten"},emoji:"âš”ï¸",year:1315,category:"swiss"},{id:"battle-sempach",name:{en:"Battle of Sempach (Winkelried)",de:"Schlacht bei Sempach (Winkelried)",fr:"Bataille de Sempach (Winkelried)"},shortName:{en:"Sempach",de:"Sempach",fr:"Sempach"},emoji:"ðŸ›¡ï¸",year:1386,category:"swiss",mainPerson:"Arnold von Winkelried"},{id:"swiss-reformation",name:{en:"Swiss Reformation (Zwingli)",de:"Schweizer Reformation (Zwingli)",fr:"RÃ©forme Suisse (Zwingli)"},shortName:{en:"Reformation",de:"Reformation",fr:"RÃ©forme"},emoji:"ðŸ“œ",year:1523,category:"swiss",mainPerson:"Huldrych Zwingli"},{id:"red-cross-founding",name:{en:"Henry Dunant Founds the Red Cross",de:"Henry Dunant grÃ¼ndet das Rote Kreuz",fr:"Henry Dunant fonde la Croix-Rouge"},shortName:{en:"Red Cross",de:"Rotes Kreuz",fr:"Croix-Rouge"},emoji:"â¤ï¸",year:1863,category:"swiss",mainPerson:"Henry Dunant"},{id:"general-dufour",name:{en:"General Dufour and Swiss Unity",de:"General Dufour und die Schweizer Einheit",fr:"GÃ©nÃ©ral Dufour et l'unitÃ© suisse"},shortName:{en:"General Dufour",de:"General Dufour",fr:"GÃ©nÃ©ral Dufour"},emoji:"ðŸŽ–ï¸",year:1847,category:"swiss",mainPerson:"Guillaume-Henri Dufour"},{id:"sonderbund-war",name:{en:"The Sonderbund War",de:"Der Sonderbundskrieg",fr:"La Guerre du Sonderbund"},shortName:{en:"Sonderbund",de:"Sonderbund",fr:"Sonderbund"},emoji:"ðŸ”ï¸",year:1847,category:"swiss"},{id:"swiss-constitution",name:{en:"Swiss Federal Constitution",de:"Schweizerische Bundesverfassung",fr:"Constitution fÃ©dÃ©rale suisse"},shortName:{en:"Constitution",de:"Bundesverfassung",fr:"Constitution"},emoji:"ðŸ“‹",year:1848,category:"swiss"},{id:"gotthard-tunnel",name:{en:"Building the Gotthard Tunnel",de:"Bau des Gotthardtunnels",fr:"Construction du tunnel du Gothard"},shortName:{en:"Gotthard Tunnel",de:"Gotthardtunnel Bau",fr:"Tunnel du Gothard"},emoji:"ðŸš‚",year:1882,category:"swiss"},{id:"swiss-ww1-neutrality",name:{en:"Swiss Neutrality in WWI",de:"Schweizer NeutralitÃ¤t im 1. Weltkrieg",fr:"NeutralitÃ© suisse pendant la PremiÃ¨re Guerre"},shortName:{en:"WWI Neutrality",de:"NeutralitÃ¤t 1. WK",fr:"NeutralitÃ© 1GM"},emoji:"ðŸ•Šï¸",year:1914,category:"swiss"},{id:"general-guisan",name:{en:"General Guisan and the RÃ¼tli Report",de:"General Guisan und der RÃ¼tlirapport",fr:"GÃ©nÃ©ral Guisan et le Rapport du GrÃ¼tli"},shortName:{en:"General Guisan",de:"General Guisan",fr:"GÃ©nÃ©ral Guisan"},emoji:"ðŸŽ–ï¸",year:1940,category:"swiss",mainPerson:"Henri Guisan"},{id:"swiss-ww2-neutrality",name:{en:"Switzerland in World War II",de:"Die Schweiz im 2. Weltkrieg",fr:"La Suisse pendant la Seconde Guerre"},shortName:{en:"WWII",de:"2. Weltkrieg",fr:"2Ã¨me GM"},emoji:"ðŸ”ï¸",year:1939,category:"swiss"},{id:"swiss-womens-vote",name:{en:"Swiss Women Win the Vote",de:"Schweizer Frauenstimmrecht",fr:"Droit de vote des femmes suisses"},shortName:{en:"Women's Vote",de:"Frauenstimmrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1971,category:"swiss"},{id:"moon-landing",name:{en:"First Moon Landing",de:"Erste Mondlandung",fr:"Premier pas sur la Lune"},shortName:{en:"Moon Landing",de:"Mondlandung",fr:"Alunissage"},emoji:"ðŸŒ™",year:1969,category:"exploration",mainPerson:"Neil Armstrong"},{id:"columbus-voyage",name:{en:"Columbus Reaches the Americas",de:"Kolumbus erreicht Amerika",fr:"Colomb atteint les AmÃ©riques"},shortName:{en:"Discovery of America",de:"Entdeckung Amerikas",fr:"DÃ©couverte de l'AmÃ©rique"},emoji:"â›µ",year:1492,category:"exploration",mainPerson:"Christopher Columbus"},{id:"wright-brothers",name:{en:"First Powered Flight",de:"Erster Motorflug",fr:"Premier vol motorisÃ©"},shortName:{en:"First Flight",de:"Erster Flug",fr:"Premier vol"},emoji:"âœˆï¸",year:1903,category:"exploration",mainPerson:"Wright Brothers"},{id:"lindbergh-flight",name:{en:"First Solo Atlantic Crossing",de:"Erster Atlantik-Soloflug",fr:"PremiÃ¨re traversÃ©e solitaire"},shortName:{en:"Atlantic Flight",de:"Atlantikflug",fr:"Vol Atlantique"},emoji:"ðŸ›©ï¸",year:1927,category:"exploration",mainPerson:"Charles Lindbergh"},{id:"everest-summit",name:{en:"First Everest Summit",de:"Erste Everest-Besteigung",fr:"Premier sommet de l'Everest"},shortName:{en:"Climbing Everest",de:"Everest-Besteigung",fr:"Ascension Everest"},emoji:"ðŸ”ï¸",year:1953,category:"exploration",mainPerson:"Edmund Hillary & Tenzing Norgay"},{id:"south-pole",name:{en:"First to the South Pole",de:"Erster am SÃ¼dpol",fr:"Premier au PÃ´le Sud"},shortName:{en:"South Pole",de:"SÃ¼dpol",fr:"PÃ´le Sud"},emoji:"â„ï¸",year:1911,category:"exploration",mainPerson:"Roald Amundsen"},{id:"magellan-circumnavigation",name:{en:"First Circumnavigation",de:"Erste Weltumsegelung",fr:"Premier tour du monde"},shortName:{en:"Around the World",de:"Weltumsegelung",fr:"Tour du monde"},emoji:"ðŸŒ",year:1522,category:"exploration",mainPerson:"Ferdinand Magellan"},{id:"mariana-trench",name:{en:"Deepest Ocean Dive",de:"Tiefster Meerstauchgang",fr:"PlongÃ©e la plus profonde"},shortName:{en:"Deep Sea Dive",de:"Tiefseetauchen",fr:"PlongÃ©e profonde"},emoji:"ðŸŒŠ",year:1960,category:"exploration",mainPerson:"Jacques Piccard"},{id:"electricity-discovery",name:{en:"Franklin's Kite Experiment",de:"Franklins Drachenexperiment",fr:"ExpÃ©rience du cerf-volant"},shortName:{en:"Electricity Discovery",de:"ElektrizitÃ¤t entdeckt",fr:"DÃ©couverte Ã©lectricitÃ©"},emoji:"âš¡",year:1752,category:"science",mainPerson:"Benjamin Franklin"},{id:"penicillin",name:{en:"Discovery of Penicillin",de:"Entdeckung des Penicillins",fr:"DÃ©couverte de la pÃ©nicilline"},shortName:{en:"Penicillin",de:"Penicillin",fr:"PÃ©nicilline"},emoji:"ðŸ’Š",year:1928,category:"science",mainPerson:"Alexander Fleming"},{id:"vaccine-discovery",name:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},shortName:{en:"First Vaccine",de:"Erste Impfung",fr:"Premier vaccin"},emoji:"ðŸ’‰",year:1796,category:"science",mainPerson:"Edward Jenner"},{id:"dna-discovery",name:{en:"DNA Structure Discovered",de:"DNA-Struktur entdeckt",fr:"Structure ADN dÃ©couverte"},shortName:{en:"DNA Discovery",de:"DNA-Entdeckung",fr:"DÃ©couverte ADN"},emoji:"ðŸ§¬",year:1953,category:"science",mainPerson:"Watson & Crick"},{id:"dinosaur-discovery",name:{en:"First Dinosaur Named",de:"Erster Dinosaurier benannt",fr:"Premier dinosaure nommÃ©"},shortName:{en:"Dinosaur Discovery",de:"Dinosaurier-Entdeckung",fr:"DÃ©couverte dinosaure"},emoji:"ðŸ¦•",year:1824,category:"science",mainPerson:"William Buckland"},{id:"einstein-relativity",name:{en:"Einstein's Relativity",de:"Einsteins RelativitÃ¤tstheorie",fr:"RelativitÃ© d'Einstein"},shortName:{en:"Einstein's Theory",de:"Einsteins Theorie",fr:"ThÃ©orie d'Einstein"},emoji:"ðŸ§ ",year:1905,category:"science",mainPerson:"Albert Einstein"},{id:"galapagos-darwin",name:{en:"Darwin Visits GalÃ¡pagos",de:"Darwin auf GalÃ¡pagos",fr:"Darwin aux GalÃ¡pagos"},shortName:{en:"Darwin's Voyage",de:"Darwins Reise",fr:"Voyage de Darwin"},emoji:"ðŸ¢",year:1835,category:"science",mainPerson:"Charles Darwin"},{id:"first-heart-transplant",name:{en:"First Heart Transplant",de:"Erste Herztransplantation",fr:"PremiÃ¨re greffe cardiaque"},shortName:{en:"Heart Transplant",de:"Herztransplantation",fr:"Greffe cardiaque"},emoji:"â¤ï¸",year:1967,category:"science",mainPerson:"Christiaan Barnard"},{id:"human-genome",name:{en:"Human Genome Decoded",de:"Menschliches Genom entschlÃ¼sselt",fr:"GÃ©nome humain dÃ©codÃ©"},shortName:{en:"Genome Project",de:"Genom-Projekt",fr:"Projet GÃ©nome"},emoji:"ðŸ§ª",year:2003,category:"science"},{id:"hubble-launch",name:{en:"Hubble Telescope Launch",de:"Hubble-Teleskop Start",fr:"Lancement tÃ©lescope Hubble"},shortName:{en:"Hubble Telescope",de:"Hubble-Teleskop",fr:"TÃ©lescope Hubble"},emoji:"ðŸ”­",year:1990,category:"science"},{id:"telephone-invention",name:{en:"First Telephone Call",de:"Erster Telefonanruf",fr:"Premier appel tÃ©lÃ©phonique"},shortName:{en:"Telephone",de:"Telefon",fr:"TÃ©lÃ©phone"},emoji:"ðŸ“ž",year:1876,category:"invention",mainPerson:"Alexander Graham Bell"},{id:"light-bulb",name:{en:"Edison's Light Bulb",de:"Edisons GlÃ¼hbirne",fr:"Ampoule d'Edison"},shortName:{en:"Light Bulb",de:"GlÃ¼hbirne",fr:"Ampoule"},emoji:"ðŸ’¡",year:1879,category:"invention",mainPerson:"Thomas Edison"},{id:"printing-press",name:{en:"Gutenberg's Printing Press",de:"Gutenbergs Buchdruck",fr:"Presse de Gutenberg"},shortName:{en:"Printing Press",de:"Buchdruck",fr:"Imprimerie"},emoji:"ðŸ“–",year:1440,category:"invention",mainPerson:"Johannes Gutenberg"},{id:"internet-creation",name:{en:"Birth of the World Wide Web",de:"Geburt des World Wide Web",fr:"Naissance du Web"},shortName:{en:"The Web",de:"Das Internet",fr:"Le Web"},emoji:"ðŸŒ",year:1991,category:"invention",mainPerson:"Tim Berners-Lee"},{id:"emancipation",name:{en:"Abolition of Slavery",de:"Abschaffung der Sklaverei",fr:"Abolition de l'esclavage"},shortName:{en:"End of Slavery",de:"Ende der Sklaverei",fr:"Fin de l'esclavage"},emoji:"â›“ï¸",year:1865,category:"rights",mainPerson:"Abraham Lincoln"},{id:"womens-suffrage",name:{en:"Women Win the Vote",de:"Frauenwahlrecht",fr:"Droit de vote des femmes"},shortName:{en:"Women's Vote",de:"Frauenwahlrecht",fr:"Vote des femmes"},emoji:"ðŸ—³ï¸",year:1920,category:"rights"},{id:"rosa-parks",name:{en:"Rosa Parks & Bus Boycott",de:"Rosa Parks & Busboykott",fr:"Rosa Parks & Boycott des bus"},shortName:{en:"Rosa Parks",de:"Rosa Parks",fr:"Rosa Parks"},emoji:"ðŸšŒ",year:1955,category:"rights",mainPerson:"Rosa Parks"},{id:"berlin-wall-fall",name:{en:"Fall of the Berlin Wall",de:"Fall der Berliner Mauer",fr:"Chute du mur de Berlin"},shortName:{en:"Berlin Wall Fall",de:"Fall der Berliner Mauer",fr:"Chute du Mur de Berlin"},emoji:"ðŸ§±",year:1989,category:"rights"},{id:"mandela-freedom",name:{en:"Mandela Released",de:"Mandela befreit",fr:"Mandela libÃ©rÃ©"},shortName:{en:"Mandela Free",de:"Mandela frei",fr:"Mandela libre"},emoji:"âœŠ",year:1990,category:"rights",mainPerson:"Nelson Mandela"},{id:"pyramids",name:{en:"Building the Great Pyramids",de:"Bau der Pyramiden",fr:"Construction des Pyramides"},shortName:{en:"The Pyramids",de:"Die Pyramiden",fr:"Les Pyramides"},emoji:"ðŸ”º",year:"-2560",category:"construction"},{id:"eiffel-tower",name:{en:"Eiffel Tower Opens",de:"Eiffelturm erÃ¶ffnet",fr:"Tour Eiffel inaugurÃ©e"},shortName:{en:"Eiffel Tower",de:"Eiffelturm",fr:"Tour Eiffel"},emoji:"ðŸ—¼",year:1889,category:"construction",mainPerson:"Gustave Eiffel"},{id:"panama-canal",name:{en:"Panama Canal Opens",de:"Panamakanal erÃ¶ffnet",fr:"Canal de Panama inaugurÃ©"},shortName:{en:"Panama Canal",de:"Panamakanal",fr:"Canal de Panama"},emoji:"ðŸš¢",year:1914,category:"construction"},{id:"golden-gate",name:{en:"Building the Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Construction du pont Golden Gate"},shortName:{en:"Golden Gate Bridge",de:"Bau der Golden Gate Bridge",fr:"Pont Golden Gate"},emoji:"ðŸŒ‰",year:1937,category:"construction"},{id:"channel-tunnel",name:{en:"Channel Tunnel Opens",de:"Eurotunnel erÃ¶ffnet",fr:"Tunnel sous la Manche"},shortName:{en:"Chunnel",de:"Eurotunnel",fr:"Eurotunnel"},emoji:"ðŸš‡",year:1994,category:"construction"},{id:"first-olympics",name:{en:"First Modern Olympics",de:"Erste moderne Olympiade",fr:"Premiers Jeux Olympiques modernes"},shortName:{en:"Modern Olympics",de:"Moderne Olympiade",fr:"Jeux modernes"},emoji:"ðŸ…",year:1896,category:"culture"},{id:"disneyland-opening",name:{en:"Disneyland Opens",de:"Disneyland erÃ¶ffnet",fr:"Disneyland ouvre"},shortName:{en:"Disneyland",de:"Disneyland",fr:"Disneyland"},emoji:"ðŸ°",year:1955,category:"culture",mainPerson:"Walt Disney"},{id:"first-movie",name:{en:"Birth of Cinema",de:"Geburt des Kinos",fr:"Naissance du cinÃ©ma"},shortName:{en:"First Movies",de:"Erste Filme",fr:"Premiers films"},emoji:"ðŸŽ¬",year:1895,category:"culture",mainPerson:"LumiÃ¨re Brothers"},{id:"first-zoo",name:{en:"First Modern Zoo Opens",de:"Erster moderner Zoo",fr:"Premier zoo moderne"},shortName:{en:"London Zoo",de:"London Zoo",fr:"Zoo de Londres"},emoji:"ðŸ¦",year:1828,category:"culture"},{id:"natural-history-museum",name:{en:"Natural History Museum Opens",de:"Naturhistorisches Museum",fr:"MusÃ©e d'Histoire Naturelle"},shortName:{en:"Natural History Museum",de:"Naturkundemuseum",fr:"MusÃ©e Histoire Naturelle"},emoji:"ðŸ›ï¸",year:1881,category:"culture"},{id:"king-tut",name:{en:"King Tut's Tomb Discovered",de:"Tutanchamuns Grab entdeckt",fr:"Tombeau de ToutÃ¢nkhamon"},shortName:{en:"King Tut",de:"Tutanchamun",fr:"ToutÃ¢nkhamon"},emoji:"ðŸ‘‘",year:1922,category:"archaeology",mainPerson:"Howard Carter"},{id:"pompeii-discovery",name:{en:"Rediscovery of Pompeii",de:"Wiederentdeckung von Pompeji",fr:"RedÃ©couverte de PompÃ©i"},shortName:{en:"Pompeii",de:"Pompeji",fr:"PompÃ©i"},emoji:"ðŸŒ‹",year:1748,category:"archaeology"},{id:"terracotta-army",name:{en:"Terracotta Army Discovered",de:"Terrakotta-Armee entdeckt",fr:"ArmÃ©e de terre cuite"},shortName:{en:"Terracotta Army",de:"Terrakotta-Armee",fr:"ArmÃ©e terre cuite"},emoji:"ðŸ—¿",year:1974,category:"archaeology"}];function Rl(r){return r==="popular"?gn.filter(l=>Qo.includes(l.id)):gn.filter(l=>l.group===r)}function Dl(r){return r==="popular"?Jn.filter(l=>Zo.includes(l.id)):Jn.filter(l=>l.ageGroup===r)}function Fl(r){return r==="popular"?Qn.filter(l=>Yo.includes(l.id)):Qn.filter(l=>l.group===r)}function El(r){return r==="popular"?Zn.filter(l=>Xo.includes(l.id)):Zn.filter(l=>l.category===r)}const el={ideaModel:null,outlineModel:null,textModel:null,sceneDescriptionModel:null,imageModel:null,coverImageModel:null,qualityModel:null,imageBackend:null,avatarModel:null},or={enableAutoRepair:!1,enableFinalChecks:!0,incrementalConsistency:!1,incrementalConsistencyDryRun:!0,lookbackCount:3,checkOnlyMode:!1,useGridRepair:!0,forceRepairThreshold:null,enableSceneValidation:!1,separatedEvaluation:!1};function tl(){const r=localStorage.getItem("developer_mode")==="true",[l,o]=i.useState(r),[c,s]=i.useState(null),[E,g]=i.useState("auto"),[S,R]=i.useState(!1),[V,M]=i.useState(!1),[N,k]=i.useState(!1),[f,q]=i.useState(!1),[j,x]=i.useState(r),[O,xe]=i.useState(or.enableAutoRepair),[ne,T]=i.useState(or.enableFinalChecks),[L,z]=i.useState(or.incrementalConsistency),[F,W]=i.useState(or.incrementalConsistencyDryRun),[P,ee]=i.useState(or.lookbackCount),[Q,Ne]=i.useState(or.checkOnlyMode),[Se,b]=i.useState(or.useGridRepair),[H,ie]=i.useState(or.forceRepairThreshold),[je,le]=i.useState(or.enableSceneValidation),[G,I]=i.useState(or.separatedEvaluation),[me,te]=i.useState(!1),[ge,Z]=i.useState({...el}),Te=Me=>{o(Me),x(!!Me)};return i.useEffect(()=>{l?localStorage.setItem("developer_mode","true"):localStorage.removeItem("developer_mode")},[l]),{developerMode:l,setDeveloperMode:Te,imageGenMode:c,setImageGenMode:s,generationMode:E,setGenerationMode:g,devSkipOutline:S,setDevSkipOutline:R,devSkipText:V,setDevSkipText:M,devSkipSceneDescriptions:N,setDevSkipSceneDescriptions:k,devSkipImages:f,setDevSkipImages:q,devSkipCovers:j,setDevSkipCovers:x,enableAutoRepair:O,setEnableAutoRepair:xe,enableFinalChecks:ne,setEnableFinalChecks:T,incrementalConsistency:L,setIncrementalConsistency:z,incrementalConsistencyDryRun:F,setIncrementalConsistencyDryRun:W,lookbackCount:P,setLookbackCount:ee,checkOnlyMode:Q,setCheckOnlyMode:Ne,useGridRepair:Se,setUseGridRepair:b,forceRepairThreshold:H,setForceRepairThreshold:ie,enableSceneValidation:je,setEnableSceneValidation:le,separatedEvaluation:G,setSeparatedEvaluation:I,loadAllAvatars:me,setLoadAllAvatars:te,modelSelections:ge,setModelSelections:Z}}const rl=i.lazy(()=>ta(()=>import("./WizardStep2Characters-CIPuf9Lp.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])).then(r=>({default:r.WizardStep2Characters}))),sl=i.lazy(()=>ta(()=>Promise.resolve().then(()=>Vo),void 0).then(r=>({default:r.WizardStep3BookSettings}))),al=i.lazy(()=>ta(()=>import("./WizardStep4StoryType-8loGo2pN.js"),__vite__mapDeps([24,1,2,3,4,7,17,12,13,5,6,8,18,19,14,20,21,9,22,23,15])).then(r=>({default:r.WizardStep4StoryType}))),nl=i.lazy(()=>ta(()=>import("./WizardStep5ArtStyle-Df7xVbdZ.js"),__vite__mapDeps([25,1,2,3,4,26,20])).then(r=>({default:r.WizardStep5ArtStyle}))),il=i.lazy(()=>ta(()=>import("./WizardStep6Summary-DkD7uXQf.js"),__vite__mapDeps([27,1,2,3,4,26,17,9,7,5,6,8,18,19,12,13,14,20,21,22,23,15])).then(r=>({default:r.WizardStep6Summary}))),y=hn("StoryWizard"),Yn={en:{1:"Add photos of your characters - they'll appear consistently throughout your story!",2:"Set the book length and reading level for your audience",3:"Choose a story type and theme",4:"Pick an illustration style for your book",5:"Review your choices, add plot details, then generate your story!"},de:{1:"FÃ¼ge Fotos deiner Charaktere hinzu - sie erscheinen einheitlich in der gesamten Geschichte!",2:"Lege die BuchlÃ¤nge und das Leseniveau fÃ¼r dein Publikum fest",3:"WÃ¤hle einen Geschichtstyp und ein Thema",4:"WÃ¤hle einen Illustrationsstil fÃ¼r dein Buch",5:"ÃœberprÃ¼fe deine Auswahl, fÃ¼ge Handlungsdetails hinzu und generiere deine Geschichte!"},fr:{1:"Ajoutez des photos de vos personnages - ils apparaÃ®tront de maniÃ¨re cohÃ©rente dans toute votre histoire!",2:"DÃ©finissez la longueur du livre et le niveau de lecture pour votre public",3:"Choisissez un type d'histoire et un thÃ¨me",4:"Choisissez un style d'illustration pour votre livre",5:"VÃ©rifiez vos choix, ajoutez des dÃ©tails de l'intrigue, puis gÃ©nÃ©rez votre histoire!"}};function ol(){const r=Vi(),[l,o]=Wi(),{t:c,language:s}=lr(),{isAuthenticated:E,user:g,updateCredits:S,refreshUser:R,isLoading:V,isImpersonating:M}=xn(),{showSuccess:N,showInfo:k,showError:f}=_i(),{startTracking:q,stopTracking:j,activeJob:x,isComplete:O,completedStoryId:xe,markCompletionViewed:ne,hasUnviewedCompletion:T}=Hi(),[L,z]=i.useState(()=>{const n=new URLSearchParams(window.location.search);if(n.get("storyId"))return 6;if(n.get("new")==="true")return 1;const v=localStorage.getItem("wizard_step");return v?parseInt(v,10):1}),[F,W]=i.useState(()=>!!new URLSearchParams(window.location.search).get("storyId")),[P,ee]=i.useState(null),{developerMode:Q,setDeveloperMode:Ne,imageGenMode:Se,setImageGenMode:b,generationMode:H,setGenerationMode:ie,devSkipOutline:je,setDevSkipOutline:le,devSkipText:G,setDevSkipText:I,devSkipSceneDescriptions:me,setDevSkipSceneDescriptions:te,devSkipImages:ge,setDevSkipImages:Z,devSkipCovers:Te,setDevSkipCovers:Me,enableAutoRepair:Je,setEnableAutoRepair:It,useGridRepair:vt,setUseGridRepair:dr,forceRepairThreshold:ss,setForceRepairThreshold:Zt,enableFinalChecks:ra,setEnableFinalChecks:sa,incrementalConsistency:kr,setIncrementalConsistency:Pr,incrementalConsistencyDryRun:aa,setIncrementalConsistencyDryRun:a,lookbackCount:Re,setLookbackCount:ct,checkOnlyMode:$e,setCheckOnlyMode:Cs,enableSceneValidation:jt,setEnableSceneValidation:cr,separatedEvaluation:Yt,setSeparatedEvaluation:Gr,loadAllAvatars:mr,setLoadAllAvatars:as,modelSelections:at,setModelSelections:na}=tl(),[Tt,Xt]=i.useState(()=>localStorage.getItem("story_type")||""),[De,Ar]=i.useState(()=>localStorage.getItem("story_category")||""),[We,ns]=i.useState(()=>localStorage.getItem("story_topic")||""),[qe,$r]=i.useState(()=>localStorage.getItem("story_theme")||""),[Ye,ur]=i.useState(()=>localStorage.getItem("story_custom_theme_text")||""),[wt,ht]=i.useState(()=>localStorage.getItem("story_art_style")||"watercolor"),[ke,ye]=i.useState([]),[gr,xt]=i.useState(null),[C,Fe]=i.useState(null),ks=i.useRef([]),Ir=i.useRef(null),[ia,ot]=i.useState(!1),[oa,nt]=i.useState("photo"),[la,hr]=i.useState(!1),[Xe,pt]=i.useState(null),[Ps,xr]=i.useState(!1),[is,Ot]=i.useState(!1),[os,As]=i.useState(void 0),[Ja,$s]=i.useState(void 0),da=i.useRef(null),[Qa,pr]=i.useState(!1),[ls,Is]=i.useState([]),[_r,ds]=i.useState(null),[Ts,Hr]=i.useState(null),[ft,Vr]=i.useState({}),[Rt,Rs]=i.useState({}),[Tr,ca]=i.useState([]),Ds=i.useRef(null),fr=i.useRef(!1),Rr=i.useRef(!1),[Wr,ma]=i.useState(!1),[Lt,Gt]=i.useState([]),[mt,qr]=i.useState([]),cs=i.useRef(!1),[St,_t]=i.useState(()=>{try{return localStorage.getItem("story_language_level")||"standard"}catch{return"standard"}}),[Dt,ua]=i.useState(()=>{try{const n=localStorage.getItem("story_language");if(n){if(n==="de")return"de-ch";if(n==="fr")return"fr-ch";if(n==="it")return"it-ch";if(n==="en")return"en-gb";if(n.startsWith("de")||n.startsWith("fr")||n.startsWith("it")||n.startsWith("en")||n.startsWith("gsw"))return n}return"de-ch"}catch{return"de-ch"}}),[bt,ms]=i.useState(()=>{try{const n=localStorage.getItem("story_pages");return n?parseInt(n):30}catch{return 30}}),[br,Ur]=i.useState(()=>localStorage.getItem("story_dedication")||""),[yr,Ht]=i.useState(()=>localStorage.getItem("story_details")||""),[Ft,er]=i.useState(!1),[Fs,Kr]=i.useState(!1),[Vt,Ct]=i.useState(!1),[us,ga]=i.useState(0),[ha,Es]=i.useState(0),[Wt,Jr]=i.useState(null),[Qr,Dr]=i.useState(""),[kt,qt]=i.useState([]),[xa,Bs]=i.useState(null),[zs,pa]=i.useState(null),tr=i.useRef(null),[rr,Ms]=i.useState(null),[sr,fa]=i.useState(()=>ni()),[t,h]=i.useState(!1),[m,A]=i.useState(new Set),[d,re]=i.useState(!1),[he,_e]=i.useState(!1),[Be,st]=i.useState(!1),[yt,Pt]=i.useState(!1),[pe,dt]=i.useState(!1),[Zr,ar]=i.useState(!1),[vr,nr]=i.useState({current:0,total:0,message:""}),[At,Fr]=i.useState(null),[ba,jr]=i.useState(!1),[gs,Ut]=i.useState(""),[Nr,Er]=i.useState(""),[ya,Os]=i.useState(""),[va,Ls]=i.useState(""),[ja,Gs]=i.useState(""),[Na,_s]=i.useState(),[wa,Hs]=i.useState(),[Sa,Vs]=i.useState([]),[Ca,wr]=i.useState(null),[ka,Yr]=i.useState(null),[Pa,hs]=i.useState([]),[Aa,xs]=i.useState([]),[$a,ps]=i.useState([]),[K,Ae]=i.useState(null),[Pe,Kt]=i.useState([]),[fs,et]=i.useState([]),[Ws,ir]=i.useState({frontCover:null,initialPage:null,backCover:null}),[Ce,Za]=i.useState(null),[oi,li]=i.useState(0),[Ya,Ia]=i.useState(null),[di,yn]=i.useState(!1),[ci,vn]=i.useState(),[mi,jn]=i.useState(),[ui,Nn]=i.useState(),[gi,Xa]=i.useState(null),en=i.useRef(!1),Br=i.useRef(!1),[$t,Ta]=i.useState(null),[tn,Ra]=i.useState({}),[hi,Da]=i.useState(!1),[it,Fa]=i.useState(null),[qs,Us]=i.useState("");i.useEffect(()=>{ks.current=ke},[ke]),i.useEffect(()=>{Ir.current=C},[C]),i.useEffect(()=>{if(!V&&!E){if(!!localStorage.getItem("auth_token")){y.debug("Token found but not authenticated yet, waiting for state sync...");return}const v=window.location.pathname+window.location.search,u=encodeURIComponent(v);r(`/?login=true&redirect=${u}`)}},[E,V,r]);const Ea=i.useCallback(n=>{var v,u,B,p,w,D,_,$,de,X;if(n){if((v=n.sceneImages)!=null&&v.length&&et(oe=>oe.map(fe=>{const Ie=n.sceneImages.find(Qe=>Qe.pageNumber===fe.pageNumber);return Ie?{...fe,prompt:Ie.prompt??fe.prompt,qualityReasoning:Ie.qualityReasoning??fe.qualityReasoning,retryHistory:Ie.retryHistory??fe.retryHistory,repairHistory:Ie.repairHistory??fe.repairHistory,wasRegenerated:Ie.wasRegenerated??fe.wasRegenerated,originalScore:Ie.originalScore??fe.originalScore,originalReasoning:Ie.originalReasoning??fe.originalReasoning,totalAttempts:Ie.totalAttempts??fe.totalAttempts,faceEvaluation:Ie.faceEvaluation??fe.faceEvaluation,referencePhotos:Ie.referencePhotos??fe.referencePhotos,landmarkPhotos:Ie.landmarkPhotos??fe.landmarkPhotos,consistencyRegen:Ie.consistencyRegen??fe.consistencyRegen}:fe})),n.coverImages&&ir(oe=>{var Qe;const fe={...oe},Ie=["frontCover","initialPage","backCover"];for(const tt of Ie){const ce=(Qe=n.coverImages)==null?void 0:Qe[tt],Ve=oe[tt];ce&&typeof Ve=="object"&&Ve!==null&&(fe[tt]={...Ve,prompt:ce.prompt??Ve.prompt,qualityReasoning:ce.qualityReasoning??Ve.qualityReasoning,retryHistory:ce.retryHistory??Ve.retryHistory,referencePhotos:ce.referencePhotos??Ve.referencePhotos,landmarkPhotos:ce.landmarkPhotos??Ve.landmarkPhotos})}return fe}),console.log("[StoryWizard] Dev metadata generationLog:",((u=n.generationLog)==null?void 0:u.length)||0,"entries"),(B=n.generationLog)!=null&&B.length&&ps(n.generationLog),(p=n.styledAvatarGeneration)!=null&&p.length&&(console.log("[StoryWizard] Dev metadata styledAvatarGeneration:",((w=n.styledAvatarGeneration)==null?void 0:w.length)??0,"entries"),hs(n.styledAvatarGeneration)),(D=n.costumedAvatarGeneration)!=null&&D.length&&(console.log("[StoryWizard] Dev metadata costumedAvatarGeneration:",((_=n.costumedAvatarGeneration)==null?void 0:_.length)??0,"entries"),xs(n.costumedAvatarGeneration)),n.finalChecksReport&&(console.log("[StoryWizard] Dev metadata finalChecksReport:",n.finalChecksReport.totalIssues,"issues"),Ae(n.finalChecksReport)),($=n.sceneDescriptions)!=null&&$.length){const oe=n.sceneDescriptions;console.log("[StoryWizard] Dev metadata sceneDescriptions:",oe.length,"entries"),console.log("[StoryWizard] First scene keys:",Object.keys(oe[0]||{})),console.log("[StoryWizard] First scene has outlineExtract:",!!((de=oe[0])!=null&&de.outlineExtract)),console.log("[StoryWizard] First scene has scenePrompt:",!!((X=oe[0])!=null&&X.scenePrompt)),Kt(n.sceneDescriptions)}n.visualBible&&(console.log("[StoryWizard] Dev metadata visualBible loaded"),wr(n.visualBible))}},[]);i.useEffect(()=>{Ee.getUserLocation().then(n=>{Ms(n),n!=null&&n.city&&Ee.triggerLandmarkDiscovery(n.city,n.country)})},[]),i.useEffect(()=>{E&&Ee.getStories({limit:1}).then(({pagination:n})=>{dt(n.total>0)}).catch(()=>dt(!1))},[E]);const rn=i.useRef(null);i.useEffect(()=>{const n=l.get("storyId");l.get("new")!=="true"&&(n&&(rn.current=null),x&&!n&&rn.current!==x.jobId&&(y.info("Returning during active generation, restoring progress for job:",x.jobId),rn.current=x.jobId,z(6),h(!0),Ut(x.storyTitle),Ia(x.jobId),Ee.getJobStatus(x.jobId).then(u=>{var B,p;if(y.info("Restored job status:",{progress:u.progress,hasStoryText:!!u.storyText,storyTextKeys:u.storyText?Object.keys(u.storyText):[],pageTextsCount:(B=u.storyText)!=null&&B.pageTexts?Object.keys(u.storyText.pageTexts).length:0,partialPages:((p=u.partialPages)==null?void 0:p.length)||0}),u.progress&&nr(w=>u.progress.current>=w.current?u.progress:{...w,message:u.progress.message}),u.storyText){const w=u.storyText.pageTexts||{};y.info("Setting progressiveStoryData with",Object.keys(w).length,"pages"),Ta({title:u.storyText.title||x.storyTitle,dedication:u.storyText.dedication,pageTexts:w,sceneDescriptions:u.storyText.sceneDescriptions||[],totalPages:u.storyText.totalPages||bt})}else y.warn("No storyText in job status response");if(u.partialPages&&u.partialPages.length>0){const w={};u.partialPages.forEach(D=>{D.pageNumber&&D.imageData&&(w[D.pageNumber]=D.imageData)}),y.info("Restored",Object.keys(w).length,"page images"),Ra(w)}u.partialCovers&&ir(w=>{var D,_,$;return{frontCover:((D=u.partialCovers)==null?void 0:D.frontCover)||w.frontCover,initialPage:((_=u.partialCovers)==null?void 0:_.initialPage)||w.initialPage,backCover:(($=u.partialCovers)==null?void 0:$.backCover)||w.backCover}})}).catch(u=>{y.error("Failed to restore job status:",u)})),y.debug("Auto-nav check:",{generationComplete:O,completedStoryId:xe,urlStoryId:n,hasActiveJob:!!x}),O&&xe&&!n&&(y.info("Generation completed, navigating to story:",xe),o({storyId:xe},{replace:!0})))},[x,O,xe,l,o,bt]),i.useEffect(()=>{if(l.get("new")==="true"){y.info("New story requested - resetting all story settings"),Xt(""),Ar(""),ns(""),$r(""),ur(""),ht("watercolor"),_t("standard"),ms(30),Ur(""),Ht(""),xt(null),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_custom_theme_text"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step");const v=new URLSearchParams(l);v.delete("new"),o(v,{replace:!0}),Fe(null),nt("photo"),z(1)}},[l,o]),i.useEffect(()=>{const n=l.get("storyId");n&&L!==6&&z(6),(async()=>{if(!(!n||!E)){if(en.current){en.current=!1,y.info("Skipping story reload - just finished generating");return}y.info("Loading saved story progressively:",n),W(!0),ee(null),Fr(null);try{await Ee.getStoryProgressively(n,(u,B)=>{var p,w,D,_;y.info("Metadata loaded:",u.title,`(${B} images to load)`),Za(u.id),Ut(u.title||""),Xt(u.storyType||""),ht(u.artStyle||"pixar"),Ls(u.outline||""),Gs(u.outlinePrompt||""),_s(u.outlineModelId),Hs(u.outlineUsage),Vs(u.storyTextPrompts||[]),hs(u.styledAvatarGeneration||[]),xs(u.costumedAvatarGeneration||[]),(p=u.generationLog)!=null&&p.length&&(console.log("[StoryWizard] Loading story metadata, generationLog:",((w=u.generationLog)==null?void 0:w.length)??0,"entries"),ps(u.generationLog)),u.visualBible?wr({mainCharacters:u.visualBible.mainCharacters||[],secondaryCharacters:u.visualBible.secondaryCharacters||[],animals:u.visualBible.animals||[],artifacts:u.visualBible.artifacts||[],locations:u.visualBible.locations||[],vehicles:u.visualBible.vehicles||[],clothing:u.visualBible.clothing||[],changeLog:u.visualBible.changeLog||[]}):wr(null),u.clothingRequirements?Yr(u.clothingRequirements):Yr(null),et(u.sceneImages||[]),Kt(u.sceneDescriptions||[]),ir(u.coverImages||{frontCover:null,initialPage:null,backCover:null}),_t(u.languageLevel||"standard"),u.language&&ua(u.language),h(!1),yn(u.isPartial||!1),vn(u.failureReason),jn(u.generatedPages),Nn(u.totalPages),Er(u.story||""),Os(u.originalStory||u.story||""),Xa({storyCategory:u.storyCategory,storyTopic:u.storyTopic,storyTheme:u.storyTheme,storyTypeName:u.storyTypeName,storyDetails:u.storyDetails,artStyle:u.artStyle,language:u.language,languageLevel:u.languageLevel,pages:u.pages,dedication:u.dedication,characters:(D=u.characters)==null?void 0:D.map($=>{var de;return{id:$.id,name:$.name,isMain:(de=u.mainCharacters)==null?void 0:de.includes($.id)}}),mainCharacters:u.mainCharacters,relationships:u.relationships,relationshipTexts:u.relationshipTexts,season:u.season,userLocation:u.userLocation}),(_=u.characters)!=null&&_.length&&xt(u.characters.map($=>{var de,X;return{id:$.id,name:$.name,photoData:$.photoData||((de=$.photos)==null?void 0:de.face)||((X=$.photos)==null?void 0:X.original)}})),z(6),W(!1),ee(null),B>0&&Fr({loaded:0,total:B}),Br.current=!0,Ee.getStoryDevMetadata(n).then($=>{Ea($),y.debug("Dev metadata merged into story")}).catch($=>{y.warn("Failed to load dev metadata:",$),Br.current=!1})},(u,B,p,w)=>{if(typeof u=="number")et(D=>D.map(_=>{if(_.pageNumber!==u)return _;const $=_.imageVersions||[],de=p==null?void 0:p.map((X,oe)=>({...$[oe]||{},...X}));return{..._,imageData:B,imageVersions:de||$}}));else{const D=u;ir(_=>{const $=_[D];return typeof $=="object"&&$!==null?{..._,[D]:{...$,imageData:B}}:{..._,[D]:B}})}w!==void 0&&Fr(D=>D?{...D,loaded:w}:null)},()=>{y.info("All images loaded"),Fr(null)})}catch(u){y.error("Failed to load story:",u),W(!1),ee(null),Fr(null)}}})()},[l,E,oi]),i.useEffect(()=>{L===6&&T&&(y.info("Clearing unviewed completion - user is viewing story"),ne())},[L,T,ne]),i.useEffect(()=>{(async()=>{const v=l.get("payment"),u=l.get("session_id");if(v==="success"&&u){y.info("Payment successful! Checking order status..."),y.info("Session ID:",u);try{const w=await Ee.getOrderStatus(u);if(y.info("Order Status:",w),w.order){const D=`CHF ${(w.order.amount_total/100).toFixed(2)}`,_={en:"Payment Successful!",de:"Zahlung erfolgreich!",fr:"Paiement rÃ©ussi!"},$={en:"Your book order has been received and will be printed soon.",de:"Ihre Buchbestellung wurde entgegengenommen und wird bald gedruckt.",fr:"Votre commande de livre a Ã©tÃ© reÃ§ue et sera bientÃ´t imprimÃ©e."},de=[`${s==="de"?"Kunde":s==="fr"?"Client":"Customer"}: ${w.order.customer_name}`,`Email: ${w.order.customer_email}`,`${s==="de"?"Betrag":s==="fr"?"Montant":"Amount"}: ${D}`,`${s==="de"?"Versand an":s==="fr"?"ExpÃ©diÃ© Ã ":"Shipping to"}: ${w.order.shipping_name}`,`${w.order.shipping_address_line1}`,`${w.order.shipping_postal_code} ${w.order.shipping_city}`,`${w.order.shipping_country}`];N($[s]||$.en,_[s]||_.en,de)}}catch(w){y.error("Error checking order status:",w)}const p=new URLSearchParams(l);p.delete("payment"),p.delete("session_id"),o(p,{replace:!0})}else if(v==="cancelled"){y.info("Payment cancelled by user");const p={en:"Payment was cancelled. You can try again when ready.",de:"Zahlung wurde abgebrochen. Sie kÃ¶nnen es erneut versuchen.",fr:"Paiement annulÃ©. Vous pouvez rÃ©essayer quand vous Ãªtes prÃªt."};k(p[s]||p.en,s==="de"?"Abgebrochen":s==="fr"?"AnnulÃ©":"Cancelled");const w=new URLSearchParams(l);w.delete("payment"),o(w,{replace:!0})}const B=l.get("credits_payment");if(B==="success"){y.info("Credits payment successful!"),await R();const p={en:"Credits Added!",de:"Credits hinzugefuegt!",fr:"Credits ajoutes!"},w={en:"100 credits have been added to your account.",de:"100 Credits wurden Ihrem Konto gutgeschrieben.",fr:"100 credits ont ete ajoutes a votre compte."};N(w[s]||w.en,p[s]||p.en);const D=new URLSearchParams(l);D.delete("credits_payment"),D.delete("session_id"),o(D,{replace:!0})}else if(B==="cancelled"){y.info("Credits payment cancelled by user");const p={en:"Credits purchase was cancelled.",de:"Kreditkauf wurde abgebrochen.",fr:"L'achat de credits a ete annule."};k(p[s]||p.en,s==="de"?"Abgebrochen":s==="fr"?"Annule":"Cancelled");const w=new URLSearchParams(l);w.delete("credits_payment"),o(w,{replace:!0})}})()},[l,o,s,N,k,R]);const Ba=i.useRef(!1);i.useEffect(()=>{if(l.get("autoGenerate")==="true"&&!Ba.current){Ba.current=!0;const v=localStorage.getItem("pending_story_type"),u=localStorage.getItem("pending_art_style");v&&(Xt(v),localStorage.removeItem("pending_story_type")),u&&(ht(u),localStorage.removeItem("pending_art_style")),z(6);const B=new URLSearchParams(l);B.delete("autoGenerate"),o(B,{replace:!0})}},[l,o]);const sn=n=>{if(n.length===0)return;const v=n.filter(u=>{const B=parseInt(u.age);return B>=1&&B<=10});if(v.length>0){const u=v.map(B=>B.id);Gt(u),y.info(`Auto-selected ${v.length} main character(s) aged 1-10`)}else{const u=n.reduce((B,p)=>{const w=parseInt(p.age)||999,D=parseInt(B.age)||999;return w<D?p:B});Gt([u.id]),y.info(`Auto-selected youngest character as main: ${u.name} (age ${u.age})`)}};i.useEffect(()=>{E?(async()=>{try{W(!0);const v=await Ge.getCharacterData(mr);if(y.info("Loaded character data from API:",{characters:v.characters.length,relationships:Object.keys(v.relationships).length}),ye(v.characters),Object.keys(v.relationships).length>0&&(Vr(v.relationships),fr.current=!0),Object.keys(v.relationshipTexts).length>0&&Rs(v.relationshipTexts),v.customRelationships.length>0&&ca(v.customRelationships),v.characters.some(B=>B.storyRole)){const B=[],p=[];for(const w of v.characters)w.storyRole==="main"?B.push(w.id):w.storyRole==="out"&&p.push(w.id);Gt(B),qr(p),y.info(`Loaded character roles from database: ${B.length} main, ${p.length} excluded`)}else v.characters.length>0&&sn(v.characters)}catch(v){y.error("Failed to load character data:",v)}finally{W(!1),ma(!0)}})():V||ma(!0)},[E,V]),i.useEffect(()=>{Q&&Ce&&!Br.current&&(Br.current=!0,y.info("Developer mode enabled, fetching dev metadata for story:",Ce),Ee.getStoryDevMetadata(Ce).then(n=>{Ea(n),y.debug("Dev metadata merged (triggered by dev mode toggle)")}).catch(n=>{y.warn("Failed to load dev metadata on toggle:",n),Br.current=!1})),(!Q||!Ce)&&(Br.current=!1)},[Q,Ce,Ea]),i.useEffect(()=>{mr&&E&&Wr&&(async()=>{try{y.info("Reloading characters with full avatars (dev mode)");const v=await Ge.getCharacterData(!0);ye(v.characters),y.info(`Loaded ${v.characters.length} characters with full avatars`)}catch(v){y.error("Failed to reload with full avatars:",v)}})()},[mr,E,Wr]),i.useEffect(()=>{L===1&&ke.length===0&&!C&&!F&&Wr&&nn()},[L,ke.length,C,F,Wr]);const an=i.useRef(mt);i.useEffect(()=>{an.current!==mt&&JSON.stringify(an.current)!==JSON.stringify(mt)&&(qt([]),Ht(""),an.current=mt)},[mt]),i.useEffect(()=>{localStorage.setItem("story_language_level",St)},[St]),i.useEffect(()=>{localStorage.setItem("story_language",Dt)},[Dt]),i.useEffect(()=>{localStorage.setItem("story_pages",bt.toString())},[bt]),i.useEffect(()=>{localStorage.setItem("story_dedication",br)},[br]),i.useEffect(()=>{localStorage.setItem("story_details",yr)},[yr]),i.useEffect(()=>{localStorage.setItem("story_type",Tt)},[Tt]),i.useEffect(()=>{De?localStorage.setItem("story_category",De):localStorage.removeItem("story_category")},[De]),i.useEffect(()=>{We?localStorage.setItem("story_topic",We):localStorage.removeItem("story_topic")},[We]),i.useEffect(()=>{qe?localStorage.setItem("story_theme",qe):localStorage.removeItem("story_theme")},[qe]),i.useEffect(()=>{Ye?localStorage.setItem("story_custom_theme_text",Ye):localStorage.removeItem("story_custom_theme_text")},[Ye]);const wn=i.useRef(De),Sn=i.useRef(We),Cn=i.useRef(qe),kn=i.useRef(!0);i.useEffect(()=>{if(kn.current){kn.current=!1;return}const n=wn.current!==De,v=Sn.current!==We,u=Cn.current!==qe;(n||v||u)&&(Ht(""),localStorage.removeItem("story_details"),qt([])),wn.current=De,Sn.current=We,Cn.current=qe},[De,We,qe]),i.useEffect(()=>{localStorage.setItem("story_art_style",wt)},[wt]);const Ks=i.useRef(!1);i.useEffect(()=>{if(L===4&&!Ks.current&&!Ft&&kt.length===0){const n=!!De,v=!!qe||!!We,u=ke.length>0;n&&v&&u&&(Ks.current=!0,y.info("[StoryWizard] Pre-generating story ideas while user selects art style"),$n())}Ks.current&&kt.length===0&&(Ks.current=!1)},[L,De,qe,We,ke.length,Ft,kt.length]);const Pn=i.useRef({storyCategory:De,storyTheme:qe,storyTopic:We});i.useEffect(()=>{const n=Pn.current,v=n.storyCategory!==De||n.storyTheme!==qe||n.storyTopic!==We;Pn.current={storyCategory:De,storyTheme:qe,storyTopic:We},v&&(Ft||kt.length>0)&&(y.info("[StoryWizard] Story inputs changed - aborting idea generation and clearing results"),tr.current&&(tr.current.abort(),tr.current=null),er(!1),Kr(!1),Ct(!1),qt([]),Jr(null),Dr(""),Ks.current=!1)},[De,qe,We,Ft,kt.length]),i.useEffect(()=>{if(!Ft)return;const v=setTimeout(()=>{y.warn("[StoryWizard] Safety timeout - resetting isGeneratingIdeas after 2.5 minutes"),er(!1),Kr(!1),Ct(!1),f(s==="de"?"ZeitÃ¼berschreitung bei der Ideengenerierung. Bitte versuchen Sie es erneut.":s==="fr"?"DÃ©lai d'attente de gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Idea generation timed out. Please try again.")},15e4);return()=>clearTimeout(v)},[Ft,s]),i.useEffect(()=>{if(!Fs&&!Vt){ga(0),Es(0);return}const n=35e3,v=80,u=100,B=Date.now(),p=setInterval(()=>{const w=Date.now()-B,D=Math.min(w/n,1),_=1-Math.pow(1-D,3),$=Math.round(_*v);Fs&&ga($),Vt&&Es($),D>=1&&clearInterval(p)},u);return()=>clearInterval(p)},[Fs,Vt]),i.useEffect(()=>{L>=1&&L<=5&&localStorage.setItem("wizard_step",L.toString())},[L]);const xi=n=>{Ar(n)},pi=n=>{$r(n),!(n==="custom"||n==="realistic"||n==="")&&(De==="adventure"||(De==="life-challenge"||De==="educational")&&We!=="")&&Sr(4)},fi=n=>{ns(n),De==="historical"&&n!==""&&Sr(4)},bi=n=>{ht(n),Sr(5)};i.useEffect(()=>{if(L===2&&ke.length>=2&&!F){const n=ke.map(v=>v.id).sort().join("-");if(!Ds.current||Ds.current!==n){const u=qo(s);y.debug("Initializing relationships for step 2",{charKey:n,existingCount:Object.keys(ft).length}),Vr(B=>{const p={...B};let w=!1;return ke.forEach((D,_)=>{ke.forEach(($,de)=>{if(_!==de){const X=`${D.id}-${$.id}`;p[X]||(p[X]=u,w=!0,y.debug("Initializing missing relationship:",X))}})}),w?p:B}),Ds.current=n}}},[L,ke,s,F]);const yi=()=>{if(ke.length<2)return!0;for(let n=0;n<ke.length;n++)for(let v=0;v<ke.length;v++)if(n!==v){const u=`${ke[n].id}-${ke[v].id}`,B=ft[u];if(!B||Un(B))return!1}return!0},vi=()=>{if(ke.length<2)return null;let n=0,v=null;for(const u of ke){let B=0;for(const p of ke)if(u.id!==p.id){const w=`${u.id}-${p.id}`,D=ft[w];(!D||Un(D))&&B++}B>n&&(n=B,v=u)}return v},nn=()=>{Fe({id:Date.now(),name:"",gender:void 0,age:"",traits:{strengths:[],flaws:[],challenges:[]}}),nt("photo"),ot(!1)},ji=(n,v=1500)=>new Promise(u=>{const B=new Image;B.onload=()=>{const p=document.createElement("canvas");let{width:w,height:D}=B;(w>v||D>v)&&(w>D?(D=Math.round(D*v/w),w=v):(w=Math.round(w*v/D),D=v)),p.width=w,p.height=D;const _=p.getContext("2d");_==null||_.drawImage(B,0,0,w,D),u(p.toDataURL("image/jpeg",.85))},B.onerror=()=>u(n),B.src=n}),Ni=async(n,v)=>{var p,w,D,_,$;if(y.info(`ðŸ“¸ handlePhotoSelect called: file=${n==null?void 0:n.name}, character=${C==null?void 0:C.name}, developerMode=${Q}`),C&&!Q){const de=!!((p=C.avatars)!=null&&p.winter||(w=C.avatars)!=null&&w.standard||(D=C.avatars)!=null&&D.summer||(_=C.avatars)!=null&&_.hasFullAvatars);if(y.info(`ðŸ“¸ hasAvatars=${de}`),de){const X=Ka(C.id);if(y.info(`ðŸ“¸ cooldown check: canRegenerate=${X.canRegenerate}, waitSeconds=${X.waitSeconds}`),!X.canRegenerate){const oe=s==="de"?`Bitte warten Sie ${X.waitSeconds} Sekunden, bevor Sie ein neues Foto hochladen.`:`Please wait ${X.waitSeconds} seconds before uploading a new photo.`;f(oe);return}ii(C.id)}}const u=v&&(($=C==null?void 0:C.clothing)!=null&&$.structured)?{...C.clothing.structured}:null,B=new FileReader;B.onload=async de=>{var oe,fe,Ie,Qe,tt,ce,Ve,ue,Y,U,se,J;const X=(oe=de.target)==null?void 0:oe.result;C&&(da.current={physical:C.physical,gender:C.gender,age:C.age}),As(void 0),hr(!0),!(C!=null&&C.name)||C.name.trim().length<2?nt("name"):(nt("traits"),y.info("ðŸ“¸ Character has name, going to traits step to show avatar regeneration"));try{const be=await ji(X),Oe=Math.round(X.length/1024),ae=Math.round(be.length/1024);y.info(`Starting photo analysis... (${Oe}KB -> ${ae}KB)`);const ze=C!=null&&C.id&&C.id>0?C.id:void 0,we=await Ge.analyzePhoto(be,s,void 0,void 0,ze);if(we.success){if(we.multipleFacesDetected&&we.faces&&we.faces.length>1){y.info(`Multiple faces detected (${we.faces.length}), showing selection modal`),ds(be),Hr(u?{structured:u}:null),Is(we.faces),pr(!0),hr(!1);return}y.info("Photo analysis complete:",{hasPhotos:!!we.photos,hasPhysical:!!we.physical,hasClothing:!!we.clothing,age:we.age,gender:we.gender}),we._debug&&($s(we._debug),we._debug.rawResponse,we._debug.error&&console.warn("ðŸ“¸ [DEBUG] Gemini error:",we._debug.error));const Ue={original:((fe=we.photos)==null?void 0:fe.face)||X,face:(Ie=we.photos)==null?void 0:Ie.face,body:((Qe=we.photos)==null?void 0:Qe.body)||X,bodyNoBg:(tt=we.photos)==null?void 0:tt.bodyNoBg,faceBox:(ce=we.photos)==null?void 0:ce.faceBox,bodyBox:(Ve=we.photos)==null?void 0:Ve.bodyBox},lt=(ue=we.photos)!=null&&ue.bodyNoBg?Math.round(we.photos.bodyNoBg.length/1024):0,ut=(Y=we.photos)!=null&&Y.body?Math.round(we.photos.body.length/1024):0,za=(U=we.photos)!=null&&U.face?Math.round(we.photos.face.length/1024):0;if(y.info(`ðŸ“¸ [PHOTO CHANGE] Analysis returned: bodyNoBg=${lt}KB, body=${ut}KB, face=${za}KB`),(se=we.photos)!=null&&se.bodyNoBg){const Le=we.photos.bodyNoBg.substring(we.photos.bodyNoBg.indexOf("base64,")+7,we.photos.bodyNoBg.indexOf("base64,")+27);y.info(`ðŸ“¸ [PHOTO CHANGE] bodyNoBg fingerprint: ${Le}...`)}let Jt,Ma;u?(Jt={structured:u},Ma={upperBody:u.upperBody?"user":void 0,lowerBody:u.lowerBody?"user":void 0,shoes:u.shoes?"user":void 0,fullBody:u.fullBody?"user":void 0},y.info(`ðŸ‘• Keeping old clothing (marked as user-edited): ${JSON.stringify(u)}`)):y.info("ðŸ‘• Using new photo's clothing (cleared existing)");const Oa=we.characterId,ln=(C==null?void 0:C.id)&&C.id>0,bs=ln?C.id:Oa;ln?y.info(`ðŸ“¸ [PHOTO] Keeping existing character ID: ${C.id} (server created new ID ${Oa} but ignoring)`):Oa&&y.info(`ðŸ“¸ [PHOTO] Using server-created character ID: ${Oa}`);const Et=C?{...C,id:bs||C.id,photos:Ue,avatars:{status:"generating"},clothing:Jt,clothingSource:Ma}:null;if(Et){const Le=(J=Et.photos)==null?void 0:J.bodyNoBg,Nt=Le?Math.round(Le.length/1024):0;if(y.info(`ðŸ“¸ [CHAR FOR GEN] bodyNoBg=${Nt}KB, has photos: ${!!Et.photos}`),Le){const He=Le.substring(Le.indexOf("base64,")+7,Le.indexOf("base64,")+27);y.info(`ðŸ“¸ [CHAR FOR GEN] fingerprint: ${He}...`)}}if(Fe(Le=>{var He;if(!Le)return null;const Nt=(He=Le.avatars)!=null&&He.standard?{...Le.avatars,status:"generating",stale:!0}:{status:"generating"};return{...Le,id:bs||Le.id,photos:Ue,avatars:Nt,clothing:Jt,clothingSource:Ma}}),bs&&!ln&&ye(Le=>{if(!Le.some(He=>He.id===bs)){const He={...C,id:bs,photos:Ue,avatars:{status:"generating"},clothing:Jt,clothingSource:Ma};return y.info(`ðŸ“¸ Adding new character ${bs} to array to prevent data loss`),[...Le,He]}return Le}),y.info("ðŸŽ¨ Auto-starting avatar generation in background..."),y.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Ue.bodyNoBg}, body=${!!Ue.body}, face=${!!Ue.face}`),Et&&Et.id&&Et.name&&Et.name.trim()){const Le=Et.id;pt(Le),Ge.generateAndSaveAvatarForCharacter(Et,void 0,{avatarModel:at.avatarModel||void 0}).then(Nt=>{Nt.success&&Nt.character?(Fe(He=>!He||He.id!==Le?He:{...He,avatars:Nt.character.avatars,physical:Nt.character.physical,clothing:Nt.character.clothing}),ye(He=>He.map(Bt=>Bt.id===Le?{...Bt,...Nt.character,id:Bt.id}:Bt)),y.success(`âœ… Avatar generated and traits extracted for ${Et.name}`)):(y.error(`âŒ Avatar generation failed: ${Nt.error}`),Fe(He=>He&&He.id===Le?{...He,avatars:{status:"failed"}}:He),ye(He=>He.map(Bt=>Bt.id===Le?{...Bt,avatars:{status:"failed"}}:Bt)))}).catch(Nt=>{y.error("âŒ Avatar generation error:",Nt),Fe(He=>He&&He.id===Le?{...He,avatars:{status:"failed"}}:He),ye(He=>He.map(Bt=>Bt.id===Le?{...Bt,avatars:{status:"failed"}}:Bt))}).finally(()=>{pt(null)})}else Et&&Et.id?(y.info("â­ï¸ Skipping auto-generation: character has no name yet"),pt(null),Fe(Le=>Le&&{...Le,avatars:{status:"pending"}})):(y.warn("â­ï¸ Skipping auto-generation: no character data available"),pt(null))}else we.error==="no_face_detected"?(y.warn("No face detected in photo"),f(c.noFaceDetected)):(y.warn("Photo analysis returned no data, using original photo"),Fe(Ue=>Ue?{...Ue,photos:{original:X},avatars:void 0}:null))}catch(be){y.error("Photo analysis error:",be),Fe(Oe=>Oe?{...Oe,photos:{original:X},avatars:void 0}:null)}finally{hr(!1)}},B.readAsDataURL(n)},wi=async n=>{var v,u,B,p,w,D,_,$;if(!_r){y.error("No pending photo data for face selection");return}pr(!1),hr(!0);try{y.info(`Re-analyzing photo with selected face ID: ${n}`);const de=ls.map(fe=>({id:fe.id,x:fe.faceBox.x,y:fe.faceBox.y,width:fe.faceBox.width,height:fe.faceBox.height,confidence:fe.confidence})),X=C!=null&&C.id&&C.id>0?C.id:void 0,oe=await Ge.analyzePhoto(_r,s,n,de,X);if(oe.success){y.info("Photo analysis complete with selected face:",{hasPhotos:!!oe.photos,hasPhysical:!!oe.physical,hasClothing:!!oe.clothing,age:oe.age,gender:oe.gender}),oe._debug&&$s(oe._debug);const fe=Ts==null?void 0:Ts.structured,Ie={original:((v=oe.photos)==null?void 0:v.face)||_r,face:(u=oe.photos)==null?void 0:u.face,body:((B=oe.photos)==null?void 0:B.body)||_r,bodyNoBg:(p=oe.photos)==null?void 0:p.bodyNoBg,faceBox:(w=oe.photos)==null?void 0:w.faceBox,bodyBox:(D=oe.photos)==null?void 0:D.bodyBox},Qe=(_=oe.photos)!=null&&_.bodyNoBg?Math.round(oe.photos.bodyNoBg.length/1024):0;if(y.info(`ðŸ“¸ [FACE SELECT] Analysis returned: bodyNoBg=${Qe}KB`),($=oe.photos)!=null&&$.bodyNoBg){const se=oe.photos.bodyNoBg.substring(oe.photos.bodyNoBg.indexOf("base64,")+7,oe.photos.bodyNoBg.indexOf("base64,")+27);y.info(`ðŸ“¸ [FACE SELECT] bodyNoBg fingerprint: ${se}...`)}let tt,ce;fe&&(tt={structured:fe},ce={upperBody:fe.upperBody?"user":void 0,lowerBody:fe.lowerBody?"user":void 0,shoes:fe.shoes?"user":void 0,fullBody:fe.fullBody?"user":void 0});const Ve=oe.characterId,ue=(C==null?void 0:C.id)&&C.id>0,Y=ue?C.id:Ve;ue?y.info(`ðŸ“¸ [FACE SELECT] Keeping existing character ID: ${C.id} (server created new ID ${Ve} but ignoring)`):Ve&&y.info(`ðŸ“¸ [FACE SELECT] Using server-created character ID: ${Ve}`);const U=C?{...C,id:Y||C.id,photos:Ie,avatars:{status:"generating"},clothing:tt,clothingSource:ce}:null;if(Fe(se=>{var be;if(!se)return null;const J=(be=se.avatars)!=null&&be.standard?{...se.avatars,status:"generating",stale:!0}:{status:"generating"};return{...se,id:Y||se.id,photos:Ie,avatars:J,clothing:tt,clothingSource:ce}}),Y&&!ue&&ye(se=>{if(!se.some(be=>be.id===Y)){const be={...C,id:Y,photos:Ie,avatars:{status:"generating"},clothing:tt,clothingSource:ce};return y.info(`ðŸ“¸ [FACE SELECT] Adding new character ${Y} to array to prevent data loss`),[...se,be]}return se}),C!=null&&C.name&&C.name.trim().length>=2?(nt("traits"),y.info("ðŸ“¸ Face selected, character has name, going to traits step")):nt("name"),y.info("ðŸŽ¨ Auto-starting avatar generation in background after face selection..."),y.info(`ðŸ“¸ Photo for avatar: bodyNoBg=${!!Ie.bodyNoBg}, body=${!!Ie.body}, face=${!!Ie.face}`),U&&U.name&&U.name.trim()){const se=U.id;pt(se),Ge.generateAndSaveAvatarForCharacter(U,void 0,{avatarModel:at.avatarModel||void 0}).then(J=>{J.success&&J.character?(Fe(be=>!be||be.id!==se?be:{...be,avatars:J.character.avatars,physical:J.character.physical,clothing:J.character.clothing}),ye(be=>be.map(Oe=>Oe.id===se?{...Oe,...J.character,id:Oe.id}:Oe)),y.success(`âœ… Avatar generated for ${U.name} (face selection)`)):(y.error(`âŒ Avatar generation failed: ${J.error}`),Fe(be=>be&&be.id===se?{...be,avatars:{status:"failed"}}:be),ye(be=>be.map(Oe=>Oe.id===se?{...Oe,avatars:{status:"failed"}}:Oe)))}).catch(J=>{y.error("âŒ Avatar generation error:",J),Fe(be=>be&&be.id===se?{...be,avatars:{status:"failed"}}:be),ye(be=>be.map(Oe=>Oe.id===se?{...Oe,avatars:{status:"failed"}}:Oe))}).finally(()=>{pt(null)})}else y.info("â­ï¸ Skipping auto-generation: character has no name yet"),pt(null),Fe(se=>se&&{...se,avatars:{status:"pending"}})}else y.warn("Photo analysis failed after face selection"),f(c.noFaceDetected)}catch(de){y.error("Photo analysis error after face selection:",de),f("Failed to analyze photo. Please try again.")}finally{hr(!1),ds(null),Hr(null),Is([])}},Si=()=>{pr(!1),ds(null),Hr(null),Is([]),nt("photo")},Ci=async()=>{if(C){Fe(n=>n&&{...n,avatars:void 0}),xr(!0);try{y.info(`ðŸ”„ Regenerating avatars for ${C.name}...`);const n=await Ge.regenerateAvatarsForCharacter(C.id,(v,u)=>y.info(`[${v}] ${u}`),{avatarModel:at.avatarModel||void 0});if(n.success&&n.character){const v={...n.character.avatars,stale:!1};Fe(u=>u&&{...u,avatars:v,physical:n.character.physical,clothing:n.character.clothing}),ye(u=>u.map(B=>B.id===C.id?{...B,avatars:v,physical:n.character.physical,clothing:n.character.clothing}:B)),y.success(`âœ… Avatars and traits regenerated for ${C.name}`)}else y.error(`âŒ Failed to regenerate avatars: ${n.error}`),f(`Failed to regenerate avatars: ${n.error||"Unknown error"}`)}catch(n){y.error(`âŒ Failed to regenerate avatars for ${C.name}:`,n),f(`Failed to regenerate avatars: ${n instanceof Error?n.message:"Unknown error"}`)}finally{xr(!1)}}},ki=async()=>{var n,v,u,B,p,w,D,_,$,de,X,oe,fe,Ie,Qe,tt;if(C){Fe(ce=>ce&&{...ce,avatars:void 0}),Ot(!0);try{y.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${C.name}...`),y.info(`Physical traits: ${JSON.stringify(C.physical)}`);const ce=await Ge.generateClothingAvatarsWithTraits(C);if(ce.success&&ce.avatars){const Ve={...ce.avatars,stale:!1,generatedAt:new Date().toISOString()},ue=C.physicalTraitsSource||{},Y=ce.extractedTraits?{height:(n=C.physical)==null?void 0:n.height,eyeColor:ue.eyeColor==="user"?(v=C.physical)==null?void 0:v.eyeColor:ce.extractedTraits.eyeColor,eyeColorHex:ue.eyeColor==="user"?(u=C.physical)==null?void 0:u.eyeColorHex:ce.extractedTraits.eyeColorHex,hairColor:ue.hairColor==="user"?(B=C.physical)==null?void 0:B.hairColor:ce.extractedTraits.hairColor,hairColorHex:ue.hairColor==="user"?(p=C.physical)==null?void 0:p.hairColorHex:ce.extractedTraits.hairColorHex,hairLength:ue.hairLength==="user"?(w=C.physical)==null?void 0:w.hairLength:ce.extractedTraits.hairLength,hairStyle:ue.hairStyle==="user"?(D=C.physical)==null?void 0:D.hairStyle:ce.extractedTraits.hairStyle,build:ue.build==="user"?(_=C.physical)==null?void 0:_.build:ce.extractedTraits.build,face:ue.face==="user"?($=C.physical)==null?void 0:$.face:ce.extractedTraits.face,facialHair:ue.facialHair==="user"?(de=C.physical)==null?void 0:de.facialHair:ce.extractedTraits.facialHair,other:ue.other==="user"?(X=C.physical)==null?void 0:X.other:ce.extractedTraits.other,skinTone:ue.skinTone==="user"?(oe=C.physical)==null?void 0:oe.skinTone:ce.extractedTraits.skinTone,skinToneHex:ue.skinTone==="user"?(fe=C.physical)==null?void 0:fe.skinToneHex:ce.extractedTraits.skinToneHex,detailedHairAnalysis:ce.extractedTraits.detailedHairAnalysis||((Ie=C.physical)==null?void 0:Ie.detailedHairAnalysis),apparentAge:ue.apparentAge==="user"?(Qe=C.physical)==null?void 0:Qe.apparentAge:ce.extractedTraits.apparentAge||((tt=C.physical)==null?void 0:tt.apparentAge)}:C.physical,U=ce.extractedTraits?{eyeColor:ue.eyeColor==="user"?"user":ce.extractedTraits.eyeColor?"extracted":void 0,hairColor:ue.hairColor==="user"?"user":ce.extractedTraits.hairColor?"extracted":void 0,hairLength:ue.hairLength==="user"?"user":ce.extractedTraits.hairLength?"extracted":void 0,hairStyle:ue.hairStyle==="user"?"user":ce.extractedTraits.hairStyle?"extracted":void 0,build:ue.build==="user"?"user":ce.extractedTraits.build?"extracted":void 0,face:ue.face==="user"?"user":ce.extractedTraits.face?"extracted":void 0,facialHair:ue.facialHair==="user"?"user":ce.extractedTraits.facialHair?"extracted":void 0,other:ue.other==="user"?"user":ce.extractedTraits.other?"extracted":void 0,skinTone:ue.skinTone==="user"?"user":ce.extractedTraits.skinTone?"extracted":void 0,apparentAge:ue.apparentAge==="user"?"user":ce.extractedTraits.apparentAge?"extracted":void 0}:C.physicalTraitsSource,se=ce.extractedClothing?{...C.clothing,structured:{upperBody:ce.extractedClothing.upperBody||void 0,lowerBody:ce.extractedClothing.lowerBody||void 0,shoes:ce.extractedClothing.shoes||void 0,fullBody:ce.extractedClothing.fullBody||void 0}}:C.clothing;Fe(J=>J&&{...J,avatars:Ve,physical:Y,physicalTraitsSource:U,clothing:se}),ye(J=>J.map(be=>be.id===C.id?{...be,avatars:Ve,physical:Y,physicalTraitsSource:U,clothing:se}:be)),y.success(`âœ… Avatars WITH TRAITS regenerated for ${C.name}`),ce.extractedTraits&&y.info(`ðŸ“‹ Extracted traits saved: ${JSON.stringify(ce.extractedTraits)}`),ce.extractedClothing&&y.info(`ðŸ‘• Extracted clothing saved: ${JSON.stringify(ce.extractedClothing)}`)}else y.error(`âŒ Failed to regenerate avatars with traits: ${ce.error}`),f(`Failed to regenerate avatars: ${ce.error||"Unknown error"}`)}catch(ce){y.error(`âŒ Failed to regenerate avatars with traits for ${C.name}:`,ce),f(`Failed to regenerate avatars: ${ce instanceof Error?ce.message:"Unknown error"}`)}finally{Ot(!1)}}},Pi=async()=>{var u,B,p,w,D,_,$,de,X,oe,fe,Ie,Qe,tt,ce,Ve;if(!C)return;const n={...C},v=C.id;Ot(!0);try{y.info(`ðŸ’¾ Saving character and regenerating avatars for ${n.name}...`),await on(),y.info(`ðŸ”„ Regenerating avatars WITH TRAITS for ${n.name}...`);const Y=(await new Promise(se=>{ye(J=>(se(J),J))})).find(se=>se.id===v);if(!Y){y.warn("Character not found in characters array after save");return}const U=await Ge.generateClothingAvatarsWithTraits(Y);if(U.success&&U.avatars){const se={...U.avatars,stale:!1,generatedAt:new Date().toISOString()},J=Y.physicalTraitsSource||{},be=U.extractedTraits?{height:(u=Y.physical)==null?void 0:u.height,eyeColor:J.eyeColor==="user"?(B=Y.physical)==null?void 0:B.eyeColor:U.extractedTraits.eyeColor,eyeColorHex:J.eyeColor==="user"?(p=Y.physical)==null?void 0:p.eyeColorHex:U.extractedTraits.eyeColorHex,hairColor:J.hairColor==="user"?(w=Y.physical)==null?void 0:w.hairColor:U.extractedTraits.hairColor,hairColorHex:J.hairColor==="user"?(D=Y.physical)==null?void 0:D.hairColorHex:U.extractedTraits.hairColorHex,hairLength:J.hairLength==="user"?(_=Y.physical)==null?void 0:_.hairLength:U.extractedTraits.hairLength,hairStyle:J.hairStyle==="user"?($=Y.physical)==null?void 0:$.hairStyle:U.extractedTraits.hairStyle,build:J.build==="user"?(de=Y.physical)==null?void 0:de.build:U.extractedTraits.build,face:J.face==="user"?(X=Y.physical)==null?void 0:X.face:U.extractedTraits.face,facialHair:J.facialHair==="user"?(oe=Y.physical)==null?void 0:oe.facialHair:U.extractedTraits.facialHair,other:J.other==="user"?(fe=Y.physical)==null?void 0:fe.other:U.extractedTraits.other,skinTone:J.skinTone==="user"?(Ie=Y.physical)==null?void 0:Ie.skinTone:U.extractedTraits.skinTone,skinToneHex:J.skinTone==="user"?(Qe=Y.physical)==null?void 0:Qe.skinToneHex:U.extractedTraits.skinToneHex,detailedHairAnalysis:U.extractedTraits.detailedHairAnalysis||((tt=Y.physical)==null?void 0:tt.detailedHairAnalysis),apparentAge:J.apparentAge==="user"?(ce=Y.physical)==null?void 0:ce.apparentAge:U.extractedTraits.apparentAge||((Ve=Y.physical)==null?void 0:Ve.apparentAge)}:Y.physical,Oe=U.extractedTraits?{eyeColor:J.eyeColor==="user"?"user":U.extractedTraits.eyeColor?"extracted":void 0,hairColor:J.hairColor==="user"?"user":U.extractedTraits.hairColor?"extracted":void 0,hairLength:J.hairLength==="user"?"user":U.extractedTraits.hairLength?"extracted":void 0,hairStyle:J.hairStyle==="user"?"user":U.extractedTraits.hairStyle?"extracted":void 0,build:J.build==="user"?"user":U.extractedTraits.build?"extracted":void 0,face:J.face==="user"?"user":U.extractedTraits.face?"extracted":void 0,facialHair:J.facialHair==="user"?"user":U.extractedTraits.facialHair?"extracted":void 0,other:J.other==="user"?"user":U.extractedTraits.other?"extracted":void 0,skinTone:J.skinTone==="user"?"user":U.extractedTraits.skinTone?"extracted":void 0,apparentAge:J.apparentAge==="user"?"user":U.extractedTraits.apparentAge?"extracted":void 0}:Y.physicalTraitsSource,ae=U.extractedClothing?{...Y.clothing,structured:{upperBody:U.extractedClothing.upperBody||void 0,lowerBody:U.extractedClothing.lowerBody||void 0,shoes:U.extractedClothing.shoes||void 0,fullBody:U.extractedClothing.fullBody||void 0}}:Y.clothing;Fe(lt=>lt&&lt.id===v?{...lt,avatars:se,physical:be,physicalTraitsSource:Oe,clothing:ae}:lt),ye(lt=>lt.map(ut=>ut.id===v?{...ut,avatars:se,physical:be,physicalTraitsSource:Oe,clothing:ae}:ut)),y.success(`âœ… Avatars regenerated for ${Y.name}`);const ze={...Y,avatars:se,physical:be,physicalTraitsSource:Oe,clothing:ae},Ue=(await new Promise(lt=>{ye(ut=>(lt(ut),ut))})).map(lt=>lt.id===v?ze:lt);await Ge.saveCharacterData({characters:Ue,relationships:ft,relationshipTexts:Rt,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]}),y.success("ðŸ’¾ Character saved with new avatars, traits, and clothing"),N(s==="de"?"Charakter gespeichert und Avatar regeneriert":"Character saved and avatar regenerated")}else y.error(`âŒ Failed to regenerate avatars: ${U.error}`),f(`Failed to regenerate avatars: ${U.error||"Unknown error"}`)}catch(ue){y.error("âŒ Failed to save and regenerate:",ue),f(`Failed: ${ue instanceof Error?ue.message:"Unknown error"}`)}finally{Ot(!1)}},Ai=async()=>{var B,p,w,D,_,$,de,X,oe,fe,Ie,Qe,tt,ce,Ve,ue,Y,U;if(!C)return;const n=C.id;As(void 0),nt("traits");const v=(B=C.avatars)==null?void 0:B.status,u=!!((p=C.avatars)!=null&&p.standard||(w=C.avatars)!=null&&w.winter||(D=C.avatars)!=null&&D.summer||(_=C.avatars)!=null&&_.hasFullAvatars);if(v==="generating"||v==="complete"&&u){y.info(`â­ï¸ Skipping avatar generation - already ${v}${u?" with avatars":""}`);return}pt(n),Fe(se=>se&&se.id===n?{...se,avatars:{status:"generating"}}:se),y.info(`ðŸŽ¨ Starting avatar generation for ${C.name||"unnamed"} (id: ${n})...`);try{const se=await Ge.generateClothingAvatarsWithTraits(C);if(se.success&&se.avatars){const J={...se.avatars,stale:!1,generatedAt:new Date().toISOString()},be=se.extractedTraits?{...C.physical,build:se.extractedTraits.build||(($=C.physical)==null?void 0:$.build),eyeColor:se.extractedTraits.eyeColor||((de=C.physical)==null?void 0:de.eyeColor),eyeColorHex:se.extractedTraits.eyeColorHex||((X=C.physical)==null?void 0:X.eyeColorHex),hairColor:se.extractedTraits.hairColor||((oe=C.physical)==null?void 0:oe.hairColor),hairColorHex:se.extractedTraits.hairColorHex||((fe=C.physical)==null?void 0:fe.hairColorHex),hairLength:se.extractedTraits.hairLength||((Ie=C.physical)==null?void 0:Ie.hairLength),hairStyle:se.extractedTraits.hairStyle||((Qe=C.physical)==null?void 0:Qe.hairStyle),facialHair:se.extractedTraits.facialHair||((tt=C.physical)==null?void 0:tt.facialHair),skinTone:se.extractedTraits.skinTone||((ce=C.physical)==null?void 0:ce.skinTone),skinToneHex:se.extractedTraits.skinToneHex||((Ve=C.physical)==null?void 0:Ve.skinToneHex),face:se.extractedTraits.face||((ue=C.physical)==null?void 0:ue.face),other:se.extractedTraits.other||((Y=C.physical)==null?void 0:Y.other),detailedHairAnalysis:se.extractedTraits.detailedHairAnalysis||((U=C.physical)==null?void 0:U.detailedHairAnalysis)}:C.physical,Oe=se.extractedClothing?{...C.clothing,structured:{upperBody:se.extractedClothing.upperBody||void 0,lowerBody:se.extractedClothing.lowerBody||void 0,shoes:se.extractedClothing.shoes||void 0,fullBody:se.extractedClothing.fullBody||void 0}}:C.clothing;ye(ae=>ae.map(ze=>ze.id===n?{...ze,avatars:J,physical:be,clothing:Oe}:ze)),Fe(ae=>ae&&ae.id===n?{...ae,avatars:J,physical:be,clothing:Oe}:ae),y.success(`âœ… Avatar generated for ${C.name} (id: ${n})`)}else y.error(`âŒ Failed to generate avatar: ${se.error}`),f(`Failed to generate avatar: ${se.error||"Unknown error"}`),ye(J=>J.map(be=>be.id===n?{...be,avatars:{status:"failed"}}:be)),Fe(J=>J&&J.id===n?{...J,avatars:{status:"failed"}}:J)}catch(se){y.error("âŒ Avatar generation failed:",se),f(`Avatar generation failed: ${se instanceof Error?se.message:"Unknown error"}`),ye(J=>J.map(be=>be.id===n?{...be,avatars:{status:"failed"}}:be)),Fe(J=>J&&J.id===n?{...J,avatars:{status:"failed"}}:J)}finally{pt(null)}},on=async()=>{var n;if(C){W(!0);try{const v=Ir.current,u=ks.current;if(!v){y.warn("No current character to save");return}const B=v.id&&u.find(_=>_.id===v.id),p=B?u.map(_=>_.id===v.id?v:_):[...u,v];y.info("Saving characters with relationships:",p.length);const w=!B&&!!((n=v.photos)!=null&&n.original);await Ge.saveCharacterData({characters:p,relationships:ft,relationshipTexts:Rt,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:w}),Rr.current=!1,y.success("Character data saved successfully"),ye(p),sn(p);const D=p.find(_=>_.id===C.id);D&&Ge.needsAvatars(D)&&Xe!==D.id&&(y.info(`ðŸŽ¨ Starting background avatar generation for ${D.name}...`),Ge.generateAndSaveAvatarForCharacter(D,void 0,{avatarModel:at.avatarModel||void 0}).then(_=>{_.success&&_.character?(ye($=>$.map(de=>de.id===D.id?{...de,avatars:_.character.avatars,physical:_.character.physical,clothing:_.character.clothing}:de)),y.success(`âœ… Avatars and traits saved for ${D.name}`)):_.skipped||(y.warn(`Avatar generation failed for ${D.name}: ${_.error}`),ye($=>$.map(de=>de.id===D.id?{...de,avatars:{status:"failed"}}:de)))}).catch(_=>{y.error(`âŒ Background avatar generation error for ${D.name}:`,_),ye($=>$.map(de=>de.id===D.id?{...de,avatars:{status:"failed"}}:de))})),Fe(null),ot(!0)}catch(v){y.error("Failed to save character:",v),f(s==="de"?"Charakter konnte nicht gespeichert werden. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de l'enregistrement du personnage. Veuillez rÃ©essayer.":"Failed to save character. Please try again.")}finally{W(!1)}}},$i=async n=>{Fe({...n}),nt("traits"),ot(!1);const v=await Ge.loadFullCharacter(n.id);v&&(Fe(u=>u&&u.id===n.id?{...u,...v}:u),ye(u=>u.map(B=>B.id===n.id?{...B,...v}:B)))},Ii=async n=>{try{const v=await Ge.deleteCharacter(n);v.success?(ye(u=>u.filter(B=>B.id!==n)),Vr(u=>{const B={...u};return Object.keys(B).forEach(p=>{(p.includes(`${n}-`)||p.includes(`-${n}`))&&delete B[p]}),B}),Rs(u=>{const B={...u};return Object.keys(B).forEach(p=>{(p.includes(`${n}-`)||p.includes(`-${n}`))&&delete B[p]}),B}),Gt(u=>u.filter(B=>B!==n)),cs.current=!0,y.success(`Character ${n} deleted`)):(y.error("Failed to delete character:",v.error),f(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character"))}catch(v){y.error("Failed to delete character:",v),f(s==="de"?"Charakter konnte nicht gelÃ¶scht werden":"Failed to delete character")}},Ti=(n,v,u)=>{const p=Uo(u,s),w=`${n}-${v}`,D=`${v}-${n}`;y.debug("Updating relationship:",w,"=",u,", inverse:",D,"=",p),Rr.current=!0,Vr(_=>({..._,[w]:u,[D]:p}))},Ri=(n,v)=>{Rr.current=!0;const[u,B]=n.split("-").map(Number),p=`${B}-${u}`;Rs(w=>({...w,[n]:v,[p]:v}))},Di=(n,v)=>{Rr.current=!0,ca(u=>[...u,{forward:n,inverse:v}])},Fi=(n,v)=>{v==="out"?(qr(u=>u.includes(n)?u:[...u,n]),Gt(u=>u.filter(B=>B!==n))):v==="in"?(qr(u=>u.filter(B=>B!==n)),Gt(u=>u.filter(B=>B!==n))):v==="main"&&(qr(u=>u.filter(B=>B!==n)),Gt(u=>u.includes(n)?u:[...u,n])),cs.current=!0,ye(u=>u.map(B=>B.id===n?{...B,storyRole:v}:B))},Ei=async()=>{const[n,v,u]=await Promise.all([new Promise(p=>{ye(w=>(p(w),w))}),new Promise(p=>{Gt(w=>(p(w),w))}),new Promise(p=>{qr(w=>(p(w),w))})]);if(n.length===0)return;if(!cs.current){y.debug("Roles not modified, skipping save");return}const B={};for(const p of n)v.includes(p.id)?B[p.id]="main":u.includes(p.id)?B[p.id]="out":B[p.id]="in";try{await Ge.saveCharacterRoles(B),cs.current=!1}catch(p){y.error("Failed to save character roles:",p)}},Js=i.useRef(null),Sr=async n=>{n>=0&&n<=7&&(L===1&&C&&n!==1&&await on(),L===1&&n!==1&&(Js.current=(async()=>{await zi(),await Ei()})(),Js.current.catch(v=>y.error("Background save failed:",v))),n===1&&L!==1&&Fe(null),z(n),window.scrollTo(0,0))},Bi=n=>n===1?!0:n===2||n===3?ke.length>0:n===4?ke.length>0&&De!=="":n===5?ke.length>0&&De!==""&&wt!=="":n===6?Nr!=="":!1,Xr=()=>L===1?ke.length>0&&Lt.length>0:L===2?!0:L===3?!(!De||De==="adventure"&&!qe||(De==="life-challenge"||De==="educational")&&!We||De==="historical"&&!We||De==="custom"&&!(Ye!=null&&Ye.trim())):L===4?wt!=="":L===5?ke.filter(v=>!mt.includes(v.id)).length>0&&Lt.length>0&&yr.trim().length>0:!1,zi=async()=>{const n=await new Promise(v=>{ye(u=>(v(u),u))});if(n.length!==0){if(!Rr.current){y.debug("Relationships not modified, skipping save");return}try{y.debug("Auto-saving character data with latest state..."),await Ge.saveCharacterData({characters:n,relationships:ft,relationshipTexts:Rt,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]}),Rr.current=!1,y.debug("Character data auto-saved")}catch(v){y.error("Failed to auto-save character data:",v)}}},Mi=async()=>{if(L<5&&Xr()){if(L===1&&ke.length===1){Pt(!0);return}await Sr(L+1)}},An=async()=>{L>0&&await Sr(L-1)},Oi=(n,v)=>{Ht(n),Bs(v??null)},$n=async()=>{tr.current&&tr.current.abort(),er(!0),Kr(!0),Ct(!0),qt([]),Jr(null),Dr(""),Bs(null);const n=ke.filter(v=>!mt.includes(v.id));pa({storyType:Tt,storyCategory:De||"",storyTopic:We||"",storyTheme:qe||"",characters:n.map(v=>({id:v.id,name:v.name})),language:Dt,languageLevel:St,pages:bt,userLocation:rr||void 0,season:sr||void 0}),tr.current=Ee.generateStoryIdeasStream({storyType:Tt,storyTypeName:Qs(),storyCategory:De||void 0,storyTopic:We||void 0,storyTheme:qe||void 0,customThemeText:qe==="custom"?Ye:void 0,language:Dt,languageLevel:St,pages:bt,characters:n.map(v=>({name:v.name,age:v.age,gender:v.gender,traits:v.traits,isMain:Lt.includes(v.id)})),relationships:Object.entries(ft).map(([v,u])=>{const[B,p]=v.split("-").map(Number),w=n.find(_=>_.id===B),D=n.find(_=>_.id===p);return{character1:(w==null?void 0:w.name)||"",character2:(D==null?void 0:D.name)||"",relationship:u}}).filter(v=>v.character1&&v.character2),ideaModel:(g==null?void 0:g.role)==="admin"||M?at.ideaModel:void 0,userLocation:rr||void 0,season:sr},{onStatus:(v,u,B)=>{u&&B&&Jr({prompt:u,model:B})},onStory1:v=>{qt(u=>{const B=[...u];return B[0]=v,B}),ga(100),Kr(!1)},onStory2:v=>{qt(u=>{const B=[...u];return B[1]=v,B}),Es(100),Ct(!1)},onError:v=>{y.error("Failed to generate story ideas:",v),f(s==="de"?"Fehler beim Generieren von Ideen. Bitte versuchen Sie es erneut.":s==="fr"?"Erreur lors de la gÃ©nÃ©ration d'idÃ©es. Veuillez rÃ©essayer.":"Failed to generate ideas. Please try again."),er(!1),Kr(!1),Ct(!1)},onDone:v=>{er(!1),Kr(!1),Ct(!1),v&&Dr(v),tr.current=null,y.info("[IDEAS] onDone complete")}})},Qs=()=>{const n=gn.find(v=>v.id===Tt);return n?n.name[s]:Tt},es=async n=>{var u,B,p,w,D,_,$,de,X,oe,fe,Ie,Qe,tt,ce,Ve;if(console.log("[generateStory] Called with overrides:",n),console.log("[generateStory] user:",g==null?void 0:g.email,"emailVerified:",g==null?void 0:g.emailVerified,"isImpersonating:",M),Js.current&&(await Js.current,Js.current=null),!(n!=null&&n.skipEmailCheck)&&!M&&g&&g.emailVerified!==!0){await R();const ue=localStorage.getItem("currentUser");let Y=g.emailVerified;if(ue)try{Y=JSON.parse(ue).emailVerified}catch{}if(Y===!0)console.log("[generateStory] Email verified (confirmed after refresh), proceeding");else{console.log("[generateStory] Email not verified, showing modal"),localStorage.setItem("pendingStoryGeneration","true"),localStorage.setItem("pending_story_type",Tt),localStorage.setItem("pending_art_style",wt),ar(!0);return}}console.log("[generateStory] Starting generation, setting step to 6"),h(!0),_e(!1),z(6),Xa({storyCategory:De||void 0,storyTopic:We||void 0,storyTheme:qe||void 0,storyTypeName:Qs(),storyDetails:yr||void 0,artStyle:wt||void 0,language:Dt||void 0,languageLevel:St||void 0,pages:bt||void 0,dedication:br||void 0,characters:ke.filter(ue=>!mt.includes(ue.id)).map(ue=>({id:ue.id,name:ue.name})),mainCharacters:Lt,relationships:ft,relationshipTexts:Rt,season:sr||void 0,userLocation:rr||void 0}),Er(""),Ut(""),et([]),Kt([]),Ta(null),Ra({}),ir({frontCover:null,initialPage:null,backCover:null});const v=ke.filter(ue=>!mt.includes(ue.id)).filter(ue=>!ue.avatars||ue.avatars.stale||ue.avatars.status!=="complete");if(v.length>0){console.log("[generateStory] Characters needing avatar regeneration:",v.map(ue=>ue.name)),nr({current:1,total:100,message:s==="de"?`Aktualisiere Avatare fÃ¼r ${v.length} Charakter(e)...`:s==="fr"?`Mise Ã  jour des avatars pour ${v.length} personnage(s)...`:`Updating avatars for ${v.length} character(s)...`});for(let ue=0;ue<v.length;ue++){const Y=v[ue];try{console.log(`[generateStory] Regenerating avatars for ${Y.name} (${ue+1}/${v.length})`),nr({current:2,total:100,message:s==="de"?`Generiere Avatare fÃ¼r ${Y.name}...`:s==="fr"?`GÃ©nÃ©ration des avatars pour ${Y.name}...`:`Generating avatars for ${Y.name}...`});const U=await Ge.generateClothingAvatarsWithTraits(Y);if(U.success&&U.avatars){const se={...U.avatars,stale:!1,generatedAt:new Date().toISOString()},J=Y.physicalTraitsSource||{},be=U.extractedTraits?{...Y.physical,height:(u=Y.physical)==null?void 0:u.height,build:J.build==="user"?(B=Y.physical)==null?void 0:B.build:U.extractedTraits.build,eyeColor:J.eyeColor==="user"?(p=Y.physical)==null?void 0:p.eyeColor:U.extractedTraits.eyeColor,eyeColorHex:J.eyeColor==="user"?(w=Y.physical)==null?void 0:w.eyeColorHex:U.extractedTraits.eyeColorHex,hairColor:J.hairColor==="user"?(D=Y.physical)==null?void 0:D.hairColor:U.extractedTraits.hairColor,hairColorHex:J.hairColor==="user"?(_=Y.physical)==null?void 0:_.hairColorHex:U.extractedTraits.hairColorHex,hairLength:J.hairLength==="user"?($=Y.physical)==null?void 0:$.hairLength:U.extractedTraits.hairLength,hairStyle:J.hairStyle==="user"?(de=Y.physical)==null?void 0:de.hairStyle:U.extractedTraits.hairStyle,facialHair:J.facialHair==="user"?(X=Y.physical)==null?void 0:X.facialHair:U.extractedTraits.facialHair,skinTone:J.skinTone==="user"?(oe=Y.physical)==null?void 0:oe.skinTone:U.extractedTraits.skinTone,skinToneHex:J.skinTone==="user"?(fe=Y.physical)==null?void 0:fe.skinToneHex:U.extractedTraits.skinToneHex,face:J.face==="user"?(Ie=Y.physical)==null?void 0:Ie.face:U.extractedTraits.face,other:J.other==="user"?(Qe=Y.physical)==null?void 0:Qe.other:U.extractedTraits.other,detailedHairAnalysis:U.extractedTraits.detailedHairAnalysis||((tt=Y.physical)==null?void 0:tt.detailedHairAnalysis),apparentAge:J.apparentAge==="user"?(ce=Y.physical)==null?void 0:ce.apparentAge:U.extractedTraits.apparentAge||((Ve=Y.physical)==null?void 0:Ve.apparentAge)}:Y.physical,Oe=U.extractedTraits?{...J,build:J.build==="user"?"user":U.extractedTraits.build?"extracted":void 0,eyeColor:J.eyeColor==="user"?"user":U.extractedTraits.eyeColor?"extracted":void 0,hairColor:J.hairColor==="user"?"user":U.extractedTraits.hairColor?"extracted":void 0,hairLength:J.hairLength==="user"?"user":U.extractedTraits.hairLength?"extracted":void 0,hairStyle:J.hairStyle==="user"?"user":U.extractedTraits.hairStyle?"extracted":void 0,face:J.face==="user"?"user":U.extractedTraits.face?"extracted":void 0,facialHair:J.facialHair==="user"?"user":U.extractedTraits.facialHair?"extracted":void 0,other:J.other==="user"?"user":U.extractedTraits.other?"extracted":void 0,skinTone:J.skinTone==="user"?"user":U.extractedTraits.skinTone?"extracted":void 0,apparentAge:J.apparentAge==="user"?"user":U.extractedTraits.apparentAge?"extracted":void 0}:Y.physicalTraitsSource,ae=U.extractedClothing?{...Y.clothing,structured:{upperBody:U.extractedClothing.upperBody||void 0,lowerBody:U.extractedClothing.lowerBody||void 0,shoes:U.extractedClothing.shoes||void 0,fullBody:U.extractedClothing.fullBody||void 0}}:Y.clothing;ye(ze=>ze.map(we=>we.id===Y.id?{...we,avatars:se,physical:be,physicalTraitsSource:Oe,clothing:ae}:we)),Fe(ze=>ze&&ze.id===Y.id?{...ze,avatars:se,physical:be,physicalTraitsSource:Oe,clothing:ae}:ze),ye(ze=>{const we=ze.map(Ue=>Ue.id===Y.id?{...Ue,avatars:se,physical:be,physicalTraitsSource:Oe,clothing:ae}:Ue);return Ge.saveCharacterData({characters:we,relationships:ft,relationshipTexts:Rt,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]}).catch(Ue=>console.error("Failed to save avatar update:",Ue)),we}),console.log(`[generateStory] âœ… Avatars regenerated for ${Y.name}`)}else console.warn(`[generateStory] âš ï¸ Failed to regenerate avatars for ${Y.name}: ${U.error}`)}catch(U){console.error(`[generateStory] âŒ Error regenerating avatars for ${Y.name}:`,U)}}}nr({current:5,total:100,message:s==="de"?"Starte Generierung...":s==="fr"?"DÃ©marrage de la gÃ©nÃ©ration...":"Starting generation..."});try{const ue=ke.filter(ae=>!mt.includes(ae.id)),{jobId:Y,creditsRemaining:U}=await Ee.createStoryJob({storyType:Tt,storyTypeName:Qs(),storyCategory:De||void 0,storyTopic:We||void 0,storyTheme:qe||void 0,customThemeText:qe==="custom"?Ye:void 0,artStyle:wt,language:Dt,languageLevel:St,pages:bt,dedication:br,storyDetails:yr,characters:ue,mainCharacters:Lt,relationships:ft,relationshipTexts:Rt,skipImages:(n==null?void 0:n.skipImages)??ge,imageGenMode:Se,generationMode:H!=="auto"?H:void 0,skipOutline:je,skipText:G,skipSceneDescriptions:me,skipCovers:Te,enableAutoRepair:Je,useGridRepair:vt,forceRepairThreshold:ss,enableFinalChecks:ra,checkOnlyMode:$e,enableSceneValidation:jt,separatedEvaluation:Yt,incrementalConsistency:kr?{enabled:!0,dryRun:aa,lookbackCount:Re}:void 0,modelOverrides:(g==null?void 0:g.role)==="admin"||M?{outlineModel:at.outlineModel,textModel:at.textModel,sceneDescriptionModel:at.sceneDescriptionModel,imageModel:at.imageModel,coverImageModel:at.coverImageModel,qualityModel:at.qualityModel}:void 0,userLocation:rr||void 0,season:sr||void 0,ideaGeneration:zs&&Wt&&kt.length>0?{input:zs,output:kt,rawResponse:Qr,prompt:Wt.prompt,model:Wt.model,selectedIndex:xa}:void 0});Ia(Y),y.info("Story job created:",Y),q(Y,Qs()||"New Story"),U!=null&&S(U);let se=!1,J=0,be=Date.now();const Oe=180*1e3;for(jr(!1);!se;){await new Promise(ze=>setTimeout(ze,2e3));const ae=await Ee.getJobStatus(Y);if(ae.progress&&(ae.progress.current!==J?(y.debug(`Progress: ${ae.progress.current}% - ${ae.progress.message||""}`),J=ae.progress.current,be=Date.now(),jr(!1)):Date.now()-be>=Oe&&jr(!0),nr(ze=>ae.progress.current>=ze.current?ae.progress:ae.progress.message?{...ze,message:ae.progress.message}:ze)),ae.partialCovers){let ze=!1;ir(we=>{var lt,ut,za;const Ue={...we};if((lt=ae.partialCovers)!=null&&lt.frontCover&&!we.frontCover){Ue.frontCover=ae.partialCovers.frontCover,y.debug("Front cover received during streaming");const Jt=ae.partialCovers.frontCover;typeof Jt=="object"&&(Jt!=null&&Jt.storyTitle)&&(Ut(Jt.storyTitle),y.debug(`Story title from front cover: ${Jt.storyTitle}`)),ze=!0}return(ut=ae.partialCovers)!=null&&ut.initialPage&&!we.initialPage&&(Ue.initialPage=ae.partialCovers.initialPage,y.debug("Initial page cover received during streaming")),(za=ae.partialCovers)!=null&&za.backCover&&!we.backCover&&(Ue.backCover=ae.partialCovers.backCover,y.debug("Back cover received during streaming")),Ue}),ze&&(y.debug("Transitioning to StoryDisplay - front cover ready"),z(6))}if(ae.storyText&&!$t&&(Ta(ae.storyText),Ut(ae.storyText.title),y.debug(`Story text received: ${ae.storyText.totalPages} pages ready for display`)),ae.partialPages&&ae.partialPages.length>0&&Ra(ze=>{var lt;const we={...ze};let Ue=0;return(lt=ae.partialPages)==null||lt.forEach(ut=>{ut.imageData&&!ze[ut.pageNumber]&&(we[ut.pageNumber]=ut.imageData,Ue++)}),Ue>0&&y.debug(`${Ue} new page images received (total: ${Object.keys(we).length})`),we}),console.log("[StoryWizard] Job status check:",{status:ae.status,hasResult:!!ae.result,resultKeys:ae.result?Object.keys(ae.result):[],progress:ae.progress}),ae.status==="completed"&&ae.result)Za(ae.result.storyId),Ut(ae.result.title),Ls(ae.result.outline),Gs(ae.result.outlinePrompt||""),_s(ae.result.outlineModelId),Hs(ae.result.outlineUsage),Vs(ae.result.storyTextPrompts||[]),hs(ae.result.styledAvatarGeneration||[]),xs(ae.result.costumedAvatarGeneration||[]),ps(ae.result.generationLog||[]),Ae(ae.result.finalChecksReport||null),ae.result.visualBible?wr({mainCharacters:ae.result.visualBible.mainCharacters||[],secondaryCharacters:ae.result.visualBible.secondaryCharacters||[],animals:ae.result.visualBible.animals||[],artifacts:ae.result.visualBible.artifacts||[],locations:ae.result.visualBible.locations||[],vehicles:ae.result.visualBible.vehicles||[],clothing:ae.result.visualBible.clothing||[],changeLog:ae.result.visualBible.changeLog||[]}):wr(null),ae.result.clothingRequirements?Yr(ae.result.clothingRequirements):Yr(null),Er(ae.result.story),Os(ae.result.story),Kt(ae.result.sceneDescriptions||[]),et(ae.result.sceneImages||[]),ir(ae.result.coverImages||{frontCover:null,initialPage:null,backCover:null}),Ta(null),Ra({}),se=!0,ae.currentCredits!==null&&ae.currentCredits!==void 0&&S(ae.currentCredits),z(6),y.success("Story generation completed!"),Xa({storyCategory:De||void 0,storyTopic:We||void 0,storyTheme:qe||void 0,storyTypeName:Qs(),storyDetails:yr||void 0,artStyle:wt||void 0,language:Dt||void 0,languageLevel:St||void 0,pages:bt||void 0,dedication:br||void 0,characters:ke.map(ze=>({id:ze.id,name:ze.name})),mainCharacters:Lt,relationships:ft,relationshipTexts:Rt,season:sr||void 0,userLocation:rr||void 0}),en.current=!0,j();else if(ae.status==="failed")throw new Error(ae.error||"Story generation failed")}nr({current:100,total:100,message:s==="de"?"Fertig!":s==="fr"?"TerminÃ©!":"Complete!"})}catch(ue){y.error("Generation failed:",ue);const Y=ue instanceof Error?ue.message:String(ue);if(Y.includes("already in progress")){const U=Y.match(/\|ACTIVE_JOB:(job_[a-z0-9_]+)/i),se=U?U[1]:null,J=s==="de"?"Eine Geschichte wird bereits erstellt. MÃ¶chtest du diese abbrechen und eine neue starten?":s==="fr"?"Une histoire est dÃ©jÃ  en cours de crÃ©ation. Voulez-vous l'annuler et en commencer une nouvelle?":"A story is already being generated. Would you like to cancel it and start a new one?";if(se&&window.confirm(J))try{await Ee.cancelJob(se),y.info("Cancelled existing job:",se),await es(n);return}catch(be){y.error("Failed to cancel existing job:",be),f(s==="de"?"Abbrechen fehlgeschlagen. Bitte versuche es spÃ¤ter erneut.":s==="fr"?"Ã‰chec de l'annulation. Veuillez rÃ©essayer plus tard.":"Failed to cancel. Please try again later.")}h(!1);return}else f(s==="de"?`Generierung fehlgeschlagen: ${Y}`:s==="fr"?`Ã‰chec de la gÃ©nÃ©ration: ${Y}`:`Generation failed: ${Y}`)}finally{jr(!1),j(),setTimeout(()=>h(!1),500)}};i.useEffect(()=>{if(Ba.current&&E&&ke.length>0&&L===5&&!t){Ba.current=!1;const n=localStorage.getItem("verificationGenerationStarted");if(n){const u=parseInt(n,10),B=Date.now()-120*1e3;if(u>B){console.log("Another window already started generation, skipping auto-generate");return}localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),(async()=>{await R(),setTimeout(()=>{es({skipEmailCheck:!0})},500)})()}},[E,ke,L,t,R]);const Li=()=>{switch(L){case 1:return e.jsx(rl,{characters:ke,currentCharacter:C,characterStep:oa,showCharacterCreated:ia,isLoading:F,isAnalyzingPhoto:la,isGeneratingAvatar:Xe===(C==null?void 0:C.id),isRegeneratingAvatars:Ps,isRegeneratingAvatarsWithTraits:is,developerMode:Q,isImpersonating:M,changedTraits:os,photoAnalysisDebug:Ja,mainCharacters:Lt,excludedCharacters:mt,onCharacterRoleChange:Fi,onCharacterChange:Fe,onCharacterStepChange:nt,onContinueToAvatar:()=>nt("avatar"),onPhotoSelect:Ni,onSaveAndGenerateAvatar:Ai,onSaveCharacter:on,onEditCharacter:$i,onDeleteCharacter:Ii,onStartNewCharacter:nn,onRegenerateAvatars:Ci,onRegenerateAvatarsWithTraits:ki,onSaveAndRegenerateWithTraits:Pi,onSaveAndTryNewPhoto:async()=>{var u;if(y.info(`ðŸ“¸ onSaveAndTryNewPhoto called, currentCharacter: ${C==null?void 0:C.name}`),!C){y.warn("ðŸ“¸ No currentCharacter, returning early");return}W(!0);try{const B=C.id&&ke.find(D=>D.id===C.id),p=B?ke.map(D=>D.id===C.id?C:D):[...ke,C],w=!B&&!!((u=C.photos)!=null&&u.original);await Ge.saveCharacterData({characters:p,relationships:ft,relationshipTexts:Rt,customRelationships:Tr,customStrengths:[],customWeaknesses:[],customFears:[]},{includePhotos:w}),ye(p),sn(p),y.info(`ðŸ“¸ Setting characterStep to 'photo', currentCharacter still: ${C==null?void 0:C.name}`),nt("photo")}catch(B){y.error("ðŸ“¸ Error saving character:",B)}finally{W(!1),y.info("ðŸ“¸ onSaveAndTryNewPhoto complete, characterStep should now be 'photo'")}},relationships:ft,relationshipTexts:Rt,onRelationshipChange:Ti,onRelationshipTextChange:Ri,customRelationships:Tr,onAddCustomRelationship:Di});case 2:return e.jsx(sl,{languageLevel:St,onLanguageLevelChange:_t,pages:bt,onPagesChange:ms,storyLanguage:Dt,onStoryLanguageChange:ua,developerMode:Q,userLocation:rr,onLocationChange:Ms,season:sr,onSeasonChange:fa,userCredits:M?-1:(g==null?void 0:g.credits)??0});case 3:return e.jsx(al,{storyCategory:De,storyTopic:We,storyTheme:qe,customThemeText:Ye,onCategoryChange:xi,onTopicChange:fi,onThemeChange:pi,onCustomThemeTextChange:ur,onLegacyStoryTypeChange:Xt});case 4:return e.jsx(nl,{artStyle:wt,onArtStyleChange:bi});case 5:return e.jsx(il,{characters:ke,mainCharacters:Lt,excludedCharacters:mt,storyCategory:De,storyTopic:We,storyTheme:qe,customThemeText:Ye,onCustomThemeTextChange:ur,artStyle:wt,storyLanguage:Dt,languageLevel:St,pages:bt,userLocation:rr,season:sr,storyDetails:yr,onStoryDetailsChange:Ht,dedication:br,onDedicationChange:Ur,onGenerateIdeas:$n,isGeneratingIdeas:Ft,isGeneratingIdea1:Fs,isGeneratingIdea2:Vt,ideaProgress1:us,ideaProgress2:ha,ideaPrompt:Wt,ideaFullResponse:Qr,generatedIdeas:kt,onSelectIdea:Oi,onUseDirectly:()=>es(),onEditStep:Sr,developerMode:Q,imageGenMode:Se,onImageGenModeChange:b,generationMode:H,onGenerationModeChange:ie});case 6:const n=Ws.frontCover||Ws.initialPage||Object.keys(tn).length>0||fs.some(u=>u.imageData);if(Nr&&n||$t&&n||t&&n){const u=Nr?fs:Object.entries(tn).map(([p,w])=>{var D;return{pageNumber:parseInt(p),imageData:w,description:((D=$t==null?void 0:$t.sceneDescriptions.find(_=>_.pageNumber===parseInt(p)))==null?void 0:D.description)||""}}),B=Nr||Object.entries(($t==null?void 0:$t.pageTexts)||{}).sort(([p],[w])=>parseInt(p)-parseInt(w)).map(([p,w])=>`--- Page ${p} ---
${w}`).join(`

`);return e.jsxs(e.Fragment,{children:[At&&At.total>0&&e.jsxs("div",{className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-sm rounded-full shadow-lg px-4 py-2 flex items-center gap-3 border border-indigo-100",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300 ease-out",style:{width:`${At.loaded/At.total*100}%`}})}),e.jsx("span",{className:"text-sm text-gray-600 whitespace-nowrap",children:s==="de"?`Bilder: ${At.loaded}/${At.total}`:s==="fr"?`Images: ${At.loaded}/${At.total}`:`Images: ${At.loaded}/${At.total}`})]}),Q&&Ce&&!t&&e.jsx(Go,{storyId:Ce,sceneImages:u,characters:ke.filter(p=>!mt.includes(p.id)),finalChecksReport:K,imageModel:at.imageModel||void 0,onImageUpdate:(p,w,D)=>{et(_=>_.map($=>$.pageNumber===p?{...$,imageData:w,imageVersions:[...$.imageVersions||[],{imageData:w,createdAt:new Date().toISOString(),isActive:!0,type:"repair"}].map((de,X,oe)=>({...de,isActive:X===oe.length-1}))}:$))},onRefreshStory:Ce?async()=>{try{y.info("Refreshing story data after repair...");const p=await Ee.getStory(Ce);p&&(et(p.sceneImages||[]),Ae(p.finalChecksReport||null),y.success("Story data refreshed"))}catch(p){y.error("Failed to refresh story:",p)}}:void 0}),e.jsx(Do,{title:gs,dedication:br||void 0,story:B,originalStory:ya,outline:va,outlinePrompt:ja,outlineModelId:Na,outlineUsage:wa,storyTextPrompts:Sa,visualBible:Ca||void 0,sceneImages:u,sceneDescriptions:($t==null?void 0:$t.sceneDescriptions)||Pe,characters:gr||ke.filter(p=>!mt.includes(p.id)),progressiveMode:t,progressiveData:$t||void 0,completedPageImages:tn,coverImages:Ws,regeneratingCovers:m,languageLevel:St,storyLanguage:Dt,isGenerating:t,developerMode:Q,styledAvatarGeneration:Pa,costumedAvatarGeneration:Aa,generationLog:$a,finalChecksReport:K,clothingRequirements:ka||void 0,storyId:Ce,onVisualBibleChange:Ce?async p=>{try{y.info("Updating Visual Bible for story:",Ce),await Ee.updateVisualBible(Ce,p),wr(p),y.success("Visual Bible updated successfully")}catch(w){y.error("Failed to update Visual Bible:",w),f(s==="de"?"Visual Bible konnte nicht aktualisiert werden":s==="fr"?"Ã‰chec de la mise Ã  jour de la Bible Visuelle":"Failed to update Visual Bible")}}:void 0,onRegenerateImage:Ce?async(p,w,D)=>{var _;try{y.info("Regenerating image for page:",p,w?"(scene edited)":"",D?`(${D.length} characters)`:"");const $=await Ee.regenerateImage(Ce,p,w,D);if(y.info("Regenerate result:",{hasImageData:!!($!=null&&$.imageData),length:(_=$==null?void 0:$.imageData)==null?void 0:_.length,versionCount:$==null?void 0:$.versionCount,creditsRemaining:$==null?void 0:$.creditsRemaining}),!($!=null&&$.imageData))throw y.error("No imageData in response!",$),new Error("No image data returned from server");et(de=>de.map(X=>X.pageNumber===p?{...X,imageData:$.imageData,description:$.newDescription||X.description,prompt:$.newPrompt,qualityScore:$.qualityScore,qualityReasoning:$.qualityReasoning,totalAttempts:$.totalAttempts,retryHistory:$.retryHistory,wasRegenerated:!0,originalImage:$.originalImage,originalScore:$.originalScore,originalReasoning:$.originalReasoning,imageVersions:$.imageVersions,referencePhotos:$.referencePhotos||X.referencePhotos,landmarkPhotos:$.landmarkPhotos||X.landmarkPhotos,visualBibleGrid:$.visualBibleGrid||X.visualBibleGrid}:X)),$.creditsRemaining!==void 0&&S&&S($.creditsRemaining),y.info("Image regenerated successfully, updated state")}catch($){y.error("Image regeneration failed:",$);const de=$ instanceof Error?$.message:String($);f(s==="de"?`Bildgenerierung fehlgeschlagen: ${de}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${de}`:`Image regeneration failed: ${de}`)}}:void 0,onDownloadTxt:()=>{const p=new Blob([Nr],{type:"text/plain"}),w=URL.createObjectURL(p),D=document.createElement("a");D.href=w,D.download=`${gs}.txt`,D.click(),URL.revokeObjectURL(w)},onDownloadPdf:Ce?async p=>{try{const w=await Ee.generatePdf(Ce,p),D=URL.createObjectURL(w),_=document.createElement("a");_.href=D,_.download=`${gs}.pdf`,_.click(),URL.revokeObjectURL(D)}catch(w){y.error("PDF download failed:",w),f(s==="de"?"PDF-Download fehlgeschlagen":s==="fr"?"Ã‰chec du tÃ©lÃ©chargement PDF":"PDF download failed")}}:void 0,onAddToBook:Ce?()=>{try{const p=sessionStorage.getItem("mystories_selected"),w=p?JSON.parse(p):[];w.includes(Ce)||(w.push(Ce),sessionStorage.setItem("mystories_selected",JSON.stringify(w))),y.info("Added story to book selection:",Ce),N(s==="de"?"Geschichte zum Buch hinzugefÃ¼gt. Du kannst weitere hinzufÃ¼gen oder das Buch bestellen.":s==="fr"?"Histoire ajoutÃ©e au livre. Vous pouvez en ajouter d'autres ou commander le livre.":"Story added to book. You can add more or order the book.",s==="de"?"Zum Buch hinzugefÃ¼gt":s==="fr"?"AjoutÃ© au livre":"Added to Book"),r("/stories")}catch(p){y.error("Failed to add story to selection:",p)}}:void 0,onPrintBook:Ce?async()=>{let p=await xo.getShippingAddress();if(!p){const _=prompt(s==="de"?"Keine Adresse gespeichert. Bitte eingeben (Format: Vorname, Nachname, Strasse, PLZ, Ort, Land, Email):":s==="fr"?"Aucune adresse enregistrÃ©e. Veuillez entrer (Format: PrÃ©nom, Nom, Rue, CP, Ville, Pays, Email):":"No saved address. Please enter (Format: FirstName, LastName, Street, PostCode, City, Country, Email):");if(!_)return;const $=_.split(",").map(de=>de.trim());if($.length<7){f(s==="de"?"UngÃ¼ltiges Adressformat":s==="fr"?"Format d'adresse invalide":"Invalid address format");return}p={firstName:$[0],lastName:$[1],addressLine1:$[2],postCode:$[3],city:$[4],country:$[5],email:$[6]}}const w=`${p.firstName} ${p.lastName}
${p.addressLine1}
${p.postCode} ${p.city}
${p.country}`,D=s==="de"?`Druckauftrag an folgende Adresse senden?

${w}`:s==="fr"?`Envoyer la commande Ã  cette adresse?

${w}`:`Send print order to this address?

${w}`;if(confirm(D))try{y.info("Creating print order for story:",Ce);const _=await Ee.createPrintOrder(Ce,{firstName:p.firstName,lastName:p.lastName,addressLine1:p.addressLine1,city:p.city,postCode:p.postCode,country:p.country,email:p.email||""}),$=s==="de"?`âœ… Druckauftrag erfolgreich erstellt!

Order ID: ${_.orderId}
${_.isDraft?"(Entwurf - muss in Gelato bestÃ¤tigt werden)":""}

MÃ¶chten Sie das Gelato Dashboard Ã¶ffnen, um den Auftrag zu verfolgen?`:s==="fr"?`âœ… Commande d'impression crÃ©Ã©e avec succÃ¨s!

ID de commande: ${_.orderId}
${_.isDraft?"(Brouillon - doit Ãªtre confirmÃ© dans Gelato)":""}

Voulez-vous ouvrir le tableau de bord Gelato pour suivre la commande?`:`âœ… Print order created successfully!

Order ID: ${_.orderId}
${_.isDraft?"(Draft - must be confirmed in Gelato)":""}

Would you like to open the Gelato dashboard to track your order?`;_.dashboardUrl&&confirm($)?window.open(_.dashboardUrl,"_blank"):_.dashboardUrl||N(s==="de"?`Druckauftrag erstellt! Order ID: ${_.orderId}`:s==="fr"?`Commande crÃ©Ã©e! ID: ${_.orderId}`:`Print order created! Order ID: ${_.orderId}`)}catch(_){y.error("Print order failed:",_);const $=_ instanceof Error?_.message:String(_);f(s==="de"?`Druckauftrag fehlgeschlagen: ${$}`:s==="fr"?`Ã‰chec de la commande d'impression: ${$}`:`Print order failed: ${$}`)}}:void 0,onCreateAnother:()=>{y.info("Creating new story - resetting settings"),Za(null),Ia(null),xt(null);const p=new URLSearchParams(l);p.delete("storyId"),o(p,{replace:!0}),Er(""),Ut(""),Kt([]),et([]),ir({frontCover:null,initialPage:null,backCover:null}),yn(!1),vn(void 0),jn(void 0),Nn(void 0),Xt(""),Ar(""),ns(""),$r(""),ht("watercolor"),_t("standard"),ms(30),Ur(""),Ht(""),localStorage.removeItem("story_type"),localStorage.removeItem("story_category"),localStorage.removeItem("story_topic"),localStorage.removeItem("story_theme"),localStorage.removeItem("story_art_style"),localStorage.removeItem("story_language_level"),localStorage.removeItem("story_pages"),localStorage.removeItem("story_dedication"),localStorage.removeItem("story_details"),localStorage.removeItem("wizard_step"),localStorage.removeItem("verificationGenerationStarted"),Fe(null),nt("photo"),z(1)},onRegenerateCover:Ce?async(p,w,D,_,$)=>{const de=p==="front"?"frontCover":p==="back"?"backCover":"initialPage";try{y.info("Regenerating cover:",p,w?`with scene: "${w.substring(0,50)}..."`:"",D?`with ${D.length} characters`:""),A(oe=>new Set(oe).add(de));const X=await Ee.regenerateCover(Ce,p,w,D,_,$);ir(oe=>oe&&{...oe,[p==="front"?"frontCover":p==="back"?"backCover":"initialPage"]:{imageData:X.imageData,description:X.description,prompt:X.prompt,qualityScore:X.qualityScore,qualityReasoning:X.qualityReasoning,totalAttempts:X.totalAttempts,retryHistory:X.retryHistory,referencePhotos:X.referencePhotos,wasRegenerated:X.wasRegenerated,regenerationCount:X.regenerationCount,previousImage:X.previousImage,previousScore:X.previousScore,originalImage:X.originalImage,originalScore:X.originalScore,modelId:X.modelId}}),X.creditsRemaining!==void 0&&S&&S(X.creditsRemaining),y.info("Cover regenerated successfully")}catch(X){y.error("Cover regeneration failed:",X);const oe=X instanceof Error?X.message:String(X);f(s==="de"?`Cover-Generierung fehlgeschlagen: ${oe}`:s==="fr"?`Ã‰chec de la rÃ©gÃ©nÃ©ration: ${oe}`:`Cover regeneration failed: ${oe}`)}finally{A(X=>{const oe=new Set(X);return oe.delete(de),oe})}}:void 0,onEditImage:p=>{Fa({type:"image",pageNumber:p}),Us(""),Da(!0)},onEditCover:p=>{Fa({type:"cover",coverType:p}),Us(""),Da(!0)},onRepairImage:Ce&&((g==null?void 0:g.role)==="admin"||M)?async p=>{var w,D,_;try{y.info("Starting auto-repair for page:",p);const $=fs.find(oe=>oe.pageNumber===p);let de=$==null?void 0:$.fixTargets;if(!de||de.length===0){const oe=(D=(w=$==null?void 0:$.retryHistory)==null?void 0:w.filter(fe=>fe.type==="auto_repair"))==null?void 0:D.slice(-1)[0];(_=oe==null?void 0:oe.preRepairEval)!=null&&_.fixTargets&&oe.preRepairEval.fixTargets.length>0&&(de=oe.preRepairEval.fixTargets,y.info(`Using ${de.length} fix targets from retryHistory.preRepairEval`))}de&&de.length>0?y.info(`Using ${de.length} existing fix targets`):y.info("No stored fix targets found, will re-evaluate");const X=await Ee.repairImage(Ce,p,de);X.repaired?(et(oe=>oe.map(fe=>fe.pageNumber===p?{...fe,imageData:X.imageData,wasAutoRepaired:!0,repairHistory:X.repairHistory,repairedAt:new Date().toISOString()}:fe)),y.info("Auto-repair completed successfully:",{repaired:X.repaired,repairs:X.repairHistory.length})):X.noErrorsFound&&y.info("No physics errors detected in the image")}catch($){throw y.error("Auto-repair failed:",$),$}}:void 0,onIteratePage:Ce&&((g==null?void 0:g.role)==="admin"||M)?async p=>{var w;try{y.info("Starting iteration for page:",p,"imageModel:",at.imageModel);const D=await Ee.iteratePage(Ce,p,at.imageModel||void 0);D.success&&(et(_=>_.map($=>{var de;if($.pageNumber===p){const X=$.imageVersions||[],oe=(de=D.imageVersions)==null?void 0:de.map((fe,Ie)=>{var Qe;return{imageData:fe.imageData||((Qe=X[Ie])==null?void 0:Qe.imageData)||"",description:fe.description,prompt:fe.prompt,modelId:fe.modelId,createdAt:fe.createdAt||new Date().toISOString(),isActive:fe.isActive??!1,type:fe.type,qualityScore:fe.qualityScore}});return{...$,imageData:D.imageData,description:D.sceneDescription,prompt:D.imagePrompt,qualityScore:D.qualityScore,qualityReasoning:D.qualityReasoning,wasIterated:!0,iteratedAt:new Date().toISOString(),iterationFeedback:D.composition,previewMismatches:D.previewMismatches,imageVersions:oe||$.imageVersions}}return $})),Kt(_=>_.map($=>$.pageNumber===p?{...$,description:D.sceneDescription,iteratedAt:new Date().toISOString()}:$)),y.info("Iteration completed successfully:",{mismatches:((w=D.previewMismatches)==null?void 0:w.length)||0,score:D.qualityScore,message:D.message}))}catch(D){throw y.error("Iteration failed:",D),D}}:void 0,onRevertRepair:Ce&&((g==null?void 0:g.role)==="admin"||M)?async(p,w)=>{try{y.info("Reverting repair for page:",p),et(D=>D.map(_=>_.pageNumber===p?{..._,imageData:w,wasAutoRepaired:!1}:_)),await Ee.updateSceneImage(Ce,p,w),y.info("Repair reverted successfully")}catch(D){throw y.error("Failed to revert repair:",D),D}}:void 0,onSaveStoryText:Ce?async p=>{try{y.info("Saving story text for story:",Ce),await Ee.saveStoryText(Ce,p),Er(p),y.info("Story text saved successfully")}catch(w){throw y.error("Failed to save story text:",w),w}}:void 0,onSaveTitleChange:Ce?async p=>{try{y.info("Saving title for story:",Ce,p),await Ee.saveStoryTitle(Ce,p),Ut(p),y.info("Title saved successfully")}catch(w){throw y.error("Failed to save title:",w),w}}:void 0,userCredits:M?-1:(g==null?void 0:g.credits)||0,imageRegenerationCost:5,isImpersonating:M,onSelectImageVersion:Ce?async(p,w)=>{try{y.info("Selecting image version:",{pageNumber:p,versionIndex:w});const D=await Ee.setActiveImage(Ce,p,w);et(_=>_.map($=>{if($.pageNumber===p&&$.imageVersions){const de=$.imageVersions[w];return{...$,imageData:(de==null?void 0:de.imageData)||$.imageData,imageVersions:$.imageVersions.map((X,oe)=>({...X,isActive:oe===w}))}}return $})),y.info("Image version selected:",D)}catch(D){throw y.error("Failed to select image version:",D),D}}:void 0,isPartial:di,failureReason:ci,generatedPages:mi,totalPages:ui,generationSettings:gi||void 0,onRefreshStory:Ce?async()=>{if(y.info("Refreshing story data:",Ce),Br.current=!1,li(p=>p+1),Q)try{const p=await Ee.getStoryDevMetadata(Ce);Ea(p),Br.current=!0,y.info("Dev metadata refreshed after repair")}catch(p){y.warn("Failed to refresh dev metadata:",p)}}:void 0})]})}return l.get("storyId")?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(Ze,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story..."})]}):t?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-indigo-300 border-t-indigo-600 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-indigo-700",children:s==="de"?"Geschichte wird erstellt...":s==="fr"?"CrÃ©ation de l'histoire...":"Creating your story..."}),e.jsx("p",{className:"text-indigo-500 mt-2",children:s==="de"?"Einen Moment Geduld bitte":s==="fr"?"Veuillez patienter":"Please wait a moment"})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ns,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:c.generateStory}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Bereit, deine Geschichte zu erstellen!":s==="fr"?"PrÃªt Ã  crÃ©er votre histoire!":"Ready to create your story!"}),e.jsxs(Wa,{onClick:()=>es(),size:"lg",icon:Ns,children:[c.generateStory," (",bt*10," Credits)"]})]});default:return null}};return E?e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[e.jsx(Ui,{currentStep:L,onStepClick:Sr,canAccessStep:Bi,developerMode:Q,onDeveloperModeChange:Ne,hideSteps:L===6&&!!Ce,onShowGenerationProgress:()=>{_e(!1),z(6)}}),e.jsx("div",{className:"px-3 md:px-8 mt-2 md:mt-8 flex-1",children:e.jsxs("div",{className:"md:bg-white md:rounded-2xl md:shadow-xl md:p-8",children:[F&&!t?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center",children:[e.jsx(Ze,{className:"w-12 h-12 text-indigo-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:P?s==="de"?"Geschichte wird geladen...":s==="fr"?"Chargement de l'histoire...":"Loading story...":s==="de"?"Wird geladen...":s==="fr"?"Chargement...":"Loading..."}),P&&e.jsxs("div",{className:"w-64 mt-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-600 transition-all duration-300 ease-out",style:{width:P.total?`${Math.min(100,P.loaded/P.total*100)}%`:"100%"}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2 text-center",children:[(P.loaded/(1024*1024)).toFixed(1)," MB",P.total&&e.jsxs("span",{children:[" (",Math.round(P.loaded/P.total*100),"%)"]})]})]})]}):e.jsxs(e.Fragment,{children:[L>=1&&L<=5&&!C&&e.jsx(vo,{step:L,text:(Yn[s]||Yn.en)[L]}),e.jsx(i.Suspense,{fallback:e.jsx(In,{}),children:Li()})]}),L<6&&!C&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200",children:[L===1&&ke.length>=2&&!yi()&&(()=>{const n=vi();if(!n)return null;const v=s==="de"?`${n.name} hat Beziehungen, die nicht definiert sind ("nicht bekannt")`:s==="fr"?`${n.name} a des relations non dÃ©finies ("ne connaÃ®t pas")`:`${n.name} has undefined relationships ("not known to")`;return e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"âš ï¸"}),e.jsx("p",{className:"text-amber-700 text-sm",children:v})]})})(),L!==5&&e.jsxs("div",{className:`flex ${L===1?"justify-end":"justify-between"}`,children:[L>1&&e.jsxs("button",{onClick:An,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(zn,{size:20})," ",c.back]}),e.jsxs("button",{onClick:Mi,disabled:!Xr(),className:`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${Xr()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:[c.next," ",e.jsx(Xi,{size:20})]})]}),L===5&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{onClick:()=>es(),disabled:!Xr(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Xr()?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Ns,{size:20})," ",c.generateStory," (",bt*10," Credits)"]}),Q&&e.jsxs("button",{onClick:()=>es({skipImages:!0}),disabled:!Xr(),className:`w-full py-3 rounded-lg font-bold text-base flex items-center justify-center gap-2 ${Xr()?"bg-yellow-500 text-white hover:bg-yellow-600":"bg-gray-400 text-white cursor-not-allowed"}`,children:[e.jsx(Ns,{size:20}),s==="de"?"Nur Text generieren (ohne Bilder)":s==="fr"?"GÃ©nÃ©rer le texte uniquement (sans images)":"Generate Text Only (no images)"]}),Q&&e.jsxs("div",{className:"p-4 bg-orange-50 border border-orange-200 rounded-lg text-left",children:[e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mb-3",children:["ðŸ› ï¸ ",s==="de"?"Entwickler-Optionen - Schritte Ã¼berspringen":s==="fr"?"Options dÃ©veloppeur - Sauter des Ã©tapes":"Developer Options - Skip Steps"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:je,onChange:n=>le(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Gliederung Ã¼berspringen":s==="fr"?"Sauter le plan":"Skip outline generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:G,onChange:n=>I(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Text Ã¼berspringen":s==="fr"?"Sauter le texte":"Skip text generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:me,onChange:n=>te(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenenbeschreibungen Ã¼berspringen":s==="fr"?"Sauter les descriptions de scÃ¨nes":"Skip scene descriptions"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ge,onChange:n=>Z(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Bilder Ã¼berspringen":s==="fr"?"Sauter les images":"Skip image generation"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Te,onChange:n=>Me(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Cover Ã¼berspringen":s==="fr"?"Sauter les couvertures":"Skip cover images"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2",children:s==="de"?"Hinweis: Ãœbersprungene Schritte verwenden Platzhalter/leere Daten":s==="fr"?"Note: Les Ã©tapes sautÃ©es utiliseront des donnÃ©es vides/provisoires":"Note: Skipped steps will use placeholder/empty data"}),e.jsxs("h3",{className:"text-sm font-semibold text-orange-700 mt-4 mb-2",children:["ðŸ”§ ",s==="de"?"Feature-Optionen":s==="fr"?"Options de fonctionnalitÃ©s":"Feature Options"]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Je,onChange:n=>It(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Auto-Reparatur aktivieren":s==="fr"?"Activer la rÃ©paration auto":"Enable auto-repair"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Versucht erkannte Bildfehler automatisch zu korrigieren (z.B. fehlende Finger)":s==="fr"?"Essaie de corriger automatiquement les erreurs d'image dÃ©tectÃ©es":"Attempts to automatically fix detected image issues (e.g., missing fingers)"}),Je&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:vt,onChange:n=>dr(n.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Grid-Reparatur verwenden":s==="fr"?"Utiliser la rÃ©paration en grille":"Use grid repair"})]}),Je&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Extrahiert Problemregionen in ein Grid, repariert mit Gemini, verifiziert mit LPIPS+LLM":s==="fr"?"Extrait les rÃ©gions problÃ©matiques dans une grille, rÃ©pare avec Gemini, vÃ©rifie avec LPIPS+LLM":"Extracts issue regions to grid, repairs with Gemini, verifies with LPIPS+LLM"}),Je&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:s==="de"?"Reparatur-Schwelle:":s==="fr"?"Seuil de rÃ©paration:":"Force repair threshold:"}),e.jsxs("select",{value:ss===null?"default":ss,onChange:n=>Zt(n.target.value==="default"?null:parseInt(n.target.value)),className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"default",children:s==="de"?"Standard (nur bei Fehler)":s==="fr"?"DÃ©faut (seulement si erreur)":"Default (only on failure)"}),e.jsx("option",{value:"100",children:s==="de"?"100% (immer reparieren)":s==="fr"?"100% (toujours rÃ©parer)":"100% (always repair)"}),e.jsx("option",{value:"90",children:"90%"}),e.jsx("option",{value:"80",children:"80%"}),e.jsx("option",{value:"75",children:"75%"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?"Bei 100% werden alle Seiten mit Problemen repariert, auch wenn sie die QualitÃ¤tsprÃ¼fung bestehen":s==="fr"?"Ã€ 100%, toutes les pages avec des problÃ¨mes sont rÃ©parÃ©es, mÃªme si elles passent le contrÃ´le qualitÃ©":"At 100%, all pages with issues are repaired even if they pass quality check"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:ra,onChange:n=>sa(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"KonsistenzprÃ¼fung aktivieren":s==="fr"?"Activer la vÃ©rification de cohÃ©rence":"Enable final checks"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft Bilder und Text auf Konsistenz am Ende der Generierung":s==="fr"?"VÃ©rifie la cohÃ©rence des images et du texte Ã  la fin de la gÃ©nÃ©ration":"Checks images and text for consistency at end of generation"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:jt,onChange:n=>cr(n.target.checked),className:"rounded border-cyan-300 text-cyan-600 focus:ring-cyan-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Szenen-Validierung":s==="fr"?"Validation de scÃ¨ne":"Scene validation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt gÃ¼nstige Vorschau, prÃ¼ft Geometrie, repariert Kompositionsprobleme":s==="fr"?"GÃ©nÃ¨re un aperÃ§u Ã©conomique, vÃ©rifie la gÃ©omÃ©trie, rÃ©pare les problÃ¨mes de composition":"Generates cheap preview, checks geometry, repairs composition issues"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:Yt,onChange:n=>Gr(n.target.checked),className:"rounded border-violet-300 text-violet-600 focus:ring-violet-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Getrennte Auswertung":s==="fr"?"Ã‰valuation sÃ©parÃ©e":"Separated evaluation"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"Erzeugt alle Bilder zuerst, dann wertet alle parallel aus und repariert":s==="fr"?"GÃ©nÃ¨re toutes les images d'abord, puis Ã©value et rÃ©pare en parallÃ¨le":"Generates all images first, then evaluates and repairs in batch"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:kr,onChange:n=>Pr(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Inkrementelle Konsistenz":s==="fr"?"CohÃ©rence incrÃ©mentielle":"Incremental consistency"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"PrÃ¼ft jedes Bild gegen vorherige Bilder wÃ¤hrend der Generierung":s==="fr"?"VÃ©rifie chaque image par rapport aux images prÃ©cÃ©dentes pendant la gÃ©nÃ©ration":"Checks each image against previous images during generation"}),kr&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2 ml-6",children:[e.jsx("input",{type:"checkbox",checked:aa,onChange:n=>a(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur Protokoll (Dry Run)":s==="fr"?"Journaliser seulement (Dry Run)":"Dry run (log only)"})]}),kr&&e.jsx("p",{className:"text-xs text-gray-500 ml-12",children:s==="de"?"Zeigt nur an, was repariert wÃ¼rde, ohne tatsÃ¤chlich zu reparieren":s==="fr"?"Affiche uniquement ce qui serait rÃ©parÃ© sans effectuer de rÃ©parations":"Shows what would be fixed without actually fixing"}),kr&&e.jsxs("div",{className:"mt-2 ml-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-700 text-sm",children:s==="de"?"Vergleichsfenster:":s==="fr"?"FenÃªtre de comparaison:":"Lookback window:"}),e.jsx("input",{type:"range",min:"1",max:"5",value:Re,onChange:n=>ct(parseInt(n.target.value,10)),className:"w-20 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer"}),e.jsx("span",{className:"text-gray-600 font-medium w-4",children:Re})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s==="de"?`Vergleicht jedes Bild mit den ${Re} vorherigen`:s==="fr"?`Compare chaque image avec les ${Re} prÃ©cÃ©dentes`:`Compares each image with the previous ${Re}`})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-4",children:[e.jsx("input",{type:"checkbox",checked:$e,onChange:n=>Cs(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Nur PrÃ¼fung (keine Regenerierung)":s==="fr"?"VÃ©rification seule (pas de rÃ©gÃ©nÃ©ration)":"Check only (no regeneration)"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"FÃ¼hrt alle QualitÃ¤tsprÃ¼fungen durch, Ã¼berspringt aber Regenerierung/Reparatur":s==="fr"?"ExÃ©cute toutes les vÃ©rifications de qualitÃ© mais ignore la rÃ©gÃ©nÃ©ration/rÃ©paration":"Runs all quality checks but skips regeneration/repair"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",checked:mr,onChange:n=>as(n.target.checked),className:"rounded border-orange-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{className:"text-gray-700",children:s==="de"?"Alle Avatare laden":s==="fr"?"Charger tous les avatars":"Load all avatars"})]}),e.jsx("p",{className:"text-xs text-gray-500 ml-6",children:s==="de"?"LÃ¤dt alle Avatar-Varianten (30MB+). NÃ¼tzlich zum Debuggen.":s==="fr"?"Charge toutes les variantes d'avatar (30MB+). Utile pour le dÃ©bogage.":"Loads all avatar variants (30MB+). Useful for debugging."})]}),Q&&((g==null?void 0:g.role)==="admin"||M)&&e.jsx(zo,{selections:at,onChange:na}),e.jsxs("button",{onClick:An,className:"bg-transparent text-gray-800 hover:bg-gray-100 px-6 py-3 rounded-lg font-semibold flex items-center gap-2",children:[e.jsx(zn,{size:20})," ",c.back]})]})]})]})}),t&&!Nr&&!$t&&!Ws.frontCover&&!he&&e.jsx(jo,{current:vr.current,total:vr.total,message:vr.message,coverImages:Ws,characters:ke,jobId:Ya||void 0,isStalled:ba,onDismissStalled:()=>jr(!1),isImpersonating:M,onMinimize:()=>st(!0),onCancel:Ya?async()=>{try{await Ee.cancelJob(Ya),y.info("Job cancelled by user"),h(!1),Ia(null),jr(!1),nr({current:0,total:0,message:""}),k(s==="de"?"Generierung abgebrochen":s==="fr"?"GÃ©nÃ©ration annulÃ©e":"Generation cancelled")}catch(n){y.error("Failed to cancel job:",n),f(s==="de"?"Abbruch fehlgeschlagen":s==="fr"?"Ã‰chec de l'annulation":"Failed to cancel")}}:void 0}),Be&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Geschichte wird im Hintergrund generiert":s==="fr"?"Histoire en cours de gÃ©nÃ©ration":"Story generating in background"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Was mÃ¶chtest du tun?":s==="fr"?"Que voulez-vous faire?":"What would you like to do?"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{_e(!0),st(!1),r("/create?new=true")},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Neue Geschichte erstellen":s==="fr"?"CrÃ©er une autre histoire":"Create another story"}),pe&&e.jsx("button",{onClick:()=>{_e(!0),st(!1),r("/stories")},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Meine Geschichten lesen":s==="fr"?"Lire mes histoires":"Read my stories"})]})]})}),yt&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s==="de"?"Nur ein Charakter":s==="fr"?"Un seul personnage":"Only One Character"}),e.jsx("p",{className:"text-gray-600 mb-6",children:s==="de"?"Geschichten werden interessanter mit mehreren Charakteren. Du hast nur einen Charakter erstellt.":s==="fr"?"Les histoires sont plus intÃ©ressantes avec plusieurs personnages. Vous n'avez crÃ©Ã© qu'un seul personnage.":"Stories are more interesting with multiple characters. You have only created one character."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{Pt(!1),nn()},className:"w-full py-3 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium",children:s==="de"?"Weiteren Charakter erstellen":s==="fr"?"CrÃ©er un autre personnage":"Create another character"}),e.jsx("button",{onClick:async()=>{Pt(!1),await Sr(L+1)},className:"w-full py-3 px-4 bg-gray-100 text-gray-800 rounded-xl hover:bg-gray-200 transition-colors font-medium",children:s==="de"?"Trotzdem weiter":s==="fr"?"Continuer quand mÃªme":"Continue anyway"})]})]})}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center",children:[e.jsx("div",{className:"relative inline-block mb-4",children:e.jsx(Ze,{size:40,className:"animate-spin text-indigo-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s==="de"?"Bild wird erstellt...":s==="fr"?"CrÃ©ation de l'image...":"Generating image..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:s==="de"?"Dies dauert etwa 30 Sekunden":s==="fr"?"Cela prend environ 30 secondes":"This takes about 30 seconds"})]})}),hi&&it&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:s==="de"?"Bild bearbeiten":s==="fr"?"Modifier l'image":"Edit Image"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:it.type==="image"?s==="de"?`Seite ${it.pageNumber}`:s==="fr"?`Page ${it.pageNumber}`:`Page ${it.pageNumber}`:s==="de"?it.coverType==="front"?"Titelseite":it.coverType==="back"?"RÃ¼ckseite":"Einleitungsseite":s==="fr"?it.coverType==="front"?"Couverture":it.coverType==="back"?"Dos":"Page de dÃ©dicace":it.coverType==="front"?"Front Cover":it.coverType==="back"?"Back Cover":"Dedication Page"}),e.jsx("textarea",{value:qs,onChange:n=>Us(n.target.value),placeholder:s==="de"?`Beschreibe die gewÃ¼nschte Ã„nderung...
z.B. "Mach den Himmel blauer" oder "FÃ¼ge einen Schmetterling hinzu"`:s==="fr"?`DÃ©crivez le changement souhaitÃ©...
par ex. "Rendre le ciel plus bleu" ou "Ajouter un papillon"`:`Describe what you want to change...
e.g. "Make the sky bluer" or "Add a butterfly"`,className:"w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 resize-none"}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{onClick:()=>{Da(!1),Fa(null),Us("")},className:"flex-1 px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium",children:s==="de"?"Abbrechen":s==="fr"?"Annuler":"Cancel"}),e.jsx("button",{onClick:async()=>{if(!(!qs.trim()||!Ce)){Da(!1),re(!0);try{if(it.type==="image"&&it.pageNumber){const n=await Ee.editImage(Ce,it.pageNumber,qs);if(y.info("Edit result:",{hasImageData:!!(n!=null&&n.imageData),score:n==null?void 0:n.qualityScore}),!(n!=null&&n.imageData))throw y.error("No imageData in edit response!",n),new Error("No image data returned from server");et(v=>v.map(u=>u.pageNumber===it.pageNumber?{...u,imageData:n.imageData,qualityScore:n.qualityScore,qualityReasoning:n.qualityReasoning,wasEdited:!0,originalImage:n.originalImage,originalScore:n.originalScore,originalReasoning:n.originalReasoning}:u)),y.info("Image edited successfully, updated state with quality info")}else if(it.type==="cover"&&it.coverType){const n=await Ee.editCover(Ce,it.coverType,qs);ir(v=>{if(!v)return v;const u=it.coverType==="front"?"frontCover":it.coverType==="back"?"backCover":"initialPage",B=v[u],p={...typeof B=="object"?B:{},imageData:n.imageData,qualityScore:n.qualityScore,qualityReasoning:n.qualityReasoning,wasEdited:!0,originalImage:n.originalImage,originalScore:n.originalScore,originalReasoning:n.originalReasoning};return{...v,[u]:p}}),y.info("Cover edited successfully with quality info")}}catch(n){y.error("Edit failed:",n),f(s==="de"?"Bearbeitung fehlgeschlagen. Bitte versuche es erneut.":s==="fr"?"Ã‰chec de la modification. Veuillez rÃ©essayer.":"Edit failed. Please try again.")}finally{re(!1),Fa(null),Us("")}}},disabled:!qs.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:s==="de"?"Bearbeiten":s==="fr"?"Modifier":"Edit"})]})]})}),e.jsx(Jo,{isOpen:Qa,faces:ls,onSelect:wi,onUploadNew:Si,developerMode:Q}),e.jsx(Wo,{isOpen:Zr,onClose:()=>ar(!1),onVerified:()=>{console.log("[EmailVerification] onVerified callback triggered");const n=localStorage.getItem("verificationGenerationStarted");if(n){const v=parseInt(n,10),u=Date.now()-120*1e3;if(v>u){console.log("[EmailVerification] Another window started recently, skipping"),ar(!1);return}console.log("[EmailVerification] Clearing stale flag"),localStorage.removeItem("verificationGenerationStarted")}localStorage.setItem("verificationGenerationStarted",Date.now().toString()),localStorage.removeItem("pendingStoryGeneration"),localStorage.removeItem("pending_story_type"),localStorage.removeItem("pending_art_style"),console.log("[EmailVerification] Calling generateStory with skipEmailCheck: true"),es({skipEmailCheck:!0}),ar(!1)}})]}):e.jsx(In,{fullScreen:!0})}const Bl=Object.freeze(Object.defineProperty({__proto__:null,default:ol},Symbol.toStringTag,{value:"Module"}));export{Co as I,uo as S,go as U,ys as a,ai as b,Ge as c,Pl as d,Rl as e,Uo as f,qo as g,Dl as h,Un as i,Il as j,Fl as k,$l as l,Tl as m,El as n,Jn as o,Qn as p,Al as q,bn as r,kl as s,Zn as t,Cl as u,gn as v,Bl as w};
