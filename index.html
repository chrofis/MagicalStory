<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Story Creator</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // Lucide Icons Component Wrapper
    const Icon = ({ name, size = 24, className = "", ...props }) => {
      useEffect(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, []);
      return React.createElement('i', {
        'data-lucide': name,
        className,
        style: { width: size, height: size },
        ...props
      });
    };

    const storyTypes = [
      { id: 'pirate', name: { en: 'Pirate Adventure', de: 'Piraten-Abenteuer', fr: 'Aventure de Pirates' }, emoji: 'ðŸ´â€â˜ ï¸' },
      { id: 'cowboy', name: { en: 'Wild West', de: 'Wilder Westen', fr: 'Far West' }, emoji: 'ðŸ¤ ' },
      { id: 'fireman', name: { en: 'Brave Firefighter', de: 'Tapferer Feuerwehrmann', fr: 'Pompier Courageux' }, emoji: 'ðŸš’' },
      { id: 'unicorn', name: { en: 'Magical Unicorn', de: 'Magisches Einhorn', fr: 'Licorne Magique' }, emoji: 'ðŸ¦„' },
      { id: 'ninja', name: { en: 'Secret Ninja', de: 'Geheimer Ninja', fr: 'Ninja Secret' }, emoji: 'ðŸ¥·' },
      { id: 'space', name: { en: 'Space Explorer', de: 'Weltraum-Entdecker', fr: 'Explorateur Spatial' }, emoji: 'ðŸš€' },
      { id: 'dinosaur', name: { en: 'Dinosaur World', de: 'Dinosaurier-Welt', fr: 'Monde des Dinosaures' }, emoji: 'ðŸ¦–' },
      { id: 'princess', name: { en: 'Princess Story', de: 'Prinzessinnen-Geschichte', fr: 'Histoire de Princesse' }, emoji: 'ðŸ‘‘' },
      { id: 'knight', name: { en: 'Knight Adventure', de: 'Ritter-Abenteuer', fr: 'Aventure de Chevalier' }, emoji: 'âš”ï¸' },
      { id: 'detective', name: { en: 'Detective Mystery', de: 'Detektiv-Geheimnis', fr: 'MystÃ¨re de DÃ©tective' }, emoji: 'ðŸ”' }
    ];

    const defaultStrengths = {
      en: ['Brave', 'Smart', 'Kind', 'Strong', 'Fast', 'Creative', 'Funny', 'Leader', 'Helpful', 'Patient', 'Honest', 'Loyal', 'Curious', 'Determined', 'Caring', 'Confident', 'Cheerful', 'Generous', 'Clever', 'Adventurous', 'Resourceful', 'Protective', 'Imaginative', 'Hardworking', 'Trustworthy'],
      de: ['Mutig', 'Klug', 'Freundlich', 'Stark', 'Schnell', 'Kreativ', 'Lustig', 'FÃ¼hrungspersÃ¶nlichkeit', 'Hilfsbereit', 'Geduldig', 'Ehrlich', 'Treu', 'Neugierig', 'Entschlossen', 'FÃ¼rsorglich', 'Selbstbewusst', 'FrÃ¶hlich', 'GroÃŸzÃ¼gig', 'Schlau', 'Abenteuerlustig', 'Einfallsreich', 'BeschÃ¼tzend', 'Fantasievoll', 'FleiÃŸig', 'VertrauenswÃ¼rdig'],
      fr: ['Courageux', 'Intelligent', 'Gentil', 'Fort', 'Rapide', 'CrÃ©atif', 'DrÃ´le', 'Leader', 'Serviable', 'Patient', 'HonnÃªte', 'Loyal', 'Curieux', 'DÃ©terminÃ©', 'AttentionnÃ©', 'Confiant', 'Joyeux', 'GÃ©nÃ©reux', 'Astucieux', 'Aventureux', 'DÃ©brouillard', 'Protecteur', 'Imaginatif', 'Travailleur', 'Digne de confiance']
    };

    const defaultWeaknesses = {
      en: ['Shy', 'Clumsy', 'Impatient', 'Forgetful', 'Messy', 'Talkative', 'Stubborn', 'Lazy', 'Greedy', 'Jealous', 'Anxious', 'Distracted', 'Reckless', 'Bossy', 'Easily scared', 'Too trusting', 'Perfectionist', 'Indecisive', 'Secretive', 'Boastful', 'Quick-tempered', 'Careless', 'Overly cautious', 'Selfish'],
      de: ['SchÃ¼chtern', 'Tollpatschig', 'Ungeduldig', 'Vergesslich', 'Unordentlich', 'GesprÃ¤chig', 'Stur', 'Faul', 'Gierig', 'EifersÃ¼chtig', 'Ã„ngstlich', 'Abgelenkt', 'Leichtsinnig', 'HerrschsÃ¼chtig', 'Leicht Ã¤ngstlich', 'Zu vertrauensvoll', 'Perfektionist', 'Unentschlossen', 'Verschlossen', 'Prahlerisch', 'JÃ¤hzornig', 'NachlÃ¤ssig', 'Ãœbervorsichtig', 'Egoistisch'],
      fr: ['Timide', 'Maladroit', 'Impatient', 'Distrait', 'DÃ©sordonnÃ©', 'Bavard', 'TÃªtu', 'Paresseux', 'Avide', 'Jaloux', 'Anxieux', 'Distrait', 'Imprudent', 'Autoritaire', 'Facilement effrayÃ©', 'Trop confiant', 'Perfectionniste', 'IndÃ©cis', 'Secret', 'Vantard', 'ColÃ©rique', 'NÃ©gligent', 'Trop prudent', 'Ã‰goÃ¯ste']
    };

    const fearOptions = {
      en: ['Fear of heights', 'Fear of spiders', 'Fear of the dark', 'Fear of being alone', 'Fear of loud noises'],
      de: ['HÃ¶henangst', 'Angst vor Spinnen', 'Angst vor der Dunkelheit', 'Angst allein zu sein', 'Angst vor lauten GerÃ¤uschen'],
      fr: ['Peur du vide', 'Peur des araignÃ©es', 'Peur du noir', 'Peur d\'Ãªtre seul', 'Peur des bruits forts']
    };

    const relationshipTypes = [
      { value: { en: 'Best Friends with', de: 'Beste Freunde mit', fr: 'Meilleurs amis avec' }, inverse: { en: 'Best Friends with', de: 'Beste Freunde mit', fr: 'Meilleurs amis avec' } },
      { value: { en: 'Friends with', de: 'Freunde mit', fr: 'Amis avec' }, inverse: { en: 'Friends with', de: 'Freunde mit', fr: 'Amis avec' } },
      { value: { en: 'Married to', de: 'Verheiratet mit', fr: 'MariÃ©(e) Ã ' }, inverse: { en: 'Married to', de: 'Verheiratet mit', fr: 'MariÃ©(e) Ã ' } },
      { value: { en: 'In a relationship with', de: 'In einer Beziehung mit', fr: 'En relation avec' }, inverse: { en: 'In a relationship with', de: 'In einer Beziehung mit', fr: 'En relation avec' } },
      { value: { en: 'Older Sibling of', de: 'Ã„lteres Geschwister von', fr: 'FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de' }, inverse: { en: 'Younger Sibling of', de: 'JÃ¼ngeres Geschwister von', fr: 'FrÃ¨re/SÅ“ur cadet(te) de' } },
      { value: { en: 'Younger Sibling of', de: 'JÃ¼ngeres Geschwister von', fr: 'FrÃ¨re/SÅ“ur cadet(te) de' }, inverse: { en: 'Older Sibling of', de: 'Ã„lteres Geschwister von', fr: 'FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de' } },
      { value: { en: 'Parent of', de: 'Elternteil von', fr: 'Parent de' }, inverse: { en: 'Child of', de: 'Kind von', fr: 'Enfant de' } },
      { value: { en: 'Child of', de: 'Kind von', fr: 'Enfant de' }, inverse: { en: 'Parent of', de: 'Elternteil von', fr: 'Parent de' } },
      { value: { en: 'Rivals with', de: 'Rivalen mit', fr: 'Rivaux avec' }, inverse: { en: 'Rivals with', de: 'Rivalen mit', fr: 'Rivaux avec' } },
      { value: { en: 'Neighbors with', de: 'Nachbarn mit', fr: 'Voisins avec' }, inverse: { en: 'Neighbors with', de: 'Nachbarn mit', fr: 'Voisins avec' } },
      { value: { en: 'Not Known to', de: 'Nicht bekannt mit', fr: 'Pas connu de' }, inverse: { en: 'Not Known to', de: 'Nicht bekannt mit', fr: 'Pas connu de' } }
    ];

    const translations = {
      en: {
        title: 'AI Story Creator',
        subtitle: 'Create magical stories with AI!',
        selectLanguage: 'Choose your language',
        chooseStoryType: 'Choose Your Story Type',
        createCharacters: 'Create Your Characters',
        characterCreated: 'Character Created!',
        createAnother: 'Create Another Character',
        continueToRelationships: 'Continue to Relationships',
        yourCharacters: 'Your Characters:',
        startCreating: 'Start Creating Character',
        characterName: 'Character Name',
        characterPhoto: 'Character Photo (Optional)',
        uploadPhoto: 'Upload Photo',
        orDescribe: 'OR describe the character',
        characterAge: 'Age',
        hairColor: 'Hair Color',
        otherFeatures: 'Other Features',
        descriptionPlaceholder: 'e.g., Blue eyes, wears glasses, has freckles',
        gender: 'Gender',
        male: 'Male',
        female: 'Female',
        other: 'Unknown',
        age: 'Age',
        strengths: 'Strengths',
        weaknesses: 'Weaknesses',
        selectAtLeast: 'Select at least',
        selected: 'Selected',
        addCustomStrengths: 'Add custom strengths',
        addCustomWeaknesses: 'Add custom weaknesses',
        addCustomFears: 'Add custom fears',
        specialDetails: 'Favorite Animal, Hopes and Other Details (Optional)',
        specialDetailsPlaceholder: 'e.g., Loves dogs, dreams of flying, always wears a red hat',
        fears: 'Fears',
        addCustomRelationship: 'Add custom relationship',
        cancel: 'Cancel',
        saveCharacter: 'Save Character',
        editCharacter: 'Edit',
        defineRelationships: 'Define Character Relationships',
        defineRelationshipsDesc: 'Define how each character relates to the others.',
        is: 'is',
        reverseRelationship: 'Reverse relationship:',
        storySettings: 'Story Settings',
        selectMainCharacters: 'Select Main Characters (max 2)',
        numberOfPages: 'Number of Pages',
        readingLevel: 'Reading Level',
        firstGrade: '1st Grade',
        firstGradeDesc: 'Simple words and short sentences',
        standard: 'Standard',
        standardDesc: 'Age-appropriate vocabulary',
        advanced: 'Advanced',
        advancedDesc: 'Complex words and sentences',
        generateStory: 'Generate Story!',
        creating: 'Creating Your Story...',
        storyReady: 'Your Story is Ready!',
        downloadTXT: 'Download as TXT',
        downloadPDF: 'Download as PDF',
        createAnotherStory: 'Create Another Story',
        back: 'Back',
        next: 'Next',
        exportConfig: 'Export Configuration',
        importConfig: 'Import Configuration',
        charactersCreated: "You've created {count} character{s} so far.",
        mainCharacter: 'Main Character',
        apiKeyRequired: 'API Key Required',
        apiKeyPrompt: 'Please enter your Anthropic API key to generate stories:',
        apiKeyPlaceholder: 'sk-ant-...',
        saveApiKey: 'Save API Key',
        apiKeyNote: 'Your API key is stored locally in your browser and never sent anywhere except to Anthropic.'
      },
      de: {
        title: 'KI-Geschichten-Creator',
        subtitle: 'Erstelle magische Geschichten mit KI!',
        selectLanguage: 'WÃ¤hle deine Sprache',
        chooseStoryType: 'WÃ¤hle deinen Geschichtentyp',
        createCharacters: 'Erstelle deine Charaktere',
        characterCreated: 'Charakter erstellt!',
        createAnother: 'Weiteren Charakter erstellen',
        continueToRelationships: 'Weiter zu Beziehungen',
        yourCharacters: 'Deine Charaktere:',
        startCreating: 'Charakter erstellen beginnen',
        characterName: 'Charaktername',
        characterPhoto: 'Charakterfoto (Optional)',
        uploadPhoto: 'Foto hochladen',
        orDescribe: 'ODER Figur beschreiben',
        characterAge: 'Alter',
        hairColor: 'Haarfarbe',
        otherFeatures: 'Sonstige Merkmale',
        descriptionPlaceholder: 'z.B. Blaue Augen, trÃ¤gt Brille, hat Sommersprossen',
        gender: 'Geschlecht',
        male: 'MÃ¤nnlich',
        female: 'Weiblich',
        other: 'Unbekannt',
        age: 'Alter',
        strengths: 'StÃ¤rken',
        weaknesses: 'SchwÃ¤chen',
        selectAtLeast: 'WÃ¤hle mindestens',
        selected: 'AusgewÃ¤hlt',
        addCustomStrengths: 'Eigene StÃ¤rken hinzufÃ¼gen',
        addCustomWeaknesses: 'Eigene SchwÃ¤chen hinzufÃ¼gen',
        addCustomFears: 'Eigene Ã„ngste hinzufÃ¼gen',
        specialDetails: 'Lieblingstier, Hoffnungen und andere Besonderheiten (Optional)',
        specialDetailsPlaceholder: 'z.B. Liebt Hunde, trÃ¤umt vom Fliegen, trÃ¤gt immer einen roten Hut',
        fears: 'Ã„ngste',
        addCustomRelationship: 'Eigene Beziehung hinzufÃ¼gen',
        cancel: 'Abbrechen',
        saveCharacter: 'Charakter speichern',
        editCharacter: 'Bearbeiten',
        defineRelationships: 'Charakterbeziehungen definieren',
        defineRelationshipsDesc: 'Definiere, wie die Charaktere zueinander stehen.',
        is: 'ist',
        reverseRelationship: 'Umgekehrte Beziehung:',
        storySettings: 'Geschichten-Einstellungen',
        selectMainCharacters: 'Hauptfiguren auswÃ¤hlen (max 2)',
        numberOfPages: 'Anzahl der Seiten',
        readingLevel: 'Lesestufe',
        firstGrade: '1. Klasse',
        firstGradeDesc: 'Einfache WÃ¶rter und kurze SÃ¤tze',
        standard: 'Standard',
        standardDesc: 'Altersgerechter Wortschatz',
        advanced: 'Fortgeschritten',
        advancedDesc: 'Komplexe WÃ¶rter und SÃ¤tze',
        generateStory: 'Geschichte erstellen!',
        creating: 'Erstelle deine Geschichte...',
        storyReady: 'Deine Geschichte ist fertig!',
        downloadTXT: 'Als TXT herunterladen',
        downloadPDF: 'Als PDF herunterladen',
        createAnotherStory: 'Neue Geschichte erstellen',
        back: 'ZurÃ¼ck',
        next: 'Weiter',
        exportConfig: 'Konfiguration exportieren',
        importConfig: 'Konfiguration importieren',
        charactersCreated: 'Du hast bisher {count} Charakter{s} erstellt.',
        mainCharacter: 'Hauptfigur',
        apiKeyRequired: 'API-SchlÃ¼ssel erforderlich',
        apiKeyPrompt: 'Bitte geben Sie Ihren Anthropic API-SchlÃ¼ssel ein:',
        apiKeyPlaceholder: 'sk-ant-...',
        saveApiKey: 'API-SchlÃ¼ssel speichern',
        apiKeyNote: 'Ihr API-SchlÃ¼ssel wird lokal im Browser gespeichert.'
      },
      fr: {
        title: 'CrÃ©ateur d\'Histoires IA',
        subtitle: 'CrÃ©ez des histoires magiques avec l\'IA!',
        selectLanguage: 'Choisissez votre langue',
        chooseStoryType: 'Choisissez votre type d\'histoire',
        createCharacters: 'CrÃ©ez vos personnages',
        characterCreated: 'Personnage crÃ©Ã©!',
        createAnother: 'CrÃ©er un autre personnage',
        continueToRelationships: 'Continuer vers les relations',
        yourCharacters: 'Vos personnages:',
        startCreating: 'Commencer Ã  crÃ©er un personnage',
        characterName: 'Nom du personnage',
        characterPhoto: 'Photo du personnage (Optionnel)',
        uploadPhoto: 'TÃ©lÃ©charger une photo',
        orDescribe: 'OU dÃ©crire le personnage',
        characterAge: 'Ã‚ge',
        hairColor: 'Couleur des cheveux',
        otherFeatures: 'Autres caractÃ©ristiques',
        descriptionPlaceholder: 'par ex. Yeux bleus, porte des lunettes, a des taches de rousseur',
        gender: 'Genre',
        male: 'Masculin',
        female: 'FÃ©minin',
        other: 'Inconnu',
        age: 'Ã‚ge',
        strengths: 'Forces',
        weaknesses: 'Faiblesses',
        selectAtLeast: 'SÃ©lectionnez au moins',
        selected: 'SÃ©lectionnÃ©',
        addCustomStrengths: 'Ajouter des forces personnalisÃ©es',
        addCustomWeaknesses: 'Ajouter des faiblesses personnalisÃ©es',
        addCustomFears: 'Ajouter des peurs personnalisÃ©es',
        specialDetails: 'Animal prÃ©fÃ©rÃ©, espoirs et autres dÃ©tails (Optionnel)',
        specialDetailsPlaceholder: 'par ex. Aime les chiens, rÃªve de voler, porte toujours un chapeau rouge',
        fears: 'Peurs',
        addCustomRelationship: 'Ajouter une relation personnalisÃ©e',
        cancel: 'Annuler',
        saveCharacter: 'Sauvegarder le personnage',
        editCharacter: 'Modifier',
        defineRelationships: 'DÃ©finir les relations entre personnages',
        defineRelationshipsDesc: 'DÃ©finissez comment chaque personnage est liÃ© aux autres.',
        is: 'est',
        reverseRelationship: 'Relation inverse:',
        storySettings: 'ParamÃ¨tres de l\'histoire',
        selectMainCharacters: 'SÃ©lectionner les personnages principaux (max 2)',
        numberOfPages: 'Nombre de pages',
        readingLevel: 'Niveau de lecture',
        firstGrade: '1Ã¨re annÃ©e',
        firstGradeDesc: 'Mots simples et phrases courtes',
        standard: 'Standard',
        standardDesc: 'Vocabulaire adaptÃ© Ã  l\'Ã¢ge',
        advanced: 'AvancÃ©',
        advancedDesc: 'Mots et phrases complexes',
        generateStory: 'GÃ©nÃ©rer l\'histoire!',
        creating: 'CrÃ©ation de votre histoire...',
        storyReady: 'Votre histoire est prÃªte!',
        downloadTXT: 'TÃ©lÃ©charger en TXT',
        downloadPDF: 'TÃ©lÃ©charger en PDF',
        createAnotherStory: 'CrÃ©er une nouvelle histoire',
        back: 'Retour',
        next: 'Suivant',
        exportConfig: 'Exporter la configuration',
        importConfig: 'Importer la configuration',
        charactersCreated: 'Vous avez crÃ©Ã© {count} personnage{s} jusqu\'Ã  prÃ©sent.',
        mainCharacter: 'Personnage principal',
        apiKeyRequired: 'ClÃ© API requise',
        apiKeyPrompt: 'Veuillez entrer votre clÃ© API Anthropic:',
        apiKeyPlaceholder: 'sk-ant-...',
        saveApiKey: 'Sauvegarder la clÃ© API',
        apiKeyNote: 'Votre clÃ© API est stockÃ©e localement dans votre navigateur.'
      }
    };

    function StoryCreator() {
      const [language, setLanguage] = useState('de');
      const [step, setStep] = useState(0);
      const [storyType, setStoryType] = useState('');
      const [characters, setCharacters] = useState([]);
      const [currentCharacter, setCurrentCharacter] = useState(null);
      const [showCharacterCreated, setShowCharacterCreated] = useState(false);
      const [customStrengths, setCustomStrengths] = useState([]);
      const [customWeaknesses, setCustomWeaknesses] = useState([]);
      const [customFears, setCustomFears] = useState([]);
      const [customRelationships, setCustomRelationships] = useState([]);
      const [newStrength, setNewStrength] = useState('');
      const [newWeakness, setNewWeakness] = useState('');
      const [newFear, setNewFear] = useState('');
      const [newRelationship, setNewRelationship] = useState('');
      const [relationships, setRelationships] = useState({});
      const [pages, setPages] = useState(5);
      const [languageLevel, setLanguageLevel] = useState('standard');
      const [mainCharacters, setMainCharacters] = useState([]);
      const [generatedStory, setGeneratedStory] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [apiKey, setApiKey] = useState('');
      const [showApiKeyPrompt, setShowApiKeyPrompt] = useState(false);
      const [tempApiKey, setTempApiKey] = useState('');

      useEffect(() => {
        const savedApiKey = localStorage.getItem('anthropic_api_key');
        if (savedApiKey) {
          setApiKey(savedApiKey);
        }
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, [step, currentCharacter, characters, showCharacterCreated]);

      const t = translations[language];
      const allStrengths = [...defaultStrengths[language], ...customStrengths];
      const allWeaknesses = [...defaultWeaknesses[language], ...customWeaknesses];
      const allFears = [...fearOptions[language], ...customFears];
      const allRelationships = [...relationshipTypes, ...customRelationships.map(rel => ({
        value: { en: rel, de: rel, fr: rel },
        inverse: { en: rel, de: rel, fr: rel }
      }))];

      const detectGender = (name) => {
        const femaleSuffixes = ['a', 'e', 'ie', 'ine', 'elle'];
        const femaleNames = ['sophia', 'emma', 'olivia', 'ava', 'isabella', 'mia', 'charlotte', 'amelia', 'marie', 'anna', 'lisa', 'julia', 'sarah', 'laura', 'lena'];
        const maleNames = ['liam', 'noah', 'oliver', 'james', 'lucas', 'max', 'leon', 'paul', 'ben', 'tom', 'felix', 'lukas', 'tim', 'jan', 'finn'];

        const lowerName = name.toLowerCase();

        if (femaleNames.some(n => lowerName.includes(n))) return 'female';
        if (maleNames.some(n => lowerName.includes(n))) return 'male';
        if (femaleSuffixes.some(suffix => lowerName.endsWith(suffix))) return 'female';

        return 'other';
      };

      const getInverseRelationship = (relationship) => {
        const rel = relationshipTypes.find(r => r.value[language] === relationship);
        return rel ? rel.inverse[language] : relationship;
      };

      const saveApiKeyToStorage = () => {
        if (tempApiKey.trim()) {
          localStorage.setItem('anthropic_api_key', tempApiKey.trim());
          setApiKey(tempApiKey.trim());
          setShowApiKeyPrompt(false);
          setTempApiKey('');
        }
      };

      const generateStory = async () => {
        if (!apiKey) {
          setShowApiKeyPrompt(true);
          return;
        }

        setIsGenerating(true);

        const characterDescriptions = characters.map(char => {
          const isMain = mainCharacters.includes(char.id) ? ' (MAIN CHARACTER)' : '';
          return `${char.name}${isMain} (${char.gender}, ${char.age} years old): ${t.strengths}: ${char.strengths.join(', ')}, ${t.weaknesses}: ${char.weaknesses.join(', ')}, ${t.specialDetails}: ${char.specialDetails || 'none'}, ${t.fears}: ${char.fears.join(', ') || 'none'}`;
        }).join('\\n');

        const relationshipDescriptions = Object.entries(relationships)
          .filter(([key, type]) => {
            const [char1Id, _] = key.split('-').map(Number);
            const char1Index = characters.findIndex(c => c.id === char1Id);
            const char2Index = characters.findIndex(c => c.id === parseInt(key.split('-')[1]));
            return type !== 'Not Known to' && char1Index < char2Index;
          })
          .map(([key, type]) => {
            const [char1Id, char2Id] = key.split('-').map(Number);
            const char1 = characters.find(c => c.id === char1Id);
            const char2 = characters.find(c => c.id === char2Id);
            return `${char1?.name} ${t.is} ${type} ${char2?.name}`;
          }).join('\\n');

        const languageInstructions = {
          'en': {
            '1st-grade': 'Use very simple words and short sentences suitable for 1st graders who are just learning to read.',
            'standard': 'Use age-appropriate vocabulary and sentence structure for elementary school children.',
            'advanced': 'Use more complex vocabulary and varied sentence structure for advanced readers.'
          },
          'de': {
            '1st-grade': 'Verwende sehr einfache WÃ¶rter und kurze SÃ¤tze, die fÃ¼r ErstklÃ¤ssler geeignet sind, die gerade lesen lernen.',
            'standard': 'Verwende altersgerechtes Vokabular und Satzstruktur fÃ¼r Grundschulkinder.',
            'advanced': 'Verwende komplexeres Vokabular und abwechslungsreiche Satzstruktur fÃ¼r fortgeschrittene Leser.'
          },
          'fr': {
            '1st-grade': 'Utilisez des mots trÃ¨s simples et des phrases courtes adaptÃ©es aux Ã©lÃ¨ves de 1Ã¨re annÃ©e qui apprennent Ã  lire.',
            'standard': 'Utilisez un vocabulaire et une structure de phrase adaptÃ©s Ã  l\'Ã¢ge pour les enfants de l\'Ã©cole primaire.',
            'advanced': 'Utilisez un vocabulaire plus complexe et une structure de phrase variÃ©e pour les lecteurs avancÃ©s.'
          }
        };

        const storyTypeName = storyTypes.find(t => t.id === storyType)?.name[language] || 'adventure';

        const prompt = `Create a ${pages}-page children's story about a ${storyTypeName} in ${language === 'de' ? 'German' : language === 'fr' ? 'French' : 'English'}.

Characters:
${characterDescriptions}

Relationships:
${relationshipDescriptions}

Language Level: ${languageInstructions[language][languageLevel]}

Please write an engaging, age-appropriate story that incorporates all the characters, their traits, and relationships. Focus especially on the main character(s). Structure it with clear page breaks (use "--- Page X ---" markers). Make it exciting, positive, and include a meaningful lesson or resolution. Each page should be a distinct scene or moment in the story. Write the complete story without truncation. The story should be written entirely in ${language === 'de' ? 'German' : language === 'fr' ? 'French' : 'English'}.`;

        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000,
              messages: [
                { role: 'user', content: prompt }
              ]
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error('API Error:', errorData);
            throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
          }

          const data = await response.json();

          if (!data.content || data.content.length === 0) {
            throw new Error('No content received from API');
          }

          const storyText = data.content
            .filter(block => block.type === 'text')
            .map(block => block.text)
            .join('\\n');

          if (!storyText) {
            throw new Error('Story text is empty');
          }

          setGeneratedStory(storyText);
          setStep(6);
        } catch (error) {
          console.error('Error generating story:', error);
          setGeneratedStory(`Sorry, there was an error generating your story: ${error.message}\\n\\nPlease check your API key and try again!`);
          setStep(6);
        } finally {
          setIsGenerating(false);
        }
      };

      const downloadStory = (format) => {
        try {
          const storyTitle = `${storyTypes.find(t => t.id === storyType)?.name[language] || 'Story'} - ${new Date().toLocaleDateString()}`;

          if (format === 'txt') {
            const blob = new Blob([generatedStory], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${storyTitle}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          } else if (format === 'pdf') {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (printWindow) {
              const htmlContent = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>${storyTitle}</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; }
      h1 { color: #7c3aed; margin-bottom: 20px; }
      p { margin-bottom: 10px; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <h1>${storyTitle}</h1>
    <p>${generatedStory.replace(/\n/g, '<br>')}</p>
  </body>
</html>`;
              printWindow.document.write(htmlContent);
              printWindow.document.close();
              setTimeout(() => {
                printWindow.print();
              }, 500);
            } else {
              alert('Popup blocked. Please allow popups.');
            }
          }
        } catch (error) {
          console.error('Download error:', error);
          alert('Download error: ' + error.message);
        }
      };

      const exportConfiguration = () => {
        try {
          const config = {
            version: '1.0',
            language,
            storyType,
            characters: characters.map(char => ({
              id: char.id,
              name: char.name,
              gender: char.gender,
              age: char.age,
              hairColor: char.hairColor || '',
              otherFeatures: char.otherFeatures || '',
              strengths: char.strengths,
              weaknesses: char.weaknesses,
              specialDetails: char.specialDetails || '',
              fears: char.fears
            })),
            customStrengths,
            customWeaknesses,
            customFears,
            customRelationships,
            relationships,
            pages,
            languageLevel,
            mainCharacters
          };

          const jsonString = JSON.stringify(config, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `story-config-${Date.now()}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Export error:', error);
          alert('Export error: ' + error.message);
        }
      };

      const importConfiguration = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const config = JSON.parse(event.target.result);
              setLanguage(config.language || 'de');
              setStoryType(config.storyType || '');
              setCharacters(config.characters || []);
              setCustomStrengths(config.customStrengths || []);
              setCustomWeaknesses(config.customWeaknesses || []);
              setCustomFears(config.customFears || []);
              setCustomRelationships(config.customRelationships || []);
              setRelationships(config.relationships || {});
              setPages(config.pages || 5);
              setLanguageLevel(config.languageLevel || 'standard');
              setMainCharacters(config.mainCharacters || []);
              setStep(1);
              alert('Configuration imported successfully!');
            } catch (error) {
              console.error('Import error:', error);
              alert('Error loading configuration file');
            }
          };
          reader.readAsText(file);
        }
      };

      // Render functions would be too long to include in a single response
      // Continuing in the next section...

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-100 via-pink-50 to-blue-100 p-4 md:p-8">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-8">
              <h1 className="text-4xl md:text-5xl font-bold text-purple-700 mb-2">
                âœ¨ {t.title} âœ¨
              </h1>
              <p className="text-gray-600">{t.subtitle}</p>
            </div>

            {showApiKeyPrompt && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-8 max-w-md w-full">
                  <h2 className="text-2xl font-bold text-purple-700 mb-4">{t.apiKeyRequired}</h2>
                  <p className="text-gray-600 mb-4">{t.apiKeyPrompt}</p>
                  <input
                    type="password"
                    value={tempApiKey}
                    onChange={(e) => setTempApiKey(e.target.value)}
                    placeholder={t.apiKeyPlaceholder}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4"
                  />
                  <p className="text-xs text-gray-500 mb-4">{t.apiKeyNote}</p>
                  <div className="flex gap-4">
                    <button
                      onClick={() => setShowApiKeyPrompt(false)}
                      className="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400"
                    >
                      {t.cancel}
                    </button>
                    <button
                      onClick={saveApiKeyToStorage}
                      className="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600"
                    >
                      {t.saveApiKey}
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8">
              <div className="text-center">
                <p className="text-lg text-gray-700 mb-4">Welcome to AI Story Creator!</p>
                <p className="text-sm text-gray-600">This is a demo version. Full implementation with all features coming soon.</p>
                <p className="text-sm text-gray-600 mt-2">To use this app, you'll need an Anthropic API key. Get one at <a href="https://console.anthropic.com/" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">console.anthropic.com</a></p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<StoryCreator />);
  </script>
</body>
</html>