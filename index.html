<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magical Story</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Libre+Baskerville:wght@400&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    .font-title {
      font-family: 'Cinzel', serif;
      font-weight: 700;
    }
    .font-body {
      font-family: 'Libre Baskerville', serif;
      font-weight: 400;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // Lucide Icons Component Wrapper
    const Icon = ({ name, size = 24, className = "", ...props }) => {
      useEffect(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, []);
      return React.createElement('i', {
        'data-lucide': name,
        className,
        style: { width: size, height: size },
        ...props
      });
    };

    const storyTypes = [
      { id: 'pirate', name: { en: 'Pirate Adventure', de: 'Piraten-Abenteuer', fr: 'Aventure de Pirates' }, emoji: 'ðŸ´â€â˜ ï¸' },
      { id: 'cowboy', name: { en: 'Wild West', de: 'Wilder Westen', fr: 'Far West' }, emoji: 'ðŸ¤ ' },
      { id: 'fireman', name: { en: 'Brave Firefighter', de: 'Tapferer Feuerwehrmann', fr: 'Pompier Courageux' }, emoji: 'ðŸš’' },
      { id: 'unicorn', name: { en: 'Magical Unicorn', de: 'Magisches Einhorn', fr: 'Licorne Magique' }, emoji: 'ðŸ¦„' },
      { id: 'ninja', name: { en: 'Secret Ninja', de: 'Geheimer Ninja', fr: 'Ninja Secret' }, emoji: 'ðŸ¥·' },
      { id: 'space', name: { en: 'Space Explorer', de: 'Weltraum-Entdecker', fr: 'Explorateur Spatial' }, emoji: 'ðŸš€' },
      { id: 'dinosaur', name: { en: 'Dinosaur World', de: 'Dinosaurier-Welt', fr: 'Monde des Dinosaures' }, emoji: 'ðŸ¦–' },
      { id: 'princess', name: { en: 'Princess Story', de: 'Prinzessinnen-Geschichte', fr: 'Histoire de Princesse' }, emoji: 'ðŸ‘‘' },
      { id: 'knight', name: { en: 'Knight Adventure', de: 'Ritter-Abenteuer', fr: 'Aventure de Chevalier' }, emoji: 'âš”ï¸' },
      { id: 'detective', name: { en: 'Detective Mystery', de: 'Detektiv-Geheimnis', fr: 'MystÃ¨re de DÃ©tective' }, emoji: 'ðŸ”' }
    ];

    const defaultStrengths = {
      en: ['Brave', 'Smart', 'Kind', 'Strong', 'Fast', 'Creative', 'Funny', 'Leader', 'Helpful', 'Patient', 'Honest', 'Loyal', 'Curious', 'Determined', 'Caring', 'Confident', 'Cheerful', 'Generous', 'Clever', 'Adventurous', 'Resourceful', 'Protective', 'Imaginative', 'Hardworking', 'Trustworthy'],
      de: ['Mutig', 'Klug', 'Freundlich', 'Stark', 'Schnell', 'Kreativ', 'Lustig', 'FÃ¼hrungspersÃ¶nlichkeit', 'Hilfsbereit', 'Geduldig', 'Ehrlich', 'Treu', 'Neugierig', 'Entschlossen', 'FÃ¼rsorglich', 'Selbstbewusst', 'FrÃ¶hlich', 'GroÃŸzÃ¼gig', 'Schlau', 'Abenteuerlustig', 'Einfallsreich', 'BeschÃ¼tzend', 'Fantasievoll', 'FleiÃŸig', 'VertrauenswÃ¼rdig'],
      fr: ['Courageux', 'Intelligent', 'Gentil', 'Fort', 'Rapide', 'CrÃ©atif', 'DrÃ´le', 'Leader', 'Serviable', 'Patient', 'HonnÃªte', 'Loyal', 'Curieux', 'DÃ©terminÃ©', 'AttentionnÃ©', 'Confiant', 'Joyeux', 'GÃ©nÃ©reux', 'Astucieux', 'Aventureux', 'DÃ©brouillard', 'Protecteur', 'Imaginatif', 'Travailleur', 'Digne de confiance']
    };

    const defaultWeaknesses = {
      en: ['Shy', 'Clumsy', 'Impatient', 'Forgetful', 'Messy', 'Talkative', 'Stubborn', 'Lazy', 'Greedy', 'Jealous', 'Anxious', 'Distracted', 'Reckless', 'Bossy', 'Easily scared', 'Too trusting', 'Perfectionist', 'Indecisive', 'Secretive', 'Boastful', 'Quick-tempered', 'Careless', 'Overly cautious', 'Selfish'],
      de: ['SchÃ¼chtern', 'Tollpatschig', 'Ungeduldig', 'Vergesslich', 'Unordentlich', 'GesprÃ¤chig', 'Stur', 'Faul', 'Gierig', 'EifersÃ¼chtig', 'Ã„ngstlich', 'Abgelenkt', 'Leichtsinnig', 'HerrschsÃ¼chtig', 'Leicht Ã¤ngstlich', 'Zu vertrauensvoll', 'Perfektionist', 'Unentschlossen', 'Verschlossen', 'Prahlerisch', 'JÃ¤hzornig', 'NachlÃ¤ssig', 'Ãœbervorsichtig', 'Egoistisch'],
      fr: ['Timide', 'Maladroit', 'Impatient', 'Distrait', 'DÃ©sordonnÃ©', 'Bavard', 'TÃªtu', 'Paresseux', 'Avide', 'Jaloux', 'Anxieux', 'Distrait', 'Imprudent', 'Autoritaire', 'Facilement effrayÃ©', 'Trop confiant', 'Perfectionniste', 'IndÃ©cis', 'Secret', 'Vantard', 'ColÃ©rique', 'NÃ©gligent', 'Trop prudent', 'Ã‰goÃ¯ste']
    };

    const fearOptions = {
      en: ['Fear of heights', 'Fear of spiders', 'Fear of the dark', 'Fear of being alone', 'Fear of loud noises'],
      de: ['HÃ¶henangst', 'Angst vor Spinnen', 'Angst vor der Dunkelheit', 'Angst allein zu sein', 'Angst vor lauten GerÃ¤uschen'],
      fr: ['Peur du vide', 'Peur des araignÃ©es', 'Peur du noir', 'Peur d\'Ãªtre seul', 'Peur des bruits forts']
    };

    const relationshipTypes = [
      { value: { en: 'Best Friends with', de: 'Beste Freunde mit', fr: 'Meilleurs amis avec' }, inverse: { en: 'Best Friends with', de: 'Beste Freunde mit', fr: 'Meilleurs amis avec' } },
      { value: { en: 'Friends with', de: 'Freunde mit', fr: 'Amis avec' }, inverse: { en: 'Friends with', de: 'Freunde mit', fr: 'Amis avec' } },
      { value: { en: 'Married to', de: 'Verheiratet mit', fr: 'MariÃ©(e) Ã ' }, inverse: { en: 'Married to', de: 'Verheiratet mit', fr: 'MariÃ©(e) Ã ' } },
      { value: { en: 'In a relationship with', de: 'In einer Beziehung mit', fr: 'En relation avec' }, inverse: { en: 'In a relationship with', de: 'In einer Beziehung mit', fr: 'En relation avec' } },
      { value: { en: 'Older Sibling of', de: 'Ã„lteres Geschwister von', fr: 'FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de' }, inverse: { en: 'Younger Sibling of', de: 'JÃ¼ngeres Geschwister von', fr: 'FrÃ¨re/SÅ“ur cadet(te) de' } },
      { value: { en: 'Younger Sibling of', de: 'JÃ¼ngeres Geschwister von', fr: 'FrÃ¨re/SÅ“ur cadet(te) de' }, inverse: { en: 'Older Sibling of', de: 'Ã„lteres Geschwister von', fr: 'FrÃ¨re/SÅ“ur aÃ®nÃ©(e) de' } },
      { value: { en: 'Parent of', de: 'Elternteil von', fr: 'Parent de' }, inverse: { en: 'Child of', de: 'Kind von', fr: 'Enfant de' } },
      { value: { en: 'Child of', de: 'Kind von', fr: 'Enfant de' }, inverse: { en: 'Parent of', de: 'Elternteil von', fr: 'Parent de' } },
      { value: { en: 'Rivals with', de: 'Rivalen mit', fr: 'Rivaux avec' }, inverse: { en: 'Rivals with', de: 'Rivalen mit', fr: 'Rivaux avec' } },
      { value: { en: 'Neighbors with', de: 'Nachbarn mit', fr: 'Voisins avec' }, inverse: { en: 'Neighbors with', de: 'Nachbarn mit', fr: 'Voisins avec' } },
      { value: { en: 'Not Known to', de: 'Nicht bekannt mit', fr: 'Pas connu de' }, inverse: { en: 'Not Known to', de: 'Nicht bekannt mit', fr: 'Pas connu de' } }
    ];

    const translations = {
      en: {
        title: 'Magical Story',
        subtitle: 'Personalize your story to create magic',
        heroTitle: 'Become the hero of your story',
        heroSubtitle: '',
        heroDescription: 'Turn your wildest ideas into a breathtaking personalized tale.',
        bookText: 'Get a beautifully printed book and make someone feel like the legend they truly are.',
        startJourney: 'Start Your Adventure',
        selectLanguage: 'Choose your language',
        chooseStoryType: 'Choose Your Story Type',
        addCustomStoryType: 'Add Custom Story Type',
        storyTypeName: 'Story Type Name',
        storyTypeEmoji: 'Emoji',
        addStoryType: 'Add',
        createCharacters: 'Create Your Characters',
        characterCreated: 'Character Created!',
        createAnother: 'Create Another Character',
        continueToRelationships: 'Continue to Relationships',
        yourCharacters: 'Your Characters:',
        startCreating: 'Start Creating Character',
        characterName: 'Character Name',
        characterPhoto: 'Character Photo (Optional)',
        uploadPhoto: 'Upload Photo',
        orDescribe: 'OR describe the character',
        characterAge: 'Age',
        hairColor: 'Hair Color',
        otherFeatures: 'Other Features',
        descriptionPlaceholder: 'e.g., Blue eyes, wears glasses, has freckles',
        gender: 'Gender',
        male: 'Male',
        female: 'Female',
        other: 'Unknown',
        age: 'Age',
        strengths: 'Strengths',
        weaknesses: 'Weaknesses',
        selectAtLeast: 'Select at least',
        selected: 'Selected',
        addCustomStrengths: 'Add custom strengths',
        addCustomWeaknesses: 'Add custom weaknesses',
        addCustomFears: 'Add custom fears',
        specialDetails: 'Favorite Animal, Hopes and Other Details (Optional)',
        specialDetailsPlaceholder: 'e.g., Loves dogs, dreams of flying, always wears a red hat',
        fears: 'Fears',
        addCustomRelationship: 'Add custom relationship',
        cancel: 'Cancel',
        saveCharacter: 'Save Character',
        editCharacter: 'Edit',
        deleteCharacter: 'Delete',
        defineRelationships: 'Define Character Relationships',
        defineRelationshipsDesc: 'Define how each character relates to the others.',
        is: 'is',
        reverseRelationship: 'Reverse relationship:',
        storySettings: 'Story Settings',
        selectMainCharacters: 'Select Main Characters (max 2)',
        numberOfPages: 'Number of Pages',
        readingLevel: 'Reading Level',
        firstGrade: '1st Grade',
        firstGradeDesc: 'Simple words and short sentences',
        standard: 'Standard',
        standardDesc: 'Age-appropriate vocabulary',
        advanced: 'Advanced',
        advancedDesc: 'Complex words and sentences',
        generateStory: 'Generate Story!',
        creating: 'Creating Your Story...',
        storyReady: 'Your Story is Ready!',
        downloadTXT: 'Download as TXT',
        downloadPDF: 'Download as PDF',
        downloadPrompt: 'Download Prompt',
        viewPrompt: 'View Prompt',
        hidePrompt: 'Hide Prompt',
        promptUsed: 'Prompt Used to Generate Story:',
        createAnotherStory: 'Create Another Story',
        back: 'Back',
        next: 'Next',
        exportConfig: 'Export Configuration',
        importConfig: 'Import Configuration',
        charactersCreated: "You've created {count} character{s} so far.",
        mainCharacter: 'Main Character',
        apiKeyRequired: 'API Key Required',
        apiKeyPrompt: 'Please enter your Anthropic API key to generate stories:',
        apiKeyPlaceholder: 'sk-ant-...',
        saveApiKey: 'Save API Key',
        apiKeyNote: 'Your API key is stored locally in your browser and never sent anywhere except to Anthropic.'
      },
      de: {
        title: 'Magical Story',
        subtitle: 'Personalisiere deine Geschichte fÃ¼r Magie',
        heroTitle: 'Werde zum Helden deiner Geschichte',
        heroSubtitle: '',
        heroDescription: 'Verwandle deine wildesten Ideen in eine atemberaubende personalisierte Geschichte.',
        bookText: 'Erhalte ein wunderschÃ¶n gedrucktes Buch und gib jemandem das GefÃ¼hl, die Legende zu sein, die er wirklich ist.',
        startJourney: 'Starte dein Abenteuer',
        selectLanguage: 'WÃ¤hle deine Sprache',
        chooseStoryType: 'WÃ¤hle deinen Geschichtentyp',
        addCustomStoryType: 'Eigenen Geschichtentyp hinzufÃ¼gen',
        storyTypeName: 'Name des Geschichtentyps',
        storyTypeEmoji: 'Emoji',
        addStoryType: 'HinzufÃ¼gen',
        createCharacters: 'Erstelle deine Charaktere',
        characterCreated: 'Charakter erstellt!',
        createAnother: 'Weiteren Charakter erstellen',
        continueToRelationships: 'Weiter zu Beziehungen',
        yourCharacters: 'Deine Charaktere:',
        startCreating: 'Charakter erstellen beginnen',
        characterName: 'Charaktername',
        characterPhoto: 'Charakterfoto (Optional)',
        uploadPhoto: 'Foto hochladen',
        orDescribe: 'ODER Figur beschreiben',
        characterAge: 'Alter',
        hairColor: 'Haarfarbe',
        otherFeatures: 'Sonstige Merkmale',
        descriptionPlaceholder: 'z.B. Blaue Augen, trÃ¤gt Brille, hat Sommersprossen',
        gender: 'Geschlecht',
        male: 'MÃ¤nnlich',
        female: 'Weiblich',
        other: 'Unbekannt',
        age: 'Alter',
        strengths: 'StÃ¤rken',
        weaknesses: 'SchwÃ¤chen',
        selectAtLeast: 'WÃ¤hle mindestens',
        selected: 'AusgewÃ¤hlt',
        addCustomStrengths: 'Eigene StÃ¤rken hinzufÃ¼gen',
        addCustomWeaknesses: 'Eigene SchwÃ¤chen hinzufÃ¼gen',
        addCustomFears: 'Eigene Ã„ngste hinzufÃ¼gen',
        specialDetails: 'Lieblingstier, Hoffnungen und andere Besonderheiten (Optional)',
        specialDetailsPlaceholder: 'z.B. Liebt Hunde, trÃ¤umt vom Fliegen, trÃ¤gt immer einen roten Hut',
        fears: 'Ã„ngste',
        addCustomRelationship: 'Eigene Beziehung hinzufÃ¼gen',
        cancel: 'Abbrechen',
        saveCharacter: 'Charakter speichern',
        editCharacter: 'Bearbeiten',
        deleteCharacter: 'LÃ¶schen',
        defineRelationships: 'Charakterbeziehungen definieren',
        defineRelationshipsDesc: 'Definiere, wie die Charaktere zueinander stehen.',
        is: 'ist',
        reverseRelationship: 'Umgekehrte Beziehung:',
        storySettings: 'Geschichten-Einstellungen',
        selectMainCharacters: 'Hauptfiguren auswÃ¤hlen (max 2)',
        numberOfPages: 'Anzahl der Seiten',
        readingLevel: 'Lesestufe',
        firstGrade: '1. Klasse',
        firstGradeDesc: 'Einfache WÃ¶rter und kurze SÃ¤tze',
        standard: 'Standard',
        standardDesc: 'Altersgerechter Wortschatz',
        advanced: 'Fortgeschritten',
        advancedDesc: 'Komplexe WÃ¶rter und SÃ¤tze',
        generateStory: 'Geschichte erstellen!',
        creating: 'Erstelle deine Geschichte...',
        storyReady: 'Deine Geschichte ist fertig!',
        downloadTXT: 'Als TXT herunterladen',
        downloadPDF: 'Als PDF herunterladen',
        downloadPrompt: 'Prompt herunterladen',
        viewPrompt: 'Prompt anzeigen',
        hidePrompt: 'Prompt ausblenden',
        promptUsed: 'Verwendeter Prompt:',
        createAnotherStory: 'Neue Geschichte erstellen',
        back: 'ZurÃ¼ck',
        next: 'Weiter',
        exportConfig: 'Konfiguration exportieren',
        importConfig: 'Konfiguration importieren',
        charactersCreated: 'Du hast bisher {count} Charakter{s} erstellt.',
        mainCharacter: 'Hauptfigur',
        apiKeyRequired: 'API-SchlÃ¼ssel erforderlich',
        apiKeyPrompt: 'Bitte geben Sie Ihren Anthropic API-SchlÃ¼ssel ein:',
        apiKeyPlaceholder: 'sk-ant-...',
        saveApiKey: 'API-SchlÃ¼ssel speichern',
        apiKeyNote: 'Ihr API-SchlÃ¼ssel wird lokal im Browser gespeichert.'
      },
      fr: {
        title: 'Magical Story',
        subtitle: 'Personnalisez votre histoire pour crÃ©er la magie',
        heroTitle: 'Devenez le hÃ©ros de votre histoire',
        heroSubtitle: '',
        heroDescription: 'Transformez vos idÃ©es les plus folles en un conte personnalisÃ© Ã©poustouflant.',
        bookText: 'Obtenez un livre magnifiquement imprimÃ© et donnez Ã  quelqu\'un le sentiment d\'Ãªtre la lÃ©gende qu\'il est vraiment.',
        startJourney: 'Commencez Votre Aventure',
        selectLanguage: 'Choisissez votre langue',
        chooseStoryType: 'Choisissez votre type d\'histoire',
        addCustomStoryType: 'Ajouter un type d\'histoire personnalisÃ©',
        storyTypeName: 'Nom du type d\'histoire',
        storyTypeEmoji: 'Emoji',
        addStoryType: 'Ajouter',
        createCharacters: 'CrÃ©ez vos personnages',
        characterCreated: 'Personnage crÃ©Ã©!',
        createAnother: 'CrÃ©er un autre personnage',
        continueToRelationships: 'Continuer vers les relations',
        yourCharacters: 'Vos personnages:',
        startCreating: 'Commencer Ã  crÃ©er un personnage',
        characterName: 'Nom du personnage',
        characterPhoto: 'Photo du personnage (Optionnel)',
        uploadPhoto: 'TÃ©lÃ©charger une photo',
        orDescribe: 'OU dÃ©crire le personnage',
        characterAge: 'Ã‚ge',
        hairColor: 'Couleur des cheveux',
        otherFeatures: 'Autres caractÃ©ristiques',
        descriptionPlaceholder: 'par ex. Yeux bleus, porte des lunettes, a des taches de rousseur',
        gender: 'Genre',
        male: 'Masculin',
        female: 'FÃ©minin',
        other: 'Inconnu',
        age: 'Ã‚ge',
        strengths: 'Forces',
        weaknesses: 'Faiblesses',
        selectAtLeast: 'SÃ©lectionnez au moins',
        selected: 'SÃ©lectionnÃ©',
        addCustomStrengths: 'Ajouter des forces personnalisÃ©es',
        addCustomWeaknesses: 'Ajouter des faiblesses personnalisÃ©es',
        addCustomFears: 'Ajouter des peurs personnalisÃ©es',
        specialDetails: 'Animal prÃ©fÃ©rÃ©, espoirs et autres dÃ©tails (Optionnel)',
        specialDetailsPlaceholder: 'par ex. Aime les chiens, rÃªve de voler, porte toujours un chapeau rouge',
        fears: 'Peurs',
        addCustomRelationship: 'Ajouter une relation personnalisÃ©e',
        cancel: 'Annuler',
        saveCharacter: 'Sauvegarder le personnage',
        editCharacter: 'Modifier',
        deleteCharacter: 'Supprimer',
        defineRelationships: 'DÃ©finir les relations entre personnages',
        defineRelationshipsDesc: 'DÃ©finissez comment chaque personnage est liÃ© aux autres.',
        is: 'est',
        reverseRelationship: 'Relation inverse:',
        storySettings: 'ParamÃ¨tres de l\'histoire',
        selectMainCharacters: 'SÃ©lectionner les personnages principaux (max 2)',
        numberOfPages: 'Nombre de pages',
        readingLevel: 'Niveau de lecture',
        firstGrade: '1Ã¨re annÃ©e',
        firstGradeDesc: 'Mots simples et phrases courtes',
        standard: 'Standard',
        standardDesc: 'Vocabulaire adaptÃ© Ã  l\'Ã¢ge',
        advanced: 'AvancÃ©',
        advancedDesc: 'Mots et phrases complexes',
        generateStory: 'GÃ©nÃ©rer l\'histoire!',
        creating: 'CrÃ©ation de votre histoire...',
        storyReady: 'Votre histoire est prÃªte!',
        downloadTXT: 'TÃ©lÃ©charger en TXT',
        downloadPDF: 'TÃ©lÃ©charger en PDF',
        downloadPrompt: 'TÃ©lÃ©charger le prompt',
        viewPrompt: 'Voir le prompt',
        hidePrompt: 'Masquer le prompt',
        promptUsed: 'Prompt utilisÃ© pour gÃ©nÃ©rer l\'histoire:',
        createAnotherStory: 'CrÃ©er une nouvelle histoire',
        back: 'Retour',
        next: 'Suivant',
        exportConfig: 'Exporter la configuration',
        importConfig: 'Importer la configuration',
        charactersCreated: 'Vous avez crÃ©Ã© {count} personnage{s} jusqu\'Ã  prÃ©sent.',
        mainCharacter: 'Personnage principal',
        apiKeyRequired: 'ClÃ© API requise',
        apiKeyPrompt: 'Veuillez entrer votre clÃ© API Anthropic:',
        apiKeyPlaceholder: 'sk-ant-...',
        saveApiKey: 'Sauvegarder la clÃ© API',
        apiKeyNote: 'Votre clÃ© API est stockÃ©e localement dans votre navigateur.'
      }
    };

    function StoryCreator() {
      // Auto-detect browser language
      const detectBrowserLanguage = () => {
        const browserLang = navigator.language || navigator.userLanguage;
        if (browserLang.startsWith('de')) return 'de';
        if (browserLang.startsWith('fr')) return 'fr';
        return 'en'; // default to English
      };

      const [language, setLanguage] = useState(detectBrowserLanguage());
      const [step, setStep] = useState(0);
      const [storyType, setStoryType] = useState('');
      const [characters, setCharacters] = useState([]);
      const [currentCharacter, setCurrentCharacter] = useState(null);
      const [showCharacterCreated, setShowCharacterCreated] = useState(false);
      const [customStrengths, setCustomStrengths] = useState([]);
      const [customWeaknesses, setCustomWeaknesses] = useState([]);
      const [customFears, setCustomFears] = useState([]);
      const [customRelationships, setCustomRelationships] = useState([]);
      const [newStrength, setNewStrength] = useState('');
      const [newWeakness, setNewWeakness] = useState('');
      const [newFear, setNewFear] = useState('');
      const [newRelationship, setNewRelationship] = useState('');
      const [relationships, setRelationships] = useState({});
      const [pages, setPages] = useState(5);
      const [languageLevel, setLanguageLevel] = useState('standard');
      const [mainCharacters, setMainCharacters] = useState([]);
      const [generatedStory, setGeneratedStory] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [apiKey, setApiKey] = useState('');
      const [showApiKeyPrompt, setShowApiKeyPrompt] = useState(false);
      const [tempApiKey, setTempApiKey] = useState('');
      const [generatedPrompt, setGeneratedPrompt] = useState('');
      const [showPrompt, setShowPrompt] = useState(false);
      const [customStoryTypes, setCustomStoryTypes] = useState([]);
      const [newStoryTypeName, setNewStoryTypeName] = useState('');
      const [newStoryTypeEmoji, setNewStoryTypeEmoji] = useState('ðŸŽ­');
      const [showLanguageDropdown, setShowLanguageDropdown] = useState(false);

      useEffect(() => {
        const savedApiKey = localStorage.getItem('anthropic_api_key');
        if (savedApiKey) {
          setApiKey(savedApiKey);
        }
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, [step, currentCharacter, characters, showCharacterCreated]);

      const t = translations[language];
      const allStrengths = [...defaultStrengths[language], ...customStrengths];
      const allWeaknesses = [...defaultWeaknesses[language], ...customWeaknesses];
      const allFears = [...fearOptions[language], ...customFears];
      const allRelationships = [...relationshipTypes, ...customRelationships.map(rel => ({
        value: { en: rel, de: rel, fr: rel },
        inverse: { en: rel, de: rel, fr: rel }
      }))];
      const allStoryTypes = [...storyTypes, ...customStoryTypes];

      const detectGender = (name) => {
        const femaleSuffixes = ['a', 'e', 'ie', 'ine', 'elle'];
        const femaleNames = ['sophia', 'emma', 'olivia', 'ava', 'isabella', 'mia', 'charlotte', 'amelia', 'marie', 'anna', 'lisa', 'julia', 'sarah', 'laura', 'lena'];
        const maleNames = ['liam', 'noah', 'oliver', 'james', 'lucas', 'max', 'leon', 'paul', 'ben', 'tom', 'felix', 'lukas', 'tim', 'jan', 'finn'];

        const lowerName = name.toLowerCase();

        if (femaleNames.some(n => lowerName.includes(n))) return 'female';
        if (maleNames.some(n => lowerName.includes(n))) return 'male';
        if (femaleSuffixes.some(suffix => lowerName.endsWith(suffix))) return 'female';

        return 'other';
      };

      const getInverseRelationship = (relationship) => {
        const rel = relationshipTypes.find(r => r.value[language] === relationship);
        return rel ? rel.inverse[language] : relationship;
      };

      const saveApiKeyToStorage = () => {
        if (tempApiKey.trim()) {
          localStorage.setItem('anthropic_api_key', tempApiKey.trim());
          setApiKey(tempApiKey.trim());
          setShowApiKeyPrompt(false);
          setTempApiKey('');
        }
      };

      const generateStory = async () => {
        if (!apiKey) {
          setShowApiKeyPrompt(true);
          return;
        }

        setIsGenerating(true);

        const characterDescriptions = characters.map(char => {
          const isMain = mainCharacters.includes(char.id) ? ' (MAIN CHARACTER)' : '';
          return `${char.name}${isMain} (${char.gender}, ${char.age} years old): ${t.strengths}: ${char.strengths.join(', ')}, ${t.weaknesses}: ${char.weaknesses.join(', ')}, ${t.specialDetails}: ${char.specialDetails || 'none'}, ${t.fears}: ${char.fears.join(', ') || 'none'}`;
        }).join('\\n');

        const relationshipDescriptions = Object.entries(relationships)
          .filter(([key, type]) => {
            const [char1Id, _] = key.split('-').map(Number);
            const char1Index = characters.findIndex(c => c.id === char1Id);
            const char2Index = characters.findIndex(c => c.id === parseInt(key.split('-')[1]));
            return type !== 'Not Known to' && char1Index < char2Index;
          })
          .map(([key, type]) => {
            const [char1Id, char2Id] = key.split('-').map(Number);
            const char1 = characters.find(c => c.id === char1Id);
            const char2 = characters.find(c => c.id === char2Id);
            return `${char1?.name} ${t.is} ${type} ${char2?.name}`;
          }).join('\\n');

        const languageInstructions = {
          'en': {
            '1st-grade': 'Use very simple words and short sentences suitable for 1st graders who are just learning to read.',
            'standard': 'Use age-appropriate vocabulary and sentence structure for elementary school children.',
            'advanced': 'Use more complex vocabulary and varied sentence structure for advanced readers.'
          },
          'de': {
            '1st-grade': 'Verwende sehr einfache WÃ¶rter und kurze SÃ¤tze, die fÃ¼r ErstklÃ¤ssler geeignet sind, die gerade lesen lernen.',
            'standard': 'Verwende altersgerechtes Vokabular und Satzstruktur fÃ¼r Grundschulkinder.',
            'advanced': 'Verwende komplexeres Vokabular und abwechslungsreiche Satzstruktur fÃ¼r fortgeschrittene Leser.'
          },
          'fr': {
            '1st-grade': 'Utilisez des mots trÃ¨s simples et des phrases courtes adaptÃ©es aux Ã©lÃ¨ves de 1Ã¨re annÃ©e qui apprennent Ã  lire.',
            'standard': 'Utilisez un vocabulaire et une structure de phrase adaptÃ©s Ã  l\'Ã¢ge pour les enfants de l\'Ã©cole primaire.',
            'advanced': 'Utilisez un vocabulaire plus complexe et une structure de phrase variÃ©e pour les lecteurs avancÃ©s.'
          }
        };

        const storyTypeName = storyTypes.find(t => t.id === storyType)?.name[language] || 'adventure';

        const prompt = `Create a ${pages}-page children's story about a ${storyTypeName} in ${language === 'de' ? 'German' : language === 'fr' ? 'French' : 'English'}.

Characters:
${characterDescriptions}

Relationships:
${relationshipDescriptions}

Language Level: ${languageInstructions[language][languageLevel]}

Please write an engaging, age-appropriate story that incorporates all the characters, their traits, and relationships. Focus especially on the main character(s). Structure it with clear page breaks (use "--- Page X ---" markers). Make it exciting, positive, and include a meaningful lesson or resolution. Each page should be a distinct scene or moment in the story. Write the complete story without truncation. The story should be written entirely in ${language === 'de' ? 'German' : language === 'fr' ? 'French' : 'English'}.`;

        // Save the prompt for display/download
        setGeneratedPrompt(prompt);

        try {
          const response = await fetch('https://magical-story-api.rogerfischer.workers.dev', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              apiKey: apiKey,
              prompt: prompt,
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error('API Error:', errorData);
            throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
          }

          const data = await response.json();

          if (!data.content || data.content.length === 0) {
            throw new Error('No content received from API');
          }

          const storyText = data.content
            .filter(block => block.type === 'text')
            .map(block => block.text)
            .join('\\n');

          if (!storyText) {
            throw new Error('Story text is empty');
          }

          setGeneratedStory(storyText);
          setStep(6);
        } catch (error) {
          console.error('Error generating story:', error);
          setGeneratedStory(`Sorry, there was an error generating your story: ${error.message}\\n\\nPlease check your API key and try again!`);
          setStep(6);
        } finally {
          setIsGenerating(false);
        }
      };

      const downloadPrompt = () => {
        try {
          const promptTitle = `Prompt - ${storyTypes.find(t => t.id === storyType)?.name[language] || 'Story'} - ${new Date().toLocaleDateString()}`;
          const blob = new Blob([generatedPrompt], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${promptTitle}.txt`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Download error:', error);
          alert('Download error: ' + error.message);
        }
      };

      const downloadStory = (format) => {
        try {
          const storyTitle = `${storyTypes.find(t => t.id === storyType)?.name[language] || 'Story'} - ${new Date().toLocaleDateString()}`;

          if (format === 'txt') {
            const blob = new Blob([generatedStory], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${storyTitle}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          } else if (format === 'pdf') {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (printWindow) {
              const htmlContent = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>${storyTitle}</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; }
      h1 { color: #7c3aed; margin-bottom: 20px; }
      p { margin-bottom: 10px; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <h1>${storyTitle}</h1>
    <p>${generatedStory.replace(/\n/g, '<br>')}</p>
  </body>
</html>`;
              printWindow.document.write(htmlContent);
              printWindow.document.close();
              setTimeout(() => {
                printWindow.print();
              }, 500);
            } else {
              alert('Popup blocked. Please allow popups.');
            }
          }
        } catch (error) {
          console.error('Download error:', error);
          alert('Download error: ' + error.message);
        }
      };

      const exportConfiguration = () => {
        try {
          const config = {
            version: '1.0',
            language,
            storyType,
            characters: characters.map(char => ({
              id: char.id,
              name: char.name,
              gender: char.gender,
              age: char.age,
              hairColor: char.hairColor || '',
              otherFeatures: char.otherFeatures || '',
              strengths: char.strengths,
              weaknesses: char.weaknesses,
              specialDetails: char.specialDetails || '',
              fears: char.fears
            })),
            customStrengths,
            customWeaknesses,
            customFears,
            customRelationships,
            customStoryTypes,
            relationships,
            pages,
            languageLevel,
            mainCharacters
          };

          const jsonString = JSON.stringify(config, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `story-config-${Date.now()}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Export error:', error);
          alert('Export error: ' + error.message);
        }
      };

      const importConfiguration = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const config = JSON.parse(event.target.result);
              setLanguage(config.language || 'de');
              setStoryType(config.storyType || '');
              setCharacters(config.characters || []);
              setCustomStrengths(config.customStrengths || []);
              setCustomWeaknesses(config.customWeaknesses || []);
              setCustomFears(config.customFears || []);
              setCustomRelationships(config.customRelationships || []);
              setCustomStoryTypes(config.customStoryTypes || []);
              setRelationships(config.relationships || {});
              setPages(config.pages || 5);
              setLanguageLevel(config.languageLevel || 'standard');
              setMainCharacters(config.mainCharacters || []);
              setStep(1);
              alert('Configuration imported successfully!');
            } catch (error) {
              console.error('Import error:', error);
              alert('Error loading configuration file');
            }
          };
          reader.readAsText(file);
        }
      };

      const startNewCharacter = () => {
        setCurrentCharacter({
          id: Date.now(),
          name: '',
          photo: null,
          photoUrl: null,
          useDescription: false,
          descriptionAge: '',
          hairColor: '',
          otherFeatures: '',
          gender: 'other',
          age: '',
          strengths: [],
          weaknesses: [],
          specialDetails: '',
          fears: []
        });
        setShowCharacterCreated(false);
      };

      const editCharacter = (char) => {
        setCurrentCharacter(char);
        setCharacters(characters.filter(c => c.id !== char.id));
        setShowCharacterCreated(false);
      };

      const deleteCharacter = (charId) => {
        if (confirm(t.deleteCharacter + '?')) {
          setCharacters(characters.filter(c => c.id !== charId));
          // Remove from main characters if present
          setMainCharacters(mainCharacters.filter(id => id !== charId));
          // Remove relationships involving this character
          const newRelationships = {};
          Object.keys(relationships).forEach(key => {
            if (!key.includes(charId.toString())) {
              newRelationships[key] = relationships[key];
            }
          });
          setRelationships(newRelationships);
        }
      };

      const saveCurrentCharacter = () => {
        if (currentCharacter.name &&
            currentCharacter.strengths.length >= 3 &&
            currentCharacter.weaknesses.length >= 2) {
          setCharacters([...characters, currentCharacter]);
          setShowCharacterCreated(true);
          setCurrentCharacter(null);
        }
      };

      const handlePhotoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setCurrentCharacter({
              ...currentCharacter,
              photo: file,
              photoUrl: reader.result
            });
          };
          reader.readAsDataURL(file);
        }
      };

      const handleNameChange = (name) => {
        const detectedGender = detectGender(name);
        setCurrentCharacter({
          ...currentCharacter,
          name,
          gender: detectedGender
        });
      };

      const toggleArrayItem = (field, item) => {
        const currentArray = currentCharacter[field];
        const newArray = currentArray.includes(item)
          ? currentArray.filter(i => i !== item)
          : [...currentArray, item];
        setCurrentCharacter({ ...currentCharacter, [field]: newArray });
      };

      const addCustomStrength = () => {
        if (newStrength && !allStrengths.includes(newStrength)) {
          setCustomStrengths([...customStrengths, newStrength]);
          setCurrentCharacter({
            ...currentCharacter,
            strengths: [...currentCharacter.strengths, newStrength]
          });
          setNewStrength('');
        }
      };

      const addCustomWeakness = () => {
        if (newWeakness && !allWeaknesses.includes(newWeakness)) {
          setCustomWeaknesses([...customWeaknesses, newWeakness]);
          setCurrentCharacter({
            ...currentCharacter,
            weaknesses: [...currentCharacter.weaknesses, newWeakness]
          });
          setNewWeakness('');
        }
      };

      const addCustomFear = () => {
        if (newFear && !allFears.includes(newFear)) {
          setCustomFears([...customFears, newFear]);
          setCurrentCharacter({
            ...currentCharacter,
            fears: [...currentCharacter.fears, newFear]
          });
          setNewFear('');
        }
      };

      const addCustomRelationship = () => {
        if (newRelationship && !customRelationships.includes(newRelationship)) {
          setCustomRelationships([...customRelationships, newRelationship]);
          setNewRelationship('');
        }
      };

      const addCustomStoryType = () => {
        if (newStoryTypeName.trim()) {
          const newType = {
            id: `custom-${Date.now()}`,
            name: { en: newStoryTypeName, de: newStoryTypeName, fr: newStoryTypeName },
            emoji: newStoryTypeEmoji || 'ðŸŽ­'
          };
          setCustomStoryTypes([...customStoryTypes, newType]);
          setNewStoryTypeName('');
          setNewStoryTypeEmoji('ðŸŽ­');
        }
      };

      const toggleMainCharacter = (charId) => {
        if (mainCharacters.includes(charId)) {
          setMainCharacters(mainCharacters.filter(id => id !== charId));
        } else if (mainCharacters.length < 2) {
          setMainCharacters([...mainCharacters, charId]);
        }
      };

      const initializeRelationships = () => {
        const newRelationships = {};
        characters.forEach(char1 => {
          characters.forEach(char2 => {
            if (char1.id !== char2.id) {
              const key = `${char1.id}-${char2.id}`;
              if (!relationships[key]) {
                newRelationships[key] = relationshipTypes[10].value[language];
              } else {
                newRelationships[key] = relationships[key];
              }
            }
          });
        });
        setRelationships({ ...relationships, ...newRelationships });
      };

      const updateRelationship = (char1Id, char2Id, type) => {
        const inverse = getInverseRelationship(type);
        setRelationships({
          ...relationships,
          [`${char1Id}-${char2Id}`]: type,
          [`${char2Id}-${char1Id}`]: inverse
        });
      };

      const areAllRelationshipsDefined = () => {
        for (let i = 0; i < characters.length; i++) {
          for (let j = 0; j < characters.length; j++) {
            if (i !== j) {
              const key = `${characters[i].id}-${characters[j].id}`;
              if (!relationships[key]) return false;
            }
          }
        }
        return true;
      };

      const renderStep0 = () => (
        <div className="flex items-center min-h-[calc(100vh-72px)] px-8 py-8 relative" style={{height: 'calc(100vh - 72px)'}}>
          {/* Decorative Sparkles - Only 4 total */}
          <div className="absolute bottom-10 right-20 text-3xl opacity-50 animate-pulse">âœ¨</div>
          <div className="absolute top-10 right-1/3 text-3xl opacity-50 animate-pulse" style={{animationDelay: '1s'}}>âœ¨</div>
          <div className="absolute bottom-24 left-1/4 text-3xl opacity-50 animate-pulse" style={{animationDelay: '1.5s'}}>âœ¨</div>
          <div className="absolute bottom-1/3 right-1/3 text-3xl opacity-50 animate-pulse" style={{animationDelay: '2s'}}>âœ¨</div>

          <div className="flex gap-8 w-full items-center relative z-10">
            {/* Left Side - Text and Button (1/3) */}
            <div className="space-y-6" style={{width: '30%'}}>
              <div>
                <h1 className="text-5xl font-title text-black mb-4 leading-tight">
                  {t.heroTitle}
                </h1>
                <p className="text-xl font-body text-black mb-3">
                  {t.heroDescription}
                </p>
                <p className="text-xl font-body text-black">
                  {t.bookText}
                </p>
              </div>

              <button
                onClick={() => setStep(1)}
                className="bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 text-white px-8 py-4 rounded-xl text-lg font-bold hover:shadow-2xl transform hover:scale-105 transition-all inline-flex items-center gap-2"
              >
                <Icon name="sparkles" size={24} />
                {t.startJourney}
                <Icon name="arrow-right" size={24} />
              </button>
            </div>

            {/* Right Side - Photos and Video (2/3) */}
            <div className="flex gap-6 items-center" style={{width: '70%'}}>
              {/* Photos Column - Stacked Vertically */}
              <div className="flex flex-col gap-3" style={{width: '35%'}}>
                {/* Real Photo */}
                <div className="text-center">
                  <div className="mb-2">
                    <img src="images/Real person.jpg" alt="Your Picture" className="w-full h-auto object-contain rounded-lg" style={{maxHeight: '160px'}} />
                  </div>
                  <p className="text-sm text-black font-semibold">
                    {language === 'de' ? 'Dein Foto' : language === 'fr' ? 'Votre Photo' : 'Your Picture'}
                  </p>
                </div>

                {/* Arrow Down - Rotated 90 degrees */}
                <div className="flex justify-center my-3">
                  <img src="images/arrow-icon-1162.png" alt="Arrow Down" style={{width: '50px', height: '50px', transform: 'rotate(90deg)'}} />
                </div>

                {/* Avatar */}
                <div className="text-center">
                  <div className="mb-2">
                    <img src="images/Avatar 2.png" alt="Your Character" className="w-full h-auto object-contain rounded-lg" style={{maxHeight: '160px'}} />
                  </div>
                  <p className="text-sm text-black font-semibold">
                    {language === 'de' ? 'Dein Charakter' : language === 'fr' ? 'Votre Personnage' : 'Your Character'}
                  </p>
                </div>
              </div>

              {/* Arrow Right */}
              <div className="flex justify-center items-center" style={{width: '10%'}}>
                <img src="images/arrow-icon-1162.png" alt="Arrow Right" style={{width: '60px', height: '60px'}} />
              </div>

              {/* Video Column */}
              <div className="text-center" style={{width: '55%'}}>
                <div className="rounded-xl overflow-hidden shadow-2xl mb-2" style={{height: '400px'}}>
                  <video
                    autoPlay
                    loop
                    muted
                    playsInline
                    className="w-full h-full object-cover"
                  >
                    <source src="images/Pirat Video2.mp4" type="video/mp4" />
                    Your browser does not support the video tag.
                  </video>
                </div>
                <p className="text-sm text-black font-semibold">
                  {language === 'de' ? 'Deine Geschichte' : language === 'fr' ? 'Votre Histoire' : 'Your Story'}
                </p>
              </div>
            </div>
          </div>
        </div>
      );

      const renderStep1 = () => (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
            <Icon name="book-open" size={24} /> {t.chooseStoryType}
          </h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {allStoryTypes.map(type => (
              <button
                key={type.id}
                onClick={() => setStoryType(type.id)}
                className={`p-6 rounded-xl border-2 transition-all ${
                  storyType === type.id
                    ? 'border-purple-500 bg-purple-50 shadow-lg scale-105'
                    : 'border-gray-200 hover:border-purple-300 hover:shadow-md'
                }`}
              >
                <div className="text-4xl mb-2">{type.emoji}</div>
                <div className="font-semibold text-sm">{type.name[language]}</div>
              </button>
            ))}
          </div>

          <div className="bg-purple-50 border-2 border-purple-200 rounded-xl p-6 mt-6">
            <h3 className="text-lg font-bold text-purple-700 mb-4">{t.addCustomStoryType}</h3>
            <div className="flex gap-3 flex-wrap">
              <input
                type="text"
                value={newStoryTypeEmoji}
                onChange={(e) => setNewStoryTypeEmoji(e.target.value)}
                placeholder={t.storyTypeEmoji}
                className="w-20 px-3 py-2 border-2 border-gray-300 rounded-lg text-center text-2xl"
                maxLength="2"
              />
              <input
                type="text"
                value={newStoryTypeName}
                onChange={(e) => setNewStoryTypeName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addCustomStoryType()}
                placeholder={t.storyTypeName}
                className="flex-1 min-w-[200px] px-4 py-2 border-2 border-gray-300 rounded-lg"
              />
              <button
                onClick={addCustomStoryType}
                className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
              >
                <Icon name="plus" size={20} /> {t.addStoryType}
              </button>
            </div>
          </div>
        </div>
      );

      const renderStep2 = () => {
        const canSave = currentCharacter && currentCharacter.name &&
                        currentCharacter.strengths.length >= 3 &&
                        currentCharacter.weaknesses.length >= 2;

        return (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
              <Icon name="users" size={24} /> {t.createCharacters}
            </h2>

            {characters.length > 0 && (
              <div className="bg-white border-2 border-purple-200 rounded-xl p-6 mb-6">
                <h3 className="text-lg font-bold text-purple-700 mb-4">{t.yourCharacters}</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  {characters.map((char) => (
                    <div key={char.id} className="border border-gray-200 rounded-lg p-4 relative">
                      <div className="absolute top-2 right-2 flex gap-2">
                        <button
                          onClick={() => editCharacter(char)}
                          className="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 flex items-center gap-1"
                        >
                          {t.editCharacter}
                        </button>
                        <button
                          onClick={() => deleteCharacter(char.id)}
                          className="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 flex items-center gap-1"
                        >
                          {t.deleteCharacter}
                        </button>
                      </div>
                      {char.photoUrl && (
                        <img src={char.photoUrl} alt={char.name} className="w-20 h-20 rounded-full mx-auto mb-2 object-cover" />
                      )}
                      <h4 className="font-bold text-center mb-2">{char.name}</h4>
                      <p className="text-sm text-gray-600 text-center mb-1">
                        {char.gender === 'male' ? t.male : char.gender === 'female' ? t.female : t.other}, {char.age} {language === 'de' ? 'Jahre' : language === 'fr' ? 'ans' : 'years'}
                      </p>
                      <p className="text-sm text-gray-600">
                        <strong>{t.strengths}:</strong> {char.strengths.slice(0, 3).join(', ')}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {showCharacterCreated && (
              <div className="bg-green-50 border-2 border-green-300 rounded-xl p-8 text-center">
                <Icon name="check" size={64} className="text-green-500 mx-auto mb-4" />
                <h2 className="text-2xl font-bold text-green-700 mb-4">{t.characterCreated}</h2>
                <p className="text-gray-700 mb-6">
                  {t.charactersCreated.replace('{count}', characters.length).replace('{s}', characters.length > 1 ? 's' : '')}
                </p>
                <div className="flex gap-4 justify-center">
                  <button
                    onClick={startNewCharacter}
                    className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
                  >
                    <Icon name="plus" size={20} /> {t.createAnother}
                  </button>
                  <button
                    onClick={() => {
                      initializeRelationships();
                      setStep(3);
                    }}
                    className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
                  >
                    {t.continueToRelationships} <Icon name="arrow-right" size={20} />
                  </button>
                </div>
              </div>
            )}

            {!currentCharacter && !showCharacterCreated && (
              <div className="bg-purple-50 border-2 border-purple-200 rounded-xl p-12 text-center">
                <p className="text-gray-700 mb-6 text-lg">
                  {characters.length === 0
                    ? t.charactersCreated.replace('{count}', 0).replace('{s}', 's')
                    : t.charactersCreated.replace('{count}', characters.length).replace('{s}', characters.length > 1 ? 's' : '')}
                </p>
                <div className="flex gap-4 justify-center">
                  <button
                    onClick={startNewCharacter}
                    className="bg-blue-500 text-white px-8 py-4 rounded-lg hover:bg-blue-600 font-bold text-lg flex items-center gap-2"
                  >
                    <Icon name="plus" size={24} /> {t.startCreating}
                  </button>
                  {characters.length > 0 && (
                    <button
                      onClick={() => {
                        initializeRelationships();
                        setStep(3);
                      }}
                      className="bg-blue-500 text-white px-8 py-4 rounded-lg hover:bg-blue-600 font-bold text-lg flex items-center gap-2"
                    >
                      {t.continueToRelationships} <Icon name="arrow-right" size={24} />
                    </button>
                  )}
                </div>
              </div>
            )}

            {currentCharacter && (
              <div className="bg-white border-2 border-purple-200 rounded-xl p-6 space-y-6">
                <h3 className="text-xl font-bold text-purple-700">{currentCharacter.id ? t.editCharacter : t.startCreating}</h3>
                <div>
                  <label className="block text-lg font-semibold mb-2">{t.characterName} *</label>
                  <input
                    type="text"
                    value={currentCharacter.name}
                    onChange={(e) => handleNameChange(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg"
                    placeholder={t.characterName}
                  />
                </div>

                <div>
                  <label className="block text-lg font-semibold mb-2">{t.gender}</label>
                  <select
                    value={currentCharacter.gender}
                    onChange={(e) => setCurrentCharacter({ ...currentCharacter, gender: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg"
                  >
                    <option value="male">{t.male}</option>
                    <option value="female">{t.female}</option>
                    <option value="other">{t.other}</option>
                  </select>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="border-2 border-purple-300 rounded-lg p-4 bg-purple-50">
                    <label className="block text-lg font-semibold mb-3 text-center">{t.characterPhoto}</label>
                    <div className="flex flex-col items-center gap-3">
                      {currentCharacter.photoUrl && (
                        <img
                          src={currentCharacter.photoUrl}
                          alt="Character"
                          className="w-32 h-32 rounded-full object-cover border-4 border-purple-400"
                        />
                      )}
                      <label className="cursor-pointer bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 flex items-center gap-2 font-semibold">
                        <Icon name="upload" size={20} /> {t.uploadPhoto}
                        <input
                          type="file"
                          accept="image/*"
                          onChange={handlePhotoUpload}
                          className="hidden"
                        />
                      </label>
                    </div>
                  </div>

                  <div className="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                    <label className="block text-lg font-semibold mb-3 text-center">{t.orDescribe}</label>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-semibold mb-1">{t.age}</label>
                        <input
                          type="number"
                          value={currentCharacter.age}
                          onChange={(e) => setCurrentCharacter({ ...currentCharacter, age: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder={t.age}
                          min="1"
                          max="99"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-1">{t.hairColor}</label>
                        <input
                          type="text"
                          value={currentCharacter.hairColor}
                          onChange={(e) => setCurrentCharacter({ ...currentCharacter, hairColor: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder={t.hairColor}
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-1">{t.otherFeatures}</label>
                        <textarea
                          value={currentCharacter.otherFeatures}
                          onChange={(e) => setCurrentCharacter({ ...currentCharacter, otherFeatures: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder={t.descriptionPlaceholder}
                          rows={2}
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <label className="block text-lg font-semibold mb-2">
                    {t.strengths} * ({t.selectAtLeast} 3) - {t.selected}: {currentCharacter.strengths.length}
                  </label>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {allStrengths.map(strength => (
                      <button
                        key={strength}
                        onClick={() => toggleArrayItem('strengths', strength)}
                        className={`px-3 py-1 rounded-full text-sm ${
                          currentCharacter.strengths.includes(strength)
                            ? 'bg-green-500 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {strength}
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newStrength}
                      onChange={(e) => setNewStrength(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addCustomStrength()}
                      placeholder={t.addCustomStrengths}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <button
                      onClick={addCustomStrength}
                      className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                    >
                      <Icon name="plus" size={20} />
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-lg font-semibold mb-2">
                    {t.weaknesses} * ({t.selectAtLeast} 2) - {t.selected}: {currentCharacter.weaknesses.length}
                  </label>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {allWeaknesses.map(weakness => (
                      <button
                        key={weakness}
                        onClick={() => toggleArrayItem('weaknesses', weakness)}
                        className={`px-3 py-1 rounded-full text-sm ${
                          currentCharacter.weaknesses.includes(weakness)
                            ? 'bg-orange-500 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {weakness}
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newWeakness}
                      onChange={(e) => setNewWeakness(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addCustomWeakness()}
                      placeholder={t.addCustomWeaknesses}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <button
                      onClick={addCustomWeakness}
                      className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                    >
                      <Icon name="plus" size={20} />
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-lg font-semibold mb-2">{t.fears}</label>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {allFears.map(fear => (
                      <button
                        key={fear}
                        onClick={() => toggleArrayItem('fears', fear)}
                        className={`px-3 py-1 rounded-full text-sm ${
                          currentCharacter.fears.includes(fear)
                            ? 'bg-red-500 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {fear}
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newFear}
                      onChange={(e) => setNewFear(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addCustomFear()}
                      placeholder={t.addCustomFears}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <button
                      onClick={addCustomFear}
                      className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                    >
                      <Icon name="plus" size={20} />
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-lg font-semibold mb-2">{t.specialDetails}</label>
                  <textarea
                    value={currentCharacter.specialDetails}
                    onChange={(e) => setCurrentCharacter({ ...currentCharacter, specialDetails: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg"
                    placeholder={t.specialDetailsPlaceholder}
                    rows={3}
                  />
                </div>

                <div className="flex gap-4">
                  <button
                    onClick={() => {
                      setCurrentCharacter(null);
                      setShowCharacterCreated(false);
                    }}
                    className="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 font-semibold"
                  >
                    {t.cancel}
                  </button>
                  <button
                    onClick={saveCurrentCharacter}
                    disabled={!canSave}
                    className={`flex-1 px-6 py-3 rounded-lg font-semibold ${
                      canSave
                        ? 'bg-blue-500 text-white hover:bg-blue-600'
                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    }`}
                  >
                    {t.saveCharacter}
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const renderStep3 = () => (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
            <Icon name="heart" size={24} /> {t.defineRelationships}
          </h2>
          <p className="text-gray-600">{t.defineRelationshipsDesc}</p>

          <div className="space-y-4">
            {characters.map((char1, i) => (
              <div key={char1.id}>
                {characters.map((char2, j) => {
                  if (i >= j) return null;
                  const key1 = `${char1.id}-${char2.id}`;
                  const key2 = `${char2.id}-${char1.id}`;

                  return (
                    <div key={key1} className="bg-white border-2 border-purple-200 rounded-xl p-6 space-y-4">
                      <div className="grid md:grid-cols-3 gap-4 items-center">
                        <div className="text-center">
                          {char1.photoUrl && (
                            <img src={char1.photoUrl} alt={char1.name} className="w-16 h-16 rounded-full mx-auto mb-2 object-cover" />
                          )}
                          <div className="font-bold">{char1.name}</div>
                        </div>

                        <div className="space-y-2">
                          <label className="block text-sm font-semibold text-center">{t.is}</label>
                          <select
                            value={relationships[key1] || relationshipTypes[10].value[language]}
                            onChange={(e) => updateRelationship(char1.id, char2.id, e.target.value)}
                            className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg font-semibold"
                          >
                            {allRelationships.map((type, idx) => (
                              <option key={idx} value={type.value[language]}>{type.value[language]}</option>
                            ))}
                          </select>
                          <div className="flex gap-2 mt-2">
                            <input
                              type="text"
                              value={newRelationship}
                              onChange={(e) => setNewRelationship(e.target.value)}
                              onKeyPress={(e) => e.key === 'Enter' && addCustomRelationship()}
                              placeholder={t.addCustomRelationship}
                              className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                            />
                            <button
                              onClick={addCustomRelationship}
                              className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                            >
                              <Icon name="plus" size={16} />
                            </button>
                          </div>
                        </div>

                        <div className="text-center">
                          {char2.photoUrl && (
                            <img src={char2.photoUrl} alt={char2.name} className="w-16 h-16 rounded-full mx-auto mb-2 object-cover" />
                          )}
                          <div className="font-bold">{char2.name}</div>
                        </div>
                      </div>

                      {relationships[key1] && relationships[key2] && (
                        <div className="pt-3 border-t border-gray-200">
                          <div className="text-xs text-gray-500 text-center mb-1">{t.reverseRelationship}</div>
                          <div className="text-sm text-center text-gray-600">
                            <strong>{char2.name}</strong> {t.is} <strong>{relationships[key2]}</strong> <strong>{char1.name}</strong>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
        </div>
      );

      const renderStep4 = () => (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
              <Icon name="wand-2" size={24} /> {t.storySettings}
            </h2>
            <button
              onClick={exportConfiguration}
              className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2"
            >
              <Icon name="save" size={20} /> {t.exportConfig}
            </button>
          </div>

          <div className="bg-white border-2 border-purple-200 rounded-xl p-6 space-y-6">
            <div>
              <label className="block text-lg font-semibold mb-3">{t.selectMainCharacters}</label>
              <div className="grid md:grid-cols-2 gap-3">
                {characters.map(char => (
                  <button
                    key={char.id}
                    onClick={() => toggleMainCharacter(char.id)}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      mainCharacters.includes(char.id)
                        ? 'border-yellow-500 bg-yellow-50'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <div className="flex items-center gap-3">
                      {char.photoUrl && (
                        <img src={char.photoUrl} alt={char.name} className="w-12 h-12 rounded-full object-cover" />
                      )}
                      <div className="flex-1">
                        <div className="font-bold flex items-center gap-2">
                          {char.name}
                          {mainCharacters.includes(char.id) && <Icon name="star" size={16} className="text-yellow-500" />}
                        </div>
                        <div className="text-sm text-gray-600">
                          {char.gender === 'male' ? t.male : char.gender === 'female' ? t.female : t.other}, {char.age}
                        </div>
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            <div>
              <label className="block text-lg font-semibold mb-3">{t.numberOfPages}</label>
              <div className="flex items-center gap-4">
                <input
                  type="range"
                  min="3"
                  max="30"
                  value={pages}
                  onChange={(e) => setPages(parseInt(e.target.value))}
                  className="flex-1"
                />
                <span className="text-2xl font-bold text-purple-600 w-12 text-center">{pages}</span>
              </div>
            </div>

            <div>
              <label className="block text-lg font-semibold mb-3">{t.readingLevel}</label>
              <div className="space-y-2">
                {[
                  { value: '1st-grade', label: t.firstGrade, desc: t.firstGradeDesc },
                  { value: 'standard', label: t.standard, desc: t.standardDesc },
                  { value: 'advanced', label: t.advanced, desc: t.advancedDesc }
                ].map(level => (
                  <button
                    key={level.value}
                    onClick={() => setLanguageLevel(level.value)}
                    className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                      languageLevel === level.value
                        ? 'border-purple-500 bg-purple-50'
                        : 'border-gray-200 hover:border-purple-300'
                    }`}
                  >
                    <div className="font-semibold">{level.label}</div>
                    <div className="text-sm text-gray-600">{level.desc}</div>
                  </button>
                ))}
              </div>
            </div>

            <button
              onClick={generateStory}
              disabled={isGenerating || characters.length === 0}
              className={`w-full py-4 rounded-lg font-bold text-lg flex items-center justify-center gap-2 ${
                isGenerating || characters.length === 0
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  : 'bg-blue-500 text-white hover:bg-blue-600'
              }`}
            >
              <Icon name="wand-2" size={24} />
              {isGenerating ? t.creating : t.generateStory}
            </button>
          </div>
        </div>
      );

      const renderStep6 = () => (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
            <Icon name="book-open" size={24} /> {t.storyReady}
          </h2>

          <div className="bg-white border-2 border-purple-200 rounded-xl p-8 prose max-w-none">
            <div className="whitespace-pre-wrap leading-relaxed text-gray-800">
              {generatedStory}
            </div>
          </div>

          {generatedPrompt && (
            <div className="bg-gray-50 border-2 border-gray-300 rounded-xl p-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-gray-700">{t.promptUsed}</h3>
                <button
                  onClick={() => setShowPrompt(!showPrompt)}
                  className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2"
                >
                  <Icon name={showPrompt ? "eye-off" : "eye"} size={20} />
                  {showPrompt ? t.hidePrompt : t.viewPrompt}
                </button>
              </div>
              {showPrompt && (
                <div className="bg-white border border-gray-300 rounded-lg p-4 mt-4">
                  <pre className="whitespace-pre-wrap text-sm text-gray-700 font-mono">
                    {generatedPrompt}
                  </pre>
                </div>
              )}
            </div>
          )}

          <div className="flex gap-4 flex-wrap">
            <button
              onClick={() => downloadStory('txt')}
              className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
            >
              <Icon name="download" size={20} /> {t.downloadTXT}
            </button>
            <button
              onClick={() => downloadStory('pdf')}
              className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
            >
              <Icon name="download" size={20} /> {t.downloadPDF}
            </button>
            {generatedPrompt && (
              <button
                onClick={downloadPrompt}
                className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
              >
                <Icon name="download" size={20} /> {t.downloadPrompt}
              </button>
            )}
            <button
              onClick={exportConfiguration}
              className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold flex items-center gap-2"
            >
              <Icon name="save" size={20} /> {t.exportConfig}
            </button>
            <button
              onClick={() => {
                setStep(1);
                setGeneratedStory('');
                setGeneratedPrompt('');
                setShowPrompt(false);
                setCharacters([]);
                setRelationships({});
                setStoryType('');
                setMainCharacters([]);
              }}
              className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold ml-auto"
            >
              {t.createAnotherStory}
            </button>
          </div>
        </div>
      );

      return (
        <div className="min-h-screen" style={{backgroundColor: '#e0f2fe'}}>
          {/* Black Navigation Bar */}
          <nav className="bg-black text-white px-8 py-4 flex justify-between items-center">
            <div className="flex items-center gap-2">
              <h1 className="text-2xl font-bold">âœ¨ {t.title}</h1>
            </div>
            <div className="relative">
              <button
                onClick={() => setShowLanguageDropdown(!showLanguageDropdown)}
                className="bg-gray-800 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 flex items-center gap-2"
              >
                <Icon name="globe" size={20} />
                {language.toUpperCase()}
              </button>
              {showLanguageDropdown && (
                <div className="absolute right-0 mt-2 bg-gray-800 rounded-lg shadow-lg overflow-hidden z-50">
                  <button
                    onClick={() => {
                      setLanguage('en');
                      setShowLanguageDropdown(false);
                    }}
                    className={`block w-full text-left px-6 py-3 hover:bg-gray-700 font-semibold ${language === 'en' ? 'bg-purple-600 text-white' : 'text-white'}`}
                  >
                    EN
                  </button>
                  <button
                    onClick={() => {
                      setLanguage('de');
                      setShowLanguageDropdown(false);
                    }}
                    className={`block w-full text-left px-6 py-3 hover:bg-gray-700 font-semibold ${language === 'de' ? 'bg-purple-600 text-white' : 'text-white'}`}
                  >
                    DE
                  </button>
                  <button
                    onClick={() => {
                      setLanguage('fr');
                      setShowLanguageDropdown(false);
                    }}
                    className={`block w-full text-left px-6 py-3 hover:bg-gray-700 font-semibold ${language === 'fr' ? 'bg-purple-600 text-white' : 'text-white'}`}
                  >
                    FR
                  </button>
                </div>
              )}
            </div>
          </nav>

          {showApiKeyPrompt && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-8 max-w-md w-full">
                  <h2 className="text-2xl font-bold text-purple-700 mb-4">{t.apiKeyRequired}</h2>
                  <p className="text-gray-600 mb-4">{t.apiKeyPrompt}</p>
                  <input
                    type="password"
                    value={tempApiKey}
                    onChange={(e) => setTempApiKey(e.target.value)}
                    placeholder={t.apiKeyPlaceholder}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4"
                  />
                  <p className="text-xs text-gray-500 mb-4">{t.apiKeyNote}</p>
                  <div className="flex gap-4">
                    <button
                      onClick={() => setShowApiKeyPrompt(false)}
                      className="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400"
                    >
                      {t.cancel}
                    </button>
                    <button
                      onClick={saveApiKeyToStorage}
                      className="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600"
                    >
                      {t.saveApiKey}
                    </button>
                  </div>
                </div>
              </div>
            )}

          {step === 0 && renderStep0()}

          {step > 0 && (
            <div className="max-w-7xl mx-auto px-4 md:px-8">
              {step < 6 && (
                <div className="flex justify-center mb-8 mt-8">
                  <div className="flex items-center gap-2">
                  {[1, 2, 3, 4].map(s => (
                    <React.Fragment key={s}>
                      <button
                        onClick={() => {
                          if (s < step || (s === 1 && storyType) || (s === 2 && characters.length > 0) || (s === 3 && areAllRelationshipsDefined())) {
                            setStep(s);
                          }
                        }}
                        disabled={s > step}
                        className={`w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all ${
                          step >= s
                            ? 'bg-purple-500 text-white hover:bg-purple-600 cursor-pointer'
                            : 'bg-gray-300 text-gray-600 cursor-not-allowed'
                        } ${s < step ? 'hover:scale-110' : ''}`}
                      >
                        {s}
                      </button>
                      {s < 4 && <div className={`w-12 h-1 ${step > s ? 'bg-purple-500' : 'bg-gray-300'}`} />}
                    </React.Fragment>
                  ))}
                </div>
              </div>
              )}

              <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
                {step === 1 && renderStep1()}
                {step === 2 && renderStep2()}
                {step === 3 && renderStep3()}
                {step === 4 && renderStep4()}
                {step === 6 && renderStep6()}
              </div>

              {step < 6 && step !== 2 && (
                <div className="flex justify-between">
                <button
                  onClick={() => setStep(Math.max(0, step - 1))}
                  className="bg-white text-purple-600 hover:bg-purple-50 border-2 border-purple-500 px-6 py-3 rounded-lg font-semibold flex items-center gap-2"
                >
                  <Icon name="arrow-left" size={20} /> {t.back}
                </button>

                <button
                  onClick={() => setStep(Math.min(4, step + 1))}
                  disabled={
                    (step === 1 && !storyType) ||
                    (step === 2 && characters.length === 0) ||
                    (step === 3 && !areAllRelationshipsDefined())
                  }
                  className={`px-6 py-3 rounded-lg font-semibold flex items-center gap-2 ${
                    (step === 1 && !storyType) ||
                    (step === 2 && characters.length === 0) ||
                    (step === 3 && !areAllRelationshipsDefined())
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      : 'bg-blue-500 text-white hover:bg-blue-600'
                  }`}
                >
                  {t.next} <Icon name="arrow-right" size={20} />
                </button>
              </div>
              )}
            </div>
          )}
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<StoryCreator />);
  </script>
</body>
</html>